<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prosty Ticker – GPW + USA (proxy-only, GitHub Pages)</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%93%88%3C/text%3E%3C/svg%3E">
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; display: grid; place-items: center; min-height: 100vh; background: #0f172a; color: #e5e7eb; }
    .card { width: min(920px, 96vw); background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 8px; font-size: 20px; color: #f3f4f6; }
    .sub { color:#9ca3af; font-size: 13px; margin-top: 2px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input, button {
      background: #0b1220; color: #e5e7eb; border: 1px solid #25314b; border-radius: 12px;
      padding: 12px 14px; font-size: 16px; outline: none;
    }
    input::placeholder { color: #94a3b8; }
    button { cursor: pointer; font-weight: 700; }
    .panel {
      background: #0b1220; border: 1px solid #1f2937; border-radius: 14px; padding: 14px;
    }
    .panel h2 { font-size: 16px; margin: 0 0 8px; color:#cbd5e1; }
    .price { margin-top: 6px; font-size: 38px; font-weight: 800; letter-spacing: .5px; }
    .meta { margin-top: 4px; color: #9ca3af; font-size: 12px; }
    .err { margin-top: 8px; color: #fca5a5; font-size: 13px; min-height: 1em; white-space: pre-line; }
    .ok { color: #22c55e; }
    .bad { color: #ef4444; }
    .hint { margin-top: 12px; color: #94a3b8; font-size: 12px; }
    .muted { color: #9ca3af; }
    .badge { padding: 6px 8px; border:1px solid #374151; border-radius:10px; font-size:12px; }
    @media (max-width: 720px) {
      .grid2 { grid-template-columns: 1fr; }
      .price { font-size: 32px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Prosty Ticker – GPW + USA (proxy-only, GitHub Pages)</h1>
    <div class="sub">Ta wersja nigdy nie pyta bezpośrednio <code>stooq.com</code> (zawsze przez publiczne proxy). Wpisuj tickery <b>bez</b> sufiksów (np. <b>PCO</b>, <b>TSLA</b>).</div>

    <div class="row" style="margin-top:12px">
      <button id="toggle">Start</button>
      <button id="once">Odśwież teraz</button>
      <span class="badge muted" id="proxyInfo">(brak)</span>
    </div>

    <div class="grid2" style="margin-top:14px">
      <div class="panel" id="p_gpw">
        <h2>GPW</h2>
        <div class="row">
          <input id="ticker_gpw" placeholder="Np. PCO, PKN, PKO, KGH..." autocapitalize="characters" />
        </div>
        <div class="price" id="out_gpw">—</div>
        <div class="meta" id="meta_gpw"></div>
        <div class="err" id="err_gpw"></div>
      </div>

      <div class="panel" id="p_usa">
        <h2>USA</h2>
        <div class="row">
          <input id="ticker_us" placeholder="Np. TSLA, AAPL, MSFT..." autocapitalize="characters" />
        </div>
        <div class="price" id="out_us">—</div>
        <div class="meta" id="meta_us"></div>
        <div class="err" id="err_us"></div>
      </div>
    </div>

    <div class="hint">
      Proxy kolejno: <code>api.allorigins.win</code> → <code>cors.isomorphic-git.org</code> → <code>corsproxy.io</code>. Jeśli wszystkie padną, zobacz sekcję Worker (prywatny proxy).
    </div>
  </div>

<script>
  // --- Minimalny parser CSV ---
  function parseCSVLine(line) {
    const out = [];
    let cur = '', inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i], next = line[i+1];
      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes) {
        out.push(cur); cur = '';
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  // --- DOM ---
  const $toggle = document.getElementById('toggle');
  const $once = document.getElementById('once');
  const $proxyInfo = document.getElementById('proxyInfo');

  const $tg = document.getElementById('ticker_gpw');
  const $tu = document.getElementById('ticker_us');

  const $out_g = document.getElementById('out_gpw');
  const $meta_g = document.getElementById('meta_gpw');
  const $err_g = document.getElementById('err_gpw');

  const $out_u = document.getElementById('out_us');
  const $meta_u = document.getElementById('meta_us');
  const $err_u = document.getElementById('err_us');

  // --- Stan ---
  let timer = null;
  let last = {
    gpw: { symbol: '', price: null },
    usa: { symbol: '', price: null },
  };

  // --- Helpers ---
  function stooqUrl(symbol) {
    return `https://stooq.com/q/l/?s=${encodeURIComponent(symbol)}&f=sd2t2ohlcvn&h&e=csv`;
  }

  async function fetchTextProxied(url) {
    const attempts = [
      { name: 'AllOrigins', url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}` },
      { name: 'isomorphic-git', url: `https://cors.isomorphic-git.org/${encodeURIComponent(url)}` },
      { name: 'corsproxy.io', url: `https://corsproxy.io/?${encodeURIComponent(url)}` },
    ];
    let lastErr = null;
    for (const a of attempts) {
      try {
        const res = await fetch(a.url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        $proxyInfo.textContent = a.name;
        return txt;
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error('Wszystkie publiczne proxy odrzuciły zapytanie.');
  }

  async function fetchStooq(symbol) {
    const csv = await fetchTextProxied(stooqUrl(symbol));
    const lines = csv.trim().split(/\\r?\\n/);
    if (lines.length < 2) throw new Error('Niepoprawny CSV');
    const row = parseCSVLine(lines[1]);
    const [sym, date, time, o, h, l, c, v, name] = row;
    if (!c || c === 'N/D') throw new Error('Brak notowań');
    return { sym, date, time, o: +o, h: +h, l: +l, c: +c, v: +v, name };
  }

  function renderSide(side, data, err) {
    const isUSA = (side === 'usa');
    const $out = isUSA ? $out_u : $out_g;
    const $meta = isUSA ? $meta_u : $meta_g;
    const $err = isUSA ? $err_u : $err_g;

    if (err) {
      $err.textContent = err;
      $out.textContent = '—';
      $meta.textContent = '';
      last[side].price = null;
      return;
    } else {
      $err.textContent = '';
    }

    const currency = isUSA ? '$' : 'zł';
    const prevPrice = last[side].symbol === data.sym ? last[side].price : null;
    const delta = (prevPrice != null) ? (data.c - prevPrice) : 0;

    let deltaHtml = '';
    if (prevPrice != null && Math.abs(delta) > 0) {
      const sign = delta > 0 ? '▲' : '▼';
      const cls = delta > 0 ? 'ok' : 'bad';
      const unit = isUSA ? '$' : '';
      deltaHtml = ` <span class="${cls}">${sign} ${unit}${Math.abs(delta).toFixed(2)}</span>`;
    }

    $out.innerHTML = `${currency} ${data.c.toFixed(2)}${deltaHtml}`;
    $meta.textContent = `${data.sym.toUpperCase()} • ${data.name || ''} • ${data.date} ${data.time}`;

    last[side].symbol = data.sym;
    last[side].price = data.c;
  }

  async function tick() {
    const gpw = ($tg.value || '').trim().toLowerCase();
    const usa = ($tu.value || '').trim().toLowerCase();

    if (gpw) {
      try {
        const d = await fetchStooq(gpw); // GPW bez sufiksu
        renderSide('gpw', d, null);
      } catch (e) {
        renderSide('gpw', null, (e && e.message) ? e.message : String(e));
      }
    } else {
      renderSide('gpw', null, '');
      $out_g.textContent = '—'; $meta_g.textContent = '';
      last.gpw.price = null;
    }

    if (usa) {
      try {
        const d = await fetchStooq(usa + '.us'); // USA z .us
        renderSide('usa', d, null);
      } catch (e) {
        renderSide('usa', null, (e && e.message) ? e.message : String(e));
      }
    } else {
      renderSide('usa', null, '');
      $out_u.textContent = '—'; $meta_u.textContent = '';
      last.usa.price = null;
    }
  }

  function start() {
    if (timer) return;
    tick();
    timer = setInterval(tick, 5000);
    $toggle.textContent = 'Stop';
  }
  function stop() {
    if (!timer) return;
    clearInterval(timer);
    timer = null;
    $toggle.textContent = 'Start';
  }

  // --- actions ---
  $toggle.addEventListener('click', () => timer ? stop() : start());
  $once.addEventListener('click', tick);

  [$tg, $tu].forEach(inp => {
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { last.gpw.price = null; last.usa.price = null; tick(); }});
  });

  // Wstępne wartości
  $tg.value = 'PCO';
  $tu.value = 'TSLA';
</script>

<!--
--- Alternatywa: prywatny Cloudflare Worker jako proxy (stabilniej) ---
1) Wejdź na https://dash.cloudflare.com → Workers & Pages → Create Worker → Quick edit.
2) Wklej poniższy kod i Deploy. Zanotuj adres, np. https://twoj-worker.workers.dev
3) W HTML zmień fetchTextProxied na pobieranie z Twojego Workera, np. `${WORKER}/stooq?s=${symbol}`

export default {
  async fetch(request) {
    const url = new URL(request.url);
    if (url.pathname === "/stooq") {
      const s = url.searchParams.get("s");
      if (!s) return new Response("Missing s", { status: 400 });
      const target = `https://stooq.com/q/l/?s=${encodeURIComponent(s)}&f=sd2t2ohlcvn&h&e=csv`;
      const resp = await fetch(target, { headers: { "User-Agent": "Mozilla/5.0" } });
      const text = await resp.text();
      return new Response(text, {
        status: resp.status,
        headers: {
          "content-type": "text/csv; charset=utf-8",
          "access-control-allow-origin": "*",
          "cache-control": "no-store"
        }
      });
    }
    return new Response("ok");
  }
}
-->
</body>
</html>
