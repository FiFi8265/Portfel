
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GT Multi-User (Firestore Login) — v4.5 auto-sync</title>
  <style>
    :root { --bg:#0b0f16; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --border:#1f2937; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial; }
    .center { display:flex; align-items:center; justify-content:center; min-height:100%; }
    .card { width:100%; max-width:420px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    .card h1 { font-size:22px; margin:0 0 8px; }
    .card p.small { color:var(--muted); margin:0 0 16px; }
    label { display:block; font-size:13px; color:var(--muted); margin:12px 0 6px; }
    input { width:100%; box-sizing:border-box; background:#0f172a; color:#e5e7eb; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; }
    input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.25); }
    .row { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    button { flex:1; cursor:pointer; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#0f172a; color:#e5e7eb; }
    button.primary { background:var(--accent); color:#001b0c; border-color:#16a34a; }
    button.link { background:transparent; border-color:transparent; text-decoration:underline; color:var(--muted); flex:none; }
    .error { color:var(--danger); font-size:13px; min-height:18px; margin-top:10px; }
    .hide { display:none !important; }
    #appContainer { position:fixed; inset:0; }
    #appFrame { width:100%; height:100%; border:0; background:#000; }
    .topbar { position:fixed; bottom:12px; left:12px; z-index:50; display:flex; gap:8px; align-items:center; pointer-events:none; }
    .pill { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); font-size:12px; }
    .danger { background:rgba(239,68,68,.12); border-color:#7f1d1d; }
      .topbar > * { pointer-events:auto; }
  
    .checkbox-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .checkbox-row input[type="checkbox"] {
      width:auto;
      flex:none;
      accent-color: var(--accent);
    }
    .checkbox-row a {
      color:var(--accent);
      text-decoration:underline;
      cursor:pointer;
    }
    .modal-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    .modal {
      width:100%;
      max-width:600px;
      max-height:80vh;
      background:var(--card);
      border-radius:16px;
      padding:20px;
      box-shadow:0 20px 40px rgba(0,0,0,.4);
      overflow:auto;
    }
    .modal h2 {
      margin-top:0;
      margin-bottom:10px;
      font-size:18px;
    }
    .modal h3 {
      margin-top:16px;
      margin-bottom:6px;
      font-size:15px;
    }
    .modal p, .modal li {
      font-size:13px;
      line-height:1.5;
      color:var(--muted);
    }
    .modal ul {
      padding-left:18px;
      margin:6px 0 10px;
    }
    .modal-footer {
      margin-top:16px;
      text-align:right;
    }
    .modal-footer button {
      flex:none;
      min-width:100px;
    }
</style>
</head>
<body>
  <div id="loginView" class="center">
    <div class="card">
      <h1>Zaloguj się</h1>
      <p class="small">Email/hasło • Dane w Firestore (nowy proj...kt). Iframe ma stubs + firewall; stan ląduje w Twoim koncie.</p>
      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
      <label for="password">Hasło</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="min. 6 znaków" />
            <label class="checkbox-row">
        <input id="acceptTerms" type="checkbox" />
        <span>Akceptuję <a href="#" id="termsLink">regulamin i zasady prywatności</a></span>
      </label>
<div class="row">
        <button id="loginBtn" class="primary">Zaloguj</button>
        <button id="signupBtn">Utwórz konto</button> </div>
      <button id="resetBtn" class="link" type="button">Zapomniałem hasła</button>
      <div id="err" class="error"></div>
    </div>
  </div>

  <div id="termsOverlay" class="modal-overlay hide">
    <div class="modal">
      <h2>Regulamin i zasady prywatności (wersja testowa)</h2>
      <p class="small">Poniżej znajdziesz zwięzłe zasady korzystania z aplikacji w wersji beta.</p>
      <h3>1. Informacje ogólne</h3>
      <p>Aplikacja służy do testowego zarządzania portfelami inwestycyjnymi. Jest to wersja rozwojowa (beta), udostępniona ograniczonej grupie użytkowników do celów testowych.</p>
      <h3>2. Charakter aplikacji (brak doradztwa inwestycyjnego)</h3>
      <p>Aplikacja nie świadczy usług doradztwa inwestycyjnego. Wszystkie decyzje inwestycyjne podejmujesz samodzielnie, na własne ryzyko. Dane rynkowe mogą być opóźnione lub niepełne.</p>
      <h3>3. Dane przetwarzane w aplikacji</h3>
      <p>W ramach korzystania z aplikacji mogą być przetwarzane w szczególności:</p>
      <ul>
        <li>adres email i hasło (do logowania)*,</li>
        <li>dane portfeli i transakcji (nazwy portfeli, tickery, ilości, ceny, waluty),</li>
        <li>ustawienia użytkownika (waluta domyślna, zezwolenie na saldo ujemne, częstotliwość odświeżania, klucze API do serwisów z danymi rynkowymi),</li>
        <li>dane techniczne (logi błędów, podstawowe dane o urządzeniu/przeglądarce).</li>
      </ul>
      <p>* Hasło jest przechowywane po stronie Firebase (Firebase Authentication) w postaci zaszyfrowanej (hashowanej). Jako administrator aplikacji nie mam możliwości odczytania treści Twojego hasła.</p>

      <h3>4. Zasady prywatności</h3>
      <p>Dane są wykorzystywane wyłącznie w celu umożliwienia działania aplikacji, poprawy jej jakości oraz analizy błędów. Dane nie są sprzedawane osobom trzecim. Zewnętrzne serwisy (np. dostawcy danych giełdowych) mogą przetwarzać dane zgodnie z własnymi regulaminami i politykami prywatności.</p>
      <p>Wszystkie dane związane z Twoim kontem (email, zaszyfrowane hasło, portfele, transakcje, ustawienia) są przechowywane w usługach Firebase Authentication oraz Cloud Firestore (Google).</p>

      <h3>5. Twoje prawa</h3>
      <p>Jako użytkownik masz prawo m.in. do:</p>
      <ul>
        <li>dostępu do swoich danych i ich poprawiania,</li>
        <li>usunięcia konta i danych (w aplikacji dostępna jest funkcja dezaktywacji konta),</li>
        <li>ograniczenia przetwarzania oraz zgłoszenia sprzeciwu,</li>
        <li>zgłoszenia skargi do odpowiedniego organu nadzorczego ds. ochrony danych osobowych.</li>
      </ul>
      <h3>6. Odpowiedzialność</h3>
      <p>Autor aplikacji dokłada starań, aby działała poprawnie, ale nie gwarantuje jej nieprzerwanego działania ani poprawności danych. Aplikacja jest przeznaczona wyłącznie do celów edukacyjnych i testowych. Korzystasz z niej na własną odpowiedzialność.</p>
      <h3>7. Kontakt</h3>
      <p>W sprawach związanych z regulaminem lub prywatnością danych skontaktuj się z administratorem aplikacji (np. pod adresem email wskazanym przez autora aplikacji).</p>
      <p>Kontakt do administratora aplikacji: <a href="mailto:filpod2@wp.pl">filpod2@wp.pl</a></p>

      <div class="modal-footer">
        <button id="closeTermsBtn">Zamknij</button>
      </div>
    </div>
  </div>


  <div id="verifyView" class="center hide">
    <div class="card">
      <h1>Potwierdź adres email</h1>
      <p class="small">Na adres <span id="verifyEmail"></span> wysłaliśmy link aktywacyjny.</p>
      <p class="small">Kliknij link w wiadomości, a następnie wróć tutaj.</p>
      <div class="row">
        <button id="resendVerifyBtn">Wyślij ponownie link</button>
        <button id="refreshVerifyBtn">Sprawdź ponownie</button>
      </div>
      <div id="verifyErr" class="error small"></div>
    </div>
  </div>


<div id="appContainer" class="hide">
    <div class="topbar">
      <span id="who" class="pill">—</span>
      <button id="logoutBtn" class="pill danger">Wyloguj</button>
    </div>
    <iframe id="appFrame" loading="eager"></iframe>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, setPersistence, browserLocalPersistence, sendEmailVerification, deleteUser, updatePassword} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs, deleteDoc} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfhxDgCqOaCfRKxtMECpRSjQU0TTgtGrM",
      authDomain: "mywallets-b55d9.firebaseapp.com",
      projectId: "mywallets-b55d9",
      storageBucket: "mywallets-b55d9.firebasestorage.app",
      messagingSenderId: "724728432741",
      appId: "1:724728432741:web:2a0a6302a68c78fc0ade8c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    const loginView = document.getElementById('loginView');
    const appContainer = document.getElementById('appContainer');
    const appFrame = document.getElementById('appFrame');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const err = document.getElementById('err');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn'); const logoutBtn = document.getElementById('logoutBtn');
    const verifyView = document.getElementById('verifyView');
    const verifyEmail = document.getElementById('verifyEmail');
    const resendVerifyBtn = document.getElementById('resendVerifyBtn');
    const refreshVerifyBtn = document.getElementById('refreshVerifyBtn');
    const verifyErr = document.getElementById('verifyErr');
    const resetBtn = document.getElementById('resetBtn');
    const acceptTerms = document.getElementById('acceptTerms');
    const termsLink = document.getElementById('termsLink');
    const termsOverlay = document.getElementById('termsOverlay');
    const closeTermsBtn = document.getElementById('closeTermsBtn');
    
    // ENTER = Zaloguj
    function handleEnter(e){ if(e.key === 'Enter'){ e.preventDefault(); loginBtn.click(); } }
    emailEl.addEventListener('keydown', handleEnter);
    passwordEl.addEventListener('keydown', handleEnter);
    if (termsLink && termsOverlay) {
      termsLink.addEventListener('click', (e) => {
        e.preventDefault();
        termsOverlay.classList.remove('hide');
      });
    }
    if (closeTermsBtn && termsOverlay) {
      closeTermsBtn.addEventListener('click', () => {
        termsOverlay.classList.add('hide');
      });
    }
    if (termsOverlay) {
      termsOverlay.addEventListener('click', (e) => {
        if (e.target === termsOverlay) {
          termsOverlay.classList.add('hide');
        }
      });
    }

function showError(e) {
      console.error(e);
      let msg = (e && e.message) ? e.message : String(e);
      if (e && e.code) {
        const map = {
          "auth/invalid-email": "Nieprawidłowy email",
          "auth/missing-password": "Podaj hasło (min. 6 znaków)",
          "auth/weak-password": "Hasło zbyt krótkie (min. 6 znaków)",
          "auth/email-already-in-use": "Email już istnieje",
          "auth/user-not-found": "Błędny email lub hasło",
          "auth/wrong-password": "Błędny email lub hasło",
          "auth/too-many-requests": "Za dużo prób, spróbuj później",
          "auth/unauthorized-domain": "Dodaj domenę do Authorized domains (Firebase Auth)",
          "auth/invalid-credential": "Błędny email lub hasło",
          "auth/invalid-login-credentials": "Błędny email lub hasło",
};
        msg = map[e.code] || msg;
      }
      err.textContent = msg;
      setTimeout(() => { if (err.textContent === msg) err.textContent = ""; }, 7000);
    }

    const disable = (flag) => [loginBtn, signupBtn, resetBtn].forEach(b => { if (b) b.disabled = !!flag; });
    function validEmail(s) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
    function validPass(s) { return typeof s === 'string' && s.length >= 6; }
    function creds(){ return { email: emailEl.value.trim().toLowerCase(), password: passwordEl.value }; }

    // Ignore reserved keys like "__name__"
    const isReservedKey = (k) => /^__.*__$/.test(k);
    const sanitizeSnapshot = (obj) => { const out = {}; for (const k in obj) { if (!isReservedKey(k)) out[k] = obj[k]; } return out; };

    loginBtn.onclick = async () => {
      const {email,password} = creds();
      if (!validEmail(email)) return showError({ code: "auth/invalid-email" });
      if (!validPass(password)) return showError({ code: "auth/weak-password" });
      try { disable(true); await signInWithEmailAndPassword(auth, email, password); }
      catch(e){ showError(e); } finally { disable(false); }
    };
    signupBtn.onclick = async () => {
      const {email,password} = creds();
      if (!validEmail(email)) return showError({ code: "auth/invalid-email" });
      if (!validPass(password)) return showError({ code: "auth/weak-password" });
      if (!acceptTerms || !acceptTerms.checked) {
        return showError("Aby utworzyć konto, musisz zaakceptować regulamin i zasady prywatności.");
      }
      try {
        disable(true);
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        try {
          await sendEmailVerification(cred.user);
        } catch(e) {
          console.warn('[Email verification] Nie udało się wysłać maila weryfikacyjnego', e);
        }
        const ref = doc(db, 'users', cred.user.uid, 'gt', 'state');
        await setDoc(ref, { localStorage: {}, updatedAt: serverTimestamp(), version: 1 }, { merge: true });
      } catch(e) { showError(e); } finally { disable(false); }
    };
    if (resetBtn) {
      resetBtn.onclick = async () => {
        const email = (emailEl.value || '').trim().toLowerCase();
        if (!validEmail(email)) return showError({ code: 'auth/invalid-email' });
        try {
          disable(true);
          await sendPasswordResetEmail(auth, email);
          err.textContent = 'Jeśli konto istnieje, wysłaliśmy link do resetu hasła na podany email.';
          setTimeout(() => { if (err.textContent) err.textContent = ''; }, 8000);
        } catch(e) {
          console.error(e);
          err.textContent = 'Jeśli konto istnieje, wysłaliśmy link do resetu hasła na podany email.';
          setTimeout(() => { if (err.textContent) err.textContent = ''; }, 8000);
        } finally {
          disable(false);
        }
      };
    }

    logoutBtn.onclick = async () => { await signOut(auth); };
    if (resendVerifyBtn) {
      resendVerifyBtn.onclick = async () => {
        const user = auth.currentUser;
        if (!user) {
          if (verifyErr) verifyErr.textContent = 'Brak zalogowanego użytkownika.';
          return;
        }
        try {
          resendVerifyBtn.disabled = true;
          if (verifyErr) verifyErr.textContent = '';
          await sendEmailVerification(user);
          if (verifyErr) verifyErr.textContent = 'Link weryfikacyjny został wysłany ponownie.';
        } catch(e) {
          console.error(e);
          if (verifyErr) verifyErr.textContent = 'Nie udało się wysłać maila weryfikacyjnego: ' + (e && e.message ? e.message : e);
        } finally {
          resendVerifyBtn.disabled = false;
        }
      };
    }
    if (refreshVerifyBtn) {
      refreshVerifyBtn.onclick = () => {
        window.location.reload();
      };
    }



    let lastSnapshot = {};
    let timer = null;
    const debounce = (uid) => { clearTimeout(timer); timer = setTimeout(async()=>{
      try { const sanitized = sanitizeSnapshot(lastSnapshot);
        await setDoc(doc(db, 'users', uid, 'gt', 'state'), { localStorage: sanitized, updatedAt: serverTimestamp(), version:1 }, { merge:true }); }
      catch(e){ console.error(e); }
    }, 250); };


    // Global helper for password change (used from iframe Settings)
    window.__requestPasswordChange = async (newPassword) => {
      const user = auth.currentUser;
      if (!user) {
        alert('Brak zalogowanego użytkownika.');
        return;
      }
      try {
        await updatePassword(user, newPassword);
        alert('Hasło zostało zmienione.');
      } catch (e) {
        console.error('Błąd przy zmianie hasła:', e);
        if (e && e.code === 'auth/requires-recent-login') {
          alert('Aby zmienić hasło, wyloguj się i zaloguj ponownie, a następnie spróbuj ponownie.');
        } else if (e && e.code === 'auth/weak-password') {
          alert('Hasło jest zbyt słabe. Użyj co najmniej 6 znaków, najlepiej z cyframi i liczbami.');
        } else {
          alert('Nie udało się zmienić hasła. Spróbuj ponownie później.');
        }
      }
    };

    // Global helper for account deactivation (used from iframe Settings)
    window.__requestAccountDeletion = async () => {
      const user = auth.currentUser;
      if (!user) {
        alert('Brak zalogowanego użytkownika.');
        return;
      }

      const ok = window.confirm('Czy na pewno chcesz dezaktywować konto i usunąć wszystkie dane?\nTej operacji nie można cofnąć.');
      if (!ok) return;

      try {
        // 1. Usuń dane użytkownika z Firestore (kolekcja users/{uid}/gt/*)
        try {
          const colRef = collection(db, 'users', user.uid, 'gt');
          const snap = await getDocs(colRef);
          const deletions = [];
          snap.forEach((docSnap) => {
            deletions.push(deleteDoc(docSnap.ref));
          });
          await Promise.all(deletions);
        } catch (e) {
          console.error('Błąd przy usuwaniu danych Firestore:', e);
        }

        // 2. Usuń konto użytkownika z Firebase Auth
        try {
          await deleteUser(user);
        } catch (e) {
          console.error('Błąd przy usuwaniu konta:', e);
          if (e && e.code === 'auth/requires-recent-login') {
            alert('Aby dezaktywować konto, zaloguj się ponownie i spróbuj jeszcze raz.');
            return;
          } else {
            alert('Nie udało się usunąć konta. Spróbuj ponownie później.');
            return;
          }
        }

        // 3. Wyloguj (na wszelki wypadek) i wyczyść stan lokalny
        try {
          lastSnapshot = {};
        } catch(_){}
        try {
          await signOut(auth);
        } catch(_){}

        alert('Konto zostało dezaktywowane i dane zostały usunięte.');
      } catch (e) {
        console.error('Błąd przy dezaktywacji konta:', e);
        alert('Wystąpił błąd podczas dezaktywacji konta. Spróbuj ponownie później.');
      }
    };


    const APP_B64 = "PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9InBsIj4KPGhlYWQ+CjxiYXNlIGhyZWY9Il9fQkFTRV9fIj4KCjwhLS0gR1Qgd3JhcHBlcjogTFMgYWRhcHRlciArIEZpcmVzdG9yZSBzdHVicyArIGZpcmV3YWxsICsgYXV0by1zeW5jIC0tPgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBjb25zdCBMU19QUkVGSVg9IkdUX011bHRpVXNlcl92MV9fIjsKICBjb25zdCBQVVJHRV9VTlBSRUZJWEVEPWZhbHNlOwoKICAvLyAtLS0gTmV0d29yayBmaXJld2FsbDogYmxvY2sgRmlyZWJhc2UvRmlyZXN0b3JlIGVuZHBvaW50cyBmcm9tIGlubmVyIGFwcCAtLS0KICAoZnVuY3Rpb24oKXsKICAgIGNvbnN0IEJMT0NLID0gLyhefFwuKWZpcmViYXNlaW9cLmNvbSR8KF58XC4pKGdzdGF0aWN8Z29vZ2xlYXBpcylcLmNvbSR8KF58XC4pKGZpcmVzdG9yZVwuZ29vZ2xlYXBpcylcLmNvbSQvaTsKICAgIHRyeXsKICAgICAgY29uc3QgX2ZldGNoID0gd2luZG93LmZldGNoOwogICAgICB3aW5kb3cuZmV0Y2ggPSBmdW5jdGlvbihpbnB1dCwgaW5pdCl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHVybCA9ICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSA/IGlucHV0IDogKGlucHV0ICYmIGlucHV0LnVybCkgfHwgJyc7CiAgICAgICAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgICAgaWYgKEJMT0NLLnRlc3QodS5ob3N0bmFtZSkpIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0Jsb2NrZWQgYnkgaWZyYW1lIGZpcmV3YWxsOiAnK3UuaG9zdG5hbWUpKTsKICAgICAgICB9IGNhdGNoKF9lKXt9CiAgICAgICAgcmV0dXJuIF9mZXRjaC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfWNhdGNoKF9lKXt9CiAgICB0cnl7CiAgICAgIGNvbnN0IF9vcGVuID0gWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLm9wZW47CiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgICAgaWYgKEJMT0NLLnRlc3QodS5ob3N0bmFtZSkpIHsgdGhpcy5fX2Jsb2NrZWRfYnlfZmlyZXdhbGxfXyA9IHRydWU7IH0KICAgICAgICB9IGNhdGNoKF9lKXt9CiAgICAgICAgcmV0dXJuIF9vcGVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICAgIGNvbnN0IF9zZW5kID0gWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLnNlbmQ7CiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5fX2Jsb2NrZWRfYnlfZmlyZXdhbGxfXykgeyB0aGlzLmFib3J0KCk7IHRocm93IG5ldyBFcnJvcignQmxvY2tlZCBieSBpZnJhbWUgZmlyZXdhbGwgKFhIUiknKTsgfQogICAgICAgIHJldHVybiBfc2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfWNhdGNoKF9lKXt9CiAgfSkoKTsKCiAgLy8gLS0tIExvY2FsU3RvcmFnZSBhZGFwdGVyIHdpdGggcHJlZml4ICsgb3B0aW9uYWwgcHVyZ2Ugb2Ygb2xkIGtleXMgLS0tCiAgKGZ1bmN0aW9uKCl7CiAgICBjb25zdCBvcmlnPXdpbmRvdy5sb2NhbFN0b3JhZ2U7CiAgICB0cnl7CiAgICAgIGlmKFBVUkdFX1VOUFJFRklYRUQpewogICAgICAgIGNvbnN0IHRvRGVsPVtdOwogICAgICAgIGZvcihsZXQgaT0wO2k8b3JpZy5sZW5ndGg7aSsrKXtjb25zdCBrPW9yaWcua2V5KGkpOyBpZihrICYmICFrLnN0YXJ0c1dpdGgoTFNfUFJFRklYKSkgdG9EZWwucHVzaChrKTt9CiAgICAgICAgdG9EZWwuZm9yRWFjaChrPT57dHJ5e29yaWcucmVtb3ZlSXRlbShrKTt9Y2F0Y2goX2Upe319KTsKICAgICAgfQogICAgfWNhdGNoKF9lKXt9CiAgICBjb25zdCBtYXBLZXk9KGspPT5MU19QUkVGSVgrazsKICAgIGNvbnN0IF9zZXQ9b3JpZy5zZXRJdGVtLmJpbmQob3JpZyk7CiAgICBjb25zdCBfZ2V0PW9yaWcuZ2V0SXRlbS5iaW5kKG9yaWcpOwogICAgY29uc3QgX3JlbT1vcmlnLnJlbW92ZUl0ZW0uYmluZChvcmlnKTsKICAgIFN0b3JhZ2UucHJvdG90eXBlLnNldEl0ZW09ZnVuY3Rpb24oayx2KXsgdHJ5e19zZXQobWFwS2V5KGspLHYpO31jYXRjaChfZSl7fTsgdHJ5e3BhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTonc3RvcmFnZV9ldmVudCcsa2V5OmssdmFsdWU6dn0sJyonKTt9Y2F0Y2goX2Upe307IH07CiAgICBTdG9yYWdlLnByb3RvdHlwZS5nZXRJdGVtPWZ1bmN0aW9uKGspeyByZXR1cm4gX2dldChtYXBLZXkoaykpOyB9OwogICAgU3RvcmFnZS5wcm90b3R5cGUucmVtb3ZlSXRlbT1mdW5jdGlvbihrKXsgdHJ5e19yZW0obWFwS2V5KGspKTt9Y2F0Y2goX2Upe307IHRyeXtwYXJlbnQucG9zdE1lc3NhZ2Uoe3R5cGU6J3N0b3JhZ2VfZXZlbnQnLGtleTprLHZhbHVlOm51bGx9LCcqJyk7fWNhdGNoKF9lKXt9OyB9OwogICAgU3RvcmFnZS5wcm90b3R5cGUuY2xlYXI9ZnVuY3Rpb24oKXsgdHJ5e2NvbnN0IGtleXM9W107IGZvcihsZXQgaT0wO2k8b3JpZy5sZW5ndGg7aSsrKXtjb25zdCBrZXk9b3JpZy5rZXkoaSk7IGlmKGtleSYma2V5LnN0YXJ0c1dpdGgoTFNfUFJFRklYKSkga2V5cy5wdXNoKGtleSk7fSBrZXlzLmZvckVhY2goaz0+X3JlbShrKSk7fWNhdGNoKF9lKXt9OyB0cnl7cGFyZW50LnBvc3RNZXNzYWdlKHt0eXBlOidzdG9yYWdlX2NsZWFyJ30sJyonKTt9Y2F0Y2goX2Upe307IH07CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsKGV2KT0+ewogICAgICBjb25zdCBtc2c9ZXYuZGF0YXx8e307CiAgICAgIGlmKG1zZy50eXBlPT09J3N0b3JhZ2VfYXBwbHknJiZtc2cucGF5bG9hZCl7CiAgICAgICAgT2JqZWN0LmtleXMobXNnLnBheWxvYWQpLmZvckVhY2goaz0+eyB0cnl7X3NldChtYXBLZXkoayksbXNnLnBheWxvYWRba10pO31jYXRjaChfZSl7fTsgfSk7CiAgICAgIH0gZWxzZSBpZihtc2cudHlwZT09PSdzZXRfY2xlYXJfb25fZXhpdCcpeyB3aW5kb3cuX19HVF9DTEVBUl9PTl9FWElUX189ISFtc2cudmFsdWU7IH0KICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsKCk9PnsKICAgICAgaWYod2luZG93Ll9fR1RfQ0xFQVJfT05fRVhJVF9fKXsKICAgICAgICB0cnl7Y29uc3Qga2V5cz1bXTsgZm9yKGxldCBpPTA7aTxvcmlnLmxlbmd0aDtpKyspe2NvbnN0IGtleT1vcmlnLmtleShpKTsgaWYoa2V5JiZrZXkuc3RhcnRzV2l0aChMU19QUkVGSVgpKSBrZXlzLnB1c2goa2V5KTt9IGtleXMuZm9yRWFjaChrPT57dHJ5e19yZW0oayk7fWNhdGNoKF9lKXt9fSk7fWNhdGNoKF9lKXt9CiAgICAgIH0KICAgIH0pOwogICAgdHJ5eyBwYXJlbnQucG9zdE1lc3NhZ2Uoe3R5cGU6J3JlcXVlc3RfaW5pdCd9LCcqJyk7IH1jYXRjaChfZSl7fQogIH0pKCk7CgogIC8vIC0tLSBGaXJlc3RvcmUgY29tcGF0IHN0dWJzIGJhY2tlZCBieSBsb2NhbFN0b3JhZ2UgKGtleTogR1RGU19TVE9SRSkgKyBhdXRvLXN5bmMgaG9vayAtLS0KICAoZnVuY3Rpb24oKXsKICAgIGZ1bmN0aW9uIG5vb3AoKXt9CiAgICBmdW5jdGlvbiByZXNvbHZlZCh2KXsgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2KTsgfQogICAgZnVuY3Rpb24gbm93KCl7IHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7IH0KCiAgICBjb25zdCBTVFVCX0tFWSA9ICJHVEZTX1NUT1JFIjsKCiAgICBmdW5jdGlvbiBsb2FkU3RvcmUoKXsKICAgICAgdHJ5eyBjb25zdCByYXcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVFVCX0tFWSk7IGlmKCFyYXcpIHJldHVybiB7IGM6e30gfTsgcmV0dXJuIEpTT04ucGFyc2UocmF3KTsgfWNhdGNoKGUpeyByZXR1cm4geyBjOnt9IH07IH0KICAgIH0KICAgIGZ1bmN0aW9uIHNhdmVTdG9yZShzdG9yZSl7CiAgICAgIHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RVQl9LRVksIEpTT04uc3RyaW5naWZ5KHN0b3JlKSk7IH1jYXRjaChfZSl7fQogICAgfQogICAgY29uc3Qgc3RvcmUgPSBsb2FkU3RvcmUoKTsKCiAgICBmdW5jdGlvbiBjbG9uZSh2KXsgdHJ5eyByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh2KSk7IH1jYXRjaChfZSl7IHJldHVybiB2OyB9IH0KICAgIGZ1bmN0aW9uIGVuc3VyZUNvbChuYW1lKXsgaWYoIXN0b3JlLmNbbmFtZV0pIHN0b3JlLmNbbmFtZV0gPSB7fTsgcmV0dXJuIHN0b3JlLmNbbmFtZV07IH0KICAgIGZ1bmN0aW9uIG1ha2VJZCgpeyByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiwgMTApICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiwgMTApOyB9CgogICAgZnVuY3Rpb24gbWFrZURvY1NuYXBzaG90KGlkLCBkYXRhKXsKICAgICAgcmV0dXJuIHsgaWQsIGV4aXN0czogZGF0YSAhPSBudWxsLCBkYXRhOiAoKSA9PiBjbG9uZShkYXRhIHx8IHt9KSB9OwogICAgfQogICAgZnVuY3Rpb24gbWFrZVF1ZXJ5U25hcHNob3QoZG9jcyl7CiAgICAgIHJldHVybiB7IGVtcHR5OiAhZG9jcyB8fCBkb2NzLmxlbmd0aCA9PT0gMCwgc2l6ZTogKGRvY3MgfHwgW10pLmxlbmd0aCwgZG9jczogKGRvY3MgfHwgW10pLm1hcChkID0+ICh7IGlkOiBkLmlkLCBkYXRhOiAoKSA9PiBjbG9uZShkLmRhdGEpIH0pKSB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5V2hlcmUoYXJyLCBmaWVsZCwgb3AsIHZhbHVlKXsKICAgICAgaWYgKCFhcnIpIHJldHVybiBbXTsKICAgICAgaWYgKG9wICE9PSAnPT0nICYmIG9wICE9PSAnaW4nICYmIG9wICE9PSAnYXJyYXktY29udGFpbnMnICYmIG9wICE9PSAnPj0nICYmIG9wICE9PSAnPD0nICYmIG9wICE9PSAnPicgJiYgb3AgIT09ICc8JykgcmV0dXJuIGFycjsKICAgICAgcmV0dXJuIGFyci5maWx0ZXIoaXRlbSA9PiB7CiAgICAgICAgY29uc3QgdiA9IGl0ZW0uZGF0YVtmaWVsZF07CiAgICAgICAgc3dpdGNoKG9wKXsKICAgICAgICAgIGNhc2UgJz09JzogcmV0dXJuIHYgPT09IHZhbHVlOwogICAgICAgICAgY2FzZSAnPj0nOiByZXR1cm4gdiA+PSB2YWx1ZTsKICAgICAgICAgIGNhc2UgJzw9JzogcmV0dXJuIHYgPD0gdmFsdWU7CiAgICAgICAgICBjYXNlICc+JzogIHJldHVybiB2ID4gIHZhbHVlOwogICAgICAgICAgY2FzZSAnPCc6ICByZXR1cm4gdiA8ICB2YWx1ZTsKICAgICAgICAgIGNhc2UgJ2luJzogcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmluY2x1ZGVzKHYpOwogICAgICAgICAgY2FzZSAnYXJyYXktY29udGFpbnMnOiByZXR1cm4gQXJyYXkuaXNBcnJheSh2KSAmJiB2LmluY2x1ZGVzKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbGxlY3Rpb25SZWYobmFtZSl7CiAgICAgIGNvbnN0IGFwaSA9IHt9OwogICAgICBhcGkuZG9jID0gZnVuY3Rpb24oaWQpewogICAgICAgIGNvbnN0IGRvY0lkID0gaWQgfHwgbWFrZUlkKCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGlkOiBkb2NJZCwKICAgICAgICAgIGdldDogKCkgPT4geyBjb25zdCBjb2wgPSBlbnN1cmVDb2wobmFtZSk7IGNvbnN0IGRhdGEgPSBjb2xbZG9jSWRdOyByZXR1cm4gcmVzb2x2ZWQobWFrZURvY1NuYXBzaG90KGRvY0lkLCBkYXRhKSk7IH0sCiAgICAgICAgICBzZXQ6IChkYXRhLCBvcHRzKSA9PiB7IGNvbnN0IGNvbCA9IGVuc3VyZUNvbChuYW1lKTsgY29sW2RvY0lkXSA9IChvcHRzICYmIG9wdHMubWVyZ2UpID8gT2JqZWN0LmFzc2lnbih7fSwgY29sW2RvY0lkXXx8e30sIGNsb25lKGRhdGEpKSA6IGNsb25lKGRhdGEpOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoKTsgfSwKICAgICAgICAgIHVwZGF0ZTogKHBhdGNoKSA9PiB7IGNvbnN0IGNvbCA9IGVuc3VyZUNvbChuYW1lKTsgY29sW2RvY0lkXSA9IE9iamVjdC5hc3NpZ24oe30sIGNvbFtkb2NJZF18fHt9LCBjbG9uZShwYXRjaCkpOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoKTsgfSwKICAgICAgICAgIGRlbGV0ZTogKCkgPT4geyBjb25zdCBjb2wgPSBlbnN1cmVDb2wobmFtZSk7IGRlbGV0ZSBjb2xbZG9jSWRdOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoKTsgfSwKICAgICAgICAgIG9uU25hcHNob3Q6IChjYikgPT4geyBjb25zdCBjb2wgPSBlbnN1cmVDb2wobmFtZSk7IGNvbnN0IGRhdGEgPSBjb2xbZG9jSWRdOyB0cnl7IGNiKG1ha2VEb2NTbmFwc2hvdChkb2NJZCwgZGF0YSkpOyB9Y2F0Y2goX2Upe30gcmV0dXJuIG5vb3A7IH0KICAgICAgICB9OwogICAgICB9OwogICAgICBhcGkuYWRkID0gZnVuY3Rpb24oZGF0YSl7IGNvbnN0IGlkID0gbWFrZUlkKCk7IGNvbnN0IGNvbCA9IGVuc3VyZUNvbChuYW1lKTsgY29sW2lkXSA9IGNsb25lKGRhdGEpOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoeyBpZCB9KTsgfTsKCiAgICAgIGZ1bmN0aW9uIHF1ZXJ5T2JqKGxpc3QpewogICAgICAgIGNvbnN0IHEgPSB7fTsKICAgICAgICBxLl9saXN0ID0gbGlzdCB8fCBPYmplY3QuZW50cmllcyhlbnN1cmVDb2wobmFtZSkpLm1hcCgoW2lkLGRhdGFdKSA9PiAoeyBpZCwgZGF0YSB9KSk7CiAgICAgICAgcS53aGVyZSA9IGZ1bmN0aW9uKGZpZWxkLCBvcCwgdmFsdWUpeyBxLl9saXN0ID0gYXBwbHlXaGVyZShxLl9saXN0LCBmaWVsZCwgb3AsIHZhbHVlKTsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5vcmRlckJ5ID0gZnVuY3Rpb24oZmllbGQsIGRpcil7IHEuX2xpc3Quc29ydCgoYSxiKT0+eyBpZiAoYS5kYXRhW2ZpZWxkXSA9PSBiLmRhdGFbZmllbGRdKSByZXR1cm4gMDsgcmV0dXJuIChhLmRhdGFbZmllbGRdIDwgYi5kYXRhW2ZpZWxkXSA/IC0xIDogMSkgKiAoZGlyPT09J2Rlc2MnPy0xOjEpOyB9KTsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5saW1pdCA9IGZ1bmN0aW9uKG4peyBxLl9saXN0ID0gcS5fbGlzdC5zbGljZSgwLCBuKTsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5zdGFydEFmdGVyID0gZnVuY3Rpb24oKXsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5lbmRCZWZvcmUgPSBmdW5jdGlvbigpeyByZXR1cm4gcTsgfTsKICAgICAgICBxLmdldCA9IGZ1bmN0aW9uKCl7IHJldHVybiByZXNvbHZlZChtYWtlUXVlcnlTbmFwc2hvdChxLl9saXN0KSk7IH07CiAgICAgICAgcS5vblNuYXBzaG90ID0gZnVuY3Rpb24oY2IpeyB0cnl7IGNiKG1ha2VRdWVyeVNuYXBzaG90KHEuX2xpc3QpKTsgfWNhdGNoKF9lKXt9OyByZXR1cm4gbm9vcDsgfTsKICAgICAgICByZXR1cm4gcTsKICAgICAgfQogICAgICBhcGkud2hlcmUgPSBmdW5jdGlvbihmaWVsZCwgb3AsIHZhbHVlKXsgcmV0dXJuIHF1ZXJ5T2JqKCkud2hlcmUoZmllbGQsIG9wLCB2YWx1ZSk7IH07CiAgICAgIGFwaS5nZXQgPSBmdW5jdGlvbigpeyByZXR1cm4gcXVlcnlPYmooKS5nZXQoKTsgfTsKICAgICAgYXBpLm9uU25hcHNob3QgPSBmdW5jdGlvbihjYil7IHJldHVybiBxdWVyeU9iaigpLm9uU25hcHNob3QoY2IpOyB9OwoKICAgICAgcmV0dXJuIGFwaTsKICAgIH0KCiAgICBpZiAoIXdpbmRvdy5maXJlYmFzZSkgd2luZG93LmZpcmViYXNlID0ge307CiAgICB3aW5kb3cuZmlyZWJhc2UuYXBwcyA9IFt7fV07CiAgICB3aW5kb3cuZmlyZWJhc2UuaW5pdGlhbGl6ZUFwcCA9IGZ1bmN0aW9uKCl7IHJldHVybiB7fTsgfTsKICAgIHdpbmRvdy5maXJlYmFzZS5maXJlc3RvcmUgPSBmdW5jdGlvbigpeyByZXR1cm4geyBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uUmVmLCBkb2M6IChpZCk9PmNvbGxlY3Rpb25SZWYoJ19yb290JykuZG9jKGlkKSwgRmllbGRWYWx1ZTogeyBzZXJ2ZXJUaW1lc3RhbXA6ICgpID0+ICh7IF9fc2VydmVyVGltZXN0YW1wOnRydWUsIGF0OiBub3coKSB9KSB9IH07IH07CiAgICB3aW5kb3cuZmlyZWJhc2UuZmlyZXN0b3JlLkZpZWxkVmFsdWUgPSB7IHNlcnZlclRpbWVzdGFtcDogKCkgPT4gKHsgX19zZXJ2ZXJUaW1lc3RhbXA6dHJ1ZSwgYXQ6IG5vdygpIH0pIH07CiAgICB3aW5kb3cuZmlyZWJhc2UuYXV0aCA9IGZ1bmN0aW9uKCl7IHJldHVybiB7IHNldFBlcnNpc3RlbmNlOiAoKT0+cmVzb2x2ZWQoKSwgc2lnbkluQW5vbnltb3VzbHk6ICgpPT5yZXNvbHZlZCh7IHVzZXI6eyB1aWQ6J3N0dWInIH0gfSksIGN1cnJlbnRVc2VyOiB7IHVpZDonc3R1YicgfSwgb25BdXRoU3RhdGVDaGFuZ2VkOiAoY2IpPT57IHRyeXsgY2IoeyB1aWQ6J3N0dWInIH0pOyB9Y2F0Y2goX2Upe307IHJldHVybiAoKT0+e307IH0gfTsgfTsKICAgIHdpbmRvdy5maXJlYmFzZS5hdXRoLkF1dGggPSB7IFBlcnNpc3RlbmNlOiB7IExPQ0FMOidMT0NBTCcsIFNFU1NJT046J1NFU1NJT04nLCBOT05FOidOT05FJyB9IH07CiAgICBjb25zb2xlLmxvZygiR1QgRmlyZXN0b3JlIHN0dWI6IHJlYWR5Iik7CgogICAgLy8gLS0tIEF1dG8tc3luYyBoYW5kbGVyIGZyb20gd3JhcHBlciAtLS0KICAgIGZ1bmN0aW9uIHNlZWRTdHViRnJvbUxvY2FsKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBMU19LRVkgPSAodHlwZW9mIGRldGVjdExTS2V5PT09J2Z1bmN0aW9uJykgPyBkZXRlY3RMU0tleSgpIDogJ3BvcnRmZWxlX2Zpcm15X3YxJzsKICAgICAgICBjb25zdCByYXcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19LRVkpOwogICAgICAgIGlmICghcmF3KSByZXR1cm4gZmFsc2U7CiAgICAgICAgbGV0IGRhdGE9bnVsbDsgdHJ5eyBkYXRhID0gSlNPTi5wYXJzZShyYXcpOyB9Y2F0Y2goX2UpeyByZXR1cm4gZmFsc2U7IH0KICAgICAgICBjb25zdCBGQl9DT0wgPSAodHlwZW9mIHdpbmRvdy5GQl9DT0whPT0ndW5kZWZpbmVkJykgPyB3aW5kb3cuRkJfQ09MIDogJ2d0X3BvcnRmb2xpb3MnOwogICAgICAgIGNvbnN0IEZCX0RPQyA9ICh0eXBlb2Ygd2luZG93LkZCX0RPQyE9PSd1bmRlZmluZWQnKSA/IHdpbmRvdy5GQl9ET0MgOiAnZGVmYXVsdCc7CiAgICAgICAgY29uc3QgY29sID0gZW5zdXJlQ29sKEZCX0NPTCk7CiAgICAgICAgY29sW0ZCX0RPQ10gPSBjbG9uZShkYXRhKTsKICAgICAgICBzYXZlU3RvcmUoc3RvcmUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9Y2F0Y2goX2UpewogICAgICAgIGNvbnNvbGUud2Fybignc2VlZFN0dWJGcm9tTG9jYWwgZXJyb3InLCBfZSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdHJ5SGFyZERvd25sb2FkKCl7CiAgICAgIHRyeXsKICAgICAgICBpZiAodHlwZW9mIGhhcmREb3dubG9hZD09PSdmdW5jdGlvbicpewogICAgICAgICAgcmV0dXJuIGhhcmREb3dubG9hZCh0cnVlKTsKICAgICAgICB9CiAgICAgIH1jYXRjaChfZSl7IGNvbnNvbGUud2FybignaGFyZERvd25sb2FkIGNhbGwgZXJyb3InLCBfZSk7IH0KICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7CiAgICB9CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZXYpPT57CiAgICAgIGNvbnN0IG1zZyA9IGV2LmRhdGF8fHt9OwogICAgICBpZiAobXNnLnR5cGU9PT0nYXV0b19zeW5jJyl7CiAgICAgICAgY29uc3Qgc2VlZGVkID0gc2VlZFN0dWJGcm9tTG9jYWwoKTsKICAgICAgICAvLyBuYXdldCBqZcWbbGkgbmllIHVkYcWCbyBzacSZIHphc2lsacSHLCBzcHLDs2J1aiBwb2JyYcSHCiAgICAgICAgdHJ5SGFyZERvd25sb2FkKCk7CiAgICAgIH0KICAgIH0pOwogIH0pKCk7Cn0pKCk7Cjwvc2NyaXB0PgoKCiAgPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIiAvPgogIDx0aXRsZT5Qb3J0ZmVsZSDigJQgdjI8L3RpdGxlPgogIDxzdHlsZT4KICAgIDpyb290ewogICAgICAtLWJnOiMwZjE3MmE7ICAgICAgICAvKiBzbGF0ZS05MDAgKi8KICAgICAgLS1wYW5lbDojMTExODI3OyAgICAgLyogZ3JheS05MDAgKi8KICAgICAgLS1wYW5lbC0yOiMxZjI5Mzc7ICAgLyogZ3JheS04MDAgKi8KICAgICAgLS1tdXRlZDojOTRhM2I4OyAgICAgLyogc2xhdGUtNDAwICovCiAgICAgIC0tdGV4dDojZTVlN2ViOyAgICAgIC8qIGdyYXktMjAwICovCiAgICAgIC0tYWNjZW50OiMyMmQzZWU7ICAgIC8qIGN5YW4tNDAwICovCiAgICAgIC0tYWNjZW50LTI6IzA2YjZkNDsgIC8qIGN5YW4tNTAwICovCiAgICAgIC0tZGFuZ2VyOiNlZjQ0NDQ7ICAgIC8qIHJlZC01MDAgKi8KICAgICAgLS1vazojMTBiOTgxOyAgICAgICAgLyogZW1lcmFsZC01MDAgKi8KICAgICAgLS13YXJuOiNmNTllMGI7ICAgICAgLyogYW1iZXItNTAwICovCiAgICAgIC0tc2hhZG93OiAwIDEwcHggMjVweCByZ2JhKDAsMCwwLC4zNSk7CiAgICAgIC0tcmFkaXVzOiAxNHB4OwogICAgfQogICAgKnsgYm94LXNpemluZzogYm9yZGVyLWJveDsgfQogICAgaHRtbCxib2R5e2hlaWdodDoxMDAlfQogICAgYm9keXsKICAgICAgbWFyZ2luOjA7CiAgICAgIGZvbnQtZmFtaWx5OiB1aS1zYW5zLXNlcmlmLCBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEludGVyLCBOb3RvIFNhbnMsIFVidW50dSwgQ2FudGFyZWxsLCBBcmlhbCwgQXBwbGUgQ29sb3IgRW1vamksIFNlZ29lIFVJIEVtb2ppLCBTZWdvZSBVSSBTeW1ib2w7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMjBkZWcsIzBiMTIyMiAwJSwjMGYxNzJhIDQwJSwgIzEwMTUyNSAxMDAlKTsKICAgICAgY29sb3I6IHZhcigtLXRleHQpOwogICAgfQogICAgaGVhZGVyewogICAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgICAgIHBhZGRpbmc6MTRweCAxOHB4OyBwb3NpdGlvbjpzdGlja3k7IHRvcDowOyB6LWluZGV4OjU7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgwZGVnLCByZ2JhKDE1LDIzLDQyLC42KSwgcmdiYSgxNSwyMyw0MiwuNikpOwogICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICMxMTE4Mjc7CiAgICAgIGJveC1zaGFkb3c6IHZhcigtLXNoYWRvdyk7CiAgICB9CiAgICBoZWFkZXIgaDF7IG1hcmdpbjowOyBmb250LXdlaWdodDo3MDA7IGZvbnQtc2l6ZTogY2xhbXAoMThweCwgMnZ3LCAyMnB4KTsgbGV0dGVyLXNwYWNpbmc6LjNweDsgfQogICAgaGVhZGVyIC5hY3Rpb25zeyBkaXNwbGF5OmZsZXg7IGdhcDo4cHg7IGZsZXgtd3JhcDp3cmFwO30KICAgIC5idG57CiAgICAgIGJvcmRlcjpub25lOyBib3JkZXItcmFkaXVzOjEwcHg7CiAgICAgIHBhZGRpbmc6MTBweCAxNHB4OyBjb2xvcjojMGIxMjIyOyBmb250LXdlaWdodDo2MDA7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWFjY2VudCk7IGN1cnNvcjpwb2ludGVyOwogICAgICB0cmFuc2l0aW9uOi4ycyB0cmFuc2Zvcm0gZWFzZSwgLjJzIGJveC1zaGFkb3cgZWFzZSwgLjJzIGZpbHRlciBlYXNlOwogICAgICBib3gtc2hhZG93OiAwIDhweCAyMHB4IHJnYmEoMzQsMjExLDIzOCwuMjUpOwogICAgfQogICAgLmJ0bjpob3ZlcnsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xcHgpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS4wNSk7IH0KICAgIC5idG46YWN0aXZleyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KSBzY2FsZSguOTgpOyB9CiAgICAuYnRuLnNlY29uZGFyeXsgYmFja2dyb3VuZDojMzM0MTU1OyBjb2xvcjogdmFyKC0tdGV4dCk7IGJveC1zaGFkb3c6bm9uZTsgfQogICAgLmJ0bi5naG9zdHsgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7IGNvbG9yOiB2YXIoLS10ZXh0KTsgYm9yZGVyOjFweCBzb2xpZCAjMzM0MTU1OyB9CiAgICAuYnRuLndhcm57IGJhY2tncm91bmQ6IHZhcigtLXdhcm4pOyBjb2xvcjojMGIxMjIyOyB9CiAgICAuYnRuLmRhbmdlcnsgYmFja2dyb3VuZDogdmFyKC0tZGFuZ2VyKTsgY29sb3I6I2ZmZjsgfQogICAgLmJ0bi5va3sgYmFja2dyb3VuZDogdmFyKC0tb2spOyBjb2xvcjojMGIxMjIyOyB9CiAgICAubGF5b3V0eyBkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMzMwcHggMWZyOyBnYXA6MTRweDsgcGFkZGluZzoxNHB4OyB9CiAgICBAbWVkaWEgKG1heC13aWR0aDogOTgwcHgpeyAubGF5b3V0eyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsgfSB9CiAgICAuY2FyZHsKICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgxNywyNCwzOSwuODUpLCByZ2JhKDE2LDIzLDQyLC45MikpOwogICAgICBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7CiAgICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLXJhZGl1cyk7CiAgICAgIGJveC1zaGFkb3c6IHZhcigtLXNoYWRvdyk7CiAgICB9CiAgICAuc2lkZWJhcnsgcGFkZGluZzoxNHB4OyBtaW4taGVpZ2h0OiBjYWxjKDEwMHN2aCAtIDgwcHgpOyB9CiAgICAuc2lkZWJhciAuaGVhZHsgZGlzcGxheTpmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6Y2VudGVyOyBtYXJnaW4tYm90dG9tOjhweDsgfQogICAgLnBvcnRmb2xpb3N7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBnYXA6OHB4OyB9CiAgICAucG9ydGZvbGlvLWl0ZW17CiAgICAgIHBhZGRpbmc6MTBweDsgYm9yZGVyLXJhZGl1czoxMnB4OyBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICMwZjE3MmEsICMwYjEyMjIpOwogICAgICBjdXJzb3I6cG9pbnRlcjsgdHJhbnNpdGlvbjouMTVzIGVhc2U7CiAgICB9CiAgICAucG9ydGZvbGlvLWl0ZW06aG92ZXJ7IGJvcmRlci1jb2xvcjojMzM0MTU1OyB9CiAgICAucG9ydGZvbGlvLWl0ZW0uYWN0aXZleyBib3JkZXItY29sb3I6IHZhcigtLWFjY2VudCk7IGJveC1zaGFkb3c6IDAgMCAwIDFweCBpbnNldCB2YXIoLS1hY2NlbnQpOyB9CiAgICAucG9ydGZvbGlvLWl0ZW0gLm5hbWV7IGZvbnQtd2VpZ2h0OjcwMDsgZm9udC1zaXplOjE1cHg7IH0KICAgIC5wb3J0Zm9saW8taXRlbSAucm93eyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBnYXA6OHB4OyBjb2xvcjogdmFyKC0tbXV0ZWQpOyBmb250LXNpemU6MTNweDsgbWFyZ2luLXRvcDo0cHg7IH0KICAgIC5tYWlueyBwYWRkaW5nOjE0cHg7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBnYXA6MTRweDsgfQogICAgLnBhbmVseyBwYWRkaW5nOjE0cHg7IH0KICAgIC5wYW5lbCBoMnsgbWFyZ2luOjAgMCAxMHB4IDA7IGZvbnQtc2l6ZToxOHB4OyB9CiAgICAuZ3JpZHsgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgxMiwgMWZyKTsgZ2FwOjE0cHg7IH0KICAgIC5jb2wtNHsgZ3JpZC1jb2x1bW46IHNwYW4gNDsgfSAuY29sLTZ7IGdyaWQtY29sdW1uOiBzcGFuIDY7IH0gLmNvbC04eyBncmlkLWNvbHVtbjogc3BhbiA4OyB9IC5jb2wtMTJ7IGdyaWQtY29sdW1uOiBzcGFuIDEyOyB9CiAgICBAbWVkaWEgKG1heC13aWR0aDogOTgwcHgpeyAuY29sLTQsLmNvbC02LC5jb2wtOHsgZ3JpZC1jb2x1bW46IHNwYW4gMTI7IH0gfQogICAgLnN0YXR7CiAgICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICAgICAgcGFkZGluZzoxMnB4OyBib3JkZXItcmFkaXVzOjEycHg7IGJhY2tncm91bmQ6IzBiMTIyMjsgYm9yZGVyOjFweCBzb2xpZCAjMWYyOTM3OwogICAgfQogICAgLm11dGVkeyBjb2xvcjogdmFyKC0tbXV0ZWQpOyB9CiAgICAucm93eyBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjhweDsgZmxleC13cmFwOiB3cmFwOyB9CiAgICAuc3BhY2VyeyBmbGV4OiAxIDEgYXV0bzsgfQogICAgdGV4dGFyZWEsIGlucHV0LCBzZWxlY3R7CiAgICAgIHdpZHRoOjEwMCU7IHBhZGRpbmc6MTBweCAxMnB4OyBib3JkZXItcmFkaXVzOjEwcHg7IGJvcmRlcjoxcHggc29saWQgIzMzNDE1NTsgYmFja2dyb3VuZDojMGIxMjIyOwogICAgICBjb2xvcjp2YXIoLS10ZXh0KTsgb3V0bGluZTpub25lOyBmb250LXNpemU6MTRweDsKICAgIH0KICAgIGxhYmVseyBkaXNwbGF5OmJsb2NrOyBmb250LXNpemU6MTNweDsgY29sb3I6IHZhcigtLW11dGVkKTsgbWFyZ2luLWJvdHRvbTo2cHg7IH0KICAgIHRhYmxleyB3aWR0aDoxMDAlOyBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyB9CiAgICB0aCwgdGR7IHRleHQtYWxpZ246bGVmdDsgcGFkZGluZzoxMHB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCAjMWYyOTM3OyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyB9CiAgICB0aHsgY29sb3I6ICNjYmQ1ZTE7IGZvbnQtd2VpZ2h0OjcwMDsgYmFja2dyb3VuZDojMGIxMjIyOyBwb3NpdGlvbjpzdGlja3k7IHRvcDowOyB9CiAgICB0cjpob3ZlciB0ZHsgYmFja2dyb3VuZDogcmdiYSgzLCA3LCAxOCwgLjQpOyB9CiAgICAudGlja2VyeyBmb250LWZhbWlseTogdWktbW9ub3NwYWNlLCBTRk1vbm8tUmVndWxhciwgTWVubG8sIE1vbmFjbywgQ29uc29sYXMsICJMaWJlcmF0aW9uIE1vbm8iLCAiQ291cmllciBOZXciLCBtb25vc3BhY2U7IGxldHRlci1zcGFjaW5nOi4zcHg7IGZvbnQtd2VpZ2h0OjcwMDsgfQogICAgZGV0YWlscyBzdW1tYXJ5eyBjdXJzb3I6cG9pbnRlcjsgdXNlci1zZWxlY3Q6bm9uZTsgfQogICAgLnRhZ3sgcGFkZGluZzo0cHggOHB4OyBib3JkZXItcmFkaXVzOjk5OXB4OyBiYWNrZ3JvdW5kOiMxMTE4Mjc7IGJvcmRlcjoxcHggc29saWQgIzFmMjkzNzsgZm9udC1zaXplOjEycHg7IGNvbG9yOiNjYmQ1ZTE7IH0KICAgIGZvb3RlcnsgY29sb3I6dmFyKC0tbXV0ZWQpOyB0ZXh0LWFsaWduOmNlbnRlcjsgcGFkZGluZzoxOHB4IDhweDsgfQogICAgZGlhbG9neyBib3JkZXI6bm9uZTsgYm9yZGVyLXJhZGl1czoxNnB4OyBwYWRkaW5nOjA7IGJhY2tncm91bmQ6dHJhbnNwYXJlbnQ7IAogICAgICBjb2xvcjogdmFyKC0tdGV4dCk7Cn0KICAgIC5tb2RhbHsKICAgICAgY29sb3I6IHZhcigtLXRleHQpOwogYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgxNywyNCwzOSwuOTgpLCByZ2JhKDE1LDIzLDQyLC45OCkpOyBib3JkZXI6MXB4IHNvbGlkICMzMzQxNTU7IGJvcmRlci1yYWRpdXM6MTZweDsgd2lkdGg6bWluKDcyMHB4LCA5NnZ3KTsgYm94LXNoYWRvdzogdmFyKC0tc2hhZG93KTsgfQogICAgLm1vZGFsIGhlYWRlcnsgcG9zaXRpb246c3RpY2t5OyB0b3A6MDsgYmFja2dyb3VuZDp0cmFuc3BhcmVudDsgYm94LXNoYWRvdzpub25lOyBib3JkZXI6bm9uZTsgcGFkZGluZzoxNHB4OyB9CiAgICAubW9kYWwgLmNvbnRlbnR7IHBhZGRpbmc6MTRweDsgfQogICAgLm1vZGFsIGZvb3RlcnsgZGlzcGxheTpmbGV4OyBnYXA6OHB4OyBqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmQ7IHBhZGRpbmc6MTRweDsgfQogICAgLnNtYWxseyBmb250LXNpemU6MTJweDsgY29sb3I6dmFyKC0tbXV0ZWQpOyB9CiAgICAubm90ZXsgZm9udC1zaXplOjEzcHg7IGNvbG9yOiNlNWU3ZWI7IG9wYWNpdHk6Ljk7IH0KICAgIC5kYW5nZXItdGV4dHsgY29sb3I6IHZhcigtLWRhbmdlcik7IH0KICAgIC5vay10ZXh0eyBjb2xvcjogdmFyKC0tb2spOyB9CiAgICAKLndhcm4tdGV4dHsgY29sb3I6IHZhcigtLXdhcm4sICNmZmIwMjApOyB9Ci53YXJuLXN0cm9uZy10ZXh0eyBjb2xvcjojZmY2YTAwOyBmb250LXdlaWdodDo2MDA7IH0KLyogUGVyY2VudGFnZSBiYWRnZSBoZWxwZXIgKi8KLnBjdC1iYWRnZXsgZm9udC13ZWlnaHQ6NzAwOyBwYWRkaW5nOjJweCA2cHg7IGJvcmRlci1yYWRpdXM6OHB4OyBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LC4wNCk7IGRpc3BsYXk6aW5saW5lLWJsb2NrOyBtaW4td2lkdGg6NjJweDsgdGV4dC1hbGlnbjpyaWdodDsgfQoucGN0LXBvc3sgY29sb3I6IHZhcigtLW9rKTsgfQoucGN0LW5lZ3sgY29sb3I6IHZhcigtLWRhbmdlcik7IH0KLmNlbnRlcnsgdGV4dC1hbGlnbjpjZW50ZXI7IH0KICAgIC5saW5reyBjb2xvcjogdmFyKC0tYWNjZW50KTsgY3Vyc29yOnBvaW50ZXI7IHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOyB9CiAgCiAgICAubmVhci10YXJnZXR7IGFuaW1hdGlvbjogcHVsc2UgMS4ycyBpbmZpbml0ZTsgfQogICAgLmhpdC10YXJnZXR7IGFuaW1hdGlvbjogcHVsc2Utc3Ryb25nIDAuOHMgaW5maW5pdGU7IH0KICAgIEBrZXlmcmFtZXMgcHVsc2V7CiAgICAgIDAleyBib3gtc2hhZG93OiAwIDAgMCAwIHJnYmEoMTYsMTg1LDEyOSwuMzUpOyB9CiAgICAgIDUwJXsgYm94LXNoYWRvdzogMCAwIDAgNnB4IHJnYmEoMTYsMTg1LDEyOSwuMDUpOyBiYWNrZ3JvdW5kOiByZ2JhKDE2LDE4NSwxMjksLjA2KTsgfQogICAgICAxMDAleyBib3gtc2hhZG93OiAwIDAgMCAwIHJnYmEoMTYsMTg1LDEyOSwuMCk7IH0KICAgIH0KICAgIEBrZXlmcmFtZXMgcHVsc2Utc3Ryb25newogICAgICAwJXsgYm94LXNoYWRvdzogMCAwIDAgMCByZ2JhKDM0LDE5Nyw5NCwuNik7IH0KICAgICAgNTAleyBib3gtc2hhZG93OiAwIDAgMCAxMHB4IHJnYmEoMzQsMTk3LDk0LC4xMik7IGJhY2tncm91bmQ6IHJnYmEoMzQsMTk3LDk0LC4xMik7IH0KICAgICAgMTAwJXsgYm94LXNoYWRvdzogMCAwIDAgMCByZ2JhKDM0LDE5Nyw5NCwuMCk7IH0KICAgIH0KCiAgCiAgLyogPT09IENvbGxhcHNpYmxlIEhpc3RvcnkgPT09ICovCiAgI2hpc3RvcnlQYW5lbCAjdHhUYWJsZVdyYXAgeyB0cmFuc2l0aW9uOiBtYXgtaGVpZ2h0IDAuMjVzIGVhc2U7IH0KICAjaGlzdG9yeVBhbmVsLmNvbGxhcHNlZCAjdHhUYWJsZVdyYXAgeyBtYXgtaGVpZ2h0OiAwOyBvdmVyZmxvdzogaGlkZGVuOyBwYWRkaW5nOiAwOyBtYXJnaW46IDA7IGJvcmRlcjogMDsgfQogICNoaXN0b3J5UGFuZWwuY29sbGFwc2VkICNmaWx0ZXJRdWVyeSwgCiAgI2hpc3RvcnlQYW5lbC5jb2xsYXBzZWQgbGFiZWxbZm9yPSJmaWx0ZXJRdWVyeSJdIHsgZGlzcGxheTogbm9uZTsgfQogICNoaXN0b3J5UGFuZWwgLmNsaWNrYWJsZSB7IGN1cnNvcjogcG9pbnRlcjsgfQogICNoaXN0b3J5UGFuZWwgLmNoZXYgeyBkaXNwbGF5OmlubGluZS1ibG9jazsgdHJhbnNpdGlvbjogdHJhbnNmb3JtIC4ycyBlYXNlOyB9CiAgI2hpc3RvcnlQYW5lbC5jb2xsYXBzZWQgLmNoZXYgeyB0cmFuc2Zvcm06IHJvdGF0ZSgtOTBkZWcpOyB9CgoKLyogPT09IENvbG9yZWQgYmxpbmtpbmcgZm9yIEJVWSAoZ3JlZW4pIGFuZCBTRUxMIChyZWQpID09PSAqLwpAa2V5ZnJhbWVzIGJsaW5rUmVkIHsgMCV7b3V0bGluZS1jb2xvcjogdHJhbnNwYXJlbnQ7fSA1MCV7b3V0bGluZS1jb2xvcjogcmdiYSgyMjAsMzgsMzgsMC45KTt9IDEwMCV7b3V0bGluZS1jb2xvcjogdHJhbnNwYXJlbnQ7fSB9CkBrZXlmcmFtZXMgYmxpbmtHcmVlbiB7IDAle291dGxpbmUtY29sb3I6IHRyYW5zcGFyZW50O30gNTAle291dGxpbmUtY29sb3I6IHJnYmEoMTYsMTg1LDEyOSwwLjkpO30gMTAwJXtvdXRsaW5lLWNvbG9yOiB0cmFuc3BhcmVudDt9IH0KCi5oaXQtdGFyZ2V0LXNlbGwgICB7IG91dGxpbmU6IDNweCBzb2xpZDsgYW5pbWF0aW9uOiBibGlua1JlZCAxcyBpbmZpbml0ZTsgICAgfQoubmVhci10YXJnZXQtc2VsbCAgeyBvdXRsaW5lOiAycHggZGFzaGVkOyBhbmltYXRpb246IGJsaW5rUmVkIDEuNnMgaW5maW5pdGU7IH0KLmhpdC10YXJnZXQtYnV5ICAgIHsgb3V0bGluZTogM3B4IHNvbGlkOyBhbmltYXRpb246IGJsaW5rR3JlZW4gMXMgaW5maW5pdGU7ICB9Ci5uZWFyLXRhcmdldC1idXkgICB7IG91dGxpbmU6IDJweCBkYXNoZWQ7IGFuaW1hdGlvbjogYmxpbmtHcmVlbiAxLjZzIGluZmluaXRlOyB9CgovKiBjb21wYXRpYmlsaXR5IChvbGQgZ2VuZXJpYyBjbGFzc2VzKSAqLwouaGl0LXRhcmdldCB7IG91dGxpbmU6IDNweCBzb2xpZDsgYW5pbWF0aW9uOiBibGlua1JlZCAxLjJzIGluZmluaXRlOyB9Ci5uZWFyLXRhcmdldHsgb3V0bGluZTogMnB4IGRhc2hlZDsgYW5pbWF0aW9uOiBibGlua1JlZCAycyBpbmZpbml0ZTsgfQoKLyogPT09IE1vYmlsZSB0d2Vha3MgPT09ICovCkBtZWRpYSAobWF4LXdpZHRoOiA5ODBweCl7CiAgLmxheW91dHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnI7IHBhZGRpbmc6MTBweDsgZ2FwOjEwcHg7IH0KICAuc2lkZWJhcnsgbWluLWhlaWdodDogYXV0bzsgfQogIG1haW57IHBhZGRpbmc6MTBweDsgZ2FwOjEwcHg7IH0KICBoZWFkZXJ7IHBhZGRpbmc6MTBweDsgfQogIGhlYWRlciAuYWN0aW9uc3sgZ2FwOjZweDsgfQogIGhlYWRlciAuYWN0aW9ucyA+ICp7IGZsZXg6IDEgMSA0OCU7IH0gLyogMiBwZXIgcm93ICovCiAgLnBhbmVseyBwYWRkaW5nOjEwcHg7IH0KICAuZ3JpZHsgZ2FwOjEwcHg7IH0KICB0aCwgdGR7IHBhZGRpbmc6OHB4OyB9CiAgLmJ0bnsgcGFkZGluZzoxMHB4IDEycHg7IGZvbnQtc2l6ZToxNHB4OyB9Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCl7CiAgaGVhZGVyIGgxeyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjsgZ2FwOjhweDsgfQogIGhlYWRlciBoMSAuYnRueyBhbGlnbi1zZWxmOmZsZXgtc3RhcnQ7IH0KICBoZWFkZXIgLmFjdGlvbnMgPiAqeyBmbGV4OiAxIDEgMTAwJTsgfSAvKiBmdWxsIHdpZHRoICovCiAgLnRhYmxlLXdyYXB7IG92ZXJmbG93LXg6YXV0bzsgLXdlYmtpdC1vdmVyZmxvdy1zY3JvbGxpbmc6IHRvdWNoOyB9CiAgdGFibGV7IG1pbi13aWR0aDogNjQwcHg7IH0gLyogZW5hYmxlIGhvcml6b250YWwgc2Nyb2xsIGZvciB3aWRlIHRhYmxlcyAqLwogIC50aWNrZXJ7IGZvbnQtc2l6ZToxM3B4OyB9CiAgdGgsIHRkeyBmb250LXNpemU6MTNweDsgfQp9Ci8qID09PSBEYWlseSBjaGFuZ2UgYXJyb3dzID09PSAqLwouY2hhbmdlLWFycm93eyBmb250LXdlaWdodDogNzAwOyBtYXJnaW4tcmlnaHQ6IDRweDsgfQouY2hhbmdlLWFycm93LnVweyBjb2xvcjogdmFyKC0tb2spOyB9Ci5jaGFuZ2UtYXJyb3cuZG93bnsgY29sb3I6IHZhcigtLWRhbmdlcik7IH0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KCjwhLS0gRmlyZWJhc2UgU0RLcyAoY29tcGF0KSAtLT4KICAKPHNjcmlwdD4KLyogPT09IEVhcmx5IFRYIGhlbHBlcnMgc2hpbSAoZW5zdXJlQnV5TG90SWRJblR4IC8gYXBwbHlDYXNoKSBbR09dID09PSAqLwooZnVuY3Rpb24oKXsKICB0cnl7CiAgICBpZiAodHlwZW9mIHdpbmRvdy5lbnN1cmVCdXlMb3RJZEluVHggIT09ICdmdW5jdGlvbicpIHsKICAgICAgd2luZG93LmVuc3VyZUJ1eUxvdElkSW5UeCA9IGZ1bmN0aW9uKHR4KXsKICAgICAgICB0cnl7CiAgICAgICAgICBpZih0eCAmJiB0eC50eXBlPT09J2J1eScgJiYgIXR4LmxvdElkKXsKICAgICAgICAgICAgdHgubG90SWQgPSB0eC5pZCB8fCAoJ2xvdF8nK0RhdGUubm93KCkudG9TdHJpbmcoMzYpKydfJytNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSk7CiAgICAgICAgICB9CiAgICAgICAgfWNhdGNoKF8pe30KICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2Ygd2luZG93Ll9fZ29fYXBwbHlDYXNoU2hpbSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB3aW5kb3cuX19nb19hcHBseUNhc2hTaGltID0gZnVuY3Rpb24oc3RhdGUsIHR5cGUsIGFtb3VudCl7CiAgICAgICAgY29uc3QgYSA9IE51bWJlcihhbW91bnQpfHwwOwogICAgICAgIGlmKCFzdGF0ZSB8fCAhdHlwZSkgcmV0dXJuOwogICAgICAgIGlmKHR5cGU9PT0nZGVwb3NpdCcgfHwgdHlwZT09PSd0cmFuc2Zlcl9pbicpeyBzdGF0ZS5jYXNoID0gKE51bWJlcihzdGF0ZS5jYXNoKXx8MCkgKyBhOyByZXR1cm47IH0KICAgICAgICBpZih0eXBlPT09J3dpdGhkcmF3JyB8fCB0eXBlPT09J3RyYW5zZmVyX291dCcpeyBzdGF0ZS5jYXNoID0gKE51bWJlcihzdGF0ZS5jYXNoKXx8MCkgLSBhOyByZXR1cm47IH0KICAgICAgICAvLyBlbHNlIGlnbm9yZQogICAgICB9OwogICAgfQogIH1jYXRjaChfKXt9Cn0pKCk7Ci8qID09PSBlbmQgZWFybHkgVFggc2hpbXMgPT09ICovCgo8L3NjcmlwdD4KPHNjcmlwdD4KLyogPT09IExpZ2h0d2VpZ2h0IGFwcGx5KiBmYWxsYmFja3MgZm9yIEdPIGNoYXJ0ICh1c2VkIG9ubHkgaWYgYXBwIHZlcnNpb25zIG5vdCB5ZXQgbG9hZGVkKSA9PT0gKi8KKGZ1bmN0aW9uKCl7CiAgZnVuY3Rpb24gX19nb19ib29rKHN0YXRlLCB0a3IpewogICAgc3RhdGUuaG9sZGluZ3MgPSBzdGF0ZS5ob2xkaW5ncyB8fCB7fTsKICAgIGlmKCFzdGF0ZS5ob2xkaW5nc1t0a3JdKSBzdGF0ZS5ob2xkaW5nc1t0a3JdID0geyBxdHk6IDAsIGxvdHM6IFtdIH07CiAgICBjb25zdCBiID0gc3RhdGUuaG9sZGluZ3NbdGtyXTsKICAgIGIubG90cyA9IEFycmF5LmlzQXJyYXkoYi5sb3RzKSA/IGIubG90cyA6IFtdOwogICAgYi5xdHkgPSBOdW1iZXIoYi5xdHkpfHwwOwogICAgcmV0dXJuIGI7CiAgfQogIGZ1bmN0aW9uIF9fZ29fY29uc3VtZUxvdHMoYm9vaywgcXR5LCBsaW5rcyl7CiAgICBsZXQgbGVmdCA9IE51bWJlcihxdHkpfHwwOwogICAgaWYoIWJvb2sgfHwgIUFycmF5LmlzQXJyYXkoYm9vay5sb3RzKSkgcmV0dXJuIDA7CiAgICAvLyBJZiBleHBsaWNpdCBsb3RMaW5rcyBwcm92aWRlZCwgY29uc3VtZSB0aG9zZSBmaXJzdAogICAgaWYoQXJyYXkuaXNBcnJheShsaW5rcykgJiYgbGlua3MubGVuZ3RoKXsKICAgICAgZm9yKGNvbnN0IGxuIG9mIGxpbmtzKXsKICAgICAgICBpZihsZWZ0PD0wKSBicmVhazsKICAgICAgICBjb25zdCBpZCA9IGxuLmxvdElkOyBsZXQgcnEgPSBOdW1iZXIobG4ucXR5KXx8MDsKICAgICAgICBmb3IoY29uc3QgbG90IG9mIGJvb2subG90cyl7CiAgICAgICAgICBpZihsZWZ0PD0wKSBicmVhazsKICAgICAgICAgIGlmKGlkICYmIGxvdC5sb3RJZD09PWlkKXsKICAgICAgICAgICAgY29uc3QgdGFrZSA9IE1hdGgubWluKGxvdC5xdHl8fDAsIHJxLCBsZWZ0KTsKICAgICAgICAgICAgbG90LnF0eSA9IChsb3QucXR5fHwwKSAtIHRha2U7CiAgICAgICAgICAgIGJvb2sucXR5ID0gKGJvb2sucXR5fHwwKSAtIHRha2U7CiAgICAgICAgICAgIGxlZnQgLT0gdGFrZTsgcnEgLT0gdGFrZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIEZJRk8gZm9yIHRoZSByZXN0CiAgICBmb3IoY29uc3QgbG90IG9mIGJvb2subG90cyl7CiAgICAgIGlmKGxlZnQ8PTApIGJyZWFrOwogICAgICBjb25zdCB0YWtlID0gTWF0aC5taW4obG90LnF0eXx8MCwgbGVmdCk7CiAgICAgIGxvdC5xdHkgPSAobG90LnF0eXx8MCkgLSB0YWtlOwogICAgICBib29rLnF0eSA9IChib29rLnF0eXx8MCkgLSB0YWtlOwogICAgICBsZWZ0IC09IHRha2U7CiAgICB9CiAgICAvLyBjbGVhbnVwIGVtcHR5IGxvdHMKICAgIGJvb2subG90cyA9IGJvb2subG90cy5maWx0ZXIobCA9PiAobC5xdHl8fDApID4gMCk7CiAgICByZXR1cm4gbGVmdDsgLy8gcmVtYWluaW5nIChpZiA+MCwgbm90IGVub3VnaCBxdHkpCiAgfQogIGlmKHR5cGVvZiB3aW5kb3cuX19nb19hcHBseUJ1eSAhPT0gJ2Z1bmN0aW9uJyl7CiAgICB3aW5kb3cuX19nb19hcHBseUJ1eSA9IGZ1bmN0aW9uKHN0YXRlLCBwZiwgdHgpewogICAgICBjb25zdCB0a3IgPSBTdHJpbmcodHgudGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGNvbnN0IHEgPSBOdW1iZXIodHgucXR5KXx8MCwgcCA9IE51bWJlcih0eC5wcmljZSl8fDAsIGYgPSBOdW1iZXIodHguZmVlcyl8fDA7CiAgICAgIHN0YXRlLmNhc2ggPSAoTnVtYmVyKHN0YXRlLmNhc2gpfHwwKSAtIChxKnAgKyBmKTsKICAgICAgdHJ5eyBpZih0eXBlb2YgZW5zdXJlQnV5TG90SWRJblR4PT09J2Z1bmN0aW9uJykgZW5zdXJlQnV5TG90SWRJblR4KHR4KTsgfWNhdGNoKF8pe30KICAgICAgY29uc3QgYm9vayA9IF9fZ29fYm9vayhzdGF0ZSwgdGtyKTsKICAgICAgY29uc3QgbG90ID0geyBsb3RJZDogdHgubG90SWQgfHwgKCdsb3RfJytNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSksIHF0eTogcSwgcHJpY2U6IHAgfTsKICAgICAgYm9vay5sb3RzLnB1c2gobG90KTsKICAgICAgYm9vay5xdHkgPSAoYm9vay5xdHl8fDApICsgcTsKICAgIH07CiAgfQogIGlmKHR5cGVvZiB3aW5kb3cuX19nb19hcHBseVNlbGwgIT09ICdmdW5jdGlvbicpewogICAgd2luZG93Ll9fZ29fYXBwbHlTZWxsID0gZnVuY3Rpb24oc3RhdGUsIHBmLCB0eCl7CiAgICAgIGNvbnN0IHRrciA9IFN0cmluZyh0eC50aWNrZXJ8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwLCBwID0gTnVtYmVyKHR4LnByaWNlfHx0eC5zZWxsUHJpY2V8fDApLCBmID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogICAgICBzdGF0ZS5jYXNoID0gKE51bWJlcihzdGF0ZS5jYXNoKXx8MCkgKyAocSpwIC0gZik7CiAgICAgIGNvbnN0IGJvb2sgPSBfX2dvX2Jvb2soc3RhdGUsIHRrcik7CiAgICAgIF9fZ29fY29uc3VtZUxvdHMoYm9vaywgcSwgQXJyYXkuaXNBcnJheSh0eC5sb3RMaW5rcyk/dHgubG90TGlua3M6W10pOwogICAgfTsKICB9CiAgaWYodHlwZW9mIHdpbmRvdy5fX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55SW4gIT09ICdmdW5jdGlvbicpewogICAgd2luZG93Ll9fZ29fYXBwbHlUcmFuc2ZlckNvbXBhbnlJbiA9IGZ1bmN0aW9uKHN0YXRlLCBwZiwgdHgpewogICAgICBjb25zdCB0a3IgPSBTdHJpbmcodHgudGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGNvbnN0IHEgPSBOdW1iZXIodHgucXR5KXx8MCwgcCA9IE51bWJlcih0eC5wcmljZSl8fDA7CiAgICAgIGNvbnN0IGJvb2sgPSBfX2dvX2Jvb2soc3RhdGUsIHRrcik7CiAgICAgIGJvb2subG90cy5wdXNoKHsgbG90SWQ6IHR4LmxvdElkIHx8ICgnbG90XycrTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMikpLCBxdHk6IHEsIHByaWNlOiBwIH0pOwogICAgICBib29rLnF0eSA9IChib29rLnF0eXx8MCkgKyBxOwogICAgfTsKICB9CiAgaWYodHlwZW9mIHdpbmRvdy5fX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55T3V0ICE9PSAnZnVuY3Rpb24nKXsKICAgIHdpbmRvdy5fX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55T3V0ID0gZnVuY3Rpb24oc3RhdGUsIHBmLCB0eCl7CiAgICAgIGNvbnN0IHRrciA9IFN0cmluZyh0eC50aWNrZXJ8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgICBjb25zdCBib29rID0gX19nb19ib29rKHN0YXRlLCB0a3IpOwogICAgICBfX2dvX2NvbnN1bWVMb3RzKGJvb2ssIHEsIEFycmF5LmlzQXJyYXkodHgubG90TGlua3MpP3R4LmxvdExpbmtzOltdKTsKICAgIH07CiAgfQp9KSgpOwovKiA9PT0gZW5kIGxpZ2h0d2VpZ2h0IGFwcGx5KiBmYWxsYmFja3MgPT09ICovCjwvc2NyaXB0Pgo8c2NyaXB0PgovKiA9PT0gRWFybHkgY3VycmVuY3kgZm9ybWF0dGVyIHNoaW0gKGJlZm9yZSBhcHAgYm9vdCkgW0dPXSA9PT0gKi8KKGZ1bmN0aW9uKCl7CiAgdHJ5ewogICAgaWYgKHR5cGVvZiB3aW5kb3cuX19nb19mbXRDdXJyZW5jeSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB3aW5kb3cuX19nb19mbXRDdXJyZW5jeSA9IGZ1bmN0aW9uKHYsIGNvZGUpewogICAgICAgIHRyeSB7IGlmICh0eXBlb2YgZm10Q3VycmVuY3kgPT09ICdmdW5jdGlvbicpIHJldHVybiBmbXRDdXJyZW5jeSh2LCBjb2RlKTsgfSBjYXRjaChfKSB7fQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgSW50bC5OdW1iZXJGb3JtYXQodW5kZWZpbmVkLCB7IHN0eWxlOidjdXJyZW5jeScsIGN1cnJlbmN5Oihjb2RlfHwnUExOJykgfSkuZm9ybWF0KHZ8fDApOyB9CiAgICAgICAgY2F0Y2goXykgeyByZXR1cm4gU3RyaW5nKE1hdGgucm91bmQoKHZ8fDApKjEwMCkvMTAwKSArICcgJyArIChjb2RlfHwnJyk7IH0KICAgICAgfTsKICAgIH0KICB9Y2F0Y2goXyl7fQp9KSgpOwovKiA9PT0gZW5kIHNoaW0gPT09ICovCjwvc2NyaXB0PgoKICAKICAKCgo8c2NyaXB0PgovLyBHbG9iYWwgc2hpbXMgdG8gYXZvaWQgUmVmZXJlbmNlRXJyb3Igd2hlbiBfX2ZtdE51bSAvIF9fZXNjIGFyZSB1c2VkIGJlZm9yZSBtb2R1bGUgbG9hZHMKd2luZG93Ll9fZXNjID0gd2luZG93Ll9fZXNjIHx8IGZ1bmN0aW9uKHMpewogIHRyeXsgaWYodHlwZW9mIHdpbmRvdy5lc2NhcGVIdG1sPT09J2Z1bmN0aW9uJykgcmV0dXJuIHdpbmRvdy5lc2NhcGVIdG1sKFN0cmluZyhzfHwnJykpOyB9Y2F0Y2goXyl7fQogIGNvbnN0IHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOyB0LnRleHRDb250ZW50ID0gU3RyaW5nKHN8fCcnKTsgcmV0dXJuIHQuaW5uZXJIVE1MOwp9Owp3aW5kb3cuX19mbXROdW0gPSB3aW5kb3cuX19mbXROdW0gfHwgZnVuY3Rpb24odil7CiAgdHJ5eyBpZih0eXBlb2Ygd2luZG93LmZtdE51bT09PSdmdW5jdGlvbicpIHJldHVybiB3aW5kb3cuZm10TnVtKHYpOyB9Y2F0Y2goXyl7fQogIGNvbnN0IG4gPSBOdW1iZXIodik7IGlmKCFpc0Zpbml0ZShuKSkgcmV0dXJuICfigJQnOwogIHJldHVybiBuLnRvTG9jYWxlU3RyaW5nKHVuZGVmaW5lZCwge21heGltdW1GcmFjdGlvbkRpZ2l0czogMn0pOwp9Owo8L3NjcmlwdD4KPHNjcmlwdD4KLy8gPT09IEdsb2JhbCBkYXRlIGhlbHBlcnMgc2hpbSAoYWRkZWQgYnkgZml4KSA9PT0Kd2luZG93LnRvTXMgPSB3aW5kb3cudG9NcyB8fCBmdW5jdGlvbihkKXsKICB0cnl7CiAgICBpZiAoZCA9PSBudWxsKSByZXR1cm4gTmFOOwogICAgaWYgKHR5cGVvZiBkID09PSAnbnVtYmVyJykgcmV0dXJuIGQ7CiAgICBpZiAoZCBpbnN0YW5jZW9mIERhdGUpIHJldHVybiBkLmdldFRpbWUoKTsKICAgIGlmIChkICYmIHR5cGVvZiBkLnRvRGF0ZSA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIGQudG9EYXRlKCkuZ2V0VGltZSgpOwogICAgaWYgKGQgJiYgdHlwZW9mIGQuc2Vjb25kcyAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBOdW1iZXIoZC5zZWNvbmRzKSAqIDEwMDA7CiAgICBjb25zdCBtcyA9IERhdGUucGFyc2UoU3RyaW5nKGQpKTsKICAgIHJldHVybiBOdW1iZXIuaXNGaW5pdGUobXMpID8gbXMgOiBOYU47CiAgfWNhdGNoKF8peyByZXR1cm4gTmFOOyB9Cn07Cgp3aW5kb3cuaW5SYW5nZU1zID0gd2luZG93LmluUmFuZ2VNcyB8fCBmdW5jdGlvbihtcywgcmFuZ2UpewogIGlmICghcmFuZ2UpIHJldHVybiB0cnVlOwogIGlmICghTnVtYmVyLmlzRmluaXRlKG1zKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHMgPSBOdW1iZXIoKChyYW5nZSAmJiByYW5nZS5zdGFydCkgPz8gLUluZmluaXR5KSk7CiAgY29uc3QgZSA9IE51bWJlcigoKHJhbmdlICYmIHJhbmdlLmVuZCkgPz8gSW5maW5pdHkpKTsKICByZXR1cm4gbXMgPj0gcyAmJiBtcyA8PSBlOwp9Owo8L3NjcmlwdD4KCgo8c3R5bGU+CiN0b2FzdHNXcmFwe3Bvc2l0aW9uOmZpeGVkO3JpZ2h0OjEwcHg7Ym90dG9tOjEwcHg7ei1pbmRleDo5OTk5O2Rpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW47Z2FwOjhweDttYXgtd2lkdGg6OTJ2d30KLnRvYXN0e3BhZGRpbmc6MTBweCAxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtib3gtc2hhZG93OjAgNHB4IDE0cHggcmdiYSgwLDAsMCwuMik7YmFja2dyb3VuZDp2YXIoLS10YWJsZS1iZywgI2Y4ZjlmYSk7Y29sb3I6dmFyKC0tdGV4dC1jb2xvciwjMTExKTtmb250LXNpemU6LjlyZW07b3BhY2l0eTouOTg7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtnYXA6OHB4fQoudG9hc3QuaGl0e2JvcmRlci1sZWZ0OjRweCBzb2xpZCAjMTZhMzRhfQoudG9hc3QubmVhcntib3JkZXItbGVmdDo0cHggc29saWQgI2Q5NzcwNn0KLnRvYXN0IC50aW1le29wYWNpdHk6LjY7Zm9udC1zaXplOi44cmVtO21hcmdpbi1sZWZ0OmF1dG99CiNhbGVydHNUYWJCdG4gLmJhZGdle21hcmdpbi1sZWZ0OjZweDtwYWRkaW5nOjAgNnB4O2JvcmRlci1yYWRpdXM6MTBweDtiYWNrZ3JvdW5kOiNlZjQ0NDQ7Y29sb3I6I2ZmZjtmb250LXNpemU6Ljc1cmVtO2Rpc3BsYXk6aW5saW5lLWJsb2NrfQoKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgoKPHN0eWxlPgovKiBEaXNhYmxlIGJsaW5raW5nIGluc2lkZSBBbGVydHMgcGFuZWwgKi8KI2FsZXJ0c1BhbmVsIC5oaXQtdGFyZ2V0LXNlbGwsIAojYWxlcnRzUGFuZWwgLmhpdC10YXJnZXQtYnV5LCAKI2FsZXJ0c1BhbmVsIC5uZWFyLXRhcmdldC1zZWxsLCAKI2FsZXJ0c1BhbmVsIC5uZWFyLXRhcmdldC1idXkgeyBhbmltYXRpb246IG5vbmUgIWltcG9ydGFudDsgfQovKiBVc2Ugbm9uLWJsaW5raW5nIHN0eWxlcyBmb3Igcm93cyAqLwojYWxlcnRzUGFuZWwgdHIuc3RhdGUtaGl0ICB7IGJvcmRlci1sZWZ0OiA0cHggc29saWQgcmdiYSgzNCwxOTcsOTQsLjkpOyB9ICAgLyogZ3JlZW4gKi8KI2FsZXJ0c1BhbmVsIHRyLnN0YXRlLW5lYXIgeyBib3JkZXItbGVmdDogNHB4IHNvbGlkIHJnYmEoMjQ1LDE1OCwxMSwuOSk7IH0gIC8qIGFtYmVyICovCiNhbGVydHNQYW5lbCB0ci5zdGF0ZS1oaXQsICNhbGVydHNQYW5lbCB0ci5zdGF0ZS1uZWFyIHsgYmFja2dyb3VuZDogaW5oZXJpdDsgfQoKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgo8c3R5bGU+Ci8qID09PSBHbG9iYWwgRGFyayBUaGVtZSBmb3IgQUxMIG1vZGFscy9wb3B1cHMgPT09ICovCjpyb290ewogIC0tX19tb2RhbC1iZzogdmFyKC0tc3VyZmFjZSwgIzBmMTcyYSk7CiAgLS1fX21vZGFsLWJnMjogdmFyKC0tc3VyZmFjZS0yLCAjMGIxMjIwKTsKICAtLV9fbW9kYWwtdGV4dDogdmFyKC0tdGV4dCwgI2U1ZTdlYik7CiAgLS1fX21vZGFsLW11dGVkOiB2YXIoLS1tdXRlZCwgIzk0YTNiOCk7CiAgLS1fX21vZGFsLWJvcmRlcjogdmFyKC0tYm9yZGVyLWNvbG9yLCAjMzM0MTU1KTsKICAtLV9fbW9kYWwtcmluZzogdmFyKC0tYWNjZW50LCAjNjBhNWZhKTsKICAtLV9fYmFja2Ryb3A6IHJnYmEoMiw2LDIzLDAuNjYpOwp9CgovKiBOYXRpdmUgPGRpYWxvZz4gKi8KZGlhbG9nLCBbcm9sZT0iZGlhbG9nIl0sIC5tb2RhbCwgLnBvcHVwLCAuZGlhbG9nLCAuYXBwLW1vZGFsLCAuYXBwLXBvcHVwIHsKICBiYWNrZ3JvdW5kOgogICAgbGluZWFyLWdyYWRpZW50KDE4MGRlZywgY29sb3ItbWl4KGluIG9rbGFiLCB2YXIoLS1fX21vZGFsLWJnKSA5OCUsIHRyYW5zcGFyZW50KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3ItbWl4KGluIG9rbGFiLCB2YXIoLS1fX21vZGFsLWJnMikgOTglLCB0cmFuc3BhcmVudCkpOwogIGNvbG9yOiB2YXIoLS1fX21vZGFsLXRleHQpOwogIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLV9fbW9kYWwtYm9yZGVyKTsKICBib3JkZXItcmFkaXVzOiAxNnB4OwogIGJveC1zaGFkb3c6IDAgMTJweCAyOHB4IHJnYmEoMCwwLDAsLjM1KTsKfQoKLyogRW5zdXJlIGNvbW1vbiBpbm5lciB3cmFwcGVycyBpbmhlcml0ICovCmRpYWxvZyAubW9kYWwtY29udGVudCwKLm1vZGFsIC5tb2RhbC1jb250ZW50LAoucG9wdXAgLm1vZGFsLWNvbnRlbnQsCltyb2xlPSJkaWFsb2ciXSAubW9kYWwtY29udGVudCB7IGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OyBjb2xvcjogaW5oZXJpdDsgYm9yZGVyOiAwOyB9CgovKiBCYWNrZHJvcCBmb3IgbmF0aXZlIDxkaWFsb2c+ICovCmRpYWxvZzo6YmFja2Ryb3AgeyAKICBiYWNrZ3JvdW5kOiB2YXIoLS1fX2JhY2tkcm9wKTsKICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cig2cHgpOwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cig2cHgpOwp9CgovKiBHZW5lcmljIG92ZXJsYXkvYmFja2Ryb3AgY2xhc3NlcyB1c2VkIGJ5IGN1c3RvbSBtb2RhbHMgKi8KLmJhY2tkcm9wLCAub3ZlcmxheSwgLm1vZGFsLWJhY2tkcm9wLCAucG9wdXAtYmFja2Ryb3AgewogIGJhY2tncm91bmQ6IHZhcigtLV9fYmFja2Ryb3ApICFpbXBvcnRhbnQ7CiAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoNnB4KTsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNnB4KTsKfQoKLyogSGVhZC9mb290IGFyZWFzICovCi5tb2RhbC1oZWFkZXIsIC5wb3B1cC1oZWFkZXIgewogIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1fX21vZGFsLWJvcmRlcik7CiAgcGFkZGluZzogMTJweCAxNnB4Owp9Ci5tb2RhbC1mb290ZXIsIC5wb3B1cC1mb290ZXIgewogIGJvcmRlci10b3A6IDFweCBzb2xpZCB2YXIoLS1fX21vZGFsLWJvcmRlcik7CiAgcGFkZGluZzogMTJweCAxNnB4OwogIGRpc3BsYXk6IGZsZXg7IGdhcDogMTJweDsganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLyogQ29udHJvbHMgKi8KLm1vZGFsIGlucHV0LCAubW9kYWwgdGV4dGFyZWEsIC5tb2RhbCBzZWxlY3QsCmRpYWxvZyBpbnB1dCwgZGlhbG9nIHRleHRhcmVhLCBkaWFsb2cgc2VsZWN0LAoucG9wdXAgaW5wdXQsIC5wb3B1cCB0ZXh0YXJlYSwgLnBvcHVwIHNlbGVjdCwKW3JvbGU9ImRpYWxvZyJdIGlucHV0LCBbcm9sZT0iZGlhbG9nIl0gdGV4dGFyZWEsIFtyb2xlPSJkaWFsb2ciXSBzZWxlY3QgewogIGJhY2tncm91bmQ6IHZhcigtLXN1cmZhY2UtMiwgIzExMTgyNyk7CiAgY29sb3I6IHZhcigtLV9fbW9kYWwtdGV4dCk7CiAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tX19tb2RhbC1ib3JkZXIpOwogIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgcGFkZGluZzogMTBweCAxMnB4OwogIG91dGxpbmU6IG5vbmU7Cn0KLm1vZGFsIGlucHV0OjpwbGFjZWhvbGRlciwgLm1vZGFsIHRleHRhcmVhOjpwbGFjZWhvbGRlciwKZGlhbG9nIGlucHV0OjpwbGFjZWhvbGRlciwgZGlhbG9nIHRleHRhcmVhOjpwbGFjZWhvbGRlciwKLnBvcHVwIGlucHV0OjpwbGFjZWhvbGRlciwgLnBvcHVwIHRleHRhcmVhOjpwbGFjZWhvbGRlciwKW3JvbGU9ImRpYWxvZyJdIGlucHV0OjpwbGFjZWhvbGRlciwgW3JvbGU9ImRpYWxvZyJdIHRleHRhcmVhOjpwbGFjZWhvbGRlciB7CiAgY29sb3I6IGNvbG9yLW1peChpbiBva2xhYiwgdmFyKC0tX19tb2RhbC1tdXRlZCkgODAlLCB0cmFuc3BhcmVudCk7Cn0KLm1vZGFsIGlucHV0OmZvY3VzLCAubW9kYWwgdGV4dGFyZWE6Zm9jdXMsIC5tb2RhbCBzZWxlY3Q6Zm9jdXMsCmRpYWxvZyBpbnB1dDpmb2N1cywgZGlhbG9nIHRleHRhcmVhOmZvY3VzLCBkaWFsb2cgc2VsZWN0OmZvY3VzLAoucG9wdXAgaW5wdXQ6Zm9jdXMsIC5wb3B1cCB0ZXh0YXJlYTpmb2N1cywgLnBvcHVwIHNlbGVjdDpmb2N1cywKW3JvbGU9ImRpYWxvZyJdIGlucHV0OmZvY3VzLCBbcm9sZT0iZGlhbG9nIl0gdGV4dGFyZWE6Zm9jdXMsIFtyb2xlPSJkaWFsb2ciXSBzZWxlY3Q6Zm9jdXMgewogIGJveC1zaGFkb3c6IDAgMCAwIDNweCBjb2xvci1taXgoaW4gb2tsYWIsIHZhcigtLV9fbW9kYWwtcmluZykgMzAlLCB0cmFuc3BhcmVudCk7CiAgYm9yZGVyLWNvbG9yOiB2YXIoLS1fX21vZGFsLXJpbmcpOwp9CgovKiBDaGVja2JveC9SYWRpbyBhY2NlbnQgKi8KLm1vZGFsIGlucHV0W3R5cGU9ImNoZWNrYm94Il0sIC5tb2RhbCBpbnB1dFt0eXBlPSJyYWRpbyJdLApkaWFsb2cgaW5wdXRbdHlwZT0iY2hlY2tib3giXSwgZGlhbG9nIGlucHV0W3R5cGU9InJhZGlvIl0sCi5wb3B1cCBpbnB1dFt0eXBlPSJjaGVja2JveCJdLCAucG9wdXAgaW5wdXRbdHlwZT0icmFkaW8iXSwKW3JvbGU9ImRpYWxvZyJdIGlucHV0W3R5cGU9ImNoZWNrYm94Il0sIFtyb2xlPSJkaWFsb2ciXSBpbnB1dFt0eXBlPSJyYWRpbyJdewogIGFjY2VudC1jb2xvcjogdmFyKC0tX19tb2RhbC1yaW5nKTsKfQoKLyogQ2xvc2UgaWNvbiAqLwoubW9kYWwgLm1vZGFsLXgsIGRpYWxvZyAubW9kYWwteCwgLnBvcHVwIC5tb2RhbC14IHsKICBjb2xvcjogdmFyKC0tX19tb2RhbC1tdXRlZCk7Cn0KLm1vZGFsIC5tb2RhbC14OmhvdmVyLCBkaWFsb2cgLm1vZGFsLXg6aG92ZXIsIC5wb3B1cCAubW9kYWwteDpob3ZlciB7CiAgb3BhY2l0eTogLjk7Cn0KCi8qIEJ1dHRvbnMgKHVzZSBleGlzdGluZyAuYnRuIHN0eWxpbmcgaWYgcHJlc2VudCkgKi8KLm1vZGFsIC5idG4sIGRpYWxvZyAuYnRuLCAucG9wdXAgLmJ0biB7CiAgYm9yZGVyLXJhZGl1czogMTJweDsKICBwYWRkaW5nOiAxMHB4IDE0cHg7CiAgZm9udC13ZWlnaHQ6IDYwMDsKfQoubW9kYWwgLmJ0bi5naG9zdCwgZGlhbG9nIC5idG4uZ2hvc3QsIC5wb3B1cCAuYnRuLmdob3N0IHsKICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1fX21vZGFsLWJvcmRlcik7CiAgY29sb3I6IHZhcigtLV9fbW9kYWwtbXV0ZWQpOwp9CgovKiBTdWJ0bGUgZW50ZXIgYW5pbWF0aW9uOyByZXNwZWN0cyByZWR1Y2VkIG1vdGlvbiAqLwpAbWVkaWEgKHByZWZlcnMtcmVkdWNlZC1tb3Rpb246IG5vLXByZWZlcmVuY2UpewogIGRpYWxvZ1tvcGVuXSwgLm1vZGFsLCAucG9wdXAsIFtyb2xlPSJkaWFsb2ciXSB7CiAgICBhbmltYXRpb246IG1vZGFsRmFkZUluIC4xNnMgZWFzZS1vdXQ7CiAgfQogIEBrZXlmcmFtZXMgbW9kYWxGYWRlSW4geyBmcm9tIHsgb3BhY2l0eTogLjA7IHRyYW5zZm9ybTogc2NhbGUoLjk4KTt9IHRvIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiBzY2FsZSgxKTt9IH0KfQoKCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KPHN0eWxlPgovKiA9PT0gR08gcGVyaW9kIGNoaXAgcG9saXNoID09PSAqLwouZ28tY2hpcC1sYWJlbHtkaXNwbGF5OmlubGluZS1ibG9jazsgbWFyZ2luLXJpZ2h0OjhweDsgb3BhY2l0eTouOTsgZm9udC13ZWlnaHQ6NjAwO30KI2dvLXBlcmlvZHsKICBwYWRkaW5nOjRweCAxMHB4OwogIGJvcmRlci1yYWRpdXM6MTBweDsKICBib3JkZXI6MXB4IHNvbGlkIHZhcigtLW11dGVkLCByZ2JhKDEyOCwxMjgsMTI4LC40KSk7CiAgYmFja2dyb3VuZDogdmFyKC0tYmctMiwgcmdiYSgyNTUsMjU1LDI1NSwuMDUpKTsKICBvdXRsaW5lOm5vbmU7Cn0KI2dvLXBlcmlvZDpmb2N1c3sgYm94LXNoYWRvdzowIDAgMCAycHggcmdiYSgxMDAsMTUwLDI1NSwuMjUpOyB9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CjxzdHlsZT4KLmNvbXBhbnktbmFtZS1kaXNwbGF5IHsKICBkaXNwbGF5OiBibG9jazsKICBmb250LXNpemU6IDExcHg7CiAgY29sb3I6IHZhcigtLW11dGVkKTsKICBmb250LXdlaWdodDogNDAwOwogIG1hcmdpbi10b3A6IDJweDsKICBvcGFjaXR5OiAwLjg1Owp9CgoKCiAgCgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CjxzdHlsZSBpZD0iaG9sZGluZ3MtYWN0aW9ucy1hbGlnbiI+Ci8qIEFsaWduICcrJyBhbmQgdHJhbnNmZXIgYnV0dG9ucyBpbiBob2xkaW5ncyBzdW1tYXJ5IHRvIHRoZSBmYXIgcmlnaHQgKi8KI2hvbGRpbmdzVGFibGVXcmFwIGRldGFpbHMgPiBzdW1tYXJ5ewogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKfQovKiBwdXNoIHRoZSBmaXJzdCBzbWFsbCBidXR0b24gdG8gdGhlIHJpZ2h0OyB0aGUgcmVzdCB3aWxsIGZvbGxvdyAqLwojaG9sZGluZ3NUYWJsZVdyYXAgZGV0YWlscyA+IHN1bW1hcnkgLmJ0bi5zbWFsbDpmaXJzdC1vZi10eXBlewogIG1hcmdpbi1sZWZ0OiBhdXRvOwp9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CjxzdHlsZSBpZD0iYWxlcnRzLWhpc3RvcnktY29udHJvbHMtZml4Ij4KLyogQ29tbW9uIGNsYXNzIGZvciB0aGUgYWxlcnRzIGhpc3RvcnkgY29udHJvbHMgY29udGFpbmVyICovCi5hbGVydHMtaGlzdG9yeS1jb250cm9sc3sKICBkaXNwbGF5OiBmbGV4ICFpbXBvcnRhbnQ7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKICB3aGl0ZS1zcGFjZTogbm93cmFwOwogIGZsZXgtd3JhcDogbm93cmFwOwp9Ci8qIEVuc3VyZSBidXR0b24gdGV4dCBjb2xvciBmb2xsb3dzIHRoZW1lIChzYW1lIGZvciBib3RoKSAqLwouYWxlcnRzLWhpc3RvcnktY29udHJvbHMgYnV0dG9uLAouYWxlcnRzLWhpc3RvcnktY29udHJvbHMgLmJ0biwKLmFsZXJ0cy1oaXN0b3J5LWNvbnRyb2xzIGFbcm9sZT0iYnV0dG9uIl17CiAgY29sb3I6IHZhcigtLWZvcmVncm91bmQsIGluaGVyaXQpICFpbXBvcnRhbnQ7Cn0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KCjxzdHlsZSBpZD0iYWxlcnRzLWhpc3RvcnktaW5saW5lLWZpeDIiPgovKiBGb3JjZSAnT2TFm3dpZcW8JyBhbmQgJ1d5Y3p5xZvEhycgdG8gc2l0IGlubGluZSBhbmQgc2hhcmUgdGV4dCBjb2xvciAqLwojYWxlcnRzUGFuZWwgLmZpbHRlcnMgLmNvbC0zLAojYWxlcnRzUGFuZWwgLmZpbHRlcnMgLmNvbCwKI2FsZXJ0c1BhbmVsIC5maWx0ZXJzIC5jb250cm9scywKI2FsZXJ0c1BhbmVsIC5maWx0ZXJzewogIGRpc3BsYXk6IGZsZXggIWltcG9ydGFudDsKICBhbGlnbi1pdGVtczogY2VudGVyICFpbXBvcnRhbnQ7CiAgZ2FwOiA4cHggIWltcG9ydGFudDsKICBmbGV4LXdyYXA6IG5vd3JhcCAhaW1wb3J0YW50Owp9CiNhbGVydHNSZWZyZXNoQnRuLCAjYWxlcnRzQ2xlYXJCdG57CiAgZGlzcGxheTogaW5saW5lLWZsZXggIWltcG9ydGFudDsKICB3aWR0aDogYXV0byAhaW1wb3J0YW50OwogIG1pbi13aWR0aDogMCAhaW1wb3J0YW50OwogIGZsZXg6IDAgMCBhdXRvICFpbXBvcnRhbnQ7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcCAhaW1wb3J0YW50OwogIHZlcnRpY2FsLWFsaWduOiBtaWRkbGUgIWltcG9ydGFudDsKfQovKiB1bmlmeWluZyB0ZXh0IGNvbG9yIC0gbWF0Y2ggbm9ybWFsIC5idG4gZGFyayB0ZXh0IHVzZWQgb24gYWNjZW50IGJ1dHRvbnMgKi8KI2FsZXJ0c0NsZWFyQnRuLCAjYWxlcnRzUmVmcmVzaEJ0bnsKICBjb2xvcjogIzBiMTIyMiAhaW1wb3J0YW50Owp9Ci8qIHN1YnRsZSBzcGFjaW5nIGlmIGxheW91dCBlbmdpbmUgaWdub3JlcyBnYXAgKi8KI2FsZXJ0c1JlZnJlc2hCdG57IG1hcmdpbi1yaWdodDogOHB4ICFpbXBvcnRhbnQ7IH0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KPHN0eWxlIGlkPSJhbGVydHMtaW5saW5lLWNvbnRyb2xzLWNzcyI+Ci5hbGVydHMtaW5saW5lLWNvbnRyb2xzewogIGRpc3BsYXk6IGZsZXggIWltcG9ydGFudDsKICBhbGlnbi1pdGVtczogY2VudGVyICFpbXBvcnRhbnQ7CiAgZ2FwOiA4cHggIWltcG9ydGFudDsKICBmbGV4LXdyYXA6IG5vd3JhcCAhaW1wb3J0YW50Owp9Ci8qIGtlZXAgYnV0dG9ucyBjb21wYWN0ICovCi5hbGVydHMtaW5saW5lLWNvbnRyb2xzICNhbGVydHNSZWZyZXNoQnRuLAouYWxlcnRzLWlubGluZS1jb250cm9scyAjYWxlcnRzQ2xlYXJCdG57CiAgZGlzcGxheTogaW5saW5lLWZsZXggIWltcG9ydGFudDsKICBmbGV4OiAwIDAgYXV0byAhaW1wb3J0YW50OwogIHdpZHRoOiBhdXRvICFpbXBvcnRhbnQ7CiAgbWluLXdpZHRoOiAwICFpbXBvcnRhbnQ7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcCAhaW1wb3J0YW50Owp9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+Cgo8c3R5bGUgaWQ9ImdvLWltcHJvdmVkLWNoYXJ0LWNzcy12MyI+CiAgLmdvLWNoYXJ0LXdyYXAgeyBwb3NpdGlvbjpyZWxhdGl2ZTsgaGVpZ2h0OiA2NDBweDsgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjIpOyBib3JkZXItcmFkaXVzOiAxMnB4OyBib3JkZXI6IDFweCBzb2xpZCAjMWYyOTM3OyBvdmVyZmxvdzogaGlkZGVuOyB9CkBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCl7IC5nby1jaGFydC13cmFweyBoZWlnaHQ6IDQ4MHB4OyB9IH0KQG1lZGlhIChtaW4td2lkdGg6IDE0MDBweCl7IC5nby1jaGFydC13cmFweyBoZWlnaHQ6IDc0MHB4OyB9IH0KICAjZ28tbGluZS1jaGFydCB7IHdpZHRoOjEwMCU7IGhlaWdodDoxMDAlOyBkaXNwbGF5OmJsb2NrOyBjdXJzb3I6IGNyb3NzaGFpcjsgfQogIC5jaGFydC10b29sdGlwLWltcHJvdmVkIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC45NSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjMjJkM2VlOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIHBhZGRpbmc6IDE0cHggMTZweDsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMTAwMDsKICAgIG1heC13aWR0aDogMzQwcHg7CiAgICBib3gtc2hhZG93OiAwIDhweCAyNHB4IHJnYmEoMzQsMjExLDIzOCwwLjMpOwogICAgZGlzcGxheTogbm9uZTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig2cHgpOwogICAgbWluLXdpZHRoOiAyODBweDsKICB9CiAgLmNoYXJ0LXRvb2x0aXAtaW1wcm92ZWQudmlzaWJsZSB7IGRpc3BsYXk6IGJsb2NrOyB9CiAgLnRvb2x0aXAtcm93LWltcHJvdmVkewogICAgZGlzcGxheTpmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgZ2FwOjEycHg7CiAgICBtYXJnaW46NnB4IDA7IHBhZGRpbmc6NHB4IDA7IGJvcmRlci1ib3R0b206MXB4IHNvbGlkIHJnYmEoMTQ4LDE2MywxODQsMC4yKTsKICB9CiAgLnRvb2x0aXAtcm93LWltcHJvdmVkOmxhc3QtY2hpbGR7IGJvcmRlci1ib3R0b206bm9uZTsgfQogIC50b29sdGlwLWxhYmVsLWltcHJvdmVkeyBjb2xvcjojOTRhM2I4OyBmb250LXdlaWdodDo1MDA7IH0KICAudG9vbHRpcC12YWx1ZS1pbXByb3ZlZHsgZm9udC13ZWlnaHQ6NzAwOyBjb2xvcjojMjJkM2VlOyBmb250LWZhbWlseTogdWktbW9ub3NwYWNlLCBTRk1vbm8tUmVndWxhciwgTWVubG8sIE1vbmFjbywgQ29uc29sYXMsICJDb3VyaWVyIE5ldyIsIG1vbm9zcGFjZTsgdGV4dC1hbGlnbjpyaWdodDsgfQo8L3N0eWxlPgoKPHN0eWxlPiNnby1saW5lLWNoYXJ0LW92ZXJsYXl7cG9zaXRpb246YWJzb2x1dGU7aW5zZXQ6MDt3aWR0aDoxMDAlO2hlaWdodDoxMDAlO3BvaW50ZXItZXZlbnRzOm5vbmU7fTwvc3R5bGU+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0veGxzeEAwLjE4LjUvZGlzdC94bHN4LmZ1bGwubWluLmpzIj48L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KPGlucHV0IHR5cGU9ImZpbGUiIGlkPSJ4dGJJbXBvcnRGaWxlIiBhY2NlcHQ9Ii54bHN4LC54bHMiIHN0eWxlPSJkaXNwbGF5Om5vbmUiIC8+CjxkaXYgaWQ9InRvYXN0c1dyYXAiPjwvZGl2PgoKPGhlYWRlcj4KICA8aDE+8J+TiiBQb3J0ZmVsZSAgPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IiBpZD0icG9ydGZvbGlvc1RhYkJ0biIgdGl0bGU9IldpZG9rIHBvcnRmZWxpIj7wn5OCIFBvcnRmZWxlPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9Indpc2hsaXN0VGFiQnRuIiB0aXRsZT0iTGlzdGEgxbx5Y3plxYQgKGNlbnkga3VwbmEpIj7irZAgTGlzdGEgxbx5Y3plxYQ8L2J1dHRvbj4gPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IiBpZD0iYWxlcnRzVGFiQnRuIiB0aXRsZT0iSGlzdG9yaWEgYWxhcm3Ds3ciPvCflJQgQWxhcm15PC9idXR0b24+PC9oMT4KPGRpdiBjbGFzcz0iYWN0aW9ucyI+PGJ1dHRvbiBjbGFzcz0iYnRuIG9rIiBpZD0iYWRkUG9ydGZvbGlvQnRuIj7inpUgTm93eSBwb3J0ZmVsPC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gc2Vjb25kYXJ5IiBpZD0idHJhbnNmZXJCdG4iPvCflIEgUHJ6ZWxldyBtacSZZHp5IHBvcnRmZWxhbWk8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImV4cG9ydEJ0biI+4qyH77iPIEVrc3BvcnR1aiBKU09OPC9idXR0b24+CiAgICA8bGFiZWwgZm9yPSJpbXBvcnRGaWxlIiBjbGFzcz0iYnRuIGdob3N0IiBzdHlsZT0iY3Vyc29yOnBvaW50ZXIiPuKshu+4jyBJbXBvcnR1aiBKU09OPC9sYWJlbD4KICAgIDxpbnB1dCB0eXBlPSJmaWxlIiBpZD0iaW1wb3J0RmlsZSIgYWNjZXB0PSIuanNvbixhcHBsaWNhdGlvbi9qc29uIiBzdHlsZT0iZGlzcGxheTpub25lIiAvPgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHdhcm4iIGlkPSJzZXR0aW5nc0J0biI+4pqZ77iPIFVzdGF3aWVuaWE8L2J1dHRvbj4KICAKICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImZpcmViYXNlVXBsb2FkQnRuIiB0aXRsZT0iV3nFm2xpaiBkbyBGaXJlYmFzZSI+4piB77iPIFd5xZtsaWo8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImZpcmViYXNlRG93bmxvYWRCdG4iIHRpdGxlPSJQb2JpZXJ6IHogRmlyZWJhc2UiPuKYge+4jyBQb2JpZXJ6PC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJmaXJlYmFzZURpYWdCdG4iIHRpdGxlPSJTcHJhd2TFuiBwb8WCxIVjemVuaWUgeiBGaXJlc3RvcmUiPvCfp6ogVGVzdDwvYnV0dG9uPgogICAgCiAgICA8L2Rpdj4KPC9oZWFkZXI+CjxkaXYgY2xhc3M9ImxheW91dCI+CiAgPGFzaWRlIGNsYXNzPSJzaWRlYmFyIGNhcmQiPgogICAgPGRpdiBjbGFzcz0iaGVhZCI+CiAgICAgIDxkaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NzAwIj5Ud29qZSBwb3J0ZmVsZTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5LYcW8ZHkgcG9ydGZlbCB0byBvc29ibmEg4oCeZmlybWHigJ0gemUgc3dvasSFIHN0cmF0ZWdpxIU8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBvayIgaWQ9ImRlcG9zaXRCdG4iIHRpdGxlPSJTenlia2kgcHJ6ZWxldyBnb3TDs3draSBkbyB3eWJyYW5lZ28gcG9ydGZlbGEiPvCfkrA8L2J1dHRvbj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0icG9ydGZvbGlvcyIgaWQ9InBvcnRmb2xpb0xpc3QiPjwvZGl2PgogIDwvYXNpZGU+CiAgPG1haW4+CjxzZWN0aW9uIGlkPSJhbGVydHNQYW5lbCIgc3R5bGU9ImRpc3BsYXk6bm9uZSI+CiAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICA8ZGl2IGNsYXNzPSJjYXJkLWhlYWRlciI+CiAgICAgIDxoMj7wn5SUIEhpc3RvcmlhIGFsYXJtw7N3PC9oMj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0iY2FyZC1ib2R5Ij4KICAgICAgPGRpdiBjbGFzcz0iZ3JpZCIgc3R5bGU9ImdhcDogOHB4OyBhbGlnbi1pdGVtczogZW5kOyI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTMiPgogICAgICAgICAgPGxhYmVsPlpha3JlczwvbGFiZWw+CiAgICAgICAgICA8c2VsZWN0IGlkPSJhbGVydHNTY29wZSI+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+V3N6eXN0a288L29wdGlvbj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0icG9ydGZvbGlvIj5Qb3J0ZmVsZTwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJ3aXNobGlzdCI+TGlzdGEgxbx5Y3plxYQ8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0zIj4KICAgICAgICAgIDxsYWJlbD5TdGFuPC9sYWJlbD4KICAgICAgICAgIDxzZWxlY3QgaWQ9ImFsZXJ0c1N0YXRlIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj5Xc3p5c3Rrbzwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJoaXQiPvCfjq8gQ2VsIG9zacSFZ25pxJl0eTwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJuZWFyIj7ij7MgQmxpc2tvIGNlbHU8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0zIj4KICAgICAgICAgIDxsYWJlbD5Sb2R6YWo8L2xhYmVsPgogICAgICAgICAgPHNlbGVjdCBpZD0iYWxlcnRzS2luZCI+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+V3N6eXN0a288L29wdGlvbj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ic2VsbCI+U0VMTDwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJidXkiPkJVWTwvb3B0aW9uPgogICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTMiPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0iYWxlcnRzUmVmcmVzaEJ0biI+8J+UhCBPZMWbd2llxbw8L2J1dHRvbj4gPGJ1dHRvbiBpZD0iYWxlcnRzQ2xlYXJCdG4iIGNsYXNzPSJidG4gc21hbGwiIHRpdGxlPSJTa2FzdWogaGlzdG9yacSZIGFsYXJtw7N3Ij7wn5eRIFd5Y3p5xZvEhzwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iYWxlcnRzU3RhdHMiIGNsYXNzPSJzbWFsbCIgc3R5bGU9Im1hcmdpbjo4cHggMDsiPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj4KICAgICAgICA8dGFibGU+CiAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICA8dGg+RGF0YTwvdGg+CiAgICAgICAgICAgICAgPHRoPlRpY2tlcjwvdGg+CiAgICAgICAgICAgICAgPHRoPlN0YW48L3RoPgogICAgICAgICAgICAgIDx0aD5Sb2R6YWo8L3RoPgogICAgICAgICAgICAgIDx0aD5DZW5hPC90aD4KICAgICAgICAgICAgICA8dGg+Q2VsPC90aD4KICAgICAgICAgICAgICA8dGg+xblyw7NkxYJvPC90aD4KICAgICAgICAgICAgPC90cj4KICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHkgaWQ9ImFsZXJ0c1RhYmxlQm9keSI+CiAgICAgICAgICAgIDx0cj48dGQgY29sc3Bhbj0iNyIgY2xhc3M9Im11dGVkIj5CcmFrIGRhbnljaOKApjwvdGQ+PC90cj4KICAgICAgICAgIDwvdGJvZHk+CiAgICAgICAgPC90YWJsZT4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9zZWN0aW9uPgoKCiAgICA8c2VjdGlvbiBpZD0id2lzaGxpc3RQYW5lbCIgY2xhc3M9ImNhcmQgcGFuZWwiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMj7irZAgTGlzdGEgxbx5Y3plxYQgKGNlbGUgS1VQTkEpPC9oMj4KICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZXIiPjwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPlRpY2tlcjwvbGFiZWw+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciIHN0eWxlPSJnYXA6NnB4Ij4KICAgICAgICAgICAgPGlucHV0IGlkPSJ3bFRpY2tlciIgcGxhY2Vob2xkZXI9Im5wLiBUU0xBIC8gUEtOLldBIiAvPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJ3bFNlYXJjaCI+U3p1a2FqPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+Q2VuYSBkb2NlbG93YSAoa3Vwbm8pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBpZD0id2xQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcGxhY2Vob2xkZXI9Im5wLiAzMDAuMDAiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPiZuYnNwOzwvbGFiZWw+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2siIGlkPSJ3bEFkZCI+4p6VIERvZGFqIGRvIGxpc3R5PC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5XeW5pa2kgd3lzenVraXdhbmlhPC9sYWJlbD4KICAgICAgICAgIDxkaXYgaWQ9IndsU2VhcmNoUmVzdWx0cyIgY2xhc3M9ImNhcmQgcGFuZWwiIHN0eWxlPSJwYWRkaW5nOjhweDsgbWF4LWhlaWdodDoyMjBweDsgb3ZlcmZsb3c6YXV0byI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjEwcHgiPjwvZGl2PgogICAgICA8ZGl2IGlkPSJ3bFRhYmxlV3JhcCI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InNtYWxsIiBzdHlsZT0ibWFyZ2luLXRvcDo4cHgiPlNvcnRvd2FuaWUgd2cuIG9kbGVnxYJvxZtjaSBvZCBjZWx1OyBnZHkga3VycyDiiaQgY2VsOiB3aWVyc3ogbXJ1Z2EgbmEgemllbG9ubzsgZ2R5IGJsaXNrbyAo4omkIHRvbGVyYW5jamEgeiBVc3Rhd2llxYQpOiBkZWxpa2F0bmUgbXJ1Z2FuaWUuPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQgcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMiBpZD0icGZUaXRsZSI+V3liaWVyeiBwb3J0ZmVsPC9oMj4KICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZXIiPjwvZGl2PgogICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiIGlkPSJyZW5hbWVCdG4iPuKcj++4jyBabWllxYQgbmF6d8SZPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRhbmdlciIgaWQ9ImRlbGV0ZUJ0biI+8J+Xke+4jyBVc3XFhCBwb3J0ZmVsPC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgICA8bGFiZWw+U3RyYXRlZ2lhIC8gTm90YXRraTwvbGFiZWw+CiAgICAgICAgICA8dGV4dGFyZWEgaWQ9InN0cmF0ZWd5Qm94IiByb3dzPSI0IiBwbGFjZWhvbGRlcj0iT3Bpc3oga3LDs3RrbyB6YXNhZHkgdGVqICdmaXJteScgKG5wLiBkeXdpZGVuZHksIG1vbWVudHVtLCBzd2luZyBpdHAuKSI+PC90ZXh0YXJlYT4KICAgICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5aYXBpc3l3YW5lIGF1dG9tYXR5Y3puaWUuPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGRpdiBjbGFzcz0iZ3JpZCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0Ij4KICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIj5TYWxkbyBnb3TDs3draTwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjYXNoQmFsYW5jZSIgc3R5bGU9ImZvbnQtc2l6ZToyMHB4OyBmb250LXdlaWdodDo4MDAiPuKAlDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2siIGlkPSJjYXNoQWN0aW9uc0J0biI+8J+StSBPcGVyYWNqZTwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQiPgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibXV0ZWQiPlp5c2svU3RyYXRhICh6cmVhbGl6b3dhbmUpPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZToyMHB4OyBmb250LXdlaWdodDo4MDAiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJyZWFsaXplZFBMIj7igJQ8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNtYWxsIj4oPHNwYW4gaWQ9InJlYWxpemVkUExuZXQiPm5ldHRvPC9zcGFuPik8L3NwYW4+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0YWciPmxpY3pvbmUgdHlsa28gcG8gc3ByemVkYcW8eTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIG9rIiBpZD0iYnV5QnRuIj7wn5uSIFpha3VwPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2siIGlkPSJzZWxsQnRuIj7wn5K4IFNwcnplZGHFvCAoZG93b2xuZSBwYXJ0aWUpPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gc2Vjb25kYXJ5IiBpZD0id2l0aGRyYXdCdG4iPvCfj6cgV3lwxYJhdGE8L2J1dHRvbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQgcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMj5TdGFuIHBvc2lhZGFuaWEgKHBhcnRpZSBpIMWbcmVkbmkga29zenQpPC9oMj4KICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZXIiPjwvZGl2PgogICAgICAgIDxzcGFuIGNsYXNzPSJzbWFsbCI+S3Vyc3kgbmEgxbx5d28geiBGaW5uaHViIChiZXoga29ud2Vyc2ppIHdhbHV0KS4gVXN0YXcgdG9rZW4gdyDimpnvuI8gVXN0YXdpZW5pYS48L3NwYW4+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJob2xkaW5nc1RhYmxlV3JhcCI+PC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gaWQ9Imhpc3RvcnlQYW5lbCIgY2xhc3M9ImNhcmQgcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMiBpZD0iaGlzdG9yeVRpdGxlIiBjbGFzcz0iY2xpY2thYmxlIj5IaXN0b3JpYSBvcGVyYWNqaTwvaDI+CiAgICAgICAgPGRpdiBjbGFzcz0ic3BhY2VyIj48L2Rpdj4KICAgICAgICA8YnV0dG9uIGlkPSJoaXN0b3J5Q29sbGFwc2VCdG4iIGNsYXNzPSJidG4gc21hbGwgb2siIHRpdGxlPSJad2nFhC9Sb3p3acWEIj48c3BhbiBjbGFzcz0iY2hldiI+4pa+PC9zcGFuPjwvYnV0dG9uPgogICAgICAgIDxsYWJlbCBjbGFzcz0ic21hbGwiIGZvcj0iZmlsdGVyUXVlcnkiPkZpbHRyPC9sYWJlbD4KICAgICAgICA8aW5wdXQgaWQ9ImZpbHRlclF1ZXJ5IiBwbGFjZWhvbGRlcj0ibnAuIHR5cDpzZWxsIFRTTEEgMjAyNS0wOSIgc3R5bGU9Im1heC13aWR0aDozMDBweCIgLz4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gc21hbGwgZ2hvc3QiIGlkPSJmaWx0ZXJDbGVhckJ0biI+V3ljennFm8SHPC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJ0eFRhYmxlV3JhcCI+PC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPGZvb3Rlcj4KICAgICAgdjIg4oCiIERhbmUgemFwaXN5d2FuZSBsb2thbG5pZSB3IHByemVnbMSFZGFyY2UgKGxvY2FsU3RvcmFnZSkgb3JheiB3IGNobXVyemUuIFphd3N6ZSBtb8W8ZXN6IDxzcGFuIGNsYXNzPSJsaW5rIiBpZD0iZXhwb3J0TGluazIiPmVrc3BvcnRvd2HEhyBKU09OPC9zcGFuPiBpIHDDs8W6bmllaiBnbyA8c3BhbiBjbGFzcz0ibGluayIgaWQ9ImltcG9ydExpbmsyIj56YWltcG9ydG93YcSHPC9zcGFuPi4KICAgIDwvZm9vdGVyPgogIDwvbWFpbj4KPC9kaXY+Cgo8IS0tIE1vZGFsZSAtLT4KPGRpYWxvZyBpZD0ibW9kYWwiPgogIDxkaXYgY2xhc3M9Im1vZGFsIj4KICAgIDxoZWFkZXI+CiAgICAgIDxoMyBpZD0ibW9kYWxUaXRsZSI+TW9kYWw8L2gzPgogICAgPC9oZWFkZXI+CiAgICA8ZGl2IGNsYXNzPSJjb250ZW50IiBpZD0ibW9kYWxDb250ZW50Ij7igJQ8L2Rpdj4KICAgIDxmb290ZXI+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9Im1vZGFsQ2FuY2VsIj5BbnVsdWo8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0ibW9kYWxPayI+WmFwaXN6PC9idXR0b24+CiAgICA8L2Zvb3Rlcj4KICA8L2Rpdj4KPC9kaWFsb2c+Cgo8c2NyaXB0PgooKCk9PnsKICBjb25zdCBLRVkgPSAicG9ydGZlbGVfZmlybXlfdjEiOwoKCi8vID09PSBbVU5ET10gTWlnYXdraSBiYXp5IHogVFRMIDIgZG5pID09PQpjb25zdCBVTkRPX0tFWSA9IEtFWSArICdfX3VuZG8nOwpjb25zdCBVTkRPX1RUTF9NUyA9IDIqMjQqNjAqNjAqMTAwMDsgLy8gMiBkbmkKY29uc3QgVU5ET19NQVggPSA2MDsgLy8gb2dyYW5pY3plbmllIHdpZWxrb8WbY2kgaGlzdG9yaWkgKHJpbmcgYnVmZmVyKQp3aW5kb3cuX19VTkRPX1JFU1RPUklORyA9IGZhbHNlOyAvLyBndWFyZCBwcnplZCBuYXPFgnVjaGVtIEZpcmVzdG9yZSB3IHRyYWtjaWUgcHJ6eXdyYWNhbmlhCgpmdW5jdGlvbiBfX3VuZG9Mb2FkKCl7CiAgdHJ5eyByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShVTkRPX0tFWSkgfHwgJ1tdJyk7IH1jYXRjaChfKXsgcmV0dXJuIFtdOyB9Cn0KZnVuY3Rpb24gX191bmRvU2F2ZShzdGFjayl7IHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oVU5ET19LRVksIEpTT04uc3RyaW5naWZ5KHN0YWNrKSk7IH1jYXRjaChfKXt9IH0KZnVuY3Rpb24gX191bmRvUHJ1bmUoc3RhY2s9bnVsbCl7CiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICBjb25zdCBzID0gKHN0YWNrIHx8IF9fdW5kb0xvYWQoKSkuZmlsdGVyKGl0ID0+IChub3cgLSAoaXQudHN8fDApKSA8IFVORE9fVFRMX01TKTsKICBpZihzLmxlbmd0aCA+IFVORE9fTUFYKSBzLnNwbGljZSgwLCBzLmxlbmd0aCAtIFVORE9fTUFYKTsKICBfX3VuZG9TYXZlKHMpOwogIF9fdW5kb1VwZGF0ZUJ0bigpOwogIHJldHVybiBzOwp9CmZ1bmN0aW9uIF9fbWFrZVNuYXBzaG90KGtpbmQ9J3R4Jyl7CiAgcmV0dXJuIHsgdHM6IERhdGUubm93KCksIGtpbmQsIGxhYmVsOiAnJywgZGI6IEpTT04uc3RyaW5naWZ5KERCKSwgY3VycmVudFBmSWQgfTsKfQpmdW5jdGlvbiBwdXNoVW5kbyh7bGFiZWw9J1ptaWFuYScsIGtpbmQ9J3R4J30gPSB7fSl7CiAgdHJ5ewogICAgY29uc3QgcyA9IF9fdW5kb1BydW5lKCk7CiAgICBjb25zdCBzbmFwID0gX19tYWtlU25hcHNob3Qoa2luZCk7IHNuYXAubGFiZWwgPSBsYWJlbDsKICAgIHMucHVzaChzbmFwKTsKICAgIF9fdW5kb1NhdmUocyk7CiAgICBfX3VuZG9VcGRhdGVCdG4oKTsKICB9Y2F0Y2goXyl7fQp9CmZ1bmN0aW9uIGNhblVuZG8oKXsgcmV0dXJuIF9fdW5kb1BydW5lKCkubGVuZ3RoID4gMDsgfQoKZnVuY3Rpb24gX19maW5kU25hcHNob3RUb1VuZG8obW9kZT0ndHgnKXsKICAvLyBtb2RlOiAndHgnIChkb215xZtsbmllIHNrYWN6ZW15IGRvIG9zdGF0bmllaiB0cmFuc2FrY3lqbmVqKSwgJ2FueScgKGtyb2tvd28pCiAgY29uc3QgcyA9IF9fdW5kb1BydW5lKCk7CiAgaWYocy5sZW5ndGg9PT0wKSByZXR1cm4ge3N0YWNrOnMsIHRhcmdldDpudWxsLCBpZHg6LTF9OwogIGlmKG1vZGU9PT0nYW55Jyl7CiAgICByZXR1cm4ge3N0YWNrOnMsIHRhcmdldDpzW3MubGVuZ3RoLTFdLCBpZHg6cy5sZW5ndGgtMX07CiAgfQogIGZvcihsZXQgaT1zLmxlbmd0aC0xO2k+PTA7aS0tKXsKICAgIGlmKChzW2ldLmtpbmR8fCd0eCcpPT09J3R4JykgcmV0dXJuIHtzdGFjazpzLCB0YXJnZXQ6c1tpXSwgaWR4Oml9OwogIH0KICAvLyBqZcWbbGkgbmllIG1hICd0eCcsIHdlxbogb3N0YXRuacSFIGpha8SFa29sd2llawogIHJldHVybiB7c3RhY2s6cywgdGFyZ2V0OnNbcy5sZW5ndGgtMV0sIGlkeDpzLmxlbmd0aC0xfTsKfQoKZnVuY3Rpb24gdW5kbyh7bW9kZT0ndHgnfT17fSl7CiAgY29uc3QgZm91bmQgPSBfX2ZpbmRTbmFwc2hvdFRvVW5kbyhtb2RlKTsKICBjb25zdCBzID0gZm91bmQuc3RhY2s7CiAgY29uc3QgdGFyZ2V0ID0gZm91bmQudGFyZ2V0OwogIGNvbnN0IGlkeCA9IGZvdW5kLmlkeDsKICBpZighdGFyZ2V0KXsgYWxlcnQoJ0JyYWsgY29mbmnEmcSHIChoaXN0b3JpYSBwdXN0YSBsdWIgcG8gVFRMKS4nKTsgcmV0dXJuOyB9CiAgdHJ5ewogICAgd2luZG93Ll9fVU5ET19SRVNUT1JJTkcgPSB0cnVlOwogICAgREIgPSBKU09OLnBhcnNlKHRhcmdldC5kYik7CiAgICBjdXJyZW50UGZJZCA9IHRhcmdldC5jdXJyZW50UGZJZCB8fCAoREIucG9ydGZvbGlvcyAmJiBEQi5wb3J0Zm9saW9zWzBdICYmIERCLnBvcnRmb2xpb3NbMF0uaWQpIHx8IG51bGw7CiAgICBpZiAodHlwZW9mIHNhdmUgPT09ICdmdW5jdGlvbicpIHNhdmUoKTsKICAgIGlmICh0eXBlb2YgcmVuZGVyID09PSAnZnVuY3Rpb24nKSByZW5kZXIoKTsKICAgIHRyeXsgaWYodHlwZW9mIHdpbmRvdy5oYXJkVXBsb2FkPT09J2Z1bmN0aW9uJyl7IGNvbnN0IHIgPSB3aW5kb3cuaGFyZFVwbG9hZCgpOyBpZihyICYmIHR5cGVvZiByLnRoZW49PT0nZnVuY3Rpb24nKXsgci50aGVuKCgpPT57fSkuY2F0Y2goKCk9Pnt9KTsgfSB9IH1jYXRjaChfKXt9CiAgICBhbGVydCgnQ29mbmnEmXRvOiAnICsgKHRhcmdldC5sYWJlbCB8fCAnem1pYW7EmScpKTsKICB9Y2F0Y2goZSl7CiAgICBhbGVydCgnTmllIHVkYcWCbyBzacSZIGNvZm7EhcSHOiAnICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsKICB9ZmluYWxseXsKICAgIC8vIHVzdcWEIHdzenlzdGtpZSBtaWdhd2tpIG9kIGtvxYRjYSBhxbwgZG8gd3licmFuZWogKHfFgsSFY3puaWUpCiAgICBzLnNwbGljZShpZHgsIHMubGVuZ3RoIC0gaWR4KTsKICAgIF9fdW5kb1NhdmUocyk7CiAgICBfX3VuZG9VcGRhdGVCdG4oKTsKICAgIHNldFRpbWVvdXQoKCk9Pnsgd2luZG93Ll9fVU5ET19SRVNUT1JJTkcgPSBmYWxzZTsgfSwgMTUwMCk7CiAgfQp9CgpmdW5jdGlvbiBfX3VuZG9VcGRhdGVCdG4oKXsKICB0cnl7CiAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndW5kb0J0bicpOwogICAgaWYoIWJ0bikgcmV0dXJuOwogICAgY29uc3QgbiA9IChfX3VuZG9Mb2FkKCkgfHwgW10pLmZpbHRlcihpdCA9PiAoRGF0ZS5ub3coKSAtIChpdC50c3x8MCkpIDwgVU5ET19UVExfTVMpLmxlbmd0aDsKICAgIGJ0bi5kaXNhYmxlZCA9IG49PT0wOwogICAgYnRuLnRpdGxlID0gbiA/IGBDb2ZuaWogKHcgaGlzdG9yaWk6ICR7bn07IHd5Z2FzYSBwbyAyIGRuaWFjaClgIDogJ0JyYWsgcnplY3p5IGRvIGNvZm5pxJljaWEnOwogIH1jYXRjaChfKXt9Cn0KCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKT0+ewogIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1bmRvQnRuJyk7CiAgaWYoYnRuKSBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICAgIC8vIFNoaWZ0K2tsaWsgLT4gdHJ5YiAnYW55JyAoa3Jva293byksIHp3eWvFgnkga2xpayAtPiAndHgnIChza29rIGRvIG9zdGF0bmllaiB0cmFuc2FrY2ppKQogICAgdW5kbyh7bW9kZTogZSAmJiBlLnNoaWZ0S2V5ID8gJ2FueScgOiAndHgnfSk7CiAgfSk7CiAgX191bmRvVXBkYXRlQnRuKCk7Cn0pOwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57CiAgY29uc3Qga2V5ID0gU3RyaW5nKGUua2V5fHwnJykudG9Mb3dlckNhc2UoKTsKICBpZigoZS5jdHJsS2V5fHxlLm1ldGFLZXkpICYmIGtleT09PSd6Jyl7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAvLyBDdHJsL0NtZCtTaGlmdCtaIC0+ICdhbnknLCB6d3lrxYJlIEN0cmwvQ21kK1ogLT4gJ3R4JwogICAgdW5kbyh7bW9kZTogZS5zaGlmdEtleSA/ICdhbnknIDogJ3R4J30pOwogIH0KfSk7CgogIGNvbnN0ICQgPSBzZWwgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWwpOwogIGNvbnN0ICQkID0gc2VsID0+IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWwpKTsKCiAgY29uc3QgZm10Q3VycmVuY3kgPSAobiwgY3VyKSA9PiB7CiAgICBpZihuID09PSBudWxsIHx8IG4gPT09IHVuZGVmaW5lZCB8fCBpc05hTihuKSkgcmV0dXJuICLigJQiOwogICAgdHJ5ewogICAgICByZXR1cm4gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdwbC1QTCcsIHsgc3R5bGU6J2N1cnJlbmN5JywgY3VycmVuY3k6IGN1ciB8fCAnVVNEJywgbWluaW11bUZyYWN0aW9uRGlnaXRzOjIsIG1heGltdW1GcmFjdGlvbkRpZ2l0czoyIH0pLmZvcm1hdChuKTsKICAgIH1jYXRjaChlKXsKICAgICAgcmV0dXJuIChuLnRvRml4ZWQoMikpICsgJyAnICsgKGN1cnx8J1VTRCcpOwogICAgfQogIH07CiAgY29uc3QgZm10TnVtID0gKG4sIGQ9MikgPT4gKG4gPz8gbj09PTApID8gTnVtYmVyKG4pLnRvRml4ZWQoZCkgOiAi4oCUIjsKICBjb25zdCBpZCA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpICsgRGF0ZS5ub3coKS50b1N0cmluZygzNik7CgogIGNvbnN0IGRlZmF1bHREQiA9ICgpPT4gKHsKICAgIHZlcnNpb246IDEsCiAgICBzZXR0aW5nczogeyB0YXhSYXRlOiAwLjE5LCBhbGxvd05lZ2F0aXZlQ2FzaDogZmFsc2UsIGN1cnJlbmN5RGVmYXVsdDogIlVTRCIsIGZpbm5odWJUb2tlbjogIiIsIHByaWNlUG9sbFNlY29uZHM6IDQ1LCBhcHByb2FjaFRvbGVyYW5jZVBjdDogMSB9LAogICAgcG9ydGZvbGlvczogW10sCiAgICB3YXRjaGxpc3Q6IFtdCiAgfSk7CiAgbGV0IERCID0gbnVsbDsKICB0cnl7CiAgICBEQiA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKSkgfHwgZGVmYXVsdERCKCk7CiAgfWNhdGNoKGUpewogICAgREIgPSBkZWZhdWx0REIoKTsKICB9CiAgY29uc3Qgc2F2ZSA9ICgpPT4gbG9jYWxTdG9yYWdlLnNldEl0ZW0oS0VZLCBKU09OLnN0cmluZ2lmeShEQikpOwoKICBsZXQgY3VycmVudFBmSWQgPSBEQi5wb3J0Zm9saW9zWzBdPy5pZCB8fCBudWxsOwoKICAvLyBVSSBFbGVtZW50cwogIGNvbnN0IHBvcnRmb2xpb0xpc3RFbCA9ICQoIiNwb3J0Zm9saW9MaXN0Iik7CiAgY29uc3QgcGZUaXRsZUVsID0gJCgiI3BmVGl0bGUiKTsKICBjb25zdCBzdHJhdGVneUJveCA9ICQoIiNzdHJhdGVneUJveCIpOwogIGNvbnN0IGNhc2hCYWxhbmNlRWwgPSAkKCIjY2FzaEJhbGFuY2UiKTsKICBjb25zdCByZWFsaXplZFBMRWwgPSAkKCIjcmVhbGl6ZWRQTCIpOwogIGNvbnN0IHJlYWxpemVkUExuZXRFbCA9ICQoIiNyZWFsaXplZFBMbmV0Iik7CiAgY29uc3QgaG9sZGluZ3NUYWJsZVdyYXAgPSAkKCIjaG9sZGluZ3NUYWJsZVdyYXAiKTsKICBjb25zdCB0eFRhYmxlV3JhcCA9ICQoIiN0eFRhYmxlV3JhcCIpOwogIGNvbnN0IGZpbHRlclF1ZXJ5RWwgPSAkKCIjZmlsdGVyUXVlcnkiKTsKCiAgLy8gTW9kYWwgaGVscGVycwogIGNvbnN0IG1vZGFsID0gJCgiI21vZGFsIik7CiAgY29uc3QgbW9kYWxUaXRsZSA9ICQoIiNtb2RhbFRpdGxlIik7CiAgY29uc3QgbW9kYWxDb250ZW50ID0gJCgiI21vZGFsQ29udGVudCIpOwogIGNvbnN0IG1vZGFsT2sgPSAkKCIjbW9kYWxPayIpOwogIGNvbnN0IG1vZGFsQ2FuY2VsID0gJCgiI21vZGFsQ2FuY2VsIik7CiAgbGV0IG1vZGFsUmVzb2x2ZSA9IG51bGw7CiAgbW9kYWxDYW5jZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IGNsb3NlTW9kYWwobnVsbCkpOwogIGZ1bmN0aW9uIG9wZW5Nb2RhbCh7dGl0bGUsIGlubmVySFRNTCwgb2tUZXh0PSJaYXBpc3oiLCBjYW5jZWxUZXh0PSJBbnVsdWoifSl7CiAgICBtb2RhbFRpdGxlLnRleHRDb250ZW50ID0gdGl0bGU7CiAgICBtb2RhbENvbnRlbnQuaW5uZXJIVE1MID0gaW5uZXJIVE1MOwogICAgJCgiI21vZGFsT2siKS50ZXh0Q29udGVudCA9IG9rVGV4dDsKICAgICQoIiNtb2RhbENhbmNlbCIpLnRleHRDb250ZW50ID0gY2FuY2VsVGV4dDsKICAgIG1vZGFsLnNob3dNb2RhbCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlcz0+IG1vZGFsUmVzb2x2ZSA9IHJlcyk7CiAgfQogIGZ1bmN0aW9uIGNsb3NlTW9kYWwocmVzdWx0KXsKICAgIG1vZGFsLmNsb3NlKCk7CiAgICBpZihtb2RhbFJlc29sdmUpeyBjb25zdCByID0gbW9kYWxSZXNvbHZlOyBtb2RhbFJlc29sdmUgPSBudWxsOyByKHJlc3VsdCk7IH0KICB9CiAgbW9kYWxPay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT4gewogICAgLy8gQnkgZGVmYXVsdCwgY29sbGVjdCBmb3JtIHZhbHVlcyBpbnRvIGFuIG9iamVjdAogICAgY29uc3QgZm9ybSA9IG1vZGFsQ29udGVudC5xdWVyeVNlbGVjdG9yKCJmb3JtIik7CiAgICBpZihmb3JtKXsKICAgICAgY29uc3QgZGF0YSA9IE9iamVjdC5mcm9tRW50cmllcyhuZXcgRm9ybURhdGEoZm9ybSkuZW50cmllcygpKTsKICAgICAgY2xvc2VNb2RhbChkYXRhKTsKICAgIH1lbHNlewogICAgICBjbG9zZU1vZGFsKHRydWUpOwogICAgfQogIH0pOwoKICAvLyBDb3JlIG9wZXJhdGlvbnMKCiAgLy8gPT09IFJlYnVpbGQgZnJvbSB0cmFuc2FjdGlvbnMgKGNocm9ub2xvZ2ljYWwgcmVwbGF5KSA9PT0KICAKLy8gLS0tIEhlbHBlcjogZmluZCBsb3QgYnkgbG90SWQgYWNyb3NzIGhvbGRpbmdzCmZ1bmN0aW9uIGdldExvdEJ5SWQocGYsIGxvdElkKXsKICBpZighcGYgfHwgIWxvdElkKSByZXR1cm4gbnVsbDsKICBmb3IoY29uc3QgW3RpY2tlciwgaF0gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICBmb3IoY29uc3QgbG90IG9mIChoLmxvdHN8fFtdKSl7CiAgICAgIGlmKGxvdC5sb3RJZCA9PT0gbG90SWQpIHJldHVybiBsb3Q7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGVuc3VyZUJ1eUxvdElkSW5UeCh0eCl7CiAgICAvLyBBc3NpZ24gc3RhYmxlIGxvdElkIHRvIGJ1eSB0eCBpZiBtaXNzaW5nIChiYWNrd2FyZCBjb21wYXQpCiAgICBpZih0eC50eXBlPT09ImJ1eSIgJiYgIXR4LmxvdElkKXsKICAgICAgdHgubG90SWQgPSB0eC5pZCB8fCBpZCgpOwogICAgfQogIH0KICBmdW5jdGlvbiBjbG9uZUVtcHR5U3RhdGUocGYpewogICAgcmV0dXJuIHsgY2FzaDogMCwgaG9sZGluZ3M6IHt9IH07CiAgfQogIGZ1bmN0aW9uIGFwcGx5QnV5KHN0YXRlLCBwZiwgdHgpewogICAgY29uc3QgdGtyID0gdHgudGlja2VyLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgY29uc3QgcCA9IE51bWJlcih0eC5wcmljZSl8fDA7CiAgICBjb25zdCBmID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogICAgc3RhdGUuY2FzaCAtPSAocSpwICsgZik7CiAgICBzdGF0ZS5ob2xkaW5nc1t0a3JdIHx8PSB7IGxvdHM6IFtdIH07CiAgICBjb25zdCBsb3RJZFN0YWJsZSA9IHR4LmxvdElkOwogICAgY29uc3QgbG90ID0geyBsb3RJZDogbG90SWRTdGFibGUsIGRhdGU6IHR4LmRhdGUgfHwgdG9kYXkoKSwgcXR5OiBxLCB1bml0Q29zdDogcCArIChmL3F8fDApLCByYXdQcmljZTogcCwgZmVlczogZiwgbm90ZTogdHgubm90ZXx8IiIsIHRhcmdldFBjdDogKHR4LnRhcmdldFBjdD8/bnVsbCksIHRhcmdldFByaWNlOiAodHgudGFyZ2V0UHJpY2U/P251bGwpLCBidXlUYXJnZXRQY3Q6ICh0eC5idXlUYXJnZXRQY3Q/P251bGwpLCBidXlUYXJnZXRQcmljZTogKHR4LmJ1eVRhcmdldFByaWNlPz9udWxsKSB9OwogICAgc3RhdGUuaG9sZGluZ3NbdGtyXS5sb3RzLnB1c2gobG90KTsKICB9CiAgZnVuY3Rpb24gYXBwbHlTZWxsKHN0YXRlLCBwZiwgdHgpewogIGNvbnN0IHRrciA9IHR4LnRpY2tlci50cmltKCkudG9VcHBlckNhc2UoKTsKICBjb25zdCBwU2VsbCA9IE51bWJlcih0eC5wcmljZXx8dHguc2VsbFByaWNlfHwwKTsKICBjb25zdCBmID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogIGNvbnN0IGxpbmtzID0gKHR4LmxvdExpbmtzfHxbXSkubWFwKHg9Pih7bG90SWQ6IHgubG90SWQsIHF0eTogTnVtYmVyKHgucXR5KXx8MH0pKS5maWx0ZXIoeD0+eC5xdHk+MCk7CiAgLy8gUHJlcGFyZSBlcnJvcnMgYXJyYXkKICBzdGF0ZS5fX2Vycm9ycyA9IHN0YXRlLl9fZXJyb3JzIHx8IFtdOwogIGZ1bmN0aW9uIHNvZnRFcnJvcihtc2cpewogICAgdHJ5eyBzdGF0ZS5fX2Vycm9ycy5wdXNoKHt0aWNrZXI6dGtyLCBpZDogdHguaWR8fG51bGwsIGRhdGU6IHR4LmRhdGV8fG51bGwsIG1lc3NhZ2U6IFN0cmluZyhtc2cpfSk7IH1jYXRjaChfKXt9CiAgfQogIGxldCBwcm9jZWVkcyA9IDAsIGdyb3NzUEwgPSAwOwogIGNvbnN0IGJvb2sgPSBzdGF0ZS5ob2xkaW5nc1t0a3JdOwogIGlmKCFib29rKXsKICAgIHNvZnRFcnJvcigiU3ByemVkYcW8IGJleiBwb3p5Y2ppICgiK3RrcisiKS4iKTsKICAgIC8vIEtlZXAgdHggZGVyaXZlZCBmaWVsZHMgY29uc2lzdGVudCBidXQgZG8gbm90IG11dGF0ZSBzdGF0ZQogICAgdHgucXR5ID0gbGlua3MucmVkdWNlKChhLGIpPT5hK2IucXR5LDApOwogICAgdHgucHJvY2VlZHMgPSAwOyB0eC5ncm9zc1BMID0gMDsgdHgudGF4ID0gMDsgdHgubmV0UEwgPSAwOwogICAgcmV0dXJuOwogIH0KICBmb3IoY29uc3QgbGluayBvZiBsaW5rcyl7CiAgICBjb25zdCBsb3QgPSBib29rLmxvdHMuZmluZChsPT5sLmxvdElkPT09bGluay5sb3RJZCk7CiAgICBpZighbG90KXsKICAgICAgc29mdEVycm9yKCJCcmFrIHBhcnRpaSAiK2xpbmsubG90SWQrIiBwcnp5IHNwcnplZGHFvHkgIit0a3IpOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIGlmKGxpbmsucXR5ID4gbG90LnF0eSArIDFlLTkpewogICAgICBzb2Z0RXJyb3IoIlNwcnplZGHFvCBwcnpla3JhY3phIGlsb8WbxIcgdyBwYXJ0aWkgKCIrdGtyKyIpLiIpOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIHByb2NlZWRzICs9IGxpbmsucXR5ICogcFNlbGw7CiAgICBncm9zc1BMICs9IGxpbmsucXR5ICogKHBTZWxsIC0gbG90LnVuaXRDb3N0KTsKICB9CiAgZ3Jvc3NQTCAtPSBmOwogIGNvbnN0IHRheCA9IGdyb3NzUEw+MCA/IGdyb3NzUEwqKERCLnNldHRpbmdzLnRheFJhdGV8fDAuMTkpIDogMDsKICBjb25zdCBuZXRQTCA9IGdyb3NzUEwgLSB0YXg7CiAgLy8gVXBkYXRlIGNhc2ggJiByZWR1Y2UgbG90cyBvbmx5IGZvciBsaW5rcyB0aGF0IHdlcmUgdmFsaWQKICBzdGF0ZS5jYXNoICs9IChwcm9jZWVkcyAtIGYpOwogIGZvcihjb25zdCBsaW5rIG9mIGxpbmtzKXsKICAgIGNvbnN0IGxvdCA9IChib29rLmxvdHN8fFtdKS5maW5kKGw9PmwubG90SWQ9PT1saW5rLmxvdElkKTsKICAgIGlmKGxvdCAmJiBsaW5rLnF0eSA8PSBsb3QucXR5ICsgMWUtOSl7CiAgICAgIGxvdC5xdHkgLT0gbGluay5xdHk7CiAgICB9CiAgfQogIGJvb2subG90cyA9IGJvb2subG90cy5maWx0ZXIobD0+bC5xdHk+MWUtOSk7CiAgLy8gTXV0YXRlIHR4IHRvIGtlZXAgZGVyaXZlZCBmaWVsZHMgY29uc2lzdGVudAogIHR4LnF0eSA9IGxpbmtzLnJlZHVjZSgoYSxiKT0+YStiLnF0eSwwKTsKICB0eC5wcmljZSA9IHBTZWxsOwogIHR4LnByb2NlZWRzID0gcHJvY2VlZHM7CiAgdHguZ3Jvc3NQTCA9IGdyb3NzUEw7CiAgdHgudGF4ID0gdGF4OwogIHR4Lm5ldFBMID0gbmV0UEw7Cn0KCmZ1bmN0aW9uIGFwcGx5VHJhbnNmZXJDb21wYW55SW4oc3RhdGUsIHBmLCB0eCl7CiAgICBjb25zdCB0a3IgPSAodHgudGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICBjb25zdCBxID0gTnVtYmVyKHR4LnF0eSl8fDA7CiAgICBjb25zdCB1YyA9IE51bWJlcih0eC51bml0Q29zdCA/PyB0eC5wcmljZSA/PyAwKSB8fCAwOwogICAgc3RhdGUuaG9sZGluZ3NbdGtyXSB8fD0geyBsb3RzOiBbXSB9OwogICAgY29uc3QgbG90SWQgPSB0eC5uZXdMb3RJZCB8fCB0eC5sb3RJZCB8fCBpZCgpOwogICAgY29uc3QgbG90ID0geyBsb3RJZCwgZGF0ZTogdHguZGF0ZSB8fCB0b2RheSgpLCBxdHk6IHEsIHVuaXRDb3N0OiB1YywgcmF3UHJpY2U6IHVjLCBmZWVzOiBOdW1iZXIodHguZmVlcyl8fDAsIG5vdGU6IHR4Lm5vdGV8fCIiIH07CiAgICBzdGF0ZS5ob2xkaW5nc1t0a3JdLmxvdHMucHVzaChsb3QpOwogIH0KCmZ1bmN0aW9uIGFwcGx5VHJhbnNmZXJDb21wYW55T3V0KHN0YXRlLCBwZiwgdHgpewogICAgY29uc3QgdGtyID0gKHR4LnRpY2tlcnx8JycpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgY29uc3QgYm9vayA9IHN0YXRlLmhvbGRpbmdzW3Rrcl07CiAgICBpZighYm9vaykgcmV0dXJuOyAvLyBub3RoaW5nIHRvIHJlbW92ZQogICAgaWYodHgubG90SWQpewogICAgICBjb25zdCBpZHggPSBib29rLmxvdHMuZmluZEluZGV4KGw9PmwubG90SWQ9PT10eC5sb3RJZCk7CiAgICAgIGlmKGlkeD49MCl7CiAgICAgICAgY29uc3QgbG90ID0gYm9vay5sb3RzW2lkeF07CiAgICAgICAgbG90LnF0eSAtPSBxOwogICAgICAgIGlmKGxvdC5xdHkgPD0gMWUtOSl7IGJvb2subG90cy5zcGxpY2UoaWR4LDEpOyB9CiAgICAgIH0KICAgIH1lbHNlewogICAgICAvLyBGYWxsYmFjazogcmVtb3ZlIHF0eSBmcm9tIGZpcnN0IGxvdHMgRklGTwogICAgICBsZXQgcmVtYWluaW5nID0gcTsKICAgICAgZm9yKGNvbnN0IGxvdCBvZiBib29rLmxvdHMpewogICAgICAgIGlmKHJlbWFpbmluZzw9MWUtOSkgYnJlYWs7CiAgICAgICAgY29uc3QgdGFrZSA9IE1hdGgubWluKGxvdC5xdHksIHJlbWFpbmluZyk7CiAgICAgICAgbG90LnF0eSAtPSB0YWtlOwogICAgICAgIHJlbWFpbmluZyAtPSB0YWtlOwogICAgICB9CiAgICAgIGJvb2subG90cyA9IGJvb2subG90cy5maWx0ZXIobD0+bC5xdHk+MWUtOSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhcHBseUNhc2goc3RhdGUsIHR5cGUsIGFtb3VudCl7CiAgICBjb25zdCBhID0gTnVtYmVyKGFtb3VudCl8fDA7CiAgICBpZih0eXBlPT09ImRlcG9zaXQiIHx8IHR5cGU9PT0idHJhbnNmZXJfaW4iKSBzdGF0ZS5jYXNoICs9IGE7CiAgICBpZih0eXBlPT09IndpdGhkcmF3IiB8fCB0eXBlPT09InRyYW5zZmVyX291dCIpIHN0YXRlLmNhc2ggLT0gYTsKICB9CiAgZnVuY3Rpb24gcmVidWlsZFBvcnRmb2xpbyhwZil7CiAgICAvLyAtLS0gUHJlc2VydmUgcGVyLWxvdCBtdXRlZCBmbGFncyBCRUZPUkUgcmVidWlsZCAoYnkgc3RhYmxlIGxvdElkKSAtLS0KICAgIGNvbnN0IF9fcHJldk11dGVkID0ge307CiAgICB0cnl7CiAgICAgIGNvbnN0IHByZXZIb2xkaW5ncyA9IHBmICYmIHBmLmhvbGRpbmdzID8gcGYuaG9sZGluZ3MgOiB7fTsKICAgICAgZm9yKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocHJldkhvbGRpbmdzKSl7CiAgICAgICAgZm9yKGNvbnN0IGxvdCBvZiAoYm9vay5sb3RzfHxbXSkpewogICAgICAgICAgaWYobG90ICYmIGxvdC5sb3RJZCl7IF9fcHJldk11dGVkW2xvdC5sb3RJZF0gPSAhIWxvdC5tdXRlZDsgfQogICAgICAgIH0KICAgICAgfQogICAgfWNhdGNoKF8pe30KCiAgICAvLyBSZXBsYXkgZnJvbSBvbGRlc3QgdG8gbmV3ZXN0CiAgICBjb25zdCB0eHNDaHJvbm8gPSBwZi50cmFuc2FjdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICBjb25zdCBzdGF0ZSA9IGNsb25lRW1wdHlTdGF0ZShwZik7CiAgICBzdGF0ZS5fX2Vycm9ycyA9IFtdOwogICAgZm9yKGNvbnN0IHR4IG9mIHR4c0Nocm9ubyl7CiAgICAgIGlmKHR4LnR5cGU9PT0iZGVwb3NpdCIgfHwgdHgudHlwZT09PSJ3aXRoZHJhdyIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9pbiIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9vdXQiKXsKICAgICAgICBhcHBseUNhc2goc3RhdGUsIHR4LnR5cGUsIHR4LmFtb3VudCk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0iYnV5Iil7CiAgICAgICAgZW5zdXJlQnV5TG90SWRJblR4KHR4KTsKICAgICAgICBhcHBseUJ1eShzdGF0ZSwgcGYsIHR4KTsKICAgICAgfWVsc2UgaWYodHgudHlwZSA9PT0gInNlbGwiKXsKICAgICAgICBjb25zdCBzZWxsRGF0ZU1zID0gdG9Ncyh0eC5kYXRlKTsKICAgICAgICBhcHBseVNlbGwoc3RhdGUsIHBmLCB0eCk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0idHJhbnNmZXJfY29tcGFueV9pbiIpewogICAgICAgIGFwcGx5VHJhbnNmZXJDb21wYW55SW4oc3RhdGUsIHBmLCB0eCk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0idHJhbnNmZXJfY29tcGFueV9vdXQiKXsKICAgICAgICBhcHBseVRyYW5zZmVyQ29tcGFueU91dChzdGF0ZSwgcGYsIHR4KTsKICAgICAgfQogICAgfQoKICAgIC8vIC0tLSBSZS1hcHBseSBtdXRlZCBmbGFncyB0byByZWJ1aWx0IGxvdHMgKG1hdGNoaW5nIGJ5IGxvdElkKSAtLS0KICAgIHRyeXsKICAgICAgZm9yKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUuaG9sZGluZ3N8fHt9KSl7CiAgICAgICAgZm9yKGNvbnN0IGxvdCBvZiAoYm9vay5sb3RzfHxbXSkpewogICAgICAgICAgaWYobG90ICYmIGxvdC5sb3RJZCAmJiAoX19wcmV2TXV0ZWRbbG90LmxvdElkXSA9PT0gdHJ1ZSB8fCBfX3ByZXZNdXRlZFtsb3QubG90SWRdID09PSBmYWxzZSkpewogICAgICAgICAgICBsb3QubXV0ZWQgPSBfX3ByZXZNdXRlZFtsb3QubG90SWRdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfWNhdGNoKF8pe30KCiAgICAKICAgIC8vIC0tLSBQcnVuZSBlbXB0eS96ZXJvLXF0eSBsb3RzIGFuZCByZW1vdmUgZW1wdHkgdGlja2VycyAoYW50aS1naG9zdCkgLS0tCiAgICB0cnkgewogICAgICBmb3IgKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUuaG9sZGluZ3MgfHwge30pKSB7CiAgICAgICAgY29uc3QgbG90cyA9IEFycmF5LmlzQXJyYXkoYm9vay5sb3RzKSA/IGJvb2subG90cyA6IFtdOwogICAgICAgIC8vIGRyb3AgemVyby1xdHkgbG90cwogICAgICAgIGJvb2subG90cyA9IGxvdHMuZmlsdGVyKGwgPT4gTnVtYmVyKGwgJiYgbC5xdHkgfHwgMCkgPiAxZS05KTsKICAgICAgICAvLyByZW1vdmUgdGlja2VyIGVudGlyZWx5IGlmIG5vIGxvdHMgbGVmdAogICAgICAgIGlmICghYm9vay5sb3RzLmxlbmd0aCkgewogICAgICAgICAgZGVsZXRlIHN0YXRlLmhvbGRpbmdzW3RrXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKF8pIHt9CnBmLl9fZXJyb3JzID0gQXJyYXkuaXNBcnJheShzdGF0ZS5fX2Vycm9ycykgPyBzdGF0ZS5fX2Vycm9ycyA6IFtdOwogICAgcGYuY2FzaCA9IHN0YXRlLmNhc2g7CiAgICBwZi5ob2xkaW5ncyA9IHN0YXRlLmhvbGRpbmdzOwogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOwogIH0KICBmdW5jdGlvbiBnZXRQZihpZCl7IHJldHVybiBEQi5wb3J0Zm9saW9zLmZpbmQocD0+cC5pZD09PWlkKSB8fCBudWxsOyB9CiAgZnVuY3Rpb24gZW5zdXJlQ3VycmVuY3koY3VyKXsgcmV0dXJuIGN1ciB8fCBEQi5zZXR0aW5ncy5jdXJyZW5jeURlZmF1bHQgfHwgIlBMTiI7IH0KCiAgZnVuY3Rpb24gYWRkUG9ydGZvbGlvKCl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IkRvZGFuaWUgcG9ydGZlbGEiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBuZXdQZiA9IHsKICAgICAgaWQ6IGlkKCksCiAgICAgIG5hbWU6ICJOb3d5IHBvcnRmZWwiLAogICAgICBjdXJyZW5jeTogREIuc2V0dGluZ3MuY3VycmVuY3lEZWZhdWx0IHx8ICJQTE4iLAogICAgICBzdHJhdGVneTogIiIsCiAgICAgIGNhc2g6IDAsCiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgaG9sZGluZ3M6IHt9LCAvLyB0aWNrZXIgLT4geyBsb3RzOiBbIHtsb3RJZCwgZGF0ZSwgcXR5LCB1bml0Q29zdCwgcmF3UHJpY2UsIGZlZXMsIG5vdGV9IF0gfQogICAgICB0cmFuc2FjdGlvbnM6IFtdIC8vIGxpc3Qgb2YgdHggb2JqZWN0cwogICAgfTsKICAgIERCLnBvcnRmb2xpb3MucHVzaChuZXdQZik7CiAgICBjdXJyZW50UGZJZCA9IG5ld1BmLmlkOwogICAgc2F2ZSgpOyByZW5kZXIoKTsKICB9CgogIGZ1bmN0aW9uIGRlbGV0ZVBvcnRmb2xpbyhwZklkKXsKICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiVXN1bmlcdTAxMTljaWUgcG9ydGZlbGEiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBpZHggPSBEQi5wb3J0Zm9saW9zLmZpbmRJbmRleChwPT5wLmlkPT09cGZJZCk7CiAgICBpZihpZHg+PTApeyBEQi5wb3J0Zm9saW9zLnNwbGljZShpZHgsMSk7IGlmKGN1cnJlbnRQZklkPT09cGZJZCkgY3VycmVudFBmSWQgPSBEQi5wb3J0Zm9saW9zWzBdPy5pZCB8fCBudWxsOyBzYXZlKCk7IHJlbmRlcigpOyB9CiAgfQoKICBmdW5jdGlvbiByZW5hbWVQb3J0Zm9saW8ocGZJZCwgbmFtZSl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlptaWFuYSBuYXp3eSBwb3J0ZmVsYSIsIGtpbmQ6J21ldGEnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBwZi5uYW1lID0gbmFtZTsgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB0cnkgeyByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogIH0KCiAgZnVuY3Rpb24gc2V0U3RyYXRlZ3kocGZJZCwgdGV4dCl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IkVkeWNqYSBzdHJhdGVnaWkvbm90YXRraSIsIGtpbmQ6J21ldGEnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBwZi5zdHJhdGVneSA9IHRleHQ7IHBmLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsgdHJ5IHsgcmVidWlsZFBvcnRmb2xpbyhwZik7IH0gY2F0Y2goXykge30gc2F2ZSgpOyByZW5kZXIoKTsKICB9CgogIGZ1bmN0aW9uIGRlcG9zaXQocGZJZCwgYW1vdW50LCBub3RlPSIiKXsKICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiV3BcdTAxNDJhdGEgZ290XHUwMGYzd2tpIiwga2luZDondHgnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBjb25zdCBhbXQgPSBOdW1iZXIoYW1vdW50KXx8MDsKICAgIHBmLmNhc2ggKz0gYW10OwogICAgcGYudHJhbnNhY3Rpb25zLnVuc2hpZnQoeyBpZDppZCgpLCB0eXBlOiJkZXBvc2l0IiwgZGF0ZTp0b2RheSgpLCBhbW91bnQ6YW10LCBub3RlIH0pOwogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB0cnkgeyByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogIH0KICBmdW5jdGlvbiB3aXRoZHJhdyhwZklkLCBhbW91bnQsIG5vdGU9IiIpewogIHRyeXsgcHVzaFVuZG8oe2xhYmVsOiJXeXBcdTAxNDJhdGEgZ290XHUwMGYzd2tpIiwga2luZDondHgnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBjb25zdCBhbXQgPSBOdW1iZXIoYW1vdW50KXx8MDsKICAgIGlmKCFEQi5zZXR0aW5ncy5hbGxvd05lZ2F0aXZlQ2FzaCAmJiBwZi5jYXNoIDwgYW10KXsgYWxlcnQoIkJyYWsgxZtyb2Rrw7N3LiBXxYLEhWN6IG9wY2rEmSAnWmV6d8OzbCBuYSBzYWxkbyB1amVtbmUnIHcgVXN0YXdpZW5pYWNoLCBqZcWbbGkgY2hjZXN6IGtvbnR5bnVvd2HEhy4iKTsgcmV0dXJuOyB9CiAgICBwZi5jYXNoIC09IGFtdDsKICAgIHBmLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsgaWQ6aWQoKSwgdHlwZToid2l0aGRyYXciLCBkYXRlOnRvZGF5KCksIGFtb3VudDphbXQsIG5vdGUgfSk7CiAgICBwZi51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7IHRyeSB7IHJlYnVpbGRQb3J0Zm9saW8ocGYpOyB9IGNhdGNoKF8pIHt9IHNhdmUoKTsgcmVuZGVyKCk7CiAgfQoKICBmdW5jdGlvbiB0cmFuc2Zlcihmcm9tSWQsIHRvSWQsIGFtb3VudCwgbm90ZT0iIil7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlByemVsZXcgbWlcdTAxMTlkenkgcG9ydGZlbGFtaSIsIGtpbmQ6J3R4J30pOyB9Y2F0Y2goXyl7fQoKICBpZihmcm9tSWQ9PT10b0lkKXsgYWxlcnQoIld5YmllcnogcsOzxbxuZSBwb3J0ZmVsZS4iKTsgcmV0dXJuOyB9CiAgY29uc3QgZnJvbSA9IGdldFBmKGZyb21JZCksIHRvID0gZ2V0UGYodG9JZCk7CiAgY29uc3QgYW10ID0gTnVtYmVyKGFtb3VudCl8fDA7CiAgaWYoIWZyb20gfHwgIXRvKSByZXR1cm4gYWxlcnQoIk5pZXByYXdpZMWCb3dlIHBvcnRmZWxlLiIpOwogIGlmKCFEQi5zZXR0aW5ncy5hbGxvd05lZ2F0aXZlQ2FzaCAmJiBmcm9tLmNhc2ggPCBhbXQpeyBhbGVydCgiQnJhayDFm3JvZGvDs3cgdyBwb3J0ZmVsdSDFunLDs2TFgm93eW0uIik7IHJldHVybjsgfQogIGZyb20uY2FzaCAtPSBhbXQ7CiAgdG8uY2FzaCArPSBhbXQ7CiAgY29uc3Qgc3RhbXAgPSB0b2RheSgpOwogIGNvbnN0IGxpbmtJZCA9IGlkKCk7CiAgZnJvbS50cmFuc2FjdGlvbnMudW5zaGlmdCh7IGlkOmlkKCksIGxpbmtJZCwgdHlwZToidHJhbnNmZXJfb3V0IiwgZGF0ZTpzdGFtcCwgYW1vdW50OmFtdCwgbm90ZSwgY291bnRlcnBhcnR5UG9ydGZvbGlvSWQ6IHRvLmlkIH0pOwogIHRvLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsgaWQ6aWQoKSwgbGlua0lkLCB0eXBlOiJ0cmFuc2Zlcl9pbiIsICBkYXRlOnN0YW1wLCBhbW91bnQ6YW10LCBub3RlLCBjb3VudGVycGFydHlQb3J0Zm9saW9JZDogZnJvbS5pZCB9KTsKICBmcm9tLnVwZGF0ZWRBdCA9IHRvLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICBzYXZlKCk7IHJlbmRlcigpOwp9CgoKYXN5bmMgZnVuY3Rpb24gdHJhbnNmZXJDb21wYW55RGlhbG9nKGZyb21QZklkLCB0aWNrZXIpIHsKICBjb25zdCBmcm9tUGYgPSBnZXRQZihmcm9tUGZJZCk7CiAgaWYoIWZyb21QZikgcmV0dXJuIGFsZXJ0KCJCxYLEhWQ6IHBvcnRmZWwgxbpyw7NkxYJvd3kgbmllIGlzdG5pZWplLiIpOwogIGNvbnN0IGJvb2sgPSAoZnJvbVBmLmhvbGRpbmdzfHx7fSlbdGlja2VyXTsKICBpZighYm9vayB8fCAhYm9vay5sb3RzIHx8ICFib29rLmxvdHMubGVuZ3RoKSByZXR1cm4gYWxlcnQoIkJyYWsgcGFraWV0w7N3IGRvIHByemVuaWVzaWVuaWEuIik7CiAgY29uc3QgdGFyZ2V0UG9ydGZvbGlvcyA9IERCLnBvcnRmb2xpb3MuZmlsdGVyKHAgPT4gcC5pZCAhPT0gZnJvbVBmSWQpOwogIGlmKCF0YXJnZXRQb3J0Zm9saW9zLmxlbmd0aCkgcmV0dXJuIGFsZXJ0KCJCcmFrIGlubnljaCBwb3J0ZmVsaSBkbyBwcnplbmllc2llbmlhLiIpOwogIGNvbnN0IG9wdHMgPSB0YXJnZXRQb3J0Zm9saW9zLm1hcChwID0+IGA8b3B0aW9uIHZhbHVlPSIke3AuaWR9Ij4ke19fZXNjKHAubmFtZSl9ICgke3AuY3VycmVuY3l9KTwvb3B0aW9uPmApLmpvaW4oIiIpOwogIGNvbnN0IHRvdGFsUXR5ID0gYm9vay5sb3RzLnJlZHVjZSgoc3VtLCBsb3QpID0+IHN1bSArIE51bWJlcihsb3QucXR5fHwwKSwgMCk7CiAgY29uc3QgdG90YWxWYWx1ZSA9IGJvb2subG90cy5yZWR1Y2UoKHN1bSwgbG90KSA9PiBzdW0gKyAoTnVtYmVyKGxvdC5xdHl8fDApICogTnVtYmVyKGxvdC51bml0Q29zdHx8MCkpLCAwKTsKICBjb25zdCBsb3RzTGlzdCA9IGJvb2subG90cy5tYXAoKGxvdCwgaSkgPT4gCiAgICBgPHRyPgogICAgICA8dGQ+JHtpKzF9PC90ZD4KICAgICAgPHRkPiR7X19lc2MobG90LmRhdGV8fCIiKX08L3RkPgogICAgICA8dGQ+JHtfX2ZtdE51bShsb3QucXR5fHwwKX08L3RkPgogICAgICA8dGQ+JHtfX2dvX2ZtdEN1cnJlbmN5KGxvdC51bml0Q29zdHx8MCwgZnJvbVBmLmN1cnJlbmN5KX08L3RkPgogICAgICA8dGQ+JHtfX2dvX2ZtdEN1cnJlbmN5KChOdW1iZXIobG90LnF0eXx8MCkgKiBOdW1iZXIobG90LnVuaXRDb3N0fHwwKSksIGZyb21QZi5jdXJyZW5jeSl9PC90ZD4KICAgIDwvdHI+YAogICkuam9pbigiIik7CgogIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgdGl0bGU6IGBQcnplbmllxZsgY2HFgsSFIHNww7PFgmvEmSAke3RpY2tlcn1gLAogICAgaW5uZXJIVE1MOiBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgPGxhYmVsPlBvcnRmZWwgZG9jZWxvd3k8L2xhYmVsPgogICAgICAgIDxzZWxlY3QgbmFtZT0idG9Qb3J0Zm9saW9JZCIgcmVxdWlyZWQ+JHtvcHRzfTwvc2VsZWN0PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgIDxsYWJlbD5EYXRhIHByemVuaWVzaWVuaWE8L2xhYmVsPgogICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgcmVxdWlyZWQgLz4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgPGxhYmVsPk5vdGF0a2EgKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHBsYWNlaG9sZGVyPSJucC4gcmVvcmdhbml6YWNqYSBwb3J0ZmVsaSIgLz4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgPGg0PlBha2lldHkgZG8gcHJ6ZW5pZXNpZW5pYTo8L2g0PgogICAgICAgIDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPgogICAgICAgICAgPHRhYmxlPgogICAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgICAgPHRyPjx0aD4jPC90aD48dGg+RGF0YTwvdGg+PHRoPklsb8WbxIc8L3RoPjx0aD5Lb3N6dC9zenQ8L3RoPjx0aD5XYXJ0b8WbxIc8L3RoPjwvdHI+CiAgICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICAgIDx0Ym9keT4ke2xvdHNMaXN0fTwvdGJvZHk+CiAgICAgICAgICAgIDx0Zm9vdD4KICAgICAgICAgICAgICA8dHIgc3R5bGU9ImZvbnQtd2VpZ2h0OmJvbGQiPgogICAgICAgICAgICAgICAgPHRkIGNvbHNwYW49IjIiPlJBWkVNOjwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+JHtfX2ZtdE51bSh0b3RhbFF0eSl9PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD7igJQ8L3RkPgogICAgICAgICAgICAgICAgPHRkPiR7X19nb19mbXRDdXJyZW5jeSh0b3RhbFZhbHVlLCBmcm9tUGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90Zm9vdD4KICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwgd2Fybi10ZXh0Ij4KICAgICAgICAgIFVXQUdBOiBPcGVyYWNqYSBwcnplbmllc2llIHdzenlzdGtpZSBwYWtpZXR5IGFrY2ppICR7dGlja2VyfSAKICAgICAgICAgIHogcG9ydGZlbGEgIiR7ZnJvbVBmLm5hbWV9IiBkbyB3eWJyYW5lZ28gcG9ydGZlbGEgZG9jZWxvd2Vnby4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Zvcm0+YCwKICAgIG9rVGV4dDogIlByemVuaWXFmyBzcMOzxYJrxJkiLAogICAgY2FuY2VsVGV4dDogIkFudWx1aiIKICB9KTsKICBpZihkYXRhKSB7CiAgICBhd2FpdCB0cmFuc2ZlckNvbXBhbnkoZnJvbVBmSWQsIGRhdGEudG9Qb3J0Zm9saW9JZCwgdGlja2VyLCBkYXRhLmRhdGUsIGRhdGEubm90ZXx8IiIpOwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdHJhbnNmZXJDb21wYW55KGZyb21QZklkLCB0b1BmSWQsIHRpY2tlciwgZGF0ZSwgbm90ZSA9ICIiKSB7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlRyYW5zZmVyIHNwXHUwMGYzXHUwMTQya2kiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgaWYoZnJvbVBmSWQgPT09IHRvUGZJZCkgcmV0dXJuIGFsZXJ0KCJQb3J0ZmVsIMW6csOzZMWCb3d5IGkgZG9jZWxvd3kgc8SFIGlkZW50eWN6bmUuIik7CiAgY29uc3QgZnJvbVBmID0gZ2V0UGYoZnJvbVBmSWQpOwogIGNvbnN0IHRvUGYgPSBnZXRQZih0b1BmSWQpOwogIGlmKCFmcm9tUGYgfHwgIXRvUGYpIHJldHVybiBhbGVydCgiQsWCxIVkOiBuaWVwcmF3aWTFgm93ZSBwb3J0ZmVsZS4iKTsKICBjb25zdCBib29rID0gKGZyb21QZi5ob2xkaW5nc3x8e30pW3RpY2tlcl07CiAgaWYoIWJvb2sgfHwgIWJvb2subG90cyB8fCAhYm9vay5sb3RzLmxlbmd0aCkgcmV0dXJuIGFsZXJ0KCJCcmFrIHBha2lldMOzdyBkbyBwcnplbmllc2llbmlhLiIpOwogIGlmKGZyb21QZi5jdXJyZW5jeSAhPT0gdG9QZi5jdXJyZW5jeSkgewogICAgY29uc3QgcHJvY2VlZCA9IGNvbmZpcm0oCiAgICAgIGBVd2FnYTogUsOzxbxuZSB3YWx1dHkhXG5gICsKICAgICAgYFo6ICR7ZnJvbVBmLm5hbWV9ICgke2Zyb21QZi5jdXJyZW5jeX0pXG5gICsKICAgICAgYERvOiAke3RvUGYubmFtZX0gKCR7dG9QZi5jdXJyZW5jeX0pXG5cbmAgKwogICAgICBgQ3p5IGtvbnR5bnVvd2HEhyBwcnplbmllc2llbmllP2AKICAgICk7CiAgICBpZighcHJvY2VlZCkgcmV0dXJuOwogIH0KICB0cnl7CiAgICBjb25zdCB0cmFuc2ZlckRhdGUgPSBkYXRlIHx8IHRvZGF5KCk7CiAgICBjb25zdCBsaW5rSWQgPSBpZCgpOwogICAgdG9QZi5ob2xkaW5nc1t0aWNrZXJdID0gdG9QZi5ob2xkaW5nc1t0aWNrZXJdIHx8IHsgbG90czogW10gfTsKICAgIGZvcihjb25zdCBsb3Qgb2YgYm9vay5sb3RzKXsKICAgICAgY29uc3QgbmV3TG90SWQgPSBpZCgpOwogICAgICBjb25zdCBuZXdMb3QgPSB7CiAgICAgICAgLi4ubG90LAogICAgICAgIGxvdElkOiBuZXdMb3RJZCwKICAgICAgICB0cmFuc2ZlcnJlZEZyb206IHsKICAgICAgICAgIG9yaWdpbmFsTG90SWQ6IGxvdC5sb3RJZCwKICAgICAgICAgIGZyb21Qb3J0Zm9saW9JZDogZnJvbVBmSWQsCiAgICAgICAgICBmcm9tUG9ydGZvbGlvTmFtZTogZnJvbVBmLm5hbWUsCiAgICAgICAgICB0cmFuc2ZlckRhdGU6IHRyYW5zZmVyRGF0ZSwKICAgICAgICAgIHRyYW5zZmVyTGlua0lkOiBsaW5rSWQKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRvUGYuaG9sZGluZ3NbdGlja2VyXS5sb3RzLnB1c2gobmV3TG90KTsKICAgICAgdG9QZi50cmFuc2FjdGlvbnMudW5zaGlmdCh7CiAgICAgICAgaWQ6IGlkKCksCiAgICAgICAgbGlua0lkOiBsaW5rSWQsCiAgICAgICAgdHlwZTogInRyYW5zZmVyX2NvbXBhbnlfaW4iLAogICAgICAgIGRhdGU6IHRyYW5zZmVyRGF0ZSwKICAgICAgICB0aWNrZXI6IHRpY2tlciwKICAgICAgICBxdHk6IE51bWJlcihsb3QucXR5KXx8MCwKICAgICAgICBwcmljZTogTnVtYmVyKGxvdC5yYXdQcmljZSA/PyBsb3QudW5pdENvc3QpIHx8IDAsCiAgICAgICAgdW5pdENvc3Q6IE51bWJlcihsb3QudW5pdENvc3QpfHwwLAogICAgICAgIGZlZXM6IE51bWJlcihsb3QuZmVlcyl8fDAsCiAgICAgICAgbm90ZTogYFRyYW5zZmVyIHNww7PFgmtpICR7dGlja2VyfSB6IHBvcnRmZWxhICIke2Zyb21QZi5uYW1lfSIuICR7bm90ZX1gLnRyaW0oKSwKICAgICAgICBjb3VudGVycGFydHlQb3J0Zm9saW9JZDogZnJvbVBmSWQsCiAgICAgICAgb3JpZ2luYWxMb3RJZDogbG90LmxvdElkLAogICAgICAgIG5ld0xvdElkOiBuZXdMb3RJZAogICAgICB9KTsKICAgIH0KICAgIGZvcihjb25zdCBsb3Qgb2YgYm9vay5sb3RzKXsKICAgICAgZnJvbVBmLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsKICAgICAgICBpZDogaWQoKSwKICAgICAgICBsaW5rSWQ6IGxpbmtJZCwKICAgICAgICB0eXBlOiAidHJhbnNmZXJfY29tcGFueV9vdXQiLAogICAgICAgIGRhdGU6IHRyYW5zZmVyRGF0ZSwKICAgICAgICB0aWNrZXI6IHRpY2tlciwKICAgICAgICBxdHk6IE51bWJlcihsb3QucXR5KXx8MCwKICAgICAgICBwcmljZTogTnVtYmVyKGxvdC5yYXdQcmljZSA/PyBsb3QudW5pdENvc3QpIHx8IDAsCiAgICAgICAgdW5pdENvc3Q6IE51bWJlcihsb3QudW5pdENvc3QpfHwwLAogICAgICAgIGZlZXM6IE51bWJlcihsb3QuZmVlcyl8fDAsCiAgICAgICAgbm90ZTogYFRyYW5zZmVyIHNww7PFgmtpICR7dGlja2VyfSBkbyBwb3J0ZmVsYSAiJHt0b1BmLm5hbWV9Ii4gJHtub3RlfWAudHJpbSgpLAogICAgICAgIGNvdW50ZXJwYXJ0eVBvcnRmb2xpb0lkOiB0b1BmSWQsCiAgICAgICAgbG90SWQ6IGxvdC5sb3RJZAogICAgICB9KTsKICAgIH0KICAgIGRlbGV0ZSBmcm9tUGYuaG9sZGluZ3NbdGlja2VyXTsKICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgIGZyb21QZi51cGRhdGVkQXQgPSBub3c7CiAgICB0b1BmLnVwZGF0ZWRBdCA9IG5vdzsKICAgIHRyeSB7IHJlYnVpbGRQb3J0Zm9saW8oZnJvbVBmKTsgcmVidWlsZFBvcnRmb2xpbyh0b1BmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogICAgYWxlcnQoCiAgICAgIGBUcmFuc2ZlciB6YWtvxYRjem9ueSFcblxuYCArCiAgICAgIGBTcMOzxYJrYTogJHt0aWNrZXJ9XG5gICsKICAgICAgYFo6ICR7ZnJvbVBmLm5hbWV9IOKGkiAke3RvUGYubmFtZX1cbmAgKwogICAgICBgUGFraWV0w7N3OiAke2Jvb2subG90cy5sZW5ndGh9XG5gICsKICAgICAgYERhdGE6ICR7dHJhbnNmZXJEYXRlfWAKICAgICk7CiAgfWNhdGNoKGVycm9yKXsKICAgIGNvbnNvbGUuZXJyb3IoIkLFgsSFZCB0cmFuc2ZlcnUgc3DDs8WCa2k6IiwgZXJyb3IpOwogICAgYWxlcnQoYELFgsSFZCBwb2RjemFzIHRyYW5zZmVydTogJHtlcnJvci5tZXNzYWdlfWApOwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gYnV5KHBmSWQsIHt0aWNrZXIsIGRhdGUsIHF0eSwgcHJpY2UsIGZlZXMsIG5vdGUsIHRhcmdldFBjdCwgdGFyZ2V0UHJpY2UsIGJ1eVRhcmdldFBjdCwgYnV5VGFyZ2V0UHJpY2V9KXsKICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiWmFrdXAiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBwZiA9IGdldFBmKHBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIHRpY2tlciA9ICh0aWNrZXJ8fCIiKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgIGNvbnN0IHEgPSBNYXRoLm1heCgwLCBOdW1iZXIocXR5KXx8MCk7CiAgICBjb25zdCBwID0gTnVtYmVyKHByaWNlKXx8MDsKICAgIGNvbnN0IGYgPSBOdW1iZXIoZmVlcyl8fDA7CiAgICBpZighdGlja2VyIHx8IHE8PTAgfHwgcDw9MCl7IHJldHVybiBhbGVydCgiVXp1cGXFgm5paiBwb3ByYXduaWU6IHRpY2tlciwgaWxvxZvEhywgY2VuxJkuIik7IH0KICAgIGNvbnN0IGNhc2hPdXQgPSBxKnAgKyBmOwogICAgaWYoIURCLnNldHRpbmdzLmFsbG93TmVnYXRpdmVDYXNoICYmIHBmLmNhc2ggPCBjYXNoT3V0KXsgcmV0dXJuIGFsZXJ0KCJCcmFrIMWbcm9ka8OzdyBuYSB6YWt1cCAoc3ByYXdkxbogc2FsZG8gZ290w7N3a2kpIGx1YiB6ZXp3w7NsIG5hIHNhbGRvIHVqZW1uZSB3IHVzdGF3aWVuaWFjaC4iKTsgfQogICAgcGYuY2FzaCAtPSBjYXNoT3V0OwogICAgcGYuaG9sZGluZ3NbdGlja2VyXSB8fD0geyBsb3RzOiBbXSB9OwogICAgY29uc3QgbG90ID0geyBsb3RJZDogaWQoKSwgZGF0ZTogZGF0ZSB8fCB0b2RheSgpLCBxdHk6IHEsIHVuaXRDb3N0OiBwICsgKGYvcXx8MCksIHJhd1ByaWNlOiBwLCBmZWVzOiBmLCBub3RlOiBub3RlfHwiIiwgdGFyZ2V0UGN0OiAodGFyZ2V0UGN0IT09dW5kZWZpbmVkICYmIHRhcmdldFBjdCE9PSIiID8gTnVtYmVyKHRhcmdldFBjdCkgOiBudWxsKSwgdGFyZ2V0UHJpY2U6ICh0YXJnZXRQcmljZSE9PXVuZGVmaW5lZCAmJiB0YXJnZXRQcmljZSE9PSIiID8gTnVtYmVyKHRhcmdldFByaWNlKSA6IG51bGwpLCBidXlUYXJnZXRQY3Q6IChidXlUYXJnZXRQY3QhPT11bmRlZmluZWQgJiYgYnV5VGFyZ2V0UGN0IT09IiIgPyBOdW1iZXIoYnV5VGFyZ2V0UGN0KSA6IG51bGwpLCBidXlUYXJnZXRQcmljZTogKGJ1eVRhcmdldFByaWNlIT09dW5kZWZpbmVkICYmIGJ1eVRhcmdldFByaWNlIT09IiIgPyBOdW1iZXIoYnV5VGFyZ2V0UHJpY2UpIDogbnVsbCkgfTsKICAgIHBmLmhvbGRpbmdzW3RpY2tlcl0ubG90cy5wdXNoKGxvdCk7CiAgICBwZi50cmFuc2FjdGlvbnMudW5zaGlmdCh7IGlkOmlkKCksIHR5cGU6ImJ1eSIsIGRhdGU6IGRhdGUgfHwgdG9kYXkoKSwgdGlja2VyLCBxdHk6cSwgcHJpY2U6cCwgZmVlczpmLCBub3RlOiBub3RlLCBsb3RJZDogbG90LmxvdElkLCB0YXJnZXRQY3Q6IGxvdC50YXJnZXRQY3QsIHRhcmdldFByaWNlOiBsb3QudGFyZ2V0UHJpY2UsIGJ1eVRhcmdldFBjdDogbG90LmJ1eVRhcmdldFBjdCwgYnV5VGFyZ2V0UHJpY2U6IGxvdC5idXlUYXJnZXRQcmljZSB9KTsKICAgIHBmLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsgdHJ5IHsgcmVidWlsZFBvcnRmb2xpbyhwZik7IH0gY2F0Y2goXykge30gc2F2ZSgpOyByZW5kZXIoKTsKICB9CgogIGZ1bmN0aW9uIHNlbGwocGZJZCwge3RpY2tlciwgZGF0ZSwgc2VsbFByaWNlLCBmZWVzLCBhbGxvY2F0aW9ucywgbm90ZX0pewogIHRyeXsgcHVzaFVuZG8oe2xhYmVsOiJTcHJ6ZWRhXHUwMTdjIiwga2luZDondHgnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICB0aWNrZXIgPSAodGlja2VyfHwiIikudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICBjb25zdCBwU2VsbCA9IE51bWJlcihzZWxsUHJpY2UpfHwwOwogICAgY29uc3QgZiA9IE51bWJlcihmZWVzKXx8MDsKICAgIGlmKCF0aWNrZXIgfHwgcFNlbGw8PTApeyByZXR1cm4gYWxlcnQoIlV6dXBlxYJuaWogcG9wcmF3bmllOiB0aWNrZXIgaSBjZW7EmSBzcHJ6ZWRhxbx5LiIpOyB9CiAgICBjb25zdCBib29rID0gcGYuaG9sZGluZ3NbdGlja2VyXTsgaWYoIWJvb2speyByZXR1cm4gYWxlcnQoIkJyYWsgcG96eWNqaSBuYSB0ZW4gdGlja2VyLiIpOyB9CiAgICAvLyBWYWxpZGF0ZSBhbGxvY2F0aW9ucwogICAgbGV0IHRvdGFsUXR5ID0gMDsKICAgIGFsbG9jYXRpb25zID0gYWxsb2NhdGlvbnMuZmlsdGVyKGE9PmEucXR5PjApOwogICAgaWYoYWxsb2NhdGlvbnMubGVuZ3RoPT09MCl7IHJldHVybiBhbGVydCgiV3liaWVyeiBpbG/Fm8SHIGRvIHNwcnplZGHFvHkgdyBjbyBuYWptbmllaiBqZWRuZWogcGFydGlpLiIpOyB9CiAgICBmb3IoY29uc3QgYSBvZiBhbGxvY2F0aW9ucyl7IHRvdGFsUXR5ICs9IGEucXR5OyB9CiAgICAvLyBQcm9jZWVkcyBhbmQgUC9MCiAgICBjb25zdCBwcm9jZWVkcyA9IHRvdGFsUXR5ICogcFNlbGw7CiAgICBsZXQgZ3Jvc3NQTCA9IDA7CiAgICBmb3IoY29uc3QgYSBvZiBhbGxvY2F0aW9ucyl7CiAgICAgIGNvbnN0IGxvdCA9IGJvb2subG90cy5maW5kKGw9PmwubG90SWQ9PT1hLmxvdElkKTsKICAgICAgaWYoIWxvdCkgcmV0dXJuIGFsZXJ0KCJOaWUgem5hbGV6aW9ubyBwYXJ0aWkuIik7CiAgICAgIGlmKGEucXR5ID4gbG90LnF0eSl7IHJldHVybiBhbGVydCgiU3ByemVkYXdhbmEgaWxvxZvEhyBwcnpla3JhY3phIGlsb8WbxIcgdyBwYXJ0aWkuIik7IH0KICAgICAgZ3Jvc3NQTCArPSBhLnF0eSAqIChwU2VsbCAtIGxvdC51bml0Q29zdCk7CiAgICB9CiAgICBncm9zc1BMIC09IGY7CiAgICBjb25zdCB0YXggPSBncm9zc1BMPjAgPyBncm9zc1BMICogKERCLnNldHRpbmdzLnRheFJhdGUgfHwgMC4xOSkgOiAwOwogICAgY29uc3QgbmV0UEwgPSBncm9zc1BMIC0gdGF4OwogICAgLy8gQXBwbHkgaW52ZW50b3J5IGNoYW5nZXMKICAgIGZvcihjb25zdCBhIG9mIGFsbG9jYXRpb25zKXsKICAgICAgY29uc3QgbG90ID0gYm9vay5sb3RzLmZpbmQobD0+bC5sb3RJZD09PWEubG90SWQpOwogICAgICBsb3QucXR5IC09IGEucXR5OwogICAgfQogICAgYm9vay5sb3RzID0gYm9vay5sb3RzLmZpbHRlcihsPT5sLnF0eT4wLjAwMDAwMDEpOwogICAgLy8gQWRkIGNhc2gKICAgIHBmLmNhc2ggKz0gKHByb2NlZWRzIC0gZik7CiAgICAvLyBSZWNvcmQgVFgKICAgIHBmLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsKICAgICAgaWQ6aWQoKSwgdHlwZToic2VsbCIsIGRhdGU6IGRhdGUgfHwgdG9kYXkoKSwgdGlja2VyLAogICAgICBxdHk6IHRvdGFsUXR5LCBwcmljZTogcFNlbGwsIGZlZXM6IGYsCiAgICAgIHByb2NlZWRzLCBncm9zc1BMLCB0YXgsIG5ldFBMLAogICAgICBsb3RMaW5rczogYWxsb2NhdGlvbnMubWFwKGE9Pih7IGxvdElkOmEubG90SWQsIHF0eTphLnF0eSB9KSksCiAgICAgIG5vdGUKICAgIH0pOwogICAgLy8gQ2xlYW51cCBlbXB0eSB0aWNrZXIKICAgIGlmKGJvb2subG90cy5sZW5ndGg9PT0wKXsgZGVsZXRlIHBmLmhvbGRpbmdzW3RpY2tlcl07IH0KICAgIHBmLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsgdHJ5IHsgcmVidWlsZFBvcnRmb2xpbyhwZik7IH0gY2F0Y2goXykge30gc2F2ZSgpOyByZW5kZXIoKTsKICB9CgogIC8vID09PSBYVEIgSU1QT1JURVIgdjE6IFhMU1ggLT4ga29uZmlndXJhdG9yIEJVWS9TRUxMID09PQogIGxldCBfX3h0YkltcG9ydFBvcnRmb2xpb0lkID0gbnVsbDsKICBsZXQgX194dGJBZ2dyZWdhdGVkID0gbnVsbDsKICBsZXQgX194dGJJbXBvcnRNb2RhbCA9IG51bGw7CgogIGZ1bmN0aW9uIHN0YXJ0WHRiSW1wb3J0Rm9yUG9ydGZvbGlvKHBmSWQpewogICAgX194dGJJbXBvcnRQb3J0Zm9saW9JZCA9IHBmSWQ7CiAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ4dGJJbXBvcnRGaWxlIik7CiAgICBpZighaW5wdXQpewogICAgICBhbGVydCgiQnJhayBwb2xhIHBsaWt1IFhUQiB3IEhUTUwuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlucHV0LnZhbHVlID0gIiI7CiAgICBpbnB1dC5jbGljaygpOwogIH0KCiAgZnVuY3Rpb24gX194dGJFeGNlbERhdGVUb0pzKHZhbHVlKXsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHJldHVybiB2YWx1ZTsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgIGNvbnN0IGVwb2NoID0gbmV3IERhdGUoRGF0ZS5VVEMoMTg5OSwgMTEsIDMwKSk7CiAgICAgIGNvbnN0IG1zID0gdmFsdWUgKiAyNCAqIDYwICogNjAgKiAxMDAwOwogICAgICByZXR1cm4gbmV3IERhdGUoZXBvY2guZ2V0VGltZSgpICsgbXMpOwogICAgfQogICAgcmV0dXJuIHZhbHVlIHx8IG51bGw7CiAgfQoKICBmdW5jdGlvbiBfX3h0YlBhcnNlTnVtYmVyKHZhbCl7CiAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHJldHVybiB2YWw7CiAgICBpZiAodmFsID09IG51bGwpIHJldHVybiBOYU47CiAgICBsZXQgcyA9IFN0cmluZyh2YWwpLnJlcGxhY2UoL1xccysvZywgIiIpOwogICAgcyA9IHMucmVwbGFjZSgiLCIsICIuIik7CiAgICBjb25zdCBuID0gTnVtYmVyKHMpOwogICAgcmV0dXJuIGlzTmFOKG4pID8gTmFOIDogbjsKICB9CgogIGZ1bmN0aW9uIF9feHRiRGV0ZWN0SGVhZGVyUm93KHJvd3MsIHJlcXVpcmVkQ29scyl7CiAgICBmb3IobGV0IGk9MDtpPHJvd3MubGVuZ3RoO2krKyl7CiAgICAgIGNvbnN0IHIgPSByb3dzW2ldIHx8IFtdOwogICAgICBsZXQgb2sgPSB0cnVlOwogICAgICBmb3IoY29uc3QgbmFtZSBvZiByZXF1aXJlZENvbHMpewogICAgICAgIGlmKCFyLmluY2x1ZGVzKG5hbWUpKXsgb2sgPSBmYWxzZTsgYnJlYWs7IH0KICAgICAgfQogICAgICBpZihvaykgcmV0dXJuIGk7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICBmdW5jdGlvbiBfX3h0YkJ1aWxkSW5kZXhNYXAoaGVhZGVyUm93KXsKICAgIGNvbnN0IG1hcCA9IHt9OwogICAgaGVhZGVyUm93LmZvckVhY2goKG5hbWUsIGlkeCk9PnsKICAgICAgaWYodHlwZW9mIG5hbWUgPT09ICJzdHJpbmciICYmIG5hbWUudHJpbSgpKXsKICAgICAgICBtYXBbbmFtZS50cmltKCldID0gaWR4OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBtYXA7CiAgfQoKICBmdW5jdGlvbiBfX3h0Yk5vcm1hbGl6ZVN5bWJvbChzeW0pewogICAgaWYoIXN5bSkgcmV0dXJuIHsgZnVsbDoiIiwgYmFzZToiIiB9OwogICAgY29uc3QgcyA9IFN0cmluZyhzeW0pLnRyaW0oKTsKICAgIGNvbnN0IHBhcnRzID0gcy5zcGxpdCgiLiIpOwogICAgcmV0dXJuIHsgZnVsbDpzLCBiYXNlOnBhcnRzWzBdIH07CiAgfQoKICBmdW5jdGlvbiBfX3h0YlBhcnNlQ2FzaFNoZWV0KHNoZWV0KXsKICAgIGNvbnN0IG91dCA9IFtdOwogICAgaWYoIXNoZWV0KSByZXR1cm4gb3V0OwogICAgY29uc3QgYXJyYXkgPSBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24oc2hlZXQsIHtoZWFkZXI6MSwgZGVmdmFsOm51bGwsIHJhdzp0cnVlfSk7CiAgICBpZighYXJyYXkgfHwgIWFycmF5Lmxlbmd0aCkgcmV0dXJuIG91dDsKCiAgICBjb25zdCBoZWFkZXJJZHggPSBfX3h0YkRldGVjdEhlYWRlclJvdyhhcnJheSwgWyJJRCIsIlR5cGUiLCJUaW1lIiwiQ29tbWVudCIsIlN5bWJvbCIsIkFtb3VudCJdKTsKICAgIGlmKGhlYWRlcklkeCA9PT0gLTEpIHJldHVybiBvdXQ7CiAgICBjb25zdCBoZWFkZXIgPSBhcnJheVtoZWFkZXJJZHhdOwogICAgY29uc3QgaWR4ID0gX194dGJCdWlsZEluZGV4TWFwKGhlYWRlcik7CgogICAgZm9yKGxldCByPWhlYWRlcklkeCsxO3I8YXJyYXkubGVuZ3RoO3IrKyl7CiAgICAgIGNvbnN0IHJvdyA9IGFycmF5W3JdIHx8IFtdOwogICAgICBjb25zdCBtYXliZVRvdGFsID0gcm93W2lkeFsiSUQiXV07CiAgICAgIGlmKG1heWJlVG90YWwgPT09ICJUb3RhbCIpIGJyZWFrOwoKICAgICAgY29uc3QgdHlwZSA9IHJvd1tpZHhbIlR5cGUiXV07CiAgICAgIGNvbnN0IHRpbWUgPSByb3dbaWR4WyJUaW1lIl1dOwogICAgICBjb25zdCBjb21tZW50ID0gcm93W2lkeFsiQ29tbWVudCJdXTsKICAgICAgY29uc3Qgc3ltYm9sID0gcm93W2lkeFsiU3ltYm9sIl1dOwogICAgICBjb25zdCBhbW91bnQgPSByb3dbaWR4WyJBbW91bnQiXV07CgogICAgICBpZighdHlwZSB8fCAhdGltZSB8fCAhY29tbWVudCB8fCAhc3ltYm9sIHx8IGFtb3VudCA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgIGNvbnN0IHQgPSBTdHJpbmcodHlwZSkudG9VcHBlckNhc2UoKTsKICAgICAgaWYgKHQgIT09ICJTVE9DSyBQVVJDSEFTRSIgJiYgdCAhPT0gIlNUT0NLIFNBTEUiKSBjb250aW51ZTsKCiAgICAgIGNvbnN0IG5vcm0gPSBfX3h0Yk5vcm1hbGl6ZVN5bWJvbChzeW1ib2wpOwoKICAgICAgY29uc3QgbSA9IFN0cmluZyhjb21tZW50KS5tYXRjaCgvKE9QRU58Q0xPU0UpXHMrQlVZXHMrKFswLTkuLF0rKVwvKFswLTkuLF0rKVxzK0BccysoWzAtOS4sXSspL2kpOwogICAgICBpZighbSkgY29udGludWU7CiAgICAgIGNvbnN0IHF0eSA9IF9feHRiUGFyc2VOdW1iZXIobVsyXSk7CiAgICAgIGNvbnN0IHByaWNlID0gX194dGJQYXJzZU51bWJlcihtWzRdKTsKICAgICAgaWYoIXF0eSB8fCAhcHJpY2UpIGNvbnRpbnVlOwoKICAgICAgY29uc3Qgc2lkZSA9ICh0ID09PSAiU1RPQ0sgUFVSQ0hBU0UiKSA/ICJCVVkiIDogIlNFTEwiOwoKICAgICAgb3V0LnB1c2goewogICAgICAgIHN5bWJvbEZ1bGw6IG5vcm0uZnVsbCwKICAgICAgICBzeW1ib2w6IG5vcm0uYmFzZSwKICAgICAgICBzaWRlOiBzaWRlLAogICAgICAgIHF0eTogcXR5LAogICAgICAgIHByaWNlOiBwcmljZSwKICAgICAgICB0aW1lOiBfX3h0YkV4Y2VsRGF0ZVRvSnModGltZSksCiAgICAgICAgc2hlZXQ6ICJDQVNIIiwKICAgICAgICByYXdUeXBlOiB0eXBlLAogICAgICAgIGNvbW1lbnQ6IFN0cmluZyhjb21tZW50fHwiIikKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gb3V0OwogIH0KCiAgZnVuY3Rpb24gX194dGJCdWlsZEFnZ3JlZ2F0ZWQocm93cyl7CiAgICBjb25zdCBhZ2cgPSB7fTsKICAgIHJvd3MuZm9yRWFjaChyID0+IHsKICAgICAgY29uc3QgdGlja2VyID0gKHIuc3ltYm9sIHx8ICIiKS50b1VwcGVyQ2FzZSgpOwogICAgICBpZighdGlja2VyKSByZXR1cm47CiAgICAgIGlmKCFhZ2dbdGlja2VyXSl7CiAgICAgICAgYWdnW3RpY2tlcl0gPSB7CiAgICAgICAgICB0aWNrZXIsCiAgICAgICAgICBzeW1ib2xGdWxsOiByLnN5bWJvbEZ1bGwgfHwgdGlja2VyLAogICAgICAgICAgYnV5czogW10sCiAgICAgICAgICBzZWxsczogW10sCiAgICAgICAgICBidXlUb3RhbFF0eTogMCwKICAgICAgICAgIGJ1eVRvdGFsQ2FzaDogMCwKICAgICAgICAgIGJ1eUZpcnN0RGF0ZTogbnVsbCwKICAgICAgICAgIHNlbGxUb3RhbFF0eTogMCwKICAgICAgICAgIHNlbGxUb3RhbENhc2g6IDAsCiAgICAgICAgICBzZWxsRmlyc3REYXRlOiBudWxsCiAgICAgICAgfTsKICAgICAgfQogICAgICBjb25zdCBlbnRyeSA9IGFnZ1t0aWNrZXJdOwogICAgICBpZihyLnNpZGUgPT09ICJCVVkiKXsKICAgICAgICBlbnRyeS5idXlzLnB1c2gocik7CiAgICAgICAgZW50cnkuYnV5VG90YWxRdHkgKz0gci5xdHk7CiAgICAgICAgZW50cnkuYnV5VG90YWxDYXNoICs9IHIucXR5ICogci5wcmljZTsKICAgICAgICBjb25zdCBkdCA9IHIudGltZSBpbnN0YW5jZW9mIERhdGUgPyByLnRpbWUgOiBfX3h0YkV4Y2VsRGF0ZVRvSnMoci50aW1lKTsKICAgICAgICBpZihkdCAmJiAoIWVudHJ5LmJ1eUZpcnN0RGF0ZSB8fCBkdCA8IGVudHJ5LmJ1eUZpcnN0RGF0ZSkpIGVudHJ5LmJ1eUZpcnN0RGF0ZSA9IGR0OwogICAgICB9ZWxzZSBpZihyLnNpZGUgPT09ICJTRUxMIil7CiAgICAgICAgZW50cnkuc2VsbHMucHVzaChyKTsKICAgICAgICBlbnRyeS5zZWxsVG90YWxRdHkgKz0gci5xdHk7CiAgICAgICAgZW50cnkuc2VsbFRvdGFsQ2FzaCArPSByLnF0eSAqIHIucHJpY2U7CiAgICAgICAgY29uc3QgZHQgPSByLnRpbWUgaW5zdGFuY2VvZiBEYXRlID8gci50aW1lIDogX194dGJFeGNlbERhdGVUb0pzKHIudGltZSk7CiAgICAgICAgaWYoZHQgJiYgKCFlbnRyeS5zZWxsRmlyc3REYXRlIHx8IGR0IDwgZW50cnkuc2VsbEZpcnN0RGF0ZSkpIGVudHJ5LnNlbGxGaXJzdERhdGUgPSBkdDsKICAgICAgfQogICAgfSk7CgogICAgT2JqZWN0LmtleXMoYWdnKS5mb3JFYWNoKHQgPT4gewogICAgICBjb25zdCBlID0gYWdnW3RdOwogICAgICBlLmJ1eUF2Z1ByaWNlID0gZS5idXlUb3RhbFF0eSA+IDAgPyAoZS5idXlUb3RhbENhc2ggLyBlLmJ1eVRvdGFsUXR5KSA6IDA7CiAgICAgIGUuc2VsbEF2Z1ByaWNlID0gZS5zZWxsVG90YWxRdHkgPiAwID8gKGUuc2VsbFRvdGFsQ2FzaCAvIGUuc2VsbFRvdGFsUXR5KSA6IDA7CiAgICB9KTsKICAgIHJldHVybiBhZ2c7CiAgfQoKICBmdW5jdGlvbiBfX3h0YkVuc3VyZUltcG9ydE1vZGFsKCl7CiAgICBpZihfX3h0YkltcG9ydE1vZGFsKSByZXR1cm4gX194dGJJbXBvcnRNb2RhbDsKICAgIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHdyYXAuaWQgPSAieHRiSW1wb3J0TW9kYWwiOwogICAgd3JhcC5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CiAgICB3cmFwLnN0eWxlLmluc2V0ID0gIjAiOwogICAgd3JhcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgd3JhcC5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgICB3cmFwLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gImNlbnRlciI7CiAgICB3cmFwLnN0eWxlLmJhY2tncm91bmQgPSAicmdiYSgxNSwyMyw0MiwwLjgpIjsKICAgIHdyYXAuc3R5bGUuekluZGV4ID0gIjk5OTkiOwoKICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGNhcmQuc3R5bGUuYmFja2dyb3VuZCA9ICIjMDIwNjE3IjsKICAgIGNhcmQuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjEycHgiOwogICAgY2FyZC5zdHlsZS5ib3JkZXIgPSAiMXB4IHNvbGlkIHJnYmEoMTQ4LDE2MywxODQsMC42KSI7CiAgICBjYXJkLnN0eWxlLnBhZGRpbmcgPSAiMTJweCAxNHB4IjsKICAgIGNhcmQuc3R5bGUubWF4V2lkdGggPSAiNzgwcHgiOwogICAgY2FyZC5zdHlsZS53aWR0aCA9ICIxMDAlIjsKICAgIGNhcmQuc3R5bGUubWF4SGVpZ2h0ID0gIjgwdmgiOwogICAgY2FyZC5zdHlsZS5ib3hTaGFkb3cgPSAiMCAyMnB4IDYwcHggcmdiYSgxNSwyMyw0MiwwLjkpIjsKICAgIGNhcmQuc3R5bGUuZm9udFNpemUgPSAiMTJweCI7CiAgICBjYXJkLnN0eWxlLmNvbG9yID0gIiNlNWU3ZWIiOwogICAgY2FyZC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgY2FyZC5zdHlsZS5mbGV4RGlyZWN0aW9uID0gImNvbHVtbiI7CiAgICBjYXJkLnN0eWxlLmdhcCA9ICI4cHgiOwoKICAgIGNvbnN0IHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0aXRsZS5pZCA9ICJ4dGJJbXBvcnRUaXRsZSI7CiAgICB0aXRsZS5zdHlsZS5mb250V2VpZ2h0ID0gIjYwMCI7CiAgICB0aXRsZS5zdHlsZS5mb250U2l6ZSA9ICIxM3B4IjsKICAgIGNhcmQuYXBwZW5kQ2hpbGQodGl0bGUpOwoKICAgIGNvbnN0IGRlc2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRlc2MudGV4dENvbnRlbnQgPSAiV3liaWVyeiwga3TDs3JlIHNww7PFgmtpIHogcGxpa3UgWFRCIGNoY2VzeiB6YWltcG9ydG93YcSHLiBCVVkgem9zdGFuxIUgZG9kYW5lIGpha28gbm93ZSB6YWt1cHksIFNFTEwgbW/FvGVzeiBwb3dpxIV6YcSHIHogd3licmFueW1pIHBhcnRpYW1pLiI7CiAgICBkZXNjLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgZGVzYy5zdHlsZS5jb2xvciA9ICIjOTRhM2I4IjsKICAgIGNhcmQuYXBwZW5kQ2hpbGQoZGVzYyk7CgogICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgYm9keS5pZCA9ICJ4dGJJbXBvcnRCb2R5IjsKICAgIGJvZHkuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgIGJvZHkuc3R5bGUuZmxleERpcmVjdGlvbiA9ICJjb2x1bW4iOwogICAgYm9keS5zdHlsZS5nYXAgPSAiNnB4IjsKICAgIGJvZHkuc3R5bGUub3ZlcmZsb3cgPSAiYXV0byI7CiAgICBib2R5LnN0eWxlLnBhZGRpbmcgPSAiNHB4IDAiOwogICAgY2FyZC5hcHBlbmRDaGlsZChib2R5KTsKCiAgICBjb25zdCBmb290ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGZvb3Rlci5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgZm9vdGVyLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gImZsZXgtZW5kIjsKICAgIGZvb3Rlci5zdHlsZS5nYXAgPSAiOHB4IjsKICAgIGZvb3Rlci5zdHlsZS5tYXJnaW5Ub3AgPSAiNnB4IjsKCiAgICBjb25zdCBjYW5jZWxCdG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgIGNhbmNlbEJ0bi50eXBlID0gImJ1dHRvbiI7CiAgICBjYW5jZWxCdG4udGV4dENvbnRlbnQgPSAiQW51bHVqIjsKICAgIGNhbmNlbEJ0bi5zdHlsZS5wYWRkaW5nID0gIjRweCAxMHB4IjsKICAgIGNhbmNlbEJ0bi5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiOTk5cHgiOwogICAgY2FuY2VsQnRuLnN0eWxlLmJvcmRlciA9ICIxcHggc29saWQgcmdiYSgxNDgsMTYzLDE4NCwwLjYpIjsKICAgIGNhbmNlbEJ0bi5zdHlsZS5iYWNrZ3JvdW5kID0gInRyYW5zcGFyZW50IjsKICAgIGNhbmNlbEJ0bi5zdHlsZS5jb2xvciA9ICIjZTVlN2ViIjsKICAgIGNhbmNlbEJ0bi5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgIGNhbmNlbEJ0bi5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICBjYW5jZWxCdG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbigpewogICAgICB3cmFwLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIF9feHRiQWdncmVnYXRlZCA9IG51bGw7CiAgICAgIF9feHRiSW1wb3J0UG9ydGZvbGlvSWQgPSBudWxsOwogICAgfSk7CgogICAgY29uc3QgaW1wb3J0QnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBpbXBvcnRCdG4udHlwZSA9ICJidXR0b24iOwogICAgaW1wb3J0QnRuLmlkID0gInh0YkltcG9ydENvbmZpcm0iOwogICAgaW1wb3J0QnRuLnRleHRDb250ZW50ID0gIkltcG9ydHVqIHphem5hY3pvbmUiOwogICAgaW1wb3J0QnRuLnN0eWxlLnBhZGRpbmcgPSAiNHB4IDEwcHgiOwogICAgaW1wb3J0QnRuLnN0eWxlLmJvcmRlclJhZGl1cyA9ICI5OTlweCI7CiAgICBpbXBvcnRCdG4uc3R5bGUuYm9yZGVyID0gIm5vbmUiOwogICAgaW1wb3J0QnRuLnN0eWxlLmJhY2tncm91bmQgPSAiIzIyYzU1ZSI7CiAgICBpbXBvcnRCdG4uc3R5bGUuY29sb3IgPSAiIzAyMDYxNyI7CiAgICBpbXBvcnRCdG4uc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CiAgICBpbXBvcnRCdG4uc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgaW1wb3J0QnRuLnN0eWxlLmZvbnRXZWlnaHQgPSAiNjAwIjsKCiAgICBmb290ZXIuYXBwZW5kQ2hpbGQoY2FuY2VsQnRuKTsKICAgIGZvb3Rlci5hcHBlbmRDaGlsZChpbXBvcnRCdG4pOwogICAgY2FyZC5hcHBlbmRDaGlsZChmb290ZXIpOwoKICAgIHdyYXAuYXBwZW5kQ2hpbGQoY2FyZCk7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHdyYXApOwoKICAgIGltcG9ydEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIF9feHRiUGVyZm9ybUltcG9ydCk7CgogICAgX194dGJJbXBvcnRNb2RhbCA9IHdyYXA7CiAgICByZXR1cm4gd3JhcDsKICB9CgogIGZ1bmN0aW9uIF9feHRiRm9ybWF0RGF0ZShkKXsKICAgIGlmKCEoZCBpbnN0YW5jZW9mIERhdGUpKSByZXR1cm4gIiI7CiAgICBjb25zdCB5ID0gZC5nZXRGdWxsWWVhcigpOwogICAgY29uc3QgbSA9IFN0cmluZyhkLmdldE1vbnRoKCkrMSkucGFkU3RhcnQoMiwiMCIpOwogICAgY29uc3QgZGEgPSBTdHJpbmcoZC5nZXREYXRlKCkpLnBhZFN0YXJ0KDIsIjAiKTsKICAgIHJldHVybiB5ICsgIi0iICsgbSArICItIiArIGRhOwogIH0KCiAgZnVuY3Rpb24gX194dGJSZW5kZXJJbXBvcnRNb2RhbChwZklkLCBhZ2dyZWdhdGVkKXsKICAgIGNvbnN0IHBmID0gZ2V0UGYocGZJZCk7CiAgICBjb25zdCBtb2RhbCA9IF9feHRiRW5zdXJlSW1wb3J0TW9kYWwoKTsKICAgIGNvbnN0IHRpdGxlID0gbW9kYWwucXVlcnlTZWxlY3RvcigiI3h0YkltcG9ydFRpdGxlIik7CiAgICBjb25zdCBib2R5ID0gbW9kYWwucXVlcnlTZWxlY3RvcigiI3h0YkltcG9ydEJvZHkiKTsKICAgIGlmKHRpdGxlKSB0aXRsZS50ZXh0Q29udGVudCA9ICJJbXBvcnQgeiBYVEIgZG8gcG9ydGZlbGE6ICIgKyAocGYgJiYgcGYubmFtZSA/IHBmLm5hbWUgOiBwZklkKTsKICAgIGJvZHkuaW5uZXJIVE1MID0gIiI7CgogICAgY29uc3QgdGlja2VycyA9IE9iamVjdC5rZXlzKGFnZ3JlZ2F0ZWQpLnNvcnQoKTsKICAgIGlmKCF0aWNrZXJzLmxlbmd0aCl7CiAgICAgIGNvbnN0IGluZm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgaW5mby50ZXh0Q29udGVudCA9ICJCcmFrIHRyYW5zYWtjamkgQlVZL1NFTEwgZG8gemFpbXBvcnRvd2FuaWEuIjsKICAgICAgaW5mby5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgICAgaW5mby5zdHlsZS5jb2xvciA9ICIjOTRhM2I4IjsKICAgICAgYm9keS5hcHBlbmRDaGlsZChpbmZvKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRpY2tlcnMuZm9yRWFjaCh0aWNrZXIgPT4gewogICAgICBjb25zdCBlbnRyeSA9IGFnZ3JlZ2F0ZWRbdGlja2VyXTsKICAgICAgY29uc3Qgcm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHJvdy5jbGFzc05hbWUgPSAieHRiLWltcG9ydC1yb3ciOwogICAgICByb3cuZGF0YXNldC50aWNrZXIgPSB0aWNrZXI7CiAgICAgIHJvdy5zdHlsZS5ib3JkZXIgPSAiMXB4IHNvbGlkIHJnYmEoNTEsNjUsODUsMC45KSI7CiAgICAgIHJvdy5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiOHB4IjsKICAgICAgcm93LnN0eWxlLnBhZGRpbmcgPSAiNnB4IDhweCI7CiAgICAgIHJvdy5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgICByb3cuc3R5bGUuZmxleERpcmVjdGlvbiA9ICJjb2x1bW4iOwogICAgICByb3cuc3R5bGUuZ2FwID0gIjRweCI7CiAgICAgIHJvdy5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYmEoMTUsMjMsNDIsMC43KSI7CgogICAgICBjb25zdCBoZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgaGVhZGVyLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgIGhlYWRlci5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICJzcGFjZS1iZXR3ZWVuIjsKICAgICAgaGVhZGVyLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKCiAgICAgIGNvbnN0IHRpdGxlRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHRpdGxlRGl2LnRleHRDb250ZW50ID0gKGVudHJ5LnN5bWJvbEZ1bGwgfHwgdGlja2VyKTsKICAgICAgdGl0bGVEaXYuc3R5bGUuZm9udFdlaWdodCA9ICI2MDAiOwogICAgICB0aXRsZURpdi5zdHlsZS5mb250U2l6ZSA9ICIxMnB4IjsKCiAgICAgIGhlYWRlci5hcHBlbmRDaGlsZCh0aXRsZURpdik7CiAgICAgIHJvdy5hcHBlbmRDaGlsZChoZWFkZXIpOwoKICAgICAgY29uc3QgY29scyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBjb2xzLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgIGNvbHMuc3R5bGUuZ2FwID0gIjhweCI7CiAgICAgIGNvbHMuc3R5bGUuZmxleFdyYXAgPSAid3JhcCI7CgogICAgICAvLyBCVVkgY29sdW1uCiAgICAgIGNvbnN0IGJ1eUNvbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBidXlDb2wuc3R5bGUuZmxleCA9ICIxIDEgMjYwcHgiOwogICAgICBidXlDb2wuc3R5bGUubWluV2lkdGggPSAiMCI7CgogICAgICBpZihlbnRyeS5idXlUb3RhbFF0eSA+IDApewogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICAgICAgbGJsLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgICAgbGJsLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgICAgICBsYmwuc3R5bGUuZ2FwID0gIjRweCI7CiAgICAgICAgY29uc3QgY2IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgIGNiLnR5cGUgPSAiY2hlY2tib3giOwogICAgICAgIGNiLmNsYXNzTmFtZSA9ICJ4dGItaW1wb3J0LWJ1eS1jaGVja2JveCI7CiAgICAgICAgY2IuY2hlY2tlZCA9IHRydWU7CiAgICAgICAgbGJsLmFwcGVuZENoaWxkKGNiKTsKCiAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgICBzcGFuLnRleHRDb250ZW50ID0gIlphaW1wb3J0dWogQlVZIjsKICAgICAgICBsYmwuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgYnV5Q29sLmFwcGVuZENoaWxkKGxibCk7CgogICAgICAgIGNvbnN0IGluZm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBpbmZvLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgICAgIGluZm8uc3R5bGUuY29sb3IgPSAiI2NiZDVmNSI7CiAgICAgICAgY29uc3QgYXZnID0gZW50cnkuYnV5QXZnUHJpY2UgfHwgMDsKICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gIlF0eTogIiArIGVudHJ5LmJ1eVRvdGFsUXR5LnRvRml4ZWQoNCkgKyAiIHwgxZpyLiBjZW5hOiAiICsgYXZnLnRvRml4ZWQoNCkgKyAiIHwgVHJhbnNha2NqaTogIiArIGVudHJ5LmJ1eXMubGVuZ3RoICsgKGVudHJ5LmJ1eUZpcnN0RGF0ZSA/ICIgfCBvZDogIiArIF9feHRiRm9ybWF0RGF0ZShlbnRyeS5idXlGaXJzdERhdGUpIDogIiIpOwogICAgICAgIGJ1eUNvbC5hcHBlbmRDaGlsZChpbmZvKTsKICAgICAgfWVsc2V7CiAgICAgICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGluZm8uc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CiAgICAgICAgaW5mby5zdHlsZS5jb2xvciA9ICIjNjQ3NDhiIjsKICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gIkJyYWsgdHJhbnNha2NqaSBCVVkgZGxhIHRlaiBzcMOzxYJraSB3IHBsaWt1LiI7CiAgICAgICAgYnV5Q29sLmFwcGVuZENoaWxkKGluZm8pOwogICAgICB9CgogICAgICAvLyBTRUxMIGNvbHVtbgogICAgICBjb25zdCBzZWxsQ29sID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHNlbGxDb2wuc3R5bGUuZmxleCA9ICIxIDEgMjYwcHgiOwogICAgICBzZWxsQ29sLnN0eWxlLm1pbldpZHRoID0gIjAiOwoKICAgICAgaWYoZW50cnkuc2VsbFRvdGFsUXR5ID4gMCl7CiAgICAgICAgY29uc3QgdG9wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgdG9wLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgICAgdG9wLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgICAgICB0b3Auc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAic3BhY2UtYmV0d2VlbiI7CiAgICAgICAgdG9wLnN0eWxlLmdhcCA9ICI0cHgiOwoKICAgICAgICBjb25zdCBsYmwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICAgIGxibC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgICAgIGxibC5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgICAgICAgbGJsLnN0eWxlLmdhcCA9ICI0cHgiOwogICAgICAgIGNvbnN0IGNiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICBjYi50eXBlID0gImNoZWNrYm94IjsKICAgICAgICBjYi5jbGFzc05hbWUgPSAieHRiLWltcG9ydC1zZWxsLWNoZWNrYm94IjsKICAgICAgICBjYi5jaGVja2VkID0gdHJ1ZTsKICAgICAgICBsYmwuYXBwZW5kQ2hpbGQoY2IpOwogICAgICAgIGNvbnN0IHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgICAgc3Bhbi50ZXh0Q29udGVudCA9ICJaYWltcG9ydHVqIFNFTEwiOwogICAgICAgIGxibC5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICB0b3AuYXBwZW5kQ2hpbGQobGJsKTsKCiAgICAgICAgY29uc3QgbG90c0J0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgICAgIGxvdHNCdG4udHlwZSA9ICJidXR0b24iOwogICAgICAgIGxvdHNCdG4udGV4dENvbnRlbnQgPSAiUG9rYcW8IHBhcnRpZSI7CiAgICAgICAgbG90c0J0bi5jbGFzc05hbWUgPSAieHRiLXNlbGwtbG90cy10b2dnbGUiOwogICAgICAgIGxvdHNCdG4uZGF0YXNldC50aWNrZXIgPSB0aWNrZXI7CiAgICAgICAgbG90c0J0bi5zdHlsZS5wYWRkaW5nID0gIjJweCA4cHgiOwogICAgICAgIGxvdHNCdG4uc3R5bGUuYm9yZGVyUmFkaXVzID0gIjk5OXB4IjsKICAgICAgICBsb3RzQnRuLnN0eWxlLmJvcmRlciA9ICIxcHggc29saWQgcmdiYSgxNDgsMTYzLDE4NCwwLjcpIjsKICAgICAgICBsb3RzQnRuLnN0eWxlLmJhY2tncm91bmQgPSAidHJhbnNwYXJlbnQiOwogICAgICAgIGxvdHNCdG4uc3R5bGUuY29sb3IgPSAiI2U1ZTdlYiI7CiAgICAgICAgbG90c0J0bi5zdHlsZS5mb250U2l6ZSA9ICIxMHB4IjsKICAgICAgICBsb3RzQnRuLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICB0b3AuYXBwZW5kQ2hpbGQobG90c0J0bik7CgogICAgICAgIHNlbGxDb2wuYXBwZW5kQ2hpbGQodG9wKTsKCiAgICAgICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGluZm8uc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CiAgICAgICAgaW5mby5zdHlsZS5jb2xvciA9ICIjZmVjYWNhIjsKICAgICAgICBjb25zdCBhdmcgPSBlbnRyeS5zZWxsQXZnUHJpY2UgfHwgMDsKICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gIlF0eSAoWFRCKTogIiArIGVudHJ5LnNlbGxUb3RhbFF0eS50b0ZpeGVkKDQpICsgIiB8IMWaci4gY2VuYSBTRUxMOiAiICsgYXZnLnRvRml4ZWQoNCkgKyAiIHwgVHJhbnNha2NqaTogIiArIGVudHJ5LnNlbGxzLmxlbmd0aCArIChlbnRyeS5zZWxsRmlyc3REYXRlID8gIiB8IG9kOiAiICsgX194dGJGb3JtYXREYXRlKGVudHJ5LnNlbGxGaXJzdERhdGUpIDogIiIpOwogICAgICAgIHNlbGxDb2wuYXBwZW5kQ2hpbGQoaW5mbyk7CgogICAgICAgIGNvbnN0IGxvdHNXcmFwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgbG90c1dyYXAuY2xhc3NOYW1lID0gInh0Yi1zZWxsLWxvdHMiOwogICAgICAgIGxvdHNXcmFwLmRhdGFzZXQudGlja2VyID0gdGlja2VyOwogICAgICAgIGxvdHNXcmFwLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgbG90c1dyYXAuc3R5bGUubWFyZ2luVG9wID0gIjRweCI7CiAgICAgICAgbG90c1dyYXAuc3R5bGUuYm9yZGVyVG9wID0gIjFweCBzb2xpZCByZ2JhKDUxLDY1LDg1LDAuOSkiOwogICAgICAgIGxvdHNXcmFwLnN0eWxlLnBhZGRpbmdUb3AgPSAiNHB4IjsKCiAgICAgICAgY29uc3QgcGZIb2xkID0gcGYgJiYgcGYuaG9sZGluZ3MgJiYgcGYuaG9sZGluZ3NbdGlja2VyXSA/IHBmLmhvbGRpbmdzW3RpY2tlcl0gOiBudWxsOwogICAgICAgIGNvbnN0IGxvdHMgPSBwZkhvbGQgJiYgQXJyYXkuaXNBcnJheShwZkhvbGQubG90cykgPyBwZkhvbGQubG90cyA6IFtdOwoKICAgICAgICBpZihsb3RzLmxlbmd0aCl7CiAgICAgICAgICBjb25zdCB0YmwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0YWJsZSIpOwogICAgICAgICAgdGJsLnN0eWxlLndpZHRoID0gIjEwMCUiOwogICAgICAgICAgdGJsLnN0eWxlLmJvcmRlckNvbGxhcHNlID0gImNvbGxhcHNlIjsKICAgICAgICAgIGNvbnN0IHRoZWFkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGhlYWQiKTsKICAgICAgICAgIGNvbnN0IGhyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidHIiKTsKICAgICAgICAgIFsiIiwgIkRhdGEiLCAiUXR5IiwgIkNlbmEgemFrdXB1Il0uZm9yRWFjaCh0eHQgPT4gewogICAgICAgICAgICBjb25zdCB0aCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRoIik7CiAgICAgICAgICAgIHRoLnRleHRDb250ZW50ID0gdHh0OwogICAgICAgICAgICB0aC5zdHlsZS5mb250U2l6ZSA9ICIxMHB4IjsKICAgICAgICAgICAgdGguc3R5bGUuZm9udFdlaWdodCA9ICI1MDAiOwogICAgICAgICAgICB0aC5zdHlsZS50ZXh0QWxpZ24gPSAibGVmdCI7CiAgICAgICAgICAgIHRoLnN0eWxlLnBhZGRpbmcgPSAiMnB4IDRweCI7CiAgICAgICAgICAgIHRoLnN0eWxlLmNvbG9yID0gIiM5NGEzYjgiOwogICAgICAgICAgICBoci5hcHBlbmRDaGlsZCh0aCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoZWFkLmFwcGVuZENoaWxkKGhyKTsKICAgICAgICAgIHRibC5hcHBlbmRDaGlsZCh0aGVhZCk7CgogICAgICAgICAgY29uc3QgdGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpOwogICAgICAgICAgbG90cy5mb3JFYWNoKGxvdCA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidHIiKTsKICAgICAgICAgICAgdHIuc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CgogICAgICAgICAgICBjb25zdCB0ZENiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGQiKTsKICAgICAgICAgICAgdGRDYi5zdHlsZS5wYWRkaW5nID0gIjJweCA0cHgiOwogICAgICAgICAgICBjb25zdCBjYkxvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgIGNiTG90LnR5cGUgPSAiY2hlY2tib3giOwogICAgICAgICAgICBjYkxvdC5jbGFzc05hbWUgPSAieHRiLXNlbGwtbG90LWNoZWNrYm94IjsKICAgICAgICAgICAgY2JMb3QuZGF0YXNldC50aWNrZXIgPSB0aWNrZXI7CiAgICAgICAgICAgIGNiTG90LmRhdGFzZXQubG90aWQgPSBsb3QubG90SWQ7CiAgICAgICAgICAgIGNiTG90LmRhdGFzZXQucXR5ID0gTnVtYmVyKGxvdC5xdHl8fDApOwogICAgICAgICAgICB0ZENiLmFwcGVuZENoaWxkKGNiTG90KTsKICAgICAgICAgICAgdHIuYXBwZW5kQ2hpbGQodGRDYik7CgogICAgICAgICAgICBjb25zdCB0ZERhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZCIpOwogICAgICAgICAgICB0ZERhdGUuc3R5bGUucGFkZGluZyA9ICIycHggNHB4IjsKICAgICAgICAgICAgdGREYXRlLnRleHRDb250ZW50ID0gbG90LmRhdGUgfHwgIiI7CiAgICAgICAgICAgIHRyLmFwcGVuZENoaWxkKHRkRGF0ZSk7CgogICAgICAgICAgICBjb25zdCB0ZFF0eSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgICAgICAgICAgIHRkUXR5LnN0eWxlLnBhZGRpbmcgPSAiMnB4IDRweCI7CiAgICAgICAgICAgIHRkUXR5LnRleHRDb250ZW50ID0gKE51bWJlcihsb3QucXR5KXx8MCkudG9GaXhlZCg0KTsKICAgICAgICAgICAgdHIuYXBwZW5kQ2hpbGQodGRRdHkpOwoKICAgICAgICAgICAgY29uc3QgdGRQcmljZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgICAgICAgICAgIHRkUHJpY2Uuc3R5bGUucGFkZGluZyA9ICIycHggNHB4IjsKICAgICAgICAgICAgdGRQcmljZS50ZXh0Q29udGVudCA9IChOdW1iZXIobG90LnVuaXRDb3N0KXx8MCkudG9GaXhlZCg0KTsKICAgICAgICAgICAgdHIuYXBwZW5kQ2hpbGQodGRQcmljZSk7CgogICAgICAgICAgICB0Yi5hcHBlbmRDaGlsZCh0cik7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRibC5hcHBlbmRDaGlsZCh0Yik7CiAgICAgICAgICBsb3RzV3JhcC5hcHBlbmRDaGlsZCh0YmwpOwogICAgICAgIH1lbHNlewogICAgICAgICAgY29uc3Qgbm9Mb3RzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICBub0xvdHMudGV4dENvbnRlbnQgPSAiQnJhayBvdHdhcnR5Y2ggcGFydGlpIG5hIHRlbiB0aWNrZXIgdyBwb3J0ZmVsdS4iOwogICAgICAgICAgbm9Mb3RzLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgICAgICAgbm9Mb3RzLnN0eWxlLmNvbG9yID0gIiNmOTczNzMiOwogICAgICAgICAgbG90c1dyYXAuYXBwZW5kQ2hpbGQobm9Mb3RzKTsKICAgICAgICB9CgogICAgICAgIHNlbGxDb2wuYXBwZW5kQ2hpbGQobG90c1dyYXApOwogICAgICB9ZWxzZXsKICAgICAgICBjb25zdCBpbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgaW5mby5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgICAgICBpbmZvLnN0eWxlLmNvbG9yID0gIiM2NDc0OGIiOwogICAgICAgIGluZm8udGV4dENvbnRlbnQgPSAiQnJhayB0cmFuc2FrY2ppIFNFTEwgZGxhIHRlaiBzcMOzxYJraSB3IHBsaWt1LiI7CiAgICAgICAgc2VsbENvbC5hcHBlbmRDaGlsZChpbmZvKTsKICAgICAgfQoKICAgICAgY29scy5hcHBlbmRDaGlsZChidXlDb2wpOwogICAgICBjb2xzLmFwcGVuZENoaWxkKHNlbGxDb2wpOwogICAgICByb3cuYXBwZW5kQ2hpbGQoY29scyk7CiAgICAgIGJvZHkuYXBwZW5kQ2hpbGQocm93KTsKICAgIH0pOwoKICAgIC8vIHRvZ2dsZSBidXR0b25zCiAgICBjb25zdCB0b2dnbGVzID0gbW9kYWwucXVlcnlTZWxlY3RvckFsbCgiLnh0Yi1zZWxsLWxvdHMtdG9nZ2xlIik7CiAgICB0b2dnbGVzLmZvckVhY2goYnRuID0+IHsKICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24oKXsKICAgICAgICBjb25zdCB0ID0gYnRuLmRhdGFzZXQudGlja2VyOwogICAgICAgIGNvbnN0IHdyYXAgPSBtb2RhbC5xdWVyeVNlbGVjdG9yKCIueHRiLXNlbGwtbG90c1tkYXRhLXRpY2tlcj0nIit0KyInXSIpOwogICAgICAgIGlmKCF3cmFwKSByZXR1cm47CiAgICAgICAgd3JhcC5zdHlsZS5kaXNwbGF5ID0gd3JhcC5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gX194dGJQZXJmb3JtSW1wb3J0KCl7CiAgICBjb25zdCBwZklkID0gX194dGJJbXBvcnRQb3J0Zm9saW9JZDsKICAgIGlmKCFwZklkIHx8ICFfX3h0YkFnZ3JlZ2F0ZWQpewogICAgICBhbGVydCgiQnJhayBkYW55Y2ggaW1wb3J0dSBYVEIuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHBmID0gZ2V0UGYocGZJZCk7CiAgICBpZighcGYpewogICAgICBhbGVydCgiUG9ydGZlbCBuaWUgaXN0bmllamUuIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25zdCBtb2RhbCA9IF9feHRiSW1wb3J0TW9kYWwgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInh0YkltcG9ydE1vZGFsIik7CiAgICBjb25zdCBib2R5ID0gbW9kYWwgPyBtb2RhbC5xdWVyeVNlbGVjdG9yKCIjeHRiSW1wb3J0Qm9keSIpIDogbnVsbDsKCiAgICBsZXQgYnV5c0ltcG9ydGVkID0gMDsKICAgIGxldCBzZWxsc0ltcG9ydGVkID0gMDsKICAgIGxldCBza2lwcGVkID0gMDsKCiAgICBmdW5jdGlvbiB0b0RhdGVTdHIoZCl7CiAgICAgIGNvbnN0IHggPSBkIGluc3RhbmNlb2YgRGF0ZSA/IGQgOiBfX3h0YkV4Y2VsRGF0ZVRvSnMoZCk7CiAgICAgIGlmKCEoeCBpbnN0YW5jZW9mIERhdGUpKSByZXR1cm4gdG9kYXkoKTsKICAgICAgY29uc3QgeSA9IHguZ2V0RnVsbFllYXIoKTsKICAgICAgY29uc3QgbSA9IFN0cmluZyh4LmdldE1vbnRoKCkrMSkucGFkU3RhcnQoMiwiMCIpOwogICAgICBjb25zdCBkYSA9IFN0cmluZyh4LmdldERhdGUoKSkucGFkU3RhcnQoMiwiMCIpOwogICAgICByZXR1cm4geSsiLSIrbSsiLSIrZGE7CiAgICB9CgogICAgY29uc3QgdGlja2VycyA9IE9iamVjdC5rZXlzKF9feHRiQWdncmVnYXRlZCk7CiAgICB0aWNrZXJzLmZvckVhY2godGlja2VyID0+IHsKICAgICAgY29uc3QgZW50cnkgPSBfX3h0YkFnZ3JlZ2F0ZWRbdGlja2VyXTsKICAgICAgY29uc3Qgcm93RWwgPSBib2R5ID8gYm9keS5xdWVyeVNlbGVjdG9yKCIueHRiLWltcG9ydC1yb3dbZGF0YS10aWNrZXI9JyIrdGlja2VyKyInXSIpIDogbnVsbDsKICAgICAgaWYoIXJvd0VsKSByZXR1cm47CgogICAgICBjb25zdCBidXlDYiA9IHJvd0VsLnF1ZXJ5U2VsZWN0b3IoIi54dGItaW1wb3J0LWJ1eS1jaGVja2JveCIpOwogICAgICBjb25zdCBzZWxsQ2IgPSByb3dFbC5xdWVyeVNlbGVjdG9yKCIueHRiLWltcG9ydC1zZWxsLWNoZWNrYm94Iik7CgogICAgICAvLyBCVVkgaW1wb3J0CiAgICAgIGlmKGJ1eUNiICYmIGJ1eUNiLmNoZWNrZWQgJiYgZW50cnkuYnV5VG90YWxRdHkgPiAwKXsKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBkYXRlU3RyID0gZW50cnkuYnV5Rmlyc3REYXRlID8gdG9EYXRlU3RyKGVudHJ5LmJ1eUZpcnN0RGF0ZSkgOiB0b2RheSgpOwogICAgICAgICAgY29uc3QgcXR5ID0gZW50cnkuYnV5VG90YWxRdHk7CiAgICAgICAgICBjb25zdCBwcmljZSA9IGVudHJ5LmJ1eUF2Z1ByaWNlIHx8IDA7CiAgICAgICAgICBidXkocGZJZCwgewogICAgICAgICAgICB0aWNrZXIsCiAgICAgICAgICAgIGRhdGU6IGRhdGVTdHIsCiAgICAgICAgICAgIHF0eTogcXR5LAogICAgICAgICAgICBwcmljZTogcHJpY2UsCiAgICAgICAgICAgIGZlZXM6IDAsCiAgICAgICAgICAgIG5vdGU6ICJJbXBvcnQgWFRCIEJVWSAoIiArIGVudHJ5LmJ1eXMubGVuZ3RoICsgIiB0cmFucy4pIiwKICAgICAgICAgICAgdGFyZ2V0UGN0OiBudWxsLAogICAgICAgICAgICB0YXJnZXRQcmljZTogbnVsbCwKICAgICAgICAgICAgYnV5VGFyZ2V0UGN0OiBudWxsLAogICAgICAgICAgICBidXlUYXJnZXRQcmljZTogbnVsbAogICAgICAgICAgfSk7CiAgICAgICAgICBidXlzSW1wb3J0ZWQrKzsKICAgICAgICB9Y2F0Y2goZXJyKXsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlhUQiBpbXBvcnQgQlVZIGVycm9yIiwgZXJyKTsKICAgICAgICAgIHNraXBwZWQrKzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNFTEwgaW1wb3J0CiAgICAgIGlmKHNlbGxDYiAmJiBzZWxsQ2IuY2hlY2tlZCAmJiBlbnRyeS5zZWxsVG90YWxRdHkgPiAwKXsKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBsb3RDYnMgPSByb3dFbC5xdWVyeVNlbGVjdG9yQWxsKCIueHRiLXNlbGwtbG90LWNoZWNrYm94Iik7CiAgICAgICAgICBjb25zdCBzZWxlY3RlZCA9IFtdOwogICAgICAgICAgbG90Q2JzLmZvckVhY2goY2IgPT4gewogICAgICAgICAgICBpZihjYi5jaGVja2VkKXsKICAgICAgICAgICAgICBzZWxlY3RlZC5wdXNoKHsKICAgICAgICAgICAgICAgIGxvdElkOiBjYi5kYXRhc2V0LmxvdGlkLAogICAgICAgICAgICAgICAgcXR5OiBOdW1iZXIoY2IuZGF0YXNldC5xdHkpfHwwCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgaWYoIXNlbGVjdGVkLmxlbmd0aCl7CiAgICAgICAgICAgIHNraXBwZWQrKzsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgdG90YWxYdGJRdHkgPSBlbnRyeS5zZWxsVG90YWxRdHkgfHwgMDsKICAgICAgICAgIGlmKHRvdGFsWHRiUXR5IDw9IDApewogICAgICAgICAgICBza2lwcGVkKys7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGxldCByZW1haW5pbmcgPSB0b3RhbFh0YlF0eTsKICAgICAgICAgIGNvbnN0IGFsbG9jYXRpb25zID0gW107CiAgICAgICAgICAvLyBBbG9rdWplbXkgY3rEmcWbY2lvd28geiB6YXpuYWN6b255Y2ggcGFydGlpIGHFvCBkbyB3eWN6ZXJwYW5pYSBpbG/Fm2NpIFhUQgogICAgICAgICAgc2VsZWN0ZWQuZm9yRWFjaChzID0+IHsKICAgICAgICAgICAgaWYocmVtYWluaW5nIDw9IDApIHJldHVybjsKICAgICAgICAgICAgY29uc3QgbG90UXR5ID0gTnVtYmVyKHMucXR5KSB8fCAwOwogICAgICAgICAgICBpZihsb3RRdHkgPD0gMCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCB1c2VRdHkgPSBNYXRoLm1pbihsb3RRdHksIHJlbWFpbmluZyk7CiAgICAgICAgICAgIGlmKHVzZVF0eSA+IDApewogICAgICAgICAgICAgIGFsbG9jYXRpb25zLnB1c2goeyBsb3RJZDogcy5sb3RJZCwgcXR5OiB1c2VRdHkgfSk7CiAgICAgICAgICAgICAgcmVtYWluaW5nIC09IHVzZVF0eTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBpZighYWxsb2NhdGlvbnMubGVuZ3RoKXsKICAgICAgICAgICAgc2tpcHBlZCsrOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBzZWxsUHJpY2UgPSBlbnRyeS5zZWxsQXZnUHJpY2UgfHwgMDsKICAgICAgICAgIGNvbnN0IHNlbGxEYXRlU3RyID0gZW50cnkuc2VsbEZpcnN0RGF0ZSA/IHRvRGF0ZVN0cihlbnRyeS5zZWxsRmlyc3REYXRlKSA6IHRvZGF5KCk7CiAgICAgICAgICBzZWxsKHBmSWQsIHsKICAgICAgICAgICAgdGlja2VyLAogICAgICAgICAgICBkYXRlOiBzZWxsRGF0ZVN0ciwKICAgICAgICAgICAgc2VsbFByaWNlOiBzZWxsUHJpY2UsCiAgICAgICAgICAgIGZlZXM6IDAsCiAgICAgICAgICAgIGFsbG9jYXRpb25zOiBhbGxvY2F0aW9ucywKICAgICAgICAgICAgbm90ZTogIkltcG9ydCBYVEIgU0VMTCAoemF6bmFjem9uZSBwYXJ0aWUsICIgKyBlbnRyeS5zZWxscy5sZW5ndGggKyAiIHRyYW5zLikiCiAgICAgICAgICB9KTsKICAgICAgICAgIHNlbGxzSW1wb3J0ZWQrKzsKICAgICAgICB9Y2F0Y2goZXJyKXsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlhUQiBpbXBvcnQgU0VMTCBlcnJvciIsIGVycik7CiAgICAgICAgICBza2lwcGVkKys7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCgogICAgaWYobW9kYWwpIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBfX3h0YkltcG9ydFBvcnRmb2xpb0lkID0gbnVsbDsKICAgIF9feHRiQWdncmVnYXRlZCA9IG51bGw7CgogICAgYWxlcnQoCiAgICAgICJJbXBvcnQgWFRCIHpha2/FhGN6b255LlxcbiIgKwogICAgICAiQlVZIGRvZGFuZTogIiArIGJ1eXNJbXBvcnRlZCArICJcXG4iICsKICAgICAgIlNFTEwgd3lrb25hbmU6ICIgKyBzZWxsc0ltcG9ydGVkICsgIlxcbiIgKwogICAgICAiUG9taW5pxJl0ZSAvIGLFgsSZZG5lOiAiICsgc2tpcHBlZAogICAgKTsKICB9CgogIGZ1bmN0aW9uIF9feHRiSGFuZGxlRmlsZUlucHV0Q2hhbmdlKGV2KXsKICAgIGNvbnN0IGlucHV0ID0gZXYudGFyZ2V0OwogICAgY29uc3QgZmlsZSA9IGlucHV0LmZpbGVzICYmIGlucHV0LmZpbGVzWzBdOwogICAgaWYoIWZpbGUpIHJldHVybjsKICAgIGlmKHR5cGVvZiBYTFNYID09PSAidW5kZWZpbmVkIil7CiAgICAgIGFsZXJ0KCJCcmFrIGJpYmxpb3Rla2kgWExTWCAoU2hlZXRKUykuIFNwcmF3ZMW6IHBvxYLEhWN6ZW5pZSB6IGludGVybmV0ZW0uIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHBmSWQgPSBfX3h0YkltcG9ydFBvcnRmb2xpb0lkOwogICAgaWYoIXBmSWQpewogICAgICBhbGVydCgiTmFqcGllcncgd3liaWVyeiBwb3J0ZmVsIGRsYSBpbXBvcnR1IFhUQi4iKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24oZSl7CiAgICAgIGxldCB3YjsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheShlLnRhcmdldC5yZXN1bHQpOwogICAgICAgIHdiID0gWExTWC5yZWFkKGRhdGEsIHt0eXBlOiJhcnJheSIsIGNlbGxEYXRlczp0cnVlfSk7CiAgICAgIH1jYXRjaChlcnIpewogICAgICAgIGNvbnNvbGUuZXJyb3IoIlhUQiBpbXBvcnQ6IGLFgsSFZCBwYXJzb3dhbmlhIHBsaWt1IiwgZXJyKTsKICAgICAgICBhbGVydCgiTmllIHVkYcWCbyBzacSZIG9kY3p5dGHEhyBwbGlrdSBYVEIgKFhMU1gpLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBzaGVldE5hbWVzID0gd2IuU2hlZXROYW1lcyB8fCBbXTsKCiAgICAgIGNvbnN0IGNhc2hOYW1lID0gc2hlZXROYW1lcy5maW5kKG4gPT4gbi50b1VwcGVyQ2FzZSgpLnN0YXJ0c1dpdGgoIkNBU0ggT1BFUkFUSU9OIikpOwogICAgICBjb25zdCByb3dzQWxsID0gW107CiAgICAgIGlmKGNhc2hOYW1lICYmIHdiLlNoZWV0c1tjYXNoTmFtZV0pewogICAgICAgIHJvd3NBbGwucHVzaCguLi5fX3h0YlBhcnNlQ2FzaFNoZWV0KHdiLlNoZWV0c1tjYXNoTmFtZV0pKTsKICAgICAgfQoKICAgICAgaWYoIXJvd3NBbGwubGVuZ3RoKXsKICAgICAgICBhbGVydCgiTmllIHpuYWxlemlvbm8gxbxhZG55Y2ggcG96eWNqaSBha2N5am55Y2ggKFN0b2NrIHB1cmNoYXNlL3NhbGUpIHcgYXJrdXN6dSBDQVNIIE9QRVJBVElPTiBISVNUT1JZLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgYWdncmVnYXRlZCA9IF9feHRiQnVpbGRBZ2dyZWdhdGVkKHJvd3NBbGwpOwogICAgICBfX3h0YkFnZ3JlZ2F0ZWQgPSBhZ2dyZWdhdGVkOwogICAgICBfX3h0YkltcG9ydFBvcnRmb2xpb0lkID0gcGZJZDsKICAgICAgX194dGJSZW5kZXJJbXBvcnRNb2RhbChwZklkLCBhZ2dyZWdhdGVkKTsKICAgICAgY29uc3QgbW9kYWwgPSBfX3h0YkVuc3VyZUltcG9ydE1vZGFsKCk7CiAgICAgIG1vZGFsLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICB9OwogICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpOwogIH0KCiAgKGZ1bmN0aW9uKCl7CiAgICBjb25zdCBmaSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ4dGJJbXBvcnRGaWxlIik7CiAgICBpZihmaSkgZmkuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgX194dGJIYW5kbGVGaWxlSW5wdXRDaGFuZ2UpOwogIH0pKCk7CgoKICAvLyBSZW5kZXJpbmcKCiAgLy8gQ29tcHV0ZSBob2xkaW5ncyAodXNpbmcgbGl2ZSBxdW90ZSBpZiBhdmFpbGFibGUsIGVsc2UgdW5pdENvc3QpIGFuZCB0b3RhbHMKICBmdW5jdGlvbiBjb21wdXRlSG9sZGluZ3NBbmRUb3RhbFZhbHVlcyhwZil7CiAgICB0cnl7CiAgICAgIGxldCBob2xkaW5nc1ZhbHVlID0gMDsKICAgICAgZm9yKGNvbnN0IFt0aWNrZXIsIGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHBmLmhvbGRpbmdzfHx7fSkpewogICAgICAgIGNvbnN0IGxvdHMgPSAoYm9vayAmJiBBcnJheS5pc0FycmF5KGJvb2subG90cykpID8gYm9vay5sb3RzIDogW107CiAgICAgICAgY29uc3QgcVByaWNlID0gZ2V0UXVvdGUodGlja2VyKTsKICAgICAgICBmb3IoY29uc3QgbCBvZiBsb3RzKXsKICAgICAgICAgIGNvbnN0IHF0eSA9IE51bWJlcihsLnF0eSl8fDA7CiAgICAgICAgICBjb25zdCB1bml0ID0gKHFQcmljZSE9bnVsbCA/IE51bWJlcihxUHJpY2UpIDogTnVtYmVyKGwudW5pdENvc3QpfHwwKTsKICAgICAgICAgIGhvbGRpbmdzVmFsdWUgKz0gcXR5ICogdW5pdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdG90YWxXaXRoQ2FzaCA9IGhvbGRpbmdzVmFsdWUgKyAoTnVtYmVyKHBmLmNhc2gpfHwwKTsKICAgICAgcmV0dXJuIHsgaG9sZGluZ3NWYWx1ZSwgdG90YWxXaXRoQ2FzaCB9OwogICAgfWNhdGNoKGUpewogICAgICByZXR1cm4geyBob2xkaW5nc1ZhbHVlOiAwLCB0b3RhbFdpdGhDYXNoOiBOdW1iZXIocGYuY2FzaCl8fDAgfTsKICAgIH0KICB9CgpmdW5jdGlvbiByZW5kZXJQb3J0Zm9saW9MaXN0KCl7CiAgc2V0VGltZW91dCgoKT0+eyB0cnkgeyB1cGRhdGVTaWRlYmFyQmxpbmtTdGF0ZXMoKTsgfSBjYXRjaChlKSB7fSB9LCAwKTsKCiAgICBwb3J0Zm9saW9MaXN0RWwuaW5uZXJIVE1MID0gIiI7CiAgICBmb3IoY29uc3QgcGYgb2YgKCh0eXBlb2YgU1QhPT0ndW5kZWZpbmVkJyAmJiBTVC5EQiAmJiBBcnJheS5pc0FycmF5KFNULkRCLnBvcnRmb2xpb3MpKSA/IFNULkRCLnBvcnRmb2xpb3MgOiAoKHR5cGVvZiBEQiE9PSd1bmRlZmluZWQnICYmIEFycmF5LmlzQXJyYXkoREIucG9ydGZvbGlvcykpID8gREIucG9ydGZvbGlvcyA6IFtdKSkpewogICAgICBjb25zdCB0b3RhbExvdHMgPSBPYmplY3QudmFsdWVzKHBmLmhvbGRpbmdzKS5yZWR1Y2UoKGFjYywgdik9PiBhY2MgKyB2LmxvdHMubGVuZ3RoLCAwKTsKICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWwuY2xhc3NOYW1lID0gInBvcnRmb2xpby1pdGVtIiArIChwZi5pZD09PWN1cnJlbnRQZklkID8gIiBhY3RpdmUiOiAiIik7CiAgICAgIGVsLmRhdGFzZXQucGZJZCA9IHBmLmlkOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IF9zdGF0ZSA9IHBvcnRmb2xpb1RhcmdldFN0YXRlKHBmKTsKICAgICAgICBpZihfc3RhdGUgPT09ICJoaXQiKSBlbC5jbGFzc0xpc3QuYWRkKCJoaXQtdGFyZ2V0Iik7CiAgICAgICAgZWxzZSBpZihfc3RhdGUgPT09ICJuZWFyIikgZWwuY2xhc3NMaXN0LmFkZCgibmVhci10YXJnZXQiKTsKICAgICAgfSBjYXRjaChlKSB7fQoKICAgICAgZWwuaW5uZXJIVE1MID0gYAogICAgICAgIDxkaXYgY2xhc3M9Im5hbWUiPiR7X19lc2MocGYubmFtZSl9PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9InRhZyI+R290w7N3a2E6ICR7X19nb19mbXRDdXJyZW5jeShwZi5jYXNoLCBwZi5jdXJyZW5jeSl9PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgIDxkaXYgY2xhc3M9InRhZyI+QWtjamU6ICR7X19nb19mbXRDdXJyZW5jeSgoY29tcHV0ZUhvbGRpbmdzQW5kVG90YWxWYWx1ZXMocGYpLmhvbGRpbmdzVmFsdWUpLCBwZi5jdXJyZW5jeSl9PC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJ0YWciPlJhemVtOiAke19fZ29fZm10Q3VycmVuY3koKGNvbXB1dGVIb2xkaW5nc0FuZFRvdGFsVmFsdWVzKHBmKS50b3RhbFdpdGhDYXNoKSwgcGYuY3VycmVuY3kpfTwvZGl2PgogICAgICAgIDwvZGl2PgoKICAgICAgICAgIDxkaXYgY2xhc3M9InRhZyI+UGFydGllOiAke3RvdGFsTG90c308L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwiPldhbHV0YTogJHtwZi5jdXJyZW5jeX08L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5tb2R5ZjogJHtuZXcgRGF0ZShwZi51cGRhdGVkQXQpLnRvTG9jYWxlRGF0ZVN0cmluZygncGwtUEwnKX08L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IGJ0bi14dGItaW1wb3J0IiB0eXBlPSJidXR0b24iIHRpdGxlPSJJbXBvcnQgdHJhbnNha2NqaSB6IFhUQiBkbyB0ZWdvIHBvcnRmZWxhIj7irIbvuI8gSW1wb3J0IHogWFRCPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgIGA7CiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiB7IAogICAgICB0cnl7IAogICAgICAgIGNvbnN0IG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubWFpbicpIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21haW4nKTsKICAgICAgICBpZihtYWluKXsKICAgICAgICAgIG1haW4ucXVlcnlTZWxlY3RvckFsbCgnOnNjb3BlID4gc2VjdGlvbicpLmZvckVhY2goc2VjPT57CiAgICAgICAgICAgIGlmKHNlYy5pZD09PSdhbGVydHNQYW5lbCcgfHwgc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnKSBzZWMuc3R5bGUuZGlzcGxheT0nbm9uZSc7IGVsc2Ugc2VjLnN0eWxlLmRpc3BsYXk9Jyc7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CiAgICAgIGN1cnJlbnRQZklkID0gcGYuaWQ7IHJlbmRlcigpOyAKICAgIH0pOwoKICAgICAgY29uc3QgaW1wb3J0QnRuID0gZWwucXVlcnlTZWxlY3RvcigiLmJ0bi14dGItaW1wb3J0Iik7CiAgICAgIGlmIChpbXBvcnRCdG4pIHsKICAgICAgICBpbXBvcnRCdG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZXYpPT57CiAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIHN0YXJ0WHRiSW1wb3J0Rm9yUG9ydGZvbGlvKHBmLmlkKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcG9ydGZvbGlvTGlzdEVsLmFwcGVuZENoaWxkKGVsKTsKICAgIH0KICAgIGlmKCFjdXJyZW50UGZJZCAmJiBEQi5wb3J0Zm9saW9zLmxlbmd0aD09PTApewogICAgICBjb25zdCBlbXB0eSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBlbXB0eS5jbGFzc05hbWU9InNtYWxsIjsKICAgICAgZW1wdHkuaW5uZXJIVE1MID0gIkJyYWsgcG9ydGZlbGkuIEtsaWtuaWogPGI+Tm93eSBwb3J0ZmVsPC9iPiwgYWJ5IHJvenBvY3rEhcSHLiI7CiAgICAgIHBvcnRmb2xpb0xpc3RFbC5hcHBlbmRDaGlsZChlbXB0eSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJNYWluKCl7CiAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsKICAgIGlmKCFwZil7CiAgICAgIHBmVGl0bGVFbC50ZXh0Q29udGVudCA9ICJXeWJpZXJ6IHBvcnRmZWwiOwogICAgICBjYXNoQmFsYW5jZUVsLnRleHRDb250ZW50ID0gIuKAlCI7CiAgICAgIHJlYWxpemVkUExFbC50ZXh0Q29udGVudCA9ICLigJQiOwogICAgICByZWFsaXplZFBMbmV0RWwudGV4dENvbnRlbnQgPSAibmV0dG8iOwogICAgICBzdHJhdGVneUJveC52YWx1ZSA9ICIiOwogICAgICBob2xkaW5nc1RhYmxlV3JhcC5pbm5lckhUTUwgPSAiIjsKICAgICAgdHhUYWJsZVdyYXAuaW5uZXJIVE1MID0gIiI7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGVuc3VyZVRyYW5zYWN0aW9uc0NvaGVyZW50KHBmKTsKICAgIG1heWJlV2FyblR4TG9zcyhwZik7CiAgICBwZlRpdGxlRWwudGV4dENvbnRlbnQgPSBgJHtwZi5uYW1lfSAoJHtwZi5jdXJyZW5jeX0pYDsKICAgIHN0cmF0ZWd5Qm94LnZhbHVlID0gcGYuc3RyYXRlZ3kgfHwgIiI7CiAgICBjYXNoQmFsYW5jZUVsLnRleHRDb250ZW50ID0gX19nb19mbXRDdXJyZW5jeShwZi5jYXNoLCBwZi5jdXJyZW5jeSk7CiAgICBjb25zdCB7c3VtR3Jvc3MsIHN1bVRheCwgc3VtTmV0fSA9IHJlYWxpemVkU3VtcyhwZik7CiAgICByZWFsaXplZFBMRWwudGV4dENvbnRlbnQgPSBfX2dvX2ZtdEN1cnJlbmN5KHN1bUdyb3NzLCBwZi5jdXJyZW5jeSk7CiAgICByZWFsaXplZFBMbmV0RWwudGV4dENvbnRlbnQgPSBfX2dvX2ZtdEN1cnJlbmN5KHN1bU5ldCwgcGYuY3VycmVuY3kpOwoKICAgIC8vIEhvbGRpbmdzIHRhYmxlCiAgICBob2xkaW5nc1RhYmxlV3JhcC5pbm5lckhUTUwgPSBidWlsZEhvbGRpbmdzVGFibGVIVE1MKHBmKTsKLy8gU2hvdyBpbnRlZ3JpdHkgd2FybmluZ3MgKG5vbi1ibG9ja2luZykKdHJ5ewogIGNvbnN0IGVycldyYXBJZCA9ICdwZkVycm9yc0Jhbm5lcic7CiAgbGV0IG9sZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVycldyYXBJZCk7CiAgaWYob2xkKSBvbGQucmVtb3ZlKCk7CiAgY29uc3QgZXJycyA9IEFycmF5LmlzQXJyYXkocGYuX19lcnJvcnMpID8gcGYuX19lcnJvcnMgOiBbXTsKICBpZihlcnJzLmxlbmd0aCl7CiAgICBjb25zdCB3cmFwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB3cmFwLmlkID0gZXJyV3JhcElkOwogICAgd3JhcC5jbGFzc05hbWUgPSAnYmFubmVyIHdhcm4nOwogICAgY29uc3QgZGV0YWlscyA9IGVycnMuc2xpY2UoMCw0KS5tYXAoZSA9PiBgJHtlLmRhdGV8fCfigJQnfSDigKIgJHtlLnRpY2tlcnx8J+KAlCd9IOKAoiAke2UubWVzc2FnZXx8Jyd9YCkuam9pbignPGJyPicpOwogICAgd3JhcC5pbm5lckhUTUwgPSBgPGRpdj7imqDvuI8gTmllc3DDs2puZSB0cmFuc2FrY2plOiAke2VycnMubGVuZ3RofS4gPHNwYW4gY2xhc3M9InNtYWxsIiBzdHlsZT0ib3BhY2l0eTouODUiPkVkeWNqYSBuaWUgem9zdGHFgmEgemFibG9rb3dhbmEg4oCUIHNwcmF3ZMW6IHN6Y3plZ8OzxYJ5IGkgcG9wcmF3IGRhdHkvYWxva2FjamUuPC9zcGFuPjxkaXYgY2xhc3M9InNtYWxsIiBzdHlsZT0ibWFyZ2luLXRvcDo2cHgiPiR7ZGV0YWlsc30ke2VycnMubGVuZ3RoPjQ/Jzxicj7igKYnOicnfTwvZGl2PjwvZGl2PjxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4Ij48YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJwZkVycm9yc0Rpc21pc3MiPk9LPC9idXR0b24+PGJ1dHRvbiBjbGFzcz0iYnRuIHdhcm4iIGlkPSJwZkVycm9yc0lnbm9yZSI+SWdub3J1aiBzcHJ6ZWRhxbxlPC9idXR0b24+PC9kaXY+YDsKICAgIGNvbnN0IG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1haW4nKSB8fCBkb2N1bWVudC5ib2R5OwogICAgbWFpbi5wcmVwZW5kKHdyYXApOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BmRXJyb3JzRGlzbWlzcycpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT4gd3JhcC5yZW1vdmUoKSk7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BmRXJyb3JzSWdub3JlJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiB7IHRyeXsgX19pZ25vcmVJbmNvbnNpc3RlbnRTZWxscygpOyB9Y2F0Y2goXyl7IGFsZXJ0KCdCxYLEhWQgaWdub3Jvd2FuaWEuJyk7IH0gfSk7CiAgfQp9Y2F0Y2goXyl7fQoKICAgIAogICAgLy8gVXBkYXRlIGxlZnQgc2lkZWJhciB0aWxlIGJsaW5raW5nIGZvciB0aGUgY3VycmVudCBwb3J0Zm9saW8KICAgIChmdW5jdGlvbigpewogICAgICBjb25zdCBzdGF0ZSA9IHBvcnRmb2xpb1RhcmdldFN0YXRlKHBmKTsgLy8gImhpdCIgfCAibmVhciIgfCAibm9uZSIKICAgICAgLy8gQ2xlYXIgcHJldmlvdXMgYmxpbmtpbmcgY2xhc3NlcyBvbiBhbGwgc2lkZWJhciBpdGVtcwogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcucG9ydGZvbGlvLWl0ZW0nKS5mb3JFYWNoKGVsPT57CiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZSgnaGl0LXRhcmdldCcsJ25lYXItdGFyZ2V0Jyk7CiAgICAgIH0pOwogICAgICAvLyBBcHBseSB0byB0aGUgY3VycmVudCBwb3J0Zm9saW8ncyB0aWxlCiAgICAgIGNvbnN0IGN1ckVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLnBvcnRmb2xpby1pdGVtW2RhdGEtcGYtaWQ9IiR7cGYuaWR9Il1gKTsKICAgICAgaWYoY3VyRWwpewogICAgICAgIGlmKHN0YXRlID09PSAiaGl0IikgY3VyRWwuY2xhc3NMaXN0LmFkZCgnaGl0LXRhcmdldCcpOwogICAgICAgIGVsc2UgaWYoc3RhdGUgPT09ICJuZWFyIikgY3VyRWwuY2xhc3NMaXN0LmFkZCgnbmVhci10YXJnZXQnKTsKICAgICAgfQogICAgfSkoKTsKCi8vIFRyYW5zYWN0aW9ucyB0YWJsZQogICAgdHhUYWJsZVdyYXAuaW5uZXJIVE1MID0gYnVpbGRUeFRhYmxlSFRNTChwZiwgZmlsdGVyUXVlcnlFbC52YWx1ZS50cmltKCkpOwogICAgdHJ5IHsgdXBkYXRlU2lkZWJhckJsaW5rU3RhdGVzKCk7IH0gY2F0Y2goZSkge30KfQoKICBmdW5jdGlvbiByZWFsaXplZFN1bXMocGYsIHJhbmdlKXsKICAgIGxldCBzdW1Hcm9zcyA9IDAsIHN1bVRheCA9IDAsIHN1bU5ldCA9IDA7CiAgICBmb3IoY29uc3QgdCBvZiBwZi50cmFuc2FjdGlvbnMpewogICAgICBpZih0LnR5cGU9PT0ic2VsbCIpewogICAgICAgIHRyeXsgY29uc3QgbXMgPSB0b01zKHQgJiYgdC5kYXRlKTsgaWYocmFuZ2UgJiYgIWluUmFuZ2VNcyhtcywgcmFuZ2UpKSBjb250aW51ZTsgfWNhdGNoKF8pe30KICAgICAgICBzdW1Hcm9zcyArPSBOdW1iZXIodC5ncm9zc1BMKXx8MDsKICAgICAgICBzdW1UYXggICArPSBOdW1iZXIodC50YXgpfHwwOwogICAgICAgIHN1bU5ldCAgICs9IE51bWJlcih0Lm5ldFBMIHx8ICh0Lmdyb3NzUEwgLSAodC5ncm9zc1BMPjAgPyAoREIuc2V0dGluZ3MudGF4UmF0ZXx8MC4xOSkqdC5ncm9zc1BMIDogMCkpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHtzdW1Hcm9zcywgc3VtVGF4LCBzdW1OZXR9OwogIH0KCiAgCiAgCiAgCiAgZnVuY3Rpb24gYnVpbGRIb2xkaW5nc1RhYmxlSFRNTChwZil7CiAgICBjb25zdCBzZWN0aW9ucyA9IFtdOwogICAgY29uc3QgX19yb3dzID0gW107CiAgICBmb3IoY29uc3QgW3RpY2tlciwgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3MpKXsKICAgICAgY29uc3QgX19jbiA9IGdldENvbXBhbnlOYW1lKHRpY2tlcik7CiAgICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gX19jbiA/IGAke19fZXNjKHRpY2tlcil9IDxzcGFuIGNsYXNzPSJtdXRlZCBzbWFsbCIgc3R5bGU9ImZvbnQtd2VpZ2h0OjQwMCI+JHtfX2VzYyhfX2NuKX08L3NwYW4+YCA6IF9fZXNjKHRpY2tlcik7CiAgICAgIGNvbnN0IGxvdHMgPSBib29rLmxvdHMgfHwgW107CiAgICAgIGNvbnN0IHRvdGFsUXR5ID0gbG90cy5yZWR1Y2UoKGEsbCk9PmErTnVtYmVyKGwucXR5fHwwKSwwKTsKICAgICAgY29uc3QgY29zdEJhc2lzID0gbG90cy5yZWR1Y2UoKGEsbCk9PmEgKyBOdW1iZXIobC5xdHl8fDApKk51bWJlcihsLnVuaXRDb3N0fHwwKSwwKTsKICAgICAgY29uc3QgYXZnQ29zdCA9IHRvdGFsUXR5PjAgPyBjb3N0QmFzaXMgLyB0b3RhbFF0eSA6IDA7CiAgICAgIGNvbnN0IGxhc3RQcmljZSA9IGdldFF1b3RlKHRpY2tlcik7CgogICAgICBsZXQgbmVhcmVzdFRhcmdldCA9IG51bGwsIHN0YXR1c0NsYXNzID0gIiI7CmxldCBuZWFyZXN0RGlzdCA9IEluZmluaXR5OwpsZXQgc3RhdHVzUmFuayA9IC0xOyAvLyAzOiBoaXQtc2VsbCwgMjogaGl0LWJ1eSwgMTogbmVhci1zZWxsLCAwOiBuZWFyLWJ1eQpmb3IoY29uc3QgbCBvZiBsb3RzKXsKICBsLl90aWNrZXIgPSB0aWNrZXI7CiAgY29uc3Qgc2VsbFQgPSBjb21wdXRlVGFyZ2V0UHJpY2UobCk7CiAgY29uc3QgYnV5VCAgPSBjb21wdXRlQnV5VGFyZ2V0UHJpY2UobCk7CiAgY29uc3Qgc3QgPSB0YXJnZXRTdGF0dXMobCk7CiAgY29uc3QgcmFuayA9IHN0LnN0YXRlPT09ImhpdCIgPyAoc3Qua2luZD09PSJzZWxsIj8zOjIpIDogKHN0LnN0YXRlPT09Im5lYXIiID8gKHN0LmtpbmQ9PT0ic2VsbCI/MTowKSA6IC0xKTsKICBpZihyYW5rID4gc3RhdHVzUmFuayl7CiAgICBzdGF0dXNSYW5rID0gcmFuazsKICAgIGlmKHJhbms9PT0zKSBzdGF0dXNDbGFzcyA9ICJoaXQtdGFyZ2V0LXNlbGwiOwogICAgZWxzZSBpZihyYW5rPT09Mikgc3RhdHVzQ2xhc3MgPSAiaGl0LXRhcmdldC1idXkiOwogICAgZWxzZSBpZihyYW5rPT09MSkgc3RhdHVzQ2xhc3MgPSAibmVhci10YXJnZXQtc2VsbCI7CiAgICBlbHNlIGlmKHJhbms9PT0wKSBzdGF0dXNDbGFzcyA9ICJuZWFyLXRhcmdldC1idXkiOwogIH0KICAvLyBzdXBwcmVzcyBibGlua2luZyBmb3IgYWNrbm93bGVkZ2VkIGFsYXJtcwogIChmdW5jdGlvbigpewogICAgY29uc3QgbWFwID0geyJoaXQtdGFyZ2V0LXNlbGwiOntzdGF0ZToiaGl0IixraW5kOiJzZWxsIn0sImhpdC10YXJnZXQtYnV5Ijp7c3RhdGU6ImhpdCIsa2luZDoiYnV5In0sIm5lYXItdGFyZ2V0LXNlbGwiOntzdGF0ZToibmVhciIsa2luZDoic2VsbCJ9LCJuZWFyLXRhcmdldC1idXkiOntzdGF0ZToibmVhciIsa2luZDoiYnV5In19OwogICAgY29uc3QgaW5mbyA9IG1hcFtzdGF0dXNDbGFzc107CiAgICBpZihpbmZvICYmIGlzQWxlcnRBY2tlZCh0aWNrZXIsIGluZm8ua2luZCwgaW5mby5zdGF0ZSkpeyBzdGF0dXNDbGFzcyA9ICIiOyB9CiAgfSkoKTsKCiAgY29uc3QgY2FuZGlkYXRlcyA9IFtdOwogIGlmKHNlbGxUIT1udWxsKSBjYW5kaWRhdGVzLnB1c2goc2VsbFQpOwogIGlmKGJ1eVQhPW51bGwpICBjYW5kaWRhdGVzLnB1c2goYnV5VCk7CiAgZm9yKGNvbnN0IHQgb2YgY2FuZGlkYXRlcyl7CiAgICBpZihsYXN0UHJpY2UhPW51bGwpewogICAgICBjb25zdCBkID0gTWF0aC5hYnMoKGxhc3RQcmljZSAtIHQpL3QpOwogICAgICBpZihkIDwgbmVhcmVzdERpc3QpeyBuZWFyZXN0RGlzdCA9IGQ7IG5lYXJlc3RUYXJnZXQgPSB0OyB9CiAgICB9IGVsc2UgewogICAgICBpZihuZWFyZXN0VGFyZ2V0PT1udWxsKSBuZWFyZXN0VGFyZ2V0ID0gdDsgZWxzZSBuZWFyZXN0VGFyZ2V0ID0gTWF0aC5taW4obmVhcmVzdFRhcmdldCwgdCk7CiAgICB9CiAgfQogICAgICAvLyBMb2cgcGVyLXRpY2tlciBhbGFybSB0byBGaXJlc3RvcmUgKGRlZHVwbGljYXRlZCkKICAgICAgKGZ1bmN0aW9uKCl7CiAgICAgICAgY29uc3QgbWFwID0gewogICAgICAgICAgImhpdC10YXJnZXQtc2VsbCI6IHtzdGF0ZToiaGl0IiwgIGtpbmQ6InNlbGwifSwKICAgICAgICAgICJoaXQtdGFyZ2V0LWJ1eSI6ICB7c3RhdGU6ImhpdCIsICBraW5kOiJidXkifSwKICAgICAgICAgICJuZWFyLXRhcmdldC1zZWxsIjp7c3RhdGU6Im5lYXIiLCBraW5kOiJzZWxsIn0sCiAgICAgICAgICAibmVhci10YXJnZXQtYnV5Ijoge3N0YXRlOiJuZWFyIiwga2luZDoiYnV5In0KICAgICAgICB9OwogICAgICAgIGNvbnN0IGluZm8gPSBtYXBbc3RhdHVzQ2xhc3NdOwogICAgICAgIGlmKGluZm8gJiYgbmVhcmVzdFRhcmdldCE9bnVsbCAmJiBsYXN0UHJpY2UhPW51bGwpewogICAgICAgICAgY29uc3Qga2V5ID0gWydwZicsIChwZiYmcGYuaWQpfHwnZGVmYXVsdCcsIHRpY2tlciwgaW5mby5raW5kXS5qb2luKCd8Jyk7CiAgICAgICAgICBpZihfX3Nob3VsZExvZ0FsYXJtKGtleSwgaW5mby5zdGF0ZSkpeyB0cnl7IHdpbmRvdy5zaG93VG9hc3QgJiYgc2hvd1RvYXN0KHt0aWNrZXI6ci50LCBzdGF0ZTppbmZvLnN0YXRlLCBraW5kOmluZm8ua2luZH0pOyB9Y2F0Y2goXyl7fSB0cnl7IHdpbmRvdy5zaG93VG9hc3QgJiYgc2hvd1RvYXN0KHt0aWNrZXIsIHN0YXRlOmluZm8uc3RhdGUsIGtpbmQ6aW5mby5raW5kfSk7IH1jYXRjaChfKXt9CiAgICAgICAgICAgIHRyeXsgbG9nQWxhcm1FdmVudCh7c2NvcGU6J3BvcnRmb2xpbycsIHBmSWQ6KHBmJiZwZi5pZCl8fG51bGwsIHRpY2tlciwgc3RhdGU6aW5mby5zdGF0ZSwga2luZDppbmZvLmtpbmQsIHByaWNlOmxhc3RQcmljZSwgdGFyZ2V0Om5lYXJlc3RUYXJnZXR9KTsgfWNhdGNoKF8pe30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pKCk7CiAgICAKfQoKICAgICAgY29uc3QgbG90Um93c0FyciA9IGxvdHMubWFwKChsLGkpPT57CiAgICAgICAgY29uc3QgdCA9IGNvbXB1dGVUYXJnZXRQcmljZShsKTsKICAgICAgICBjb25zdCBzdCA9IHRhcmdldFN0YXR1cyhsKTsKICAgICAgICBjb25zdCBjbHMgPSBzdC5zdGF0ZT09PSJoaXQiID8gKHN0LmtpbmQ9PT0ic2VsbCI/ImhpdC10YXJnZXQtc2VsbCI6ImhpdC10YXJnZXQtYnV5IikgOiAoc3Quc3RhdGU9PT0ibmVhciIgPyAoc3Qua2luZD09PSJzZWxsIj8ibmVhci10YXJnZXQtc2VsbCI6Im5lYXItdGFyZ2V0LWJ1eSIpIDogIiIpOwogICAgICAgIHJldHVybiAoCiAgICAgICAgICBgPHRyIGRhdGEtbG90aWQ9IiR7bC5sb3RJZH0iIGNsYXNzPSIke2Nsc30iPmArCiAgICAgICAgICAgIGA8dGQ+JHtpKzF9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19lc2MobC5kYXRlfHwiIil9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19mbXROdW0obC5xdHkpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4ke19fZ29fZm10Q3VycmVuY3kobC51bml0Q29zdCwgcGYuY3VycmVuY3kpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4ke19fZ29fZm10Q3VycmVuY3kobC5xdHkqbC51bml0Q29zdCwgcGYuY3VycmVuY3kpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD5gKwogICAgICAgICAgICAoICh0IT1udWxsP2A8c3BhbiBjbGFzcz0ic2VsbC10YXJnZXQiIHN0eWxlPSJjb2xvcjojZGMyNjI2Ij4ke19fZ29fZm10Q3VycmVuY3kodCwgcGYuY3VycmVuY3kpfTwvc3Bhbj5gOmBgKSArCiAgICAgICAgICAgICAgKCAoY29tcHV0ZUJ1eVRhcmdldFByaWNlKGwpIT1udWxsKT9gPGRpdiBjbGFzcz0iYnV5LXRhcmdldCIgc3R5bGU9ImNvbG9yOiMxNmEzNGEiPiR7X19nb19mbXRDdXJyZW5jeShjb21wdXRlQnV5VGFyZ2V0UHJpY2UobCksIHBmLmN1cnJlbmN5KX08L2Rpdj5gOmBgKSArCiAgICAgICAgICAgICAgKHQ9PW51bGwgJiYgY29tcHV0ZUJ1eVRhcmdldFByaWNlKGwpPT1udWxsPyAn4oCUJzogJycpCiAgICAgICAgICAgICkrCiAgICAgICAgICAgIGA8L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHtsYXN0UHJpY2UhPW51bGw/X19mbXROdW0obGFzdFByaWNlKToi4oCUIn08L3RkPjx0ZD4keygoKT0+eyBjb25zdCBfX3AgPSAobGFzdFByaWNlIT1udWxsPyBOdW1iZXIobGFzdFByaWNlKSA6IG51bGwpOyBjb25zdCBfX3VjID0gTnVtYmVyKGwudW5pdENvc3QpfHwwOyBjb25zdCBfX3EgPSBOdW1iZXIobC5xdHkpfHwwOyBjb25zdCBfX3BsID0gKF9fcCE9bnVsbCAmJiBpc0Zpbml0ZShfX3ApKSA/IChfX3EqKF9fcC1fX3VjKSkgOiBudWxsOyByZXR1cm4gKF9fcGw9PW51bGwpID8gIuKAlCIgOiAoIjxzcGFuIGNsYXNzPSciKyhfX3BsPj0wPyJvay10ZXh0IjoiZGFuZ2VyLXRleHQiKSsiJz4iK19fZ29fZm10Q3VycmVuY3koX19wbCwgcGYuY3VycmVuY3kpKyI8L3NwYW4+Iik7IH0pKCl9PC90ZD48dGQ+JHsoKCk9PnsgY29uc3QgX19wID0gKGxhc3RQcmljZSE9bnVsbD8gTnVtYmVyKGxhc3RQcmljZSkgOiBudWxsKTsgY29uc3QgX191YyA9IE51bWJlcihsLnVuaXRDb3N0KXx8MDsgY29uc3QgX19wY3QgPSAoX19wIT1udWxsICYmIF9fdWM+MCkgPyAoKChfX3AtX191YykvX191YykqMTAwKSA6IG51bGw7IHJldHVybiAoX19wY3Q9PW51bGwpID8gIuKAlCIgOiBmbXRQY3QoX19wY3QpOyB9KSgpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4keygoKT0+eyAKICBjb25zdCBfX2NoID0gZ2V0UXVvdGVDaGFuZ2VQY3QodGlja2VyKTsgCiAgY29uc3QgX190ciA9IGdldFF1b3RlVHJlbmQodGlja2VyKTsgCiAgY29uc3QgX19hcnJvdyA9IChfX3RyPT09MSk/JzxzcGFuIGNsYXNzPSJjaGFuZ2UtYXJyb3cgdXAiPuKWsjwvc3Bhbj4nOihfX3RyPT09LTEpPyc8c3BhbiBjbGFzcz0iY2hhbmdlLWFycm93IGRvd24iPuKWvDwvc3Bhbj4nOicnOwogIHJldHVybiAoX19jaCE9bnVsbCkgPyAoX19hcnJvdyArICI8c3BhbiBjbGFzcz0ncGN0LWJhZGdlICIrKF9fY2g+PTA/InBjdC1wb3Mgb2stdGV4dCI6InBjdC1uZWcgZGFuZ2VyLXRleHQiKSsiJz4iK2ZtdFBjdChfX2NoKSsiPC9zcGFuPiIpIDogIuKAlCI7IAp9KSgpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4ke3N0LnN0YXRlPT09ImhpdCI/IvCfjq8iOihzdC5zdGF0ZT09PSJuZWFyIj8i4o+zIjoi4oCUIil9PC90ZD5gKwogICAgICAgICAgYDx0ZD48YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgbG90LWVkaXQiIGRhdGEtdGlja2VyPSIke3RpY2tlcn0iIGRhdGEtbG90PSIke2wubG90SWR9Ij7wn5OdPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBvayBsb3Qtc2VsbCIgZGF0YS10aWNrZXI9IiR7dGlja2VyfSIgZGF0YS1sb3Q9IiR7bC5sb3RJZH0iIGRhdGEtbWF4cXR5PSIke2wucXR5fSI+8J+SuDwvYnV0dG9uPiA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgbG90LW11dGUiIGRhdGEtYWN0aW9uPSJsb3QtbXV0ZSIgZGF0YS10aWNrZXI9IiR7dGlja2VyfSIgZGF0YS1sb3Q9IiR7bC5sb3RJZH0iIHRpdGxlPSIke2wubXV0ZWQ/J1fFgsSFY3ogYWxlcnQnOidXeWNpc3ogYWxlcnQnfSI+JHtsLm11dGVkPyfwn5SVJzon8J+UlCd9PC9idXR0b24+PC90ZD48L3RyPmAKICAgICAgICApOwogICAgICB9KTsKICAgICAgY29uc3QgbG90Um93c0hUTUwgPSBsb3RSb3dzQXJyLmpvaW4oIiIpIHx8ICc8dHIgZGF0YS1sb3RpZD1cIiR7bG90LmxvdElkfVwiPjx0ZCBjb2xzcGFuPSI4IiBjbGFzcz0iY2VudGVyIG11dGVkIj5CcmFrIHBhcnRpaTwvdGQ+PC90cj4nOwoKICAgICAgY29uc3QgZGV0YWlsc0hUTUwgPSAoCiAgICAgICAgYDxkZXRhaWxzPjxzdW1tYXJ5PiR7ZGlzcGxheU5hbWV9IDxidXR0b24gY2xhc3M9ImJ0biBzbWFsbCBnaG9zdCBhZGQtbG90IiBkYXRhLXRpY2tlcj0iJHtfX2VzYyh0aWNrZXIpfSIgdGl0bGU9IkRvZGFqIG5vd8SFIHBhcnRpxJkiPuKelTwvYnV0dG9uPiA8YnV0dG9uIGNsYXNzPSJidG4gc21hbGwgZ2hvc3QgdHJhbnNmZXItY29tcGFueSIgZGF0YS10aWNrZXI9IiR7X19lc2ModGlja2VyKX0iIHRpdGxlPSJQcnplbmllxZsgY2HFgsSFIHNww7PFgmvEmSBkbyBpbm5lZ28gcG9ydGZlbGEiPvCflIQ8L2J1dHRvbj48L3N1bW1hcnk+YCsKICAgICAgICBgPGRpdiBzdHlsZT0icGFkZGluZzo4cHggMCI+YCsKICAgICAgICAgIGA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj5gKwogICAgICAgICAgICBgPHRhYmxlPmArCiAgICAgICAgICAgICAgYDx0aGVhZD5gKwogICAgICAgICAgICAgICAgYDx0cj48dGg+IzwvdGg+PHRoPkRhdGE8L3RoPjx0aD5JbG/Fm8SHPC90aD48dGg+S29zenQgLyBzenQuPC90aD48dGg+V2FydG/Fm8SHIGtzacSZZ293YTwvdGg+PHRoPlN1Z2Vyb3dhbmEgY2VuYTwvdGg+PHRoPkt1cnM8L3RoPjx0aD5QL0w8L3RoPjx0aD5QL0wgJTwvdGg+PHRoPs6UIGR6aWVubnk8L3RoPjx0aD5TdGF0dXM8L3RoPjx0aD5Ba2NqZTwvdGg+PC90cj5gKwogICAgICAgICAgICAgIGA8L3RoZWFkPmArCiAgICAgICAgICAgICAgYDx0Ym9keT4ke2xvdFJvd3NIVE1MfTwvdGJvZHk+YCsKICAgICAgICAgICAgYDwvdGFibGU+YCsKICAgICAgICAgIGA8L2Rpdj5gKwogICAgICAgIGA8L2Rpdj5gKwogICAgICAgIGA8L2RldGFpbHM+YAogICAgICApOwoKICAgICAgX19yb3dzLnB1c2goeyBkaXN0OiBuZWFyZXN0RGlzdCwgaHRtbDogYDx0Ym9keT5gKwogICAgICAgICAgYDx0ciBjbGFzcz0iJHtzdGF0dXNDbGFzc30iPmArCiAgICAgICAgICAgIGA8dGQgY2xhc3M9InRpY2tlciI+JHtkZXRhaWxzSFRNTH0gPC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19mbXROdW0odG90YWxRdHkpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4ke19fZ29fZm10Q3VycmVuY3koYXZnQ29zdCwgcGYuY3VycmVuY3kpfTwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4ke19fZ29fZm10Q3VycmVuY3koY29zdEJhc2lzLCBwZi5jdXJyZW5jeSl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7bGFzdFByaWNlIT1udWxsP19fZm10TnVtKGxhc3RQcmljZSk6IuKAlCJ9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7KCgpPT57IAogIGNvbnN0IF9fY2ggPSBnZXRRdW90ZUNoYW5nZVBjdCh0aWNrZXIpOyAKICBjb25zdCBfX3RyID0gZ2V0UXVvdGVUcmVuZCh0aWNrZXIpOyAKICBjb25zdCBfX2Fycm93ID0gKF9fdHI9PT0xKT8nPHNwYW4gY2xhc3M9ImNoYW5nZS1hcnJvdyB1cCI+4payPC9zcGFuPic6KF9fdHI9PT0tMSk/JzxzcGFuIGNsYXNzPSJjaGFuZ2UtYXJyb3cgZG93biI+4pa8PC9zcGFuPic6Jyc7CiAgcmV0dXJuIChfX2NoIT1udWxsKSA/IChfX2Fycm93ICsgIjxzcGFuIGNsYXNzPSdwY3QtYmFkZ2UgIisoX19jaD49MD8icGN0LXBvcyBvay10ZXh0IjoicGN0LW5lZyBkYW5nZXItdGV4dCIpKyInPiIrZm10UGN0KF9fY2gpKyI8L3NwYW4+IikgOiAi4oCUIjsgCn0pKCl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7KCgpPT57IGlmKG5lYXJlc3RUYXJnZXQ9PW51bGwpIHJldHVybiAi4oCUIjsgIGxldCBraW5kPW51bGwsIGJlc3Q9SW5maW5pdHk7ICBmb3IoY29uc3QgbCBvZiBsb3RzKXsgICAgY29uc3Qgcz1jb21wdXRlVGFyZ2V0UHJpY2UobCk7IGlmKHMhPW51bGwpeyBjb25zdCBkPU1hdGguYWJzKChuZWFyZXN0VGFyZ2V0LXMpL25lYXJlc3RUYXJnZXQpOyBpZihkPGJlc3QpeyBiZXN0PWQ7IGtpbmQ9J3NlbGwnOyB9IH0gICAgY29uc3QgYj1jb21wdXRlQnV5VGFyZ2V0UHJpY2UobCk7IGlmKGIhPW51bGwpeyBjb25zdCBkPU1hdGguYWJzKChuZWFyZXN0VGFyZ2V0LWIpL25lYXJlc3RUYXJnZXQpOyBpZihkPGJlc3QpeyBiZXN0PWQ7IGtpbmQ9J2J1eSc7IH0gfSAgfSAgY29uc3QgbGJsID0ga2luZD09PSdzZWxsJz8nY2VsIHNwcnplZGHFvHknOihraW5kPT09J2J1eSc/J2NlbCB6YWt1cHUnOicnKTsgIHJldHVybiBfX2dvX2ZtdEN1cnJlbmN5KG5lYXJlc3RUYXJnZXQsIHBmLmN1cnJlbmN5KSArIChsYmw/YDxkaXYgY2xhc3M9InNtYWxsIiBzdHlsZT0ib3BhY2l0eTouNzU7ICR7a2luZD09PSdzZWxsJz8nY29sb3I6IzE2YTM0YSc6KGtpbmQ9PT0nYnV5Jz8nY29sb3I6I2RjMjYyNic6JycpfSI+JHtsYmx9PC9kaXY+YDoiIik7IH0pKCl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7KCgpPT57IGNvbnN0IHA9bGFzdFByaWNlOyBjb25zdCB0PW5lYXJlc3RUYXJnZXQ7IGlmKHA9PW51bGx8fHQ9PW51bGx8fHQ8PTApIHJldHVybiAi4oCUIjsgY29uc3QgZGlzdCA9IE1hdGguYWJzKHAgLSB0KSAvIHQ7IGNvbnN0IHBjdFN0ciA9IChkaXN0KjEwMCkudG9GaXhlZCgyKSArICIlIjsgY29uc3QgbG9jYWxUb2wgPSAoTnVtYmVyKERCLnNldHRpbmdzLmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MSkvMTAwOyBjb25zdCBjbHMgPSAoZGlzdDw9MWUtNikgPyAib2stdGV4dCIgOiAoZGlzdCA8PSAobG9jYWxUb2wvMikgPyAid2Fybi1zdHJvbmctdGV4dCIgOiAid2Fybi10ZXh0Iik7IHJldHVybiBgPHNwYW4gY2xhc3M9IiR7Y2xzfSI+JHtwY3RTdHJ9PC9zcGFuPmA7IH0pKCl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPjxzcGFuIGNsYXNzPSJzbWFsbCI+JHtzdGF0dXNDbGFzcz8gKHN0YXR1c0NsYXNzPT09ImhpdC10YXJnZXQiPyLwn46vIGNlbCBvc2nEhWduacSZdHkiOiLij7MgYmxpc2tvIGNlbHUiKToi4oCUIn08L3NwYW4+PC90ZD5gKwogICAgICAgICAgICBgPHRkIGNsYXNzPSJyb3ciIHN0eWxlPSJnYXA6NnB4Ij48YnV0dG9uIGNsYXNzPSJidG4gZGFuZ2VyIGRlbC1jb21wYW55IiBkYXRhLXRpY2tlcj0iJHtfX2VzYyh0aWNrZXIpfSI+8J+XkTwvYnV0dG9uPiA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgdHYtbGluayIgZGF0YS10aWNrZXI9IiR7X19lc2ModGlja2VyKX0iIHRpdGxlPSJUcmFkaW5nVmlldyI+8J+TiDwvYnV0dG9uPiA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgaW5mby1jb21wYW55IiBkYXRhLXRpY2tlcj0iJHtfX2VzYyh0aWNrZXIpfSI+4oS577iPPC9idXR0b24+PC90ZD5gKwogICAgICAgICAgYDwvdHI+YCsKICAgICAgICBgPC90Ym9keT5gCiAgICAgIH0pOwogICAgfQogICAgLyogc29ydCBieSBuZWFyZXN0IHRhcmdldCBkaXN0YW5jZSAqLwogICAgaWYoX19yb3dzLmxlbmd0aCl7CiAgICAgIF9fcm93cy5zb3J0KChhLGIpPT57CiAgICAgICAgY29uc3QgYWQgPSAoYS5kaXN0PT1udWxsfHwhaXNGaW5pdGUoYS5kaXN0KSk/SW5maW5pdHk6YS5kaXN0OwogICAgICAgIGNvbnN0IGJkID0gKGIuZGlzdD09bnVsbHx8IWlzRmluaXRlKGIuZGlzdCkpP0luZmluaXR5OmIuZGlzdDsKICAgICAgICByZXR1cm4gYWQgLSBiZDsKICAgICAgfSk7CiAgICAgIGZvcihjb25zdCByIG9mIF9fcm93cyl7IHNlY3Rpb25zLnB1c2goci5odG1sKTsgfQogICAgfQogICAgY29uc3Qgc2VjdGlvbnNIVE1MID0gc2VjdGlvbnMuam9pbigiIikgfHwgJzx0Ym9keT48dHI+PHRkIGNvbHNwYW49IjgiIGNsYXNzPSJjZW50ZXIgbXV0ZWQiPkJyYWsgcG96eWNqaTwvdGQ+PC90cj48L3Rib2R5Pic7CiAgICBjb25zdCBoID0gKAogICAgICBgPGRpdiBjbGFzcz0idGFibGUtd3JhcCI+YCsKICAgICAgICBgPHRhYmxlPmArCiAgICAgICAgICBgPHRoZWFkPmArCiAgICAgICAgICAgIGA8dHI+YCsKICAgICAgICAgICAgICBgPHRoPlRpY2tlcjwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPklsb8WbxIc8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD7FmnIuIGtvc3p0IC8gc3p0LjwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPldhcnRvxZvEhyBrc2nEmWdvd2E8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5LdXJzPC90aD48dGg+zpQgZHppZW5ueTwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPk5hamJsacW8c3p5IGNlbDwvdGg+PHRoPlBvem9zdGHFgm8gZG8gY2VsdTwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPlN0YXR1czwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPkFrY2plPC90aD5gKwogICAgICAgICAgICBgPC90cj5gKwogICAgICAgICAgYDwvdGhlYWQ+YCsKICAgICAgICAgIHNlY3Rpb25zSFRNTCsKICAgICAgICBgPC90YWJsZT5gKwogICAgICBgPC9kaXY+YAogICAgKTsKICAgIHJldHVybiBoOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VGaWx0ZXIocSl7CiAgICAvLyBTaW1wbGUgZmlsdGVyIHBhcnNlcjogInR5cDpzZWxsIFRTTEEgMjAyNS0wOSIKICAgIHEgPSAocXx8IiIpLnRyaW0oKTsKICAgIGNvbnN0IHBhcnRzID0gcS5zcGxpdCgvXHMrLykuZmlsdGVyKEJvb2xlYW4pOwogICAgY29uc3QgZiA9IHsgdGV4dDogW10gfTsKICAgIGZvcihjb25zdCBwIG9mIHBhcnRzKXsKICAgICAgY29uc3QgbSA9IHAubWF0Y2goL150eXA6KFx3KykvaSk7CiAgICAgIGlmKG0peyBmLnR5cGUgPSBtWzFdLnRvTG93ZXJDYXNlKCk7IGNvbnRpbnVlOyB9CiAgICAgIGYudGV4dC5wdXNoKHAudG9Mb3dlckNhc2UoKSk7CiAgICB9CiAgICByZXR1cm4gZjsKICB9CgogIAogIGZ1bmN0aW9uIGJ1aWxkVHhUYWJsZUhUTUwocGYsIGZpbHRlclEpewogICAgY29uc3QgZiA9IHBhcnNlRmlsdGVyKGZpbHRlclEpOwogICAgY29uc3Qgcm93c0FyciA9IFtdOwogICAgY29uc3QgdHhzID0gcGYudHJhbnNhY3Rpb25zOwogICAgZm9yKGNvbnN0IHQgb2YgdHhzKXsKICAgICAgaWYoZi50eXBlICYmIHQudHlwZSE9PWYudHlwZSkgY29udGludWU7CiAgICAgIGNvbnN0IHRleHRCbG9iID0gSlNPTi5zdHJpbmdpZnkodCkudG9Mb3dlckNhc2UoKTsKICAgICAgaWYoZi50ZXh0Py5sZW5ndGgpewogICAgICAgIGxldCBvayA9IHRydWU7CiAgICAgICAgZm9yKGNvbnN0IHdvcmQgb2YgZi50ZXh0KXsKICAgICAgICAgIGlmKCF0ZXh0QmxvYi5pbmNsdWRlcyh3b3JkKSl7IG9rPWZhbHNlOyBicmVhazsgfQogICAgICAgIH0KICAgICAgICBpZighb2spIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHJvd3NBcnIucHVzaCh0eFJvd0hUTUwocGYsIHQpKTsKICAgIH0KICAgIGNvbnN0IHJvd3NIVE1MID0gcm93c0Fyci5qb2luKCIiKSB8fCAnPHRyPjx0ZCBjb2xzcGFuPSIxMSIgY2xhc3M9ImNlbnRlciBtdXRlZCI+QnJhayBvcGVyYWNqaTwvdGQ+PC90cj4nOwogICAgY29uc3QgaCA9ICgKICAgICAgYDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPmArCiAgICAgICAgYDx0YWJsZT5gKwogICAgICAgICAgYDx0aGVhZD5gKwogICAgICAgICAgICBgPHRyPmArCiAgICAgICAgICAgICAgYDx0aD5EYXRhPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+VHlwPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+VGlja2VyPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+SWxvxZvEhzwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPkNlbmE8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5PcMWCYXR5PC90aD5gKwogICAgICAgICAgICAgIGA8dGg+R290w7N3a2EgwrE8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5aeXNrIGJydXR0bzwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPlBvZGF0ZWs8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5aeXNrIG5ldHRvPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+VXdhZ2k8L3RoPjx0aD5Ba2NqZTwvdGg+YCsKICAgICAgICAgICAgYDwvdHI+YCsKICAgICAgICAgIGA8L3RoZWFkPmArCiAgICAgICAgICBgPHRib2R5PmArIHJvd3NIVE1MICsgYDwvdGJvZHk+YCsKICAgICAgICBgPC90YWJsZT5gKwogICAgICBgPC9kaXY+YAogICAgKTsKICAgIHJldHVybiBoOwogIH0KCiAgZnVuY3Rpb24gdHhSb3dIVE1MKHBmLCB0KXsKICAgIGNvbnN0IGN1ciA9IHBmLmN1cnJlbmN5OwogICAgbGV0IGNhc2hEZWx0YSA9IDA7CiAgICBpZih0LnR5cGU9PT0iZGVwb3NpdCIpIGNhc2hEZWx0YSA9IHQuYW1vdW50OwogICAgaWYodC50eXBlPT09IndpdGhkcmF3IikgY2FzaERlbHRhID0gLXQuYW1vdW50OwogICAgaWYodC50eXBlPT09ImJ1eSIpIGNhc2hEZWx0YSA9IC0odC5xdHkqdC5wcmljZSArICh0LmZlZXN8fDApKTsKICAgIGlmKHQudHlwZT09PSJzZWxsIikgY2FzaERlbHRhID0gKHQucHJvY2VlZHMgfHwgdC5xdHkqdC5wcmljZSkgLSAodC5mZWVzfHwwKTsKICAgIGlmKHQudHlwZT09PSJ0cmFuc2Zlcl9pbiIpIGNhc2hEZWx0YSA9IHQuYW1vdW50OwogICAgaWYodC50eXBlPT09InRyYW5zZmVyX291dCIpIGNhc2hEZWx0YSA9IC10LmFtb3VudDsKCiAgICByZXR1cm4gYDx0ciBkYXRhLXR4PSIke3QuaWR9IiBjbGFzcz0idHgtcm93IiBzdHlsZT0iY3Vyc29yOnBvaW50ZXIiPgogICAgICA8dGQ+JHtfX2VzYyh0LmRhdGV8fCIiKX08L3RkPgogICAgICA8dGQ+JHttYXBUeXBlKHQudHlwZSl9PC90ZD4KICAgICAgPHRkIGNsYXNzPSJ0aWNrZXIiPiR7X19lc2ModC50aWNrZXJ8fCIiKX08L3RkPgogICAgICA8dGQ+JHt0LnF0eT9fX2ZtdE51bSh0LnF0eSk6IuKAlCJ9PC90ZD4KICAgICAgPHRkPiR7dC5wcmljZT9fX2dvX2ZtdEN1cnJlbmN5KHQucHJpY2UsIGN1cik6ICh0LmFtb3VudD9fX2dvX2ZtdEN1cnJlbmN5KHQuYW1vdW50LCBjdXIpOiLigJQiKX08L3RkPgogICAgICA8dGQ+JHt0LmZlZXM/X19nb19mbXRDdXJyZW5jeSh0LmZlZXMsIGN1cik6IuKAlCJ9PC90ZD4KICAgICAgPHRkPiR7X19nb19mbXRDdXJyZW5jeShjYXNoRGVsdGEsIGN1cil9PC90ZD4KICAgICAgPHRkIGNsYXNzPSIkeyh0Lmdyb3NzUEw/PzApPj0wID8gJ29rLXRleHQnOidkYW5nZXItdGV4dCd9Ij4ke3QuZ3Jvc3NQTCE9PXVuZGVmaW5lZD9fX2dvX2ZtdEN1cnJlbmN5KHQuZ3Jvc3NQTCwgY3VyKToi4oCUIn08L3RkPgogICAgICA8dGQ+JHt0LnRheCE9PXVuZGVmaW5lZD9fX2dvX2ZtdEN1cnJlbmN5KHQudGF4LCBjdXIpOiLigJQifTwvdGQ+CiAgICAgIDx0ZCBjbGFzcz0iJHsodC5uZXRQTD8/MCk+PTAgPyAnb2stdGV4dCc6J2Rhbmdlci10ZXh0J30iPiR7dC5uZXRQTCE9PXVuZGVmaW5lZD9fX2dvX2ZtdEN1cnJlbmN5KHQubmV0UEwsIGN1cik6IuKAlCJ9PC90ZD4KICAgICAgPHRkIGNsYXNzPSJub3RlIj4ke19fZXNjKHQubm90ZXx8IiIpfTwvdGQ+CiAgICAgIDx0ZD4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgdHgtZWRpdCIgZGF0YS10eD0iJHt0LmlkfSI+8J+TnTwvYnV0dG9uPgogICAgICAgICR7dC50eXBlPT09J2J1eSc/YDxidXR0b24gY2xhc3M9ImJ0biBvayB0eC1zZWxsLWZyb20tYnV5IiBkYXRhLXR4PSIke3QuaWR9Ij7wn5K4PC9idXR0b24+YDonJ30KICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZGFuZ2VyIHR4LWRlbCIgZGF0YS10eD0iJHt0LmlkfSI+4p2MPC9idXR0b24+CiAgICAgIDwvdGQ+CiAgICA8L3RyPmA7CiAgfQogIC8vIC0tIEludGVncml0eToga2VlcCB0cmFuc2FjdGlvbnMgYXJyYXkgdmFsaWQgJiBzb3J0ZWQgKGRlc2MgYnkgZGF0ZSkgLS0KICBmdW5jdGlvbiBlbnN1cmVUcmFuc2FjdGlvbnNDb2hlcmVudChwZil7CiAgICB0cnl7CiAgICAgIGlmKCFwZiB8fCAhQXJyYXkuaXNBcnJheShwZi50cmFuc2FjdGlvbnMpKSB7IHBmLnRyYW5zYWN0aW9ucyA9IFtdOyByZXR1cm47IH0KICAgICAgLy8gZHJvcCBudWxsL3VuZGVmaW5lZAogICAgICBwZi50cmFuc2FjdGlvbnMgPSBwZi50cmFuc2FjdGlvbnMuZmlsdGVyKHQgPT4gdCAmJiB0eXBlb2YgdCA9PT0gJ29iamVjdCcpOwogICAgICAvLyBub3JtYWxpemUgZGF0ZSBzdHJpbmdzIGFuZCBzb3J0IG5ld2VzdC1maXJzdAogICAgICBwZi50cmFuc2FjdGlvbnMuc29ydCgoYSxiKT0+ewogICAgICAgIGNvbnN0IGFkID0gRGF0ZS5wYXJzZShhLmRhdGUgfHwgJzE5NzAtMDEtMDEnKTsKICAgICAgICBjb25zdCBiZCA9IERhdGUucGFyc2UoYi5kYXRlIHx8ICcxOTcwLTAxLTAxJyk7CiAgICAgICAgcmV0dXJuIGJkIC0gYWQ7CiAgICAgIH0pOwogICAgfWNhdGNoKF8pe30KICB9CgogIC8vIC0tIFVJIGhlbHBlcjogc2hvdyB3YXJuaW5nIGJhbm5lciBvbmNlIHBlciBwYWdlIGxvYWQKICBsZXQgX190eFdhcm5TaG93biA9IGZhbHNlOwogIGZ1bmN0aW9uIG1heWJlV2FyblR4TG9zcyhwZil7CiAgICB0cnl7CiAgICAgIGlmKCFwZikgcmV0dXJuOwogICAgICBjb25zdCBLRVkgPSAnX190eENvdW50XycrcGYuaWQ7CiAgICAgIGNvbnN0IHByZXYgPSBOdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKSB8fCAnMCcpOwogICAgICBjb25zdCBjdXIgPSBBcnJheS5pc0FycmF5KHBmLnRyYW5zYWN0aW9ucykgPyBwZi50cmFuc2FjdGlvbnMubGVuZ3RoIDogMDsKICAgICAgLy8gSWYgaXQgbG9va3MgbGlrZSB3ZSBsb3N0IHRyYW5zYWN0aW9ucywgbnVkZ2UgdG8gdXNlIFVuZG8KICAgICAgaWYocHJldiAmJiBjdXIgPCBwcmV2ICYmICFfX3R4V2FyblNob3duKXsKICAgICAgICBfX3R4V2FyblNob3duID0gdHJ1ZTsKICAgICAgICBjb25zdCB3ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgdy5jbGFzc05hbWUgPSAnYmFubmVyIHdhcm4nOwogICAgICAgIHcuaW5uZXJIVE1MID0gJ+KaoO+4jyBXeWtyeXRvIHNwYWRlayBsaWN6YnkgdHJhbnNha2NqaSAoJytjdXIrJyB6ICcrcHJldisnKS4gPGJ1dHRvbiBjbGFzcz0iYnRuIHNtYWxsIiBpZD0idHhVbmRvTm93Ij5Db2ZuaWo8L2J1dHRvbj4nOwogICAgICAgIGNvbnN0IGhpc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlzdG9yeVBhbmVsJyk7CiAgICAgICAgKGhpc3Q/LnBhcmVudEVsZW1lbnQgfHwgZG9jdW1lbnQuYm9keSkuaW5zZXJ0QmVmb3JlKHcsIGhpc3QpOwogICAgICAgIGNvbnN0IGJ0biA9IHcucXVlcnlTZWxlY3RvcignI3R4VW5kb05vdycpOwogICAgICAgIGlmKGJ0bil7IGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IHRyeXsgdW5kbyh7bW9kZTondHgnfSk7IH1jYXRjaChfKXsgYWxlcnQoIlNwcsOzYnVqIHLEmWN6bmllIGtsaWtuxIXEhyBDb2ZuaWogKEN0cmwrWikiKTsgfSB9KTsgfQogICAgICAgIHNldFRpbWVvdXQoKCk9Pnsgdy5yZW1vdmUoKTsgfSwgMTIwMDApOwogICAgICB9CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEtFWSwgU3RyaW5nKGN1cikpOwogICAgfWNhdGNoKF8pe30KICB9CgoKICBmdW5jdGlvbiBtYXBUeXBlKHQpewogICAgcmV0dXJuIHsKICAgICAgZGVwb3NpdDoid3DFgmF0YSIsCiAgICAgIHdpdGhkcmF3OiJ3eXDFgmF0YSIsCiAgICAgIHRyYW5zZmVyX2luOiJwcnplbGV3IOKAlCBwcnp5Y2jDs2QiLAogICAgICB0cmFuc2Zlcl9vdXQ6InByemVsZXcg4oCUIHJvemNow7NkIiwKICAgICAgdHJhbnNmZXJfY29tcGFueV9pbjoidHJhbnNmZXIgc3DDs8WCa2kg4oCUIHByenljaMOzZCIsCiAgICB0cmFuc2Zlcl9jb21wYW55X291dDoidHJhbnNmZXIgc3DDs8WCa2kg4oCUIHJvemNow7NkIiwKICAgIGJ1eToiemFrdXAiLAogICAgICBzZWxsOiJzcHJ6ZWRhxbwiLAogICAgfVt0XSB8fCB0OwogIH0KCiAgZnVuY3Rpb24gdG9kYXkoKXsKICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc2xpY2UoMCwxMCk7CiAgfQoKICBmdW5jdGlvbiBfX2VzYyhzKXsKICAgIHJldHVybiAoc3x8IiIpLnJlcGxhY2UoL1smPD4iJ10vZywgbT0+ICh7JyYnOicmYW1wOycsJzwnOicmbHQ7JywnPic6JyZndDsnLCciJzonJnF1b3Q7JywiJyI6JyYjMzk7J31bbV0pKTsKICB9CiAgY29uc3QgUVVPVEVTID0ge307CmNvbnN0IENPTVBBTllfTkFNRVMgPSB7fTsgLy8gdGlja2VyIC0+IHtuYW1lLCB0c30KIC8vIHRpY2tlciAtPiB7cHJpY2UsIHRzfQogIGxldCBxdW90ZVRpbWVyID0gbnVsbDsKICBsZXQgaXNQb2xsaW5nUXVvdGVzID0gZmFsc2U7CmxldCBfX3BvbGxlclN0YXJ0ZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gc2V0UXVvdGUodGlja2VyLCBwcmljZSwgZXh0cmFzKXsKICB0cnl7CiAgICBjb25zdCBwcmV2ID0gUVVPVEVTW3RpY2tlcl0gfHwgewp9OwogICAgY29uc3QgbmV3UHJpY2UgPSBOdW1iZXIocHJpY2UpIHx8IG51bGw7CiAgICBjb25zdCBwcmV2UHJpY2UgPSAocHJldiAmJiB0eXBlb2YgcHJldi5wcmljZSAhPT0gJ3VuZGVmaW5lZCcpID8gcHJldi5wcmljZSA6IG51bGw7CiAgICBsZXQgdHJlbmQgPSBudWxsOwogICAgaWYobmV3UHJpY2UgIT0gbnVsbCAmJiBwcmV2UHJpY2UgIT0gbnVsbCl7CiAgICAgIHRyZW5kID0gKG5ld1ByaWNlID4gcHJldlByaWNlKSA/IDEgOiAobmV3UHJpY2UgPCBwcmV2UHJpY2UgPyAtMSA6IDApOwogICAgfQogICAgUVVPVEVTW3RpY2tlcl0gPSB7CiAgICAgIHByaWNlOiBuZXdQcmljZSwKICAgICAgcHJldlByaWNlOiBwcmV2UHJpY2UgPz8gbnVsbCwKICAgICAgdHJlbmQ6IHRyZW5kLAogICAgICB0czogRGF0ZS5ub3coKSwKICAgICAgcGM6IChleHRyYXMgJiYgZXh0cmFzLnBjICE9IG51bGwpID8gTnVtYmVyKGV4dHJhcy5wYykgOiAocHJldi5wYyA/PyBudWxsKSwKICAgICAgZHA6IChleHRyYXMgJiYgZXh0cmFzLmRwICE9IG51bGwpID8gTnVtYmVyKGV4dHJhcy5kcCkgOiAocHJldi5kcCA/PyBudWxsKSwKICAgICAgZDogIChleHRyYXMgJiYgZXh0cmFzLmQgICE9IG51bGwpID8gTnVtYmVyKGV4dHJhcy5kKSAgOiAocHJldi5kICA/PyBudWxsKSwKICAgIH07CiAgfWNhdGNoKF8pewogICAgUVVPVEVTW3RpY2tlcl0gPSB7IHByaWNlOiBOdW1iZXIocHJpY2UpfHxudWxsLCBwcmV2UHJpY2U6IG51bGwsIHRyZW5kOiBudWxsLCB0czogRGF0ZS5ub3coKSB9OwogIH0KICB0cnl7IGlmKHR5cGVvZiBtYXliZVNjYW5BbGFybXNHbG9iYWw9PT0nZnVuY3Rpb24nKSBtYXliZVNjYW5BbGFybXNHbG9iYWwoKTsgfWNhdGNoKF8peyB9Cn0KICBmdW5jdGlvbiBnZXRRdW90ZSh0aWNrZXIpewogIHJldHVybiBRVU9URVNbdGlja2VyXT8ucHJpY2UgPz8gbnVsbDsKfQoKZnVuY3Rpb24gc2V0Q29tcGFueU5hbWUodGlja2VyLCBuYW1lKXsKICB0cnl7CiAgICBpZighdGlja2VyIHx8ICFuYW1lKSByZXR1cm47CiAgICBjb25zdCB0ID0gU3RyaW5nKHRpY2tlcikudG9VcHBlckNhc2UoKTsKICAgIENPTVBBTllfTkFNRVNbdF0gPSB7bmFtZTogU3RyaW5nKG5hbWUpLCB0czogRGF0ZS5ub3coKX07CiAgfWNhdGNoKF8pe30KfQpmdW5jdGlvbiBnZXRDb21wYW55TmFtZSh0aWNrZXIpewogIHRyeXsKICAgIGNvbnN0IHQgPSBTdHJpbmcodGlja2VyKS50b1VwcGVyQ2FzZSgpOwogICAgcmV0dXJuIChDT01QQU5ZX05BTUVTW3RdICYmIENPTVBBTllfTkFNRVNbdF0ubmFtZSkgfHwgbnVsbDsKICB9Y2F0Y2goXyl7IHJldHVybiBudWxsOyB9Cn0KCgpmdW5jdGlvbiBnZXRRdW90ZVByZXZDbG9zZSh0aWNrZXIpewogIHJldHVybiBRVU9URVNbdGlja2VyXT8ucGMgPz8gbnVsbDsKfQpmdW5jdGlvbiBnZXRRdW90ZUNoYW5nZVBjdCh0aWNrZXIpewogIGNvbnN0IHEgPSBRVU9URVNbdGlja2VyXTsKICBpZighcSkgcmV0dXJuIG51bGw7CiAgaWYoTnVtYmVyLmlzRmluaXRlKHEuZHApKSByZXR1cm4gcS5kcDsKICBjb25zdCBjID0gcS5wcmljZSwgcGMgPSBxLnBjOwogIGlmKGMhPW51bGwgJiYgcGM+MCkgcmV0dXJuICgoYyAtIHBjKSAvIHBjKSAqIDEwMDsKICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBnZXRRdW90ZVRyZW5kKHRpY2tlcil7CiAgcmV0dXJuIFFVT1RFU1t0aWNrZXJdPy50cmVuZCA/PyBudWxsOwp9Cgpjb25zdCBmbXRQY3QgPSAoeCwgZD0yKT0+ICh4PT09bnVsbCB8fCB4PT09dW5kZWZpbmVkIHx8IGlzTmFOKE51bWJlcih4KSkpID8gIuKAlCIgOiAoKE51bWJlcih4KT49MD8iKyI6IiIpICsgTnVtYmVyKHgpLnRvRml4ZWQoZCkgKyAiJSIpOwogIGFzeW5jIGZ1bmN0aW9uIGZldGNoUXVvdGVGaW5uaHViKHRpY2tlciwgdG9rZW5PdmVycmlkZSl7CiAgY29uc3QgdG9rZW4gPSB0b2tlbk92ZXJyaWRlIHx8IERCLnNldHRpbmdzLmZpbm5odWJUb2tlbiB8fCAiIjsKICBpZighdG9rZW4peyByZXR1cm4ge3ByaWNlOm51bGwsIGVycm9yOidCcmFrIHRva2VudSAo4pqZ77iPIFVzdGF3aWVuaWEpJ307IH0KICB0cnl7CiAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9maW5uaHViLmlvL2FwaS92MS9xdW90ZT9zeW1ib2w9JHtlbmNvZGVVUklDb21wb25lbnQodGlja2VyKX0mdG9rZW49JHtlbmNvZGVVUklDb21wb25lbnQodG9rZW4pfWA7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgY29uc3QgaiA9IGF3YWl0IHJlcy5qc29uKCkuY2F0Y2goKCk9Pih7fSkpOwogICAgY29uc3QgZXJyID0gaiAmJiBqLmVycm9yID8gai5lcnJvciA6ICghcmVzLm9rID8gKCdIVFRQICcrcmVzLnN0YXR1cykgOiBudWxsKTsKICAgIGNvbnN0IHAgPSAoaiAmJiAoai5jID8/IGoucGMpKSA/PyBudWxsOwogICAgaWYocCE9bnVsbCkgc2V0UXVvdGUodGlja2VyLCBwLCB7IHBjOiBqPy5wYywgZHA6IGo/LmRwLCBkOiBqPy5kIH0pOwogICAgcmV0dXJuIHtwcmljZTogcCwgZXJyb3I6IGVycn07CiAgfWNhdGNoKGUpeyByZXR1cm4ge3ByaWNlOm51bGwsIGVycm9yOiBlLm1lc3NhZ2V8fCdGZXRjaCBlcnJvcid9OyB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGZldGNoQ29tcGFueVByb2ZpbGUodGlja2VyLCB0b2tlbk92ZXJyaWRlKXsKICBjb25zdCB0b2tlbiA9IHRva2VuT3ZlcnJpZGUgfHwgKERCICYmIERCLnNldHRpbmdzICYmIERCLnNldHRpbmdzLmZpbm5odWJUb2tlbikgfHwgIiI7CiAgaWYoIXRva2VuKXsgcmV0dXJuIHtuYW1lOm51bGwsIGVycm9yOidCcmFrIHRva2VudSd9OyB9CiAgdHJ5ewogICAgY29uc3QgdXJsID0gYGh0dHBzOi8vZmlubmh1Yi5pby9hcGkvdjEvc3RvY2svcHJvZmlsZTI/c3ltYm9sPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHRpY2tlcil9JnRva2VuPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHRva2VuKX1gOwogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsKTsKICAgIGNvbnN0IGogPSBhd2FpdCByZXMuanNvbigpLmNhdGNoKCgpPT4oe30pKTsKICAgIGNvbnN0IGVyciA9IGogJiYgai5lcnJvciA/IGouZXJyb3IgOiAoIXJlcy5vayA/ICgnSFRUUCAnK3Jlcy5zdGF0dXMpIDogbnVsbCk7CiAgICBjb25zdCBuYW1lID0gKGogJiYgai5uYW1lKSB8fCBudWxsOwogICAgcmV0dXJuIHtuYW1lLCBlcnJvcjogZXJyfTsKICB9Y2F0Y2goZSl7IHJldHVybiB7bmFtZTpudWxsLCBlcnJvcjogZSAmJiBlLm1lc3NhZ2UgfHwgJ0ZldGNoIGVycm9yJ307IH0KfQoKCgogIGFzeW5jIGZ1bmN0aW9uIHNlYXJjaFN5bWJvbEZpbm5odWIocXVlcnkpewogIGNvbnN0IHRva2VuID0gKERCICYmIERCLnNldHRpbmdzICYmIERCLnNldHRpbmdzLmZpbm5odWJUb2tlbldpc2hsaXN0KSB8fCAoREIgJiYgREIuc2V0dGluZ3MgJiYgREIuc2V0dGluZ3MuZmlubmh1YlRva2VuKSB8fCAnJzsKICBpZighdG9rZW4peyByZXR1cm4ge3Jlc3VsdDpbXSwgZXJyb3I6J0JyYWsgdG9rZW51ICjimpnvuI8gVXN0YXdpZW5pYSknfTsgfQogIHRyeXsKICAgIGNvbnN0IHVybCA9IGBodHRwczovL2Zpbm5odWIuaW8vYXBpL3YxL3NlYXJjaD9xPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHF1ZXJ5KX0mdG9rZW49JHtlbmNvZGVVUklDb21wb25lbnQodG9rZW4pfWA7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgY29uc3QgaiA9IGF3YWl0IHJlcy5qc29uKCkuY2F0Y2goKCk9Pih7fSkpOwogICAgY29uc3QgZXJyID0gaiAmJiBqLmVycm9yID8gai5lcnJvciA6ICghcmVzLm9rID8gKCdIVFRQICcrcmVzLnN0YXR1cykgOiBudWxsKTsKICAgIGNvbnN0IGFyciA9IEFycmF5LmlzQXJyYXkoai5yZXN1bHQpID8gai5yZXN1bHQgOiBbXTsKICAgIGFyci5mb3JFYWNoKGl0ZW0gPT4gewogICAgICBpZihpdGVtICYmIGl0ZW0uc3ltYm9sICYmIGl0ZW0uZGVzY3JpcHRpb24pewogICAgICAgIHNldENvbXBhbnlOYW1lKFN0cmluZyhpdGVtLnN5bWJvbCkudG9VcHBlckNhc2UoKSwgaXRlbS5kZXNjcmlwdGlvbik7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHtyZXN1bHQ6IGFyciwgZXJyb3I6IGVycn07CiAgfWNhdGNoKGUpeyByZXR1cm4ge3Jlc3VsdDpbXSwgZXJyb3I6IGUgJiYgZS5tZXNzYWdlIHx8ICdTZWFyY2ggZXJyb3InfTsgfQp9CgogIC8vIEhlbHBlciBmdW5jdGlvbiBmb3IgYSBzaW5nbGUsIHJhdGUtbGltaXRlZCBmZXRjaCBsb29wCmFzeW5jIGZ1bmN0aW9uIHJ1blNlcXVlbnRpYWxGZXRjaGVzKHRpY2tlcnMsIHRva2VuLCBkZWxheU1zID0gMTIwMCkgewogICAgaWYgKCF0b2tlbiB8fCAhdGlja2Vycy5sZW5ndGgpIHsKICAgICAgICByZXR1cm47IC8vIE5vdGhpbmcgdG8gZG8KICAgIH0KICAgIGNvbnN0IHVuaXF1ZVRpY2tlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQodGlja2VycykpOwoKICAgIGZvciAoY29uc3QgdCBvZiB1bmlxdWVUaWNrZXJzKSB7CiAgICAgICAgLy8gUGFzcyB0aGUgc3BlY2lmaWMgdG9rZW4gdG8gdGhlIGZldGNoIGZ1bmN0aW9ucwogICAgICAgIGF3YWl0IGZldGNoUXVvdGVGaW5uaHViKHQsIHRva2VuKTsgCgogICAgICAgIGlmICghQ09NUEFOWV9OQU1FU1t0XSB8fCAoRGF0ZS5ub3coKSAtIENPTVBBTllfTkFNRVNbdF0udHMgPiA3ICogMjQgKiA2MCAqIDYwICogMTAwMCkpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBmZXRjaENvbXBhbnlQcm9maWxlKHQsIHRva2VuKTsgCiAgICAgICAgICAgICAgICBpZiAocHJvZmlsZSAmJiBwcm9maWxlLm5hbWUpIHNldENvbXBhbnlOYW1lKHQsIHByb2ZpbGUubmFtZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgfQogICAgICAgIC8vIFphY2hvd3VqZW15IG9yeWdpbmFsbmUgb3DDs8W6bmllbmllIDEuMnMsIGFieSBuaWUgcHJ6ZWtyb2N6ecSHIGxpbWl0dSA2MC9taW4gZGxhIEpFRE5FR08ga2x1Y3phCiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIGRlbGF5TXMpKTsgCiAgICB9Cn0KCmZ1bmN0aW9uIHN0YXJ0UG9sbGluZ1F1b3RlcygpewogIGlmKF9fcG9sbGVyU3RhcnRlZCl7IHJldHVybjsgfSBfX3BvbGxlclN0YXJ0ZWQgPSB0cnVlOwogIGxldCBzZWNzID0gTnVtYmVyKERCLnNldHRpbmdzLnByaWNlUG9sbFNlY29uZHMpfHwzMDsKICBpZihzZWNzIDwgMTApIHNlY3MgPSAxMDsKICBpZihxdW90ZVRpbWVyKSBjbGVhckludGVydmFsKHF1b3RlVGltZXIpOwoKICBjb25zdCBkb1BvbGwgPSBhc3luYyAoKT0+ewogICAgaWYgKGlzUG9sbGluZ1F1b3RlcykgcmV0dXJuOwogICAgaXNQb2xsaW5nUXVvdGVzID0gdHJ1ZTsKICAgIHRyeSB7CiAgICAgICAgLy8gMS4gUG9kemllbCB0aWNrZXJ5IG5hIGR3aWUgZ3J1cHkKICAgICAgICBjb25zdCBwb3J0Zm9saW9UaWNrZXJzID0gQXJyYXkuZnJvbShuZXcgU2V0KAogICAgICAgICAgICBEQi5wb3J0Zm9saW9zLmZsYXRNYXAocGYgPT4gT2JqZWN0LmtleXMocGYuaG9sZGluZ3MgfHwge30pKQogICAgICAgICkpOwogICAgICAgIGNvbnN0IHdpc2hsaXN0VGlja2VycyA9IEFycmF5LmZyb20obmV3IFNldCgKICAgICAgICAgICAgKERCLndhdGNobGlzdCB8fCBbXSkubWFwKHcgPT4gKHcudGlja2VyIHx8ICIiKS50b1VwcGVyQ2FzZSgpKQogICAgICAgICkpOwoKICAgICAgICAvLyAyLiBQb2JpZXJ6IG9iYSBrbHVjemUKICAgICAgICBjb25zdCB0b2tlblBvcnRmb2xpbyA9IERCLnNldHRpbmdzLmZpbm5odWJUb2tlbiB8fCAiIjsKICAgICAgICBjb25zdCB0b2tlbldpc2hsaXN0ID0gREIuc2V0dGluZ3MuZmlubmh1YlRva2VuV2lzaGxpc3QgfHwgIiI7CgogICAgICAgIC8vIE9yeWdpbmFsbmUgb3DDs8W6bmllbmllIDEuMnMgKDEyMDBtcykgeiBUd29qZWdvIGtvZHUKICAgICAgICBjb25zdCBkZWxheSA9IDEyMDA7IAoKICAgICAgICAvLyAzLiBaZGVjeWR1aiBvIHRyeWJpZSB3eWtvbmFuaWEKICAgICAgICBpZiAodG9rZW5XaXNobGlzdCAmJiB0b2tlbldpc2hsaXN0ICE9PSB0b2tlblBvcnRmb2xpbykgewogICAgICAgICAgICAvLyAtLS0gVFJZQiBSw5NXTk9MRUfFgVkgLS0tCiAgICAgICAgICAgIC8vIE1hbXkgZHdhIHLDs8W8bmUga2x1Y3plLiBVcnVjaGFtaWFteSBkd2llIHDEmXRsZSBmZXRjaCB3IHR5bSBzYW15bSBjemFzaWUuCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGaW5uaHViOiBVcnVjaGFtaWFtIDIgcsOzd25vbGVnxYJlIHDEmXRsZSBvZMWbd2llxbxhbmlhIChQb3J0ZmVsICsgV2lzaGxpc3RhKSIpOwogICAgICAgICAgICBjb25zdCBwb3J0Zm9saW9UYXNrID0gcnVuU2VxdWVudGlhbEZldGNoZXMocG9ydGZvbGlvVGlja2VycywgdG9rZW5Qb3J0Zm9saW8sIGRlbGF5KTsKICAgICAgICAgICAgY29uc3Qgd2lzaGxpc3RUYXNrID0gcnVuU2VxdWVudGlhbEZldGNoZXMod2lzaGxpc3RUaWNrZXJzLCB0b2tlbldpc2hsaXN0LCBkZWxheSk7CgogICAgICAgICAgICAvLyBDemVrYW15IG5hIHpha2/FhGN6ZW5pZSBvYnUKICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW3BvcnRmb2xpb1Rhc2ssIHdpc2hsaXN0VGFza10pOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyAtLS0gVFJZQiBTRUtXRU5DWUpOWSAtLS0KICAgICAgICAgICAgLy8gTWFteSB0eWxrbyBqZWRlbiBrbHVjeiAobHViIHRlbiBzYW0gdyBvYnUgcG9sYWNoKS4KICAgICAgICAgICAgLy8gVcW8eXdhbXkgamVkbmVnbyBrbHVjemEgZGxhIHdzenlzdGtpY2ggdGlja2Vyw7N3IHcgamVkbmVqIHDEmXRsaS4KICAgICAgICAgICAgY29uc29sZS5sb2coIkZpbm5odWI6IFVydWNoYW1pYW0gMSBzZWt3ZW5jeWpuxIUgcMSZdGzEmSBvZMWbd2llxbxhbmlhIChXc3DDs2xueSBrbHVjeikiKTsKICAgICAgICAgICAgY29uc3QgdG9rZW5Ub1VzZSA9IHRva2VuUG9ydGZvbGlvIHx8IHRva2VuV2lzaGxpc3Q7IC8vIFXFvHlqIGt0w7NyZWdva29sd2llaywga3TDs3J5IGlzdG5pZWplCgogICAgICAgICAgICAvLyDFgcSFY3p5bXkgd3N6eXN0a2llIHRpY2tlcnkgdyBqZWRuxIUgbGlzdMSZCiAgICAgICAgICAgIGNvbnN0IGFsbFRpY2tlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQoWy4uLnBvcnRmb2xpb1RpY2tlcnMsIC4uLndpc2hsaXN0VGlja2Vyc10pKTsKCiAgICAgICAgICAgIGF3YWl0IHJ1blNlcXVlbnRpYWxGZXRjaGVzKGFsbFRpY2tlcnMsIHRva2VuVG9Vc2UsIGRlbGF5KTsKICAgICAgICB9CgogICAgICAgIC8vIDQuIFdzenlzdGtpZSBwb2JyYW5pYSB6YWtvxYRjem9uZSwgcmVuZGVydWogKGxvZ2lrYSBqYWsgd2N6ZcWbbmllaikKICAgICAgICB3aW5kb3cuX19sYXN0QXBpUmVmcmVzaEF0ID0gRGF0ZS5ub3coKTsgCiAgICAgICAgdHJ5eyBpZih3aW5kb3cuc2V0QXBpVGltZSkgd2luZG93LnNldEFwaVRpbWUod2luZG93Ll9fbGFzdEFwaVJlZnJlc2hBdCk7IH1jYXRjaChfKXt9CiAgICAgICAgdHJ5IHsgcmVuZGVyTWFpbigpOyB9IGNhdGNoKGUpIHt9CiAgICAgICAgdHJ5IHsgcmVuZGVyV2lzaGxpc3QoKTsgfSBjYXRjaChlKSB7fQogICAgICAgIHRyeSB7IHVwZGF0ZVNpZGViYXJCbGlua1N0YXRlcygpOyB9IGNhdGNoKGUpIHt9CiAgICAgICAgdHJ5IHsgdXBkYXRlV2lzaGxpc3RCbGlua1N0YXRlKCk7IH0gY2F0Y2goZSkge30KICAgICAgICB0cnkgeyBjaGVja0FuZFBsYXlQb3J0Zm9saW9BbGVydHMoKTsgY2hlY2tBbmRQbGF5V2lzaGxpc3RBbGVydCgpOyB9IGNhdGNoKGUpIHt9CgogICAgfSBmaW5hbGx5IHsKICAgICAgaXNQb2xsaW5nUXVvdGVzID0gZmFsc2U7CiAgICB9CiAgfTsKCiAgZG9Qb2xsKCk7IC8vIFVydWNob20gbmF0eWNobWlhc3QKICBxdW90ZVRpbWVyID0gc2V0SW50ZXJ2YWwoZG9Qb2xsLCBzZWNzKjEwMDApOyAvLyBJIHVzdGF3IGludGVyd2HFggp9CgogIGZ1bmN0aW9uIGNvbXB1dGVUYXJnZXRQcmljZShsb3QpewogICAgLy8gU3ByemVkYcW8ICh0YWtlLXByb2ZpdCkKICAgIGlmKGxvdD8udGFyZ2V0UHJpY2UgJiYgTnVtYmVyKGxvdC50YXJnZXRQcmljZSk+MCkgcmV0dXJuIE51bWJlcihsb3QudGFyZ2V0UHJpY2UpOwogICAgaWYobG90Py50YXJnZXRQY3QgJiYgTnVtYmVyKGxvdC50YXJnZXRQY3QpIT0wKXsKICAgICAgcmV0dXJuIE51bWJlcihsb3QudW5pdENvc3QpICogKDEgKyBOdW1iZXIobG90LnRhcmdldFBjdCkvMTAwKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KCiAgZnVuY3Rpb24gY29tcHV0ZUJ1eVRhcmdldFByaWNlKGxvdCl7CiAgICBpZihsb3Q/LmJ1eVRhcmdldFByaWNlICYmIE51bWJlcihsb3QuYnV5VGFyZ2V0UHJpY2UpPjApIHJldHVybiBOdW1iZXIobG90LmJ1eVRhcmdldFByaWNlKTsKICAgIGlmKGxvdD8uYnV5VGFyZ2V0UGN0ICYmIE51bWJlcihsb3QuYnV5VGFyZ2V0UGN0KSE9MCl7CiAgICAgIHJldHVybiBOdW1iZXIobG90LnVuaXRDb3N0KSAqICgxIC0gTnVtYmVyKGxvdC5idXlUYXJnZXRQY3QpLzEwMCk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgpmdW5jdGlvbiB0YXJnZXRTdGF0dXMobG90KXsgaWYobG90ICYmIGxvdC5tdXRlZCkgcmV0dXJuIHtzdGF0ZTonbm9uZSd9OyAKICBjb25zdCBwcmljZSA9IGdldFF1b3RlKGxvdC5fdGlja2VyfHwiIik7CiAgY29uc3Qgc2VsbFQgPSBjb21wdXRlVGFyZ2V0UHJpY2UobG90KTsKICBjb25zdCBidXlUICA9IGNvbXB1dGVCdXlUYXJnZXRQcmljZShsb3QpOwogIGlmKHByaWNlPT1udWxsKSByZXR1cm4ge3N0YXRlOiJub25lIn07CiAgY29uc3QgdG9sID0gKE51bWJlcihEQi5zZXR0aW5ncy5hcHByb2FjaFRvbGVyYW5jZVBjdCl8fDEpLzEwMDsgLy8gbnAuIDElCgogIGNvbnN0IGNhbmQgPSBbXTsKCiAgaWYoc2VsbFQhPW51bGwpewogICAgaWYocHJpY2UgPj0gc2VsbFQpIGNhbmQucHVzaCh7c3RhdGU6ImhpdCIsIGtpbmQ6InNlbGwiLCBwcmljZSwgdGFyZ2V0OnNlbGxUfSk7CiAgICBlbHNlIGlmKHByaWNlID49IHNlbGxUKigxIC0gdG9sKSkgY2FuZC5wdXNoKHtzdGF0ZToibmVhciIsIGtpbmQ6InNlbGwiLCBwcmljZSwgdGFyZ2V0OnNlbGxUfSk7CiAgICBlbHNlIGNhbmQucHVzaCh7c3RhdGU6ImZhciIsIGtpbmQ6InNlbGwiLCBwcmljZSwgdGFyZ2V0OnNlbGxUfSk7CiAgfQoKICBpZihidXlUIT1udWxsKXsKICAgIGlmKHByaWNlIDw9IGJ1eVQpIGNhbmQucHVzaCh7c3RhdGU6ImhpdCIsIGtpbmQ6ImJ1eSIsIHByaWNlLCB0YXJnZXQ6YnV5VH0pOwogICAgZWxzZSBpZihwcmljZSA8PSBidXlUKigxICsgdG9sKSkgY2FuZC5wdXNoKHtzdGF0ZToibmVhciIsIGtpbmQ6ImJ1eSIsIHByaWNlLCB0YXJnZXQ6YnV5VH0pOwogICAgZWxzZSBjYW5kLnB1c2goe3N0YXRlOiJmYXIiLCBraW5kOiJidXkiLCBwcmljZSwgdGFyZ2V0OmJ1eVR9KTsKICB9CgogIGlmKGNhbmQubGVuZ3RoPT09MCkgcmV0dXJuIHtzdGF0ZToibm9uZSJ9OwoKICBjb25zdCBwcmlvID0geyAiaGl0IjowLCAibmVhciI6MSwgImZhciI6MiB9OwogIGNhbmQuc29ydCgoYSxiKT0+ewogICAgaWYocHJpb1thLnN0YXRlXSE9PXByaW9bYi5zdGF0ZV0pIHJldHVybiBwcmlvW2Euc3RhdGVdLXByaW9bYi5zdGF0ZV07CiAgICBjb25zdCBkYSA9IE1hdGguYWJzKChwcmljZSAtIGEudGFyZ2V0KS9hLnRhcmdldCk7CiAgICBjb25zdCBkYiA9IE1hdGguYWJzKChwcmljZSAtIGIudGFyZ2V0KS9iLnRhcmdldCk7CiAgICByZXR1cm4gZGEgLSBkYjsKICB9KTsKICByZXR1cm4gY2FuZFswXTsKfQoKICAvLyBDb21wdXRlIHBvcnRmb2xpby1sZXZlbCBhbGVydCBzdGF0ZSBiYXNlZCBvbiBjdXJyZW50IHF1b3RlcyBhbmQgbG90IHRhcmdldHMKICBmdW5jdGlvbiBwb3J0Zm9saW9UYXJnZXRTdGF0ZShwZil7CiAgLy8gcmV0dXJucyB7c3RhdGU6ICJoaXQifCJuZWFyInwibm9uZSIsIGtpbmQ6ICJzZWxsInwiYnV5InxudWxsfQogIGxldCBoaXRTZWxsPWZhbHNlLCBoaXRCdXk9ZmFsc2UsIG5lYXJTZWxsPWZhbHNlLCBuZWFyQnV5PWZhbHNlOwogIGNvbnN0IHRvbCA9IChOdW1iZXIoREIuc2V0dGluZ3MuYXBwcm9hY2hUb2xlcmFuY2VQY3QpfHwxKS8xMDA7CiAgZm9yKGNvbnN0IFt0aWNrZXIsIGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHBmLmhvbGRpbmdzfHx7fSkpewogICAgY29uc3QgbG90cyA9IGJvb2s/LmxvdHMgfHwgW107CiAgICBjb25zdCBwcmljZSA9IGdldFF1b3RlKHRpY2tlcik7CiAgICBpZihwcmljZT09bnVsbCkgY29udGludWU7CiAgICBmb3IoY29uc3QgbCBvZiBsb3RzKXsKICAgICAgY29uc3Qgc2VsbFQgPSBjb21wdXRlVGFyZ2V0UHJpY2UobCk7CiAgICAgIGNvbnN0IGJ1eVQgID0gY29tcHV0ZUJ1eVRhcmdldFByaWNlKGwpOwogICAgICBpZihzZWxsVCE9bnVsbCl7CiAgICAgICAgaWYgKHByaWNlID49IHNlbGxUICYmICEobCAmJiBsLm11dGVkKSkgeyBoaXRTZWxsID0gdHJ1ZTsgYnJlYWs7IH0KICAgICAgICBpZihwcmljZSA+PSBzZWxsVCooMSAtIHRvbCkgJiYgIShsICYmIGwubXV0ZWQpKSBuZWFyU2VsbCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYoYnV5VCE9bnVsbCl7CiAgICAgICAgaWYgKHByaWNlIDw9IGJ1eVQgJiYgIShsICYmIGwubXV0ZWQpKSB7IGhpdEJ1eSA9IHRydWU7IGJyZWFrOyB9CiAgICAgICAgaWYocHJpY2UgPD0gYnV5VCooMSArIHRvbCkgJiYgIShsICYmIGwubXV0ZWQpKSBuZWFyQnV5ID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgaWYoaGl0U2VsbCB8fCBoaXRCdXkpIGJyZWFrOwogIH0KICBpZihoaXRTZWxsKSByZXR1cm4ge3N0YXRlOiJoaXQiLCAga2luZDoic2VsbCJ9OwogIGlmKGhpdEJ1eSkgIHJldHVybiB7c3RhdGU6ImhpdCIsICBraW5kOiJidXkifTsKICBpZihuZWFyU2VsbCkgcmV0dXJuIHtzdGF0ZToibmVhciIsIGtpbmQ6InNlbGwifTsKICBpZihuZWFyQnV5KSAgcmV0dXJuIHtzdGF0ZToibmVhciIsIGtpbmQ6ImJ1eSJ9OwogIHJldHVybiB7c3RhdGU6Im5vbmUiLCBraW5kOm51bGx9Owp9CgoKZnVuY3Rpb24gdXBkYXRlU2lkZWJhckJsaW5rU3RhdGVzKCl7CiAgLy8gQ2xlYXIgcHJldmlvdXMgYmxpbmtpbmcgY2xhc3NlcyBvbiBhbGwgc2lkZWJhciBpdGVtcwogIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5wb3J0Zm9saW8taXRlbScpLmZvckVhY2goZWw9PnsKICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ2hpdC10YXJnZXQnLCduZWFyLXRhcmdldCcsJ2hpdC10YXJnZXQtc2VsbCcsJ25lYXItdGFyZ2V0LXNlbGwnLCdoaXQtdGFyZ2V0LWJ1eScsJ25lYXItdGFyZ2V0LWJ1eScpOwogIH0pOwogIC8vIEZvciBlYWNoIHBvcnRmb2xpbywgYWRkIGJsaW5rIG9ubHkgaWYgdGhlcmUncyBhdCBsZWFzdCBvbmUgTk9OLUFDS0VEIHRpY2tlciB3aXRoIGhpdC9uZWFyCiAgZm9yKGNvbnN0IHBmIG9mICgodHlwZW9mIFNUIT09J3VuZGVmaW5lZCcgJiYgU1QuREIgJiYgQXJyYXkuaXNBcnJheShTVC5EQi5wb3J0Zm9saW9zKSkgPyBTVC5EQi5wb3J0Zm9saW9zIDogKCh0eXBlb2YgREIhPT0ndW5kZWZpbmVkJyAmJiBBcnJheS5pc0FycmF5KERCLnBvcnRmb2xpb3MpKSA/IERCLnBvcnRmb2xpb3MgOiBbXSkpKXsKICAgIGNvbnN0IGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLnBvcnRmb2xpby1pdGVtW2RhdGEtcGYtaWQ9IiR7cGYuaWR9Il1gKTsKICAgIGlmKCFlbCkgY29udGludWU7CiAgICBsZXQgcGZTdGF0ZSA9IG51bGw7CiAgICB0cnl7CiAgICAgIGZvcihjb25zdCBbdGlja2VyLCBib29rXSBvZiBPYmplY3QuZW50cmllcyhwZi5ob2xkaW5nc3x8e30pKXsKICAgICAgICBjb25zdCBsb3RzID0gYm9vay5sb3RzfHxbXTsKICAgICAgICBsZXQgcmFuaz0tMSwgc3RhdGU9J25vbmUnLCBraW5kPW51bGw7CiAgICAgICAgZm9yKGNvbnN0IGwgb2YgbG90cyl7CiAgICAgICAgICBsLl90aWNrZXIgPSB0aWNrZXI7CiAgICAgICAgICBjb25zdCBzdCA9IHRhcmdldFN0YXR1cyhsKTsKICAgICAgICAgIGNvbnN0IHIgPSBzdC5zdGF0ZT09PSJoaXQiID8gKHN0LmtpbmQ9PT0ic2VsbCI/MzoyKSA6IChzdC5zdGF0ZT09PSJuZWFyIiA/IChzdC5raW5kPT09InNlbGwiPzE6MCkgOiAtMSk7CiAgICAgICAgICBpZihyPnJhbmspeyByYW5rPXI7IHN0YXRlPXN0LnN0YXRlOyBraW5kPXN0LmtpbmQ7IH0KICAgICAgICB9CiAgICAgICAgaWYocmFuaz49MCAmJiAoc3RhdGU9PT0naGl0JyB8fCBzdGF0ZT09PSduZWFyJykgJiYga2luZCAmJiAhaXNBbGVydEFja2VkKHRpY2tlciwga2luZCwgc3RhdGUpKXsKICAgICAgICAgIHBmU3RhdGUgPSB7c3RhdGUsIGtpbmR9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9Y2F0Y2goXyl7fQogICAgaWYocGZTdGF0ZSl7CiAgICAgIGlmKHBmU3RhdGUuc3RhdGUgPT09ICJoaXQiKSBlbC5jbGFzc0xpc3QuYWRkKHBmU3RhdGUua2luZD09PSJzZWxsIj8naGl0LXRhcmdldC1zZWxsJzonaGl0LXRhcmdldC1idXknKTsKICAgICAgZWxzZSBpZihwZlN0YXRlLnN0YXRlID09PSAibmVhciIpIGVsLmNsYXNzTGlzdC5hZGQocGZTdGF0ZS5raW5kPT09InNlbGwiPyduZWFyLXRhcmdldC1zZWxsJzonbmVhci10YXJnZXQtYnV5Jyk7CiAgICB9CiAgfQp9CgoKCgogIAogIC8vID09PSBTb3VuZCBBbGVydHMgRW5naW5lID09PQooZnVuY3Rpb24oKXsKICBsZXQgX19hdWRpbyA9IHsgY3R4OiBudWxsLCB1bmxvY2tlZDogZmFsc2UgfTsKICBsZXQgX19sYXN0UG9ydGZvbGlvU2lnID0gJ25vbmUnOwogIGxldCBfX2xhc3RXaXNobGlzdFNpZyA9ICdub25lJzsKICBsZXQgX19sYXN0UG9ydGZvbGlvQmVlcCA9IDA7CiAgbGV0IF9fbGFzdFdpc2hsaXN0QmVlcCA9IDA7CiAgZnVuY3Rpb24gX19yZXBlYXRNcygpeyByZXR1cm4gTWF0aC5tYXgoNTAwMCwgTnVtYmVyKERCPy5zZXR0aW5ncz8uc291bmRSZXBlYXRTZWNvbmRzID8/IDYwKSAqIDEwMDApOyB9CgogIGZ1bmN0aW9uIF9fZ2V0U291bmRWb2x1bWVQY3QoKXsKICAgIHRyeSB7IHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigxMDAsIE51bWJlcihEQj8uc2V0dGluZ3M/LnNvdW5kVm9sdW1lID8/IDQwKSkpOyB9CiAgICBjYXRjaChfKSB7IHJldHVybiA0MDsgfQogIH0KICBmdW5jdGlvbiBfX2dhaW5Gcm9tVm9sKG11bHQpeyBjb25zdCBiYXNlID0gKF9fZ2V0U291bmRWb2x1bWVQY3QoKS8xMDApOyByZXR1cm4gTWF0aC5tYXgoMC4wMDA1LCBNYXRoLm1pbigxLjAsIGJhc2UgKiAwLjIwICogKG11bHR8fDEpKSk7IH0KCiAgZnVuY3Rpb24gZW5zdXJlQXVkaW8oKXsKICAgIHRyeXsKICAgICAgaWYoIV9fYXVkaW8uY3R4KXsKICAgICAgICBjb25zdCBBQyA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICBpZighQUMpIHJldHVybiBudWxsOwogICAgICAgIF9fYXVkaW8uY3R4ID0gbmV3IEFDKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIF9fYXVkaW8uY3R4OwogICAgfWNhdGNoKGUpeyByZXR1cm4gbnVsbDsgfQogIH0KCiAgZnVuY3Rpb24gdW5sb2NrQXVkaW8oKXsKICAgIGNvbnN0IGN0eCA9IGVuc3VyZUF1ZGlvKCk7CiAgICBpZighY3R4KSByZXR1cm47CiAgICBpZihjdHguc3RhdGUgPT09ICdzdXNwZW5kZWQnKXsKICAgICAgY3R4LnJlc3VtZSgpLmNhdGNoKCgpPT57fSkudGhlbigoKT0+eyBfX2F1ZGlvLnVubG9ja2VkID0gdHJ1ZTsgfSk7CiAgICB9ZWxzZXsKICAgICAgX19hdWRpby51bmxvY2tlZCA9IHRydWU7CiAgICB9CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCB1bmxvY2tBdWRpbyk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHVubG9ja0F1ZGlvKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHVubG9ja0F1ZGlvKTsKICB9CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgdW5sb2NrQXVkaW8sIHsgb25jZTpmYWxzZSwgY2FwdHVyZTp0cnVlIH0pOwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdW5sb2NrQXVkaW8sIHsgb25jZTpmYWxzZSwgY2FwdHVyZTp0cnVlIH0pOwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHVubG9ja0F1ZGlvLCB7IG9uY2U6ZmFsc2UsIGNhcHR1cmU6dHJ1ZSB9KTsKCgovLyA9PT0gV2ViIEF1ZGlvIHVubG9jayBoZWxwZXIgdG8gY29tcGx5IHdpdGggQ2hyb21lIGF1dG9wbGF5IHBvbGljeSA9PT0KKGZ1bmN0aW9uKCl7CiAgdHJ5ewogICAgaWYoIXdpbmRvdy5fX0FVRElPKXsKICAgICAgd2luZG93Ll9fQVVESU8gPSB7IGN0eDogbnVsbCwgdW5sb2NrZWQ6IGZhbHNlLCBxdWV1ZTogW10gfTsKICAgIH0KICAgIGZ1bmN0aW9uIF9fcmVzdW1lQXVkaW8oKXsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IEEgPSB3aW5kb3cuX19BVURJTzsKICAgICAgICBpZighQS5jdHgpewogICAgICAgICAgY29uc3QgQ3R4ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgICAgaWYoIUN0eCkgcmV0dXJuOwogICAgICAgICAgQS5jdHggPSBuZXcgQ3R4KCk7CiAgICAgICAgfQogICAgICAgIEEuY3R4LnJlc3VtZSgpLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgICAgIEEudW5sb2NrZWQgPSAoQS5jdHggJiYgQS5jdHguc3RhdGUgPT09ICdydW5uaW5nJyk7CiAgICAgICAgICBpZihBLnVubG9ja2VkKXsKICAgICAgICAgICAgWydwb2ludGVyZG93bicsJ3RvdWNoc3RhcnQnLCdjbGljaycsJ2tleWRvd24nXS5mb3JFYWNoKGZ1bmN0aW9uKGV2KXsKICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2LCBfX3Jlc3VtZUF1ZGlvLCB7IG9uY2U6IHRydWUgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBmbHVzaCBwZW5kaW5nIGJlZXBzCiAgICAgICAgICAgIHZhciBxID0gQS5xdWV1ZS5zcGxpY2UoMCk7CiAgICAgICAgICAgIHEuZm9yRWFjaChmdW5jdGlvbihmbil7IHRyeXsgZm4oKTsgfWNhdGNoKGUpe30gfSk7CiAgICAgICAgICAgIGlmKHR5cGVvZiBjb25zb2xlIT09J3VuZGVmaW5lZCcgJiYgY29uc29sZS5kZWJ1Zyl7CiAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnW2F1ZGlvXSB1bmxvY2tlZCArIHF1ZXVlIGZsdXNoZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKF8pe30pOwogICAgICB9Y2F0Y2goXyl7fQogICAgfQogICAgd2luZG93LmVuc3VyZUF1ZGlvVW5sb2NrZWQgPSBmdW5jdGlvbigpewogICAgICB0cnl7CiAgICAgICAgY29uc3QgQSA9IHdpbmRvdy5fX0FVRElPOwogICAgICAgIGlmKEEudW5sb2NrZWQpIHJldHVybiB0cnVlOwogICAgICAgIGlmKCFBLmN0eCl7CiAgICAgICAgICBjb25zdCBDdHggPSB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQ7CiAgICAgICAgICBpZighQ3R4KSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBBLmN0eCA9IG5ldyBDdHgoKTsKICAgICAgICB9CiAgICAgICAgWydwb2ludGVyZG93bicsJ3RvdWNoc3RhcnQnLCdjbGljaycsJ2tleWRvd24nXS5mb3JFYWNoKGZ1bmN0aW9uKGV2KXsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXYsIF9fcmVzdW1lQXVkaW8sIHsgb25jZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KTsKICAgICAgICB9KTsKICAgICAgICBpZih0eXBlb2YgY29uc29sZSE9PSd1bmRlZmluZWQnICYmIGNvbnNvbGUuZGVidWcpewogICAgICAgICAgY29uc29sZS5kZWJ1ZygnW2F1ZGlvXSB3YWl0aW5nIGZvciB1c2VyIGdlc3R1cmUgdG8gdW5sb2NrLi4uJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfWNhdGNoKF8peyByZXR1cm4gZmFsc2U7IH0KICAgIH07CiAgfWNhdGNoKF8pe30KfSkoKTsKLy8gPT09IGVuZCB1bmxvY2sgaGVscGVyID09PQoKCiAgCmZ1bmN0aW9uIHBsYXlCZWVwKGZyZXEsIGR1cmF0aW9uTXMsIGdhaW5WYWwpewogIHRyeXsKICAgIHZhciBmID0gTnVtYmVyKGZyZXEpfHwxMDAwOwogICAgdmFyIG1zID0gTnVtYmVyKGR1cmF0aW9uTXMpfHwyMDA7CiAgICB2YXIgZyA9IE51bWJlcihnYWluVmFsKTsgCiAgICBpZighaXNGaW5pdGUoZykgfHwgZzw9MCkgZyA9IDEuMDsKICAgIHZhciBvayA9ICh0eXBlb2YgZW5zdXJlQXVkaW9VbmxvY2tlZD09PSdmdW5jdGlvbicpID8gZW5zdXJlQXVkaW9VbmxvY2tlZCgpIDogdHJ1ZTsKCiAgICB2YXIgZG9QbGF5ID0gZnVuY3Rpb24oKXsKICAgICAgdHJ5ewogICAgICAgIHZhciBBID0gd2luZG93Ll9fQVVESU8gfHwgKHdpbmRvdy5fX0FVRElPID0geyBjdHg6bnVsbCwgdW5sb2NrZWQ6ZmFsc2UsIHF1ZXVlOltdIH0pOwogICAgICAgIHZhciBDdHggPSB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQ7CiAgICAgICAgaWYoIUEuY3R4KSBBLmN0eCA9IG5ldyBDdHgoKTsKICAgICAgICAvLyBFbnN1cmUgY29udGV4dCBpcyBydW5uaW5nCiAgICAgICAgaWYoQS5jdHguc3RhdGUgIT09ICdydW5uaW5nJyl7CiAgICAgICAgICAvLyBCZXN0IGVmZm9ydCByZXN1bWUKICAgICAgICAgIGlmIChBLmN0eC5yZXN1bWUpIEEuY3R4LnJlc3VtZSgpLmNhdGNoKGZ1bmN0aW9uKCl7IH0pOwogICAgICAgIH0KICAgICAgICB2YXIgY3R4ID0gQS5jdHg7CiAgICAgICAgdmFyIG9zYyA9IGN0eC5jcmVhdGVPc2NpbGxhdG9yKCk7CiAgICAgICAgdmFyIGdhaW4gPSBjdHguY3JlYXRlR2FpbigpOwogICAgICAgIG9zYy50eXBlID0gJ3NpbmUnOwogICAgICAgIG9zYy5mcmVxdWVuY3kudmFsdWUgPSBmOwoKICAgICAgICAvLyBzaW1wbGUgYW50aS1jbGljayBlbnZlbG9wZQogICAgICAgIHZhciB0ID0gY3R4LmN1cnJlbnRUaW1lOwogICAgICAgIHZhciBkdXIgPSBtcy8xMDAwOwogICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjAwMDEsIHQpOwogICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKE1hdGgubWF4KDAuMDAwMiwgTWF0aC5taW4oZywgMi4wKSksIHQgKyAwLjAyKTsKICAgICAgICBnYWluLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjAwMDEsIHQgKyBkdXIpOwoKICAgICAgICBvc2MuY29ubmVjdChnYWluKTsKICAgICAgICBnYWluLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICBvc2Muc3RhcnQodCk7CiAgICAgICAgb3NjLnN0b3AodCArIGR1cik7CiAgICAgIH1jYXRjaChfKXt9CiAgICB9OwoKICAgIGlmKCh3aW5kb3cuX19BVURJTyAmJiB3aW5kb3cuX19BVURJTy51bmxvY2tlZCkgfHwgb2spewogICAgICBkb1BsYXkoKTsKICAgIH1lbHNlewogICAgICAvLyBxdWV1ZSB1bnRpbCB1bmxvY2sgdmlhIGZpcnN0IGNsaWNrL3RvdWNoL2tleWRvd24KICAgICAgdHJ5ewogICAgICAgIHZhciBBID0gd2luZG93Ll9fQVVESU8gfHwgKHdpbmRvdy5fX0FVRElPID0geyBjdHg6bnVsbCwgdW5sb2NrZWQ6ZmFsc2UsIHF1ZXVlOltdIH0pOwogICAgICAgIC8vIEtlZXAgcXVldWUgc21hbGwKICAgICAgICBpZiAoQS5xdWV1ZS5sZW5ndGggPCA1KSBBLnF1ZXVlLnB1c2goZG9QbGF5KTsKICAgICAgfWNhdGNoKF8pe30KICAgIH0KICB9Y2F0Y2goXyl7fQp9CgoKICBmdW5jdGlvbiBwb3J0Zm9saW9HbG9iYWxTaWduYWwoKXsKICAgIGxldCBhbnlIaXQ9ZmFsc2UsIGFueU5lYXI9ZmFsc2U7CiAgICBmb3IoY29uc3QgcGYgb2YgKERCLnBvcnRmb2xpb3N8fFtdKSl7CiAgICAgIGNvbnN0IHNpZyA9ICh0eXBlb2YgcG9ydGZvbGlvVGFyZ2V0U3RhdGU9PT0nZnVuY3Rpb24nKSA/IHBvcnRmb2xpb1RhcmdldFN0YXRlKHBmKSA6IHtzdGF0ZTonbm9uZSd9OwogICAgICBpZihzaWcuc3RhdGU9PT0naGl0Jyl7IGFueUhpdD10cnVlOyBicmVhazsgfQogICAgICBpZihzaWcuc3RhdGU9PT0nbmVhcicpeyBhbnlOZWFyPXRydWU7IH0KICAgIH0KICAgIHJldHVybiBhbnlIaXQgPyAnaGl0JyA6IChhbnlOZWFyID8gJ25lYXInIDogJ25vbmUnKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrQW5kUGxheVBvcnRmb2xpb0FsZXJ0cygpewogICAgY29uc3QgcyA9IHBvcnRmb2xpb0dsb2JhbFNpZ25hbCgpOwogICAgY29uc3Qgbm93TXMgPSBEYXRlLm5vdygpOwogICAgaWYocz09PSdoaXQnICYmIERCPy5zZXR0aW5ncz8uc291bmRIaXRUYXJnZXQgIT09IGZhbHNlKXsKICAgICAgaWYoX19sYXN0UG9ydGZvbGlvU2lnIT09J2hpdCcgfHwgKG5vd01zIC0gX19sYXN0UG9ydGZvbGlvQmVlcCkgPj0gX19yZXBlYXRNcygpKXsKICAgICAgICBwbGF5QmVlcCgxMTAwLCAyNjAsIDEuMyk7ICB0cnl7IGlmKF9fc2hvdWxkSW5jcmVtZW50QmFkZ2UoJ3BvcnRmb2xpb19nbG9iYWwnLCAnaGl0JykpeyBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsgY29uc3Qgbj1OdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oayl8fDApfHwwOyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrLCBTdHJpbmcoTWF0aC5taW4obisxLDk5OSkpKTsgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsgfSB9Y2F0Y2goXyl7fSBfX2xhc3RQb3J0Zm9saW9CZWVwID0gbm93TXM7CiAgICAgIH0KICAgIH1lbHNlIGlmKHM9PT0nbmVhcicgJiYgREI/LnNldHRpbmdzPy5zb3VuZE5lYXJUYXJnZXQgIT09IGZhbHNlKXsKICAgICAgaWYoX19sYXN0UG9ydGZvbGlvU2lnIT09J25lYXInIHx8IChub3dNcyAtIF9fbGFzdFBvcnRmb2xpb0JlZXApID49IF9fcmVwZWF0TXMoKSl7CiAgICAgICAgcGxheUJlZXAoNjUwLCAyMjAsIDEuMCk7ICB0cnl7IGlmKF9fc2hvdWxkSW5jcmVtZW50QmFkZ2UoJ3BvcnRmb2xpb19nbG9iYWwnLCAnbmVhcicpKXsgY29uc3Qgaz0nYWxlcnRzX3VucmVhZF9jb3VudCc7IGNvbnN0IG49TnVtYmVyKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGspfHwwKXx8MDsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oaywgU3RyaW5nKE1hdGgubWluKG4rMSw5OTkpKSk7IGlmKHR5cGVvZiB1cGRhdGVBbGVydHNCYWRnZT09PSdmdW5jdGlvbicpIHVwZGF0ZUFsZXJ0c0JhZGdlKCk7IH0gfWNhdGNoKF8pe30gX19sYXN0UG9ydGZvbGlvQmVlcCA9IG5vd01zOwogICAgICB9CiAgICB9CiAgICAgX19sYXN0UG9ydGZvbGlvU2lnID0gczsKICB9CgogIGZ1bmN0aW9uIGNoZWNrQW5kUGxheVdpc2hsaXN0QWxlcnQoKXsKICAgIGlmKHR5cGVvZiB3aXNobGlzdFNpZ25hbCE9PSdmdW5jdGlvbicpIHJldHVybjsKICAgIGNvbnN0IHMgPSB3aXNobGlzdFNpZ25hbCgpOyAvLyAnaGl0JyB8ICduZWFyJyB8ICdub25lJwogICAgY29uc3Qgbm93TXMgPSBEYXRlLm5vdygpOwogICAgaWYocz09PSdoaXQnICYmIERCPy5zZXR0aW5ncz8uc291bmRIaXRUYXJnZXQgIT09IGZhbHNlKXsKICAgICAgaWYoX19sYXN0V2lzaGxpc3RTaWchPT0naGl0JyB8fCAobm93TXMgLSBfX2xhc3RXaXNobGlzdEJlZXApID49IF9fcmVwZWF0TXMoKSl7CiAgICAgICAgcGxheUJlZXAoMTAwMCwgMjQwLCAxLjMpOyAgdHJ5eyBpZihfX3Nob3VsZEluY3JlbWVudEJhZGdlKCd3aXNobGlzdF9nbG9iYWwnLCAnaGl0JykpeyBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsgY29uc3Qgbj1OdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oayl8fDApfHwwOyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrLCBTdHJpbmcoTWF0aC5taW4obisxLDk5OSkpKTsgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsgfSB9Y2F0Y2goXyl7fSBfX2xhc3RXaXNobGlzdEJlZXAgPSBub3dNczsKICAgICAgfQogICAgfWVsc2UgaWYocz09PSduZWFyJyAmJiBEQj8uc2V0dGluZ3M/LnNvdW5kTmVhclRhcmdldCAhPT0gZmFsc2UpewogICAgICBpZihfX2xhc3RXaXNobGlzdFNpZyE9PSduZWFyJyB8fCAobm93TXMgLSBfX2xhc3RXaXNobGlzdEJlZXApID49IF9fcmVwZWF0TXMoKSl7CiAgICAgICAgcGxheUJlZXAoNjAwLCAyMDAsIDEuMCk7ICB0cnl7IGlmKF9fc2hvdWxkSW5jcmVtZW50QmFkZ2UoJ3dpc2hsaXN0X2dsb2JhbCcsICduZWFyJykpeyBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsgY29uc3Qgbj1OdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oayl8fDApfHwwOyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrLCBTdHJpbmcoTWF0aC5taW4obisxLDk5OSkpKTsgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsgfSB9Y2F0Y2goXyl7fSBfX2xhc3RXaXNobGlzdEJlZXAgPSBub3dNczsKICAgICAgfQogICAgfQogICAgX19sYXN0V2lzaGxpc3RTaWcgPSBzOwogIH0KCiAgdHJ5ewogICAgd2luZG93LmNoZWNrQW5kUGxheVBvcnRmb2xpb0FsZXJ0cyA9IGNoZWNrQW5kUGxheVBvcnRmb2xpb0FsZXJ0czsKICAgIHdpbmRvdy5jaGVja0FuZFBsYXlXaXNobGlzdEFsZXJ0ID0gY2hlY2tBbmRQbGF5V2lzaGxpc3RBbGVydDsKICAgIHdpbmRvdy5fX3Rlc3RCZWVwID0gKGY9ODAwLGQ9MjUwLG09MS4wKT0+eyB0cnl7IHBsYXlCZWVwKGYsZCxtKTsgfWNhdGNoKF8peyB9IH07CiAgfWNhdGNoKF8pe30KfSkoKTs7CgogIAovKiA9PT0gQWNrbm93bGVkZ2VkIEFsZXJ0cyAoc3VwcHJlc3MgYmxpbmtpbmcgZm9yIHJlYWQgb25lcykgPT09ICovCndpbmRvdy5fX2Fja2VkQWxlcnRzID0gd2luZG93Ll9fYWNrZWRBbGVydHMgfHwge307CmZ1bmN0aW9uIF9fYWNrS2V5KHRpY2tlciwga2luZCwgc3RhdGUpeyB0cnl7IHJldHVybiBbU3RyaW5nKHRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCksIFN0cmluZyhraW5kfHwnJyksIFN0cmluZyhzdGF0ZXx8JycpXS5qb2luKCd8Jyk7IH1jYXRjaChfKXsgcmV0dXJuIFN0cmluZyh0aWNrZXJ8fCcnKTsgfSB9CmZ1bmN0aW9uIGlzQWxlcnRBY2tlZCh0aWNrZXIsIGtpbmQsIHN0YXRlKXsgdHJ5eyByZXR1cm4gISF3aW5kb3cuX19hY2tlZEFsZXJ0c1tfX2Fja0tleSh0aWNrZXIsa2luZCxzdGF0ZSldOyB9Y2F0Y2goXyl7IHJldHVybiBmYWxzZTsgfSB9CmZ1bmN0aW9uIGFja0FsZXJ0KHRpY2tlciwga2luZCwgc3RhdGUpeyB0cnl7IHdpbmRvdy5fX2Fja2VkQWxlcnRzW19fYWNrS2V5KHRpY2tlcixraW5kLHN0YXRlKV0gPSBEYXRlLm5vdygpOyB9Y2F0Y2goXyl7fSB9CgpmdW5jdGlvbiBhY2tDdXJyZW50QWxlcnRzKCl7CiAgdHJ5ewogICAgLy8gUG9ydGZvbGlvcyAtIHBlciB0aWNrZXIgYmVzdCBzdGF0ZQogICAgY29uc3QgdG9sID0gKE51bWJlcihEQj8uc2V0dGluZ3M/LmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MSkvMTAwOwogICAgZm9yKGNvbnN0IHBmIG9mIChEQj8ucG9ydGZvbGlvc3x8W10pKXsKICAgICAgZm9yKGNvbnN0IFt0aWNrZXIsIGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHBmLmhvbGRpbmdzfHx7fSkpewogICAgICAgIGNvbnN0IGxvdHMgPSBib29rLmxvdHN8fFtdOwogICAgICAgIGNvbnN0IHByaWNlID0gZ2V0UXVvdGUodGlja2VyKTsKICAgICAgICBpZihwcmljZT09bnVsbCkgY29udGludWU7CiAgICAgICAgbGV0IHJhbmsgPSAtMSwgc3RhdGU9J25vbmUnLCBraW5kPW51bGw7CiAgICAgICAgZm9yKGNvbnN0IGwgb2YgbG90cyl7CiAgICAgICAgICBsLl90aWNrZXIgPSB0aWNrZXI7CiAgICAgICAgICBjb25zdCBzdCA9IHRhcmdldFN0YXR1cyhsKTsKICAgICAgICAgIGNvbnN0IHIgPSBzdC5zdGF0ZT09PSJoaXQiID8gKHN0LmtpbmQ9PT0ic2VsbCI/MzoyKSA6IChzdC5zdGF0ZT09PSJuZWFyIiA/IChzdC5raW5kPT09InNlbGwiPzE6MCkgOiAtMSk7CiAgICAgICAgICBpZihyID4gcmFuayl7IHJhbms9cjsgc3RhdGUgPSBzdC5zdGF0ZTsga2luZCA9IHN0LmtpbmQ7IH0KICAgICAgICB9CiAgICAgICAgaWYocmFuaz49MCAmJiAoc3RhdGU9PT0naGl0JyB8fCBzdGF0ZT09PSduZWFyJykgJiYga2luZCkgYWNrQWxlcnQodGlja2VyLCBraW5kLCBzdGF0ZSk7CiAgICAgIH0KICAgIH0KICAgIC8vIFdpc2hsaXN0IC0gYWN0aXZlIHRhcmdldCBvbmx5CiAgICBjb25zdCB0b2wyID0gKE51bWJlcihEQj8uc2V0dGluZ3M/LmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MSkvMTAwOwogICAgKERCPy53YXRjaGxpc3R8fFtdKS5mb3JFYWNoKHc9PnsKICAgICAgY29uc3QgdCA9ICh3LnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGNvbnN0IHAgPSBnZXRRdW90ZSh0KTsKICAgICAgY29uc3QgdGFyZ2V0cyA9IEFycmF5LmlzQXJyYXkody50YXJnZXRzKSA/IHcudGFyZ2V0cy5tYXAoeD0+TnVtYmVyKHgpfHwwKS5maWx0ZXIoeD0+eD4wKSA6IFtdOwogICAgICBjb25zdCBhaSA9IE1hdGgubWluKE1hdGgubWF4KE51bWJlcih3LmFjdGl2ZUluZGV4KXx8MCwgMCksIE1hdGgubWF4KHRhcmdldHMubGVuZ3RoLTEsMCkpOwogICAgICBjb25zdCBkID0gdGFyZ2V0cy5sZW5ndGggPyBOdW1iZXIodGFyZ2V0c1thaV0pfHwwIDogKE51bWJlcih3LnByaWNlKXx8MCk7CiAgICAgIGlmKCF0IHx8ICEoZD4wKSB8fCBwPT1udWxsKSByZXR1cm47CiAgICAgIGlmKHAgPD0gZCkgYWNrQWxlcnQodCwgJ2J1eScsICdoaXQnKTsKICAgICAgZWxzZSBpZihwIDw9IGQqKDErdG9sMikpIGFja0FsZXJ0KHQsICdidXknLCAnbmVhcicpOwogICAgfSk7CiAgfWNhdGNoKF8pe30KfQovKiA9PT0gV2lzaGxpc3QgKExpc3RhIMW8eWN6ZcWEKSA9PT0gKi8KICAKICBmdW5jdGlvbiBlbnN1cmVXYXRjaGxpc3RTdHJ1Y3R1cmUoKXsKICAgIHRyeXsKICAgICAgREIud2F0Y2hsaXN0ID0gREIud2F0Y2hsaXN0IHx8IFtdOwogICAgICBmb3IoY29uc3QgdyBvZiBEQi53YXRjaGxpc3QpewogICAgICAgIGlmKCFBcnJheS5pc0FycmF5KHcudGFyZ2V0cykpewogICAgICAgICAgY29uc3QgYmFzZSA9IE51bWJlcih3LnByaWNlKXx8MDsKICAgICAgICAgIHcudGFyZ2V0cyA9IGJhc2U+MCA/IFtiYXNlXSA6IFtdOwogICAgICAgICAgdHJ5eyBkZWxldGUgdy5wcmljZTsgfWNhdGNoKF8pe30KICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIHcuYWN0aXZlSW5kZXghPT0nbnVtYmVyJykgdy5hY3RpdmVJbmRleCA9IDA7CiAgICAgICAgaWYodHlwZW9mIHcubmFtZSE9PSdzdHJpbmcnKSB3Lm5hbWUgPSB3Lm5hbWV8fCcnOwogICAgICB9CiAgICB9Y2F0Y2goXyl7fQogIH0KZnVuY3Rpb24gZW5zdXJlV2F0Y2hsaXN0KCl7IERCLndhdGNobGlzdCA9IERCLndhdGNobGlzdCB8fCBbXTsgZW5zdXJlV2F0Y2hsaXN0U3RydWN0dXJlKCk7IH0KCiAgCmZ1bmN0aW9uIHNldEFjdGl2ZVZpZXcodil7CiAgY29uc3QgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tYWluJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpOwogIGlmKCFtYWluKSByZXR1cm47CiAgY29uc3QgcGFuZWxzID0gbWFpbi5xdWVyeVNlbGVjdG9yQWxsKCc6c2NvcGUgPiBzZWN0aW9uJyk7CiAgcGFuZWxzLmZvckVhY2goc2VjPT57CiAgICBpZih2PT09J3dpc2hsaXN0Jykgc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnKSA/ICcnIDogJ25vbmUnOwogICAgZWxzZSBpZih2PT09J2FsZXJ0cycpIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSdhbGVydHNQYW5lbCcpID8gJycgOiAnbm9uZSc7CiAgICBlbHNlIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSd3aXNobGlzdFBhbmVsJyB8fCBzZWMuaWQ9PT0nYWxlcnRzUGFuZWwnKSA/ICdub25lJyA6ICcnOwogIH0pOwogIGNvbnN0IGJ0blcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lzaGxpc3RUYWJCdG4nKTsKICBpZihidG5XKXsgYnRuVy5jbGFzc0xpc3QudG9nZ2xlKCdzZWNvbmRhcnknLCB2IT09J3dpc2hsaXN0Jyk7IH0KICBjb25zdCBidG5BID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1RhYkJ0bicpOwogIGlmKGJ0bkEpeyBidG5BLmNsYXNzTGlzdC50b2dnbGUoJ3NlY29uZGFyeScsIHYhPT0nYWxlcnRzJyk7IH0KfQoKCiAgZnVuY3Rpb24gd2lzaGxpc3RTaWduYWwoKXsKICAgIGVuc3VyZVdhdGNobGlzdCgpOwogICAgY29uc3QgdG9sID0gKE51bWJlcihEQi5zZXR0aW5ncy5hcHByb2FjaFRvbGVyYW5jZVBjdCl8fDEpLzEwMDsKICAgIGxldCBoaXQ9ZmFsc2UsIG5lYXI9ZmFsc2U7CiAgICBmb3IoY29uc3QgdyBvZiBEQi53YXRjaGxpc3QpewogICAgICBjb25zdCB0ID0gKHcudGlja2VyfHwnJykudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcCA9IGdldFF1b3RlKHQpOwogICAgICBjb25zdCB0YXJnZXRzID0gQXJyYXkuaXNBcnJheSh3LnRhcmdldHMpID8gdy50YXJnZXRzLm1hcCh4PT5OdW1iZXIoeCl8fDApLmZpbHRlcih4PT54PjApIDogW107CiAgICAgIGNvbnN0IGFpID0gTWF0aC5taW4oTWF0aC5tYXgoTnVtYmVyKHcuYWN0aXZlSW5kZXgpfHwwLCAwKSwgTWF0aC5tYXgodGFyZ2V0cy5sZW5ndGgtMSwwKSk7CiAgICAgIGNvbnN0IGQgPSAodGFyZ2V0cy5sZW5ndGggPyBOdW1iZXIodGFyZ2V0c1thaV0pfHwwIDogKE51bWJlcih3LnByaWNlKXx8MCkpOwogICAgICBpZighdCB8fCAhKGQ+MCkgfHwgcD09bnVsbCkgY29udGludWU7CiAgICAgIGlmKHAgPD0gZCl7IGhpdCA9IHRydWU7IGJyZWFrOyB9CiAgICAgIGlmKHAgPD0gZCooMSt0b2wpKSBuZWFyID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBoaXQgPyAnaGl0JyA6IChuZWFyID8gJ25lYXInIDogJ25vbmUnKTsKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpewogICAgdHJ5ewogICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lzaGxpc3RUYWJCdG4nKTsKICAgICAgaWYoIWJ0bikgcmV0dXJuOwogICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgnaGl0LXRhcmdldC1idXknLCduZWFyLXRhcmdldC1idXknKTsKICAgICAgY29uc3Qgc2lnID0gd2lzaGxpc3RTaWduYWwoKTsKICAgICAgaWYoc2lnPT09J2hpdCcpIGJ0bi5jbGFzc0xpc3QuYWRkKCdoaXQtdGFyZ2V0LWJ1eScpOwogICAgICBlbHNlIGlmKHNpZz09PSduZWFyJykgYnRuLmNsYXNzTGlzdC5hZGQoJ25lYXItdGFyZ2V0LWJ1eScpOwogICAgfWNhdGNoKGUpe30KICB9CgogIGZ1bmN0aW9uIGFkZFdhdGNoSXRlbSh0aWNrZXIsIHByaWNlKXsKICAgIGVuc3VyZVdhdGNobGlzdCgpOwogICAgdGlja2VyID0gKHRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCkudHJpbSgpOwogICAgY29uc3QgcCA9IE51bWJlcihwcmljZSl8fDA7CiAgICBpZighdGlja2VyIHx8ICEocD4wKSl7IGFsZXJ0KCdQb2RhaiBwb3ByYXdueSB0aWNrZXIgaSBjZW7EmS4nKTsgcmV0dXJuOyB9CiAgICBjb25zdCBleCA9IERCLndhdGNobGlzdC5maW5kKHc9PiB3LnRpY2tlcj09PXRpY2tlcik7CiAgICBpZihleCl7IGV4LnByaWNlID0gcDsgZXgudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB9CiAgICBlbHNlIHsgREIud2F0Y2hsaXN0LnB1c2goeyBpZDppZCgpLCB0aWNrZXIsIHByaWNlOnAsIGNyZWF0ZWRBdDpuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIHVwZGF0ZWRBdDpuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSk7IH0KICAgIHNhdmUoKTsgcmVuZGVyV2lzaGxpc3QoKTsgdXBkYXRlV2lzaGxpc3RCbGlua1N0YXRlKCk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVXYXRjaEl0ZW0od2lkKXsKICAgIGVuc3VyZVdhdGNobGlzdCgpOwogICAgY29uc3QgaSA9IERCLndhdGNobGlzdC5maW5kSW5kZXgodz0+IHcuaWQ9PT13aWQpOwogICAgaWYoaT49MCl7IERCLndhdGNobGlzdC5zcGxpY2UoaSwxKTsgc2F2ZSgpOyByZW5kZXJXaXNobGlzdCgpOyB1cGRhdGVXaXNobGlzdEJsaW5rU3RhdGUoKTsgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gZWRpdFdhdGNoSXRlbSh3aWQpewogICAgZW5zdXJlV2F0Y2hsaXN0KCk7CiAgICBjb25zdCBpdGVtID0gREIud2F0Y2hsaXN0LmZpbmQodz0+IHcuaWQ9PT13aWQpOwogICAgaWYoIWl0ZW0pIHJldHVybjsKICAgIGNvbnN0IHQgPSAoaXRlbS50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgLy8gQnVpbGQgZGVmYXVsdCB0YXJnZXRzIHN0cmluZyBmcm9tIGV4aXN0aW5nIHRhcmdldHMgb3IgZmFsbGJhY2sgdG8gb2xkIHByaWNlCiAgICBjb25zdCBkZWZhdWx0VGFyZ2V0cyA9IChBcnJheS5pc0FycmF5KGl0ZW0udGFyZ2V0cykgJiYgaXRlbS50YXJnZXRzLmxlbmd0aCkgCiAgICAgID8gaXRlbS50YXJnZXRzLmpvaW4oJywgJykKICAgICAgOiAoKGl0ZW0ucHJpY2UhPW51bGwgJiYgaXRlbS5wcmljZSE9PScnKSA/IChpdGVtLnByaWNlKycnKSA6ICcnKTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZTogYEVkeXR1aiBjZWxlIGt1cG5hIOKAlCAke19fZXNjKHQpfWAsCiAgICAgIGlubmVySFRNTDogYDxmb3JtIGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPjxsYWJlbD5DZW55IGRvY2Vsb3dlIChrdXBubykg4oCUIHdwaXN6IHBvIHByemVjaW5rdSwgdyBrb2xlam5vxZtjaSByZWFsaXphY2ppPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0YXJnZXRzIiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0ibnAuIDM1MCwgMzAwLCAyNTAiIHZhbHVlPSIke19fZXNjKGRlZmF1bHRUYXJnZXRzKX0iIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtdXRlZCBzbWFsbCI+QWt0eXduYSBixJlkemllIHBpZXJ3c3phOyBwbyB6YWt1cGllIHByemXFgsSFY3p5IHNpxJkgbmEga29sZWpuxIUuPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZm9ybT5gLAogICAgICBva1RleHQ6IlphcGlzeiIKICAgIH0pOwogICAgaWYoIWRhdGEpIHJldHVybjsKICAgIGNvbnN0IHJhdyA9IChkYXRhLnRhcmdldHN8fCcnKSsnJzsKICAgIGNvbnN0IHRhcmdldHMgPSByYXcuc3BsaXQoL1ssO1xzXSsvKS5tYXAoeD0+TnVtYmVyKHgpKS5maWx0ZXIoeD0+eD4wKTsKICAgIGlmKCF0YXJnZXRzLmxlbmd0aCl7IGFsZXJ0KCdQb2RhaiBjbyBuYWptbmllaiBqZWRuxIUgcG9wcmF3bsSFIGNlbsSZIGRvY2Vsb3fEhS4nKTsgcmV0dXJuOyB9CiAgICBpdGVtLnRhcmdldHMgPSB0YXJnZXRzOwogICAgaWYodHlwZW9mIGl0ZW0uYWN0aXZlSW5kZXghPT0nbnVtYmVyJyB8fCBpdGVtLmFjdGl2ZUluZGV4Pj10YXJnZXRzLmxlbmd0aCkgaXRlbS5hY3RpdmVJbmRleCA9IDA7CiAgICB0cnl7IGRlbGV0ZSBpdGVtLnByaWNlOyB9Y2F0Y2goXyl7fQogICAgaXRlbS51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7CiAgICBzYXZlKCk7IHJlbmRlcldpc2hsaXN0KCk7IHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyV2lzaGxpc3QoKXsKICAgIGVuc3VyZVdhdGNobGlzdCgpOwogICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFRhYmxlV3JhcCcpOwogICAgaWYoIXdyYXApIHJldHVybjsKICAgIGNvbnN0IHRvbCA9IChOdW1iZXIoREIuc2V0dGluZ3MuYXBwcm9hY2hUb2xlcmFuY2VQY3QpfHwxKS8xMDA7CiAgICBjb25zdCByb3dzID0gKERCLndhdGNobGlzdHx8W10pLm1hcCh3PT57CiAgICAgIGNvbnN0IHQgPSAody50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICBjb25zdCBwcmljZSA9IGdldFF1b3RlKHQpOwogICAgICBjb25zdCB0YXJnZXRzID0gQXJyYXkuaXNBcnJheSh3LnRhcmdldHMpID8gdy50YXJnZXRzLm1hcCh4PT5OdW1iZXIoeCl8fDApLmZpbHRlcih4PT54PjApIDogKChOdW1iZXIody5wcmljZSl8fDApP1tOdW1iZXIody5wcmljZSldOltdKTsKICAgICAgY29uc3QgYWkgPSBNYXRoLm1pbihNYXRoLm1heChOdW1iZXIody5hY3RpdmVJbmRleCl8fDAsIDApLCBNYXRoLm1heCh0YXJnZXRzLmxlbmd0aC0xLDApKTsKICAgICAgY29uc3QgZGVzaXJlZCA9IHRhcmdldHMubGVuZ3RoID8gTnVtYmVyKHRhcmdldHNbYWldKXx8MCA6IDA7CiAgICAgIGxldCBkaXN0ID0gbnVsbCwgc3RhdHVzPSfigJQnLCBjbHM9Jyc7CiAgICAgIGlmKHByaWNlIT1udWxsICYmIGRlc2lyZWQ+MCl7CiAgICAgICAgZGlzdCA9IChwcmljZSAtIGRlc2lyZWQpL2Rlc2lyZWQ7CiAgICAgICAgaWYocHJpY2UgPD0gZGVzaXJlZCl7IHN0YXR1cyA9ICfwn46vIEtVUCc7IGNscz0naGl0LXRhcmdldC1idXknOyB9CiAgICAgICAgZWxzZSBpZihwcmljZSA8PSBkZXNpcmVkKigxK3RvbCkpeyBzdGF0dXMgPSAn4o+zIGJsaXNrbyc7IGNscz0nbmVhci10YXJnZXQtYnV5JzsgfQogICAgICB9CiAgICAgIHJldHVybiB7IC4uLncsIHQsIHByaWNlLCBkZXNpcmVkLCBkaXN0LCBzdGF0dXMsIGNscyB9OwogICAgfSkuc29ydCgoYSxiKT0+ewogICAgICBjb25zdCBhZCA9IChhLmRpc3Q9PW51bGwpID8gMWU5IDogTWF0aC5hYnMoYS5kaXN0KTsKICAgICAgY29uc3QgYmQgPSAoYi5kaXN0PT1udWxsKSA/IDFlOSA6IE1hdGguYWJzKGIuZGlzdCk7CiAgICAgIHJldHVybiBhZCAtIGJkOwogICAgfSk7CgogICAgCiAgICAvLyBMb2cgd2lzaGxpc3QgYWxhcm1zIChkZWR1cGxpY2F0ZWQpLCBmb3Igcm93cyBpbiAnbmVhcicgb3IgJ2hpdCcgc3RhdGVzCiAgICB0cnl7CiAgICAgIHJvd3MuZm9yRWFjaChyPT57CiAgICAgICAgY29uc3QgaW5mbyA9IChyLmNscz09PSdoaXQtdGFyZ2V0LWJ1eScpID8ge3N0YXRlOidoaXQnLCBraW5kOididXknfQogICAgICAgICAgICAgICAgICAgIDogKHIuY2xzPT09J25lYXItdGFyZ2V0LWJ1eScpID8ge3N0YXRlOiduZWFyJywga2luZDonYnV5J30KICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgaWYoaW5mbyAmJiByLmRlc2lyZWQ+MCAmJiByLnByaWNlIT1udWxsKXsKICAgICAgICAgIGNvbnN0IGtleSA9IFsnd2wnLCByLmlkIHx8IHIudCwgaW5mby5raW5kXS5qb2luKCd8Jyk7CiAgICAgICAgICBpZihfX3Nob3VsZExvZ0FsYXJtKGtleSwgaW5mby5zdGF0ZSkpeyB0cnl7IHdpbmRvdy5zaG93VG9hc3QgJiYgc2hvd1RvYXN0KHt0aWNrZXI6ci50LCBzdGF0ZTppbmZvLnN0YXRlLCBraW5kOmluZm8ua2luZH0pOyB9Y2F0Y2goXyl7fSB0cnl7IHdpbmRvdy5zaG93VG9hc3QgJiYgc2hvd1RvYXN0KHt0aWNrZXIsIHN0YXRlOmluZm8uc3RhdGUsIGtpbmQ6aW5mby5raW5kfSk7IH1jYXRjaChfKXt9CiAgICAgICAgICAgIGxvZ0FsYXJtRXZlbnQoe3Njb3BlOid3aXNobGlzdCcsIHRpY2tlcjpyLnQsIHN0YXRlOmluZm8uc3RhdGUsIGtpbmQ6aW5mby5raW5kLCBwcmljZTpyLnByaWNlLCB0YXJnZXQ6ci5kZXNpcmVkfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH1jYXRjaChfKXt9CmNvbnN0IGJvZHkgPSByb3dzLm1hcChyPT57CiAgICAgIGNvbnN0IHByaWNlVHh0ID0gKHIucHJpY2UhPW51bGwpID8gX19mbXROdW0oci5wcmljZSkgOiAn4oCUJzsKICAgICAgY29uc3QgZGlzdFR4dCA9IChyLmRpc3Q9PW51bGwpID8gJ+KAlCcgOiAoIChyLmRpc3QqMTAwKS50b0ZpeGVkKDIpICsgJyUnICk7CiAgICAgIHJldHVybiBgPHRyIGNsYXNzPSIke3IuY2xzfSI+CiAgICAgICAgPHRkIGNsYXNzPSJ0aWNrZXIiPiR7X19lc2Moci50KX0keygoKT0+eyBjb25zdCBjbj1nZXRDb21wYW55TmFtZShyLnQpOyByZXR1cm4gY24/YDxkaXYgY2xhc3M9Im11dGVkIHNtYWxsIiBzdHlsZT0iZm9udC13ZWlnaHQ6NDAwO21hcmdpbi10b3A6MnB4Ij4ke19fZXNjKGNuKX08L2Rpdj5gOicnOyB9KSgpfTwvdGQ+CiAgICAgICAgPHRkPiR7cHJpY2VUeHR9PC90ZD4KICAgICAgICA8dGQ+JHsoKCk9PnsgY29uc3QgY2g9Z2V0UXVvdGVDaGFuZ2VQY3Qoci50KTsgcmV0dXJuIChjaCE9bnVsbCk/ICgiPHNwYW4gY2xhc3M9J3BjdC1iYWRnZSAiKyhjaD49MD8icGN0LXBvcyBvay10ZXh0IjoicGN0LW5lZyBkYW5nZXItdGV4dCIpKyInPiIrZm10UGN0KGNoKSsiPC9zcGFuPiIpIDogIuKAlCI7IH0pKCl9PC90ZD4KICAgICAgICA8dGQ+JHtfX2ZtdE51bShyLmRlc2lyZWQpfTwvdGQ+CiAgICAgICAgPHRkPiR7KCgpPT57IGNvbnN0IF9jID0gci5jbHN8fCcnOyBjb25zdCBfZD0odHlwZW9mIHIuZGlzdD09PSdudW1iZXInKT9yLmRpc3Q6bnVsbDsgbGV0IF9jbHM9Jyc7IGlmKF9jLmluY2x1ZGVzKCdoaXQtdGFyZ2V0LWJ1eScpKXsgX2Nscz0nb2stdGV4dCc7IH0gZWxzZSBpZihfYy5pbmNsdWRlcygnbmVhci10YXJnZXQtYnV5JykpeyBfY2xzID0gKF9kIT1udWxsICYmIF9kPD0gKHRvbC8yKSkgPyAnd2Fybi1zdHJvbmctdGV4dCcgOiAnd2Fybi10ZXh0JzsgfSByZXR1cm4gYDxzcGFuIGNsYXNzPSIke19jbHN9Ij4ke2Rpc3RUeHR9PC9zcGFuPmA7IH0pKCl9PC90ZD4KICAgICAgICA8dGQ+JHtyLnN0YXR1c308L3RkPgogICAgICAgIDx0ZCBjbGFzcz0icm93IiBzdHlsZT0iZ2FwOjZweCI+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2sgd2wtYnV5IiBkYXRhLWlkPSIke3IuaWR9Ij5LdXA8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCB3bC1lZGl0IiBkYXRhLWlkPSIke3IuaWR9Ij5FZHl0dWo8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkYW5nZXIgd2wtZGVsIiBkYXRhLWlkPSIke3IuaWR9Ij5Vc3XFhDwvYnV0dG9uPiA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgdHYtbGluayIgZGF0YS10aWNrZXI9IiR7ci50fSIgdGl0bGU9IlRyYWRpbmdWaWV3Ij5UVjwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IHdsLWluZm8iIGRhdGEtdGlja2VyPSIke3IudH0iPuKEue+4jzwvYnV0dG9uPgogICAgICAgIDwvdGQ+CiAgICAgIDwvdHI+YDsKICAgIH0pLmpvaW4oJycpIHx8IGA8dHI+PHRkIGNvbHNwYW49IjgiIGNsYXNzPSJjZW50ZXIgbXV0ZWQiPkJyYWsgcG96eWNqaS4gRG9kYWogcGllcndzenkgY2VsIGt1cG5hIHBvd3nFvGVqLjwvdGQ+PC90cj5gOwoKICAgIGNvbnN0IGh0bWwgPSBgPGRpdiBjbGFzcz0idGFibGUtd3JhcCI+CiAgICAgIDx0YWJsZT4KICAgICAgICA8dGhlYWQ+PHRyPgogICAgICAgICAgPHRoPlRpY2tlcjwvdGg+PHRoPkt1cnMgKGxpdmUpPC90aD48dGg+zpQgZHppZW5ueTwvdGg+PHRoPkNlbCBrdXBuYTwvdGg+PHRoPk9kbGVnxYJvxZvEhzwvdGg+PHRoPlN0YXR1czwvdGg+PHRoPkFrY2plPC90aD4KICAgICAgICA8L3RyPjwvdGhlYWQ+CiAgICAgICAgPHRib2R5PiR7Ym9keX08L3Rib2R5PgogICAgICA8L3RhYmxlPgogICAgPC9kaXY+YDsKCiAgICB3cmFwLmlubmVySFRNTCA9IGh0bWw7CgogICAgLy8gYmluZCByb3cgYWN0aW9ucwogICAgCiAgICB3cmFwLnF1ZXJ5U2VsZWN0b3JBbGwoJy53bC1pbmZvJykuZm9yRWFjaChidG49PnsgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZT0+eyBjb25zdCB0PWUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyk7IGlmKHQpIG9wZW5Db21wYW55SW5mb01vZGFsKHQpOyB9KTsgfSk7CndyYXAucXVlcnlTZWxlY3RvckFsbCgnLndsLWRlbCcpLmZvckVhY2goYnRuPT57CiAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGU9PnsKICAgICAgICBjb25zdCBpZCA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnKTsgcmVtb3ZlV2F0Y2hJdGVtKGlkKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHdyYXAucXVlcnlTZWxlY3RvckFsbCgnLndsLWVkaXQnKS5mb3JFYWNoKGJ0bj0+ewogICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlPT57CiAgICAgICAgY29uc3QgaWQgPSBlLmN1cnJlbnRUYXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWlkJyk7IGVkaXRXYXRjaEl0ZW0oaWQpOwogICAgICB9KTsKICAgIH0pOwogICAgd3JhcC5xdWVyeVNlbGVjdG9yQWxsKCcud2wtYnV5JykuZm9yRWFjaChidG49PnsKICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgZT0+ewogICAgICAgIGNvbnN0IGlkID0gZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1pZCcpOwogICAgICAgIGNvbnN0IGl0ZW0gPSAoREIud2F0Y2hsaXN0fHxbXSkuZmluZCh3PT4gdy5pZD09PWlkKTsKICAgICAgICBpZighaXRlbSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHQgPSAoaXRlbS50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgIHRyeXsgYXdhaXQgZmV0Y2hRdW90ZUZpbm5odWIodCk7IH1jYXRjaChlKXt9CiAgICAgICAgY29uc3QgbGFzdFByaWNlID0gZ2V0UXVvdGUodCk7CiAgICAgICAgY29uc3Qgb3B0cyA9IERCLnBvcnRmb2xpb3MubWFwKHA9PmA8b3B0aW9uIHZhbHVlPSIke3AuaWR9Ij4ke19fZXNjKHAubmFtZSl9ICgke3AuY3VycmVuY3l9KTwvb3B0aW9uPmApLmpvaW4oJycpOwogICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICAgICAgdGl0bGU6IGBLdXAgJHtfX2VzYyh0KX0gKHogbGlzdHkgxbx5Y3plxYQpYCwKICAgICAgICAgIGlubmVySFRNTDogYDxmb3JtIGNsYXNzPSJncmlkIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPjxsYWJlbD5Qb3J0ZmVsPC9sYWJlbD48c2VsZWN0IG5hbWU9InBmSWQiPiR7b3B0c308L3NlbGVjdD48L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPjxsYWJlbD5JbG/Fm8SHPC9sYWJlbD48aW5wdXQgbmFtZT0icXR5IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiByZXF1aXJlZCAvPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPkNlbmEgLyBzenQuPC9sYWJlbD48aW5wdXQgbmFtZT0icHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHZhbHVlPSIke2xhc3RQcmljZSE9bnVsbD9sYXN0UHJpY2U6Jyd9IiByZXF1aXJlZCBvbmlucHV0PSJfX3dsU3luY1RhcmdldHModGhpcy5mb3JtKSIgLz48L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTMiPjxsYWJlbD5PcMWCYXR5PC9sYWJlbD48aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHZhbHVlPSIwIiAvPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMyI+PGxhYmVsPkRhdGE8L2xhYmVsPjxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgLz48L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPjxsYWJlbD5DZWwgU1BSWkVEQcW7WSAlPC9sYWJlbD48aW5wdXQgbmFtZT0idGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHBsYWNlaG9sZGVyPSJucC4gNSA9ICs1JSIgb25pbnB1dD0iX193bFN5bmNUYXJnZXRzKHRoaXMuZm9ybSkiIC8+PC9kaXY+PGRpdiBjbGFzcz0iY29sLTYiPjxsYWJlbD5DZWwgU1BSWkVEQcW7WSAoY2VuYSk8L2xhYmVsPjxpbnB1dCBuYW1lPSJ0YXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcGxhY2Vob2xkZXI9Im5wLiAzNTAuMDAiIG9uaW5wdXQ9Il9fd2xTeW5jVGFyZ2V0cyh0aGlzLmZvcm0pIiAvPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPktvbGVqbmUga3Vwbm8gJTwvbGFiZWw+PGlucHV0IG5hbWU9ImJ1eVRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBwbGFjZWhvbGRlcj0ibnAuIC01ID0ga3VwIHByenkgLTUlIiBvbmlucHV0PSJfX3dsU3luY1RhcmdldHModGhpcy5mb3JtKSIgLz48L2Rpdj48ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPktvbGVqbmUga3Vwbm8gKGNlbmEpPC9sYWJlbD48aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHBsYWNlaG9sZGVyPSJucC4gMjgwLjAwIiBvbmlucHV0PSJfX3dsU3luY1RhcmdldHModGhpcy5mb3JtKSIgLz48L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj48bGFiZWw+VXN1xYQgeiBsaXN0eSBwbyB6YWt1cGllPC9sYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9InJlbW92ZSIgLz48L2Rpdj4KICAgICAgICAgIDwvZm9ybT5gLAogICAgICAgICAgb2tUZXh0OiJaYWtzacSZZ3VqIHpha3VwIgogICAgICAgIH0pOwogICAgICAgIGlmKCFkYXRhKSByZXR1cm47CiAgICAgICAgY29uc3QgcGZJZCA9IGRhdGEucGZJZCB8fCBjdXJyZW50UGZJZDsKICAgICAgICBjb25zdCBwYXlsb2FkID0geyB0aWNrZXI6dCwgZGF0ZTpkYXRhLmRhdGUsIHF0eTpkYXRhLnF0eSwgcHJpY2U6ZGF0YS5wcmljZSwgZmVlczpkYXRhLmZlZXMsIHRhcmdldFBjdDogZGF0YS50YXJnZXRQY3R8fCIiLCB0YXJnZXRQcmljZTogZGF0YS50YXJnZXRQcmljZXx8IiIsIGJ1eVRhcmdldFBjdDogZGF0YS5idXlUYXJnZXRQY3R8fCIiLCBidXlUYXJnZXRQcmljZTogZGF0YS5idXlUYXJnZXRQcmljZXx8IiIgfTsKICAgICAgICBjb25zdCB0cyA9IE51bWJlcihkYXRhLnRhcmdldFNlbGwpfHwwOwogICAgICAgIGNvbnN0IHRibiA9IE51bWJlcihkYXRhLnRhcmdldEJ1eU5leHQpfHwwOwogICAgICAgIGlmKHRzPjApIHBheWxvYWQudGFyZ2V0U2VsbCA9IHRzOwogICAgICAgIGlmKHRibj4wKSBwYXlsb2FkLnRhcmdldEJ1eU5leHQgPSB0Ym47CiAgICAgICAgYXdhaXQgYnV5KHBmSWQsIHBheWxvYWQpOwogICAgICAgIGlmKGRhdGEucmVtb3ZlKXsgcmVtb3ZlV2F0Y2hJdGVtKGlkKTsgfSBlbHNlIHsgcmVuZGVyV2lzaGxpc3QoKTsgfQogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLy8gU2VhcmNoIGhlbHBlciBmb3Igd2lzaGxpc3QKICBhc3luYyBmdW5jdGlvbiB3bFNlYXJjaFN5bWJvbHMocSl7CiAgICBjb25zdCB7cmVzdWx0LCBlcnJvcn0gPSBhd2FpdCBzZWFyY2hTeW1ib2xGaW5uaHViKHF8fCcqJyk7CiAgICBpZihlcnJvcil7IGFsZXJ0KCdCxYLEhWQgd3lzenVraXdhbmlhOiAnK2Vycm9yKTsgcmV0dXJuOyB9CiAgICBjb25zdCBib3ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2xTZWFyY2hSZXN1bHRzJyk7CiAgICBpZighYm94KSByZXR1cm47CiAgICBjb25zdCBsaXN0ID0gKHJlc3VsdHx8W10pLnNsaWNlKDAsMjApLm1hcChyPT5gCiAgICAgIDxkaXYgY2xhc3M9InJvdyIgZGF0YS1zeW09IiR7ci5zeW1ib2x9IiBzdHlsZT0icGFkZGluZzo0cHggNnB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCAjMWYyOTM3OyBjdXJzb3I6cG9pbnRlciI+CiAgICAgICAgPGRpdiBjbGFzcz0idGlja2VyIiBzdHlsZT0ibWluLXdpZHRoOjEyMHB4Ij4ke3Iuc3ltYm9sfTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIiBzdHlsZT0ib3BhY2l0eTouOSI+JHtyLmRlc2NyaXB0aW9ufHwnJ308L2Rpdj4KICAgICAgPC9kaXY+YCkuam9pbignJykgfHwgJzxkaXYgY2xhc3M9InNtYWxsIG11dGVkIj5CcmFrIHd5bmlrw7N3LjwvZGl2Pic7CiAgICBib3guaW5uZXJIVE1MID0gbGlzdDsKICAgIGJveC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zeW1dJykuZm9yRWFjaChlbD0+ewogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jIChlKT0+ewogICAgICAgIGNvbnN0IHN5bSA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtc3ltJyk7CiAgICAgICAgY29uc3QgdEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsVGlja2VyJyk7CiAgICAgICAgaWYodEVsKSB0RWwudmFsdWUgPSBzeW07CiAgICAgICAgdHJ5eyBhd2FpdCBmZXRjaFF1b3RlRmlubmh1YihzeW0pOyB9Y2F0Y2goZSl7fQogICAgICAgIC8vIEZldGNoIGFuZCBjYWNoZSBjb21wYW55IG5hbWUKdHJ5eyBjb25zdCBwcm9maWxlID0gYXdhaXQgZmV0Y2hDb21wYW55UHJvZmlsZShzeW0pOyBpZihwcm9maWxlICYmIHByb2ZpbGUubmFtZSkgc2V0Q29tcGFueU5hbWUoc3ltLCBwcm9maWxlLm5hbWUpO31jYXRjaChfKXt9CnJlbmRlcldpc2hsaXN0KCk7IHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgCiAgLy8gTGl2ZSBzeW5jIGJldHdlZW4gJSBhbmQgYWJzb2x1dGUgdGFyZ2V0cyBpbiB3aXNobGlzdCBtb2RhbAogIGZ1bmN0aW9uIF9fd2xTeW5jVGFyZ2V0cyhmb3JtKXsKICAgIGlmKCFmb3JtKSByZXR1cm47CiAgICBjb25zdCBwcmljZUVsID0gZm9ybS5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPSJwcmljZSJdJyk7CiAgICBjb25zdCB0Z3RQY3RFbCA9IGZvcm0ucXVlcnlTZWxlY3RvcignaW5wdXRbbmFtZT0idGFyZ2V0UGN0Il0nKTsKICAgIGNvbnN0IHRndFByaWNlRWwgPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9InRhcmdldFByaWNlIl0nKTsKICAgIGNvbnN0IGJ1eVBjdEVsID0gZm9ybS5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPSJidXlUYXJnZXRQY3QiXScpOwogICAgY29uc3QgYnV5UHJpY2VFbCA9IGZvcm0ucXVlcnlTZWxlY3RvcignaW5wdXRbbmFtZT0iYnV5VGFyZ2V0UHJpY2UiXScpOwogICAgY29uc3QgcCA9IE51bWJlcihwcmljZUVsICYmIHByaWNlRWwudmFsdWUpIHx8IDA7CiAgICAvLyBTRUxMIHRhcmdldAogICAgaWYocD4wKXsKICAgICAgaWYoZG9jdW1lbnQuYWN0aXZlRWxlbWVudD09PXRndFBjdEVsIHx8ICh0Z3RQY3RFbCAmJiB0Z3RQY3RFbC5fbGFzdENoYW5nZWQpKXsKICAgICAgICBjb25zdCBwY3QgPSBOdW1iZXIodGd0UGN0RWwudmFsdWUpOwogICAgICAgIGlmKCFOdW1iZXIuaXNOYU4ocGN0KSkgeyBjb25zdCB2ID0gcCAqICgxICsgcGN0LzEwMCk7IGlmKHRndFByaWNlRWwpIHRndFByaWNlRWwudmFsdWUgPSB2ID8gdi50b0ZpeGVkKDQpIDogIiI7IH0KICAgICAgfWVsc2UgaWYodGd0UHJpY2VFbCl7CiAgICAgICAgY29uc3QgYWJzID0gTnVtYmVyKHRndFByaWNlRWwudmFsdWUpOwogICAgICAgIGlmKGFicz4wKXsgY29uc3QgcGN0ID0gKChhYnMvcCktMSkqMTAwOyBpZih0Z3RQY3RFbCkgdGd0UGN0RWwudmFsdWUgPSBwY3QudG9GaXhlZCgyKTsgfQogICAgICB9CiAgICAgIC8vIEJVWS1ORVhUIHRhcmdldDogaW50ZXJwcmV0ICUgbGl0ZXJhbGx5IChucC4gLTUgPT4gLTUlIG9kIGNlbnkgemFrdXB1KQogICAgICBpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50PT09YnV5UGN0RWwgfHwgKGJ1eVBjdEVsICYmIGJ1eVBjdEVsLl9sYXN0Q2hhbmdlZCkpewogICAgICAgIGNvbnN0IHBjdCA9IE51bWJlcihidXlQY3RFbC52YWx1ZSk7CiAgICAgICAgaWYoIU51bWJlci5pc05hTihwY3QpKSB7IGNvbnN0IHYgPSBwICogKDEgKyBwY3QvMTAwKTsgaWYoYnV5UHJpY2VFbCkgYnV5UHJpY2VFbC52YWx1ZSA9IHYgPyB2LnRvRml4ZWQoNCkgOiAiIjsgfQogICAgICB9ZWxzZSBpZihidXlQcmljZUVsKXsKICAgICAgICBjb25zdCBhYnMyID0gTnVtYmVyKGJ1eVByaWNlRWwudmFsdWUpOwogICAgICAgIGlmKGFiczI+MCl7IGNvbnN0IHBjdDIgPSAoKGFiczIvcCktMSkqMTAwOyBpZihidXlQY3RFbCkgYnV5UGN0RWwudmFsdWUgPSBwY3QyLnRvRml4ZWQoMik7IH0KICAgICAgfQogICAgfQogICAgLy8gbWFyayBsYXN0LWNoYW5nZWQgaW5wdXRzICh0byBhdm9pZCBwaW5nLXBvbmcpCiAgICBbdGd0UGN0RWwsIGJ1eVBjdEVsXS5mb3JFYWNoKGVsPT57CiAgICAgIGlmKGVsKXsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpPT57IGVsLl9sYXN0Q2hhbmdlZCA9IHRydWU7IH0pOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCAoKT0+eyBlbC5fbGFzdENoYW5nZWQgPSBmYWxzZTsgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgCiAgLy8gUmVzcG9uc2l2ZSB0YWJsZXM6IHdyYXAgYW55IHRhYmxlIHdpdGhvdXQgd3JhcHBlciB0byBlbmFibGUgaG9yaXpvbnRhbCBzY3JvbGwgb24gbW9iaWxlCiAgZnVuY3Rpb24gZW5zdXJlUmVzcG9uc2l2ZVRhYmxlcygpewogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgndGFibGUnKS5mb3JFYWNoKHRibD0+ewogICAgICBpZighdGJsLmNsb3Nlc3QoJy50YWJsZS13cmFwJykpewogICAgICAgIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICB3cmFwLmNsYXNzTmFtZSA9ICd0YWJsZS13cmFwJzsKICAgICAgICB0YmwucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUod3JhcCwgdGJsKTsKICAgICAgICB3cmFwLmFwcGVuZENoaWxkKHRibCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy8gRXZlbnQgd2lyaW5nCiAgJCgiI2FkZFBvcnRmb2xpb0J0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMoKT0+ewogICAgYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6Ik5vd3kgcG9ydGZlbCIsCiAgICAgIGlubmVySFRNTDpgPGZvcm0gY2xhc3M9InJvdyI+CiAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj4KICAgICAgICAgIDxsYWJlbD5OYXp3YSBwb3J0ZmVsYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibmFtZSIgcGxhY2Vob2xkZXI9Im5wLiBEeXdpZGVuZHkgMjAyNiIgcmVxdWlyZWQgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJ3aWR0aDoxODBweCI+CiAgICAgICAgICA8bGFiZWw+V2FsdXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJjdXJyZW5jeSIgdmFsdWU9IiR7ZW5zdXJlQ3VycmVuY3koKX0iIHBsYWNlaG9sZGVyPSJQTE4iIC8+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZm9ybT5gCiAgICB9KS50aGVuKGRhdGE9PnsKICAgICAgaWYoIWRhdGEpIHJldHVybjsKICAgICAgYWRkUG9ydGZvbGlvKCk7CiAgICAgIHJlbmFtZVBvcnRmb2xpbyhjdXJyZW50UGZJZCwgZGF0YS5uYW1lIHx8ICJOb3d5IHBvcnRmZWwiKTsKICAgICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7CiAgICAgIGlmKHBmKXsgcGYuY3VycmVuY3kgPSAoZGF0YS5jdXJyZW5jeXx8IlBMTiIpLnRvVXBwZXJDYXNlKCk7IHNhdmUoKTsgcmVuZGVyKCk7IH0KICAgIH0pOwogIH0pOwoKICAkKCIjcmVuYW1lQnRuIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuIGFsZXJ0KCJOYWpwaWVydyB3eWJpZXJ6IHBvcnRmZWwuIik7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6IlptaWXFhCBuYXp3xJkiLAogICAgICBpbm5lckhUTUw6YDxmb3JtPgogICAgICAgIDxsYWJlbD5OYXp3YTwvbGFiZWw+CiAgICAgICAgPGlucHV0IG5hbWU9Im5hbWUiIHZhbHVlPSIke19fZXNjKHBmLm5hbWUpfSIgLz4KICAgICAgPC9mb3JtPmAKICAgIH0pOwogICAgaWYoZGF0YSAmJiBkYXRhLm5hbWUpeyByZW5hbWVQb3J0Zm9saW8oY3VycmVudFBmSWQsIGRhdGEubmFtZSk7IH0KICB9KTsKCiAgJCgiI2RlbGV0ZUJ0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIGNvbnN0IGNvbmZpcm1EYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6IlVzdcWEIHBvcnRmZWwiLAogICAgICBva1RleHQ6IlRhaywgdXN1xYQiLAogICAgICBjYW5jZWxUZXh0OiJKZWRuYWsgbmllIiwKICAgICAgaW5uZXJIVE1MOmA8ZGl2IGNsYXNzPSJjb250ZW50Ij4KICAgICAgICA8cD5DenkgbmEgcGV3bm8gY2hjZXN6IHVzdW7EhcSHIHBvcnRmZWwgPGI+JHtfX2VzYyhwZi5uYW1lKX08L2I+PyBPcGVyYWNqxJkgbW/FvG5hIGNvZm7EhcSHIHByemV6IDIgZG5pICjihqnvuI8gQ29mbmlqKS4uPC9wPgogICAgICAgIDxwIGNsYXNzPSJzbWFsbCI+U2FsZG86ICR7X19nb19mbXRDdXJyZW5jeShwZi5jYXNoLCBwZi5jdXJyZW5jeSl9IOKAoiBQb3p5Y2plOiAke09iamVjdC5rZXlzKHBmLmhvbGRpbmdzKS5sZW5ndGh9PC9wPgogICAgICA8L2Rpdj5gCiAgICB9KTsKICAgIGlmKGNvbmZpcm1EYXRhIT09bnVsbCl7IGRlbGV0ZVBvcnRmb2xpbyhjdXJyZW50UGZJZCk7IH0KICB9KTsKCiAgJCgiI3NldHRpbmdzQnRuIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgY29uc3QgcyA9IERCLnNldHRpbmdzOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiJVc3Rhd2llbmlhIiwKICAgICAgaW5uZXJIVE1MOmA8Zm9ybSBjbGFzcz0ic2V0dGluZ3MtZm9ybSI+CiAgPHN0eWxlPgogICAgLyogU2NvcGVkIHN0eWxlcyBmb3IgU2V0dGluZ3MgbW9kYWwgKi8KICAgIC5zZXR0aW5ncy1mb3JteyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjsgZ2FwOjE0cHg7IH0KICAgIC5zZXR0aW5ncy1zZWN0aW9uc3sgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsgZ2FwOjEycHg7IH0KICAgIC5zZXR0aW5ncy1jYXJkewogICAgICBib3JkZXI6MXB4IHNvbGlkICMzMzQxNTU7IGJvcmRlci1yYWRpdXM6MTJweDsgcGFkZGluZzoxMnB4OwogICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDE3LDI0LDM5LC45NiksIHJnYmEoMTUsMjMsNDIsLjk2KSk7CiAgICB9CiAgICAuc2V0dGluZ3MtY2FyZCBoNHsgbWFyZ2luOjAgMCA4cHggMDsgZm9udC1zaXplOjE1cHg7IGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6OHB4OyB9CiAgICAuc2V0dGluZ3MtZ3JpZHsgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgxMiwgMWZyKTsgZ2FwOjEwcHg7IH0KICAgIC5zLWNvbC0zeyBncmlkLWNvbHVtbjogc3BhbiAzOyB9CiAgICAucy1jb2wtNHsgZ3JpZC1jb2x1bW46IHNwYW4gNDsgfQogICAgLnMtY29sLTZ7IGdyaWQtY29sdW1uOiBzcGFuIDY7IH0KICAgIC5zLWNvbC0xMnsgZ3JpZC1jb2x1bW46IHNwYW4gMTI7IH0KICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3MjBweCl7CiAgICAgIC5zZXR0aW5ncy1ncmlkID4gKnsgZ3JpZC1jb2x1bW46IHNwYW4gMTIgIWltcG9ydGFudDsgfQogICAgfQogICAgLmRlc2N7IGZvbnQtc2l6ZToxMnB4OyBvcGFjaXR5Oi44OyBtYXJnaW4tdG9wOjZweDsgfQogICAgLnN3aXRjaHsKICAgICAgZGlzcGxheTppbmxpbmUtZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTBweDsgY3Vyc29yOnBvaW50ZXI7IHVzZXItc2VsZWN0Om5vbmU7CiAgICAgIHBhZGRpbmc6OHB4IDEwcHg7IGJvcmRlci1yYWRpdXM6MTBweDsgYm9yZGVyOjFweCBzb2xpZCAjMzM0MTU1OyBiYWNrZ3JvdW5kOiMwYjEyMjI7CiAgICB9CiAgICAuc3dpdGNoIGlucHV0eyBhcHBlYXJhbmNlOm5vbmU7IHdpZHRoOjM2cHg7IGhlaWdodDoyMHB4OyBib3JkZXItcmFkaXVzOjk5OXB4OyBiYWNrZ3JvdW5kOiMzMzQxNTU7IHBvc2l0aW9uOnJlbGF0aXZlOyBvdXRsaW5lOm5vbmU7IHRyYW5zaXRpb246LjJzOyB9CiAgICAuc3dpdGNoIGlucHV0OmJlZm9yZXsgY29udGVudDoiIjsgcG9zaXRpb246YWJzb2x1dGU7IHdpZHRoOjE2cHg7IGhlaWdodDoxNnB4OyB0b3A6MnB4OyBsZWZ0OjJweDsgYm9yZGVyLXJhZGl1czo1MCU7IGJhY2tncm91bmQ6I2U1ZTdlYjsgdHJhbnNpdGlvbjouMnM7IH0KICAgIC5zd2l0Y2ggaW5wdXQ6Y2hlY2tlZHsgYmFja2dyb3VuZDojMTBiOTgxOyB9CiAgICAuc3dpdGNoIGlucHV0OmNoZWNrZWQ6YmVmb3JleyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTZweCk7IGJhY2tncm91bmQ6IzBiMTIyMjsgfQogICAgLmlubGluZXsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyB9CiAgICAubXV0ZWR7IGNvbG9yOiM5NGEzYjg7IH0KICAgIC5rdnsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBnYXA6MTBweDsgZm9udC1zaXplOjEycHg7IH0KICAgIC5rdiBjb2RleyBmb250LXNpemU6MTJweDsgb3BhY2l0eTouOTsgfQogICAgLnJvd3sgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6OHB4OyB9CiAgICAuc21hbGx7IGZvbnQtc2l6ZToxMnB4OyBjb2xvcjojOTRhM2I4OyB9CiAgCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KCiAgPGRpdiBjbGFzcz0ic2V0dGluZ3Mtc2VjdGlvbnMiPgoKICAgIDwhLS0gT0fDk0xORSAtLT4KICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWNhcmQiPgogICAgICA8aDQ+4pqZ77iPIE9nw7NsbmU8L2g0PgogICAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncy1ncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5Eb215xZtsbmEgd2FsdXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJjdXJyZW5jeURlZmF1bHQiIHZhbHVlPSIke3MuY3VycmVuY3lEZWZhdWx0fHwnUExOJ30iIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXNjIj5Vxbx5d2FuYSBwcnp5IG5vd3ljaCBwb3J0ZmVsYWNoIGkgZm9ybWF0b3dhbml1IHdhcnRvxZtjaS48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5TdGF3a2EgcG9kYXRrdSAoQmVsa2kpPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0YXhSYXRlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIG1pbj0iMCIgbWF4PSIxIiB2YWx1ZT0iJHtzLnRheFJhdGV9IiAvPgogICAgICAgICAgPGRpdiBjbGFzcz0iZGVzYyI+bnAuIDAuMTkgPSAxOSUgKG5hbGljemFuZSB0eWxrbyBwcnp5IHp5c2t1IHplIHNwcnplZGHFvHkpLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTQiPgogICAgICAgICAgPGxhYmVsPlNhbGRvIHVqZW1uZTwvbGFiZWw+CiAgICAgICAgICA8bGFiZWwgY2xhc3M9InN3aXRjaCI+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iYWxsb3dOZWdhdGl2ZUNhc2giICR7cy5hbGxvd05lZ2F0aXZlQ2FzaD8nY2hlY2tlZCc6Jyd9IC8+CiAgICAgICAgICAgIDxzcGFuPlplenfDs2wgbmEgc2FsZG8gdWplbW5lIChrcmVkeXQvbWFyZ2luKTwvc3Bhbj4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogICAgPCEtLSBBUEkgaSBDRU5ZIC0tPgogICAgPGRpdiBjbGFzcz0ic2V0dGluZ3MtY2FyZCI+CiAgICAgIDxoNCBjbGFzcz0ic2V0dGluZ3MtdGl0bGUtcm93Ij4KICAgICAgICA8c3Bhbj7wn5OhIEFQSSBpIGNlbnk8L3NwYW4+CiAgICAgICAgPGEgaHJlZj0iaHR0cHM6Ly9maW5uaHViLmlvLyIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIgbm9yZWZlcnJlciIgY2xhc3M9ImJ0biBnaG9zdCI+CiAgICAgICAgICBaZG9ixIVkxbogZGFybW93eSBrbHVjeiBBUEkKICAgICAgICA8L2E+CiAgICAgIDwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTYiPgogICAgICAgICAgPGxhYmVsPkZpbm5odWIgQVBJIFRva2VuPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJmaW5uaHViVG9rZW4iIHZhbHVlPSIke3MuZmlubmh1YlRva2VufHwnJ30iIC8+CiAgICAgICAgICAKICAgICAgICA8L2Rpdj4KCjxkaXYgY2xhc3M9InMtY29sLTYiPgogIDxsYWJlbD5GaW5uaHViIEFQSSBUb2tlbiAoV2lzaGxpc3QpPC9sYWJlbD4KICA8aW5wdXQgbmFtZT0iZmlubmh1YlRva2VuV2lzaGxpc3QiIHZhbHVlPSIke3MuZmlubmh1YlRva2VuV2lzaGxpc3R8fCcnfSIgLz4KICA8ZGl2IGNsYXNzPSJkZXNjIj5Pc29ibnkga2x1Y3ogZGxhIExpc3R5IMW7eWN6ZcWEIChwcnp5c3BpZXN6YSBvZMWbd2llxbxhbmllKS48L2Rpdj4KPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtMyI+CiAgICAgICAgICA8bGFiZWw+T2TFm3dpZcW8YW5pZSBrdXJzw7N3IFtzXTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0icHJpY2VQb2xsU2Vjb25kcyIgdHlwZT0ibnVtYmVyIiBtaW49IjUiIHN0ZXA9IjEiIHZhbHVlPSIke3MucHJpY2VQb2xsU2Vjb25kc3x8MzB9IiAvPgogICAgICAgICAgPGRpdiBjbGFzcz0iZGVzYyI+Q3rEmXN0b3RsaXdvxZvEhyBwb2JpZXJhbmlhIGNlbi48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC0zIj4KICAgICAgICAgIDxsYWJlbD5Ub2xlcmFuY2phIOKAnnpibGnFvGEgc2nEmeKAnSBbJV08L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImFwcHJvYWNoVG9sZXJhbmNlUGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMSIgbWluPSIwIiB2YWx1ZT0iJHtzLmFwcHJvYWNoVG9sZXJhbmNlUGN0fHwxfSIgLz4KICAgICAgICAgIDxkaXYgY2xhc3M9ImRlc2MiPklsZSAlIG9kIGNlbHUgdXpuYWplbXkgemEg4oCeYmxpc2tv4oCdLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gQUxFUlRZIETFuVdJxJhLT1dFIC0tPgogICAgPGRpdiBjbGFzcz0ic2V0dGluZ3MtY2FyZCI+CiAgICAgIDxoND7wn5uO77iPIEFsZXJ0eSBkxbp3acSZa293ZTwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTQiPgogICAgICAgICAgPGxhYmVsPkfFgsOzd25lPC9sYWJlbD4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0ic3dpdGNoIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJzb3VuZEFsZXJ0c0VuYWJsZWQiICR7cy5zb3VuZEFsZXJ0c0VuYWJsZWQhPT1mYWxzZT8nY2hlY2tlZCc6Jyd9IC8+CiAgICAgICAgICAgIDxzcGFuPlfFgsSFY3ogYWxhcm15IGTFundpxJlrb3dlPC9zcGFuPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC00Ij4KICAgICAgICAgIDxsYWJlbD7igJ5DZWwgb3NpxIVnbmnEmXR54oCdPC9sYWJlbD4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0ic3dpdGNoIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJzb3VuZEhpdFRhcmdldCIgJHtzLnNvdW5kSGl0VGFyZ2V0IT09ZmFsc2U/J2NoZWNrZWQnOicnfSAvPgogICAgICAgICAgICA8c3Bhbj5PZHR3YXJ6YWogcHJ6eSB0cmFmaWVuaXUgdyBjZWw8L3NwYW4+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTQiPgogICAgICAgICAgPGxhYmVsPuKAnkJsaXNrbyBjZWx14oCdPC9sYWJlbD4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0ic3dpdGNoIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJzb3VuZE5lYXJUYXJnZXQiICR7cy5zb3VuZE5lYXJUYXJnZXQhPT1mYWxzZT8nY2hlY2tlZCc6Jyd9IC8+CiAgICAgICAgICAgIDxzcGFuPk9kdHdhcnphaiBwcnp5IHpibGnFvGVuaXU8L3NwYW4+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5HxYJvxZtub8WbxIcgYWxhcm11PC9sYWJlbD4KICAgICAgICAgIDxkaXYgY2xhc3M9ImlubGluZSI+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJzb3VuZFZvbHVtZSIgdHlwZT0icmFuZ2UiIG1pbj0iMCIgbWF4PSIxNTAiIHN0ZXA9IjEiCiAgICAgICAgICAgICAgICAgICB2YWx1ZT0iJHsocy5zb3VuZFZvbHVtZT8/NjApfSIKICAgICAgICAgICAgICAgICAgIG9uaW5wdXQ9InRoaXMubmV4dEVsZW1lbnRTaWJsaW5nLnZhbHVlPXRoaXMudmFsdWUgKyAnJSciIC8+CiAgICAgICAgICAgIDxvdXRwdXQgY2xhc3M9InNtYWxsIj4keyhzLnNvdW5kVm9sdW1lPz82MCl9JTwvb3V0cHV0PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtNiI+CiAgICAgICAgICA8bGFiZWw+UG93dGFyemFuaWUgYWxhcm11IFtzXTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ic291bmRSZXBlYXRTZWNvbmRzIiB0eXBlPSJudW1iZXIiIG1pbj0iNSIgc3RlcD0iNSIgdmFsdWU9IiR7KHMuc291bmRSZXBlYXRTZWNvbmRzPz82MCl9IiAvPgogICAgICAgICAgPGRpdiBjbGFzcz0iZGVzYyI+Q28gaWxlIHNla3VuZCBwb25vd2nEhyBzeWduYcWCLCBnZHkgc3RhbiBuYWRhbCB0cndhLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICA8L2Rpdj4KCiAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncy1jYXJkIj4KICAgICAgPGg0Pkhpc3RvcmlhIGkgY29mYW5pZTwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IiBpZD0idW5kb0J0biIgdGl0bGU9IkNvZm5paiBvc3RhdG5pxIUgem1pYW7EmSAoaGlzdG9yaWEgMiBkbmkpIj7ihqnvuI8gQ29mbmlqPC9idXR0b24+CiAgICAgICAgPHNwYW4gY2xhc3M9InNtYWxsIG11dGVkIj5DdHJsL0NtZCtaIOKAlCBjb2ZuaWogdHJhbnNha2NqxJkg4oCiIFNoaWZ0K+KGqe+4jyAvIEN0cmwvQ21kK1NoaWZ0K1og4oCUIGtyb2tvd288L3NwYW4+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncy1jYXJkIj4KICAgICAgPGg0PvCfp6ggVXN0YXdpZW5pYSBrb250YTwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5Ob3dlIGhhc8WCbzwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibmV3UGFzc3dvcmQiIHR5cGU9InBhc3N3b3JkIiBtaW5sZW5ndGg9IjYiIGF1dG9jb21wbGV0ZT0ibmV3LXBhc3N3b3JkIiBwbGFjZWhvbGRlcj0ibWluLiA2IHpuYWvDs3ciIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXNjIj5Ob3dlIGhhc8WCbyB6b3N0YW5pZSB6YXBpc2FuZSBwbyBrbGlrbmnEmWNpdSBwcnp5Y2lza3UgIlphcGlzeiIgbmEgZG9sZSBva25hLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5Qb3d0w7NyeiBub3dlIGhhc8WCbzwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibmV3UGFzc3dvcmRDb25maXJtIiB0eXBlPSJwYXNzd29yZCIgbWlubGVuZ3RoPSI2IiBhdXRvY29tcGxldGU9Im5ldy1wYXNzd29yZCIgcGxhY2Vob2xkZXI9IndwaXN6IHBvbm93bmllIG5vd2UgaGFzxYJvIiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTEyIj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImJhbm5lciB3YXJuIj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8c3Ryb25nPlV3YWdhITwvc3Ryb25nPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5EZXpha3R5d2FjamEgdXN1bmllIFR3b2plIGtvbnRvIGkgZGFuZSB6IHNlcndlcmEuIE9wZXJhY2phIGplc3Qgbmllb2R3cmFjYWxuYS48L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIHdhcm4iIG9uY2xpY2s9ImlmKHdpbmRvdy5wYXJlbnQgJiYgd2luZG93LnBhcmVudC5fX3JlcXVlc3RBY2NvdW50RGVsZXRpb24peyB3aW5kb3cucGFyZW50Ll9fcmVxdWVzdEFjY291bnREZWxldGlvbigpOyB9Ij4KICAgICAgICAgICAgICBEZXpha3R5d3VqIGtvbnRvCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+Cgo8L2Zvcm0+YAogICAgfSk7CiAgICBpZihkYXRhKXsKICAgICAgLy8gWm1pYW5hIGhhc8WCYSAob2JzxYJ1Z2l3YW5hIHByemV6IGFwbGlrYWNqxJkgZ8WCw7N3bsSFKQogICAgICBpZiAoZGF0YS5uZXdQYXNzd29yZCB8fCBkYXRhLm5ld1Bhc3N3b3JkQ29uZmlybSkgewogICAgICAgIGlmICghZGF0YS5uZXdQYXNzd29yZCB8fCAhZGF0YS5uZXdQYXNzd29yZENvbmZpcm0pIHsKICAgICAgICAgIGFsZXJ0KCJBYnkgem1pZW5pxIcgaGFzxYJvLCB3eXBlxYJuaWogb2JhIHBvbGE6IG5vd2UgaGFzxYJvIGkgcG93dMOzcnplbmllLiIpOwogICAgICAgIH0gZWxzZSBpZiAoZGF0YS5uZXdQYXNzd29yZCAhPT0gZGF0YS5uZXdQYXNzd29yZENvbmZpcm0pIHsKICAgICAgICAgIGFsZXJ0KCJOb3dlIGhhc8WCbyBpIHBvdHdpZXJkemVuaWUgbmllIHPEhSB0YWtpZSBzYW1lLiIpOwogICAgICAgIH0gZWxzZSBpZiAoZGF0YS5uZXdQYXNzd29yZC5sZW5ndGggPCA2KSB7CiAgICAgICAgICBhbGVydCgiSGFzxYJvIG11c2kgbWllxIcgY28gbmFqbW5pZWogNiB6bmFrw7N3LiIpOwogICAgICAgIH0gZWxzZSBpZiAod2luZG93LnBhcmVudCAmJiB3aW5kb3cucGFyZW50Ll9fcmVxdWVzdFBhc3N3b3JkQ2hhbmdlKSB7CiAgICAgICAgICB3aW5kb3cucGFyZW50Ll9fcmVxdWVzdFBhc3N3b3JkQ2hhbmdlKGRhdGEubmV3UGFzc3dvcmQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhbGVydCgiWm1pYW5hIGhhc8WCYSBuaWUgamVzdCBkb3N0xJlwbmEgdyB0ZWogd2Vyc2ppIGFwbGlrYWNqaS4iKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIERCLnNldHRpbmdzLnRheFJhdGUgPSBOdW1iZXIoZGF0YS50YXhSYXRlKXx8MC4xOTsKICAgICAgREIuc2V0dGluZ3MuY3VycmVuY3lEZWZhdWx0ID0gKGRhdGEuY3VycmVuY3lEZWZhdWx0fHwiUExOIikudG9VcHBlckNhc2UoKTsKICAgICAgREIuc2V0dGluZ3MuYWxsb3dOZWdhdGl2ZUNhc2ggPSAhIWRhdGEuYWxsb3dOZWdhdGl2ZUNhc2g7CiAgICAgIERCLnNldHRpbmdzLmZpbm5odWJUb2tlbiA9IGRhdGEuZmlubmh1YlRva2VufHwiIjsKICAgICAgREIuc2V0dGluZ3MuZmlubmh1YlRva2VuV2lzaGxpc3QgPSBkYXRhLmZpbm5odWJUb2tlbldpc2hsaXN0fHwiIjsKICAgICAgREIuc2V0dGluZ3MucHJpY2VQb2xsU2Vjb25kcyA9IE51bWJlcihkYXRhLnByaWNlUG9sbFNlY29uZHMpfHwzMDsKICAgICAgREIuc2V0dGluZ3MuYXBwcm9hY2hUb2xlcmFuY2VQY3QgPSBOdW1iZXIoZGF0YS5hcHByb2FjaFRvbGVyYW5jZVBjdCl8fDE7CiAgICAgIERCLnNldHRpbmdzLnNvdW5kQWxlcnRzRW5hYmxlZCA9ICEhZGF0YS5zb3VuZEFsZXJ0c0VuYWJsZWQ7CiAgICAgIERCLnNldHRpbmdzLnNvdW5kSGl0VGFyZ2V0ID0gISFkYXRhLnNvdW5kSGl0VGFyZ2V0OwogICAgICBEQi5zZXR0aW5ncy5zb3VuZE5lYXJUYXJnZXQgPSAhIWRhdGEuc291bmROZWFyVGFyZ2V0OwogICAgICBEQi5zZXR0aW5ncy5zb3VuZFZvbHVtZSA9IE51bWJlcihkYXRhLnNvdW5kVm9sdW1lID8/IERCLnNldHRpbmdzLnNvdW5kVm9sdW1lID8/IDQwKTsKICAgICAgREIuc2V0dGluZ3Muc291bmRSZXBlYXRTZWNvbmRzID0gTnVtYmVyKGRhdGEuc291bmRSZXBlYXRTZWNvbmRzID8/IERCLnNldHRpbmdzLnNvdW5kUmVwZWF0U2Vjb25kcyA/PyA2MCk7CiAgICAgIHNhdmUoKTsgcmVuZGVyKCk7CiAgICAgIHN0YXJ0UG9sbGluZ1F1b3RlcygpOwogICAgfQogICAgaWYoZGF0YSl7CiAgICAgIERCLnNldHRpbmdzLnRheFJhdGUgPSBOdW1iZXIoZGF0YS50YXhSYXRlKXx8MC4xOTsKICAgICAgREIuc2V0dGluZ3MuY3VycmVuY3lEZWZhdWx0ID0gKGRhdGEuY3VycmVuY3lEZWZhdWx0fHwiUExOIikudG9VcHBlckNhc2UoKTsKICAgICAgREIuc2V0dGluZ3MuYWxsb3dOZWdhdGl2ZUNhc2ggPSAhIWRhdGEuYWxsb3dOZWdhdGl2ZUNhc2g7CiAgICAgIHNhdmUoKTsgcmVuZGVyKCk7CiAgICB9CiAgfSk7CgogICQoIiNkZXBvc2l0QnRuIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuIGFsZXJ0KCJOYWpwaWVydyB3eWJpZXJ6IHBvcnRmZWwuIik7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6IldwxYJhdGEgZG8gcG9ydGZlbGEiLAogICAgICBpbm5lckhUTUw6YDxmb3JtIGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgICA8bGFiZWw+S3dvdGEgKCR7cGYuY3VycmVuY3l9KTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYW1vdW50IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPgogICAgICAgICAgPGxhYmVsPk5vdGF0a2EgKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgPC9mb3JtPmAKICAgIH0pOwogICAgaWYoZGF0YSAmJiBkYXRhLmFtb3VudCl7IGRlcG9zaXQoY3VycmVudFBmSWQsIGRhdGEuYW1vdW50LCBkYXRhLm5vdGV8fCIiKTsgfQogIH0pOwoKICAkKCIjY2FzaEFjdGlvbnNCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm4gYWxlcnQoIk5hanBpZXJ3IHd5YmllcnogcG9ydGZlbC4iKTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZToiT3BlcmFjamUgZ290w7N3a293ZSIsCiAgICAgIGlubmVySFRNTDpgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5Ld290YSAoJHtwZi5jdXJyZW5jeX0pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJhbW91bnQiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiByZXF1aXJlZCAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5Sb2R6YWo8L2xhYmVsPgogICAgICAgICAgPHNlbGVjdCBuYW1lPSJraW5kIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZGVwb3NpdCI+V3DFgmF0YTwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJ3aXRoZHJhdyI+V3lwxYJhdGE8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgPC9mb3JtPmAKICAgIH0pOwogICAgaWYoIWRhdGEpIHJldHVybjsKICAgIGlmKGRhdGEua2luZD09PSJkZXBvc2l0IikgZGVwb3NpdChjdXJyZW50UGZJZCwgZGF0YS5hbW91bnQsIGRhdGEubm90ZXx8IiIpOwogICAgZWxzZSB3aXRoZHJhdyhjdXJyZW50UGZJZCwgZGF0YS5hbW91bnQsIGRhdGEubm90ZXx8IiIpOwogIH0pOwoKICAkKCIjd2l0aGRyYXdCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm4gYWxlcnQoIk5hanBpZXJ3IHd5YmllcnogcG9ydGZlbC4iKTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZToiV3lwxYJhdGEgeiBwb3J0ZmVsYSIsCiAgICAgIGlubmVySFRNTDpgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5Ld290YSAoJHtwZi5jdXJyZW5jeX0pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJhbW91bnQiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiByZXF1aXJlZCAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYSAob3Bjam9uYWxuaWUpPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiAvPgogICAgICAgIDwvZGl2PgogICAgICA8L2Zvcm0+YAogICAgfSk7CiAgICBpZihkYXRhICYmIGRhdGEuYW1vdW50KXsgd2l0aGRyYXcoY3VycmVudFBmSWQsIGRhdGEuYW1vdW50LCBkYXRhLm5vdGV8fCIiKTsgfQogIH0pOwoKICAkKCIjdHJhbnNmZXJCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBpZihEQi5wb3J0Zm9saW9zLmxlbmd0aDwyKXsgcmV0dXJuIGFsZXJ0KCJEb2RhaiBwcnp5bmFqbW5pZWogZHdhIHBvcnRmZWxlLCBhYnkgd3lrb25hxIcgcHJ6ZWxldy4iKTsgfQogICAgY29uc3Qgb3B0cyA9IERCLnBvcnRmb2xpb3MubWFwKHA9PmA8b3B0aW9uIHZhbHVlPSIke3AuaWR9Ij4ke19fZXNjKHAubmFtZSl9ICgke3AuY3VycmVuY3l9KTwvb3B0aW9uPmApLmpvaW4oIiIpOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiJQcnplbGV3IG1pxJlkenkgcG9ydGZlbGFtaSIsCiAgICAgIGlubmVySFRNTDpgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD7FuXLDs2TFgm88L2xhYmVsPgogICAgICAgICAgPHNlbGVjdCBuYW1lPSJmcm9tSWQiPiR7b3B0c308L3NlbGVjdD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgICA8bGFiZWw+Q2VsPC9sYWJlbD4KICAgICAgICAgIDxzZWxlY3QgbmFtZT0idG9JZCI+JHtvcHRzfTwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5Ld290YTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYW1vdW50IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dG9kYXkoKX0iIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5Ob3RhdGthPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiBwbGFjZWhvbGRlcj0ibnAuIHBvxbx5Y3prYSB6IGZpcm15IEEgZG8gQiIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgPC9mb3JtPmAKICAgIH0pOwogICAgaWYoIWRhdGEpIHJldHVybjsKICAgIHRyYW5zZmVyKGRhdGEuZnJvbUlkLCBkYXRhLnRvSWQsIGRhdGEuYW1vdW50LCBkYXRhLm5vdGV8fCIiKTsKICB9KTsKCiAgJCgiI2J1eUJ0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybiBhbGVydCgiTmFqcGllcncgd3liaWVyeiBwb3J0ZmVsLiIpOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiJaYWt1cCAobm93YSBwYXJ0aWEpIiwKICAgICAgaW5uZXJIVE1MOmA8Zm9ybSBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPlRpY2tlciA8c3BhbiBjbGFzcz0ic21hbGwiPihFbnRlciBwb2JpZXJ6ZSBrdXJzIHogRmlubmh1Yik8L3NwYW4+PC9sYWJlbD4KICAgICAgICAgIDxkaXYgY2xhc3M9InJvdyIgc3R5bGU9ImdhcDo2cHgiPjxpbnB1dCBuYW1lPSJ0aWNrZXIiIGlkPSJidXlUaWNrZXIiIHBsYWNlaG9sZGVyPSJucC4gVFNMQSAvIFBLTi5XQSIgcmVxdWlyZWQgLz48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBzZWNvbmRhcnkiIGlkPSJidG5GZXRjaFByaWNlIj5Qb2JpZXJ6IGNlbsSZPC9idXR0b24+PGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJidG5TZWFyY2hTeW1ib2wiPlN6dWthaiBzeW1ib2x1PC9idXR0b24+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPklsb8WbxIc8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InF0eSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+Q2VuYSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InByaWNlIiBpZD0iYnV5UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPk9wxYJhdHk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImZlZXMiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiB2YWx1ZT0iMCIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dG9kYXkoKX0iIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPkNlbCB6eXNrdSAlIChvcGNqb25hbG5pZSk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBwbGFjZWhvbGRlcj0ibnAuIDUgPSArNSUiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPkNlbCBjZW5hIC8gc3p0LiAob3Bjam9uYWxuaWUpPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0YXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHBsYWNlaG9sZGVyPSJucC4gMTIwLjAwIiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5DZWwgS1VQTkEgJSAoc3BhZGVrLCBvcGNqLik8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImJ1eVRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBwbGFjZWhvbGRlcj0ibnAuIDUgPSAtNSUgb2Qga29zenR1IiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5DZWwgS1VQTkEgY2VuYSAvIHN6dC4gKG9wY2ouKTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBwbGFjZWhvbGRlcj0ibnAuIDk1LjAwIiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiBzbWFsbCIgaWQ9ImJ1eVByaWNlTXNnIiBzdHlsZT0ibWluLWhlaWdodDoyMHB4Ij48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPgogICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHBsYWNlaG9sZGVyPSJucC4gemFrdXAgd2cgc3RyYXRlZ2lpIG1vbWVudHVtIiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiBzbWFsbCI+VXdhZ2E6IGt1cnMgeiBGaW5uaHViIG1vxbxlIGJ5xIcgdyB3YWx1Y2llIG5vdG93YW5pYSBpbnN0cnVtZW50dSAoYmV6IGtvbndlcnNqaSkuPC9kaXY+CiAgICAgIDwvZm9ybT5gCiAgICB9KTsKICAgIGNvbnN0IHRFbCA9ICQoIiNidXlUaWNrZXIiKSwgcEVsID0gJCgiI2J1eVByaWNlIiksIG1zZ0VsID0gJCgiI2J1eVByaWNlTXNnIik7CiAgICBhc3luYyBmdW5jdGlvbiB1aUZldGNoUHJpY2UoKXsKICAgICAgbXNnRWwudGV4dENvbnRlbnQgPSAiUG9iaWVyYW0gY2VuxJkgeiBGaW5uaHVi4oCmIjsKICAgICAgY29uc3Qgc3ltID0gKHRFbC52YWx1ZXx8IiIpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgICBpZighc3ltKXsgbXNnRWwudGV4dENvbnRlbnQgPSAiUG9kYWogc3ltYm9sIChucC4gVFNMQSwgUEtOLldBKSI7IHJldHVybjsgfQogICAgICBjb25zdCB7cHJpY2UsIGVycm9yfSA9IGF3YWl0IGZldGNoUXVvdGVGaW5uaHViKHN5bSk7CiAgICAgIGlmKHByaWNlIT1udWxsKXsgcEVsLnZhbHVlID0gcHJpY2U7IG1zZ0VsLnRleHRDb250ZW50ID0gIk9LOiAiICsgcHJpY2U7IH0KICAgICAgZWxzZSB7IG1zZ0VsLnRleHRDb250ZW50ID0gIkLFgsSFZDogIiArIChlcnJvcnx8ImJyYWsgZGFueWNoIik7IH0KICAgIH0KICAgIHRFbD8uYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGFzeW5jIChldik9PnsKICAgICAgaWYoZXYua2V5PT09IkVudGVyIil7CiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICBhd2FpdCB1aUZldGNoUHJpY2UoKTsKICAgICAgfQogICAgfSk7CiAgICAkKCIjYnRuRmV0Y2hQcmljZSIpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHVpRmV0Y2hQcmljZSk7CgogICAgJCgiI2J0blNlYXJjaFN5bWJvbCIpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICAgIGNvbnN0IHEgPSAodEVsLnZhbHVlfHwiIikudHJpbSgpOwogICAgICBjb25zdCB7cmVzdWx0LCBlcnJvcn0gPSBhd2FpdCBzZWFyY2hTeW1ib2xGaW5uaHViKHF8fCIqIik7CiAgICAgIGlmKGVycm9yKXsgYWxlcnQoIlN6dWthaiBzeW1ib2x1IOKAlCBixYLEhWQ6ICIrZXJyb3IpOyByZXR1cm47IH0KICAgICAgaWYoIXJlc3VsdC5sZW5ndGgpeyBhbGVydCgiQnJhayB3eW5pa8OzdyBkbGE6ICIrcSk7IHJldHVybjsgfQogICAgICAvLyBzaW1wbGUgcGlja2VyIGluLXBsYWNlCiAgICAgIGNvbnN0IGxpc3QgPSByZXN1bHQuc2xpY2UoMCwxMCkubWFwKHI9PmAKICAgICAgICA8dHIgZGF0YS1zeW09IiR7ci5zeW1ib2x9Ij48dGQ+JHtyLnN5bWJvbH08L3RkPjx0ZD4ke3IuZGVzY3JpcHRpb258fCcnfTwvdGQ+PHRkIGNsYXNzPSJzbWFsbCI+JHtyLnR5cGV8fCcnfTwvdGQ+PHRkIGNsYXNzPSJzbWFsbCI+JHtyLmRpc3BsYXlTeW1ib2x8fCcnfTwvdGQ+PC90cj4KICAgICAgYCkuam9pbigiIik7CiAgICAgIGNvbnN0IHBpY2tlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBwaWNrZXIuY2xhc3NOYW1lID0gImNhcmQgcGFuZWwiOwogICAgICBwaWNrZXIuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9InNtYWxsIiBzdHlsZT0ibWFyZ2luOjZweCAwIj5XeWJpZXJ6IHN5bWJvbDo8L2Rpdj48ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj48dGFibGU+PHRoZWFkPjx0cj48dGg+U3ltYm9sPC90aD48dGg+T3BpczwvdGg+PHRoPlR5cDwvdGg+PHRoPkRpc3BsYXk8L3RoPjwvdHI+PC90aGVhZD48dGJvZHk+JHtsaXN0fTwvdGJvZHk+PC90YWJsZT48L2Rpdj5gOwogICAgICBtb2RhbENvbnRlbnQuYXBwZW5kQ2hpbGQocGlja2VyKTsKICAgICAgcGlja2VyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpPT57CiAgICAgICAgY29uc3QgdHIgPSBlLnRhcmdldC5jbG9zZXN0KCd0cltkYXRhLXN5bV0nKTsgaWYoIXRyKSByZXR1cm47CiAgICAgICAgY29uc3Qgc3ltID0gdHIuZ2V0QXR0cmlidXRlKCdkYXRhLXN5bScpOwogICAgICAgIHRFbC52YWx1ZSA9IHN5bTsKICAgICAgICBwaWNrZXIucmVtb3ZlKCk7CiAgICAgICAgYXdhaXQgdWlGZXRjaFByaWNlKCk7CiAgICAgIH0sIHtvbmNlOmZhbHNlfSk7CiAgICB9KTsKCiAgICBpZighZGF0YSkgcmV0dXJuOwogICAgYnV5KGN1cnJlbnRQZklkLCB7CiAgICAgIHRpY2tlcjogZGF0YS50aWNrZXIsIGRhdGU6IGRhdGEuZGF0ZSwgcXR5OiBkYXRhLnF0eSwgcHJpY2U6IGRhdGEucHJpY2UsIGZlZXM6IGRhdGEuZmVlcywgbm90ZTogZGF0YS5ub3RlLAogICAgICB0YXJnZXRQY3Q6IGRhdGEudGFyZ2V0UGN0LCB0YXJnZXRQcmljZTogZGF0YS50YXJnZXRQcmljZSwgYnV5VGFyZ2V0UGN0OiBkYXRhLmJ1eVRhcmdldFBjdCwgYnV5VGFyZ2V0UHJpY2U6IGRhdGEuYnV5VGFyZ2V0UHJpY2UKICAgIH0pOwogIH0pOwoKICAKJCgiI3NlbGxCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57CiAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuIGFsZXJ0KCJOYWpwaWVydyB3eWJpZXJ6IHBvcnRmZWwuIik7CiAgY29uc3QgdGlja2VycyA9IE9iamVjdC5rZXlzKHBmLmhvbGRpbmdzfHx7fSk7CiAgaWYoIXRpY2tlcnMubGVuZ3RoKSByZXR1cm4gYWxlcnQoIkJyYWsgcG96eWNqaSBkbyBzcHJ6ZWRhxbx5LiIpOwogIGNvbnN0IG9wdHNUaWNrID0gdGlja2Vycy5tYXAodD0+YDxvcHRpb24gdmFsdWU9IiR7dH0iPiR7dH08L29wdGlvbj5gKS5qb2luKCIiKTsKCiAgY29uc3QgcHJvbSA9IG9wZW5Nb2RhbCh7CiAgICB0aXRsZToiU3ByemVkYcW8IOKAlCB3eWJpZXJ6IHBhcnRpZSBpIGlsb8WbY2kiLAogICAgaW5uZXJIVE1MOmA8Zm9ybSBpZD0ic2VsbEZvcm0iIGNsYXNzPSJjb250ZW50Ij4KICAgICAgPGxhYmVsPlRpY2tlcjwvbGFiZWw+CiAgICAgIDxzZWxlY3QgbmFtZT0idGlja2VyIiBpZD0ic2VsbFRpY2tlciI+JHtvcHRzVGlja308L3NlbGVjdD4KICAgICAgPGRpdiBpZD0ic2VsbExvdHNCb3giIHN0eWxlPSJtYXJnaW4tdG9wOjEycHgiPjwvZGl2PgogICAgPC9mb3JtPmAsCiAgICBva1RleHQ6Ilpha3NpxJlndWoiCiAgfSk7CgogIGNvbnN0IHNlbEVsID0gJCgiI3NlbGxUaWNrZXIiKTsKICBjb25zdCBsb3RzQm94ID0gJCgiI3NlbGxMb3RzQm94Iik7CiAgZnVuY3Rpb24gcmVuZGVyTG90cygpewogICAgY29uc3QgdCA9IHNlbEVsLnZhbHVlOwogICAgY29uc3QgYm9vayA9IHBmLmhvbGRpbmdzW3RdOwogICAgaWYoIWJvb2speyBsb3RzQm94LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSdzbWFsbCc+QnJhayBwYXJ0aWkuPC9kaXY+IjsgcmV0dXJuOyB9CiAgICBjb25zdCByb3dzID0gKGJvb2subG90c3x8W10pLm1hcChsPT5gCiAgICAgIDx0cj4KICAgICAgICA8dGQ+PGNvZGU+JHtsLmxvdElkLnNsaWNlKDAsOCl9PC90ZD4KICAgICAgICA8dGQ+JHtfX2VzYyhsLmRhdGV8fCIiKX08L3RkPgogICAgICAgIDx0ZD4ke19fZm10TnVtKGwucXR5KX08L3RkPgogICAgICAgIDx0ZD4ke19fZ29fZm10Q3VycmVuY3kobC51bml0Q29zdCwgcGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkPjxpbnB1dCBuYW1lPSJsb3RfJHtsLmxvdElkfSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgbWF4PSIke2wucXR5fSIgcGxhY2Vob2xkZXI9IjAiIC8+PC90ZD4KICAgICAgPC90cj4KICAgIGApLmpvaW4oIiIpOwogICAgbG90c0JveC5pbm5lckhUTUwgPSBgCiAgICAgIDxkaXYgY2xhc3M9ImdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5DZW5hIHNwcnplZGHFvHkgLyBzenQuPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJzZWxsUHJpY2UiIGlkPSJzZWxsUHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPk9wxYJhdHk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InNlbGxGZWVzIiBpZD0ic2VsbEZlZXMiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiB2YWx1ZT0iMCIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ic2VsbERhdGUiIGlkPSJzZWxsRGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dG9kYXkoKX0iIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5Ob3RhdGthPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJzZWxsTm90ZSIgaWQ9InNlbGxOb3RlIiBwbGFjZWhvbGRlcj0ibnAuIHJlYWxpemFjamEgenlza3UiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjEwcHgiPjwvZGl2PgogICAgICA8dGFibGU+CiAgICAgICAgPHRoZWFkPgogICAgICAgICAgPHRyPjx0aD5QYXJ0aWE8L3RoPjx0aD5EYXRhPC90aD48dGg+SWxvxZvEhyBkb3N0xJlwbmE8L3RoPjx0aD5Lb3N6dCAvIHN6dC48L3RoPjx0aD5JbG/Fm8SHIGRvIHNwcnplZGHFvHk8L3RoPjwvdHI+CiAgICAgICAgPC90aGVhZD4KICAgICAgICA8dGJvZHk+JHtyb3dzfTwvdGJvZHk+CiAgICAgIDwvdGFibGU+CiAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5XcGlzeiBpbG/Fm2NpIGRvIHNwcnplZGHFvHkgdyB3eWJyYW55Y2ggcGFydGlhY2ggKHNwcnplZGHFvCBzcGVjeWZpY3puYSDigJQgbmllIEZJRk8pLjwvZGl2PgogICAgYDsKICB9CiAgcmVuZGVyTG90cygpOwogIHNlbEVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHJlbmRlckxvdHMpOwoKICBwcm9tLnRoZW4oZGF0YT0+ewogICAgaWYoIWRhdGEpIHJldHVybjsgLy8gY2FuY2VsCiAgICBjb25zdCB0ID0gKGRhdGEudGlja2VyfHwiIikudG9VcHBlckNhc2UoKS50cmltKCk7CiAgICBjb25zdCBwU2VsbCA9IE51bWJlcihkYXRhLnNlbGxQcmljZXx8MCk7CiAgICBjb25zdCBmZWVzID0gTnVtYmVyKGRhdGEuc2VsbEZlZXN8fDApOwogICAgY29uc3QgZGF0ZSA9IGRhdGEuc2VsbERhdGUgfHwgdG9kYXkoKTsKICAgIGNvbnN0IG5vdGUgPSBkYXRhLnNlbGxOb3RlIHx8ICIiOwogICAgY29uc3QgYWxsb2NhdGlvbnMgPSBPYmplY3QuZW50cmllcyhkYXRhKQogICAgICAuZmlsdGVyKChbayx2XSk9PiBrLnN0YXJ0c1dpdGgoJ2xvdF8nKSAmJiBOdW1iZXIodik+MCkKICAgICAgLm1hcCgoW2ssdl0pPT4oeyBsb3RJZDogay5zbGljZSg0KSwgcXR5OiBOdW1iZXIodikgfSkpOwogICAgc2VsbChjdXJyZW50UGZJZCwgeyB0aWNrZXI6IHQsIGRhdGUsIHNlbGxQcmljZTogcFNlbGwsIGZlZXMsIGFsbG9jYXRpb25zLCBub3RlIH0pOwogIH0pOwp9KTsKCiAgLy8gRXgvSW0gcG9ydAogIGZ1bmN0aW9uIGV4cG9ydEpTT04oKXsKICAgIGNvbnN0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShEQiwgbnVsbCwgMik7CiAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2RhdGFdLCB7dHlwZToiYXBwbGljYXRpb24vanNvbiJ9KTsKICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgYS5ocmVmID0gdXJsOwogICAgYS5kb3dubG9hZCA9IGBwb3J0ZmVsZV9maXJteV9iYWNrdXBfJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc2xpY2UoMCwxMCl9Lmpzb25gOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgIGEuY2xpY2soKTsKICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICBhLnJlbW92ZSgpOwogICAgfSwgMTAwMCk7CiAgfQogICQoIiNleHBvcnRCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGV4cG9ydEpTT04pOwogICQoIiNleHBvcnRMaW5rMiIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZXhwb3J0SlNPTik7CiAgJCgiI2ltcG9ydExpbmsyIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ICQoIiNpbXBvcnRGaWxlIikuY2xpY2soKSk7CiAgJCgiI2ltcG9ydEZpbGUiKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBhc3luYyAoZSk9PnsKICAgIGNvbnN0IGZpbGUgPSBlLnRhcmdldC5maWxlc1swXTsKICAgIGlmKCFmaWxlKSByZXR1cm47CiAgICBjb25zdCB0eHQgPSBhd2FpdCBmaWxlLnRleHQoKTsKICAgIHRyeXsKICAgICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZSh0eHQpOwogICAgICBpZighb2JqLnBvcnRmb2xpb3MpIHRocm93IG5ldyBFcnJvcigiQnJhayBrbHVjemEgcG9ydGZvbGlvcy4iKTsKICAgICAgREIgPSBvYmo7IHRyeXsgZW5zdXJlV2F0Y2hsaXN0U3RydWN0dXJlKCk7IH1jYXRjaChfKXt9IHNhdmUoKTsgcmVuZGVyKCk7IHN0YXJ0UG9sbGluZ1F1b3RlcygpOwogICAgICBhbGVydCgiWmFpbXBvcnRvd2FubyBkYW5lLiIpOwogICAgfWNhdGNoKGVycil7CiAgICAgIGFsZXJ0KCJCxYLEhWQgaW1wb3J0dTogIitlcnIubWVzc2FnZSk7CiAgICB9CiAgICBlLnRhcmdldC52YWx1ZSA9ICIiOwogIH0pOwoKICAKICAvLyBIaXN0b3J5IGFjdGlvbnM6IEVkaXQgLyBEZWxldGUKICB0eFRhYmxlV3JhcC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jIChlKT0+ewogICAgY29uc3Qgcm93ID0gZS50YXJnZXQuY2xvc2VzdCgndHIudHgtcm93Jyk7CiAgICBjb25zdCBidG4gPSBlLnRhcmdldC5jbG9zZXN0KCdidXR0b24nKTsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIGlmKHJvdyAmJiAhYnRuKXsgLy8gY2xpY2sgcm93IHRvIGVkaXQKICAgICAgY29uc3QgdHhJZCA9IHJvdy5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHgnKTsKICAgICAgY29uc3QgdHhJbmRleCA9IHBmLnRyYW5zYWN0aW9ucy5maW5kSW5kZXgoeD0+eC5pZD09PXR4SWQpOwogICAgICBpZih0eEluZGV4Pj0wKXsgY29uc3QgZmFrZUJ0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOyBmYWtlQnRuLmNsYXNzTmFtZT0ndHgtZWRpdCc7IGZha2VCdG4uc2V0QXR0cmlidXRlKCdkYXRhLXR4JywgdHhJZCk7IGZha2VCdG4uY2xpY2soKTsgfQogICAgICByZXR1cm47CiAgICB9CiAgICBpZighYnRuKSByZXR1cm47CiAgICBjb25zdCB0eElkID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10eCcpOyBpZighdHhJZCkgcmV0dXJuOwogICAgY29uc3QgdHhJbmRleCA9IHBmLnRyYW5zYWN0aW9ucy5maW5kSW5kZXgoeD0+eC5pZD09PXR4SWQpOwogICAgaWYodHhJbmRleDwwKSByZXR1cm47CgogICAgaWYoYnRuLmNsYXNzTGlzdC5jb250YWlucygndHgtc2VsbC1mcm9tLWJ1eScpKXsKICAgICAgY29uc3QgdHhJZCA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHgnKTsKICAgICAgY29uc3QgdHhJbmRleCA9IHBmLnRyYW5zYWN0aW9ucy5maW5kSW5kZXgoeD0+eC5pZD09PXR4SWQpOwogICAgICBpZih0eEluZGV4PDApIHJldHVybjsKICAgICAgY29uc3QgdCA9IHBmLnRyYW5zYWN0aW9uc1t0eEluZGV4XTsKICAgICAgaWYodC50eXBlIT09J2J1eScpeyByZXR1cm47IH0KICAgICAgY29uc3QgbG90SWQgPSB0LmxvdElkOyBjb25zdCB0aWNrZXIgPSB0LnRpY2tlcjsgY29uc3QgbWF4UXR5ID0gdC5xdHk7CiAgICAgIGNvbnN0IGZvcm1IVE1MID0gYDxmb3JtIGNsYXNzPSJncmlkIj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPkNlbmEgc3ByemVkYcW8eSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0ic2VsbFByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiByZXF1aXJlZCAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5PcMWCYXR5PC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9ImZlZXMiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiB2YWx1ZT0iMCIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+SWxvxZvEhyBkbyBzcHJ6ZWRhxbx5PC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9InF0eSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgbWF4PSIke21heFF0eX0iIHZhbHVlPSIke21heFF0eX0iIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgICAgIDxsYWJlbD5Ob3RhdGthPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHBsYWNlaG9sZGVyPSJzcHJ6ZWRhxbwgdGVqIHRyYW5zYWtjamkgKHN6eWJrYSkiIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Zvcm0+YDsKICAgICAgb3Blbk1vZGFsKHsgdGl0bGU6YFNwcnplZGFqIHTEmSB0cmFuc2FrY2rEmSDigJQgJHtfX2VzYyh0aWNrZXIpfWAsIGlubmVySFRNTDogZm9ybUhUTUwsIG9rVGV4dDonWmFrc2nEmWd1aicgfSkudGhlbihkYXRhPT57CiAgICAgICAgaWYoIWRhdGEpIHJldHVybjsKICAgICAgICBjb25zdCBxdHkgPSBOdW1iZXIoZGF0YS5xdHl8fDApOwogICAgICAgIGNvbnN0IHByaWNlID0gTnVtYmVyKGRhdGEuc2VsbFByaWNlfHwwKTsKICAgICAgICBjb25zdCBmZWVzID0gTnVtYmVyKGRhdGEuZmVlc3x8MCk7CiAgICAgICAgY29uc3QgZGF0ZSA9IGRhdGEuZGF0ZSB8fCB0b2RheSgpOwogICAgICAgIGNvbnN0IG5vdGUgPSBkYXRhLm5vdGUgfHwgJyc7CiAgICAgICAgaWYocXR5PD0wIHx8IHByaWNlPD0wKXsgYWxlcnQoJ1BvZGFqIGlsb8WbxIcgaSBjZW7EmS4nKTsgcmV0dXJuOyB9CiAgICAgICAgc2VsbChjdXJyZW50UGZJZCwgeyB0aWNrZXIsIGRhdGUsIHNlbGxQcmljZTogcHJpY2UsIGZlZXMsIGFsbG9jYXRpb25zOiBbeyBsb3RJZCwgcXR5IH1dLCBub3RlIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ3R4LWRlbCcpKXsKICAgICAgY29uc3Qgb2sgPSBjb25maXJtKCJVc3VuxIXEhyB0xJkgdHJhbnNha2NqxJk/IE9wZXJhY2phIG5pZW9kd3JhY2FsbmEuIik7CiAgICAgIGlmKCFvaykgcmV0dXJuOwogICAgICBwZi50cmFuc2FjdGlvbnMuc3BsaWNlKHR4SW5kZXgsMSk7CiAgICAgIHJlYnVpbGRQb3J0Zm9saW8ocGYpOyBzYXZlKCk7IHJlbmRlcigpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYoYnRuLmNsYXNzTGlzdC5jb250YWlucygndHgtZWRpdCcpKXsKICAgICAgY29uc3QgdCA9IHBmLnRyYW5zYWN0aW9uc1t0eEluZGV4XTsKICAgICAgLy8gQnVpbGQgZm9ybSBwZXIgdHlwZQogICAgICBsZXQgZm9ybUhUTUwgPSAiIjsKICAgICAgaWYodC50eXBlPT09ImRlcG9zaXQiIHx8IHQudHlwZT09PSJ3aXRoZHJhdyIgfHwgdC50eXBlPT09InRyYW5zZmVyX2luIiB8fCB0LnR5cGU9PT0idHJhbnNmZXJfb3V0Iil7CiAgICAgICAgZm9ybUhUTUwgPSBgPGZvcm0+CiAgICAgICAgICA8bGFiZWw+S3dvdGEgKCR7cGYuY3VycmVuY3l9KTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYW1vdW50IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIke3QuYW1vdW50fHwwfSIgLz4KICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0LmRhdGV8fHRvZGF5KCl9IiAvPgogICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHZhbHVlPSIke19fZXNjKHQubm90ZXx8JycpfSIgLz4KICAgICAgICA8L2Zvcm0+YDsKICAgICAgfWVsc2UgaWYodC50eXBlPT09ImJ1eSIpewogICAgICAgIGZvcm1IVE1MID0gYDxmb3JtPgogICAgICAgICAgPGxhYmVsPlRpY2tlcjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGlja2VyIiB2YWx1ZT0iJHtfX2VzYyh0LnRpY2tlcnx8JycpfSIgLz4KICAgICAgICAgIDxsYWJlbD5JbG/Fm8SHPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJxdHkiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LnF0eXx8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+Q2VuYSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgdmFsdWU9IiR7dC5wcmljZXx8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiB2YWx1ZT0iJHt0LmZlZXN8fDB9IiAvPgogICAgICAgICAgPGxhYmVsPkRhdGE8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3QuZGF0ZXx8dG9kYXkoKX0iIC8+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgdmFsdWU9IiR7X19lc2ModC5ub3RlfHwnJyl9IiAvPgogICAgICAgIAogICAgICAgIDxsYWJlbD5DZWwgenlza3UgJSAob3Bjam9uYWxuaWUpPC9sYWJlbD4KICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIke3QudGFyZ2V0UGN0ID8/ICcnfSIgcGxhY2Vob2xkZXI9Im5wLiA1ID0gKzUlIiAvPgogICAgICAgIDxsYWJlbD5DZWwgY2VuYSAvIHN6dC4gKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgPGlucHV0IG5hbWU9InRhcmdldFByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgdmFsdWU9IiR7dC50YXJnZXRQcmljZSA/PyAnJ30iIHBsYWNlaG9sZGVyPSJucC4gMTIwLjAwIiAvPgogICAgICAgIDxsYWJlbD5DZWwgS1VQTkEgJSAoc3BhZGVrLCBvcGNqLik8L2xhYmVsPgogICAgICAgIDxpbnB1dCBuYW1lPSJidXlUYXJnZXRQY3QiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgdmFsdWU9IiR7dC5idXlUYXJnZXRQY3QgPz8gJyd9IiBwbGFjZWhvbGRlcj0ibnAuIDUgPSAtNSUgb2Qga29zenR1IiAvPgogICAgICAgIDxsYWJlbD5DZWwgS1VQTkEgY2VuYSAvIHN6dC4gKG9wY2ouKTwvbGFiZWw+CiAgICAgICAgPGlucHV0IG5hbWU9ImJ1eVRhcmdldFByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgdmFsdWU9IiR7dC5idXlUYXJnZXRQcmljZSA/PyAnJ30iIHBsYWNlaG9sZGVyPSJucC4gOTUuMDAiIC8+CiAgICAgICAgCiAgICAgICAgPC9mb3JtPmA7CiAgICAgIH1lbHNlIGlmKHQudHlwZT09PSJzZWxsIil7CiAgICAgICAgLy8gRm9yIG5vdzogZWRpdCBwcmljZS9mZWVzL2RhdGUvbm90ZTsgYWxsb2NhdGlvbnMgcG96b3N0YWrEhSBiZXogem1pYW4KICAgICAgICBmb3JtSFRNTCA9IGA8Zm9ybT4KICAgICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5FZHljamEgc3ByemVkYcW8eSBkb3R5Y3p5IGNlbnkvb3DFgmF0L2RhdHkvdXdhZy4gKEFsb2thY2plIHBhcnRpaSBiZXogem1pYW4gdyB0ZWogd2Vyc2ppKTwvZGl2PgogICAgICAgICAgPGxhYmVsPlRpY2tlcjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGlja2VyIiB2YWx1ZT0iJHtfX2VzYyh0LnRpY2tlcnx8JycpfSIgLz4KICAgICAgICAgIDxsYWJlbD7FgcSFY3puYSBpbG/Fm8SHIChpbmZvcm1hY3lqbmllKTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHZhbHVlPSIke3QucXR5fHwwfSIgZGlzYWJsZWQgLz4KICAgICAgICAgIDxsYWJlbD5DZW5hIHNwcnplZGHFvHkgLyBzenQuPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJwcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHZhbHVlPSIke3QucHJpY2V8fDB9IiAvPgogICAgICAgICAgPGxhYmVsPk9wxYJhdHk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImZlZXMiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgdmFsdWU9IiR7dC5mZWVzfHwwfSIgLz4KICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0LmRhdGV8fHRvZGF5KCl9IiAvPgogICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHZhbHVlPSIke19fZXNjKHQubm90ZXx8JycpfSIgLz4KICAgICAgICA8L2Zvcm0+YDsKICAgICAgfQoKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7IHRpdGxlOiJFZHl0dWogdHJhbnNha2NqxJkiLCBpbm5lckhUTUw6IGZvcm1IVE1MLCBva1RleHQ6IlphcGlzeiIgfSk7CiAgICAgIGlmKCFkYXRhKSByZXR1cm47CgogICAgICAvLyBBcHBseSBlZGl0cwogICAgICBpZih0LnR5cGU9PT0iZGVwb3NpdCIgfHwgdC50eXBlPT09IndpdGhkcmF3IiB8fCB0LnR5cGU9PT0idHJhbnNmZXJfaW4iIHx8IHQudHlwZT09PSJ0cmFuc2Zlcl9vdXQiKXsKICAgICAgICB0LmFtb3VudCA9IE51bWJlcihkYXRhLmFtb3VudCl8fDA7CiAgICAgICAgdC5kYXRlID0gZGF0YS5kYXRlIHx8IHQuZGF0ZTsKICAgICAgICB0Lm5vdGUgPSBkYXRhLm5vdGUgfHwgIiI7CiAgICAgIH1lbHNlIGlmKHQudHlwZT09PSJidXkiKXsKICAgICAgICB0LnRpY2tlciA9IChkYXRhLnRpY2tlcnx8dC50aWNrZXJ8fCIiKS50b1VwcGVyQ2FzZSgpLnRyaW0oKTsKICAgICAgICB0LnF0eSA9IE51bWJlcihkYXRhLnF0eSl8fHQucXR5OwogICAgICAgIHQucHJpY2UgPSBOdW1iZXIoZGF0YS5wcmljZSl8fHQucHJpY2U7CiAgICAgICAgdC5mZWVzID0gTnVtYmVyKGRhdGEuZmVlcyl8fHQuZmVlczsKICAgICAgICB0LmRhdGUgPSBkYXRhLmRhdGUgfHwgdC5kYXRlOwogICAgICAgIHQubm90ZSA9IGRhdGEubm90ZSB8fCAiIjsKICAgICAgICBlbnN1cmVCdXlMb3RJZEluVHgodCk7CiAgICAgIH1lbHNlIGlmKHQudHlwZT09PSJzZWxsIil7CiAgICAgICAgdC50aWNrZXIgPSAoZGF0YS50aWNrZXJ8fHQudGlja2VyfHwiIikudG9VcHBlckNhc2UoKS50cmltKCk7CiAgICAgICAgdC5wcmljZSA9IE51bWJlcihkYXRhLnByaWNlKXx8dC5wcmljZTsKICAgICAgICB0LmZlZXMgPSBOdW1iZXIoZGF0YS5mZWVzKXx8dC5mZWVzOwogICAgICAgIHQuZGF0ZSA9IGRhdGEuZGF0ZSB8fCB0LmRhdGU7CiAgICAgICAgdC5ub3RlID0gZGF0YS5ub3RlIHx8ICIiOwogICAgICAgIC8vIGdyb3NzL25ldCB3aWxsIGJlIHJlY29tcHV0ZWQgZHVyaW5nIHJlYnVpbGQKICAgICAgfQogICAgICAvLyBSZWJ1aWxkIHRvIGtlZXAgZXZlcnl0aGluZyBjb25zaXN0ZW50CiAgICAgIHRyeXsKICAgICAgICByZWJ1aWxkUG9ydGZvbGlvKHBmKTsKICAgICAgfWNhdGNoKGVycil7CiAgICAgICAgYWxlcnQoIkVkeWNqYSBwb3dvZHVqZSBuaWVzcMOzam5vxZvEhyAobnAuIHNwcnplZGHFvCA+IHBvc2lhZGFuZSkuIFN6Y3plZ8OzxYJ5OiAiK2Vyci5tZXNzYWdlKTsKICAgICAgICByZXR1cm47IC8vIGRvIG5vdCBzYXZlL3JlbmRlciBvbiBmYWlsdXJlCiAgICAgIH0KICAgICAgc2F2ZSgpOyByZW5kZXIoKTsKICAgIH0KICB9KTsKCiAgCiAgLy8gUXVpY2sgYWN0aW9ucyBpbiBob2xkaW5nczogZWRpdCBsb3QgKGJ1eSB0eCkgb3Igc2VsbCB0aGlzIGxvdAogIGhvbGRpbmdzVGFibGVXcmFwLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpPT57CiAgICBjb25zdCBidG4gPSBlLnRhcmdldC5jbG9zZXN0KCdidXR0b24nKTsgaWYoIWJ0bikgcmV0dXJuOwogICAgCgogICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2RlbC1jb21wYW55JykpewogICAgICBjb25zdCB0aWNrZXIgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLXRpY2tlcicpOwogICAgICBpZighdGlja2VyKSByZXR1cm47CiAgICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybjsKICAgICAgY29uc3Qgb2sgPSBjb25maXJtKGBOYSBwZXdubyB1c3VuxIXEhyBzcMOzxYJrxJkgJHt0aWNrZXJ9IHogcG9ydGZlbGEgKHNrYXN1amUgV1NaWVNUS0lFIHRyYW5zYWtjamUgdGVqIHNww7PFgmtpKT9gKTsKICAgICAgaWYoIW9rKSByZXR1cm47CiAgICAgIHRyeXsKICAgICAgICBwZi50cmFuc2FjdGlvbnMgPSAocGYudHJhbnNhY3Rpb25zfHxbXSkuZmlsdGVyKHR4ID0+ICh0eC50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpICE9PSB0aWNrZXIpOwogICAgICAgIHRyeXsgZGVsZXRlIHBmLmhvbGRpbmdzW3RpY2tlcl07IH1jYXRjaChfKXt9CiAgICAgICAgcmVidWlsZFBvcnRmb2xpbyhwZik7CiAgICAgICAgc2F2ZSgpOyByZW5kZXIoKTsKICAgICAgICB0cnl7IHNob3dUb2FzdCAmJiBzaG93VG9hc3Qoe3RpdGxlOidVc3VuacSZdG8gc3DDs8WCa8SZJywgbWVzc2FnZTp0aWNrZXJ9KTsgfWNhdGNoKF8pe30KICAgICAgfWNhdGNoKGVycil7CiAgICAgICAgYWxlcnQoJ05pZSB1ZGHFgm8gc2nEmSB1c3VuxIXEhyBzcMOzxYJraTogJyArIChlcnIgJiYgZXJyLm1lc3NhZ2UgfHwgZXJyKSk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2luZm8tY29tcGFueScpKXsKICAgICAgY29uc3QgdGlja2VyID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsKICAgICAgaWYoIXRpY2tlcikgcmV0dXJuOwogICAgICBvcGVuQ29tcGFueUluZm9Nb2RhbCh0aWNrZXIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZihidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCd0cmFuc2Zlci1jb21wYW55JykpewogIGNvbnN0IHRpY2tlciA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyk7CiAgYXdhaXQgdHJhbnNmZXJDb21wYW55RGlhbG9nKGN1cnJlbnRQZklkLCB0aWNrZXIpOwogIHJldHVybjsKfQpjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBpZihidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsb3QtZWRpdCcpKXsKICAgICAgY29uc3QgdGlja2VyID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsKICAgICAgY29uc3QgbG90SWQgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLWxvdCcpOwogICAgICBjb25zdCB0eEluZGV4ID0gcGYudHJhbnNhY3Rpb25zLmZpbmRJbmRleCh4PT4geC50eXBlPT09J2J1eScgJiYgeC5sb3RJZD09PWxvdElkKTsKICAgICAgaWYodHhJbmRleDwwKSB7IGFsZXJ0KCdOaWUgem5hbGV6aW9ubyB0cmFuc2FrY2ppIHpha3VwdSBkbGEgdGVqIHBhcnRpaS4nKTsgcmV0dXJuOyB9CiAgICAgIGNvbnN0IHQgPSBwZi50cmFuc2FjdGlvbnNbdHhJbmRleF07CiAgICAgIGNvbnN0IGZvcm1IVE1MID0gYDxmb3JtPgogICAgICAgICAgPGxhYmVsPlRpY2tlcjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGlja2VyIiB2YWx1ZT0iJHtfX2VzYyh0LnRpY2tlcnx8JycpfSIgLz4KICAgICAgICAgIDxsYWJlbD5JbG/Fm8SHPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJxdHkiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LnF0eXx8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+Q2VuYSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgdmFsdWU9IiR7dC5wcmljZXx8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiB2YWx1ZT0iJHt0LmZlZXN8fDB9IiAvPgogICAgICAgICAgPGxhYmVsPkRhdGE8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3QuZGF0ZXx8dG9kYXkoKX0iIC8+CiAgICAgICAgICA8bGFiZWw+Q2VsIHp5c2t1ICU8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiB2YWx1ZT0iJHt0LnRhcmdldFBjdD8/Jyd9IiAvPgogICAgICAgICAgPGxhYmVsPkNlbCBjZW5hIC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LnRhcmdldFByaWNlPz8nJ30iIC8+CiAgICAgICAgICA8bGFiZWw+Q2VsIEtVUE5BICU8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImJ1eVRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiB2YWx1ZT0iJHt0LmJ1eVRhcmdldFBjdD8/Jyd9IiAvPgogICAgICAgICAgPGxhYmVsPkNlbCBLVVBOQSBjZW5hIC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LmJ1eVRhcmdldFByaWNlPz8nJ30iIC8+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgdmFsdWU9IiR7X19lc2ModC5ub3RlfHwnJyl9IiAvPgogICAgICAgIDwvZm9ybT5gOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsgdGl0bGU6IkVkeXR1aiB6YWt1cCAocGFydGlhKSIsIGlubmVySFRNTDogZm9ybUhUTUwsIG9rVGV4dDoiWmFwaXN6IiAgfSk7CmlmKCFkYXRhKSByZXR1cm47CiAgICAgIHQudGlja2VyID0gKGRhdGEudGlja2VyfHx0LnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCkudHJpbSgpOwogICAgICB0LnF0eSA9IE51bWJlcihkYXRhLnF0eSl8fHQucXR5OwogICAgICB0LnByaWNlID0gTnVtYmVyKGRhdGEucHJpY2UpfHx0LnByaWNlOwogICAgICB0LmZlZXMgPSBOdW1iZXIoZGF0YS5mZWVzKXx8dC5mZWVzOwogICAgICB0LmRhdGUgPSBkYXRhLmRhdGUgfHwgdC5kYXRlOwogICAgICB0Lm5vdGUgPSBkYXRhLm5vdGUgfHwgIiI7CiAgICAgIHQudGFyZ2V0UGN0ID0gKGRhdGEudGFyZ2V0UGN0IT09JycgJiYgZGF0YS50YXJnZXRQY3QhPT11bmRlZmluZWQpID8gTnVtYmVyKGRhdGEudGFyZ2V0UGN0KSA6IG51bGw7CiAgICAgIHQudGFyZ2V0UHJpY2UgPSAoZGF0YS50YXJnZXRQcmljZSE9PScnICYmIGRhdGEudGFyZ2V0UHJpY2UhPT11bmRlZmluZWQpID8gTnVtYmVyKGRhdGEudGFyZ2V0UHJpY2UpIDogbnVsbDsKICAgICAgICB0LmJ1eVRhcmdldFBjdCA9IChkYXRhLmJ1eVRhcmdldFBjdCE9PScnICYmIGRhdGEuYnV5VGFyZ2V0UGN0IT09dW5kZWZpbmVkKSA/IE51bWJlcihTdHJpbmcoZGF0YS5idXlUYXJnZXRQY3QpLnJlcGxhY2UoJywnLCAnLicpKSA6IG51bGw7CiAgICAgICAgdC5idXlUYXJnZXRQcmljZSA9IChkYXRhLmJ1eVRhcmdldFByaWNlIT09JycgJiYgZGF0YS5idXlUYXJnZXRQcmljZSE9PXVuZGVmaW5lZCkgPyBOdW1iZXIoU3RyaW5nKGRhdGEuYnV5VGFyZ2V0UHJpY2UpLnJlcGxhY2UoJywnLCAnLicpKSA6IG51bGw7CiAgICAgIHRyeXsKICAgICAgICByZWJ1aWxkUG9ydGZvbGlvKHBmKTsKICAgICAgfWNhdGNoKGVycil7CiAgICAgICAgYWxlcnQoIkVkeWNqYSBwb3dvZHVqZSBuaWVzcMOzam5vxZvEhyAobnAuIHNwcnplZGHFvCA+IHBvc2lhZGFuZSkuIFN6Y3plZ8OzxYJ5OiAiK2Vyci5tZXNzYWdlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgc2F2ZSgpOyByZW5kZXIoKTsKICAgIH0KICAgIGlmKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xvdC1zZWxsJykpewogICAgICBjb25zdCB0aWNrZXIgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLXRpY2tlcicpOwogICAgICBjb25zdCBsb3RJZCA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtbG90Jyk7CiAgICAgIGNvbnN0IG1heFF0eSA9IE51bWJlcihidG4uZ2V0QXR0cmlidXRlKCdkYXRhLW1heHF0eScpfHwwKTsKICAgICAgY29uc3QgZm9ybUhUTUwgPSBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+Q2VuYSBzcHJ6ZWRhxbx5IC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJzZWxsUHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPk9wxYJhdHk8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHZhbHVlPSIwIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3RvZGF5KCl9IiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5JbG/Fm8SHIGRvIHNwcnplZGHFvHk8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0icXR5IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiBtYXg9IiR7bWF4UXR5fSIgdmFsdWU9IiR7bWF4UXR5fSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgcGxhY2Vob2xkZXI9InNwcnplZGHFvCBwYXJ0aWkgIyAoc3p5YmthKSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZm9ybT5gOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsgdGl0bGU6YFNwcnplZGFqIHBhcnRpxJkg4oCUICR7X19lc2ModGlja2VyKX1gLCBpbm5lckhUTUw6IGZvcm1IVE1MLCBva1RleHQ6Ilpha3NpxJlndWoiIH0pOwogICAgICBpZighZGF0YSkgcmV0dXJuOwogICAgICBjb25zdCBxdHkgPSBOdW1iZXIoZGF0YS5xdHl8fDApOwogICAgICBjb25zdCBwcmljZSA9IE51bWJlcihkYXRhLnNlbGxQcmljZXx8MCk7CiAgICAgIGNvbnN0IGZlZXMgPSBOdW1iZXIoZGF0YS5mZWVzfHwwKTsKICAgICAgY29uc3QgZGF0ZSA9IGRhdGEuZGF0ZSB8fCB0b2RheSgpOwogICAgICBjb25zdCBub3RlID0gZGF0YS5ub3RlIHx8ICIiOwogICAgICBpZihxdHk8PTAgfHwgcHJpY2U8PTApeyBhbGVydCgiUG9kYWogaWxvxZvEhyBpIGNlbsSZLiIpOyByZXR1cm47IH0KICAgICAgc2VsbChjdXJyZW50UGZJZCwgeyB0aWNrZXIsIGRhdGUsIHNlbGxQcmljZTogcHJpY2UsIGZlZXMsIGFsbG9jYXRpb25zOiBbeyBsb3RJZCwgcXR5IH1dLCBub3RlIH0pOwogICAgfQogICAgaWYoYnRuLmNsYXNzTGlzdC5jb250YWlucygnYWRkLWxvdCcpKXsKICAgICAgY29uc3QgdGlja2VyID0gKGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyl8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuOwogICAgICBjb25zdCBsYXN0UHJpY2UgPSBnZXRRdW90ZSh0aWNrZXIpOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgICB0aXRsZTogYFpha3VwIChub3dhIHBhcnRpYSkg4oCUICR7dGlja2VyfWAsCiAgICAgICAgaW5uZXJIVE1MOiBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+VGlja2VyPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9InRpY2tlciIgdmFsdWU9IiR7dGlja2VyfSIgcmVhZG9ubHkgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+SWxvxZvEhzwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJxdHkiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPkNlbmEgLyBzenQuPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9InByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiB2YWx1ZT0iJHtsYXN0UHJpY2UhPW51bGw/bGFzdFByaWNlOicnfSIgcmVxdWlyZWQgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJmZWVzIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIG1pbj0iMCIgdmFsdWU9IjAiIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPkRhdGE8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0iZGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dG9kYXkoKX0iIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPkNlbCB6eXNrdSAlIChvcGNqb25hbG5pZSk8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHBsYWNlaG9sZGVyPSJucC4gNSA9ICs1JSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+Q2VsIGNlbmEgLyBzenQuIChvcGNqb25hbG5pZSk8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBwbGFjZWhvbGRlcj0ibnAuIDEyMC4wMCIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+Q2VsIEtVUE5BICUgKHNwYWRlaywgb3Bjai4pPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9ImJ1eVRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBwbGFjZWhvbGRlcj0ibnAuIC01ID0ga3VwIHByenkgLTUlIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5DZWwgS1VQTkEsIGNlbmEvc3p0LiAob3Bjai4pPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9ImJ1eVRhcmdldFByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgcGxhY2Vob2xkZXI9Im5wLiA5MC4wMCIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgICA8dGV4dGFyZWEgbmFtZT0ibm90ZSIgcm93cz0iMiIgcGxhY2Vob2xkZXI9Im5wLiBkb2t1cCBwb2Qgb2RiaWNpZSI+PC90ZXh0YXJlYT4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZm9ybT5gCiAgICAgIH0pOwogICAgICBpZighZGF0YSkgcmV0dXJuOwogICAgICBidXkoY3VycmVudFBmSWQsIHsKICAgICAgICB0aWNrZXI6IGRhdGEudGlja2VyLCBkYXRlOiBkYXRhLmRhdGUsIHF0eTogZGF0YS5xdHksIHByaWNlOiBkYXRhLnByaWNlLCBmZWVzOiBkYXRhLmZlZXMsIG5vdGU6IGRhdGEubm90ZSwKICAgICAgICB0YXJnZXRQY3Q6IGRhdGEudGFyZ2V0UGN0LCB0YXJnZXRQcmljZTogZGF0YS50YXJnZXRQcmljZSwKICAgICAgICBidXlUYXJnZXRQY3Q6IGRhdGEuYnV5VGFyZ2V0UGN0LCBidXlUYXJnZXRQcmljZTogZGF0YS5idXlUYXJnZXRQcmljZQogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKIGVsc2UgaWYoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbG90LW11dGUnKSl7CiAgICAgIGNvbnN0IGxvdElkID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS1sb3QnKTsKICAgICAgLy8gZmluZCB0aGUgbG90IGluIGN1cnJlbnQgcG9ydGZvbGlvCiAgICAgIGxldCB0YXJnZXQgPSBudWxsLCB0YXJnZXRUaWNrZXI9bnVsbDsKICAgICAgZm9yKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICAgICAgY29uc3QgZm91bmQgPSAoYm9vay5sb3RzfHxbXSkuZmluZCh4PT4geC5sb3RJZCA9PT0gbG90SWQpOwogICAgICAgIGlmKGZvdW5kKXsgdGFyZ2V0ID0gZm91bmQ7IHRhcmdldFRpY2tlcj10azsgYnJlYWs7IH0KICAgICAgfQogICAgICBpZighdGFyZ2V0KSByZXR1cm47CiAgICAgIHRhcmdldC5tdXRlZCA9ICF0YXJnZXQubXV0ZWQ7CiAgICAgIHNhdmUoKTsgcmVuZGVyKCk7CiAgICAgIHJldHVybjsKICAgIH0KfSk7CgoKICAvLyBUYWIgYnV0dG9uCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpc2hsaXN0VGFiQnRuJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICAgIGNvbnN0IGlzV2lzaGxpc3RWaXNpYmxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpc2hsaXN0UGFuZWwnKT8uc3R5bGUuZGlzcGxheSAhPT0gJ25vbmUnOwogICAgc2V0QWN0aXZlVmlldyhpc1dpc2hsaXN0VmlzaWJsZSA/ICdwb3J0Zm9saW8nIDogJ3dpc2hsaXN0Jyk7CiAgfSk7CgogIC8vIFdpc2hsaXN0IGZvcm0gYWN0aW9ucwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFNlYXJjaCcpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCBxID0gKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFRpY2tlcicpPy52YWx1ZXx8JycpLnRyaW0oKTsKICAgIGF3YWl0IHdsU2VhcmNoU3ltYm9scyhxKTsKICB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2xBZGQnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgY29uc3QgdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFRpY2tlcicpPy52YWx1ZXx8Jyc7CiAgICBjb25zdCBwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsUHJpY2UnKT8udmFsdWV8fCcnOwogICAgYWRkV2F0Y2hJdGVtKHQsIHApOwogICAgY29uc3QgdEVsPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFRpY2tlcicpOyBpZih0RWwpIHRFbC52YWx1ZT0nJzsKICAgIGNvbnN0IHBFbD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2xQcmljZScpOyBpZihwRWwpIHBFbC52YWx1ZT0nJzsKICAgIHRyeXsgY29uc3QgdD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2xUaWNrZXInKT8udmFsdWV8fCcnOyBpZih0KXsgY29uc3QgcHJvZmlsZSA9IGF3YWl0IGZldGNoQ29tcGFueVByb2ZpbGUodCk7IGlmKHByb2ZpbGUgJiYgcHJvZmlsZS5uYW1lKSBzZXRDb21wYW55TmFtZSh0LCBwcm9maWxlLm5hbWUpOyB9IH1jYXRjaChfKXt9CiAgICByZW5kZXJXaXNobGlzdCgpOwogIH0pOwoKCiAgLy8gRmlsdGVycwogIGZpbHRlclF1ZXJ5RWwuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKT0+IHJlbmRlck1haW4oKSk7CgogIC8vIFN0cmF0ZWd5IGF1dG9zYXZlCiAgc3RyYXRlZ3lCb3guYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKT0+ewogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuOwogICAgcGYuc3RyYXRlZ3kgPSBzdHJhdGVneUJveC52YWx1ZTsKICAgIHBmLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgIHNhdmUoKTsKICB9KTsKCiAgZnVuY3Rpb24gcmVuZGVyKCl7CiAgICByZW5kZXJQb3J0Zm9saW9MaXN0KCk7CiAgICByZW5kZXJNYWluKCk7CiAgICB0cnl7IGVuc3VyZVJlc3BvbnNpdmVUYWJsZXMoKTsgfWNhdGNoKF8peyB9CiAgdHJ5IHsgdXBkYXRlU2lkZWJhckJsaW5rU3RhdGVzKCk7IH0gY2F0Y2goZSkge30KICB0cnkgeyB1cGRhdGVXaXNobGlzdEJsaW5rU3RhdGUoKTsgfSBjYXRjaChlKSB7fQogICAgCiAgLy8gRmlsdGVyIGNsZWFyCiAgY29uc3QgZmlsdGVyQ2xlYXJCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyQ2xlYXJCdG4nKTsKICBpZihmaWx0ZXJDbGVhckJ0biAmJiAhZmlsdGVyQ2xlYXJCdG4uZGF0YXNldC5ib3VuZCl7CiAgICBmaWx0ZXJDbGVhckJ0bi5kYXRhc2V0LmJvdW5kPScxJzsKICAgIGZpbHRlckNsZWFyQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgZmlsdGVyUXVlcnlFbC52YWx1ZT0nJzsgcmVuZGVyTWFpbigpOyB9KTsKICB9CnN0YXJ0UG9sbGluZ1F1b3RlcygpOwogIH0KCiAgLy8gSW5pdGlhbCByZW5kZXIKICByZW5kZXIoKTsKICB0cnkgeyByZW5kZXJXaXNobGlzdCgpOyB1cGRhdGVXaXNobGlzdEJsaW5rU3RhdGUoKTsgfSBjYXRjaChlKSB7fQogIC8vIFVwdWJsaWN6bmllbmllIHdpxIV6YcWEIGRsYSBGaXJlYmFzZQogIHRyeXsKICAgIHdpbmRvdy5zYXZlID0gc2F2ZTsKICAgIHdpbmRvdy5yZW5kZXIgPSByZW5kZXI7CiAgICB3aW5kb3cuX19zZXRBcHBEQiA9IChvYmopPT57IAogICAgICBEQiA9IG9iajsgCiAgICAgIHRyeXsKICAgICAgICAvLyBNaWdyYXRlIHdpc2hsaXN0IGl0ZW1zIHRvIG11bHRpLXRhcmdldCBzY2hlbWEgYWZ0ZXIgbG9hZGluZyBmcm9tIHNlcnZlcgogICAgICAgIERCLndhdGNobGlzdCA9IERCLndhdGNobGlzdCB8fCBbXTsKICAgICAgICBmb3IoY29uc3QgdyBvZiBEQi53YXRjaGxpc3QpewogICAgICAgICAgaWYoIUFycmF5LmlzQXJyYXkody50YXJnZXRzKSl7CiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBOdW1iZXIody5wcmljZSl8fDA7CiAgICAgICAgICAgIHcudGFyZ2V0cyA9IGJhc2U+MCA/IFtiYXNlXSA6IFtdOwogICAgICAgICAgICB0cnl7IGRlbGV0ZSB3LnByaWNlOyB9Y2F0Y2goXyl7fQogICAgICAgICAgfQogICAgICAgICAgaWYodHlwZW9mIHcuYWN0aXZlSW5kZXghPT0nbnVtYmVyJykgdy5hY3RpdmVJbmRleCA9IDA7CiAgICAgICAgICBpZih0eXBlb2Ygdy5uYW1lIT09J3N0cmluZycpIHcubmFtZSA9IHcubmFtZXx8Jyc7CiAgICAgICAgfQogICAgICB9Y2F0Y2goXyl7fQogICAgICBzYXZlKCk7IAogICAgICB0cnkgeyByZW5kZXIoKTsgfSBjYXRjaChfKXt9CiAgICAgIHRyeSB7IHJlbmRlcldpc2hsaXN0KCk7IHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpOyB9IGNhdGNoKF8pe30KICAgIH07CiAgfWNhdGNoKGUpeyBjb25zb2xlLndhcm4oJ0V4cG9zZSBiaW5kaW5ncyBmYWlsZWQnLCBlKTsgfQp9KSgpOwo8L3NjcmlwdD4KPHNjcmlwdD4KLy8gPT09IENvbGxhcHNpYmxlIEhpc3RvcnkgKHBlcnNpc3Qgc3RhdGUpID09PQooZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBzZXR1cEhpc3RvcnlDb2xsYXBzZSgpewogICAgY29uc3QgcGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlzdG9yeVBhbmVsJyk7CiAgICBpZighcGFuZWwpIHJldHVybjsKICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaXN0b3J5Q29sbGFwc2VCdG4nKTsKICAgIGNvbnN0IHRpdGxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpc3RvcnlUaXRsZScpOwogICAgY29uc3QgS0VZID0gJ2hpc3RvcnlDb2xsYXBzZWQnOwogICAgdHJ5ewogICAgICBjb25zdCBpbml0aWFsID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKSA9PT0gJzEnOwogICAgICBpZihpbml0aWFsKSBwYW5lbC5jbGFzc0xpc3QuYWRkKCdjb2xsYXBzZWQnKTsKICAgIH1jYXRjaChlKXt9CiAgICBmdW5jdGlvbiB0b2dnbGUoKXsKICAgICAgcGFuZWwuY2xhc3NMaXN0LnRvZ2dsZSgnY29sbGFwc2VkJyk7CiAgICAgIHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oS0VZLCBwYW5lbC5jbGFzc0xpc3QuY29udGFpbnMoJ2NvbGxhcHNlZCcpID8gJzEnOicwJyk7IH1jYXRjaChlKXt9CiAgICB9CiAgICBpZihidG4gJiYgIWJ0bi5kYXRhc2V0LmJvdW5kKXsgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdG9nZ2xlKTsgYnRuLmRhdGFzZXQuYm91bmQ9JzEnOyB9CiAgICBpZih0aXRsZSAmJiAhdGl0bGUuZGF0YXNldC5ib3VuZCl7IHRpdGxlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdG9nZ2xlKTsgdGl0bGUuZGF0YXNldC5ib3VuZD0nMSc7IH0KICB9CiAgLy8gcnVuIG5vdyAoc2NyaXB0cyBsb2FkZWQgYXQgZW5kIG9mIGJvZHkpLCBhbmQgYWxzbyBhZnRlciBhbnkgZ2xvYmFsIHJlLXJlbmRlciBpZiBuZWVkZWQKICB0cnkgeyBzZXR1cEhpc3RvcnlDb2xsYXBzZSgpOyB9IGNhdGNoKGUpIHt9CiAgLy8gcmUtYXBwbHkgb24gcmVuZGVyTWFpbgogIGlmKHR5cGVvZiByZW5kZXJNYWluID09PSAnZnVuY3Rpb24nKXsKICAgIGNvbnN0IG9yaWcgPSByZW5kZXJNYWluOwogICAgd2luZG93LnJlbmRlck1haW4gPSBmdW5jdGlvbigpewogICAgICBjb25zdCByZXN1bHQgPSBvcmlnLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRyeSB7IHNldHVwSGlzdG9yeUNvbGxhcHNlKCk7IH0gY2F0Y2goZSkge30KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9Cn0pKCk7Cjwvc2NyaXB0PgoKICA8c2NyaXB0PgogIC8vIFN0YXR1cyBVSSBiZXR3ZWVuIHRpdGxlIGFuZCBhY3Rpb25zCiAgKGZ1bmN0aW9uKCl7CiAgICBmdW5jdGlvbiBmaW5kSGVhZGVyKCl7IHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkZXInKTsgfQogICAgZnVuY3Rpb24gZmluZEFjdGlvbnMoKXsgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWRlciAuYWN0aW9ucycpOyB9CiAgICBmdW5jdGlvbiBlbnN1cmVTdGF0dXNCZXR3ZWVuKCl7CiAgICAgIGNvbnN0IGggPSBmaW5kSGVhZGVyKCk7IGNvbnN0IGEgPSBmaW5kQWN0aW9ucygpOyBpZighaCkgcmV0dXJuIG51bGw7CiAgICAgIGxldCB3cmFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N5bmNTdGF0dXNXcmFwJyk7CiAgICAgIGlmKCF3cmFwKXsKICAgICAgICB3cmFwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgd3JhcC5pZD0nc3luY1N0YXR1c1dyYXAnOwogICAgICAgIHdyYXAuc3R5bGUuZGlzcGxheT0naW5saW5lLWZsZXgnOwogICAgICAgIHdyYXAuc3R5bGUuYWxpZ25JdGVtcz0nY2VudGVyJzsKICAgICAgICB3cmFwLnN0eWxlLmdhcD0nNnB4JzsKICAgICAgICB3cmFwLnN0eWxlLm1hcmdpbkxlZnQ9JzE2cHgnOwogICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsgZG90LmlkPSdzeW5jRG90JzsKICAgICAgICBkb3Quc3R5bGUud2lkdGg9JzEycHgnOyBkb3Quc3R5bGUuaGVpZ2h0PScxMnB4JzsgZG90LnN0eWxlLmJvcmRlclJhZGl1cz0nNTAlJzsgZG90LnN0eWxlLmRpc3BsYXk9J2lubGluZS1ibG9jayc7CiAgICAgICAgZG90LnN0eWxlLmJveFNoYWRvdz0nMCAwIDAgMXB4IHJnYmEoMCwwLDAsMC4yNSkgaW5zZXQnOyBkb3Quc3R5bGUuYmFja2dyb3VuZD0nIzljYTNhZic7CiAgICAgICAgY29uc3QgdHh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyB0eHQuaWQ9J3N5bmNUZXh0JzsgdHh0LnN0eWxlLmZvbnRTaXplPScxMnB4JzsgdHh0LnN0eWxlLm9wYWNpdHk9JzAuOSc7IHR4dC50ZXh0Q29udGVudD0nRmlyZWJhc2U6IC4uLic7CiAgICAgICAgd3JhcC5hcHBlbmRDaGlsZChkb3QpOyB3cmFwLmFwcGVuZENoaWxkKHR4dCk7CiAgICAgICAgaWYoYSl7IGguaW5zZXJ0QmVmb3JlKHdyYXAsIGEpOyB9IGVsc2UgeyBoLmFwcGVuZENoaWxkKHdyYXApOyB9CiAgICAgIH0KICAgICAgcmV0dXJuIHdyYXA7CiAgICB9CiAgICBmdW5jdGlvbiBjb2xvcihjKXsgY29uc3QgZD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3luY0RvdCcpOyBpZihkKSBkLnN0eWxlLmJhY2tncm91bmQ9YzsgfQogICAgZnVuY3Rpb24gbGFiZWwodCl7IGNvbnN0IGU9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N5bmNUZXh0Jyk7IGlmKGUpIGUudGV4dENvbnRlbnQ9dDsgfQogICAgZnVuY3Rpb24gcGFkKG4peyByZXR1cm4gKG48MTA/JzAnOicnKStuOyB9IGZ1bmN0aW9uIGhobW1zcyh0cyl7IGNvbnN0IGQ9bmV3IERhdGUodHMpOyByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSkrJzonK3BhZChkLmdldE1pbnV0ZXMoKSkrJzonK3BhZChkLmdldFNlY29uZHMoKSk7IH0KICAgIHdpbmRvdy5zZXRTeW5jU3RhdHVzID0gZnVuY3Rpb24oc3RhdGUpewogICAgICBlbnN1cmVTdGF0dXNCZXR3ZWVuKCk7CiAgICAgIGlmKHN0YXRlPT09J3N5bmNpbmcnKXsgY29sb3IoJyNmNTllMGInKTsgbGFiZWwoJ0ZpcmViYXNlOiBTeW5jaHJvbml6YWNqYS4uLicpOyByZXR1cm47IH0KICAgICAgaWYoc3RhdGU9PT0nb2snKXsgY29sb3IoJyMxMGI5ODEnKTsgdmFyIHQ9d2luZG93Ll9fbGFzdFN5bmNBdD8oJyAoJytoaG1tc3Mod2luZG93Ll9fbGFzdFN5bmNBdCkrJyknKTonJzsgbGFiZWwoJ0ZpcmViYXNlOiBPSycrdCk7IHJldHVybjsgfQogICAgICBpZihzdGF0ZT09PSdlcnJvcicpeyBjb2xvcignI2VmNDQ0NCcpOyBsYWJlbCgnRmlyZWJhc2U6IELFgsSFZCcpOyByZXR1cm47IH0KICAgICAgaWYoc3RhdGU9PT0nb2ZmbGluZScpeyBjb2xvcignI2VmNDQ0NCcpOyBsYWJlbCgnRmlyZWJhc2U6IE9GRkxJTkUnKTsgcmV0dXJuOyB9CiAgICAgIGlmKHN0YXRlPT09J3JlYWR5Jyl7IGNvbG9yKCcjM2I4MmY2Jyk7IGxhYmVsKCdGaXJlYmFzZTogR290b3dlJyk7IHJldHVybjsgfQogICAgICBjb2xvcignIzljYTNhZicpOyBsYWJlbCgnRmlyZWJhc2U6IC4uLicpOwogICAgfTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKT0+ewogICAgICBlbnN1cmVTdGF0dXNCZXR3ZWVuKCk7CiAgICAgIHdpbmRvdy5zZXRTeW5jU3RhdHVzKG5hdmlnYXRvci5vbkxpbmU/J3JlYWR5Jzonb2ZmbGluZScpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb25saW5lJywgKCk9PndpbmRvdy5zZXRTeW5jU3RhdHVzKCdyZWFkeScpKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29mZmxpbmUnLCAoKT0+d2luZG93LnNldFN5bmNTdGF0dXMoJ29mZmxpbmUnKSk7CiAgICB9LCB7b25jZTp0cnVlfSk7CiAgfSkoKTsKICA8L3NjcmlwdD4KCgogIDxzY3JpcHQ+CiAgLy8gLS0tIEhBUkRGSVg6IG1hbnVhbCBGaXJlYmFzZSBXecWbbGlqL1BvYmllcnogKyBpbmNvZ25pdG8gYXV0aCAtLS0KICB3aW5kb3cuc2V0U3luY1N0YXR1cyA9IHdpbmRvdy5zZXRTeW5jU3RhdHVzIHx8IGZ1bmN0aW9uKCl7fTsKICBmdW5jdGlvbiBmYkxvZyhtc2csIGNscyl7CiAgICAvLyBwb2thxbwgdHlsa28gYsWCxJlkeS9vc3RyemXFvGVuaWEg4oCUIGJyYWsgdG9hc3TDs3cgZGxhIE9LCiAgICBpZiAoY2xzIT09J2VycicgJiYgY2xzIT09J3dhcm4nKSByZXR1cm47CgogICAgdHJ5ewogICAgICBjb25zdCBib3ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmJMb2cnKTsgaWYoIWJveCkgcmV0dXJuOwogICAgICBib3guaW5uZXJIVE1MID0gJzxiPkZpcmViYXNlPC9iPjogJyArIChtc2d8fCcnKSArIChjbHM/KCc8c3BhbiBjbGFzcz0iJytjbHMrJyI+PC9zcGFuPicpOicnKTsgCiAgICAgIGJveC5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgIGNsZWFyVGltZW91dCh3aW5kb3cuX19mYkxvZ1RpbWVyKTsgd2luZG93Ll9fZmJMb2dUaW1lciA9IHNldFRpbWVvdXQoKCk9PnsgYm94LmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsgfSwgNjAwMCk7CiAgICB9Y2F0Y2goXyl7fQogIH0KCiAgY29uc3QgRkJfQ0ZHID0gewogICAgYXBpS2V5OiAiQUl6YVN5QkdGdVh4TFlRZm15by1UYXhKR0VSMnFaMHd6RXZQUHhrIiwKICAgIGF1dGhEb21haW46ICJndC1wb3J0Zm9saW9zLmZpcmViYXNlYXBwLmNvbSIsCiAgICBwcm9qZWN0SWQ6ICJndC1wb3J0Zm9saW9zIiwKICAgIGFwcElkOiAiMToyMjQyMzAxMjAwMjE6d2ViOjg3OTAxYTE2N2UxZmM2MDc5NzkyZGMiLAogICAgc3RvcmFnZUJ1Y2tldDogImd0LXBvcnRmb2xpb3MuYXBwc3BvdC5jb20iLAogICAgbWVzc2FnaW5nU2VuZGVySWQ6ICIyMjQyMzAxMjAwMjEiCiAgfTsKICBjb25zdCBGQl9DT0wgPSAiZ3RfcG9ydGZvbGlvcyI7CiAgY29uc3QgRkJfRE9DID0gImRlZmF1bHQiOwoKICBmdW5jdGlvbiBkZXRlY3RMU0tleSgpewogIGNvbnN0IEZJWEVEID0gInBvcnRmZWxlX2Zpcm15X3YxIjsgLy8gc3RhxYJ5IGtsdWN6CiAgLy8gamXFm2xpIGp1xbwgaXN0bmllamUg4oCUIHXFvHlqCiAgdHJ5eyBpZihsb2NhbFN0b3JhZ2UuZ2V0SXRlbShGSVhFRCkpIHJldHVybiBGSVhFRDsgfWNhdGNoKF8pe30KICAvLyBtaWdyYWNqYSB6IGlubnljaCBwb3RlbmNqYWxueWNoIGtsdWN6eQogIHRyeXsKICAgIGZvciAobGV0IGk9MDtpPGxvY2FsU3RvcmFnZS5sZW5ndGg7aSsrKXsKICAgICAgY29uc3QgayA9IGxvY2FsU3RvcmFnZS5rZXkoaSk7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCB2ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKSk7CiAgICAgICAgaWYgKHYgJiYgdHlwZW9mIHY9PT0nb2JqZWN0JyAmJiB2LnNldHRpbmdzICYmIEFycmF5LmlzQXJyYXkodi5wb3J0Zm9saW9zKSkgewogICAgICAgICAgY29uc29sZS5sb2coYFpuYWxlemlvbm8gZGFuZSB3IGtsdWN6dTogJHtrfSwgbWlncnVqxJkgZG8gJHtGSVhFRH1gKTsKICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEZJWEVELCBKU09OLnN0cmluZ2lmeSh2KSk7CiAgICAgICAgICByZXR1cm4gRklYRUQ7CiAgICAgICAgfQogICAgICB9Y2F0Y2goXyl7fQogICAgfQogIH1jYXRjaChfKXt9CiAgLy8gamXFm2xpIG5pYyBuaWUgem5hbGV6aW9ubyDigJQgendyw7PEhyBzdGHFgnkKICByZXR1cm4gRklYRUQ7Cn0KY29uc3QgTFNfS0VZID0gZGV0ZWN0TFNLZXkoKTsKCiAgYXN5bmMgZnVuY3Rpb24gZmJJbml0KCl7CiAgICAKICAgIC8vIEVuc3VyZSBzaW5nbGUgaW5pdGlhbGl6YXRpb24gcGVyIHBhZ2UgKHNpbmdsZXRvbikKICAgIGlmICh3aW5kb3cuX19mYkluaXRQcm9taXNlKSByZXR1cm4gd2luZG93Ll9fZmJJbml0UHJvbWlzZTsKICAgIHdpbmRvdy5fX2ZiSW5pdFByb21pc2UgPSAoYXN5bmMgKCkgPT4gewp0cnl7CiAgICAgIGlmICghd2luZG93LmZpcmViYXNlIHx8ICFmaXJlYmFzZS5hcHBzKSB0aHJvdyBuZXcgRXJyb3IoIkJyYWsgRmlyZWJhc2UgU0RLIik7CiAgICAgIGlmICghZmlyZWJhc2UuYXBwcy5sZW5ndGgpIGZpcmViYXNlLmluaXRpYWxpemVBcHAoRkJfQ0ZHKTsKICAgICAgY29uc3QgYXV0aCA9IGZpcmViYXNlLmF1dGgoKTsKICAgICAgLy8gZGlhZ25vc3R5a2Egc3RhbnUgYXV0aCAoemFiZXpwaWVjem9uZSBwcnplZCB3aWVsb2tyb3RueW0gcG9kcGnEmWNpZW0pCiAgICAgIHRyeXsKICAgICAgICBpZighd2luZG93Ll9fZmJBdXRoQm91bmQpewogICAgICAgICAgYXV0aC5vbkF1dGhTdGF0ZUNoYW5nZWQoKHVzZXIpPT57CiAgICAgICAgICAgIGlmKHVzZXIpewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGaXJlYmFzZSBhdXRoOiB6YWxvZ293YW5vIGFub25pbW93bycsIHVzZXIudWlkKTsKICAgICAgICAgICAgICBpZih0eXBlb2Ygd2luZG93LnNldFN5bmNTdGF0dXM9PT0nZnVuY3Rpb24nKSB3aW5kb3cuc2V0U3luY1N0YXR1cygncmVhZHknKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZpcmViYXNlIGF1dGg6IGJyYWsgdcW8eXRrb3duaWthJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgd2luZG93Ll9fZmJBdXRoQm91bmQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KICAgICAgdHJ5eyBhd2FpdCBhdXRoLnNldFBlcnNpc3RlbmNlKGZpcmViYXNlLmF1dGguQXV0aC5QZXJzaXN0ZW5jZS5MT0NBTCk7IH1jYXRjaChfKXt9CiAgICAgIGlmICghYXV0aC5jdXJyZW50VXNlcikgYXdhaXQgYXV0aC5zaWduSW5Bbm9ueW1vdXNseSgpOwogICAgICBjb25zdCBkYiA9IGZpcmViYXNlLmZpcmVzdG9yZSgpOwogICAgICByZXR1cm4ge2F1dGgsIGRifTsKICAgIH1jYXRjaChlKXsKICAgICAgY29uc29sZS53YXJuKCJmYkluaXQgZXJyb3I6IiwgZSk7IGFsZXJ0KCJCxYLEhWQgaW5pY2phbGl6YWNqaSBGaXJlYmFzZTogIiArIChlICYmIGUubWVzc2FnZSB8fCBlKSk7IHJldHVybiB7fTsKICAgIH0KICAKICAgIH0pKCk7CiAgICByZXR1cm4gd2luZG93Ll9fZmJJbml0UHJvbWlzZTsKfQoKICAKLy8gPT09IEF1dG9TeW5jIEhlbHBlcnMgPT09CgovLyA9PT0gQWxhcm0gTG9nZ2luZyAoRmlyZXN0b3JlKSA9PT0KY29uc3QgQUxBUk1fTE9HX1JFUEVBVF9NUyA9IDE1ICogNjAgKiAxMDAwOyAvLyByZS1sb2cgc2FtZSBzdGF0ZSBhZnRlciAxNSBtaW51dGVzCndpbmRvdy5fX2xhc3RMb2dnZWRBbGVydHMgPSB3aW5kb3cuX19sYXN0TG9nZ2VkQWxlcnRzIHx8IHt9OwoKZnVuY3Rpb24gX19zaG91bGRMb2dBbGFybShrZXksIHN0YXRlKXsKICB0cnl7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgY29uc3QgcHJldiA9IHdpbmRvdy5fX2xhc3RMb2dnZWRBbGVydHNba2V5XTsKICAgIGlmKCFwcmV2IHx8IHByZXYuc3RhdGUgIT09IHN0YXRlIHx8IChub3cgLSBwcmV2LnRpbWUpID4gQUxBUk1fTE9HX1JFUEVBVF9NUyl7CiAgICAgIHdpbmRvdy5fX2xhc3RMb2dnZWRBbGVydHNba2V5XSA9IHtzdGF0ZSwgdGltZTogbm93fTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfWNhdGNoKF8peyByZXR1cm4gdHJ1ZTsgfQp9CgovLyBUcmFjayBzdGF0ZSBjaGFuZ2VzIGZvciBiYWRnZSBjb3VudGluZyAoc2VwYXJhdGUgZnJvbSBsb2dnaW5nKQp3aW5kb3cuX19sYXN0QmFkZ2VTdGF0ZXMgPSB3aW5kb3cuX19sYXN0QmFkZ2VTdGF0ZXMgfHwge307CgpmdW5jdGlvbiBfX3Nob3VsZEluY3JlbWVudEJhZGdlKGtleSwgc3RhdGUpewogIHRyeXsKICAgIGNvbnN0IHByZXYgPSB3aW5kb3cuX19sYXN0QmFkZ2VTdGF0ZXNba2V5XTsKICAgIGNvbnN0IGNoYW5nZWQgPSAhcHJldiB8fCBwcmV2ICE9PSBzdGF0ZTsKICAgIGlmKGNoYW5nZWQpewogICAgICB3aW5kb3cuX19sYXN0QmFkZ2VTdGF0ZXNba2V5XSA9IHN0YXRlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9Y2F0Y2goXyl7IHJldHVybiBmYWxzZTsgfQp9CgoKCi8qKgogKiBTYXZlIGFsYXJtIGV2ZW50IHRvIEZpcmVzdG9yZS4KICogZGF0YToge3Njb3BlOidwb3J0Zm9saW8nfCd3aXNobGlzdCcsIHBmSWQ/LCB0aWNrZXIsIHN0YXRlOidoaXQnfCduZWFyJywga2luZDonc2VsbCd8J2J1eScsIHByaWNlLCB0YXJnZXR9CiAqLwphc3luYyBmdW5jdGlvbiBsb2dBbGFybUV2ZW50KGRhdGEpewogIHRyeXsKICAgIGNvbnN0IHBhY2sgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhfHx7fSk7CiAgICBjb25zdCB7YXV0aCwgZGIsIGZpcmViYXNlfSA9IGF3YWl0IGZiSW5pdCgpOwogICAgaWYoIWRiIHx8ICFhdXRoIHx8ICFhdXRoLmN1cnJlbnRVc2VyKXsgcmV0dXJuOyB9CiAgICBjb25zdCB1aWQgPSBhdXRoLmN1cnJlbnRVc2VyLnVpZDsKICAgIHBhY2sudWlkID0gdWlkOwogICAgLy8gTm9ybWFsaXplIHRpY2tlci9raW5kL3N0YXRlCiAgICBpZihwYWNrLnRpY2tlcikgcGFjay50aWNrZXIgPSBTdHJpbmcocGFjay50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgaWYocGFjay5raW5kKSAgIHBhY2sua2luZCAgID0gU3RyaW5nKHBhY2sua2luZHx8JycpLnRvTG93ZXJDYXNlKCk7CiAgICBpZihwYWNrLnN0YXRlKSAgcGFjay5zdGF0ZSAgPSBTdHJpbmcocGFjay5zdGF0ZXx8JycpLnRvTG93ZXJDYXNlKCk7CiAgICAvLyBBZGQgY3JlYXRlZEF0IHNlcnZlciB0aW1lc3RhbXAgaWYgYXZhaWxhYmxlLCBlbHNlIGNsaWVudAogICAgdHJ5ewogICAgICBwYWNrLmNyZWF0ZWRBdCA9IChmaXJlYmFzZT8uZmlyZXN0b3JlPy5GaWVsZFZhbHVlPy5zZXJ2ZXJUaW1lc3RhbXAgJiYgZmlyZWJhc2UuZmlyZXN0b3JlLkZpZWxkVmFsdWUuc2VydmVyVGltZXN0YW1wKCkpIHx8IG5ldyBEYXRlKCk7CiAgICB9Y2F0Y2goXyl7CiAgICAgIHBhY2suY3JlYXRlZEF0ID0gbmV3IERhdGUoKTsKICAgIH0KICAgIGF3YWl0IGRiLmNvbGxlY3Rpb24oJ2FsZXJ0cycpLmFkZChwYWNrKTsKICB9Y2F0Y2goZSl7CiAgICBjb25zb2xlLndhcm4oJ2xvZ0FsYXJtRXZlbnQgZmFpbGVkOicsIGUpOwogIH0KfQpjb25zdCBBVVRPX1NZTkNfRU5BQkxFRCA9IHRydWU7CmNvbnN0IEFVVE9fU1lOQ19JTlRFUlZBTF9NUyA9IDgwMDA7IC8vIGNvIGtpbGthIHNla3VuZApjb25zdCBERVZJQ0VfS0VZID0gJ2d0X2RldmljZUlkJzsKZnVuY3Rpb24gZ2V0RGV2aWNlSWQoKXsKICB0cnl7CiAgICBsZXQgaWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShERVZJQ0VfS0VZKTsKICAgIGlmKCFpZCl7IGlkID0gJ2Rldl8nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiwxMCk7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKERFVklDRV9LRVksIGlkKTsgfQogICAgcmV0dXJuIGlkOwogIH1jYXRjaChfKXsgcmV0dXJuICdkZXZfdW5rbm93bic7IH0KfQpmdW5jdGlvbiBkamIyKHN0cil7CiAgbGV0IGggPSA1MzgxLCBpID0gc3RyLmxlbmd0aDsKICB3aGlsZShpKSBoID0gKGggKiAzMykgXiBzdHIuY2hhckNvZGVBdCgtLWkpOwogIHJldHVybiAoaD4+PjApLnRvU3RyaW5nKDE2KTsKfQp3aW5kb3cuX19kaXJ0eVNpbmNlID0gbnVsbDsKd2luZG93Ll9fbGFzdFVwbG9hZEhhc2ggPSBudWxsOwp3aW5kb3cuX19pc1N5bmNpbmcgPSBmYWxzZTsKd2luZG93Ll9fZGV2aWNlSWQgPSBnZXREZXZpY2VJZCgpOwp3aW5kb3cuX19tYXJrRGlydHkgPSBmdW5jdGlvbigpewogIHdpbmRvdy5fX2RpcnR5U2luY2UgPSBEYXRlLm5vdygpOwogIC8vIG9wY2pvbmFsbnkgbG9nCiAgdHJ5eyBmYkxvZygnWm1pZW5pb25vIGRhbmUgbG9rYWxuZSDigJQgYXV0by1zeW5jIHdrcsOzdGNlIHd5xZtsZScsICdvaycpOyB9Y2F0Y2goXyl7fQp9Owphc3luYyBmdW5jdGlvbiBoYXJkVXBsb2FkKCl7CiAgICBjb25zdCB7ZGJ9ID0gYXdhaXQgZmJJbml0KCk7IGlmKCFkYikgcmV0dXJuIGZhbHNlOwogICAgbGV0IGRhdGE9bnVsbDsgdHJ5eyBkYXRhID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19LRVkpKTsgfWNhdGNoKF8pe30KICAgIGlmICghZGF0YSl7IGFsZXJ0KCJCcmFrIGRhbnljaCBsb2thbG55Y2ggZG8gd3lzxYJhbmlhIChrbHVjejogIitMU19LRVkrIikiKTsgcmV0dXJuIGZhbHNlOyB9CiAgICBkYXRhLl90cyA9IERhdGUubm93KCk7IGRhdGEuX3ZlciA9IGRhdGEudmVyc2lvbnx8MTsKICAgIHRyeXsKICAgICAgd2luZG93LnNldFN5bmNTdGF0dXMoJ3N5bmNpbmcnKTsKICAgICAgYXdhaXQgZGIuY29sbGVjdGlvbihGQl9DT0wpLmRvYyhGQl9ET0MpLnNldChkYXRhLCB7bWVyZ2U6ZmFsc2V9KTsKICAgIHRyeXsgd2luZG93Ll9fbGFzdFVwbG9hZEhhc2ggPSBkamIyKEpTT04uc3RyaW5naWZ5KGRhdGEpKTsgfWNhdGNoKF8pe30KICAgIHdpbmRvdy5fX2RpcnR5U2luY2UgPSBudWxsOwogICAgICB3aW5kb3cuX19sYXN0U3luY0F0ID0gRGF0ZS5ub3coKTsgd2luZG93LnNldFN5bmNTdGF0dXMoJ29rJyk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfWNhdGNoKGUpewogICAgICBjb25zb2xlLndhcm4oIlVQTE9BRCBlcnJvcjoiLCBlKTsgd2luZG93LnNldFN5bmNTdGF0dXMoJ2Vycm9yJyk7IGFsZXJ0KCJCxYLEhWQgemFwaXN1OiAiICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaGFyZERvd25sb2FkKHNpbGVudD1mYWxzZSl7CiAgICAKICAgIGNvbnN0IHtkYn0gPSBhd2FpdCBmYkluaXQoKTsgaWYoIWRiKSByZXR1cm4gZmFsc2U7CiAgICB0cnl7CiAgICAgIHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdzeW5jaW5nJyk7CiAgICAgIGNvbnN0IHNuYXAgPSBhd2FpdCBkYi5jb2xsZWN0aW9uKEZCX0NPTCkuZG9jKEZCX0RPQykuZ2V0KCk7CiAgICAgIGlmKCFzbmFwLmV4aXN0cyl7IHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdlcnJvcicpOyBpZighc2lsZW50KSBhbGVydCgiQnJhayBkb2t1bWVudHUgdyBjaG11cnplLiBOYWpwaWVydyB1xbx5aiAnV3nFm2xpaicuIik7IGZiTG9nKCdCcmFrIGRva3VtZW50dSAnK0ZCX0NPTCsnLycrRkJfRE9DLCAnZXJyJyk7IHJldHVybiBmYWxzZTsgfQogICAgICBjb25zdCBkYXRhID0gc25hcC5kYXRhKCk7IGlmKCFkYXRhKXsgd2luZG93LnNldFN5bmNTdGF0dXMoJ2Vycm9yJyk7IGFsZXJ0KCJEb2t1bWVudCBwdXN0eS9uaWVwb3ByYXdueS4iKTsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKExTX0tFWSwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICAKICAgICAgLy8gYWt0dWFsaXphY2phIGFwbGlrYWNqaQogICAgICBpZiAodHlwZW9mIHdpbmRvdy5fX3NldEFwcERCID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdHJ5IHsgd2luZG93Ll9fc2V0QXBwREIoZGF0YSk7IH0gY2F0Y2goZSl7IGNvbnNvbGUuZXJyb3IoJ0LFgsSFZCBfX3NldEFwcERCOicsIGUpOyB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuc2F2ZT09PSdmdW5jdGlvbicpIHRyeXsgd2luZG93LnNhdmUoKTsgfWNhdGNoKF8pe30KICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5yZW5kZXI9PT0nZnVuY3Rpb24nKSB0cnl7IHdpbmRvdy5yZW5kZXIoKTsgfWNhdGNoKF8pe30KICAgICAgfQogICAgICBpZiAodHlwZW9mIERCIT09J3VuZGVmaW5lZCcpIHdpbmRvdy5EQiA9IGRhdGE7CiAgICAgIGlmICh0eXBlb2Ygc2F2ZT09PSdmdW5jdGlvbicpIHRyeXsgc2F2ZSgpOyB9Y2F0Y2goXyl7fQogICAgICBpZiAodHlwZW9mIHJlbmRlcj09PSdmdW5jdGlvbicpIHRyeXsgcmVuZGVyKCk7IH1jYXRjaChfKXt9CiAgICAgIHdpbmRvdy5fX2xhc3RTeW5jQXQgPSBEYXRlLm5vdygpOyB3aW5kb3cuc2V0U3luY1N0YXR1cygnb2snKTsKICAgICAgLyogc3VjY2VzcyBhbGVydCBzdXBwcmVzc2VkICovZmJMb2coJ1BvYnJhbm8gZGFuZSB6IGNobXVyeScsICdvaycpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH1jYXRjaChlKXsKICAgICAgY29uc29sZS53YXJuKCJET1dOTE9BRCBlcnJvcjoiLCBlKTsgd2luZG93LnNldFN5bmNTdGF0dXMoJ2Vycm9yJyk7IGFsZXJ0KCJCxYLEhWQgb2Rjenl0dTogIiArIChlICYmIGUubWVzc2FnZSB8fCBlKSk7IGZiTG9nKCdCxYLEhWQgb2Rjenl0dTogJysoZSYmZS5tZXNzYWdlfHxlKSwgJ2VycicpOyByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICAKICBhc3luYyBmdW5jdGlvbiBoYXJkRGlhZygpewogIGZ1bmN0aW9uIGZvbGRDb3VudHMoZGIpewogICAgY29uc3Qgb3V0ID0geyBwb3J0Zm9saW9zOiAwLCBjb21wYW5pZXM6IDAsIHBvc2l0aW9uczogMCB9OwogICAgdHJ5ewogICAgICBjb25zdCBzZXRUaWNrZXJzID0gbmV3IFNldCgpOwogICAgICBjb25zdCBwZnMgPSBBcnJheS5pc0FycmF5KGRiPy5wb3J0Zm9saW9zKSA/IGRiLnBvcnRmb2xpb3MgOiBbXTsKICAgICAgb3V0LnBvcnRmb2xpb3MgPSBwZnMubGVuZ3RoOwogICAgICBmb3IoY29uc3QgcGYgb2YgcGZzKXsKICAgICAgICBjb25zdCBob2xkaW5ncyA9IHBmICYmIHBmLmhvbGRpbmdzID8gcGYuaG9sZGluZ3MgOiB7fTsKICAgICAgICBmb3IoY29uc3QgW3RpY2tlciwgaF0gb2YgT2JqZWN0LmVudHJpZXMoaG9sZGluZ3MpKXsKICAgICAgICAgIGlmICh0aWNrZXIpIHNldFRpY2tlcnMuYWRkKFN0cmluZyh0aWNrZXIpLnRyaW0oKSk7CiAgICAgICAgICBjb25zdCBsb3RzID0gKGggJiYgQXJyYXkuaXNBcnJheShoLmxvdHMpKSA/IGgubG90cy5sZW5ndGggOiAwOwogICAgICAgICAgb3V0LnBvc2l0aW9ucyArPSBsb3RzOwogICAgICAgIH0KICAgICAgfQogICAgICBvdXQuY29tcGFuaWVzID0gc2V0VGlja2Vycy5zaXplOwogICAgfWNhdGNoKF8pe30KICAgIHJldHVybiBvdXQ7CiAgfQoKICBsZXQgbG9jYWwgPSB7cG9ydGZvbGlvczowLCBjb21wYW5pZXM6MCwgcG9zaXRpb25zOjB9OwogIHRyeXsKICAgIGNvbnN0IGxvY2FsRGF0YSA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oTFNfS0VZKXx8J251bGwnKTsKICAgIGxvY2FsID0gZm9sZENvdW50cyhsb2NhbERhdGEpOwogICAgY29uc29sZS5sb2coJ0RpYWcgbG9rYWxuaWU6Jywge2V4aXN0czogISFsb2NhbERhdGEsIC4uLmxvY2FsfSk7CiAgfWNhdGNoKGUpeyBjb25zb2xlLndhcm4oJ0LFgsSFZCBvZGN6eXR1IGxva2FsbmVnbzonLCBlKTsgfQoKICBjb25zdCB7ZGJ9ID0gYXdhaXQgZmJJbml0KCk7IGlmKCFkYikgcmV0dXJuIGZhbHNlOwogIHRyeXsKICAgIHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdzeW5jaW5nJyk7CiAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKEZCX0NPTCkuZG9jKEZCX0RPQykuc2V0KHtfcGluZzogRGF0ZS5ub3coKSwgX2RpYWc6J3Rlc3QgY29ubmVjdGlvbid9LCB7bWVyZ2U6dHJ1ZX0pOwogICAgY29uc3Qgc25hcCA9IGF3YWl0IGRiLmNvbGxlY3Rpb24oRkJfQ09MKS5kb2MoRkJfRE9DKS5nZXQoKTsKICAgIGlmKCFzbmFwLmV4aXN0cyl7IGZiTG9nKCdEaWFnOiB6YXBpcyBvaywgb2Rjenl0IGJyYWsgZG9rdW1lbnR1JywgJ2VycicpOyB3aW5kb3cuc2V0U3luY1N0YXR1cygnZXJyb3InKTsgcmV0dXJuIGZhbHNlOyB9CiAgICBjb25zdCBkYXRhID0gc25hcC5kYXRhKCk7CiAgICBjb25zdCByZW1vdGUgPSBmb2xkQ291bnRzKGRhdGEpOwogICAgY29uc3QgbGFzdFRzID0gZGF0YT8gKGRhdGEuX3RzPyBuZXcgRGF0ZShkYXRhLl90cykudG9Mb2NhbGVTdHJpbmcoKSA6ICdicmFrJykgOiAnYnJhayc7CgogICAgZmJMb2coJ0RpYWc6IHphcGlzL29kY3p5dCBPSycsICdvaycpOwogICAgd2luZG93LnNldFN5bmNTdGF0dXMoJ29rJyk7CgogICAgY29uc3QgbXNnID0gYERpYWdub3N0eWthIE9LIQoKTG9rYWxuaWUgKCR7TFNfS0VZfSk6Ci0gUG9ydGZlbGk6ICR7bG9jYWwucG9ydGZvbGlvc30KLSBTcMOzxYJlayAodW5pa2FsbmUgdGlja2VyeSk6ICR7bG9jYWwuY29tcGFuaWVzfQotIFBvenljamkgKGxvdMOzdyk6ICR7bG9jYWwucG9zaXRpb25zfQoKVyBjaG11cnplOgotIFBvcnRmZWxpOiAke3JlbW90ZS5wb3J0Zm9saW9zfQotIFNww7PFgmVrICh1bmlrYWxuZSB0aWNrZXJ5KTogJHtyZW1vdGUuY29tcGFuaWVzfQotIFBvenljamkgKGxvdMOzdyk6ICR7cmVtb3RlLnBvc2l0aW9uc30KCk9zdGF0bmkgdXBsb2FkOiAke2xhc3RUc31gOwogICAgYWxlcnQobXNnKTsKICAgIHJldHVybiB0cnVlOwogIH1jYXRjaChlKXsKICAgIGZiTG9nKCdEaWFnIGVycm9yOiAnKyhlJiZlLm1lc3NhZ2V8fGUpLCAnZXJyJyk7CiAgICB3aW5kb3cuc2V0U3luY1N0YXR1cygnZXJyb3InKTsKICAgIGFsZXJ0KCdEaWFnIGVycm9yOiAnKyhlJiZlLm1lc3NhZ2V8fGUpKTsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKT0+ewogICAgY29uc3QgdXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlyZWJhc2VVcGxvYWRCdG4nKTsKICAgIGNvbnN0IGRvd24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlyZWJhc2VEb3dubG9hZEJ0bicpOwogICAgaWYgKHVwKSB1cC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhcmRVcGxvYWQpOwogICAgaWYgKGRvd24pIGRvd24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+aGFyZERvd25sb2FkKHRydWUpKTsKICAgIGNvbnN0IGRpYWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlyZWJhc2VEaWFnQnRuJyk7IGlmIChkaWFnKSBkaWFnLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFyZERpYWcpOwogICAgLy8gYXV0by1zaWxlbnQgZG93bmxvYWQgb24gc3RhcnQgaWYgZG9jIGV4aXN0cyAobm8gYWxlcnQpCiAgICAoYXN5bmMgKCk9PnsKICAgICAgY29uc3Qge2RifSA9IGF3YWl0IGZiSW5pdCgpOyBpZighZGIpIHJldHVybjsKICAgIC8vID09PSBSZWFsLXRpbWUgbmFzxYJ1Y2ggemRhbG55Y2ggem1pYW4gPT09CiAgICBpZiAoZGIpIHsKICBpZiAod2luZG93Ll9fZmJfdW5zdWIpIHsgdHJ5eyB3aW5kb3cuX19mYl91bnN1YigpOyB9Y2F0Y2goXyl7IH0gfQogIHdpbmRvdy5fX2ZiX3Vuc3ViID0gZGIuY29sbGVjdGlvbihGQl9DT0wpLmRvYyhGQl9ET0MpLm9uU25hcHNob3QoKHNuYXApPT57CiAgICBpZiAod2luZG93Ll9fVU5ET19SRVNUT1JJTkcpIHsgdHJ5e2NvbnNvbGUubG9nKCdbVU5ET10gaWdub3JlIHJlbW90ZSBkdXJpbmcgcmVzdG9yZScpO31jYXRjaChfKXsgfSByZXR1cm47IH0KCiAgICB0cnl7CiAgICAgIGlmICghc25hcC5leGlzdHMpIHJldHVybjsKICAgICAgY29uc3QgcmVtb3RlID0gc25hcC5kYXRhKCk7CiAgICAgIGlmIChyZW1vdGUgJiYgcmVtb3RlLl9kZXZpY2UgJiYgcmVtb3RlLl9kZXZpY2UgPT09IGdldERldmljZUlkKCkpIHJldHVybjsgLy8gbmFzemEgem1pYW5hCiAgICAgIGZiTG9nKCdXeWtyeXRvIHpkYWxuxIUgem1pYW7EmSDigJQgYXV0byBwb2JpZXJhbmll4oCmJywgJ29rJyk7CiAgICAgIGhhcmREb3dubG9hZCh0cnVlKTsKICAgIH1jYXRjaChlKXsgY29uc29sZS53YXJuKCdvblNuYXBzaG90IGVycm9yJywgZSk7IH0KICB9KTsKfQovLyA9PT0gQXV0byBQVVNIIChjbyBraWxrYSBzZWt1bmQpID09PQogICAgdHJ5ewogICAgICBmdW5jdGlvbiBzdGFydEF1dG9TeW5jKCl7CiAgICAgICAgaWYgKHdpbmRvdy5fX2F1dG9TeW5jVGltZXIpIHJldHVybjsKICAgICAgICB3aW5kb3cuX19hdXRvU3luY1RpbWVyID0gc2V0SW50ZXJ2YWwoYXN5bmMgKCk9PnsKICAgICAgICAgIHRyeXsKICAgICAgICAgICAgaWYgKCFBVVRPX1NZTkNfRU5BQkxFRCkgcmV0dXJuOwogICAgICAgICAgICBpZiAod2luZG93Ll9faXNTeW5jaW5nKSByZXR1cm47CiAgICAgICAgICAgIGlmICghbmF2aWdhdG9yLm9uTGluZSkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCByYXcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19LRVkpIHx8ICcnOwogICAgICAgICAgICBpZiAoIXJhdykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBoID0gZGpiMihyYXcpOwogICAgICAgICAgICBpZiAod2luZG93Ll9fbGFzdFVwbG9hZEhhc2ggJiYgd2luZG93Ll9fbGFzdFVwbG9hZEhhc2ggPT09IGggJiYgIXdpbmRvdy5fX2RpcnR5U2luY2UpIHJldHVybjsKICAgICAgICAgICAgd2luZG93Ll9faXNTeW5jaW5nID0gdHJ1ZTsKICAgICAgICAgIH1jYXRjaChlKXt9CiAgICAgICAgICB0cnl7CiAgICAgICAgICAgIGZiTG9nKCdBdXRvOiB3eXN5xYJhbSB6bWlhbnnigKYnLCAnb2snKTsKICAgICAgICAgICAgYXdhaXQgaGFyZFVwbG9hZCgpOwogICAgICAgICAgfWNhdGNoKGUpeyBjb25zb2xlLndhcm4oJ0F1dG9TeW5jIHVwbG9hZCBlcnJvcicsIGUpOyB9CiAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgd2luZG93Ll9faXNTeW5jaW5nID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwgQVVUT19TWU5DX0lOVEVSVkFMX01TKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzdG9wQXV0b1N5bmMoKXsgaWYgKHdpbmRvdy5fX2F1dG9TeW5jVGltZXIpeyBjbGVhckludGVydmFsKHdpbmRvdy5fX2F1dG9TeW5jVGltZXIpOyB3aW5kb3cuX19hdXRvU3luY1RpbWVyID0gbnVsbDsgfSB9CiAgICAgIC8vIHdyYXAgc2F2ZSgpCiAgICAgIGlmICh0eXBlb2Ygd2luZG93LnNhdmU9PT0nZnVuY3Rpb24nICYmICF3aW5kb3cuX19zYXZlV3JhcHBlZCl7CiAgICAgICAgY29uc3QgX19vcmlnU2F2ZSA9IHdpbmRvdy5zYXZlOwogICAgICAgIHdpbmRvdy5zYXZlID0gZnVuY3Rpb24oKXsKICAgICAgICAgIGNvbnN0IHIgPSBfX29yaWdTYXZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB0cnl7IHdpbmRvdy5fX21hcmtEaXJ0eSgpOyB9Y2F0Y2goXyl7fQogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuX19zYXZlV3JhcHBlZCA9IHRydWU7CiAgICAgIH0KICAgICAgLy8gZmx1c2ggb24gaGlkZS91bmxvYWQKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsICgpPT57CiAgICAgICAgaWYgKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZT09PSdoaWRkZW4nKXsgdHJ5eyBpZiAod2luZG93Ll9fZGlydHlTaW5jZSkgaGFyZFVwbG9hZCgpOyB9Y2F0Y2goXyl7IH0gfQogICAgICB9KTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsICgpPT57IHRyeXsgaWYgKHdpbmRvdy5fX2RpcnR5U2luY2UpIG5hdmlnYXRvci5zZW5kQmVhY29uICYmIG5hdmlnYXRvci5zZW5kQmVhY29uKCcvbm9vcCcpOyB9Y2F0Y2goXyl7IH0gfSk7CiAgICAgIHN0YXJ0QXV0b1N5bmMoKTsKICAgIH1jYXRjaChlKXsgY29uc29sZS53YXJuKCdBdXRvU3luYyBpbml0IGVycm9yJywgZSk7IH0KCiAgICAgIHRyeXsKICAgICAgICBjb25zdCBzbmFwID0gYXdhaXQgZGIuY29sbGVjdGlvbihGQl9DT0wpLmRvYyhGQl9ET0MpLmdldCgpOwogICAgICAgIGlmKHNuYXAuZXhpc3RzKXsgYXdhaXQgaGFyZERvd25sb2FkKHRydWUpOyB9CiAgICAgICAgZWxzZSB7IGZiTG9nKCdBdXRvOiBicmFrIGRva3VtZW50dSBkbyBwb2JyYW5pYScsICdlcnInKTsgfQogICAgICB9Y2F0Y2goZSl7IGZiTG9nKCdBdXRvLWxvYWQgYsWCxIVkOiAnKyhlJiZlLm1lc3NhZ2V8fGUpLCAnZXJyJyk7IH0KICAgIH0pKCk7CiAgfSk7CiAgPC9zY3JpcHQ+CgoKICA8c3R5bGU+CiAgICAjZmJMb2cgewogICAgICBwb3NpdGlvbjogZml4ZWQ7IHJpZ2h0OiAxMnB4OyBib3R0b206IDEycHg7IHotaW5kZXg6IDk5OTk7CiAgICAgIG1heC13aWR0aDogMzhjaDsgYmFja2dyb3VuZDogcmdiYSgxNywyNCwzOSwwLjkpOyBjb2xvcjogI2VlZTsKICAgICAgYm9yZGVyLXJhZGl1czogMTJweDsgcGFkZGluZzogMTBweCAxMnB4OyBib3gtc2hhZG93OiAwIDRweCAxNnB4IHJnYmEoMCwwLDAsMC40KTsKICAgICAgZm9udDogMTJweC8xLjM1IHN5c3RlbS11aSwgU2Vnb2UgVUksIFJvYm90bywgQXJpYWwsIHNhbnMtc2VyaWY7CiAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9CiAgICAjZmJMb2cuc2hvd3sgZGlzcGxheTpibG9jazsgfQogICAgI2ZiTG9nIGJ7IGNvbG9yOiM5M2M1ZmQ7IH0KICAgICNmYkxvZyAuZXJyeyBjb2xvcjojZmNhNWE1OyB9CiAgICAjZmJMb2cgLm9reyBjb2xvcjojODZlZmFjOyB9CiAgLyogPT09IERhaWx5IGNoYW5nZSBhcnJvd3MgPT09ICovCi5jaGFuZ2UtYXJyb3d7IGZvbnQtd2VpZ2h0OiA3MDA7IG1hcmdpbi1yaWdodDogNHB4OyB9Ci5jaGFuZ2UtYXJyb3cudXB7IGNvbG9yOiB2YXIoLS1vayk7IH0KLmNoYW5nZS1hcnJvdy5kb3dueyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQoKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgogIDxkaXYgaWQ9ImZiTG9nIj48L2Rpdj4KCgo8c2NyaXB0PgovLyBHbG9iYWwgY2xpY2sgZGVsZWdhdGUgZm9yIHBlci1sb3QgbXV0ZS91bm11dGUKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICBjb25zdCBidG4gPSBlLnRhcmdldC5jbG9zZXN0KCdidXR0b24ubG90LW11dGUnKTsKICBpZighYnRuKSByZXR1cm47CiAgdHJ5ewogICAgY29uc3QgREJyZWYgPSB3aW5kb3cuREIgfHwge307CiAgICBjb25zdCBwZklkID0gREJyZWYuY3VycmVudFBmSWQgfHwgREJyZWYuc2VsZWN0ZWRQZklkIHx8IChEQnJlZi5wb3J0Zm9saW9zICYmIE9iamVjdC5rZXlzKERCcmVmLnBvcnRmb2xpb3MpWzBdKTsKICAgIGNvbnN0IHBmID0gKERCcmVmLnBvcnRmb2xpb3MgJiYgcGZJZCkgPyBEQnJlZi5wb3J0Zm9saW9zW3BmSWRdIDogbnVsbDsKICAgIGlmKCFwZikgcmV0dXJuOwogICAgY29uc3QgbG90SWQgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLWxvdCcpOwogICAgbGV0IGxvdCA9IG51bGw7CiAgICBmb3IoY29uc3QgW3RrLCBib29rXSBvZiBPYmplY3QuZW50cmllcyhwZi5ob2xkaW5nc3x8e30pKXsKICAgICAgbG90ID0gKGJvb2subG90c3x8W10pLmZpbmQoeD0+IHgubG90SWQgPT09IGxvdElkKTsKICAgICAgaWYobG90KSBicmVhazsKICAgIH0KICAgIGlmKCFsb3QpIHJldHVybjsKICAgIGxvdC5tdXRlZCA9ICFsb3QubXV0ZWQ7CiAgICBpZih0eXBlb2Ygc2F2ZSA9PT0gJ2Z1bmN0aW9uJykgc2F2ZSgpOwogICAgaWYodHlwZW9mIHJlbmRlciA9PT0gJ2Z1bmN0aW9uJykgcmVuZGVyKCk7CiAgfWNhdGNoKGVycil7CiAgICBjb25zb2xlLmVycm9yKCJsb3QtbXV0ZSB0b2dnbGUgZXJyb3IiLCBlcnIpOwogIH0KfSk7PC9zY3JpcHQ+CgoKPHNjcmlwdD4KLy8gPT09IFBlcnNpc3QgZXhwYW5kZWQgY29tcGFueSBwYW5lbHMgYWNyb3NzIG11dGUvcmVmcmVzaCByZW5kZXJzID09PQooZnVuY3Rpb24oKXsKICBjb25zdCBTU19LRVkgPSAnb3BlbkRldGFpbHNUaWNrZXJzX3YyJzsKCiAgZnVuY3Rpb24gbG9hZFNldCgpewogICAgdHJ5eyBjb25zdCByYXcgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFNTX0tFWSk7IGNvbnN0IGFyciA9IHJhdz8gSlNPTi5wYXJzZShyYXcpOiBbXTsgcmV0dXJuIG5ldyBTZXQoQXJyYXkuaXNBcnJheShhcnIpPyBhcnI6IFtdKTt9Y2F0Y2goXyl7IHJldHVybiBuZXcgU2V0KCk7IH0KICB9CiAgZnVuY3Rpb24gc2F2ZVNldChzZXQpewogICAgdHJ5eyBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKFNTX0tFWSwgSlNPTi5zdHJpbmdpZnkoQXJyYXkuZnJvbShzZXR8fFtdKSkpOyB9Y2F0Y2goXyl7fQogIH0KICB3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMgPSB3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMgfHwgbG9hZFNldCgpOwoKICBmdW5jdGlvbiBlbnN1cmVEYXRhVGlja2VyKHJvb3QpewogICAgY29uc3QgY3R4ID0gcm9vdCB8fCBkb2N1bWVudDsKICAgIGNvbnN0IG5vZGVzID0gY3R4LnF1ZXJ5U2VsZWN0b3JBbGwoJyNob2xkaW5nc1RhYmxlV3JhcCBkZXRhaWxzOm5vdChbZGF0YS10aWNrZXJdKSBzdW1tYXJ5Jyk7CiAgICBub2Rlcy5mb3JFYWNoKHN1bT0+ewogICAgICB0cnl7CiAgICAgICAgLy8gVGFrZSB0aGUgZmlyc3QgdGV4dCBub2RlIGNvbnRlbnQgYXMgdGlja2VyIChiZWZvcmUgYW55IGJ1dHRvbnMvaWNvbnMpCiAgICAgICAgbGV0IHR4dCA9ICcnOwogICAgICAgIGZvcihjb25zdCBuIG9mIHN1bS5jaGlsZE5vZGVzKXsKICAgICAgICAgIGlmKG4ubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFKXsKICAgICAgICAgICAgdHh0ID0gKG4udGV4dENvbnRlbnR8fCcnKS50cmltKCk7CiAgICAgICAgICAgIGlmKHR4dCl7IGJyZWFrOyB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKCF0eHQpewogICAgICAgICAgLy8gZmFsbGJhY2s6IHdob2xlIHRleHQgd2l0aG91dCBpbm5lciBidXR0b24gbGFiZWxzCiAgICAgICAgICB0eHQgPSAoc3VtLnRleHRDb250ZW50fHwnJykudHJpbSgpLnNwbGl0KCdcbicpWzBdLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGV0YWlscyA9IHN1bS5jbG9zZXN0KCdkZXRhaWxzJyk7CiAgICAgICAgaWYoZGV0YWlscyAmJiB0eHQpIGRldGFpbHMuZGF0YXNldC50aWNrZXIgPSB0eHQ7CiAgICAgIH1jYXRjaChfKXt9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlbWVtYmVyT3BlbigpewogICAgdHJ5ewogICAgICBlbnN1cmVEYXRhVGlja2VyKCk7CiAgICAgIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaG9sZGluZ3NUYWJsZVdyYXAnKTsKICAgICAgaWYoIXdyYXApIHJldHVybjsKICAgICAgY29uc3Qgb3BlbmVkID0gQXJyYXkuZnJvbSh3cmFwLnF1ZXJ5U2VsZWN0b3JBbGwoJ2RldGFpbHNbb3Blbl1bZGF0YS10aWNrZXJdJykpLm1hcChkPT5kLmRhdGFzZXQudGlja2VyKTsKICAgICAgd2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzID0gbmV3IFNldChvcGVuZWQpOwogICAgICBzYXZlU2V0KHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2Vycyk7CiAgICB9Y2F0Y2goXyl7fQogIH0KCiAgZnVuY3Rpb24gcmVzdG9yZU9wZW4ocm9vdCl7CiAgICB0cnl7CiAgICAgIGVuc3VyZURhdGFUaWNrZXIocm9vdCk7CiAgICAgIGNvbnN0IGN0eCA9IHJvb3QgfHwgZG9jdW1lbnQ7CiAgICAgIGNvbnN0IHdyYXAgPSBjdHguZ2V0RWxlbWVudEJ5SWQgPyBjdHggOiBkb2N1bWVudDsKICAgICAgKHdyYXAucXVlcnlTZWxlY3RvckFsbCA/IHdyYXAucXVlcnlTZWxlY3RvckFsbCgnI2hvbGRpbmdzVGFibGVXcmFwIGRldGFpbHNbZGF0YS10aWNrZXJdJykgOiBbXSkuZm9yRWFjaChkPT57CiAgICAgICAgY29uc3QgdCA9IGQuZGF0YXNldC50aWNrZXI7CiAgICAgICAgaWYod2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzICYmIHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2Vycy5oYXModCkpIGQuc2V0QXR0cmlidXRlKCdvcGVuJywnJyk7CiAgICAgIH0pOwogICAgfWNhdGNoKF8pe30KICB9CgogIC8vIEtlZXAgc2V0IGluIHN5bmMgd2hlbiB1c2VyIHRvZ2dsZXMgYW55IGRldGFpbHMKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b2dnbGUnLCAoZSk9PnsKICAgIGNvbnN0IGQgPSBlLnRhcmdldCAmJiBlLnRhcmdldC5jbG9zZXN0ICYmIGUudGFyZ2V0LmNsb3Nlc3QoJyNob2xkaW5nc1RhYmxlV3JhcCBkZXRhaWxzW2RhdGEtdGlja2VyXScpOwogICAgaWYoIWQpIHJldHVybjsKICAgIGNvbnN0IHQgPSBkLmRhdGFzZXQudGlja2VyOwogICAgaWYoIXQpIHJldHVybjsKICAgIGlmKCF3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMpIHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2VycyA9IG5ldyBTZXQoKTsKICAgIGlmKGQub3Blbikgd2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzLmFkZCh0KTsgZWxzZSB3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMuZGVsZXRlKHQpOwogICAgc2F2ZVNldCh3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMpOwogIH0sIHRydWUpOwoKICAvLyBCZWZvcmUgYW55IGNsaWNrIHRoYXQgbWlnaHQgcmUtcmVuZGVyLCBzbmFwc2hvdCB0aGUgc3RhdGUgKGNhcHR1cmUgcGhhc2UpCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyB0cnl7IHJlbWVtYmVyT3BlbigpOyB9Y2F0Y2goXyl7fSB9LCB0cnVlKTsKCiAgLy8gT2JzZXJ2ZSBET00gbXV0YXRpb25zIGFuZCByZS1vcGVuIGFmdGVyIGNoYW5nZXMKICBjb25zdCBtbyA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChsaXN0KT0+ewogICAgbGV0IG5lZWQgPSBmYWxzZTsKICAgIGZvcihjb25zdCBtIG9mIGxpc3QpewogICAgICBpZihtLmFkZGVkTm9kZXMgJiYgbS5hZGRlZE5vZGVzLmxlbmd0aCl7CiAgICAgICAgbmVlZCA9IHRydWU7IGJyZWFrOwogICAgICB9CiAgICAgIGlmKG0udHlwZSA9PT0gJ2NoaWxkTGlzdCcpIHsgbmVlZCA9IHRydWU7IGJyZWFrOyB9CiAgICB9CiAgICBpZihuZWVkKXsKICAgICAgLy8gc2xpZ2h0IGRlbGF5IHRvIGFsbG93IGlubmVySFRNTCB0byBzZXR0bGUKICAgICAgc2V0VGltZW91dCgoKT0+cmVzdG9yZU9wZW4oKSwgMCk7CiAgICB9CiAgfSk7CiAgbW8ub2JzZXJ2ZShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHtzdWJ0cmVlOnRydWUsIGNoaWxkTGlzdDp0cnVlfSk7CgogIC8vIFdyYXAgYWxsIGtub3duIHJlbmRlciogZnVuY3Rpb25zCiAgZnVuY3Rpb24gd3JhcFJlbmRlcnMoKXsKICAgIGNvbnN0IG5hbWVzID0gWydyZW5kZXInLCdyZW5kZXJNYWluJywncmVuZGVyTG90cycsJ3JlbmRlclBvcnRmb2xpb0xpc3QnLCdyZW5kZXJXaXNobGlzdCddOwogICAgbmFtZXMuZm9yRWFjaChuPT57CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBmbiA9IHdpbmRvd1tuXTsKICAgICAgICBpZih0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicgJiYgIWZuLl9fcGF0Y2hlZEtlZXBPcGVuKXsKICAgICAgICAgIGNvbnN0IHdyYXBwZWQgPSBmdW5jdGlvbigpewogICAgICAgICAgICByZW1lbWJlck9wZW4oKTsKICAgICAgICAgICAgY29uc3QgcmVzID0gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+cmVzdG9yZU9wZW4oKSwgMCk7CiAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgICB9OwogICAgICAgICAgd3JhcHBlZC5fX3BhdGNoZWRLZWVwT3BlbiA9IHRydWU7CiAgICAgICAgICB3aW5kb3dbbl0gPSB3cmFwcGVkOwogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KICAgIH0pOwogIH0KCiAgLy8gSW5pdGlhbCByZXN0b3JlIGFmdGVyIGZpcnN0IHBhaW50CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKT0+eyBzZXRUaW1lb3V0KCgpPT57IHdyYXBSZW5kZXJzKCk7IHJlc3RvcmVPcGVuKCk7IH0sIDApOyB9KTsKICAvLyBBbHNvIHRyeSBzb29uIGluIGNhc2Ugc2NyaXB0cyBkZWZpbmUgcmVuZGVycyBsYXRlcgogIHNldFRpbWVvdXQod3JhcFJlbmRlcnMsIDApOwogIHNldFRpbWVvdXQocmVzdG9yZU9wZW4sIDUwKTsKfSkoKTsKCi8vID09PSBBUEkgbGFzdCByZWZyZXNoIGNsb2NrID09PQp3aW5kb3cuc2V0QXBpVGltZSA9IGZ1bmN0aW9uKHRzKXsKICB0cnl7CiAgICBpZih0eXBlb2YgZW5zdXJlU3RhdHVzQmV0d2VlbiA9PT0gJ2Z1bmN0aW9uJykgZW5zdXJlU3RhdHVzQmV0d2VlbigpOwogICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzeW5jU3RhdHVzV3JhcCcpOwogICAgaWYoIXdyYXApIHJldHVybjsKICAgIGxldCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcGlUaW1lJyk7CiAgICBpZighZWwpewogICAgICBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgZWwuaWQgPSAnYXBpVGltZSc7CiAgICAgIGVsLnN0eWxlLm1hcmdpbkxlZnQgPSAnNnB4JzsKICAgICAgZWwuY2xhc3NOYW1lID0gJ211dGVkJzsKICAgICAgd3JhcC5hcHBlbmRDaGlsZChlbCk7CiAgICB9CiAgICBmdW5jdGlvbiBwYWQobil7IHJldHVybiAobjwxMD8nMCc6JycpK247IH0KICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSh0cyB8fCAod2luZG93Ll9fbGFzdEFwaVJlZnJlc2hBdHx8RGF0ZS5ub3coKSkpOwogICAgZWwudGV4dENvbnRlbnQgPSAn4oCiIEFQSTogJyArIHBhZChkLmdldEhvdXJzKCkpKyc6JytwYWQoZC5nZXRNaW51dGVzKCkpKyc6JytwYWQoZC5nZXRTZWNvbmRzKCkpOwogIH1jYXRjaChfKXt9Cn07Cgo8L3NjcmlwdD4KCjxzY3JpcHQ+Ci8vID09PSBUb2FzdHMgJiBVbnJlYWQgYmFkZ2UgPT09CihmdW5jdGlvbigpewogIGZ1bmN0aW9uIGVuc3VyZVdyYXAoKXsgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdHNXcmFwJyk7IH0KICB3aW5kb3cuc2hvd1RvYXN0ID0gZnVuY3Rpb24oe3RpY2tlciwgc3RhdGUsIGtpbmR9KXsKICAgIHRyeXsKICBjb25zdCB3cmFwID0gKHR5cGVvZiBlbnN1cmVXcmFwPT09J2Z1bmN0aW9uJykgPyBlbnN1cmVXcmFwKCkgOiBudWxsOwogIGlmKHdyYXApewogICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGVsLmNsYXNzTmFtZSA9ICd0b2FzdCAnICsgKHN0YXRlfHwnJyk7CiAgICBjb25zdCBsYWJlbCA9IHN0YXRlPT09J2hpdCcgPyAn8J+OryBDZWwgb3NpxIVnbmnEmXR5JyA6IChzdGF0ZT09PSduZWFyJyA/ICfij7MgQmxpc2tvIGNlbHUnIDogJ/CflJQgQWxhcm0nKTsKICAgIGVsLmlubmVySFRNTCA9IGA8c3Ryb25nPiR7bGFiZWx9PC9zdHJvbmc+IOKAoiAke3RpY2tlciA/ICh0aWNrZXIudG9VcHBlckNhc2U/LigpfHx0aWNrZXIpIDogJ+KAlCd9IOKAoiAke2tpbmQgPyBraW5kLnRvVXBwZXJDYXNlPy4oKSA6ICfigJQnfSA8c3BhbiBjbGFzcz0idGltZSI+JHtuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygpfTwvc3Bhbj5gOwogICAgd3JhcC5hcHBlbmRDaGlsZChlbCk7CiAgICBzZXRUaW1lb3V0KCgpPT57IHRyeXsgZWwucmVtb3ZlKCk7IH1jYXRjaChfKXsgfSB9LCA2MDAwKTsKICB9CiAgLy8gYnVtcCB1bnJlYWQgcmVnYXJkbGVzcyBvZiB0b2FzdCBjb250YWluZXIgYXZhaWxhYmlsaXR5CiAgdHJ5ewogICAgY29uc3Qgaz0nYWxlcnRzX3VucmVhZF9jb3VudCc7CiAgICBjb25zdCBjdXJyID0gTnVtYmVyKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGspfHwwKSB8fCAwOwogICAgY29uc3QgdmFsID0gTWF0aC5taW4oY3VycisxLCA5OTkpOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oaywgU3RyaW5nKHZhbCkpOwogICAgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsKICB9Y2F0Y2goXyl7fQp9Y2F0Y2goXyl7fQoKICB9OwogIHdpbmRvdy51cGRhdGVBbGVydHNCYWRnZSA9IGZ1bmN0aW9uKCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1RhYkJ0bicpOwogICAgICBpZighZWwpIHJldHVybjsKICAgICAgY29uc3Qgaz0nYWxlcnRzX3VucmVhZF9jb3VudCc7CiAgICAgIGNvbnN0IG4gPSBOdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oayl8fDApIHx8IDA7CiAgICAgIGxldCBiID0gZWwucXVlcnlTZWxlY3RvcignLmJhZGdlJyk7CiAgICAgIGlmKG4+MCl7CiAgICAgICAgaWYoIWIpeyBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyBiLmNsYXNzTmFtZT0nYmFkZ2UnOyBlbC5hcHBlbmRDaGlsZChiKTsgfQogICAgICAgIGIudGV4dENvbnRlbnQgPSBTdHJpbmcobik7CiAgICAgIH1lbHNlIGlmKGIpeyBiLnJlbW92ZSgpOyB9CiAgICB9Y2F0Y2goXyl7fQogIH07CiAgd2luZG93LnJlc2V0QWxlcnRzVW5yZWFkID0gZnVuY3Rpb24oKXsKICAgIHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2FsZXJ0c191bnJlYWRfY291bnQnLCAnMCcpOyB1cGRhdGVBbGVydHNCYWRnZSgpOyB9Y2F0Y2goXyl7fQogIH07CiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIHVwZGF0ZUFsZXJ0c0JhZGdlKTsKfSkoKTsKPC9zY3JpcHQ+CgoKPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgZnVuY3Rpb24gX19mYWxsYmFja1NldEFjdGl2ZSh2KXsKICAgIHRyeXsKICAgICAgY29uc3QgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tYWluJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpOwogICAgICBpZighbWFpbikgcmV0dXJuOwogICAgICBjb25zdCBwYW5lbHMgPSBtYWluLnF1ZXJ5U2VsZWN0b3JBbGwoJzpzY29wZSA+IHNlY3Rpb24nKTsKICAgICAgcGFuZWxzLmZvckVhY2goc2VjPT57CiAgICAgICAgaWYodj09PSd3aXNobGlzdCcpIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSd3aXNobGlzdFBhbmVsJykgPyAnJyA6ICdub25lJzsKICAgICAgICBlbHNlIGlmKHY9PT0nYWxlcnRzJykgc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J2FsZXJ0c1BhbmVsJykgPyAnJyA6ICdub25lJzsKICAgICAgICBlbHNlIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSd3aXNobGlzdFBhbmVsJyB8fCBzZWMuaWQ9PT0nYWxlcnRzUGFuZWwnKSA/ICdub25lJyA6ICcnOwogICAgICB9KTsKICAgICAgY29uc3QgYnRuVyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aXNobGlzdFRhYkJ0bicpOwogICAgICBpZihidG5XKXsgYnRuVy5jbGFzc0xpc3QudG9nZ2xlKCdzZWNvbmRhcnknLCB2IT09J3dpc2hsaXN0Jyk7IH0KICAgICAgY29uc3QgYnRuQSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbGVydHNUYWJCdG4nKTsKICAgICAgaWYoYnRuQSl7IGJ0bkEuY2xhc3NMaXN0LnRvZ2dsZSgnc2Vjb25kYXJ5JywgdiE9PSdhbGVydHMnKTsgfQogICAgICBjb25zdCBidG5QID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BvcnRmb2xpb3NUYWJCdG4nKTsKICAgICAgaWYoYnRuUCl7IGJ0blAuY2xhc3NMaXN0LnRvZ2dsZSgnc2Vjb25kYXJ5JywgISh2IT09J3dpc2hsaXN0JyAmJiB2IT09J2FsZXJ0cycpKTsgfSAvLyBwcmltYXJ5IHdoZW4gbWFpbgogICAgfWNhdGNoKF8pe30KICB9CiAgY29uc3QgbmF2U2V0ID0gKHdpbmRvdy5zZXRBY3RpdmVWaWV3IHx8IF9fZmFsbGJhY2tTZXRBY3RpdmUpOwogIHRyeXsKICAgIGNvbnN0IGJ0blAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9ydGZvbGlvc1RhYkJ0bicpOwogICAgaWYoYnRuUCl7IGJ0blAuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBuYXZTZXQoJ21haW4nKTsgfSk7IH0KICAgIGNvbnN0IGJ0bkEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzVGFiQnRuJyk7CiAgICBpZihidG5BKXsgYnRuQS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IG5hdlNldCgnYWxlcnRzJyk7IHdpbmRvdy5yZXNldEFsZXJ0c1VucmVhZCAmJiB3aW5kb3cucmVzZXRBbGVydHNVbnJlYWQoKTsgdHJ5eyBhY2tDdXJyZW50QWxlcnRzKCk7IHVwZGF0ZVNpZGViYXJCbGlua1N0YXRlcyAmJiB1cGRhdGVTaWRlYmFyQmxpbmtTdGF0ZXMoKTsgfWNhdGNoKF8peyB9IHdpbmRvdy5yZW5kZXJBbGVydHMgJiYgd2luZG93LnJlbmRlckFsZXJ0cygpOyB9KTsgfQogICAgY29uc3QgYnRuVyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aXNobGlzdFRhYkJ0bicpOwogICAgaWYoYnRuVyl7IGJ0blcuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBuYXZTZXQoJ3dpc2hsaXN0Jyk7IH0pOyB9CiAgfWNhdGNoKF8pe30KfSkoKTsKPC9zY3JpcHQ+CgoKPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgYXN5bmMgZnVuY3Rpb24ganVtcFRvVGlja2VyKHRpY2tlcil7CiAgICB0cnl7CiAgICAgIHRpY2tlciA9ICh0aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICBpZighdGlja2VyKSByZXR1cm47CiAgICAgIC8vIHBpY2sgZmlyc3QgcG9ydGZvbGlvIHRoYXQgY29udGFpbnMgdGhpcyB0aWNrZXIKICAgICAgbGV0IHBmSWQgPSBudWxsOwogICAgICB0cnl7CiAgICAgICAgZm9yKGNvbnN0IHBmIG9mICh3aW5kb3cuREI/LnBvcnRmb2xpb3N8fFtdKSl7CiAgICAgICAgICBpZihwZiAmJiBwZi5ob2xkaW5ncyAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGYuaG9sZGluZ3MsIHRpY2tlcikpewogICAgICAgICAgICBwZklkID0gcGYuaWQgfHwgcGYubmFtZSB8fCBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CiAgICAgIC8vIHN3aXRjaCB2aWV3IHRvIG1haW4KICAgICAgY29uc3QgbmF2U2V0ID0gKHdpbmRvdy5zZXRBY3RpdmVWaWV3IHx8IGZ1bmN0aW9uKHYpeyAKICAgICAgICBjb25zdCBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1haW4nKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJyk7CiAgICAgICAgaWYoIW1haW4pIHJldHVybjsKICAgICAgICBjb25zdCBwYW5lbHMgPSBtYWluLnF1ZXJ5U2VsZWN0b3JBbGwoJzpzY29wZSA+IHNlY3Rpb24nKTsKICAgICAgICBwYW5lbHMuZm9yRWFjaChzZWM9PnsKICAgICAgICAgIGlmKHY9PT0nd2lzaGxpc3QnKSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nd2lzaGxpc3RQYW5lbCcpID8gJycgOiAnbm9uZSc7CiAgICAgICAgICBlbHNlIGlmKHY9PT0nYWxlcnRzJykgc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J2FsZXJ0c1BhbmVsJykgPyAnJyA6ICdub25lJzsKICAgICAgICAgIGVsc2Ugc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnIHx8IHNlYy5pZD09PSdhbGVydHNQYW5lbCcpID8gJ25vbmUnIDogJyc7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBuYXZTZXQoJ21haW4nKTsKICAgICAgLy8gb3B0aW9uYWxseSBzZWxlY3QgcG9ydGZvbGlvIGlmIGFwcCBleHBvc2VzIEFQSQogICAgICB0cnl7CiAgICAgICAgaWYocGZJZCAmJiB0eXBlb2Ygd2luZG93LnNldEN1cnJlbnRQb3J0Zm9saW9JZD09PSdmdW5jdGlvbicpewogICAgICAgICAgYXdhaXQgd2luZG93LnNldEN1cnJlbnRQb3J0Zm9saW9JZChwZklkKTsKICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CiAgICAgIC8vIGVuc3VyZSByZW5kZXIKICAgICAgdHJ5eyBpZih0eXBlb2Ygd2luZG93LnJlbmRlcj09PSdmdW5jdGlvbicpIHdpbmRvdy5yZW5kZXIoKTsgZWxzZSBpZih0eXBlb2Ygd2luZG93LnJlbmRlck1haW49PT0nZnVuY3Rpb24nKSB3aW5kb3cucmVuZGVyTWFpbigpOyB9Y2F0Y2goXyl7fQogICAgICAvLyBzY3JvbGwgdG8gcm93IGNvbnRhaW5pbmcgdGlja2VyCiAgICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCd0ZC50aWNrZXInKSk7CiAgICAgICAgICBjb25zdCBjZWxsID0gY2FuZGlkYXRlcy5maW5kKHRkID0+ICh0ZC50ZXh0Q29udGVudHx8JycpLnRvVXBwZXJDYXNlKCkuaW5jbHVkZXModGlja2VyKSk7CiAgICAgICAgICBpZihjZWxsKXsKICAgICAgICAgICAgY2VsbC5zY3JvbGxJbnRvVmlldyh7YmVoYXZpb3I6J3Ntb290aCcsIGJsb2NrOidjZW50ZXInfSk7CiAgICAgICAgICAgIGNlbGwuY2xhc3NMaXN0LmFkZCgnaGlnaGxpZ2h0Jyk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PnsgdHJ5eyBjZWxsLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZ2hsaWdodCcpOyB9Y2F0Y2goXyl7fSB9LCAyMDAwKTsKICAgICAgICAgIH0KICAgICAgICB9Y2F0Y2goXyl7fQogICAgICB9LCA1MCk7CiAgICB9Y2F0Y2goXyl7fQogIH0KICAvLyBzaW1wbGUgaGlnaGxpZ2h0IHN0eWxlCiAgdHJ5ewogICAgY29uc3QgY3NzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIGNzcy50ZXh0Q29udGVudCA9ICcuaGlnaGxpZ2h0e291dGxpbmU6M3B4IHNvbGlkICNmNTllMGI7IGJvcmRlci1yYWRpdXM6NnB4OyB0cmFuc2l0aW9uOiBvdXRsaW5lLWNvbG9yIC4zc30nOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChjc3MpOwogIH1jYXRjaChfKXt9CiAgLy8gZXZlbnQgZGVsZWdhdGlvbgogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57CiAgICBjb25zdCBhID0gZS50YXJnZXQuY2xvc2VzdCgnYS5hbGVydC10aWNrZXInKTsKICAgIGlmKGEpewogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGNvbnN0IHQgPSBhLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsKICAgICAganVtcFRvVGlja2VyKHQpOwogICAgfQogIH0pOwogIC8vIGV4cG9zZSBmb3IgZGVidWdnaW5nCiAgd2luZG93Lmp1bXBUb1RpY2tlciA9IGp1bXBUb1RpY2tlcjsKfSkoKTsKPC9zY3JpcHQ+Cgo8c2NyaXB0PgovLyA9PT0gQWxlcnRzIHBhbmVsIGxvZ2ljID09PQovLyAobG9jYWwgaGVscGVycyBmb3IgQWxlcnRzIHBhbmVsIHRvIGF2b2lkIGdsb2JhbCBkZXBzKQpjb25zdCBfX2VzYyA9IChzKT0+ewogIHRyeXsKICAgIGlmICh0eXBlb2Ygd2luZG93LmVzY2FwZUh0bWwgPT09ICdmdW5jdGlvbicpIHJldHVybiB3aW5kb3cuZXNjYXBlSHRtbChTdHJpbmcoc3x8JycpKTsKICB9Y2F0Y2goXyl7fQogIGNvbnN0IHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogIHQudGV4dENvbnRlbnQgPSBTdHJpbmcoc3x8JycpOwogIHJldHVybiB0LmlubmVySFRNTDsKfTsKY29uc3QgX19mbXROdW0gPSAodik9PnsKICB0cnl7CiAgICBpZiAodHlwZW9mIHdpbmRvdy5mbXROdW0gPT09ICdmdW5jdGlvbicpIHJldHVybiB3aW5kb3cuZm10TnVtKHYpOwogIH1jYXRjaChfKXt9CiAgY29uc3QgbiA9IE51bWJlcih2KTsKICBpZiAoIWlzRmluaXRlKG4pKSByZXR1cm4gJ+KAlCc7CiAgcmV0dXJuIG4udG9Mb2NhbGVTdHJpbmcodW5kZWZpbmVkLCB7bWF4aW11bUZyYWN0aW9uRGlnaXRzOiAyfSk7Cn07CgoKYXN5bmMgZnVuY3Rpb24gZmV0Y2hBbGVydHNQYWdlKHtsaW1pdD0xMDAsIHN0YXJ0QWZ0ZXI9bnVsbH09e30pewogIGNvbnN0IGVtcHR5ID0ge2l0ZW1zOltdLCBsYXN0RG9jOm51bGx9OwogIHRyeXsKICAgIGNvbnN0IHthdXRoLCBkYn0gPSBhd2FpdCBmYkluaXQoKTsgaWYoIWRiIHx8ICFhdXRoIHx8ICFhdXRoLmN1cnJlbnRVc2VyKSByZXR1cm4gZW1wdHk7CiAgICBjb25zdCB1aWQgPSBhdXRoLmN1cnJlbnRVc2VyLnVpZDsKICAgIGxldCBxQmFzZSA9IGRiLmNvbGxlY3Rpb24oJ2FsZXJ0cycpLndoZXJlKCd1aWQnLCc9PScsIHVpZCk7CiAgICBsZXQgcSA9IHFCYXNlLm9yZGVyQnkoJ2NyZWF0ZWRBdCcsJ2Rlc2MnKTsKICAgIGlmKGxpbWl0KSBxID0gcS5saW1pdChsaW1pdCk7CiAgICBpZihzdGFydEFmdGVyKSBxID0gcS5zdGFydEFmdGVyKHN0YXJ0QWZ0ZXIpOwogICAgdHJ5ewogICAgICBjb25zdCBzbmFwID0gYXdhaXQgcS5nZXQoKTsKICAgICAgY29uc3Qgb3V0ID0gW107IGxldCBsYXN0RG9jID0gbnVsbDsKICAgICAgc25hcC5mb3JFYWNoKGRvYz0+ewogICAgICAgIGNvbnN0IGQgPSBkb2MuZGF0YSgpIHx8IHt9OwogICAgICAgIGNvbnN0IGNyZWF0ZWRBdCA9IChkLmNyZWF0ZWRBdCAmJiBkLmNyZWF0ZWRBdC50b0RhdGUpID8gZC5jcmVhdGVkQXQudG9EYXRlKCkgOiAoZC5jcmVhdGVkQXRDbGllbnQgPyBuZXcgRGF0ZShkLmNyZWF0ZWRBdENsaWVudCkgOiBudWxsKTsKICAgICAgICBvdXQucHVzaCh7CiAgICAgICAgICBpZDogZG9jLmlkLAogICAgICAgICAgdGlja2VyOiAoZC50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpLAogICAgICAgICAgc3RhdGU6IGQuc3RhdGV8fCcnLAogICAgICAgICAga2luZDogZC5raW5kfHwnJywKICAgICAgICAgIHByaWNlOiAoZC5wcmljZSE9bnVsbD8gTnVtYmVyKGQucHJpY2UpOiBudWxsKSwKICAgICAgICAgIHRhcmdldDogKGQudGFyZ2V0IT1udWxsPyBOdW1iZXIoZC50YXJnZXQpOiBudWxsKSwKICAgICAgICAgIHNjb3BlOiBkLnNjb3BlfHwnJywKICAgICAgICAgIHBmSWQ6IGQucGZJZHx8JycsCiAgICAgICAgICBjcmVhdGVkQXQKICAgICAgICB9KTsKICAgICAgICBsYXN0RG9jID0gZG9jOwogICAgICB9KTsKICAgICAgcmV0dXJuIHtpdGVtczogb3V0LCBsYXN0RG9jfTsKICAgIH1jYXRjaChlKXsKICAgICAgY29uc3QgbXNnID0gKGUgJiYgKGUubWVzc2FnZXx8ZS50b1N0cmluZygpKSkgfHwgJyc7CiAgICAgIGlmKG1zZy5pbmNsdWRlcygncmVxdWlyZXMgYW4gaW5kZXgnKSl7CiAgICAgICAgY29uc29sZS5pbmZvKCdBbGVydHM6IGZhbGxpbmcgYmFjayB0byBjbGllbnQtc2lkZSBzb3J0IChubyBjb21wb3NpdGUgaW5kZXggeWV0KS4nKTsKICAgICAgICBsZXQgcTIgPSBxQmFzZTsKICAgICAgICBpZihsaW1pdCkgcTIgPSBxMi5saW1pdChsaW1pdCAqIDUpOwogICAgICAgIGNvbnN0IHNuYXAyID0gYXdhaXQgcTIuZ2V0KCk7CiAgICAgICAgY29uc3QgaXRlbXMgPSBbXTsKICAgICAgICBzbmFwMi5mb3JFYWNoKGRvYz0+ewogICAgICAgICAgY29uc3QgZCA9IGRvYy5kYXRhKCkgfHwge307CiAgICAgICAgICBjb25zdCBjcmVhdGVkQXQgPSAoZC5jcmVhdGVkQXQgJiYgZC5jcmVhdGVkQXQudG9EYXRlKSA/IGQuY3JlYXRlZEF0LnRvRGF0ZSgpIDogKGQuY3JlYXRlZEF0Q2xpZW50ID8gbmV3IERhdGUoZC5jcmVhdGVkQXRDbGllbnQpIDogbnVsbCk7CiAgICAgICAgICBpdGVtcy5wdXNoKHsKICAgICAgICAgICAgaWQ6IGRvYy5pZCwKICAgICAgICAgICAgdGlja2VyOiAoZC50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpLAogICAgICAgICAgICBzdGF0ZTogZC5zdGF0ZXx8JycsCiAgICAgICAgICAgIGtpbmQ6IGQua2luZHx8JycsCiAgICAgICAgICAgIHByaWNlOiAoZC5wcmljZSE9bnVsbD8gTnVtYmVyKGQucHJpY2UpOiBudWxsKSwKICAgICAgICAgICAgdGFyZ2V0OiAoZC50YXJnZXQhPW51bGw/IE51bWJlcihkLnRhcmdldCk6IG51bGwpLAogICAgICAgICAgICBzY29wZTogZC5zY29wZXx8JycsCiAgICAgICAgICAgIHBmSWQ6IGQucGZJZHx8JycsCiAgICAgICAgICAgIGNyZWF0ZWRBdAogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgaXRlbXMuc29ydCgoYSxiKT0+IChiLmNyZWF0ZWRBdD8uZ2V0VGltZSgpfHwwKSAtIChhLmNyZWF0ZWRBdD8uZ2V0VGltZSgpfHwwKSk7CiAgICAgICAgcmV0dXJuIHtpdGVtczogaXRlbXMuc2xpY2UoMCwgbGltaXR8fGl0ZW1zLmxlbmd0aCksIGxhc3REb2M6IG51bGx9OwogICAgICB9ZWxzZXsKICAgICAgICBjb25zb2xlLndhcm4oJ2ZldGNoQWxlcnRzUGFnZSBmYWlsZWQnLCBlKTsKICAgICAgICByZXR1cm4gZW1wdHk7CiAgICAgIH0KICAgIH0KICB9Y2F0Y2goZSl7CiAgICBjb25zb2xlLndhcm4oJ2ZldGNoQWxlcnRzUGFnZSBmYWlsZWQnLCBlKTsKICAgIHJldHVybiBlbXB0eTsKICB9Cn0KCmZ1bmN0aW9uIGZtdERhdGVUaW1lKGR0KXsKICB0cnl7CiAgICBpZighZHQpIHJldHVybiAn4oCUJzsKICAgIGNvbnN0IHBhZCA9IG49PiAobjwxMD8nMCc6JycpK247CiAgICByZXR1cm4gZHQuZ2V0RnVsbFllYXIoKSsnLScrcGFkKGR0LmdldE1vbnRoKCkrMSkrJy0nK3BhZChkdC5nZXREYXRlKCkpKycgJytwYWQoZHQuZ2V0SG91cnMoKSkrJzonK3BhZChkdC5nZXRNaW51dGVzKCkpKyc6JytwYWQoZHQuZ2V0U2Vjb25kcygpKTsKICB9Y2F0Y2goXyl7IHJldHVybiAn4oCUJzsgfQp9Cgphc3luYyBmdW5jdGlvbiByZW5kZXJBbGVydHMoKXsKICBjb25zdCBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1RhYmxlQm9keScpOwogIGNvbnN0IHN0YXRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1N0YXRzJyk7CiAgaWYoIWJvZHkpIHJldHVybjsKICBib2R5LmlubmVySFRNTCA9IGA8dHI+PHRkIGNvbHNwYW49IjciIGNsYXNzPSJtdXRlZCI+xYFhZG93YW5pZeKApjwvdGQ+PC90cj5gOwogIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoQWxlcnRzUGFnZSh7bGltaXQ6MjAwfSk7CiAgbGV0IHJvd3MgPSByZXMuaXRlbXM7CgogIC8vIEZpbHRlcnMKICBjb25zdCBmU2NvcGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzU2NvcGUnKT8udmFsdWUgfHwgJyc7CiAgY29uc3QgZlN0YXRlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1N0YXRlJyk/LnZhbHVlIHx8ICcnOwogIGNvbnN0IGZLaW5kICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbGVydHNLaW5kJyk/LnZhbHVlICB8fCAnJzsKICByb3dzID0gcm93cy5maWx0ZXIocj0+ICghZlNjb3BlIHx8IHIuc2NvcGU9PT1mU2NvcGUpICYmICghZlN0YXRlIHx8IHIuc3RhdGU9PT1mU3RhdGUpICYmICghZktpbmQgfHwgci5raW5kPT09ZktpbmQpKTsKCiAgLy8gU3RhdHMKICBjb25zdCB0b3RhbCA9IHJvd3MubGVuZ3RoOwogIGNvbnN0IGhpdHMgPSByb3dzLmZpbHRlcihyPT4gci5zdGF0ZT09PSdoaXQnKS5sZW5ndGg7CiAgY29uc3QgbmVhcnMgPSByb3dzLmZpbHRlcihyPT4gci5zdGF0ZT09PSduZWFyJykubGVuZ3RoOwogIGlmKHN0YXRzKSBzdGF0cy50ZXh0Q29udGVudCA9IGBXcGlzw7N3OiAke3RvdGFsfSDigJQg8J+OryBoaXQ6ICR7aGl0c30sIOKPsyBuZWFyOiAke25lYXJzfWA7CgogIC8vIFJlbmRlcgogIGlmKCFyb3dzLmxlbmd0aCl7CiAgICBib2R5LmlubmVySFRNTCA9IGA8dHI+PHRkIGNvbHNwYW49IjciIGNsYXNzPSJtdXRlZCI+QnJhayBhbGFybcOzdyBkbyB3ecWbd2lldGxlbmlhLjwvdGQ+PC90cj5gOwogICAgcmV0dXJuOwogIH0KICBib2R5LmlubmVySFRNTCA9IHJvd3MubWFwKHI9PnsKICAgIGNvbnN0IHN0YXRlVHh0ID0gci5zdGF0ZT09PSdoaXQnID8gJ/Cfjq8gY2VsIG9zacSFZ25pxJl0eScgOiAoci5zdGF0ZT09PSduZWFyJyA/ICfij7MgYmxpc2tvIGNlbHUnIDogci5zdGF0ZSk7CiAgICBjb25zdCBraW5kVHh0ID0gci5raW5kID8gci5raW5kLnRvVXBwZXJDYXNlKCkgOiAn4oCUJzsKICAgIGNvbnN0IHNjb3BlVHh0ID0gci5zY29wZT09PSd3aXNobGlzdCcgPyAnV2lzaGxpc3QnIDogKHIuc2NvcGU9PT0ncG9ydGZvbGlvJyA/ICdQb3J0ZmVsJyA6ICfigJQnKTsKICAgIHJldHVybiBgPHRyIGNsYXNzPSIke3Iuc3RhdGU9PT0naGl0Jz8oci5raW5kPT09J3NlbGwnPydoaXQtdGFyZ2V0LXNlbGwnOidoaXQtdGFyZ2V0LWJ1eScpOihyLnN0YXRlPT09J25lYXInPyhyLmtpbmQ9PT0nc2VsbCc/J25lYXItdGFyZ2V0LXNlbGwnOiduZWFyLXRhcmdldC1idXknKTonJyl9Ij4KICAgICAgPHRkPiR7Zm10RGF0ZVRpbWUoci5jcmVhdGVkQXQpfTwvdGQ+CiAgICAgIDx0ZD48YSBocmVmPVwiI1wiIGNsYXNzPVwiYWxlcnQtdGlja2VyXCIgZGF0YS10aWNrZXI9XCIke19fZXNjKHIudGlja2VyfHwnJyl9XCI+JHtfX2VzYyhyLnRpY2tlcnx8JycpfTwvYT48L3RkPgogICAgICA8dGQ+JHtzdGF0ZVR4dH08L3RkPgogICAgICA8dGQ+JHtraW5kVHh0fTwvdGQ+CiAgICAgIDx0ZD4ke3IucHJpY2UhPW51bGw/IF9fZm10TnVtKHIucHJpY2UpIDogJ+KAlCd9PC90ZD4KICAgICAgPHRkPiR7ci50YXJnZXQhPW51bGw/IF9fZm10TnVtKHIudGFyZ2V0KSA6ICfigJQnfTwvdGQ+CiAgICAgIDx0ZD4ke3Njb3BlVHh0fTwvdGQ+CiAgICA8L3RyPmA7CiAgfSkuam9pbignJyk7Cn0KCgooZnVuY3Rpb24gd2lyZUFsZXJ0c1VJKCl7CiAgdHJ5ewogICAgY29uc3QgY2xyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c0NsZWFyQnRuJyk7CiAgICBpZihjbHIpewogICAgICBjbHIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgICAgIHRyeXsKICAgICAgICAgIGNsci5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBjb25zdCBvbGQgPSBjbHIudGV4dENvbnRlbnQ7CiAgICAgICAgICBjbHIudGV4dENvbnRlbnQgPSAnS2FzdWrEmeKApic7CiAgICAgICAgICBhd2FpdCBjbGVhckFsZXJ0c0hpc3RvcnkoKTsKICAgICAgICAgIGNsci50ZXh0Q29udGVudCA9IG9sZDsKICAgICAgICB9ZmluYWxseXsKICAgICAgICAgIGNsci5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfWNhdGNoKF8pe30KCiAgdHJ5ewogICAgZnVuY3Rpb24gX19mYWxsYmFja1NldEFjdGl2ZSh2KXsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubWFpbicpIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21haW4nKTsKICAgICAgICBpZighbWFpbikgcmV0dXJuOwogICAgICAgIGNvbnN0IHBhbmVscyA9IG1haW4ucXVlcnlTZWxlY3RvckFsbCgnOnNjb3BlID4gc2VjdGlvbicpOwogICAgICAgIHBhbmVscy5mb3JFYWNoKHNlYz0+ewogICAgICAgICAgaWYodj09PSd3aXNobGlzdCcpIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSd3aXNobGlzdFBhbmVsJykgPyAnJyA6ICdub25lJzsKICAgICAgICAgIGVsc2UgaWYodj09PSdhbGVydHMnKSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nYWxlcnRzUGFuZWwnKSA/ICcnIDogJ25vbmUnOwogICAgICAgICAgZWxzZSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nd2lzaGxpc3RQYW5lbCcgfHwgc2VjLmlkPT09J2FsZXJ0c1BhbmVsJykgPyAnbm9uZScgOiAnJzsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBidG5XID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpc2hsaXN0VGFiQnRuJyk7CiAgICAgICAgaWYoYnRuVyl7IGJ0blcuY2xhc3NMaXN0LnRvZ2dsZSgnc2Vjb25kYXJ5JywgdiE9PSd3aXNobGlzdCcpOyB9CiAgICAgICAgY29uc3QgYnRuQSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbGVydHNUYWJCdG4nKTsKICAgICAgICBpZihidG5BKXsgYnRuQS5jbGFzc0xpc3QudG9nZ2xlKCdzZWNvbmRhcnknLCB2IT09J2FsZXJ0cycpOyB9CiAgICAgIH1jYXRjaChfKXt9CiAgICB9CiAgICBjb25zdCBuYXZTZXQgPSAod2luZG93LnNldEFjdGl2ZVZpZXcgfHwgX19mYWxsYmFja1NldEFjdGl2ZSk7CgogICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1RhYkJ0bicpOwogICAgaWYoYnRuKXsKICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgbmF2U2V0KCdhbGVydHMnKTsgcmVuZGVyQWxlcnRzKCk7IHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2FsZXJ0c191bnJlYWRfY291bnQnLCcwJyk7IGlmKHR5cGVvZiB1cGRhdGVBbGVydHNCYWRnZT09PSdmdW5jdGlvbicpIHVwZGF0ZUFsZXJ0c0JhZGdlKCk7IH1jYXRjaChfKXt9IH0pOwogICAgfQogICAgY29uc3QgcmVmID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1JlZnJlc2hCdG4nKTsKICAgIGlmKHJlZil7CiAgICAgIHJlZi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT4gcmVuZGVyQWxlcnRzKCkpOwogICAgfQogICAgWydhbGVydHNTY29wZScsJ2FsZXJ0c1N0YXRlJywnYWxlcnRzS2luZCddLmZvckVhY2goaWQ9PnsKICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgIGlmKGVsKSBlbC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKT0+IHJlbmRlckFsZXJ0cygpKTsKICAgIH0pOwogIH1jYXRjaChfKXt9Cn0pKCk7Cjwvc2NyaXB0PgoKPHNjcmlwdD4KdHJ5ewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgZnVuY3Rpb24oZSl7CiAgICB0cnl7CiAgICAgIGlmKGUgJiYgZS5rZXkgPT09ICdhbGVydHNfdW5yZWFkX2NvdW50Jyl7CiAgICAgICAgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlID09PSAnZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOwogICAgICB9CiAgICB9Y2F0Y2goXyl7fQogIH0pOwogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3Zpc2liaWxpdHljaGFuZ2UnLCBmdW5jdGlvbigpewogICAgdHJ5ewogICAgICBpZihkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPT09ICd2aXNpYmxlJyAmJiB0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2UgPT09ICdmdW5jdGlvbicpIHVwZGF0ZUFsZXJ0c0JhZGdlKCk7CiAgICB9Y2F0Y2goXyl7fQogIH0pOwp9Y2F0Y2goXyl7fQo8L3NjcmlwdD4KCgo8c2NyaXB0PgovKiA9PT0gR2xvYmFsIEFsYXJtIFNjYW5uZXIgKHJ1bnMgb24gcHJpY2UgdXBkYXRlcykgPT09ICovCnRyeXsKICB3aW5kb3cuX19sYXN0R2xvYmFsQWxhcm1TY2FuQXQgPSB3aW5kb3cuX19sYXN0R2xvYmFsQWxhcm1TY2FuQXQgfHwgMDsKICBjb25zdCBTQ0FOX01JTl9JTlRFUlZBTF9NUyA9IDEwMDA7IC8vIHRocm90dGxlIHRvIGF2b2lkIGhlYXZ5IGxvb3BzIGVhY2ggdGljawoKICB3aW5kb3cuc2NhbkFsYXJtc0dsb2JhbCA9IGZ1bmN0aW9uKCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgIGlmKChub3cgLSB3aW5kb3cuX19sYXN0R2xvYmFsQWxhcm1TY2FuQXQpIDwgU0NBTl9NSU5fSU5URVJWQUxfTVMpIHJldHVybjsKICAgICAgd2luZG93Ll9fbGFzdEdsb2JhbEFsYXJtU2NhbkF0ID0gbm93OwoKICAgICAgY29uc3QgdG9sID0gKE51bWJlcihEQj8uc2V0dGluZ3M/LmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MSkvMTAwOwoKICAgICAgLy8gLS0tIFBvcnRmb2xpbyBob2xkaW5ncyAtLS0KICAgICAgdHJ5ewogICAgICAgIGNvbnN0IHBmcyA9IEFycmF5LmlzQXJyYXkoREI/LnBvcnRmb2xpb3MpID8gREIucG9ydGZvbGlvcyA6IFtdOwogICAgICAgIGZvcihjb25zdCBwZiBvZiBwZnMpewogICAgICAgICAgY29uc3QgaG9sZGluZ3MgPSBwZj8uaG9sZGluZ3MgfHwge307CiAgICAgICAgICBmb3IoY29uc3QgW3RpY2tlciwgYm9va10gb2YgT2JqZWN0LmVudHJpZXMoaG9sZGluZ3MpKXsKICAgICAgICAgICAgY29uc3QgbG90cyA9IEFycmF5LmlzQXJyYXkoYm9vaz8ubG90cykgPyBib29rLmxvdHMgOiBbXTsKICAgICAgICAgICAgZm9yKGNvbnN0IGxvdCBvZiBsb3RzKXsKICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICBsb3QuX3RpY2tlciA9IHRpY2tlcjsKICAgICAgICAgICAgICAgIGlmKGxvdCAmJiBsb3QubXV0ZWQpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3Qgc3QgPSAodHlwZW9mIHRhcmdldFN0YXR1cz09PSdmdW5jdGlvbicpID8gdGFyZ2V0U3RhdHVzKGxvdCkgOiB7c3RhdGU6J25vbmUnfTsKICAgICAgICAgICAgICAgIGlmKHN0LnN0YXRlPT09J2hpdCcgfHwgc3Quc3RhdGU9PT0nbmVhcicpewogICAgICAgICAgICAgICAgICBjb25zdCBraW5kID0gc3Qua2luZCB8fCAoc3Quc3RhdGU9PT0naGl0JyA/ICdzZWxsJyA6ICdidXknKTsKICAgICAgICAgICAgICAgICAgY29uc3QgcHJpY2UgPSBnZXRRdW90ZSh0aWNrZXIpOwogICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSAoa2luZD09PSdzZWxsJykgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICh0eXBlb2YgY29tcHV0ZVRhcmdldFByaWNlPT09J2Z1bmN0aW9uJyA/IGNvbXB1dGVUYXJnZXRQcmljZShsb3QpIDogbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiBjb21wdXRlQnV5VGFyZ2V0UHJpY2U9PT0nZnVuY3Rpb24nID8gY29tcHV0ZUJ1eVRhcmdldFByaWNlKGxvdCkgOiBudWxsKTsKICAgICAgICAgICAgICAgICAgaWYocHJpY2UhPW51bGwgJiYgdGFyZ2V0IT1udWxsKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBbJ3BmJywgcGY/LmlkIHx8ICdkZWZhdWx0JywgdGlja2VyLCBraW5kXS5qb2luKCd8Jyk7CiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIF9fc2hvdWxkTG9nQWxhcm09PT0nZnVuY3Rpb24nID8gX19zaG91bGRMb2dBbGFybShrZXksIHN0LnN0YXRlKSA6IHRydWUpewogICAgICAgICAgICAgICAgICAgICAgdHJ5eyBpZih3aW5kb3cuc2hvd1RvYXN0KSBzaG93VG9hc3Qoe3RpY2tlciwgc3RhdGU6c3Quc3RhdGUsIGtpbmR9KTsgfWNhdGNoKF8pe30KICAgICAgICAgICAgICAgICAgICAgIHRyeXsgbG9nQWxhcm1FdmVudCh7c2NvcGU6J3BvcnRmb2xpbycsIHBmSWQ6KHBmJiZwZi5pZCl8fCcnLCB0aWNrZXIsIHN0YXRlOnN0LnN0YXRlLCBraW5kLCBwcmljZSwgdGFyZ2V0fSk7IH1jYXRjaChfKXt9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfWNhdGNoKF8pe30KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KCiAgICAgIC8vIC0tLSBXaXNobGlzdCAoYnV5IHRhcmdldHMgb25seSkgLS0tCiAgICAgIHRyeXsKICAgICAgICBjb25zdCB3bCA9IEFycmF5LmlzQXJyYXkoREI/LndhdGNobGlzdCkgPyBEQi53YXRjaGxpc3QgOiBbXTsKICAgICAgICBmb3IoY29uc3QgdyBvZiB3bCl7CiAgICAgICAgICB0cnl7CiAgICAgICAgICAgIGNvbnN0IHQgPSAodz8udGlja2VyfHwnJykudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgY29uc3QgcHJpY2UgPSBnZXRRdW90ZSh0KTsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0cyA9IEFycmF5LmlzQXJyYXkodz8udGFyZ2V0cykgPyAody50YXJnZXRzIHx8IFtdKS5tYXAoTnVtYmVyKS5maWx0ZXIoeD0+eD4wKQogICAgICAgICAgICAgICAgICAgICAgICAgICA6ICgoTnVtYmVyKHc/LnByaWNlKXx8MCkgPyBbTnVtYmVyKHcucHJpY2UpXSA6IFtdKTsKICAgICAgICAgICAgY29uc3QgYWkgPSBNYXRoLm1pbihNYXRoLm1heChOdW1iZXIodz8uYWN0aXZlSW5kZXgpfHwwLCAwKSwgTWF0aC5tYXgodGFyZ2V0cy5sZW5ndGgtMSwwKSk7CiAgICAgICAgICAgIGNvbnN0IGRlc2lyZWQgPSB0YXJnZXRzLmxlbmd0aCA/IE51bWJlcih0YXJnZXRzW2FpXSl8fDAgOiAwOwogICAgICAgICAgICBpZihwcmljZSE9bnVsbCAmJiBkZXNpcmVkPjApewogICAgICAgICAgICAgIGxldCBzdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgaWYocHJpY2UgPD0gZGVzaXJlZCl7IHN0YXRlID0gJ2hpdCc7IH0KICAgICAgICAgICAgICBlbHNlIGlmKHByaWNlIDw9IGRlc2lyZWQqKDErdG9sKSl7IHN0YXRlID0gJ25lYXInOyB9CiAgICAgICAgICAgICAgaWYoc3RhdGUpewogICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gWyd3bCcsIHc/LmlkIHx8IHQsICdidXknXS5qb2luKCd8Jyk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgX19zaG91bGRMb2dBbGFybT09PSdmdW5jdGlvbicgPyBfX3Nob3VsZExvZ0FsYXJtKGtleSwgc3RhdGUpIDogdHJ1ZSl7CiAgICAgICAgICAgICAgICAgIHRyeXsgaWYod2luZG93LnNob3dUb2FzdCkgc2hvd1RvYXN0KHt0aWNrZXI6dCwgc3RhdGUsIGtpbmQ6J2J1eSd9KTsgfWNhdGNoKF8pe30KICAgICAgICAgICAgICAgICAgdHJ5eyBsb2dBbGFybUV2ZW50KHtzY29wZTond2lzaGxpc3QnLCB0aWNrZXI6dCwgc3RhdGUsIGtpbmQ6J2J1eScsIHByaWNlLCB0YXJnZXQ6ZGVzaXJlZH0pOyB9Y2F0Y2goXyl7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfWNhdGNoKF8pe30KICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CiAgICB9Y2F0Y2goXyl7fQogIH07CgogIC8vIEhlbHBlciB0aGF0IGNhbiBiZSBjYWxsZWQgZnJvbSBzZXRRdW90ZQogIHdpbmRvdy5tYXliZVNjYW5BbGFybXNHbG9iYWwgPSBmdW5jdGlvbigpewogICAgdHJ5eyB3aW5kb3cuc2NhbkFsYXJtc0dsb2JhbCAmJiB3aW5kb3cuc2NhbkFsYXJtc0dsb2JhbCgpOyB9Y2F0Y2goXyl7fQogIH07Cn1jYXRjaChfKXt9Cjwvc2NyaXB0PgoKCjxzY3JpcHQ+Ci8vID09PSBDbGVhciBBbGVydHMgSGlzdG9yeSA9PT0KYXN5bmMgZnVuY3Rpb24gY2xlYXJBbGVydHNIaXN0b3J5KCl7CiAgdHJ5ewogICAgY29uc3QgZ28gPSAodHlwZW9mIHdpbmRvdy5jb25maXJtPT09J2Z1bmN0aW9uJykgPyB3aW5kb3cuY29uZmlybSgnU2thc293YcSHIGhpc3RvcmnEmSBhbGFybcOzdz8gT3BlcmFjasSZIG1vxbxuYSBjb2ZuxIXEhyBwcnpleiAyIGRuaSAo4oap77iPIENvZm5paikuLicpIDogdHJ1ZTsKICAgIGlmKCFnbykgcmV0dXJuOwogICAgY29uc3QgY3R4ID0gYXdhaXQgZmJJbml0KCk7CiAgICBjb25zdCB7YXV0aCwgZGJ9ID0gY3R4IHx8IHt9OwogICAgaWYoIWRiIHx8ICFhdXRoIHx8ICFhdXRoLmN1cnJlbnRVc2VyKXsgdGhyb3cgbmV3IEVycm9yKCduby1hdXRoJyk7IH0KICAgIGNvbnN0IHVpZCA9IGF1dGguY3VycmVudFVzZXIudWlkOwogICAgY29uc3QgcSA9IGRiLmNvbGxlY3Rpb24oJ2FsZXJ0cycpLndoZXJlKCd1aWQnLCc9PScsIHVpZCk7CiAgICBjb25zdCBzbmFwID0gYXdhaXQgcS5nZXQoKTsKICAgIGlmKHNuYXAgJiYgIXNuYXAuZW1wdHkpewogICAgICBsZXQgYmF0Y2ggPSBkYi5iYXRjaCgpOwogICAgICBsZXQgaSA9IDAsIGNvbW1pdHMgPSBbXTsKICAgICAgc25hcC5mb3JFYWNoKGRvYz0+ewogICAgICAgIGJhdGNoLmRlbGV0ZShkb2MucmVmKTsKICAgICAgICBpKys7CiAgICAgICAgaWYoaSAlIDQwMCA9PT0gMCl7CiAgICAgICAgICBjb21taXRzLnB1c2goYmF0Y2guY29tbWl0KCkpOwogICAgICAgICAgYmF0Y2ggPSBkYi5iYXRjaCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGNvbW1pdHMucHVzaChiYXRjaC5jb21taXQoKSk7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGNvbW1pdHMpOwogICAgfQogICAgLy8gc3VjY2VzcyBwYXRoCiAgICB0cnl7IHdpbmRvdy5fX2xhc3RMb2dnZWRBbGVydHMgPSB7fTsgfWNhdGNoKF8pe30KICAgIHRyeXsgY29uc3Qgaz0nYWxlcnRzX3VucmVhZF9jb3VudCc7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKGssJzAnKTsgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsgfWNhdGNoKF8pe30KICAgIC8vIFJlZnJlc2ggbGlzdAogICAgcmV0dXJuIHJlbmRlckFsZXJ0cygpOwogIH1jYXRjaChlKXsKICAgIC8vIEZhbGxiYWNrOiBsb2NhbCBjbGVhciAoaGlkZSBhbGwgYWxlcnRzIGxvY2FsbHkpCiAgICB0cnl7CiAgICAgIGNvbnN0IHRzID0gRGF0ZS5ub3coKTsKICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2FsZXJ0c19oaWRkZW5fYWxsX3VudGlsJywgU3RyaW5nKHRzKSk7CiAgICAgIHdpbmRvdy5fX2xhc3RMb2dnZWRBbGVydHMgPSB7fTsKICAgICAgY29uc3Qgaz0nYWxlcnRzX3VucmVhZF9jb3VudCc7CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGssJzAnKTsKICAgICAgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsKICAgICAgaWYodHlwZW9mIHJlbmRlckFsZXJ0cz09PSdmdW5jdGlvbicpIHJlbmRlckFsZXJ0cygpOwogICAgICBjb25zb2xlLndhcm4oJ2NsZWFyQWxlcnRzSGlzdG9yeTogdXNpbmcgbG9jYWwgZmFsbGJhY2sgZHVlIHRvJywgZSAmJiAoZS5jb2RlIHx8IGUubWVzc2FnZSB8fCBlLnRvU3RyaW5nKCkpKTsKICAgICAgYWxlcnQoJ0JyYWsgdXByYXduaWXFhCBkbyBrYXNvd2FuaWEgdyBGaXJlc3RvcmUg4oCUIHd5Y3p5c3pjem9ubyBsb2thbG5pZSAod2lkb2spLicpOwogICAgICByZXR1cm47CiAgICB9Y2F0Y2goXyl7fQogIH0KfQo8L3NjcmlwdD4KCgo8IS0tIEFMTE9XX1JVTEVTX0FMRVJUU19TTklQUEVUClN1Z2dlc3RlZCBGaXJlc3RvcmUgcnVsZXMgZm9yIGFsZXJ0cyBjb2xsZWN0aW9uIChyZXBsYWNlIHdpdGggeW91ciBzZXR1cCk6CnJ1bGVzX3ZlcnNpb24gPSAnMic7CnNlcnZpY2UgY2xvdWQuZmlyZXN0b3JlIHsKICBtYXRjaCAvZGF0YWJhc2VzL3tkYXRhYmFzZX0vZG9jdW1lbnRzIHsKICAgIG1hdGNoIC9hbGVydHMve2FsZXJ0SWR9IHsKICAgICAgYWxsb3cgcmVhZDogaWYgcmVxdWVzdC5hdXRoICE9IG51bGwgJiYgcmVzb3VyY2UuZGF0YS51aWQgPT0gcmVxdWVzdC5hdXRoLnVpZDsKICAgICAgYWxsb3cgY3JlYXRlOiBpZiByZXF1ZXN0LmF1dGggIT0gbnVsbCAmJiByZXF1ZXN0LnJlc291cmNlLmRhdGEudWlkID09IHJlcXVlc3QuYXV0aC51aWQ7CiAgICAgIGFsbG93IHVwZGF0ZSwgZGVsZXRlOiBpZiByZXF1ZXN0LmF1dGggIT0gbnVsbCAmJiByZXNvdXJjZS5kYXRhLnVpZCA9PSByZXF1ZXN0LmF1dGgudWlkOwogICAgfQogIH0KfQotLT4KCgo8IS0tID09PSBbR1QgQURET05dIEdsb2JhbCBPdmVydmlldyBUYWIgKE9zb2JuYSBaYWvFgmFka2EpID09PSAtLT4KPHN0eWxlPgogIC8qIE5hbWVzcGFjZWQgc3R5bGVzIHRvIGF2b2lkIGNvbGxpc2lvbnMgKi8KICAjZ28tdGFiLW92ZXJsYXlbaGlkZGVuXXsgZGlzcGxheTpub25lICFpbXBvcnRhbnQgfQogICNnby10YWItb3ZlcmxheXsKICAgIHBvc2l0aW9uOmZpeGVkOyBpbnNldDowOyB6LWluZGV4Ojk5OTk7CiAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoMTIwMHB4IDYwMHB4IGF0IDEwJSAtMTAlLCByZ2JhKDM0LDIxMSwyMzgsLjA2KSwgdHJhbnNwYXJlbnQgNDAlKSwKICAgICAgICAgICAgICAgIHJhZGlhbC1ncmFkaWVudCgxMjAwcHggNjAwcHggYXQgMTEwJSAxMTAlLCByZ2JhKDE2LDE4NSwxMjksLjA2KSwgdHJhbnNwYXJlbnQgNDAlKSwKICAgICAgICAgICAgICAgIGxpbmVhci1ncmFkaWVudCgxMjBkZWcsIzBiMTIyMiAwJSwjMGYxNzJhIDQwJSwgIzEwMTUyNSAxMDAlKTsKICAgIGNvbG9yOiNlNWU3ZWI7IGZvbnQtZmFtaWx5OiB1aS1zYW5zLXNlcmlmLCBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEludGVyLCBOb3RvIFNhbnMsIFVidW50dSwgQ2FudGFyZWxsLCBBcmlhbDsKICB9CiAgI2dvLXRhYi1oZWFkZXJ7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEwcHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogICAgcGFkZGluZzoxMnB4IDE0cHg7IGJvcmRlci1ib3R0b206MXB4IHNvbGlkICMxZjI5Mzc7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMGRlZywgcmdiYSgxNSwyMyw0MiwuNzUpLCByZ2JhKDE1LDIzLDQyLC43NSkpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDhweCk7CiAgfQogICNnby10YWItbWFpbnsgcGFkZGluZzoxNHB4OyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjsgZ2FwOjE0cHg7IGhlaWdodDogY2FsYygxMDAlIC0gNjBweCk7IG92ZXJmbG93OmF1dG8gfQogICNnby1mYWJ7CiAgICBwb3NpdGlvbjpmaXhlZDsgcmlnaHQ6MTZweDsgYm90dG9tOjE2cHg7IHotaW5kZXg6OTk5ODsKICAgIGJvcmRlcjpub25lOyBib3JkZXItcmFkaXVzOjE0cHg7IHBhZGRpbmc6MTJweCAxNHB4OyBjdXJzb3I6cG9pbnRlcjsgZm9udC13ZWlnaHQ6ODAwOwogICAgYmFja2dyb3VuZDp2YXIoLS1vayk7IGNvbG9yOiMwMDEwMTg7IGJveC1zaGFkb3c6MCAxMnB4IDI1cHggcmdiYSgxNiwxODUsMTI5LC4zNSk7CiAgfQogICNnby1mYWI6aG92ZXJ7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMXB4KTsgZmlsdGVyOiBicmlnaHRuZXNzKDEuMDUpIH0KICAjZ28tY2xvc2V7IGJvcmRlcjpub25lOyBib3JkZXItcmFkaXVzOjEwcHg7IHBhZGRpbmc6OHB4IDEwcHg7IGN1cnNvcjpwb2ludGVyOyBmb250LXdlaWdodDo4MDA7IGJhY2tncm91bmQ6IzMzNDE1NTsgY29sb3I6I2U1ZTdlYiB9CiAgI2dvLWNsb3NlOmhvdmVyeyBmaWx0ZXI6YnJpZ2h0bmVzcygxLjEpIH0KICAvKiBDYXJkcywgdGFibGVzLCBldGMuIChzY29wZWQpICovCiAgI2dvLXRhYi1vdmVybGF5IC5nby1jYXJkeyBiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMTcsMjQsMzksLjkyKSwgcmdiYSgxNiwyMyw0MiwuOTgpKTsgYm9yZGVyOjFweCBzb2xpZCAjMWYyOTM3OyBib3JkZXItcmFkaXVzOjE2cHggfQogICNnby10YWItb3ZlcmxheSAuZ28tcGFuZWx7IHBhZGRpbmc6MTRweCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1ncmlkeyBkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDEyLCAxZnIpOyBnYXA6MTRweCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1jb2wtM3sgZ3JpZC1jb2x1bW46IHNwYW4gMyB9IC5nby1jb2wtNHsgZ3JpZC1jb2x1bW46IHNwYW4gNCB9IC5nby1jb2wtNnsgZ3JpZC1jb2x1bW46IHNwYW4gNiB9IC5nby1jb2wtOHsgZ3JpZC1jb2x1bW46IHNwYW4gOCB9IC5nby1jb2wtMTJ7IGdyaWQtY29sdW1uOiBzcGFuIDEyIH0KICBAbWVkaWEgKG1heC13aWR0aDogOTgwcHgpeyAjZ28tdGFiLW92ZXJsYXkgLmdvLWNvbC0zLCAjZ28tdGFiLW92ZXJsYXkgLmdvLWNvbC00LCAjZ28tdGFiLW92ZXJsYXkgLmdvLWNvbC02LCAjZ28tdGFiLW92ZXJsYXkgLmdvLWNvbC04eyBncmlkLWNvbHVtbjogc3BhbiAxMiB9IH0KICAjZ28tdGFiLW92ZXJsYXkgdGFibGV7IHdpZHRoOjEwMCU7IGJvcmRlci1jb2xsYXBzZTpjb2xsYXBzZSB9CiAgI2dvLXRhYi1vdmVybGF5IHRoLCAjZ28tdGFiLW92ZXJsYXkgdGR7IHBhZGRpbmc6MTBweDsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzFmMjkzNzsgdGV4dC1hbGlnbjpsZWZ0OyB2ZXJ0aWNhbC1hbGlnbjogdG9wIH0KICAjZ28tdGFiLW92ZXJsYXkgdGh7IGNvbG9yOiNjYmQ1ZTE7IGJhY2tncm91bmQ6IzBiMTIyMjsgcG9zaXRpb246c3RpY2t5OyB0b3A6MCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby10aWNrZXJ7IGZvbnQtZmFtaWx5OiB1aS1tb25vc3BhY2UsIE1lbmxvLCBDb25zb2xhcywgIkNvdXJpZXIgTmV3IiwgbW9ub3NwYWNlOyBsZXR0ZXItc3BhY2luZzouM3B4OyBmb250LXdlaWdodDo3MDAgfQogICNnby10YWItb3ZlcmxheSBpbnB1dCwgI2dvLXRhYi1vdmVybGF5IHNlbGVjdHsKICAgIHdpZHRoOjEwMCU7IHBhZGRpbmc6MTBweCAxMnB4OyBib3JkZXItcmFkaXVzOjEycHg7IGJvcmRlcjoxcHggc29saWQgIzMzNDE1NTsKICAgIGJhY2tncm91bmQ6IzBiMTIyMjsgY29sb3I6I2U1ZTdlYjsgb3V0bGluZTpub25lOyBmb250LXNpemU6MTRweAogIH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLWNoaXB7IGRpc3BsYXk6aW5saW5lLWZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjZweDsgcGFkZGluZzo2cHggMTBweDsgYm9yZGVyLXJhZGl1czo5OTlweDsgYmFja2dyb3VuZDojMGIxMjIyOyBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7IGZvbnQtd2VpZ2h0OjcwMCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby10YWd7IHBhZGRpbmc6M3B4IDhweDsgYm9yZGVyLXJhZGl1czo5OTlweDsgYm9yZGVyOjFweCBzb2xpZCAjMzM0MTU1OyBjb2xvcjojY2JkNWUxOyBmb250LXNpemU6MTJweDsgYmFja2dyb3VuZDojMGMxNDI2IH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLXN0YXR7IGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6ZmxleC1zdGFydDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47IGdhcDo4cHg7IHBhZGRpbmc6MTJweDsgYm9yZGVyLXJhZGl1czoxNHB4OyBiYWNrZ3JvdW5kOiMwYjEyMjI7IGJvcmRlcjoxcHggc29saWQgIzFmMjkzNyB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1iaWd7IGZvbnQtc2l6ZToyMnB4OyBmb250LXdlaWdodDo5MDAgfQogICNnby10YWItb3ZlcmxheSAuZ28tbXV0ZWR7IGNvbG9yOiM5NGEzYjggfQogICNnby10YWItb3ZlcmxheSAuZ28tYmFkZ2V7IGZvbnQtd2VpZ2h0OjgwMDsgcGFkZGluZzoycHggNnB4OyBib3JkZXItcmFkaXVzOjhweDsgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwuMDQpOyBkaXNwbGF5OmlubGluZS1ibG9jazsgbWluLXdpZHRoOjYycHg7IHRleHQtYWxpZ246cmlnaHQgfQogICNnby10YWItb3ZlcmxheSAuZ28tcG9zeyBjb2xvcjojMTBiOTgxIH0gLmdvLW5lZ3sgY29sb3I6I2VmNDQ0NCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1taW5peyBmb250LXNpemU6MTJweCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1zd2l0Y2h7IGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6OHB4IH0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KPHN0eWxlPgogIC8qIERldGFpbHMgcm93IGluIFBvc2l0aW9ucyAoYWdncmVnYXRpb24pICovCiAgI2dvLXRhYi1vdmVybGF5IC5nby1kZXRhaWwtcm93IHRkIHsgcGFkZGluZzogMDsgfQogICNnby10YWItb3ZlcmxheSAuZ28tZGV0YWlsLXJvdyAudGFibGUtd3JhcCB7IG1hcmdpbjogNnB4IDA7IH0KCgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+Cgo8YnV0dG9uIGlkPSJnby1mYWIiIHRpdGxlPSJHbG9iYWxueSBQcnplZ2zEhWQg4oCTIG9zb2JuYSB6YWvFgmFka2EiPvCfk4ggUHJ6ZWdsxIVkPC9idXR0b24+Cgo8c2VjdGlvbiBpZD0iZ28tdGFiLW92ZXJsYXkiIGhpZGRlbj4KICA8ZGl2IGlkPSJnby10YWItaGVhZGVyIj4KICAgIDxoMyBzdHlsZT0ibWFyZ2luOjA7Zm9udC1zaXplOjE4cHgiPvCfk4ggR2xvYmFsbnkgUHJ6ZWdsxIVkIE1hasSFdGt1IDwvaDM+CiAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXIiPgoKCiAgICAgIDxzcGFuIGNsYXNzPSJnby1zd2l0Y2ggZ28tbWluaSI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iZ28tbm8tYXBpIj4gPGxhYmVsIGZvcj0iZ28tbm8tYXBpIj5CZXogQVBJICh0eWxrbyBpc3RuaWVqxIVjZSBjZW55KTwvbGFiZWw+PC9zcGFuPgogICAgICA8YnV0dG9uIGlkPSJnby1yZWZyZXNoIiB0aXRsZT0iT2TFm3dpZcW8Ij7wn5SEPC9idXR0b24+CiAgICAgIDxidXR0b24gaWQ9ImdvLWV4cG9ydC1jc3YiIHRpdGxlPSJFa3Nwb3J0IENTViI+4qyH77iPIENTVjwvYnV0dG9uPgogICAgICA8YnV0dG9uIGlkPSJnby1leHBvcnQtanNvbiIgdGl0bGU9IkVrc3BvcnQgSlNPTiI+4qyH77iPIEpTT048L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBpZD0iZ28tY2xvc2UiPuKcliBaYW1rbmlqPC9idXR0b24+CiAgICA8L2Rpdj4KICA8L2Rpdj4KCgogIDxkaXYgaWQ9ImdvLXRhYi1tYWluIj4KICAgIDxzZWN0aW9uIGNsYXNzPSJnby1jYXJkIGdvLXBhbmVsIj4KICAgICAgPGRpdiBjbGFzcz0iZ28tZ3JpZCIgc3R5bGU9ImFsaWduLWl0ZW1zOmVuZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY29sLTQiPgogICAgICAgICAgPGxhYmVsPldhbHV0YSBiYXpvd2E8L2xhYmVsPgogICAgICAgICAgPHNlbGVjdCBpZD0iZ28tYmFzZSI+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IlBMTiI+UExOPC9vcHRpb24+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IlVTRCI+VVNEPC9vcHRpb24+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkVVUiI+RVVSPC9vcHRpb24+CiAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDxkaXYgY2xhc3M9ImdvLW11dGVkIGdvLW1pbmkiPlN1bXkgcHJ6ZWxpY3phbmUgYmllxbzEhWN5bSBGWC48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtNCI+CiAgICAgICAgICA8bGFiZWw+VG9rZW4gRmlubmh1YjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgaWQ9ImdvLXRva2VuIiBwbGFjZWhvbGRlcj0ibnAuIGQwYi4uLiIgLz4KICAgICAgICAgIDxkaXYgY2xhc3M9ImdvLW11dGVkIGdvLW1pbmkiPkplxZtsaSBwdXN0ZSDigJQgc3Byw7NidWrEmSB6IFVzdGF3aWXFhC48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtNCI+CiAgICAgICAgICA8bGFiZWw+T2TFm3dpZcW8YW5pZSAoc2VrLik8L2xhYmVsPgogICAgICAgICAgPGlucHV0IGlkPSJnby1wb2xsIiB0eXBlPSJudW1iZXIiIG1pbj0iNSIgc3RlcD0iMSIgdmFsdWU9IjQ1IiAvPgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2dhcDo4cHg7YWxpZ24taXRlbXM6Y2VudGVyO21hcmdpbi10b3A6OHB4Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn5KxIEZYOiA8c3BhbiBpZD0iZ28tZngiIHN0eWxlPSJmb250LWZhbWlseTp1aS1tb25vc3BhY2UiPuKAlDwvc3Bhbj48L2Rpdj4KPGRpdiBjbGFzcz0iZ28tY2hpcCI+4pyP77iPIFVTROKGklBMTjogPGlucHV0IGlkPSJnby1meC11c2RwbG4iIHR5cGU9Im51bWJlciIgbWluPSIwIiBzdGVwPSIwLjAwMDEiIHN0eWxlPSJ3aWR0aDoxMTBweCI+IDxidXR0b24gaWQ9ImdvLWZ4LWFwcGx5IiBjbGFzcz0iZ28tbWluaSIgdGl0bGU9IlVzdGF3IGt1cnMgcsSZY3puaWUiPlVzdGF3PC9idXR0b24+IDxidXR0b24gaWQ9ImdvLWZ4LWNsZWFyIiBjbGFzcz0iZ28tbWluaSIgdGl0bGU9Ild5Y3p5xZvEhyByxJljem55IGt1cnMiPld5Y3p5xZvEhzwvYnV0dG9uPjwvZGl2Pgo8c2NyaXB0IGlkPSJnby1meC1zdG9yYWdlIj4KKGZ1bmN0aW9uKCl7CiAgY29uc3QgS0VZID0gJ2d0X2Z4X3VzZF9wbG4nOwogIGZ1bmN0aW9uIHRvTnVtKHYpewogICAgaWYgKHY9PT11bmRlZmluZWQgfHwgdj09PW51bGwpIHJldHVybiBOYU47CiAgICBjb25zdCBzID0gU3RyaW5nKHYpLnJlcGxhY2UoJywnLCAnLicpLnRyaW0oKTsKICAgIHJldHVybiBOdW1iZXIocyk7CiAgfQogIGZ1bmN0aW9uIHJlYWRTYXZlZCgpewogICAgdHJ5ewogICAgICBjb25zdCB2ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKTsKICAgICAgY29uc3QgbiA9IHRvTnVtKHYpOwogICAgICByZXR1cm4gKE51bWJlci5pc0Zpbml0ZShuKSAmJiBuPjApID8gbiA6IG51bGw7CiAgICB9Y2F0Y2goXyl7IHJldHVybiBudWxsOyB9CiAgfQogIGZ1bmN0aW9uIHNhdmUodmFsKXsKICAgIHRyeXsKICAgICAgY29uc3QgbiA9IHRvTnVtKHZhbCk7CiAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKG4pIHx8IG48PTApeyBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShLRVkpOyByZXR1cm4gbnVsbDsgfQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLRVksIFN0cmluZyhuKSk7CiAgICAgIHJldHVybiBuOwogICAgfWNhdGNoKF8peyByZXR1cm4gbnVsbDsgfQogIH0KICBmdW5jdGlvbiBjbGVhclNhdmVkKCl7CiAgICB0cnl7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKEtFWSk7IH1jYXRjaChfKXt9CiAgfQoKICBmdW5jdGlvbiBiaW5kKCl7CiAgICBjb25zdCByb290ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLXRhYi1vdmVybGF5Jyk7CiAgICBpZighcm9vdCkgcmV0dXJuOwogICAgY29uc3QgaW5wdXQgPSByb290LnF1ZXJ5U2VsZWN0b3IoJyNnby1meC11c2RwbG4nKTsKICAgIGNvbnN0IGJ0bkFwcGx5ID0gcm9vdC5xdWVyeVNlbGVjdG9yKCcjZ28tZngtYXBwbHknKTsKICAgIGNvbnN0IGJ0bkNsZWFyID0gcm9vdC5xdWVyeVNlbGVjdG9yKCcjZ28tZngtY2xlYXInKTsKICAgIGlmKCFpbnB1dCkgcmV0dXJuOwoKICAgIGNvbnN0IHNhdmVkID0gcmVhZFNhdmVkKCk7CiAgICBpZihzYXZlZCl7IGlucHV0LnZhbHVlID0gc2F2ZWQ7IH0KCiAgICBpZihidG5BcHBseSl7CiAgICAgIGJ0bkFwcGx5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKXsgc2F2ZShpbnB1dC52YWx1ZSk7IH0sIHtwYXNzaXZlOnRydWV9KTsKICAgIH0KICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBmdW5jdGlvbihldil7CiAgICAgIGlmKGV2LmtleT09PSdFbnRlcicpewogICAgICAgIHNhdmUoaW5wdXQudmFsdWUpOwogICAgICAgIGlmKGJ0bkFwcGx5KXsgdHJ5eyBidG5BcHBseS5jbGljaygpOyB9Y2F0Y2goXyl7IH0gfQogICAgICB9CiAgICB9KTsKICAgIGlmKGJ0bkNsZWFyKXsKICAgICAgYnRuQ2xlYXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpeyBjbGVhclNhdmVkKCk7IH0sIHtwYXNzaXZlOnRydWV9KTsKICAgIH0KICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCBmdW5jdGlvbigpeyBzYXZlKGlucHV0LnZhbHVlKTsgfSk7CiAgfQoKICBpZihkb2N1bWVudC5yZWFkeVN0YXRlPT09J2xvYWRpbmcnKXsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBiaW5kKTsKICB9ZWxzZXsKICAgIGJpbmQoKTsKICB9Cn0pKCk7Cjwvc2NyaXB0PgoKICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn6e+IMW5csOzZMWCYTogRmlubmh1YiBRdW90ZSwgRnJhbmtmdXJ0ZXIgKEVDQikgLyBleGNoYW5nZXJhdGUuaG9zdDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNoaXAiPvCfp4ogQ2FjaGUgVFRMOiA8c3BhbiBpZD0iZ28tdHRsIiBjbGFzcz0iZ28tbWluaSI+NjBzPC9zcGFuPjwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZsZXg6MSI+PC9kaXY+CiAgICAgICAgPGJ1dHRvbiBpZD0iZ28tc2F2ZSIgc3R5bGU9ImJvcmRlcjpub25lO2JvcmRlci1yYWRpdXM6MTJweDtwYWRkaW5nOjEwcHggMTRweDtmb250LXdlaWdodDo4MDA7YmFja2dyb3VuZDojMjJkM2VlO2NvbG9yOiMwMDEwMTgiPvCfkr4gWmFwaXN6PC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgPC9zZWN0aW9uPgoKICAgIDxzZWN0aW9uIGNsYXNzPSJnby1jYXJkIGdvLXBhbmVsIj4KICAgICAgPGg0IHN0eWxlPSJtYXJnaW46MCAwIDhweCAwIj7wn5SOIFN6eWJraWUgc3RhdHlzdHlraSAod2FsdXRhIGJhem93YSk8L2g0PgogICAgICA8ZGl2IGNsYXNzPSJnby1ncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtMyI+PGRpdiBjbGFzcz0iZ28tc3RhdCI+PGRpdj48ZGl2IGNsYXNzPSJnby1tdXRlZCI+V2FydG/Fm8SHIGFrY2ppPC9kaXY+PGRpdiBpZD0iZ28tdG90LWhvbGQiIGNsYXNzPSJnby1iaWciPuKAlDwvZGl2PjwvZGl2PjxzcGFuIGNsYXNzPSJnby10YWciPmxpdmU8L3NwYW4+PC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY29sLTMiPjxkaXYgY2xhc3M9ImdvLXN0YXQiPjxkaXY+PGRpdiBjbGFzcz0iZ28tbXV0ZWQiPkdvdMOzd2thPC9kaXY+PGRpdiBpZD0iZ28tdG90LWNhc2giIGNsYXNzPSJnby1iaWciPuKAlDwvZGl2PjwvZGl2PjxzcGFuIGNsYXNzPSJnby10YWciPnN1bWE8L3NwYW4+PC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY29sLTMiPjxkaXYgY2xhc3M9ImdvLXN0YXQiPjxkaXY+PGRpdiBjbGFzcz0iZ28tbXV0ZWQiPlN1bWEgbWFqxIV0a3U8L2Rpdj48ZGl2IGlkPSJnby10b3QtZXEiIGNsYXNzPSJnby1iaWciPuKAlDwvZGl2PjwvZGl2PjxzcGFuIGNsYXNzPSJnby10YWciPmFrY2plK2Nhc2g8L3NwYW4+PC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY29sLTMiPjxkaXYgY2xhc3M9ImdvLXN0YXQiPjxkaXY+PGRpdiBjbGFzcz0iZ28tbXV0ZWQiPk5pZXpyZWFsLiBQL0w8L2Rpdj48ZGl2IGNsYXNzPSJnby1iaWciPjxzcGFuIGlkPSJnby10b3QtdW5yIj7igJQ8L3NwYW4+IDxzcGFuIGlkPSJnby10b3QtdW5yLXBjdCIgY2xhc3M9ImdvLWJhZGdlIj7igJQ8L3NwYW4+PC9kaXY+PGRpdiBjbGFzcz0iZ28tbXV0ZWQgZ28tbWluaSI+dnMga29zenQgd8WCYXNueTwvZGl2PjwvZGl2PjxzcGFuIGlkPSJnby1kYXkiIGNsYXNzPSJnby10YWciPs6UIGR6aWVubnk6IOKAlDwvc3Bhbj48L2Rpdj48L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4O2FsaWduLWl0ZW1zOmNlbnRlcjtmbGV4LXdyYXA6d3JhcDttYXJnaW4tdG9wOjZweCI+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY2hpcCI+8J+SsCBacmVhbC4gUC9MIChicnV0dG8pOiA8c3BhbiBpZD0iZ28tcmVhbC1nIiBzdHlsZT0iZm9udC1mYW1pbHk6dWktbW9ub3NwYWNlIj7igJQ8L3NwYW4+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY2hpcCI+8J+nviBQb2RhdGVrOiA8c3BhbiBpZD0iZ28tcmVhbC10YXgiIHN0eWxlPSJmb250LWZhbWlseTp1aS1tb25vc3BhY2UiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn4+BIFpyZWFsLiBQL0wgKG5ldHRvKTogPHNwYW4gaWQ9ImdvLXJlYWwtbiIgc3R5bGU9ImZvbnQtZmFtaWx5OnVpLW1vbm9zcGFjZSI+4oCUPC9zcGFuPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNoaXAiPuKPse+4jyDFmnIuIGN6YXMgKHphbWtuacSZdGUpOiA8c3BhbiBpZD0iZ28tYXZnLWhvbGQiIHN0eWxlPSJmb250LWZhbWlseTp1aS1tb25vc3BhY2UiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn5OIIMWaci4genlzayAlIC8gcG96eWNqxJkgKGJydXR0byk6IDxzcGFuIGlkPSJnby1hdmctcGN0IiBzdHlsZT0iZm9udC1mYW1pbHk6dWktbW9ub3NwYWNlIj7igJQ8L3NwYW4+PC9kaXY+CgogICAgCiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY2hpcCI+8J+OryBUUDogPHNwYW4gaWQ9ImdvLXRwLWNvdW50Ij7igJQ8L3NwYW4+PC9kaXY+PGRpdiBjbGFzcz0iZ28tY2hpcCI+PGxhYmVsIGZvcj0iZ28tcGVyaW9kIiBjbGFzcz0iZ28tY2hpcC1sYWJlbCI+8J+ThSBPa3JlczwvbGFiZWw+IDxzZWxlY3QgaWQ9ImdvLXBlcmlvZCIgc3R5bGU9IndpZHRoOmF1dG8iPjxvcHRpb24gdmFsdWU9ImRheSI+RHppZcWEPC9vcHRpb24+PG9wdGlvbiB2YWx1ZT0id2VlayI+VHlkemllxYQ8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJtb250aCI+TWllc2nEhWM8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJ5dGQiPlRlbiByb2s8L29wdGlvbj48b3B0aW9uIHZhbHVlPSIxeSI+Um9rPC9vcHRpb24+PG9wdGlvbiB2YWx1ZT0iMnkiPjIgbGF0YTwvb3B0aW9uPjxvcHRpb24gdmFsdWU9IjN5Ij4zIGxhdGE8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJhbGwiPkNhxYJ5IG9rcmVzPC9vcHRpb24+PC9zZWxlY3Q+PC9kaXY+CiAgICAgICAgCjwvc2VjdGlvbj4KCjwhLS0g8J+nrSBbR09dIFdrxYJhZCB2cyBXYXJ0b8WbxIcg4oCUIHd5a3JlcyBsaW5pb3d5IC0tPgo8c3R5bGU+CiAgLyogTWluaW1hbCBzdHlsZXMgZm9yIHRoZSBHTyBsaW5lIGNoYXJ0ICovCiAgI2dvLWxpbmUtY2hhcnQtY2FyZHsgbWFyZ2luLXRvcDogMTJweDsgfQogIC5nby1sZWdlbmR7IGRpc3BsYXk6ZmxleDsgZ2FwOjE2cHg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgbWFyZ2luOjZweCAwIDEwcHggMDsgZmxleC13cmFwOndyYXA7IH0KICAuZ28tbGVnZW5kIC5kb3R7IHdpZHRoOjEycHg7IGhlaWdodDoxMnB4OyBib3JkZXItcmFkaXVzOjk5OXB4OyBkaXNwbGF5OmlubGluZS1ibG9jazsgdmVydGljYWwtYWxpZ246bWlkZGxlOyBtYXJnaW4tcmlnaHQ6NnB4OyB9CiAgLmdvLWxlZ2VuZCAuYmx1ZXsgYmFja2dyb3VuZDojM2I4MmY2OyB9CiAgLmdvLWxlZ2VuZCAuZ3JlZW57IGJhY2tncm91bmQ6IzIyYzU1ZTsgfQogIC5nby1sZWdlbmQgLm11dGVkeyBvcGFjaXR5OjAuNjU7IGZvbnQtc2l6ZToxMnB4OyB9CiAgLmdvLWNoYXJ0LXdyYXB7IHdpZHRoOjEwMCU7IGhlaWdodDoyNjBweDsgcG9zaXRpb246cmVsYXRpdmU7IGJvcmRlcjoxcHggc29saWQgIzFmMjkzNzsgYm9yZGVyLXJhZGl1czoxMHB4OyBvdmVyZmxvdzpoaWRkZW47IH0KICAjZ28tbGluZS1jaGFydHsgd2lkdGg6MTAwJTsgaGVpZ2h0OjEwMCU7IGRpc3BsYXk6YmxvY2s7IH0KICAjZ28tY2hhcnQtZW1wdHl7IHBhZGRpbmc6MTJweDsgZm9udC1zaXplOjEzcHg7IG9wYWNpdHk6MC44OyB9CiAgLmdvLWNoYXJ0LXRvb2x0aXB7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsgcG9pbnRlci1ldmVudHM6bm9uZTsgYmFja2dyb3VuZDojMGIxMjIwOyBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7CiAgICBwYWRkaW5nOjZweCA4cHg7IGJvcmRlci1yYWRpdXM6OHB4OyBmb250LXNpemU6MTJweDsgd2hpdGUtc3BhY2U6bm93cmFwOwogICAgdHJhbnNmb3JtOnRyYW5zbGF0ZSgtNTAlLCAtMTIwJSk7CiAgfQogIC5nby1ncmlkbGluZXsgb3BhY2l0eTowLjE1OyB9Cjwvc3R5bGU+CjxzZWN0aW9uIGNsYXNzPSJnby1jYXJkIGdvLXBhbmVsIiBpZD0iZ28tbGluZS1jaGFydC1jYXJkIj4KICA8aDQgc3R5bGU9Im1hcmdpbjowIDAgOHB4IDAiPvCfk4ggV2vFgmFkIHfFgmFzbnkgdnMgd2FydG/Fm8SHICh6YWtyZXMgY3phc3UgamFrIHcgZmlsdHJ6ZSk8L2g0PgogIDxkaXYgY2xhc3M9ImdvLWxlZ2VuZCI+CiAgICA8c3Bhbj48c3BhbiBjbGFzcz0iZG90IGJsdWUiPjwvc3Bhbj5Xa8WCYWQgd8WCYXNueSAod3DFgmF0eSDiiJIgd3lwxYJhdHkpPC9zcGFuPgogICAgPHNwYW4+PHNwYW4gY2xhc3M9ImRvdCBncmVlbiI+PC9zcGFuPldhcnRvxZvEhyBtYWrEhXRrdSAoYWtjamUgKyBnb3TDs3drYSwgd2cgYmllxbzEhWN5Y2ggY2VuKTwvc3Bhbj4KICAgIDxzcGFuIGNsYXNzPSJtdXRlZCI+KiBicmFrIGhpc3RvcmlpIGNlbiDigJQgbGluaWEgd2FydG/Fm2NpIHptaWVuaWEgc2nEmSBwcnp5IHRyYW5zYWtjamFjaC96YXN0cnp5a2FjaCBnb3TDs3draTwvc3Bhbj4KICA8L2Rpdj4KICA8ZGl2IGlkPSJnby1saW5lLWNoYXJ0LWluZm8iIGNsYXNzPSJtdXRlZCIgc3R5bGU9Im1hcmdpbi1ib3R0b206NnB4Ij4KICAgIDxzcGFuIGlkPSJnby1pbmZvLWJsdWUiPjwvc3Bhbj4g4oCiIDxzcGFuIGlkPSJnby1pbmZvLWdyZWVuIj48L3NwYW4+CiAgPC9kaXY+CiAgPGRpdiBjbGFzcz0iZ28tY2hhcnQtd3JhcCI+CiAgICA8Y2FudmFzIGlkPSJnby1saW5lLWNoYXJ0Ij48L2NhbnZhcz4KICAgIDxjYW52YXMgaWQ9ImdvLWxpbmUtY2hhcnQtb3ZlcmxheSI+PC9jYW52YXM+CgogICAgPGRpdiBjbGFzcz0iY2hhcnQtdG9vbHRpcC1pbXByb3ZlZCIgaWQ9ImdvLWNoYXJ0LXRvb2x0aXAtaW1wIj4KICAgICAgPGRpdiBjbGFzcz0idG9vbHRpcC1yb3ctaW1wcm92ZWQiPjxzcGFuIGNsYXNzPSJ0b29sdGlwLWxhYmVsLWltcHJvdmVkIj5EYXRhOjwvc3Bhbj48c3BhbiBjbGFzcz0idG9vbHRpcC12YWx1ZS1pbXByb3ZlZCIgaWQ9InR0LWRhdGUtaW1wIj4tPC9zcGFuPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwLXJvdy1pbXByb3ZlZCI+PHNwYW4gY2xhc3M9InRvb2x0aXAtbGFiZWwtaW1wcm92ZWQiPldrxYJhZCB3xYJhc255Ojwvc3Bhbj48c3BhbiBjbGFzcz0idG9vbHRpcC12YWx1ZS1pbXByb3ZlZCIgaWQ9InR0LWludmVzdGVkLWltcCI+LTwvc3Bhbj48L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idG9vbHRpcC1yb3ctaW1wcm92ZWQiPjxzcGFuIGNsYXNzPSJ0b29sdGlwLWxhYmVsLWltcHJvdmVkIj5XYXJ0b8WbxIcgcG9ydGZlbGE6PC9zcGFuPjxzcGFuIGNsYXNzPSJ0b29sdGlwLXZhbHVlLWltcHJvdmVkIiBpZD0idHQtdmFsdWUtaW1wIj4tPC9zcGFuPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwLXJvdy1pbXByb3ZlZCI+PHNwYW4gY2xhc3M9InRvb2x0aXAtbGFiZWwtaW1wcm92ZWQiPlp5c2svU3RyYXRhOjwvc3Bhbj48c3BhbiBjbGFzcz0idG9vbHRpcC12YWx1ZS1pbXByb3ZlZCIgaWQ9InR0LXByb2ZpdC1pbXAiPi08L3NwYW4+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InRvb2x0aXAtcm93LWltcHJvdmVkIj48c3BhbiBjbGFzcz0idG9vbHRpcC1sYWJlbC1pbXByb3ZlZCI+Uk9JICglKTo8L3NwYW4+PHNwYW4gY2xhc3M9InRvb2x0aXAtdmFsdWUtaW1wcm92ZWQiIGlkPSJ0dC1yb2ktaW1wIj4tPC9zcGFuPjwvZGl2PgogICAgPC9kaXY+CiAgICAKICAgIDxkaXYgaWQ9ImdvLWNoYXJ0LWVtcHR5IiBzdHlsZT0iZGlzcGxheTpub25lIj5CcmFrIGRhbnljaCBkbyB3eWtyZXN1IHcgd3licmFueW0gb2tyZXNpZS48L2Rpdj4KICA8L2Rpdj4KPC9zZWN0aW9uPgoKICAgIDxzZWN0aW9uIGNsYXNzPSJnby1jYXJkIGdvLXBhbmVsIj4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtnYXA6OHB4Ij4KICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbjowIj7wn5OCIFBvcnRmZWxlPC9oND48ZGl2IHN0eWxlPSJmbGV4OjEiPjwvZGl2PjxzcGFuIGNsYXNzPSJnby1tdXRlZCBnby1taW5pIj5LbGlrbmlqLCBieSByb3p3aW7EhcSHIHBvenljamUuPC9zcGFuPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idGFibGUtd3JhcCI+CiAgICAgICAgPHRhYmxlPgogICAgICAgICAgPHRoZWFkPjx0cj48dGg+UG9ydGZlbDwvdGg+PHRoPldhbHV0YTwvdGg+PHRoPkdvdMOzd2thPC90aD48dGg+QWtjamU8L3RoPjx0aD5SYXplbSAobmF0Lik8L3RoPjx0aD5SYXplbSAoYmF6Lik8L3RoPjx0aD5Lb3N6dCB3xYJhc255PC90aD48dGg+VW5yZWFsLiBQL0w8L3RoPjx0aD5VbnJlYWwuICU8L3RoPjx0aD5SZWFsLiBuZXR0bzwvdGg+PC90cj48L3RoZWFkPgogICAgICAgICAgPHRib2R5IGlkPSJnby1wZi1ib2R5Ij48dHI+PHRkIGNvbHNwYW49IjEwIiBjbGFzcz0iZ28tbXV0ZWQiPkJyYWsgZGFueWNo4oCmPC90ZD48L3RyPjwvdGJvZHk+CiAgICAgICAgPC90YWJsZT4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImdvLWNhcmQgZ28tcGFuZWwiPgogICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXIiPgogICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luOjAiPvCfp6kgUG96eWNqZSAoYWdyZWdhY2phKTwvaDQ+CiAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj48L2Rpdj4KICAgICAgICA8aW5wdXQgaWQ9ImdvLWZpbHRlciIgcGxhY2Vob2xkZXI9Im5wLiBUU0xBLCAuV0EsIHp5c2s+MCwgc3RyYXRhPjAsIHBmOk5hendhIiBzdHlsZT0ibWF4LXdpZHRoOjMyMHB4Ij4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPgogICAgICAgIDx0YWJsZT4KICAgICAgICAgIDx0aGVhZD48dHI+PHRoPlRpY2tlcjwvdGg+PHRoPlBvcnRmZWw8L3RoPjx0aD5JbG/Fm8SHPC90aD48dGg+xZpyLiBrb3N6dDwvdGg+PHRoPktvc3p0IHfFgmFzbnk8L3RoPjx0aD5LdXJzPC90aD48dGg+V2FydG/Fm8SHPC90aD48dGg+VW5yZWFsLiBQL0w8L3RoPjx0aD4lPC90aD48dGg+zpQgZHppZW5ueTwvdGg+PC90cj48L3RoZWFkPgogICAgICAgICAgPHRib2R5IGlkPSJnby1wb3MtYm9keSI+PHRyPjx0ZCBjb2xzcGFuPSIxMCIgY2xhc3M9ImdvLW11dGVkIj5CcmFrIHBvenljamnigKY8L3RkPjwvdHI+PC90Ym9keT4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KICA8L2Rpdj4KPC9zZWN0aW9uPgoKPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgInVzZSBzdHJpY3QiOwoKLy8gPT09IFBlcmlvZCBmaWx0ZXIgaGVscGVycyA9PT0KZnVuY3Rpb24gdG9NcyhkKXsKICB0cnl7CiAgICBpZihkPT1udWxsKSByZXR1cm4gTmFOOwogICAgaWYodHlwZW9mIGQgPT09ICdudW1iZXInKSByZXR1cm4gZDsKICAgIGlmKHR5cGVvZiBkID09PSAnc3RyaW5nJyl7IGNvbnN0IG1zID0gRGF0ZS5wYXJzZShkKTsgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShtcyk/bXM6TmFOOyB9CiAgICBpZihkICYmIHR5cGVvZiBkLnRvRGF0ZSA9PT0gJ2Z1bmN0aW9uJyl7IHRyeXsgcmV0dXJuIGQudG9EYXRlKCkuZ2V0VGltZSgpOyB9Y2F0Y2goXyl7IHJldHVybiBOYU47IH0gfQogICAgaWYoZCAmJiB0eXBlb2YgZC5zZWNvbmRzICE9PSAndW5kZWZpbmVkJyl7IHJldHVybiBOdW1iZXIoZC5zZWNvbmRzKSoxMDAwOyB9CiAgfWNhdGNoKF8pe30KICByZXR1cm4gTmFOOwp9CmZ1bmN0aW9uIGdldFBlcmlvZEtleSgpewogIHRyeXsgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfcGVyaW9kJykgfHwgJ2FsbCc7IH1jYXRjaChfKXsgcmV0dXJuICdhbGwnOyB9Cn0KZnVuY3Rpb24gc2V0UGVyaW9kS2V5KGspewogIHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19wZXJpb2QnLCBTdHJpbmcoa3x8J2FsbCcpKTsgfWNhdGNoKF8pe30KfQpmdW5jdGlvbiBnZXRQZXJpb2RSYW5nZShrZXkpewogIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7CiAgY29uc3QgZW5kID0gbm93LmdldFRpbWUoKTsKICBjb25zdCBtc0RheSA9IDI0KjYwKjYwKjEwMDA7CiAgY29uc3Qgc3RhcnRPZlRvZGF5ID0gbmV3IERhdGUobm93LmdldEZ1bGxZZWFyKCksIG5vdy5nZXRNb250aCgpLCBub3cuZ2V0RGF0ZSgpKS5nZXRUaW1lKCk7CiAgc3dpdGNoKGtleSl7CiAgICBjYXNlICdkYXknOiAgcmV0dXJuIHtzdGFydDpzdGFydE9mVG9kYXksIGVuZH07CiAgICBjYXNlICd3ZWVrJzogcmV0dXJuIHtzdGFydDplbmQgLSA3Km1zRGF5LCBlbmR9OwogICAgY2FzZSAnbW9udGgnOnJldHVybiB7c3RhcnQ6ZW5kIC0gMzAqbXNEYXksIGVuZH07CiAgICBjYXNlICd5dGQnOiAgcmV0dXJuIHtzdGFydDpuZXcgRGF0ZShub3cuZ2V0RnVsbFllYXIoKSwwLDEpLmdldFRpbWUoKSwgZW5kfTsKICAgIGNhc2UgJzF5JzogICByZXR1cm4ge3N0YXJ0OmVuZCAtIDM2NSptc0RheSwgZW5kfTsKICAgIGNhc2UgJzJ5JzogICByZXR1cm4ge3N0YXJ0OmVuZCAtIDIqMzY1Km1zRGF5LCBlbmR9OwogICAgY2FzZSAnM3knOiAgIHJldHVybiB7c3RhcnQ6ZW5kIC0gMyozNjUqbXNEYXksIGVuZH07CiAgICBkZWZhdWx0OiAgICAgcmV0dXJuIHtzdGFydDotSW5maW5pdHksIGVuZH07CiAgfQp9CmZ1bmN0aW9uIGluUmFuZ2VNcyhtcywgcmFuZ2UpewogIGlmKCFyYW5nZSkgcmV0dXJuIHRydWU7CiAgaWYoIU51bWJlci5pc0Zpbml0ZShtcykpIHJldHVybiBmYWxzZTsKICBjb25zdCBzID0gTnVtYmVyKHJhbmdlLnN0YXJ0ID8/IC1JbmZpbml0eSk7CiAgY29uc3QgZSA9IE51bWJlcihyYW5nZS5lbmQgPz8gSW5maW5pdHkpOwogIHJldHVybiBtcyA+PSBzICYmIG1zIDw9IGU7Cn0KCiAgLy8gPT09IEdMT0JBTCwgQ09PUEVSQVRJVkUgUkFURS1MSU1JVEVEIFFVT1RFIExBWUVSIChzaGFyZWQgYWNyb3NzIG1vZHVsZXMpID09PQogIGNvbnN0IE1JTl9JTlRFUlZBTF9NUyA9IDExMDA7ICAgICAgIC8vICB+MSByZXEvc2VjIChzYWZlIGZvciBmcmVlIHRpZXJzKQogIGNvbnN0IENBQ0hFX1RUTF9NUyAgID0gNjAqMTAwMDsgICAgIC8vICA2MHMgY2FjaGUgcGVyIHN5bWJvbAogIGNvbnN0IEJBQ0tPRkZfNDI5X01TID0gMTUqMTAwMDsgICAgIC8vICAxNXMgY29vbGRvd24gb24gNDI5CgogIGNvbnN0IFcgPSB3aW5kb3c7CiAgVy5fX0dUX1FVT1RFX0NBQ0hFID0gVy5fX0dUX1FVT1RFX0NBQ0hFIHx8IG5ldyBNYXAoKTsgLy8gc3ltYm9sIC0+IHtxLCBhdH0KICBXLl9fR1RfUVVPVEVfUEVORElORyA9IFcuX19HVF9RVU9URV9QRU5ESU5HIHx8IG5ldyBNYXAoKTsgLy8gc3ltYm9sIC0+IFByb21pc2UKICBXLl9fR1RfUVVPVEVfTEFTVF9DQUxMID0gVy5fX0dUX1FVT1RFX0xBU1RfQ0FMTCB8fCAwOwogIFcuX19HVF9RVU9URV9DT09MRE9XTl9VTlRJTCA9IFcuX19HVF9RVU9URV9DT09MRE9XTl9VTlRJTCB8fCAwOwoKICBmdW5jdGlvbiBub3coKXsgcmV0dXJuIERhdGUubm93KCk7IH0KCiAgZnVuY3Rpb24gcmVhZEZyb21BcHBRdW90ZXMoc3ltYm9sKXsKICAgIHRyeXsKICAgICAgLy8gcHLDs2J1amVteSB3c3DDs8WCZHppZWxpxIcgZGFuZSBnxYLDs3duZWogYXBsaWthY2ppLCBqZcWbbGkgbWEgZ2xvYmFsIFFVT1RFUwogICAgICBjb25zdCBRID0gVy5RVU9URVMgfHwgVy5fX1FVT1RFUyB8fCBudWxsOwogICAgICBpZighUSB8fCAhUVtzeW1ib2xdKSByZXR1cm4gbnVsbDsKICAgICAgY29uc3QgdiA9IFFbc3ltYm9sXTsKICAgICAgLy8gaGV1cnlzdHlrYTogcm96bWFpdGUgZm9ybWF0eQogICAgICBpZiAodHlwZW9mIHYgPT09ICdvYmplY3QnKXsKICAgICAgICBjb25zdCBwcmljZSA9IE51bWJlcih2LnByaWNlID8/IHYuYyA/PyB2Lmxhc3QgPz8gdi5wKSB8fCBudWxsOwogICAgICAgIGlmIChwcmljZSl7IHJldHVybiB7IGM6IHByaWNlLCBwYzogTnVtYmVyKHYucHJldlByaWNlID8/IHYucGMgPz8gMCkgfHwgbnVsbCwgdDogbm93KCkgfTsgfQogICAgICB9ZWxzZSBpZiAoaXNGaW5pdGUoTnVtYmVyKHYpKSl7CiAgICAgICAgcmV0dXJuIHsgYzogTnVtYmVyKHYpLCBwYzogbnVsbCwgdDogbm93KCkgfTsKICAgICAgfQogICAgfWNhdGNoKF8pe30KICAgIHJldHVybiBudWxsOwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gZGVsYXkobXMpeyByZXR1cm4gbmV3IFByb21pc2Uocj0+c2V0VGltZW91dChyLCBtcykpOyB9CgogIGFzeW5jIGZ1bmN0aW9uIGZldGNoUXVvdGVDb29wKHN5bWJvbCwgdG9rZW4sIG9wdHM9e30pewogICAgY29uc3Qgbm9BcGkgPSAhIW9wdHMubm9BcGk7CiAgICBjb25zdCB0dGwgPSBpc0Zpbml0ZShvcHRzLnR0bE1zKSA/IG9wdHMudHRsTXMgOiBDQUNIRV9UVExfTVM7CiAgICBjb25zdCBrZXkgPSBTdHJpbmcoc3ltYm9sKS50b1VwcGVyQ2FzZSgpOwoKICAgIC8vICgxKSBjYWNoZQogICAgY29uc3QgY2FjaGVkID0gVy5fX0dUX1FVT1RFX0NBQ0hFLmdldChrZXkpOwogICAgaWYgKGNhY2hlZCAmJiAobm93KCkgLSBjYWNoZWQuYXQpIDwgdHRsKXsgcmV0dXJuIGNhY2hlZC5xOyB9CgogICAgLy8gKDIpIHRyeSByZWFkIGZyb20gYXBwJ3MgZXhpc3RpbmcgcXVvdGVzCiAgICBjb25zdCBmcm9tQXBwID0gcmVhZEZyb21BcHBRdW90ZXMoa2V5KTsKICAgIGlmIChmcm9tQXBwKXsKICAgICAgVy5fX0dUX1FVT1RFX0NBQ0hFLnNldChrZXksIHtxOiBmcm9tQXBwLCBhdDogbm93KCl9KTsKICAgICAgcmV0dXJuIGZyb21BcHA7CiAgICB9CgogICAgLy8gKDMpIG5vIGV4dGVybmFsIGNhbGxzIG1vZGUKICAgIGlmIChub0FwaSB8fCAhdG9rZW4pewogICAgICAvLyBrZWVwIGxhc3Qga25vd24gY2FjaGUgb3IgcmV0dXJuIG51bGwKICAgICAgcmV0dXJuIGNhY2hlZCA/IGNhY2hlZC5xIDogbnVsbDsKICAgIH0KCiAgICAvLyBkZS1kdXAgY29uY3VycmVudCBmZXRjaGVzIGZvciB0aGUgc2FtZSBzeW1ib2wKICAgIGlmIChXLl9fR1RfUVVPVEVfUEVORElORy5oYXMoa2V5KSkgcmV0dXJuIGF3YWl0IFcuX19HVF9RVU9URV9QRU5ESU5HLmdldChrZXkpOwoKICAgIGNvbnN0IHAgPSAoYXN5bmMgKCk9PnsKICAgICAgLy8gY29vbGRvd24gd2luZG93IGFmdGVyIDQyOQogICAgICBjb25zdCB1bnRpbCA9IFcuX19HVF9RVU9URV9DT09MRE9XTl9VTlRJTCB8fCAwOwogICAgICBpZiAobm93KCkgPCB1bnRpbCkgeyBhd2FpdCBkZWxheSh1bnRpbCAtIG5vdygpKTsgfQoKICAgICAgLy8gcmF0ZSBsaW1pdDogc3BhY2luZyBjYWxscwogICAgICBjb25zdCB3YWl0ID0gTWF0aC5tYXgoMCwgKFcuX19HVF9RVU9URV9MQVNUX0NBTEwgKyBNSU5fSU5URVJWQUxfTVMpIC0gbm93KCkpOwogICAgICBpZiAod2FpdD4wKSBhd2FpdCBkZWxheSh3YWl0KTsKCiAgICAgIHRyeXsKICAgICAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9maW5uaHViLmlvL2FwaS92MS9xdW90ZT9zeW1ib2w9JHtlbmNvZGVVUklDb21wb25lbnQoa2V5KX0mdG9rZW49JHtlbmNvZGVVUklDb21wb25lbnQodG9rZW4pfWA7CiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsKTsKICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gNDI5KXsKICAgICAgICAgIC8vIGJhY2tvZmY7IGtlZXAgb2xkIHZhbHVlIGlmIGFueQogICAgICAgICAgVy5fX0dUX1FVT1RFX0NPT0xET1dOX1VOVElMID0gbm93KCkgKyBCQUNLT0ZGXzQyOV9NUzsKICAgICAgICAgIGNvbnN0IGNhY2hlZCA9IFcuX19HVF9RVU9URV9DQUNIRS5nZXQoa2V5KTsKICAgICAgICAgIHJldHVybiBjYWNoZWQgPyBjYWNoZWQucSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGpzID0gYXdhaXQgcmVzLmpzb24oKTsKICAgICAgICBjb25zdCBxID0geyBjOk51bWJlcihqcy5jKXx8bnVsbCwgcGM6TnVtYmVyKGpzLnBjKXx8bnVsbCwgZDpOdW1iZXIoanMuZCl8fG51bGwsIGRwOk51bWJlcihqcy5kcCl8fG51bGwsIHQ6IGpzLnR8fG5vdygpIH07CiAgICAgICAgVy5fX0dUX1FVT1RFX0NBQ0hFLnNldChrZXksIHtxLCBhdDogbm93KCl9KTsKICAgICAgICByZXR1cm4gcTsKICAgICAgfWZpbmFsbHl7CiAgICAgICAgVy5fX0dUX1FVT1RFX0xBU1RfQ0FMTCA9IG5vdygpOwogICAgICB9CiAgICB9KSgpOwoKICAgIFcuX19HVF9RVU9URV9QRU5ESU5HLnNldChrZXksIHApOwogICAgdHJ5eyByZXR1cm4gYXdhaXQgcDsgfQogICAgZmluYWxseXsgVy5fX0dUX1FVT1RFX1BFTkRJTkcuZGVsZXRlKGtleSk7IH0KICB9CgogIC8vID09PSBNb2R1bGUtbG9jYWwgY29kZSA9PT0KICBjb25zdCBLRVkgPSAicG9ydGZlbGVfZmlybXlfdjEiOwogIGNvbnN0ICQgPSAocywgcj1kb2N1bWVudCk9PiByLnF1ZXJ5U2VsZWN0b3Iocyk7CiAgY29uc3QgZm10TW9uZXkgPSAobiwgY3VyPSdQTE4nKSA9PiB7CiAgICBjb25zdCB4ID0gTnVtYmVyKG4pOyBpZighaXNGaW5pdGUoeCkpIHJldHVybiAi4oCUIjsKICAgIHRyeXsgcmV0dXJuIG5ldyBJbnRsLk51bWJlckZvcm1hdCgncGwtUEwnLHtzdHlsZTonY3VycmVuY3knLCBjdXJyZW5jeTpjdXIsIG1heGltdW1GcmFjdGlvbkRpZ2l0czoyLCBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6Mn0pLmZvcm1hdCh4KTsgfQogICAgY2F0Y2goZSl7IHJldHVybiB4LnRvRml4ZWQoMikrJyAnK2N1cjsgfQogIH07CiAgY29uc3QgZm10TnVtID0gKG4sZD0yKT0+IGlzRmluaXRlKE51bWJlcihuKSkgPyBOdW1iZXIobikudG9GaXhlZChkKSA6ICfigJQnOwoKICBjb25zdCBTVCA9IHsKICAgIERCOm51bGwsIGJhc2U6J1BMTicsIHRva2VuOicnLCBwb2xsOjQ1LCBGWDp7UExOOntQTE46MSwgZnhVc2RwbG5BdDowfX0sIHRpbWVyOm51bGwsIG5vQXBpOmZhbHNlLCB0dGxNczo2MCoxMDAwCiAgfTsKCiAgZnVuY3Rpb24gbG9hZFByZWZzKCl7CiAgdHJ5ewogICAgU1QucGVyaW9kS2V5ID0gZ2V0UGVyaW9kS2V5KCk7CiAgICBjb25zdCBzZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tcGVyaW9kJyk7CiAgICBpZihzZWwpeyBzZWwudmFsdWUgPSBTVC5wZXJpb2RLZXk7IH0KICAgIFNULnBlcmlvZFJhbmdlID0gZ2V0UGVyaW9kUmFuZ2UoU1QucGVyaW9kS2V5KTsKICB9Y2F0Y2goXyl7IFNULnBlcmlvZEtleSA9ICdhbGwnOyBTVC5wZXJpb2RSYW5nZSA9IGdldFBlcmlvZFJhbmdlKCdhbGwnKTsgfQoKICAgIHRyeXsgU1QuREIgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKEtFWSkgfHwgJ3t9Jyk7IH0gY2F0Y2goXyl7IFNULkRCID0ge307IH0KICAgIGlmKCFTVC5EQiB8fCAhU1QuREIuc2V0dGluZ3MpIFNULkRCID0gU1QuREIgfHwge3NldHRpbmdzOnt9fTsKICAgIFNULmJhc2UgID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19iYXNlJykgfHwgJ1BMTic7CiAgICBTVC5wb2xsICA9IE51bWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X3BvbGwnKXx8IChTVC5EQi5zZXR0aW5ncz8ucHJpY2VQb2xsU2Vjb25kcyB8fCA0NSkpIHx8IDQ1OwogICAgU1QudG9rZW4gPSAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2dsb2JhbF9vdmVydmlld190b2snKSB8fCBTVC5EQi5zZXR0aW5ncz8uZmlubmh1YlRva2VuIHx8ICcnKS50cmltKCk7CiAgICBTVC5ub0FwaSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfbm9hcGknKSA9PT0gJzEnOwogICAgJCgnI2dvLWJhc2UnKS52YWx1ZSA9IFNULmJhc2U7ICQoJyNnby1wb2xsJykudmFsdWUgPSBTVC5wb2xsOyAkKCcjZ28tdG9rZW4nKS52YWx1ZSA9IFNULnRva2VuOwogICAgJCgnI2dvLW5vLWFwaScpLmNoZWNrZWQgPSBTVC5ub0FwaTsKICAgICQoJyNnby10dGwnKS50ZXh0Q29udGVudCA9IE1hdGgucm91bmQoU1QudHRsTXMvMTAwMCkrJ3MnOwogIH0KCiAgCmFzeW5jIGZ1bmN0aW9uIGVuc3VyZUZ4KGZyb20sIHRvKXsKICB0cnl7CiAgICBpZighU1QuRlhbZnJvbV0pIFNULkZYW2Zyb21dID0ge307CiAgICBjb25zdCBwYWlyS2V5ID0gZnJvbSArICctPicgKyB0bzsKICAgIGNvbnN0IG5vd1RzID0gRGF0ZS5ub3coKTsKCiAgICAvLyBzYW1lLWN1cnJlbmN5IHNob3J0Y3V0CiAgICBpZihmcm9tPT09dG8pewogICAgICBTVC5GWFtmcm9tXVt0b10gPSAxOwogICAgICB0cnl7IHBhaW50RngoKTsgfWNhdGNoKF8pe30KICAgICAgcmV0dXJuIDE7CiAgICB9CgogICAgLy8gTWFudWFsIG92ZXJyaWRlIGZvciBVU0QtPlBMTi9QTE4tPlVTRCAoc2V0IHZpYSAiVXN0YXciKQogICAgdHJ5ewogICAgICBpZiAoKGZyb209PT0nVVNEJyAmJiB0bz09PSdQTE4nKSB8fCAoZnJvbT09PSdQTE4nICYmIHRvPT09J1VTRCcpKXsKICAgICAgICBjb25zdCBtID0gTnVtYmVyKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfZnhfdXNkcGxuJykgfHwgJycpOwogICAgICAgIGlmIChOdW1iZXIuaXNGaW5pdGUobSkgJiYgbT4wKXsKICAgICAgICAgIC8vIHJlc3BlY3QgbWFudWFsIG92ZXJyaWRlCiAgICAgICAgICBTVC5GWFsnVVNEJ10gPSBTVC5GWFsnVVNEJ10gfHwge307CiAgICAgICAgICBTVC5GWFsnUExOJ10gPSBTVC5GWFsnUExOJ10gfHwge307CiAgICAgICAgICBTVC5GWFsnVVNEJ11bJ1BMTiddID0gbTsKICAgICAgICAgIFNULkZYWydQTE4nXVsnVVNEJ10gPSAxL207CiAgICAgICAgICB0cnl7IHBhaW50RngoKTsgfWNhdGNoKF8pe30KICAgICAgICAgIHJldHVybiAoZnJvbT09PSdVU0QnKSA/IG0gOiAoMS9tKTsKICAgICAgICB9CiAgICAgIH0KICAgIH1jYXRjaChfKXt9CgogICAgLy8gRm9yIFVTRDwtPlBMTiByZWZyZXNoIHVzaW5nIFRUTCAoZGVmYXVsdHMgdG8gU1QudHRsTXMpCiAgICBjb25zdCBpc1VzZFBsbiA9IChmcm9tPT09J1VTRCcgJiYgdG89PT0nUExOJykgfHwgKGZyb209PT0nUExOJyAmJiB0bz09PSdVU0QnKTsKICAgIGNvbnN0IHR0bE1zID0gTWF0aC5tYXgoMTBfMDAwLCBOdW1iZXIoU1QudHRsTXMpfHw2MF8wMDApOwogICAgY29uc3QgY2FjaGVkID0gU1QuRlhbZnJvbV0gJiYgU1QuRlhbZnJvbV1bdG9dOwogICAgY29uc3QgZnJlc2hFbm91Z2ggPSBpc1VzZFBsbiA/IChub3dUcyAtIChTVC5meFVzZHBsbkF0fHwwKSA8IHR0bE1zKSA6IE51bWJlci5pc0Zpbml0ZShjYWNoZWQpOwoKICAgIGlmIChOdW1iZXIuaXNGaW5pdGUoY2FjaGVkKSAmJiBmcmVzaEVub3VnaCl7CiAgICAgIHJldHVybiBTVC5GWFtmcm9tXVt0b107CiAgICB9CgogICAgLy8gRGVjaWRlIGZldGNoIGRpcmVjdGlvbiAobm9ybWFsaXplIHRvIFVTRC0+UExOIGlmIHBhaXIgaXMgUExOLT5VU0QpCiAgICBsZXQgYSA9IGZyb20sIGIgPSB0bywgaW52ZXJ0ID0gZmFsc2U7CiAgICBpZiAoZnJvbT09PSdQTE4nICYmIHRvPT09J1VTRCcpeyBhPSdVU0QnOyBiPSdQTE4nOyBpbnZlcnQgPSB0cnVlOyB9CgogICAgbGV0IHJhdGUgPSBudWxsOwoKICAgIC8vIFRyeSBGcmFua2Z1cnRlciAoRUNCKSBmaXJzdCDigJQgQ09SUy1mcmllbmRseSwgbm8gQVBJIGtleQogICAgdHJ5ewogICAgICBpZiAoYT09PSdVU0QnICYmIGI9PT0nUExOJyl7CiAgICAgICAgY29uc3QgciA9IGF3YWl0IGZldGNoKCdodHRwczovL2FwaS5mcmFua2Z1cnRlci5hcHAvbGF0ZXN0P2Zyb209VVNEJnRvPVBMTicpOwogICAgICAgIGlmIChyLm9rKXsKICAgICAgICAgIGNvbnN0IGogPSBhd2FpdCByLmpzb24oKTsKICAgICAgICAgIHJhdGUgPSBOdW1iZXIoaiAmJiBqLnJhdGVzICYmIGoucmF0ZXMuUExOKTsKICAgICAgICB9CiAgICAgIH0KICAgIH1jYXRjaChfKXt9CgogICAgLy8gRmFsbGJhY2s6IGV4Y2hhbmdlcmF0ZS5ob3N0IChhbHNvIENPUlMtZnJpZW5kbHkpCiAgICBpZighTnVtYmVyLmlzRmluaXRlKHJhdGUpIHx8IHJhdGU8PTApewogICAgICB0cnl7CiAgICAgICAgY29uc3QgdXJsID0gYGh0dHBzOi8vYXBpLmV4Y2hhbmdlcmF0ZS5ob3N0L2xhdGVzdD9iYXNlPSR7ZW5jb2RlVVJJQ29tcG9uZW50KGEpfSZzeW1ib2xzPSR7ZW5jb2RlVVJJQ29tcG9uZW50KGIpfWA7CiAgICAgICAgY29uc3QgaiA9IGF3YWl0IChhd2FpdCBmZXRjaCh1cmwpKS5qc29uKCkuY2F0Y2goKCk9Pm51bGwpOwogICAgICAgIHJhdGUgPSBOdW1iZXIoaiAmJiBqLnJhdGVzICYmIGoucmF0ZXNbYl0pOwogICAgICB9Y2F0Y2goXyl7fQogICAgfQoKICAgIC8vIEZpbmFsaXplCiAgICBpZiAoTnVtYmVyLmlzRmluaXRlKHJhdGUpICYmIHJhdGU+MCl7CiAgICAgIGNvbnN0IGZpbmFsID0gaW52ZXJ0ID8gKDEvcmF0ZSkgOiByYXRlOwogICAgICBpZighU1QuRlhbZnJvbV0pIFNULkZYW2Zyb21dID0ge307CiAgICAgIGlmKCFTVC5GWFt0b10pIFNULkZYW3RvXSA9IHt9OwogICAgICBTVC5GWFtmcm9tXVt0b10gPSBmaW5hbDsKICAgICAgU1QuRlhbdG9dW2Zyb21dID0gMS9maW5hbDsKCiAgICAgIC8vIElmIHNwZWNpZmljYWxseSBVU0QtPlBMTiBwYWlyLCB1cGRhdGUgaW5wdXQgYW5kIHJlbWVtYmVyIHRpbWVzdGFtcAogICAgICB0cnl7CiAgICAgICAgaWYgKChmcm9tPT09J1VTRCcgJiYgdG89PT0nUExOJykgfHwgKGZyb209PT0nUExOJyAmJiB0bz09PSdVU0QnKSl7CiAgICAgICAgICBTVC5meFVzZHBsbkF0ID0gbm93VHM7CiAgICAgICAgICBjb25zdCB2ID0gKGZyb209PT0nVVNEJykgPyBmaW5hbCA6ICgxL2ZpbmFsKTsKICAgICAgICAgIC8vIHNob3cgaW4gdGhlIGlucHV0ICh3aXRob3V0IHRyaXBwaW5nIG1hbnVhbCBvdmVycmlkZSkKICAgICAgICAgIGNvbnN0IGlucCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1meC11c2RwbG4nKTsKICAgICAgICAgIGlmIChpbnApIGlucC52YWx1ZSA9IChOdW1iZXIodil8fDApLnRvRml4ZWQoNCk7CiAgICAgICAgICAvLyBzdG9yZSBmb3IgY29udmVuaWVuY2UgaW4gdGhlIFVJIGlucHV0IGhlbHBlcgogICAgICAgICAgdHJ5eyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ3RfZnhfdXNkX3BsbicsIFN0cmluZyh2KSk7IH1jYXRjaChfKXt9CiAgICAgICAgfQogICAgICB9Y2F0Y2goXyl7fQoKICAgICAgdHJ5eyBwYWludEZ4KCk7IH1jYXRjaChfKXt9CiAgICAgIHJldHVybiBTVC5GWFtmcm9tXVt0b107CiAgICB9CgogICAgLy8gRmFsbGJhY2sgdG8gcHJldmlvdXMgb3IgMSBpZiBhbGwgZmFpbGVkCiAgICBpZiAoTnVtYmVyLmlzRmluaXRlKGNhY2hlZCkpIHJldHVybiBjYWNoZWQ7CiAgICBTVC5GWFtmcm9tXVt0b10gPSAxOwogICAgdHJ5eyBwYWludEZ4KCk7IH1jYXRjaChfKXt9CiAgICByZXR1cm4gMTsKICB9Y2F0Y2goZSl7CiAgICBjb25zb2xlLndhcm4oJ0ZYIGVycm9yJywgZSk7CiAgICByZXR1cm4gMTsKICB9Cn0KZnVuY3Rpb24gcGFpbnRGeCgpewogICAgdHJ5ewogICAgICBjb25zdCBwYXJ0cyA9IFtdOwogICAgICBmb3IoY29uc3QgZiBpbiBTVC5GWCl7IGZvcihjb25zdCB0IGluIFNULkZYW2ZdKXsgcGFydHMucHVzaChgJHtmfS0+JHt0fToke2ZtdE51bShTVC5GWFtmXVt0XSl9YCk7IH0gfQogICAgICAkKCcjZ28tZngnKS50ZXh0Q29udGVudCA9IHBhcnRzLmpvaW4oJyAgfCAgJykgfHwgJ+KAlCc7CiAgICB9Y2F0Y2goXyl7fQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hBbGxRdW90ZXNDb29wKCl7CiAgICBjb25zdCBzZXQgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBwZnMgPSBBcnJheS5pc0FycmF5KFNULkRCLnBvcnRmb2xpb3MpID8gU1QuREIucG9ydGZvbGlvcyA6IFtdOwogICAgZm9yKGNvbnN0IHBmIG9mIHBmcyl7IGZvcihjb25zdCB0IG9mIE9iamVjdC5rZXlzKHBmLmhvbGRpbmdzfHx7fSkpeyBzZXQuYWRkKFN0cmluZyh0KS50cmltKCkudG9VcHBlckNhc2UoKSk7IH0gfQogICAgY29uc3QgdGlja2VycyA9IEFycmF5LmZyb20oc2V0KTsKICAgIGNvbnN0IHRva2VuID0gKCQoJyNnby10b2tlbicpLnZhbHVlIHx8IFNULnRva2VuIHx8ICcnKS50cmltKCk7CiAgICBjb25zdCBub0FwaSA9ICQoJyNnby1uby1hcGknKS5jaGVja2VkIHx8ICF0b2tlbjsKCiAgICAvLyBmZXRjaCBvbmx5IHN0YWxlL21pc3Npbmc7IHJlc3BlY3QgcXVldWUsIGRlZHVwIHdpdGggYXBwCiAgICBjb25zdCBwcm9taXNlcyA9IHRpY2tlcnMubWFwKHN5bSA9PiBmZXRjaFF1b3RlQ29vcChzeW0sIHRva2VuLCB7IG5vQXBpLCB0dGxNczogU1QudHRsTXMgfSkpOwogICAgY29uc3QgcXVvdGVzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpOwogICAgLy8gbWFwIHRvIG9iamVjdCBmb3IgbGF0ZXIgcmVhZHMKICAgIGNvbnN0IG9iaiA9IHt9OwogICAgdGlja2Vycy5mb3JFYWNoKCh0LGkpPT57IGNvbnN0IHEgPSBxdW90ZXNbaV18fG51bGw7IGlmKHEpIG9ialt0XT1xOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfQoKICBmdW5jdGlvbiByZWFsaXplZFN1bXMocGYsIHJhbmdlKXsKICAgIGxldCBnPTAsdD0wLG49MDsKICAgIGZvcihjb25zdCB0eCBvZiAocGYudHJhbnNhY3Rpb25zfHxbXSkpewogICAgICBpZih0eC50eXBlPT09J3NlbGwnKXsKICAgICAgICB0cnl7IGNvbnN0IG1zID0gdG9Ncyh0eCAmJiB0eC5kYXRlKTsgaWYocmFuZ2UgJiYgIWluUmFuZ2VNcyhtcywgcmFuZ2UpKSBjb250aW51ZTsgfWNhdGNoKF8pe30KICAgICAgICBjb25zdCBncm9zcyA9IE51bWJlcih0eC5ncm9zc1BMKXx8MDsKICAgICAgICBjb25zdCB0YXggICA9IE51bWJlcih0eC50YXgpfHwgKGdyb3NzPjAgPyBncm9zcyooU1QuREIuc2V0dGluZ3M/LnRheFJhdGV8fDAuMTkpIDogMCk7CiAgICAgICAgY29uc3QgbmV0ICAgPSBOdW1iZXIodHgubmV0UEwpfHwgKGdyb3NzIC0gdGF4KTsKICAgICAgICBnKz1ncm9zczsgdCs9dGF4OyBuKz1uZXQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7Z3Jvc3M6ZywgdGF4OnQsIG5ldDpufTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVQb3J0Zm9saW8ocGYsIFEsIHJhbmdlKXsKICAgIGNvbnN0IGJhc2UgPSAkKCcjZ28tYmFzZScpLnZhbHVlIHx8IFNULmJhc2UgfHwgJ1BMTic7CiAgICBjb25zdCBmeCA9IGF3YWl0IGVuc3VyZUZ4KHBmLmN1cnJlbmN5fHwnUExOJywgYmFzZSk7CiAgICBsZXQgaG9sZGluZ3M9MCwgY29zdD0wLCBkYXk9MDsKICAgIGNvbnN0IHBvc2l0aW9ucz1bXTsKICAgIGZvcihjb25zdCBbdGlja2VyLGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHBmLmhvbGRpbmdzfHx7fSkpewogICAgICBsZXQgcXR5PTAsY3N0PTAsYXZnPTA7CiAgICAgIGZvcihjb25zdCBsb3Qgb2YgKGJvb2subG90c3x8W10pKXsgY29uc3QgcT1OdW1iZXIobG90LnF0eSl8fDA7IGNvbnN0IHVjPU51bWJlcihsb3QudW5pdENvc3QpfHwwOyBxdHkrPXE7IGNzdCs9cSp1YzsgfQogICAgICBhdmcgPSBxdHk+MD9jc3QvcXR5OjA7CiAgICAgIGNvbnN0IHFkID0gKFEgJiYgUVt0aWNrZXJdKSA/IFFbdGlja2VyXSA6IG51bGw7CiAgICAgIGNvbnN0IHByaWNlID0gcWQgJiYgaXNGaW5pdGUocWQuYykgPyBOdW1iZXIocWQuYykgOiBhdmc7CiAgICAgIGNvbnN0IHZhbCA9IHF0eSpwcmljZTsgaG9sZGluZ3MrPXZhbDsgY29zdCs9Y3N0OwogICAgICBpZihxZCAmJiBpc0Zpbml0ZShxZC5kKSkgZGF5ICs9IHF0eSpOdW1iZXIocWQuZCk7CiAgICAgIHBvc2l0aW9ucy5wdXNoKHt0aWNrZXIsIHF0eSwgYXZnLCBjb3N0OmNzdCwgcHJpY2UsIHZhbHVlOnZhbCwgZDpxZD8uZD8/bnVsbCwgZHA6cWQ/LmRwPz9udWxsfSk7CiAgICB9CiAgICBjb25zdCBjYXNoID0gTnVtYmVyKHBmLmNhc2gpfHwwOwogICAgY29uc3Qge2dyb3NzLCB0YXgsIG5ldH0gPSByZWFsaXplZFN1bXMocGYsIHJhbmdlKTsKICAgIHJldHVybiB7CiAgICAgIHBmLCBmeCwKICAgICAgY2FzaE5hdDogY2FzaCwgY2FzaEJhc2U6IGNhc2gqZngsCiAgICAgIGhvbGRpbmdzTmF0OiBob2xkaW5ncywgaG9sZGluZ3NCYXNlOiBob2xkaW5ncypmeCwKICAgICAgZXF1aXR5TmF0OiBjYXNoK2hvbGRpbmdzLCBlcXVpdHlCYXNlOihjYXNoK2hvbGRpbmdzKSpmeCwKICAgICAgY29zdE5hdDogY29zdCwgY29zdEJhc2U6IGNvc3QqZngsCiAgICAgIHVucmVhbE5hdDogaG9sZGluZ3MtY29zdCwgdW5yZWFsQmFzZTooaG9sZGluZ3MtY29zdCkqZngsCiAgICAgIHVucmVhbFBjdDogY29zdD4wPyAoaG9sZGluZ3MtY29zdCkvY29zdCA6IG51bGwsCiAgICAgIGRheU1vdmVOYXQ6IGRheSwgZGF5TW92ZUJhc2U6IGRheSpmeCwKICAgICAgcmVhbGl6ZWRHcm9zc05hdDpncm9zcywgcmVhbGl6ZWRUYXhOYXQ6dGF4LCByZWFsaXplZE5ldE5hdDpuZXQsCiAgICAgIHJlYWxpemVkR3Jvc3NCYXNlOmdyb3NzKmZ4LCByZWFsaXplZFRheEJhc2U6dGF4KmZ4LCByZWFsaXplZE5ldEJhc2U6bmV0KmZ4LAogICAgICBwb3NpdGlvbnMKICAgIH07CiAgfQoKICBhc3luYyBmdW5jdGlvbiBjb21wdXRlQWxsKFEsIHJhbmdlKXsKICAgIGNvbnN0IGJhc2UgPSAkKCcjZ28tYmFzZScpLnZhbHVlIHx8ICdQTE4nOwogICAgY29uc3QgcGZzID0gQXJyYXkuaXNBcnJheShTVC5EQi5wb3J0Zm9saW9zKSA/IFNULkRCLnBvcnRmb2xpb3MgOiBbXTsKICAgIGNvbnN0IHJlc3VsdHM9W107CiAgICBsZXQgdG90ID0ge2hvbGRpbmdzQmFzZTowLGNhc2hCYXNlOjAsZXF1aXR5QmFzZTowLGNvc3RCYXNlOjAsdW5yZWFsQmFzZTowLGRheU1vdmVCYXNlOjAscmVhbGl6ZWRHcm9zc0Jhc2U6MCxyZWFsaXplZFRheEJhc2U6MCxyZWFsaXplZE5ldEJhc2U6MH07CiAgICBmb3IoY29uc3QgcGYgb2YgcGZzKXsKICAgICAgY29uc3QgciA9IGF3YWl0IGNvbXB1dGVQb3J0Zm9saW8ocGYsIFEsIHJhbmdlKTsKICAgICAgcmVzdWx0cy5wdXNoKHIpOwogICAgICB0b3QuaG9sZGluZ3NCYXNlKz1yLmhvbGRpbmdzQmFzZTsgdG90LmNhc2hCYXNlKz1yLmNhc2hCYXNlOyB0b3QuZXF1aXR5QmFzZSs9ci5lcXVpdHlCYXNlOwogICAgICB0b3QuY29zdEJhc2UrPXIuY29zdEJhc2U7IHRvdC51bnJlYWxCYXNlKz1yLnVucmVhbEJhc2U7IHRvdC5kYXlNb3ZlQmFzZSs9ci5kYXlNb3ZlQmFzZTsKICAgICAgdG90LnJlYWxpemVkR3Jvc3NCYXNlKz1yLnJlYWxpemVkR3Jvc3NCYXNlOyB0b3QucmVhbGl6ZWRUYXhCYXNlKz1yLnJlYWxpemVkVGF4QmFzZTsgdG90LnJlYWxpemVkTmV0QmFzZSs9ci5yZWFsaXplZE5ldEJhc2U7CiAgICB9CiAgICBjb25zdCB1bnJlYWxQY3QgPSB0b3QuY29zdEJhc2U+MCA/ICh0b3QudW5yZWFsQmFzZS90b3QuY29zdEJhc2UpIDogbnVsbDsKICAgIHJldHVybiB7YmFzZSwgcmVzdWx0cywgdG90LCB1bnJlYWxQY3R9OwogIH0KCiAgZnVuY3Rpb24gcGFpbnRUb3RhbHMoe2Jhc2UsIHRvdCwgdW5yZWFsUGN0fSl7CiAgICAkKCcjZ28tdG90LWhvbGQnKS50ZXh0Q29udGVudCA9IGZtdE1vbmV5KHRvdC5ob2xkaW5nc0Jhc2UsIGJhc2UpOwogICAgJCgnI2dvLXRvdC1jYXNoJykudGV4dENvbnRlbnQgPSBmbXRNb25leSh0b3QuY2FzaEJhc2UsIGJhc2UpOwogICAgJCgnI2dvLXRvdC1lcScpLnRleHRDb250ZW50ID0gZm10TW9uZXkodG90LmVxdWl0eUJhc2UsIGJhc2UpOwogICAgJCgnI2dvLXRvdC11bnInKS50ZXh0Q29udGVudCA9IGZtdE1vbmV5KHRvdC51bnJlYWxCYXNlLCBiYXNlKTsKICAgIGNvbnN0IHBjdCA9ICQoJyNnby10b3QtdW5yLXBjdCcpOyBwY3QudGV4dENvbnRlbnQgPSB1bnJlYWxQY3Q9PT1udWxsPyfigJQnOih1bnJlYWxQY3QqMTAwKS50b0ZpeGVkKDIpKyclJzsKICAgIHBjdC5jbGFzc05hbWUgPSAnZ28tYmFkZ2UgJyArICh1bnJlYWxQY3Q+MD8nZ28tcG9zJzoodW5yZWFsUGN0PDA/J2dvLW5lZyc6JycpKTsKICAgICQoJyNnby1kYXknKS50ZXh0Q29udGVudCA9ICfOlCBkemllbm55OiAnICsgZm10TW9uZXkodG90LmRheU1vdmVCYXNlLCBiYXNlKTsKICAgICQoJyNnby1yZWFsLWcnKS50ZXh0Q29udGVudCA9IGZtdE1vbmV5KHRvdC5yZWFsaXplZEdyb3NzQmFzZSwgYmFzZSk7CiAgICAkKCcjZ28tcmVhbC10YXgnKS50ZXh0Q29udGVudCA9IGZtdE1vbmV5KHRvdC5yZWFsaXplZFRheEJhc2UsIGJhc2UpOwogICAgJCgnI2dvLXJlYWwtbicpLnRleHRDb250ZW50ID0gZm10TW9uZXkodG90LnJlYWxpemVkTmV0QmFzZSwgYmFzZSk7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJQb3NpdGlvbnNUYWJsZShwb3NpdGlvbnMsIGN1cil7CiAgICBpZighcG9zaXRpb25zIHx8ICFwb3NpdGlvbnMubGVuZ3RoKSByZXR1cm4gYDxkaXYgY2xhc3M9ImdvLW11dGVkIGdvLW1pbmkiPkJyYWsgcG96eWNqaS48L2Rpdj5gOwogICAgY29uc3Qgcm93cyA9IHBvc2l0aW9ucy5tYXAocD0+ewogICAgICBjb25zdCBwbCA9IChwLnZhbHVlIC0gcC5jb3N0KTsKICAgICAgY29uc3QgZHAgPSBpc0Zpbml0ZShwLmRwKSA/IGA8c3BhbiBjbGFzcz0iZ28tYmFkZ2UgJHtwLmRwPj0wPydnby1wb3MnOidnby1uZWcnfSI+JHtOdW1iZXIocC5kcCkudG9GaXhlZCgyKX0lPC9zcGFuPmAgOiAn4oCUJzsKICAgICAgY29uc3QgcGxDbHMgPSBwbD4wPydnby1wb3MnOihwbDwwPydnby1uZWcnOicnKTsKICAgICAgcmV0dXJuIGA8dHI+CiAgICAgICAgPHRkIGNsYXNzPSJnby10aWNrZXIiPiR7ZXNjYXBlSHRtbChwLnRpY2tlcil9PC90ZD4KICAgICAgICA8dGQ+JHtOdW1iZXIocC5xdHkpLnRvRml4ZWQoMil9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShwLmF2ZywgY3VyKX08L3RkPgogICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHAuY29zdCwgY3VyKX08L3RkPgogICAgICAgIDx0ZD4ke2lzRmluaXRlKHAucHJpY2UpP051bWJlcihwLnByaWNlKS50b0ZpeGVkKDIpOifigJQnfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkocC52YWx1ZSwgY3VyKX08L3RkPgogICAgICAgIDx0ZCBjbGFzcz0iJHtwbENsc30iPiR7Zm10TW9uZXkocGwsIGN1cil9PC90ZD4KICAgICAgICA8dGQ+JHtpc0Zpbml0ZShwLmNvc3QpJiZwLmNvc3Q+MD8oKChwLnZhbHVlLXAuY29zdCkvcC5jb3N0KSoxMDApLnRvRml4ZWQoMikrJyUnOifigJQnfTwvdGQ+CiAgICAgICAgPHRkPiR7ZHB9PC90ZD4KICAgICAgPC90cj5gOwogICAgfSkuam9pbignJyk7CiAgICByZXR1cm4gYDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiIHN0eWxlPSJtYXJnaW4tdG9wOjhweCI+CiAgICAgIDx0YWJsZT4KICAgICAgICA8dGhlYWQ+PHRyPjx0aD5UaWNrZXI8L3RoPjx0aD5JbG/Fm8SHPC90aD48dGg+xZpyLiBrb3N6dDwvdGg+PHRoPktvc3p0IHfFgmFzbnk8L3RoPjx0aD5LdXJzPC90aD48dGg+V2FydG/Fm8SHPC90aD48dGg+UC9MPC90aD48dGg+JTwvdGg+PHRoPs6UIGR6aWVubnk8L3RoPjwvdHI+PC90aGVhZD4KICAgICAgICA8dGJvZHk+JHtyb3dzfTwvdGJvZHk+CiAgICAgIDwvdGFibGU+CiAgICA8L2Rpdj5gOwogIH0KICBmdW5jdGlvbiBlc2NhcGVIdG1sKHMpeyBjb25zdCB0PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7IHQudGV4dENvbnRlbnQ9U3RyaW5nKHN8fCcnKTsgcmV0dXJuIHQuaW5uZXJIVE1MOyB9CgogIGZ1bmN0aW9uIGJ1aWxkQWxsUG9zaXRpb25zKHJlc0xpc3QpewogICAgY29uc3Qgcm93cyA9IFtdOwogICAgZm9yIChsZXQgaT0wO2k8cmVzTGlzdC5sZW5ndGg7aSsrKXsgY29uc3QgciA9IHJlc0xpc3RbaV07CiAgICAgIGZvcihjb25zdCBwIG9mIHIucG9zaXRpb25zKXsKICAgICAgICByb3dzLnB1c2goeyB0aWNrZXI6IHAudGlja2VyLCBwZjogci5wZi5uYW1lfHwn4oCUJywgcXR5OiBwLnF0eSwgYXZnOiBwLmF2ZywgY29zdDogcC5jb3N0LAogICAgICAgICAgcHJpY2U6IGlzRmluaXRlKHAucHJpY2UpP3AucHJpY2U6bnVsbCwgdmFsdWU6IHAudmFsdWUsIHBsOiBwLnZhbHVlLXAuY29zdCwKICAgICAgICAgIHBjdDogcC5jb3N0PjA/IChwLnZhbHVlLXAuY29zdCkvcC5jb3N0IDogbnVsbCwgZHA6IGlzRmluaXRlKHAuZHApP3AuZHA6bnVsbCwgY3VycmVuY3k6IHIucGYuY3VycmVuY3l8fCdQTE4nLCBwZklkeDogaQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcm93czsKICB9CgogIGZ1bmN0aW9uIHBhaW50UG9ydGZvbGlvcyhyZXNMaXN0LCBiYXNlKXsKICAgIGNvbnN0IHRib2R5ID0gJCgnI2dvLXBmLWJvZHknKTsgdGJvZHkuaW5uZXJIVE1MPScnOwogICAgaWYoIXJlc0xpc3QubGVuZ3RoKXsgdGJvZHkuaW5uZXJIVE1MID0gJzx0cj48dGQgY29sc3Bhbj0iMTAiIGNsYXNzPSJnby1tdXRlZCI+QnJhayBkYW55Y2jigKY8L3RkPjwvdHI+JzsgcmV0dXJuOyB9CiAgICBmb3IoY29uc3QgciBvZiByZXNMaXN0KXsKICAgICAgY29uc3QgdW5yZWFsQ2xzID0gci51bnJlYWxCYXNlPjAgPyAnZ28tcG9zJyA6IChyLnVucmVhbEJhc2U8MCA/ICdnby1uZWcnIDogJycpOwogICAgICBjb25zdCB0ciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7CiAgICAgIHRyLmlubmVySFRNTCA9IGAKICAgICAgICA8dGQ+PGRldGFpbHM+PHN1bW1hcnk+JHtlc2NhcGVIdG1sKHIucGYubmFtZXx8J+KAlCcpfTwvc3VtbWFyeT4ke3JlbmRlclBvc2l0aW9uc1RhYmxlKHIucG9zaXRpb25zLCByLnBmLmN1cnJlbmN5KX08L2RldGFpbHM+PC90ZD4KICAgICAgICA8dGQ+JHtyLnBmLmN1cnJlbmN5fHwnUExOJ308L3RkPgogICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHIuY2FzaE5hdCwgci5wZi5jdXJyZW5jeSl9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShyLmhvbGRpbmdzTmF0LCByLnBmLmN1cnJlbmN5KX08L3RkPgogICAgICAgIDx0ZD48Yj4ke2ZtdE1vbmV5KHIuZXF1aXR5TmF0LCByLnBmLmN1cnJlbmN5KX08L2I+PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShyLmVxdWl0eUJhc2UsIGJhc2UpfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkoci5jb3N0TmF0LCByLnBmLmN1cnJlbmN5KX08L3RkPgogICAgICAgIDx0ZCBjbGFzcz0iJHt1bnJlYWxDbHN9Ij4ke2ZtdE1vbmV5KHIudW5yZWFsTmF0LCByLnBmLmN1cnJlbmN5KX08L3RkPgogICAgICAgIDx0ZD4ke3IudW5yZWFsUGN0PT09bnVsbD8n4oCUJzooci51bnJlYWxQY3QqMTAwKS50b0ZpeGVkKDIpKyclJ308L3RkPgogICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHIucmVhbGl6ZWROZXROYXQsIHIucGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgIGA7CiAgICAgIHRib2R5LmFwcGVuZENoaWxkKHRyKTsKICAgIH0KICB9CgogIAogIC8vID09PSBFeHBhbmRhYmxlIGRldGFpbHMgZm9yIGFnZ3JlZ2F0ZWQgcG9zaXRpb25zID09PQogIGZ1bmN0aW9uIHJlbmRlclRpY2tlckRldGFpbHMocGYsIHRpY2tlcil7CiAgICB0cnl7CiAgICAgIGZ1bmN0aW9uIHJlYWRMYXN0UHJpY2UodCl7CiAgICAgICAgdHJ5ewogICAgICAgICAgY29uc3Qga2V5ID0gU3RyaW5nKHR8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgY29uc3QgZnJvbUNhY2hlID0gKHdpbmRvdy5fX0dUX1FVT1RFX0NBQ0hFICYmIHdpbmRvdy5fX0dUX1FVT1RFX0NBQ0hFLmdldCkgPyB3aW5kb3cuX19HVF9RVU9URV9DQUNIRS5nZXQoa2V5KSA6IG51bGw7CiAgICAgICAgICBjb25zdCBxID0gZnJvbUNhY2hlICYmIGZyb21DYWNoZS5xID8gZnJvbUNhY2hlLnEgOiBudWxsOwogICAgICAgICAgaWYocSAmJiBpc0Zpbml0ZShxLmMpKSByZXR1cm4gTnVtYmVyKHEuYyk7CiAgICAgICAgfWNhdGNoKF8pe30KICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBLID0gU3RyaW5nKHR8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgY29uc3QgcTIgPSAod2luZG93LlFVT1RFUyAmJiB3aW5kb3cuUVVPVEVTW0tdKSA/IHdpbmRvdy5RVU9URVNbS10gOiBudWxsOwogICAgICAgICAgaWYocTIgJiYgaXNGaW5pdGUocTIucHJpY2UpKSByZXR1cm4gTnVtYmVyKHEyLnByaWNlKTsKICAgICAgICB9Y2F0Y2goXyl7fQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IGJvb2sgPSAocGYgJiYgcGYuaG9sZGluZ3MgJiYgcGYuaG9sZGluZ3NbdGlja2VyXSkgPyBwZi5ob2xkaW5nc1t0aWNrZXJdIDogbnVsbDsKICAgICAgY29uc3QgbG90cyA9IEFycmF5LmlzQXJyYXkoYm9vayAmJiBib29rLmxvdHMpID8gYm9vay5sb3RzIDogW107CiAgICAgIGNvbnN0IGN1ciA9IHBmLmN1cnJlbmN5IHx8ICdQTE4nOwogICAgICBjb25zdCBsYXN0ID0gcmVhZExhc3RQcmljZSh0aWNrZXIpOwogICAgY29uc3Qgcm93cyA9IGxvdHMubWFwKGw9PnsKICAgICAgICBjb25zdCBxdHkgPSBOdW1iZXIobC5xdHkpfHwwOwogICAgICAgIGNvbnN0IHVjICA9IE51bWJlcihsLnVuaXRDb3N0KXx8MDsKICAgICAgICBjb25zdCBjb3N0ID0gcXR5KnVjOwogICAgICAgIGNvbnN0IHByaWNlID0gKGxhc3QhPW51bGwgJiYgaXNGaW5pdGUobGFzdCkpID8gTnVtYmVyKGxhc3QpIDogdWM7CiAgICAgICAgY29uc3QgdmFsID0gcXR5KnByaWNlOwogICAgICAgIGNvbnN0IHBsID0gdmFsIC0gY29zdDsKICAgICAgICBjb25zdCBwY3QgPSBjb3N0PjAgPyAocGwvY29zdCkqMTAwIDogbnVsbDsKICAgICAgICBjb25zdCBkYXRlID0gbC5kYXRlIHx8ICcnOwogICAgICAgIGNvbnN0IG5vdGUgPSBsLm5vdGUgPyBTdHJpbmcobC5ub3RlKSA6ICcnOwogICAgICAgIHJldHVybiBgPHRyPgogICAgICAgICAgPHRkPiR7ZXNjYXBlSHRtbChkYXRlKX08L3RkPgogICAgICAgICAgPHRkPiR7cXR5LnRvRml4ZWQoMil9PC90ZD4KICAgICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHVjLCBjdXIpfTwvdGQ+CiAgICAgICAgICA8dGQ+JHtmbXRNb25leShjb3N0LCBjdXIpfTwvdGQ+CiAgICAgICAgICA8dGQ+JHtpc0Zpbml0ZShwcmljZSk/cHJpY2UudG9GaXhlZCgyKTon4oCUJ308L3RkPgogICAgICAgICAgPHRkPiR7Zm10TW9uZXkodmFsLCBjdXIpfTwvdGQ+CiAgICAgICAgICA8dGQgY2xhc3M9IiR7cGw+MD8nZ28tcG9zJzoocGw8MD8nZ28tbmVnJzonJyl9Ij4ke2ZtdE1vbmV5KHBsLCBjdXIpfTwvdGQ+CiAgICAgICAgICA8dGQ+JHtwY3Q9PT1udWxsPyfigJQnOnBjdC50b0ZpeGVkKDIpKyclJ308L3RkPgogICAgICAgICAgPHRkIGNsYXNzPSJnby1taW5pIj4ke2VzY2FwZUh0bWwobm90ZSl9PC90ZD4KICAgICAgICA8L3RyPmA7CiAgICAgIH0pLmpvaW4oJycpIHx8IGA8dHI+PHRkIGNvbHNwYW49IjkiIGNsYXNzPSJnby1taW5pIGdvLW11dGVkIGNlbnRlciI+QnJhayB0cmFuc2FrY2ppL3BhcnRpaSBkbGEgJHtlc2NhcGVIdG1sKHRpY2tlcil9PC90ZD48L3RyPmA7CgogICAgICByZXR1cm4gYAogICAgICA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj4KICAgICAgICA8dGFibGU+CiAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgIDx0cj48dGg+RGF0YTwvdGg+PHRoPklsb8WbxIc8L3RoPjx0aD5DZW5hIHpha3VwdTwvdGg+PHRoPktvc3p0PC90aD48dGg+S3VyczwvdGg+PHRoPldhcnRvxZvEhzwvdGg+PHRoPlVucmVhbC4gUC9MPC90aD48dGg+JTwvdGg+PHRoPk5vdGF0a2E8L3RoPjwvdHI+CiAgICAgICAgICA8L3RoZWFkPgogICAgICAgICAgPHRib2R5PiR7cm93c308L3Rib2R5PgogICAgICAgIDwvdGFibGU+CiAgICAgIDwvZGl2PmA7CiAgICB9Y2F0Y2goZSl7CiAgICAgIGNvbnNvbGUud2FybigncmVuZGVyVGlja2VyRGV0YWlscyBlcnJvcicsIGUpOwogICAgICByZXR1cm4gYDxkaXYgY2xhc3M9ImdvLW1pbmkgZ28tbXV0ZWQiPkLFgsSFZCBnZW5lcm93YW5pYSBzemN6ZWfDs8WCw7N3LjwvZGl2PmA7CiAgICB9CiAgfQpmdW5jdGlvbiBwYWludFBvc2l0aW9ucyhyZXNMaXN0KXsKICAgIGNvbnN0IHRib2R5ID0gJCgnI2dvLXBvcy1ib2R5Jyk7CiAgICBjb25zdCBmaWx0ZXIgPSAoJCgnI2dvLWZpbHRlcicpLnZhbHVlfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICBjb25zdCByb3dzID0gYnVpbGRBbGxQb3NpdGlvbnMocmVzTGlzdCkuZmlsdGVyKHI9PnsKICAgICAgaWYoIWZpbHRlcikgcmV0dXJuIHRydWU7CiAgICAgIGNvbnN0IHdhbnRHYWluID0gZmlsdGVyLmluY2x1ZGVzKCdaWVNLPjAnKTsKICAgICAgY29uc3Qgd2FudExvc3MgPSBmaWx0ZXIuaW5jbHVkZXMoJ1NUUkFUQT4wJyk7CiAgICAgIGNvbnN0IHBmUXVlcnkgPSAvUEY6KFteICxdKykvLmV4ZWMoZmlsdGVyKTsKICAgICAgY29uc3QgaGFzVGlja2VyID0gci50aWNrZXIudG9VcHBlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXIpIHx8IHIucGYudG9VcHBlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXIpOwogICAgICBjb25zdCBwZk1hdGNoID0gcGZRdWVyeSA/IHIucGYudG9VcHBlckNhc2UoKS5pbmNsdWRlcyhwZlF1ZXJ5WzFdLnRvVXBwZXJDYXNlKCkpIDogdHJ1ZTsKICAgICAgY29uc3QgYnlHYWluID0gd2FudEdhaW4gPyAoci5wbD4wKSA6IHRydWU7CiAgICAgIGNvbnN0IGJ5TG9zcyA9IHdhbnRMb3NzID8gKHIucGw8MCkgOiB0cnVlOwogICAgICByZXR1cm4gKGhhc1RpY2tlciB8fCBwZk1hdGNoKSAmJiBieUdhaW4gJiYgYnlMb3NzOwogICAgfSk7CgogICAgdGJvZHkuaW5uZXJIVE1MPScnOwogICAgaWYoIXJvd3MubGVuZ3RoKXsgdGJvZHkuaW5uZXJIVE1MPSc8dHI+PHRkIGNvbHNwYW49IjEwIiBjbGFzcz0iZ28tbXV0ZWQiPkJyYWsgcG96eWNqaeKApjwvdGQ+PC90cj4nOyByZXR1cm47IH0KICAgIGZvcihjb25zdCByIG9mIHJvd3MpewogICAgICBjb25zdCBwbENscyA9IHIucGw+MD8nZ28tcG9zJzooci5wbDwwPydnby1uZWcnOicnKTsKICAgICAgY29uc3QgZHAgPSByLmRwPT09bnVsbCA/ICfigJQnIDogYDxzcGFuIGNsYXNzPSJnby1iYWRnZSAke3IuZHA+PTA/J2dvLXBvcyc6J2dvLW5lZyd9Ij4ke051bWJlcihyLmRwKS50b0ZpeGVkKDIpfSU8L3NwYW4+YDsKICAgICAgY29uc3QgdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOwogICAgICB0ci5pbm5lckhUTUwgPSBgCiAgICAgICAgPHRkIGNsYXNzPSJnby10aWNrZXIiPiR7ZXNjYXBlSHRtbChyLnRpY2tlcil9PC90ZD4KICAgICAgICA8dGQ+JHtlc2NhcGVIdG1sKHIucGYpfTwvdGQ+CiAgICAgICAgPHRkPiR7TnVtYmVyKHIucXR5KS50b0ZpeGVkKDIpfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkoci5hdmcsIHIuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkoci5jb3N0LCByLmN1cnJlbmN5KX08L3RkPgogICAgICAgIDx0ZD4ke3IucHJpY2U9PT1udWxsPyfigJQnOk51bWJlcihyLnByaWNlKS50b0ZpeGVkKDIpfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkoci52YWx1ZSwgci5jdXJyZW5jeSl9PC90ZD4KICAgICAgICA8dGQgY2xhc3M9IiR7cGxDbHN9Ij4ke2ZtdE1vbmV5KHIucGwsIHIuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkPiR7ci5wY3Q9PT1udWxsPyfigJQnOihyLnBjdCoxMDApLnRvRml4ZWQoMikrJyUnfTwvdGQ+CiAgICAgICAgPHRkPiR7ZHB9PC90ZD4KICAgICAgYDsKICAgICAgdGJvZHkuYXBwZW5kQ2hpbGQodHIpOwogICAgCiAgICAgIC8vIGF0dGFjaCBleHBhbmQtb24tY2xpY2sgZm9yIGRldGFpbHMKICAgICAgdHIuZGF0YXNldC50aWNrZXIgPSByLnRpY2tlcjsKICAgICAgdHIuZGF0YXNldC5wZklkeCA9IFN0cmluZyhyLnBmSWR4ID8/IC0xKTsKICAgICAgdHIuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICB0ci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGV2KXsKICAgICAgICBpZihldi50YXJnZXQgJiYgKGV2LnRhcmdldC5jbG9zZXN0KCdidXR0b24nKSB8fCBldi50YXJnZXQuY2xvc2VzdCgnYScpKSkgcmV0dXJuOwogICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdHIubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgICAgIGlmKGV4aXN0aW5nICYmIGV4aXN0aW5nLmNsYXNzTGlzdC5jb250YWlucygnZ28tZGV0YWlsLXJvdycpKXsKICAgICAgICAgIGV4aXN0aW5nLnJlbW92ZSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBpZHggPSBOdW1iZXIodHIuZGF0YXNldC5wZklkeCk7CiAgICAgICAgY29uc3QgdGlja2VyID0gdHIuZGF0YXNldC50aWNrZXI7CiAgICAgICAgY29uc3QgcGYgPSAocmVzTGlzdCAmJiBpZHg+PTAgJiYgcmVzTGlzdFtpZHhdKSA/IHJlc0xpc3RbaWR4XS5wZiA6IG51bGw7CiAgICAgICAgY29uc3QgZGV0YWlsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKTsKICAgICAgICBkZXRhaWwuY2xhc3NOYW1lID0gJ2dvLWRldGFpbC1yb3cnOwogICAgICAgIGNvbnN0IGNvbFNwYW4gPSB0ci5jaGlsZHJlbi5sZW5ndGg7CiAgICAgICAgZGV0YWlsLmlubmVySFRNTCA9IGA8dGQgY29sc3Bhbj0iJHtjb2xTcGFufSIgc3R5bGU9ImJhY2tncm91bmQ6cmdiYSgxNDgsMTYzLDE4NCwuMDgpO3BhZGRpbmc6OHB4IDEycHg7Ym9yZGVyLXRvcDoxcHggZGFzaGVkICMzMzQxNTUiPgogICAgICAgICAgJHtyZW5kZXJUaWNrZXJEZXRhaWxzKHBmLCB0aWNrZXIpfQogICAgICAgIDwvdGQ+YDsKICAgICAgICB0ci5hZnRlcihkZXRhaWwpOwogICAgICB9KTsKICAgIH0KICAgIAogIH0KCgogIAogIC8qID09PSBbR08gRXh0cmEgU3RhdHNdIGF2ZyBob2xkaW5nIHRpbWUgJiBhdmcgJSBwcm9maXQgcGVyIHBvc2l0aW9uIChjbG9zZWQgdHJhZGVzKSDigJQgUk9CVVNUIChyZXBsYXkpID09PSAqLwogIGZ1bmN0aW9uIGNvbXB1dGVDbG9zZWRUcmFkZVN0YXRzKHJhbmdlKXsKICB0cnl7IFNULnRwQ291bnQgPSAwOyB9Y2F0Y2goXyl7fQogICAgdHJ5ewogICAgICAvLyBQcmVmZXIgYXBwIGNvbnRleHQgU1QuREIgKHVzZWQgdyBHbG9iYWwgT3ZlcnZpZXcpLCBmYWxsYmFjayB0byBEQi93aW5kb3cuREIKICAgICAgY29uc3QgREJjdHggPSAodHlwZW9mIFNUIT09J3VuZGVmaW5lZCcgJiYgU1QgJiYgU1QuREIpID8gU1QuREIKICAgICAgICAgICAgICAgICAgOiAoKHR5cGVvZiBEQiE9PSd1bmRlZmluZWQnICYmIERCKSA/IERCIDogKHdpbmRvdy5EQnx8e30pKTsKICAgICAgY29uc3QgcG9ydGZvbGlvcyA9IEFycmF5LmlzQXJyYXkoREJjdHgucG9ydGZvbGlvcykgPyBEQmN0eC5wb3J0Zm9saW9zIDogW107CiAgICAgIGxldCBzYW1wbGVzID0gMCwgc3VtRGF5cyA9IDAsIHN1bVBjdCA9IDA7IGxldCB0cENvdW50VHggPSAwOy8vIEhlbHBlciB0byBwYXJzZSBkYXRlIHNhZmVseQogICAgICBjb25zdCB0b01zID0gKGQpPT57CiAgICAgICAgdHJ5ewogICAgICAgICAgaWYoIWQpIHJldHVybiBOYU47CiAgICAgICAgICAvLyBBY2NlcHQgSVNPIHN0cmluZyBvciBEYXRlIG9iamVjdCBvciBGaXJlc3RvcmUgdGltZXN0YW1wLWxpa2Uge3NlY29uZHN9CiAgICAgICAgICBpZiAoZCBpbnN0YW5jZW9mIERhdGUpIHJldHVybiBkLmdldFRpbWUoKTsKICAgICAgICAgIGlmICh0eXBlb2YgZCA9PT0gJ29iamVjdCcgJiYgZCAhPT0gbnVsbCAmJiBOdW1iZXIuaXNGaW5pdGUoZC5zZWNvbmRzKSkgcmV0dXJuIGQuc2Vjb25kcyoxMDAwOwogICAgICAgICAgY29uc3QgbXMgPSBEYXRlLnBhcnNlKGQpOwogICAgICAgICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShtcykgPyBtcyA6IE5hTjsKICAgICAgICB9Y2F0Y2goXyl7IHJldHVybiBOYU47IH0KICAgICAgfTsKCiAgICAgIC8vIEl0ZXJhdGUgZWFjaCBwb3J0Zm9saW8gaW5kZXBlbmRlbnRseQogICAgICBmb3IoY29uc3QgcGYgb2YgcG9ydGZvbGlvcyl7CiAgICAgICAgaWYoIXBmKSBjb250aW51ZTsKICAgICAgICBjb25zdCB0eHMgPSBBcnJheS5pc0FycmF5KHBmLnRyYW5zYWN0aW9ucykgPyBwZi50cmFuc2FjdGlvbnMuc2xpY2UoKSA6IFtdOwogICAgICAgIC8vIENIUk9OT0xPR0lDQUwgKG9sZGVzdCAtPiBuZXdlc3QpCiAgICAgICAgY29uc3QgY2hyb25vID0gdHhzLnJldmVyc2UoKTsKCiAgICAgICAgLy8gTWluaW1hbCBpbi1tZW1vcnkgaG9sZGluZ3MgYm9vayBwZXIgdGlja2VyOiBGSUZPIHF1ZXVlIG9mIGxvdHMge2xvdElkLCBkYXRlTXMsIHVuaXRDb3N0LCBxdHl9CiAgICAgICAgY29uc3QgYm9vayA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogICAgICAgIC8vIFByZS1pbmRleCBidXkgaW5mbyBieSBsb3RJZCBmb3IgZmFzdCBsb29rdXAgd2hlbiBsb3RMaW5rcyBleGlzdAogICAgICAgIGNvbnN0IGJ1eUlkeCA9IG5ldyBNYXAoKTsKCiAgICAgICAgY29uc3QgcHVzaExvdCA9ICh0aWNrZXIsIGxvdElkLCBkYXRlVmFsLCB1bml0Q29zdCwgcXR5KT0+ewogICAgICAgICAgY29uc3QgZGF0ZU1zID0gdG9NcyhkYXRlVmFsKTsKICAgICAgICAgIGlmKCFOdW1iZXIuaXNGaW5pdGUoZGF0ZU1zKSB8fCAhTnVtYmVyLmlzRmluaXRlKHVuaXRDb3N0KSB8fCB1bml0Q29zdDw9MCB8fCAhTnVtYmVyLmlzRmluaXRlKHF0eSkgfHwgcXR5PD0wKSByZXR1cm47CiAgICAgICAgICBjb25zdCB0ID0gKHRpY2tlcnx8JycpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOyBpZighdCkgcmV0dXJuOwogICAgICAgICAgKGJvb2tbdF0gfHw9IFtdKS5wdXNoKHtsb3RJZCwgZGF0ZU1zLCB1bml0Q29zdCwgcXR5fSk7CiAgICAgICAgICBidXlJZHguc2V0KGxvdElkLCB7ZGF0ZU1zLCB1bml0Q29zdH0pOyAvLyBhbHNvIGluZGV4CiAgICAgICAgfTsKCiAgICAgICAgZm9yKGNvbnN0IHR4IG9mIGNocm9ubyl7CiAgICAgICAgICBpZighdHggfHwgIXR4LnR5cGUpIGNvbnRpbnVlOwogICAgICAgICAgY29uc3QgdCA9IHR4LnR5cGU7CiAgICAgICAgICBpZih0PT09J2J1eScpewogICAgICAgICAgICBjb25zdCBxdHkgID0gTnVtYmVyKHR4LnF0eSl8fDA7CiAgICAgICAgICAgIGNvbnN0IHByaWNlPSBOdW1iZXIodHgucHJpY2UpfHwwOwogICAgICAgICAgICBjb25zdCBmZWVzID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogICAgICAgICAgICBjb25zdCBsb3RJZD0gdHgubG90SWQgfHwgKHR4LmlkID8gYGxvdF8ke3R4LmlkfWAgOiBudWxsKTsKICAgICAgICAgICAgY29uc3QgdW5pdENvc3QgPSBxdHk+MCA/IChwcmljZSArIGZlZXMvTWF0aC5tYXgocXR5LDEpKSA6IHByaWNlOwogICAgICAgICAgICBwdXNoTG90KHR4LnRpY2tlciwgbG90SWQsIHR4LmRhdGUsIHVuaXRDb3N0LCBxdHkpOwogICAgICAgICAgfWVsc2UgaWYodD09PSd0cmFuc2Zlcl9jb21wYW55X2luJyl7CiAgICAgICAgICAgIGNvbnN0IHF0eSAgPSBOdW1iZXIodHgucXR5KXx8MDsKICAgICAgICAgICAgY29uc3QgbG90SWQ9IHR4Lm5ld0xvdElkIHx8IHR4LmxvdElkIHx8ICh0eC5pZCA/IGBsb3RfJHt0eC5pZH1gIDogbnVsbCk7CiAgICAgICAgICAgIGNvbnN0IHVuaXRDb3N0ID0gTnVtYmVyKHR4LnVuaXRDb3N0ID8/IHR4LnByaWNlID8/IDApOwogICAgICAgICAgICBwdXNoTG90KHR4LnRpY2tlciwgbG90SWQsIHR4LmRhdGUsIHVuaXRDb3N0LCBxdHkpOwogICAgICAgICAgfWVsc2UgaWYodD09PSdzZWxsJyl7CiAgICAgICAgICAgIC8vIENvdW50IFRQIGFzIDEgcGVyIFNFTEwgdHJhbnNhY3Rpb24gKHdpdGhpbiBzZWxlY3RlZCBwZXJpb2QpCiAgICAgICAgICAgIHRyeXsgaWYoaW5SYW5nZU1zKHRvTXModHguZGF0ZSksIHJhbmdlKSkgdHBDb3VudFR4Kys7IH1jYXRjaChfKXsvKm5vb3AqL30KCiAgICAgICAgICAgIC8vIENvdW50IFRQIGFzIDEgcGVyIFNFTEwgdHJhbnNhY3Rpb24gKHdpdGhpbiBzZWxlY3RlZCBwZXJpb2QpCiAgICAgICAgICAgIHRyeXsgaWYoaW5SYW5nZU1zKHRvTXModHguZGF0ZSksIHJhbmdlKSkgdHBDb3VudFR4Kys7IH1jYXRjaChfKXsvKm5vb3AqL30KCiAgICAgICAgICAgIGNvbnN0IHRpY2tlciA9ICh0eC50aWNrZXJ8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgY29uc3Qgc2VsbERhdGVNcyA9IHRvTXModHguZGF0ZSk7CiAgICAgICAgICAgIGNvbnN0IHNlbGxQcmljZSAgPSBOdW1iZXIodHgucHJpY2UgPz8gdHguc2VsbFByaWNlID8/IDApOwogICAgICAgICAgICBsZXQgcmVtYWluaW5nUXR5ID0gTnVtYmVyKHR4LnF0eSl8fDA7CiAgICAgICAgICAgIGlmKCF0aWNrZXIgfHwgIU51bWJlci5pc0Zpbml0ZShzZWxsRGF0ZU1zKSB8fCAhTnVtYmVyLmlzRmluaXRlKHNlbGxQcmljZSkgfHwgc2VsbFByaWNlPD0wKSBjb250aW51ZTsKCiAgICAgICAgICAgIC8vIDEpIFByZWZlciBwcmVjaXNlIGFsbG9jYXRpb25zIGlmIHRoZXkgZXhpc3QKICAgICAgICAgICAgY29uc3QgbGlua3MgPSBBcnJheS5pc0FycmF5KHR4LmxvdExpbmtzKSA/IHR4LmxvdExpbmtzIDogW107CiAgICAgICAgICAgIGlmKGxpbmtzLmxlbmd0aD4wKXsKICAgICAgICAgICAgICBmb3IoY29uc3QgbGluayBvZiBsaW5rcyl7CiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gbGluayA/IGJ1eUlkeC5nZXQobGluay5sb3RJZCkgOiBudWxsOwogICAgICAgICAgICAgICAgaWYoIWluZm8gfHwgIU51bWJlci5pc0Zpbml0ZShpbmZvLmRhdGVNcykgfHwgIU51bWJlci5pc0Zpbml0ZShpbmZvLnVuaXRDb3N0KSB8fCBpbmZvLnVuaXRDb3N0PD0wKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGRheXMgPSBNYXRoLm1heCgwLCAoc2VsbERhdGVNcyAtIGluZm8uZGF0ZU1zKS84NjQwMDAwMCk7CiAgICAgICAgICAgICAgICBjb25zdCBwY3QgID0gKChzZWxsUHJpY2UgLSBpbmZvLnVuaXRDb3N0KS9pbmZvLnVuaXRDb3N0KSoxMDA7CiAgICAgICAgICAgICAgICBpZighaW5SYW5nZU1zKHNlbGxEYXRlTXMgPz8gdG9Ncyh0eC5kYXRlKSwgcmFuZ2UpKSB7IC8qIHNraXAgb3V0LW9mLXJhbmdlICovIH0gZWxzZSB7IHN1bURheXMgKz0gZGF5czsgc3VtUGN0ICs9IHBjdDsgc2FtcGxlcyArPSAxOyAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsgLy8gZG9uZSB3aXRoIHRoaXMgc2VsbAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyKSBGYWxsYmFjazogcmVjb25zdHJ1Y3QgRklGTyBmcm9tIGN1cnJlbnQgYm9vawogICAgICAgICAgICBjb25zdCBxbG90cyA9IGJvb2tbdGlja2VyXSB8fCBbXTsKICAgICAgICAgICAgbGV0IG5lZWQgPSBNYXRoLm1heCgwLCByZW1haW5pbmdRdHkpOwogICAgICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgICAgIHdoaWxlKG5lZWQ+MCAmJiBpPHFsb3RzLmxlbmd0aCl7CiAgICAgICAgICAgICAgY29uc3QgbG90ID0gcWxvdHNbaV07CiAgICAgICAgICAgICAgY29uc3QgdGFrZSA9IE1hdGgubWluKG5lZWQsIGxvdC5xdHkpOwogICAgICAgICAgICAgIGlmKHRha2U+MCAmJiBOdW1iZXIuaXNGaW5pdGUobG90LmRhdGVNcykgJiYgTnVtYmVyLmlzRmluaXRlKGxvdC51bml0Q29zdCkgJiYgbG90LnVuaXRDb3N0PjApewogICAgICAgICAgICAgICAgY29uc3QgZGF5cyA9IE1hdGgubWF4KDAsIChzZWxsRGF0ZU1zIC0gbG90LmRhdGVNcykvODY0MDAwMDApOwogICAgICAgICAgICAgICAgY29uc3QgcGN0ICA9ICgoc2VsbFByaWNlIC0gbG90LnVuaXRDb3N0KS9sb3QudW5pdENvc3QpKjEwMDsKICAgICAgICAgICAgICAgIGlmKCFpblJhbmdlTXMoc2VsbERhdGVNcyA/PyB0b01zKHR4LmRhdGUpLCByYW5nZSkpIHsgLyogc2tpcCBvdXQtb2YtcmFuZ2UgKi8gfSBlbHNlIHsgc3VtRGF5cyArPSBkYXlzOyBzdW1QY3QgKz0gcGN0OyBzYW1wbGVzICs9IDE7ICB9CiAgICAgICAgICAgICAgICBsb3QucXR5IC09IHRha2U7CiAgICAgICAgICAgICAgICBuZWVkIC09IHRha2U7CiAgICAgICAgICAgICAgICBpZihsb3QucXR5PD0wKXsgaSsrOyB9CiAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBpKys7IC8vIHNraXAgYnJva2VuIGxvdAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBSZW1vdmUgZGVwbGV0ZWQgbG90cwogICAgICAgICAgICBpZihpPjApIGJvb2tbdGlja2VyXSA9IHFsb3RzLnNsaWNlKGkpLmZpbHRlcihMPT5MLnF0eT4wKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7IGF2Z0RheXM6IHNhbXBsZXMgPyAoc3VtRGF5cy9zYW1wbGVzKSA6IG51bGwsIGF2Z1BjdDogc2FtcGxlcyA/IChzdW1QY3Qvc2FtcGxlcykgOiBudWxsLCBzYW1wbGVzLCB0cENvdW50VHggfTsKICAgIH1jYXRjaChlKXsKICAgICAgY29uc29sZS53YXJuKCdbR09dIGNvbXB1dGVDbG9zZWRUcmFkZVN0YXRzIChyb2J1c3QpIGZhaWxlZCcsIGUpOwogICAgICByZXR1cm4geyBhdmdEYXlzOiBudWxsLCBhdmdQY3Q6IG51bGwsIHNhbXBsZXM6IDAsIHRwQ291bnRUeDogMCB9OwogICAgfQogIH0KICBmdW5jdGlvbiBwYWludEV4dHJhU3RhdHMoc3RhdHMpewogICAgdHJ5ewogICAgICBjb25zdCBlbEggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tYXZnLWhvbGQnKTsKICAgICAgY29uc3QgZWxQID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWF2Zy1wY3QnKTsKICAgICAgaWYoZWxIKXsgZWxILnRleHRDb250ZW50ID0gKHN0YXRzICYmIE51bWJlci5pc0Zpbml0ZShzdGF0cy5hdmdEYXlzKSkgPyAoTnVtYmVyKHN0YXRzLmF2Z0RheXMpLnRvRml4ZWQoMSkrJyBkJykgOiAn4oCUJzsgfQogICAgICBpZihlbFApeyBlbFAudGV4dENvbnRlbnQgPSAoc3RhdHMgJiYgTnVtYmVyLmlzRmluaXRlKHN0YXRzLmF2Z1BjdCkpICA/IChOdW1iZXIoc3RhdHMuYXZnUGN0KS50b0ZpeGVkKDIpKyclJykgOiAn4oCUJzsgfQogICAgICBpZihzdGF0cyAmJiBzdGF0cy5zYW1wbGVzPT09MCl7CiAgICAgICAgaWYoZWxIKSBlbEgudGl0bGUgPSAnQnJhayB6YW1rbmnEmXR5Y2ggdHJhbnNha2NqaSBkbyB3eWxpY3plbmlhIGx1YiBicmFrIGRvcGFzb3dhxYQnOwogICAgICAgIGlmKGVsUCkgZWxQLnRpdGxlID0gJ0JyYWsgemFta25pxJl0eWNoIHRyYW5zYWtjamkgZG8gd3lsaWN6ZW5pYSBsdWIgYnJhayBkb3Bhc293YcWEJzsKICAgICAgfQogICAgfWNhdGNoKF8pe30KICB9CiAgLy8gRmFsbGJhY2svcm9idXN0IFRQIGNvdW50ZXI6IGNvdW50cyBTRUxMIHRyYW5zYWN0aW9ucyB3aXRoaW4gcmFuZ2UgZGlyZWN0bHkgZnJvbSBEQgogIGZ1bmN0aW9uIGNvdW50U2VsbFR4SW5SYW5nZShEQmN0eCwgcmFuZ2UpewogICAgdHJ5ewogICAgICBjb25zdCBkYiA9IERCY3R4IHx8ICh3aW5kb3cuU1QgJiYgU1QuREIpIHx8IHdpbmRvdy5EQiB8fCB7fTsKICAgICAgY29uc3QgcGZzID0gQXJyYXkuaXNBcnJheShkYi5wb3J0Zm9saW9zKSA/IGRiLnBvcnRmb2xpb3MgOiBbXTsKICAgICAgbGV0IG4gPSAwOwogICAgICBmb3IoY29uc3QgcGYgb2YgcGZzKXsKICAgICAgICBjb25zdCB0eHMgPSBBcnJheS5pc0FycmF5KHBmLnRyYW5zYWN0aW9ucykgPyBwZi50cmFuc2FjdGlvbnMgOiBbXTsKICAgICAgICBmb3IoY29uc3QgdHggb2YgdHhzKXsKICAgICAgICAgIGlmKHR4ICYmIHR4LnR5cGUgPT09ICdzZWxsJyl7CiAgICAgICAgICAgIGNvbnN0IGQgPSBEYXRlLnBhcnNlKHR4LmRhdGUgfHwgJycpOwogICAgICAgICAgICBpZihOdW1iZXIuaXNGaW5pdGUoZCkgJiYgKCFyYW5nZSB8fCAoZCA+PSAocmFuZ2Uuc3RhcnQgPz8gLUluZmluaXR5KSAmJiBkIDw9IChyYW5nZS5lbmQgPz8gSW5maW5pdHkpKSkpewogICAgICAgICAgICAgIG4rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbjsKICAgIH1jYXRjaChfKXsgcmV0dXJuIDA7IH0KICB9Ci8vID09PSBbR09dIExJTklPV1kgV1lLUkVTOiBXa8WCYWQgKGJsdWUpIHZzIFdhcnRvxZvEhyAoZ3JlZW4pID09PT09PT09PT09PT09PT09PT09PQpsZXQgX19HT19DSEFSVF9DQUNIRSA9IG51bGw7CmZ1bmN0aW9uIF9fZ29fdG9NcyhkKXsgdHJ5eyBpZih0eXBlb2YgZCA9PT0gJ251bWJlcicpIHJldHVybiBkOyByZXR1cm4gRGF0ZS5wYXJzZShkIHx8ICcxOTcwLTAxLTAxJyk7IH1jYXRjaChfKXsgcmV0dXJuIDA7IH0gfQpmdW5jdGlvbiBfX2dvX2Zsb29yRGF5KG1zKXsgY29uc3QgZHQgPSBuZXcgRGF0ZShtcyk7IGR0LnNldEhvdXJzKDAsMCwwLDApOyByZXR1cm4gZHQuZ2V0VGltZSgpOyB9CmZ1bmN0aW9uIF9fZ29fZm10KGQpeyB0cnl7IHJldHVybiBuZXcgRGF0ZShkKS50b0xvY2FsZURhdGVTdHJpbmcoKTsgfWNhdGNoKF8peyByZXR1cm4gU3RyaW5nKGQpOyB9IH0KZnVuY3Rpb24gX19nb19zdW0oYSl7IHJldHVybiAoYXx8W10pLnJlZHVjZSgoeCx5KT0+eCsoK3l8fDApLDApOyB9CgpmdW5jdGlvbiBfX2dvX3dhcChsb3RzKXsKICB0cnl7CiAgICBpZighQXJyYXkuaXNBcnJheShsb3RzKSB8fCAhbG90cy5sZW5ndGgpIHJldHVybiAwOwogICAgbGV0IHNRdHk9MCwgc1ZhbD0wOwogICAgZm9yKGNvbnN0IGwgb2YgbG90cyl7IGNvbnN0IHE9TnVtYmVyKGwucXR5KXx8MCwgcD1OdW1iZXIobC5wcmljZSl8fDA7IHNRdHkrPXE7IHNWYWwrPXEqcDsgfQogICAgcmV0dXJuIHNRdHk+MCA/IChzVmFsL3NRdHkpIDogMDsKICB9Y2F0Y2goXyl7IHJldHVybiAwOyB9Cn0KCgphc3luYyBmdW5jdGlvbiBjb21wdXRlR2xvYmFsTGluZVNlcmllcyhRLCBwZXJpb2RSYW5nZSwgYmFzZSl7CiAgY29uc3Qgc3RhcnRNcyA9IF9fZ29fZmxvb3JEYXkocGVyaW9kUmFuZ2Uuc3RhcnQpOwogIGNvbnN0IGVuZE1zICAgPSBfX2dvX2Zsb29yRGF5KHBlcmlvZFJhbmdlLmVuZCk7CiAgY29uc3Qgc2VyaWVzQmx1ZSA9IFtdOyAvLyB3a8WCYWQKICBjb25zdCBzZXJpZXNHcmVlbiA9IFtdOyAvLyBlcXVpdHkKICBjb25zdCBwZlN0YXRlcyA9IG5ldyBNYXAoKTsgIC8vIHBmLmlkIC0+IHsgY2FzaCwgaG9sZGluZ3M6IHsgVEtSOiB7cXR5fSB9IH0KICBjb25zdCBwZkZ4ID0gbmV3IE1hcCgpOyAgICAgIC8vIHBmLmlkIC0+IGZ4IHRvIGJhc2UKICBjb25zdCBhbGxUeCA9IFtdOwoKICAvLyBDb2xsZWN0ICYgcHJlcGFyZQogIGZvcihjb25zdCBwZiBvZiAoU1QuREI/LnBvcnRmb2xpb3N8fFtdKSl7CiAgICBwZlN0YXRlcy5zZXQocGYuaWR8fHBmLm5hbWV8fHBmLnRpY2tlcnx8TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiksIHsgY2FzaDogMCwgaG9sZGluZ3M6IHt9IH0pOwogICAgY29uc3QgZnggPSBhd2FpdCBlbnN1cmVGeChwZi5jdXJyZW5jeXx8J1BMTicsIGJhc2UpOwogICAgcGZGeC5zZXQocGYuaWR8fHBmLm5hbWV8fHBmLnRpY2tlciwgZngpOwogICAgY29uc3QgdHhzID0gKHBmLnRyYW5zYWN0aW9uc3x8W10pLm1hcCh0PT4oey4uLnQsIF9fcGY6IHBmfSkpOwogICAgYWxsVHgucHVzaCguLi50eHMpOwogIH0KICAvLyBTb3J0IGFzY2VuZGluZyBieSBkYXRlCiAgYWxsVHguc29ydCgoYSxiKT0+IF9fZ29fdG9NcyhhLmRhdGUpIC0gX19nb190b01zKGIuZGF0ZSkpOwoKICAvLyBIZWxwZXJzIHRoYXQgcmV1c2UgZXhpc3RpbmcgZW5naW5lCiAgZnVuY3Rpb24gZXF1aXR5Tm93KCl7CiAgICBsZXQgdG90YWwgPSAwOwogICAgZm9yKGNvbnN0IHBmIG9mIChTVC5EQj8ucG9ydGZvbGlvc3x8W10pKXsKICAgICAgY29uc3Qgc3QgPSBwZlN0YXRlcy5nZXQocGYuaWR8fHBmLm5hbWV8fHBmLnRpY2tlcik7CiAgICAgIGNvbnN0IGZ4ID0gcGZGeC5nZXQocGYuaWR8fHBmLm5hbWV8fHBmLnRpY2tlcikgfHwgMTsKICAgICAgdG90YWwgKz0gKHN0LmNhc2h8fDApICogZng7CiAgICAgIGZvcihjb25zdCBbdGssIGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHN0LmhvbGRpbmdzfHx7fSkpewogICAgICAgIGxldCBwcmljZSA9IChRW3RrXT8ucHJpY2UgPz8gMCk7CiAgICAgICAgaWYoIShwcmljZT4wKSl7CiAgICAgICAgICBjb25zdCBsb3RzID0gKGJvb2sgJiYgQXJyYXkuaXNBcnJheShib29rLmxvdHMpKSA/IGJvb2subG90cyA6IFtdOwogICAgICAgICAgY29uc3Qgd2FwID0gX19nb193YXAobG90cyk7CiAgICAgICAgICBwcmljZSA9IHdhcD4wID8gd2FwIDogMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcXR5ID0gKGJvb2sgJiYgQXJyYXkuaXNBcnJheShib29rLmxvdHMpICYmIGJvb2subG90cy5sZW5ndGgpCiAgICAgICAgICA/IF9fZ29fc3VtKGJvb2subG90cy5tYXAobD0+ICtsLnF0eXx8MCkpCiAgICAgICAgICA6IE51bWJlcigoYm9vayYmYm9vay5xdHkpfHwwKTsKICAgICAgICB0b3RhbCArPSBxdHkgKiBwcmljZSAqIGZ4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdG90YWw7CiAgfQogIGZ1bmN0aW9uIGFwcGx5VHhUb1N0YXRlKHR4KXsKICAgIGNvbnN0IHBmID0gdHguX19wZjsKICAgIGNvbnN0IHN0ID0gcGZTdGF0ZXMuZ2V0KHBmLmlkfHxwZi5uYW1lfHxwZi50aWNrZXIpOwogICAgaWYoIXN0KSByZXR1cm47CiAgICAvLyBjYXNoLW9ubHkgZmxvd3MKICAgIGlmKHR4LnR5cGU9PT0iZGVwb3NpdCIgfHwgdHgudHlwZT09PSJ3aXRoZHJhdyIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9pbiIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9vdXQiKXsKICAgICAgKHR5cGVvZiBhcHBseUNhc2g9PT0nZnVuY3Rpb24nID8gYXBwbHlDYXNoIDogX19nb19hcHBseUNhc2hTaGltKShzdCwgdHgudHlwZSwgdHguYW1vdW50fHwwKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYodHgudHlwZT09PSJidXkiKXsgdHJ5eyBpZih0eXBlb2YgZW5zdXJlQnV5TG90SWRJblR4PT09J2Z1bmN0aW9uJykgZW5zdXJlQnV5TG90SWRJblR4KHR4KTt9Y2F0Y2goXyl7fTsgKHR5cGVvZiBhcHBseUJ1eT09PSdmdW5jdGlvbicgPyBhcHBseUJ1eSA6IF9fZ29fYXBwbHlCdXkpKHN0LCBwZiwgdHgpOyByZXR1cm47IH0KICAgIGlmKHR4LnR5cGU9PT0ic2VsbCIpeyAodHlwZW9mIGFwcGx5U2VsbD09PSdmdW5jdGlvbicgPyBhcHBseVNlbGwgOiBfX2dvX2FwcGx5U2VsbCkoc3QsIHBmLCB0eCk7IHJldHVybjsgfQogICAgaWYodHgudHlwZT09PSJ0cmFuc2Zlcl9jb21wYW55X2luIil7ICh0eXBlb2YgYXBwbHlUcmFuc2ZlckNvbXBhbnlJbj09PSdmdW5jdGlvbicgPyBhcHBseVRyYW5zZmVyQ29tcGFueUluIDogX19nb19hcHBseVRyYW5zZmVyQ29tcGFueUluKShzdCwgcGYsIHR4KTsgcmV0dXJuOyB9CiAgICBpZih0eC50eXBlPT09InRyYW5zZmVyX2NvbXBhbnlfb3V0Iil7ICh0eXBlb2YgYXBwbHlUcmFuc2ZlckNvbXBhbnlPdXQ9PT0nZnVuY3Rpb24nID8gYXBwbHlUcmFuc2ZlckNvbXBhbnlPdXQgOiBfX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55T3V0KShzdCwgcGYsIHR4KTsgcmV0dXJuOyB9CiAgICAvLyBpZ25vcmUgdW5rbm93bnMKICB9CgogIC8vIEJ1aWxkIGJhc2VsaW5lIHVwIHRvIHN0YXJ0CiAgbGV0IHdrxYJhZEJhc2UgPSAwOwogIGZvcihjb25zdCB0eCBvZiBhbGxUeCl7CiAgICBjb25zdCB0bXMgPSBfX2dvX3RvTXModHguZGF0ZSk7CiAgICBpZih0bXMgPCBzdGFydE1zKXsKICAgICAgLy8gY29udHJpYnV0aW9ucwogICAgICBpZih0eC50eXBlPT09ImRlcG9zaXQiIHx8IHR4LnR5cGU9PT0idHJhbnNmZXJfaW4iKXsKICAgICAgICB3a8WCYWRCYXNlICs9IChOdW1iZXIodHguYW1vdW50KXx8MCkgKiAocGZGeC5nZXQodHguX19wZi5pZCl8fDEpOwogICAgICB9ZWxzZSBpZih0eC50eXBlPT09IndpdGhkcmF3IiB8fCB0eC50eXBlPT09InRyYW5zZmVyX291dCIpewogICAgICAgIHdrxYJhZEJhc2UgLT0gKE51bWJlcih0eC5hbW91bnQpfHwwKSAqIChwZkZ4LmdldCh0eC5fX3BmLmlkKXx8MSk7CiAgICAgIH0KICAgICAgYXBwbHlUeFRvU3RhdGUodHgpOwogICAgfWVsc2V7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICAvLyBTbmFwc2hvdCBhdCBzdGFydAogIHNlcmllc0JsdWUucHVzaCh7IHg6c3RhcnRNcywgeTogd2vFgmFkQmFzZSB9KTsKICBzZXJpZXNHcmVlbi5wdXNoKHsgeDpzdGFydE1zLCB5OiBlcXVpdHlOb3coKSB9KTsKCiAgLy8gQXBwbHkgaW4tcmFuZ2UKICBmb3IoY29uc3QgdHggb2YgYWxsVHgpewogICAgY29uc3QgdG1zID0gX19nb190b01zKHR4LmRhdGUpOwogICAgaWYodG1zIDwgc3RhcnRNcyB8fCB0bXMgPiBlbmRNcykgY29udGludWU7CiAgICBpZih0eC50eXBlPT09ImRlcG9zaXQiIHx8IHR4LnR5cGU9PT0idHJhbnNmZXJfaW4iKXsKICAgICAgd2vFgmFkQmFzZSArPSAoTnVtYmVyKHR4LmFtb3VudCl8fDApICogKHBmRnguZ2V0KHR4Ll9fcGYuaWQpfHwxKTsKICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0id2l0aGRyYXciIHx8IHR4LnR5cGU9PT0idHJhbnNmZXJfb3V0Iil7CiAgICAgIHdrxYJhZEJhc2UgLT0gKE51bWJlcih0eC5hbW91bnQpfHwwKSAqIChwZkZ4LmdldCh0eC5fX3BmLmlkKXx8MSk7CiAgICB9CiAgICBhcHBseVR4VG9TdGF0ZSh0eCk7CiAgICBjb25zdCBkYXkgPSBfX2dvX2Zsb29yRGF5KHRtcyk7CiAgICBzZXJpZXNCbHVlLnB1c2goeyB4OiBkYXksIHk6IHdrxYJhZEJhc2UgfSk7CiAgICBzZXJpZXNHcmVlbi5wdXNoKHsgeDogZGF5LCB5OiBlcXVpdHlOb3coKSB9KTsKICB9CgogIC8vIEZvcmNlIGZpbmFsIHBvaW50IGF0IGVuZAogIHNlcmllc0JsdWUucHVzaCh7IHg6ZW5kTXMsIHk6IHdrxYJhZEJhc2UgfSk7CiAgc2VyaWVzR3JlZW4ucHVzaCh7IHg6ZW5kTXMsIHk6IGVxdWl0eU5vdygpIH0pOwoKICAvLyBCb3VuZHMKICBjb25zdCB5cyA9IFsuLi5zZXJpZXNCbHVlLCAuLi5zZXJpZXNHcmVlbl0ubWFwKHA9PnAueSk7CiAgbGV0IG1pblkgPSBNYXRoLm1pbiguLi55cywgMCk7CiAgbGV0IG1heFkgPSBNYXRoLm1heCguLi55cywgMCk7CiAgaWYoIXlzLmxlbmd0aCB8fCAhTnVtYmVyLmlzRmluaXRlKG1pblkpIHx8ICFOdW1iZXIuaXNGaW5pdGUobWF4WSkpewogICAgICBtaW5ZID0gMDsgbWF4WSA9IDE7CiAgfQogIGlmKG1heFkgLSBtaW5ZIDwgMWUtNil7IG1heFkgPSBtaW5ZICsgMTsgfSAvLyBhdm9pZCAwIGhlaWdodAoKICByZXR1cm4geyBzZXJpZXNCbHVlLCBzZXJpZXNHcmVlbiwgYm91bmRzOnsgbWluWDpzdGFydE1zLCBtYXhYOmVuZE1zLCBtaW5ZLCBtYXhZIH0gfTsKfQoKZnVuY3Rpb24gX19nb19mbXRDdXJyZW5jeSh2LCBjb2RlKXsgdHJ5eyBpZih0eXBlb2YgZm10Q3VycmVuY3k9PT0nZnVuY3Rpb24nKSByZXR1cm4gZm10Q3VycmVuY3kodiwgY29kZSk7IH1jYXRjaChfKXsgfSB0cnl7IHJldHVybiBuZXcgSW50bC5OdW1iZXJGb3JtYXQodW5kZWZpbmVkLHtzdHlsZTonY3VycmVuY3knLGN1cnJlbmN5Oihjb2RlfHwnUExOJyl9KS5mb3JtYXQodnx8MCk7fWNhdGNoKF8peyByZXR1cm4gU3RyaW5nKE1hdGgucm91bmQoKHZ8fDApKjEwMCkvMTAwKSsnICcrKGNvZGV8fCcnKTsgfSB9CgpmdW5jdGlvbiBkcmF3R2xvYmFsTGluZUNoYXJ0KGNhY2hlKXsKICAgIHRyeXsKICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1iYXNlJyk/LnZhbHVlIHx8ICdQTE4nOwogICAgICBjb25zdCBiID0gY2FjaGU/LnNlcmllc0JsdWUgfHwgW107CiAgICAgIGNvbnN0IGcgPSBjYWNoZT8uc2VyaWVzR3JlZW4gfHwgW107CiAgICAgIGNvbnN0IGxhc3RCID0gYi5sZW5ndGggPyBiW2IubGVuZ3RoLTFdLnkgOiAwOwogICAgICBjb25zdCBsYXN0RyA9IGcubGVuZ3RoID8gZ1tnLmxlbmd0aC0xXS55IDogMDsKICAgICAgY29uc3QgaWIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28taW5mby1ibHVlJyk7IGlmKGliKSBpYi50ZXh0Q29udGVudCA9ICdXa8WCYWQ6ICcgKyBfX2dvX2ZtdEN1cnJlbmN5KGxhc3RCLCBiYXNlKTsKICAgICAgY29uc3QgaWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28taW5mby1ncmVlbicpOyBpZihpZykgaWcudGV4dENvbnRlbnQgPSAnV2FydG/Fm8SHOiAnICsgX19nb19mbXRDdXJyZW5jeShsYXN0RywgYmFzZSk7CiAgICB9Y2F0Y2goXyl7fQoKICAgIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZ28tbGluZS1jaGFydC1jYXJkIC5nby1jaGFydC13cmFwJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmdvLWNoYXJ0LXdyYXAnKTsKICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1saW5lLWNoYXJ0Jyk7CiAgICBjb25zdCBlbXB0eSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1jaGFydC1lbXB0eScpOwogICAgY29uc3QgdGlwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWNoYXJ0LXRvb2x0aXAtaW1wJyk7CiAgICBpZighd3JhcCB8fCAhY2FudmFzIHx8ICFlbXB0eSkgcmV0dXJuOwoKICAgIGlmKCFjYWNoZSB8fCAhY2FjaGUuc2VyaWVzQmx1ZT8ubGVuZ3RoIHx8ICFjYWNoZS5zZXJpZXNHcmVlbj8ubGVuZ3RoKXsKICAgICAgZW1wdHkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7IGNhbnZhcy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyBpZih0aXApIHRpcC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7IHJldHVybjsKICAgIH0KICAgIGVtcHR5LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IGNhbnZhcy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKCiAgICBjb25zdCBkcHIgPSAod2luZG93LmRldmljZVBpeGVsUmF0aW98fDEpOwogICAgY29uc3QgZGVzaXJlZEggPSA4MjA7IHRyeXsgd3JhcC5zdHlsZS5oZWlnaHQgPSBkZXNpcmVkSCsncHgnOyB3cmFwLnN0eWxlLm1pbkhlaWdodCA9ICc4MjBweCc7IHdyYXAuc3R5bGUubWF4SGVpZ2h0ID0gZGVzaXJlZEgrJ3B4JzsgfWNhdGNoKF8pe30KY29uc3QgdyA9IE1hdGgubWF4KDEwLCB3cmFwLmNsaWVudFdpZHRoKTsKY29uc3QgaCA9IGRlc2lyZWRIOwogICAgY2FudmFzLndpZHRoID0gTWF0aC5mbG9vcih3ICogZHByKTsKICAgIGNhbnZhcy5oZWlnaHQgPSBNYXRoLmZsb29yKGggKiBkcHIpOwogICAgY2FudmFzLnN0eWxlLndpZHRoID0gdyArICdweCc7CiAgICBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gaCArICdweCc7CiAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnLCB7IHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZSB9KTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oMSwwLDAsMSwwLDApOwogICAgY3R4LnNjYWxlKGRwciwgZHByKTsKICAgIGNvbnN0IG92ZXJsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tbGluZS1jaGFydC1vdmVybGF5Jyk7CiAgICBsZXQgb2N0eCA9IG51bGw7CiAgICBpZihvdmVybGF5KXsKICAgICAgb3ZlcmxheS53aWR0aCA9IE1hdGguZmxvb3IodyAqIGRwcik7CiAgICAgIG92ZXJsYXkuaGVpZ2h0ID0gTWF0aC5mbG9vcihoICogZHByKTsKICAgICAgb3ZlcmxheS5zdHlsZS53aWR0aCA9IHcgKyAncHgnOwogICAgICBvdmVybGF5LnN0eWxlLmhlaWdodCA9IGggKyAncHgnOwogICAgICBvY3R4ID0gb3ZlcmxheS5nZXRDb250ZXh0KCcyZCcpOwogICAgICBvY3R4LnNldFRyYW5zZm9ybSgxLDAsMCwxLDAsMCk7CiAgICAgIG9jdHguc2NhbGUoZHByLCBkcHIpOwogICAgfQoKCiAgICBjb25zdCBwYWQgPSB7IGxlZnQ6IDExMCwgcmlnaHQ6IDYwLCB0b3A6IDU2LCBib3R0b206IDg0IH07CgogICAgY29uc3Qge21pblgsIG1heFh9ID0gY2FjaGUuYm91bmRzIHx8IHt9Owpjb25zdCB4cyA9IChjYWNoZS5zZXJpZXNCbHVlfHxbXSkubWFwKHA9PnAueCkuY29uY2F0KChjYWNoZS5zZXJpZXNHcmVlbnx8W10pLm1hcChwPT5wLngpKTsKY29uc3QgX21pblggPSBOdW1iZXIuaXNGaW5pdGUobWluWCkgPyBtaW5YIDogKHhzLmxlbmd0aD8gTWF0aC5taW4oLi4ueHMpOjApOwpjb25zdCBfbWF4WCA9IE51bWJlci5pc0Zpbml0ZShtYXhYKSA/IG1heFggOiAoeHMubGVuZ3RoPyBNYXRoLm1heCguLi54cyk6KF9taW5YKzEpKTsKY29uc3QgYWxsWSA9IChjYWNoZS5zZXJpZXNCbHVlfHxbXSkubWFwKHA9PnAueSkuY29uY2F0KChjYWNoZS5zZXJpZXNHcmVlbnx8W10pLm1hcChwPT5wLnkpKS5maWx0ZXIodj0+TnVtYmVyLmlzRmluaXRlKHYpKTsKbGV0IF9taW5ZID0gYWxsWS5sZW5ndGg/IE1hdGgubWluKC4uLmFsbFkpIDogMDsKbGV0IF9tYXhZID0gYWxsWS5sZW5ndGg/IE1hdGgubWF4KC4uLmFsbFkpIDogKF9taW5ZKzEpOwpsZXQgX3JhbmdlWSA9IE1hdGgubWF4KDFlLTYsIF9tYXhZIC0gX21pblkpOwpfbWluWSA9IE1hdGgubWF4KDAsIF9taW5ZIC0gX3JhbmdlWSowLjIwKTsKX21heFkgPSBfbWF4WSArIF9yYW5nZVkqMC4yMDsKX3JhbmdlWSA9IE1hdGgubWF4KDFlLTYsIF9tYXhZIC0gX21pblkpOwogICAgY29uc3QgWCA9IHggPT4gcGFkLmxlZnQgKyAoICh4IC0gX21pblgpIC8gTWF0aC5tYXgoMSwgKF9tYXhYIC0gX21pblgpKSApICogKHcgLSBwYWQubGVmdCAtIHBhZC5yaWdodCk7CiAgICBjb25zdCBZID0geSA9PiAoaCAtIHBhZC5ib3R0b20pIC0gKCAoeSAtIF9taW5ZKSAvIE1hdGgubWF4KDFlLTYsKF9tYXhZIC0gX21pblkpKSApICogKGggLSBwYWQudG9wIC0gcGFkLmJvdHRvbSk7CgogICAgY3R4LmNsZWFyUmVjdCgwLDAsdyxoKTsKICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLDAsMCwwLjMpJzsKICAgIGN0eC5maWxsUmVjdCgwLDAsdyxoKTsKCiAgICBjb25zdCBjdyA9IHcgLSBwYWQubGVmdCAtIHBhZC5yaWdodDsKICAgIGNvbnN0IGNoID0gaCAtIHBhZC50b3AgLSBwYWQuYm90dG9tOwoKICAgIC8vIEdyaWQKICAgIGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDE0OCwgMTYzLCAxODQsIDAuMiknOwogICAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgICBmb3IobGV0IGk9MDtpPD02O2krKyl7CiAgICAgIGNvbnN0IHl5ID0gcGFkLnRvcCArIChjaC82KSppOwogICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5tb3ZlVG8ocGFkLmxlZnQsIHl5KTsgY3R4LmxpbmVUbyh3IC0gcGFkLnJpZ2h0LCB5eSk7IGN0eC5zdHJva2UoKTsKICAgICAgY29uc3QgdmFsID0gX21heFkgLSAoX21heFkgLSBfbWluWSkgKiAoaS82KTsKICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjOTRhM2I4JzsgY3R4LmZvbnQgPSAnYm9sZCAxM3B4IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90byc7CiAgICAgIGN0eC50ZXh0QWxpZ24gPSAncmlnaHQnOwogICAgICB0cnl7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1iYXNlJyk/LnZhbHVlIHx8ICdQTE4nOwogICAgICAgIGN0eC5maWxsVGV4dChfX2dvX2ZtdEN1cnJlbmN5KHZhbCwgYmFzZSksIHBhZC5sZWZ0IC0gMTIsIHl5ICsgNCk7CiAgICAgIH1jYXRjaChfKXt9CiAgICB9CiAgICAvLyBCb3JkZXIKICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjMzM0MTU1JzsKICAgIGN0eC5saW5lV2lkdGggPSAyOwogICAgY3R4LnN0cm9rZVJlY3QocGFkLmxlZnQsIHBhZC50b3AsIGN3LCBjaCk7CgogICAgZnVuY3Rpb24gc3Ryb2tlU2VyaWVzKHNlcmllcywgY29sb3IsIHdpZHRoKXsKICAgICAgaWYoIXNlcmllcyB8fCAhc2VyaWVzLmxlbmd0aCkgcmV0dXJuOwogICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgIGxldCBmaXJzdCA9IHRydWU7CiAgICAgIGZvcihjb25zdCBwIG9mIHNlcmllcyl7CiAgICAgICAgY29uc3QgeHggPSBYKHAueCksIHl5ID0gWShwLnkpOwogICAgICAgIGlmKGZpcnN0KXsgY3R4Lm1vdmVUbyh4eCx5eSk7IGZpcnN0PWZhbHNlOyB9IGVsc2UgeyBjdHgubGluZVRvKHh4LHl5KTsgfQogICAgICB9CiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGNvbG9yOyBjdHgubGluZVdpZHRoID0gd2lkdGg7IGN0eC5saW5lQ2FwPSdyb3VuZCc7IGN0eC5saW5lSm9pbj0ncm91bmQnOyBjdHguc3Ryb2tlKCk7CiAgICB9CgogICAgc3Ryb2tlU2VyaWVzKGNhY2hlLnNlcmllc0JsdWUsICcjM2I4MmY2JywgNC42KTsKICAgIHN0cm9rZVNlcmllcyhjYWNoZS5zZXJpZXNHcmVlbiwgJyMyMmM1NWUnLCA0LjYpOwoKICAgIGZ1bmN0aW9uIGRyYXdQb2ludHMoc2VyaWVzLCBmaWxsKXsKICAgICAgaWYoIXNlcmllcyB8fCAhc2VyaWVzLmxlbmd0aCkgcmV0dXJuOwogICAgICBjb25zdCByID0gMy42OwogICAgICBjdHguZmlsbFN0eWxlID0gZmlsbDsKICAgICAgZm9yKGNvbnN0IHAgb2Ygc2VyaWVzKXsKICAgICAgICBjb25zdCB4eCA9IFgocC54KSwgeXkgPSBZKHAueSk7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHh4LHl5LHIsMCxNYXRoLlBJKjIpOyBjdHguZmlsbCgpOwogICAgICB9CiAgICB9CiAgICBkcmF3UG9pbnRzKGNhY2hlLnNlcmllc0JsdWUsICdyZ2JhKDU5LDEzMCwyNDYsMC44NSknKTsKICAgIGRyYXdQb2ludHMoY2FjaGUuc2VyaWVzR3JlZW4sJ3JnYmEoMzQsMTk3LDk0LDAuODUpJyk7CgogICAgLy8gWCBsYWJlbHMKICAgIGNvbnN0IHhTdGFydCA9IG5ldyBEYXRlKF9taW5YKSwgeE1pZCA9IG5ldyBEYXRlKChfbWluWCtfbWF4WCkvMiksIHhFbmQgPSBuZXcgRGF0ZShfbWF4WCk7CiAgICBjdHguZmlsbFN0eWxlID0gJyM5NGEzYjgnOyBjdHguZm9udCA9ICcxNHB4IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90byc7IGN0eC50ZXh0QWxpZ24gPSAnbGVmdCc7CiAgICBjdHguZmlsbFRleHQoeFN0YXJ0LnRvTG9jYWxlRGF0ZVN0cmluZygpLCBwYWQubGVmdCwgaC0xMik7CiAgICBjb25zdCBtaWRMYWJlbCA9IHhNaWQudG9Mb2NhbGVEYXRlU3RyaW5nKCk7IGNvbnN0IG1pZFcgPSBjdHgubWVhc3VyZVRleHQobWlkTGFiZWwpLndpZHRoOwogICAgY3R4LmZpbGxUZXh0KG1pZExhYmVsLCAodyAtIG1pZFcpLzIsIGgtMTIpOwogICAgY29uc3QgZW5kTGFiZWwgPSB4RW5kLnRvTG9jYWxlRGF0ZVN0cmluZygpOyBjb25zdCBlbmRXID0gY3R4Lm1lYXN1cmVUZXh0KGVuZExhYmVsKS53aWR0aDsKICAgIAogICAgLy8gU25hcHNob3QgYmFzZSBsYXllciB0byBwcmV2ZW50IGNyb3NzaGFpciB0cmFpbHMKICAgIHRyeXsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnNldFRyYW5zZm9ybSgxLDAsMCwxLDAsMCk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9Y2F0Y2goXyl7fQoKICAgIC8vIFRvb2x0aXAgZXZlbnRzIChhdHRhY2ggb25jZSkKCiAgICAoZnVuY3Rpb24gYXR0YWNoVGlwSGFuZGxlcnMoKXsKICAgICAgaWYoIWNhbnZhcykgcmV0dXJuOwogICAgICBjb25zdCBiID0gY2FjaGUuc2VyaWVzQmx1ZSB8fCBbXTsKICAgICAgY29uc3QgZyA9IGNhY2hlLnNlcmllc0dyZWVuIHx8IFtdOwogICAgICBjb25zdCB0aXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tY2hhcnQtdG9vbHRpcC1pbXAnKTsKICAgICAgZnVuY3Rpb24gc2hvd1RpcChwdElkeCwgY2xpZW50WCwgY2xpZW50WSl7CiAgICAgICAgaWYoIXRpcCkgcmV0dXJuOwogICAgICAgIGNvbnN0IGkgPSBNYXRoLm1heCgwLCBNYXRoLm1pbihwdElkeCwgTWF0aC5taW4oYi5sZW5ndGgsIGcubGVuZ3RoKS0xKSk7CiAgICAgICAgY29uc3QgdmIgPSAoYltpXSAmJiBiW2ldLnkpIHx8IDA7CiAgICAgICAgY29uc3QgdmcgPSAoZ1tpXSAmJiBnW2ldLnkpIHx8IDA7CiAgICAgICAgY29uc3QgZHQgPSBuZXcgRGF0ZSgoYltpXSAmJiBiW2ldLngpIHx8IChnW2ldICYmIGdbaV0ueCkgfHwgX21pblgpOwogICAgICAgIGNvbnN0IGJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tYmFzZScpPy52YWx1ZSB8fCAnUExOJzsKICAgICAgICB0aXAuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpOwogICAgICAgIGNvbnN0IGQgPSBkb2N1bWVudDsgCiAgICAgICAgZC5nZXRFbGVtZW50QnlJZCgndHQtZGF0ZS1pbXAnKS50ZXh0Q29udGVudCAgICAgPSBkdC50b0xvY2FsZURhdGVTdHJpbmcoJ3BsLVBMJyk7CiAgICAgICAgZC5nZXRFbGVtZW50QnlJZCgndHQtaW52ZXN0ZWQtaW1wJykudGV4dENvbnRlbnQgPSBfX2dvX2ZtdEN1cnJlbmN5KHZiLCBiYXNlKTsKICAgICAgICBkLmdldEVsZW1lbnRCeUlkKCd0dC12YWx1ZS1pbXAnKS50ZXh0Q29udGVudCAgICA9IF9fZ29fZm10Q3VycmVuY3kodmcsIGJhc2UpOwogICAgICAgIGNvbnN0IHByb2ZpdCA9IHZnIC0gdmI7CiAgICAgICAgZC5nZXRFbGVtZW50QnlJZCgndHQtcHJvZml0LWltcCcpLnRleHRDb250ZW50ICAgPSBfX2dvX2ZtdEN1cnJlbmN5KHByb2ZpdCwgYmFzZSk7CiAgICAgICAgY29uc3Qgcm9pID0gKHZiPjApID8gKHByb2ZpdCAvIHZiICogMTAwKSA6IDA7CiAgICAgICAgZC5nZXRFbGVtZW50QnlJZCgndHQtcm9pLWltcCcpLnRleHRDb250ZW50ICAgICAgPSAocm9pLnRvRml4ZWQoMikgKyAnJScpOwoKICAgICAgICBjb25zdCByZWN0ID0gY2FudmFzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGxldCBsZWZ0ID0gY2xpZW50WCAtIHJlY3QubGVmdDsKICAgICAgICBsZXQgdG9wICA9IGNsaWVudFkgLSByZWN0LnRvcCAtIDE0MDsKICAgICAgICBpZiAobGVmdCArIDM0MCA+IHJlY3Qud2lkdGgpIGxlZnQgPSByZWN0LndpZHRoIC0gMzUwOwogICAgICAgIGlmIChsZWZ0IDwgMTApIGxlZnQgPSAxMDsKICAgICAgICB0aXAuc3R5bGUubGVmdCA9IGxlZnQgKyAncHgnOwogICAgICAgIHRpcC5zdHlsZS50b3AgID0gdG9wICsgJ3B4JzsKICAgICAgfQogICAgICBmdW5jdGlvbiBoaWRlVGlwKCl7IGlmKHRpcCkgdGlwLmNsYXNzTGlzdC5yZW1vdmUoJ3Zpc2libGUnKTsgfQoKICAgICAgaWYoIWNhbnZhcy5fX3RpcEJvdW5kKXsKICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpPT57CiAgICAgICAgICAvLyBSZXN0b3JlIGJhc2Ugc25hcHNob3QgdG8gY2xlYXIgcHJldmlvdXMgY3Jvc3NoYWlycwoKICAgICAgICAgIGNvbnN0IHJlY3QgPSBjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICBjb25zdCByeCA9IChlLmNsaWVudFggLSByZWN0LmxlZnQpIC8gcmVjdC53aWR0aDsKICAgICAgICAgIGNvbnN0IGRvbWFpblggPSBfbWluWCArIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHJ4KSkgKiAoX21heFggLSBfbWluWCk7CgogICAgICAgICAgZnVuY3Rpb24gbmVhcmVzdElkeChzZXJpZXMpewogICAgICAgICAgICBpZighc2VyaWVzIHx8ICFzZXJpZXMubGVuZ3RoKSByZXR1cm4gLTE7CiAgICAgICAgICAgIGxldCBsbyA9IDAsIGhpID0gc2VyaWVzLmxlbmd0aC0xOwogICAgICAgICAgICB3aGlsZShsbyA8IGhpKXsKICAgICAgICAgICAgICBjb25zdCBtaWQgPSAobG8gKyBoaSkgPj4gMTsKICAgICAgICAgICAgICBpZihzZXJpZXNbbWlkXS54IDwgZG9tYWluWCkgbG8gPSBtaWQgKyAxOyBlbHNlIGhpID0gbWlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBjYW5kID0gbG87CiAgICAgICAgICAgIGlmKGxvID4gMCAmJiAoTWF0aC5hYnMoc2VyaWVzW2xvLTFdLnggLSBkb21haW5YKSA8IE1hdGguYWJzKHNlcmllc1tsb10ueCAtIGRvbWFpblgpKSkgY2FuZCA9IGxvLTE7CiAgICAgICAgICAgIHJldHVybiBjYW5kOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IGJpID0gbmVhcmVzdElkeChiKTsKICAgICAgICAgIGNvbnN0IGdpID0gbmVhcmVzdElkeChnKTsKICAgICAgICAgIGlmKGJpIDwgMCAmJiBnaSA8IDApeyByZXR1cm4gaGlkZVRpcCgpOyB9CgogICAgICAgICAgY29uc3QgdmIgPSBiaT49MCA/IChiW2JpXS55fHwwKSA6IDA7CiAgICAgICAgICBjb25zdCB2ZyA9IGdpPj0wID8gKGdbZ2ldLnl8fDApIDogMDsKCiAgICAgICAgICAvLyBEcmF3IGNyb3NzaGFpcgogICAgICAgICAgY29uc3QgY3ggPSBYKGRvbWFpblgpOwogICAgICAgICAgaWYob2N0eCl7IG9jdHguY2xlYXJSZWN0KDAsMCx3LGgpOyBvY3R4LnN0cm9rZVN0eWxlPSdyZ2JhKDE0OCwxNjMsMTg0LDAuMzUpJzsgb2N0eC5saW5lV2lkdGg9MTsgb2N0eC5iZWdpblBhdGgoKTsgb2N0eC5tb3ZlVG8oY3gsIHBhZC50b3ApOyBvY3R4LmxpbmVUbyhjeCwgaCAtIHBhZC5ib3R0b20pOyBvY3R4LnN0cm9rZSgpOyB9CgogICAgICAgICAgc2hvd1RpcChNYXRoLm1heChiaSwgZ2kpLCBlLmNsaWVudFgsIGUuY2xpZW50WSwgdmIsIHZnLCBkb21haW5YKTsKICAgICAgICB9KTsKICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsICgpPT57IGhpZGVUaXAoKTsgaWYob2N0eCl7IG9jdHguY2xlYXJSZWN0KDAsMCx3LGgpOyB9IH0pOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCBoaWRlVGlwLCB7cGFzc2l2ZTp0cnVlfSk7CiAgICAgICAgY2FudmFzLl9fdGlwQm91bmQgPSB0cnVlOwogICAgICB9CiAgICB9KSgpOwogICAgfQoKYXN5bmMgZnVuY3Rpb24gcGFpbnRHbG9iYWxMaW5lQ2hhcnQoUSwgcGVyaW9kUmFuZ2UsIGJhc2UpewogIHRyeXsKICAgIF9fR09fQ0hBUlRfQ0FDSEUgPSBhd2FpdCBjb21wdXRlR2xvYmFsTGluZVNlcmllcyhRLCBwZXJpb2RSYW5nZSwgYmFzZSk7CiAgICBkcmF3R2xvYmFsTGluZUNoYXJ0KF9fR09fQ0hBUlRfQ0FDSEUpOwogIH1jYXRjaChlcnIpewogICAgY29uc29sZS53YXJuKCdbR09dIExpbmUgY2hhcnQgZXJyb3I6JywgZXJyKTsKICAgIGNvbnN0IGVtcHR5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWNoYXJ0LWVtcHR5Jyk7CiAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tbGluZS1jaGFydCcpOwogICAgaWYoZW1wdHkgJiYgY2FudmFzKXsgZW1wdHkuc3R5bGUuZGlzcGxheT0nYmxvY2snOyBjYW52YXMuc3R5bGUuZGlzcGxheT0nbm9uZSc7IH0KICB9Cn0Kd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpPT57IHRyeXsgZHJhd0dsb2JhbExpbmVDaGFydChfX0dPX0NIQVJUX0NBQ0hFKTsgfWNhdGNoKF8peyB9IH0pOwovLyA9PT0gWy9HT10gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmFzeW5jIGZ1bmN0aW9uIHJlZnJlc2goKXtsb2FkUHJlZnMoKTsKICAgIHRyeXsgY29uc3QgcHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tcGVyaW9kJyk7IGlmKHBzKXsgU1QucGVyaW9kS2V5ID0gcHMudmFsdWV8fFNULnBlcmlvZEtleXx8J2FsbCc7IFNULnBlcmlvZFJhbmdlID0gZ2V0UGVyaW9kUmFuZ2UoU1QucGVyaW9kS2V5KTsgfSB9Y2F0Y2goXyl7fQogICAgdHJ5eyBhd2FpdCBlbnN1cmVGeCgnVVNEJywnUExOJyk7IH1jYXRjaChfKXt9CiAgICBjb25zdCBwZnMgPSBBcnJheS5pc0FycmF5KFNULkRCLnBvcnRmb2xpb3MpID8gU1QuREIucG9ydGZvbGlvcyA6IFtdOwogICAgY29uc3QgYmFzZSA9ICQoJyNnby1iYXNlJykudmFsdWUgfHwgU1QuYmFzZSB8fCAnUExOJzsKICAgIGZvcihjb25zdCBwZiBvZiBwZnMpeyBhd2FpdCBlbnN1cmVGeChwZi5jdXJyZW5jeXx8J1BMTicsIGJhc2UpOyB9CiAgICBjb25zdCBRID0gYXdhaXQgZmV0Y2hBbGxRdW90ZXNDb29wKCk7CiAgICBjb25zdCBjb21wID0gYXdhaXQgY29tcHV0ZUFsbChRLCBTVC5wZXJpb2RSYW5nZSk7CiAgICBwYWludFRvdGFscyhjb21wKTsgcGFpbnRQb3J0Zm9saW9zKGNvbXAucmVzdWx0cywgY29tcC5iYXNlKTsgcGFpbnRQb3NpdGlvbnMoY29tcC5yZXN1bHRzKTsKICAgIGNvbnN0IGV4dHJhID0gY29tcHV0ZUNsb3NlZFRyYWRlU3RhdHMoU1QucGVyaW9kUmFuZ2UpOwogICAgdHJ5eyBTVC50cENvdW50ID0gY291bnRTZWxsVHhJblJhbmdlKFNULkRCLCBTVC5wZXJpb2RSYW5nZSk7IHZhciBfX3RwPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby10cC1jb3VudCcpOyBpZihfX3RwKXsgX190cC50ZXh0Q29udGVudCA9IFN0cmluZyhTVC50cENvdW50KTsgfSB9Y2F0Y2goXyl7IH0gICAgIHBhaW50RXh0cmFTdGF0cyhleHRyYSk7CiAgICBhd2FpdCBwYWludEdsb2JhbExpbmVDaGFydChRLCBTVC5wZXJpb2RSYW5nZSwgYmFzZSk7CiAgICByZXR1cm4gY29tcDsKICB9CiAgZnVuY3Rpb24gc2NoZWR1bGUoKXsKICAgIGlmKFNULnRpbWVyKSBjbGVhckludGVydmFsKFNULnRpbWVyKTsKICAgIGNvbnN0IHNlYyA9IE1hdGgubWF4KDUsIE51bWJlcigkKCcjZ28tcG9sbCcpLnZhbHVlKXx8NDUpOwogICAgU1QudGltZXIgPSBzZXRJbnRlcnZhbChyZWZyZXNoLCBzZWMqMTAwMCk7CiAgfQoKICAvLyBVSSBldmVudHMKICAkKCcjZ28tZmFiJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyAkKCcjZ28tdGFiLW92ZXJsYXknKS5oaWRkZW49ZmFsc2U7IHJlZnJlc2goKTsgc2NoZWR1bGUoKTsgfSk7CiAgJCgnI2dvLWNsb3NlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyAkKCcjZ28tdGFiLW92ZXJsYXknKS5oaWRkZW49dHJ1ZTsgaWYoU1QudGltZXIpIGNsZWFySW50ZXJ2YWwoU1QudGltZXIpOyB9KTsKICAkKCcjZ28tcmVmcmVzaCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgcmVmcmVzaCk7CiAgJCgnI2dvLXNhdmUnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X2Jhc2UnLCAkKCcjZ28tYmFzZScpLnZhbHVlfHwnUExOJyk7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X3BvbGwnLCBTdHJpbmcoJCgnI2dvLXBvbGwnKS52YWx1ZXx8JzQ1JykpOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2dsb2JhbF9vdmVydmlld190b2snLCAoJCgnI2dvLXRva2VuJykudmFsdWV8fCcnKS50cmltKCkpOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19ub2FwaScsICgkKCcjZ28tbm8tYXBpJykuY2hlY2tlZCA/ICcxJyA6ICcwJykpOwogICAgYWxlcnQoJ1phcGlzYW5vLicpOwogICAgc2NoZWR1bGUoKTsKICB9KTsKICAkKCcjZ28tZmlsdGVyJykuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCByZWZyZXNoKTsKICBjb25zdCBwZXJpb2RTZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tcGVyaW9kJyk7CiAgaWYocGVyaW9kU2VsKXsKICAgIHBlcmlvZFNlbC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKT0+ewogICAgICB0cnl7CiAgICAgICAgU1QucGVyaW9kS2V5ID0gcGVyaW9kU2VsLnZhbHVlIHx8ICdhbGwnOwogICAgICAgIFNULnBlcmlvZFJhbmdlID0gZ2V0UGVyaW9kUmFuZ2UoU1QucGVyaW9kS2V5KTsKICAgICAgICBzZXRQZXJpb2RLZXkoU1QucGVyaW9kS2V5KTsKICAgICAgfWNhdGNoKF8pe30KICAgICAgcmVmcmVzaCgpOwogICAgfSk7CiAgfQoKICAkKCcjZ28tbm8tYXBpJykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKCk9PnsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfbm9hcGknLCAoJCgnI2dvLW5vLWFwaScpLmNoZWNrZWQgPyAnMScgOiAnMCcpKTsKICAgIHJlZnJlc2goKTsKICB9KTsKCiAgY29uc3QgZnhJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1meC11c2RwbG4nKTsKICBjb25zdCBmeEFwcGx5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWZ4LWFwcGx5Jyk7CiAgY29uc3QgZnhDbGVhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1meC1jbGVhcicpOwogIGlmIChmeEFwcGx5KXsKICAgIGZ4QXBwbHkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ewogICAgICBjb25zdCB2ID0gcGFyc2VGbG9hdChmeElucHV0ICYmIGZ4SW5wdXQudmFsdWUgPyBmeElucHV0LnZhbHVlIDogJzAnKTsKICAgICAgaWYgKGlzRmluaXRlKHYpICYmIHYgPiAwKXsKICAgICAgICBpZighU1QuRlhbJ1VTRCddKSBTVC5GWFsnVVNEJ10gPSB7fTsKICAgICAgICBpZighU1QuRlhbJ1BMTiddKSBTVC5GWFsnUExOJ10gPSB7fTsKICAgICAgICBTVC5GWFsnVVNEJ11bJ1BMTiddID0gdjsKICAgICAgICBTVC5GWFsnUExOJ11bJ1VTRCddID0gMS92OwogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfZnhfdXNkcGxuJywgU3RyaW5nKHYpKTsKICAgICAgICBwYWludEZ4KCk7CiAgICAgICAgLy8gcHJ6ZWxpY3ogbmF0eWNobWlhc3QgdG90YWxzCiAgICAgICAgcmVmcmVzaCgpOwogICAgICB9ZWxzZXsKICAgICAgICBhbGVydCgnUG9kYWogZG9kYXRuaSBrdXJzLCBucC4gNC4xMjM0Jyk7CiAgICAgIH0KICAgIH0pOwogIH0KICBpZiAoZnhDbGVhcil7CiAgICBmeENsZWFyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ2dsb2JhbF9vdmVydmlld19meF91c2RwbG4nKTsKICAgICAgLy8gdXN1d2FteSBqZWR5bmllIG5hZHBpc2FuaWU7IHBvem9zdGF3aWFteSBpbm5lIGt1cnN5CiAgICAgIHRyeXsKICAgICAgICBpZiAoU1QuRlhbJ1VTRCddKSBkZWxldGUgU1QuRlhbJ1VTRCddWydQTE4nXTsKICAgICAgICBpZiAoU1QuRlhbJ1BMTiddKSBkZWxldGUgU1QuRlhbJ1BMTiddWydVU0QnXTsKICAgICAgfWNhdGNoKF8pe30KICAgICAgcGFpbnRGeCgpOwogICAgICByZWZyZXNoKCk7CiAgICB9KTsKICB9CgoKICAvLyA9PT0gW0dPIEV4cG9ydDogQ1NWIC8gSlNPTl0gPT09CiAgKGZ1bmN0aW9uKCl7CiAgICBmdW5jdGlvbiBkb3dubG9hZEZpbGUobmFtZSwgbWltZSwgZGF0YSl7CiAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbZGF0YV0sIHt0eXBlOiBtaW1lfSk7CiAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgYS5kb3dubG9hZCA9IG5hbWU7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7CiAgICAgIGEuY2xpY2soKTsKICAgICAgc2V0VGltZW91dCgoKT0+eyBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7IGEucmVtb3ZlKCk7IH0sIDEwMDApOwogICAgfQogICAgZnVuY3Rpb24gdG9Dc3ZDZWxsKHYpewogICAgICBpZih2PT09bnVsbCB8fCB2PT09dW5kZWZpbmVkKSByZXR1cm4gJyc7CiAgICAgIGNvbnN0IHMgPSBTdHJpbmcodikucmVwbGFjZSgvIi9nLCAnIiInKTsKICAgICAgcmV0dXJuIC9bOyJcbixdLy50ZXN0KHMpID8gYCIke3N9ImAgOiBzOwogICAgfQogICAgYXN5bmMgZnVuY3Rpb24gZXhwb3J0T3ZlcnZpZXdKU09OKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBjb21wID0gYXdhaXQgcmVmcmVzaCgpOyAvLyBnZXQgZnJlc2ggc25hcHNob3QKICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zQWdnID0gYnVpbGRBbGxQb3NpdGlvbnMoY29tcC5yZXN1bHRzKTsKICAgICAgICBjb25zdCBwYXlsb2FkID0gewogICAgICAgICAgZ2VuZXJhdGVkQXQ6IG5vdywKICAgICAgICAgIGJhc2U6IGNvbXAuYmFzZSwKICAgICAgICAgIHRvdGFsczogY29tcC50b3QsCiAgICAgICAgICBwb3J0Zm9saW9zOiBjb21wLnJlc3VsdHMubWFwKHIgPT4gKHsKICAgICAgICAgICAgbmFtZTogci5wZj8ubmFtZSB8fCAn4oCUJywKICAgICAgICAgICAgY3VycmVuY3k6IHIucGY/LmN1cnJlbmN5IHx8ICdQTE4nLAogICAgICAgICAgICBlcXVpdHlCYXNlOiByLmVxdWl0eUJhc2UsCiAgICAgICAgICAgIGNhc2hCYXNlOiByLmNhc2hCYXNlLAogICAgICAgICAgICBob2xkaW5nc0Jhc2U6IHIuaG9sZGluZ3NCYXNlLAogICAgICAgICAgICBjb3N0QmFzZTogci5jb3N0QmFzZSwKICAgICAgICAgICAgdW5yZWFsQmFzZTogci51bnJlYWxCYXNlLAogICAgICAgICAgICBkYXlNb3ZlQmFzZTogci5kYXlNb3ZlQmFzZSwKICAgICAgICAgICAgcmVhbGl6ZWRHcm9zc0Jhc2U6IHIucmVhbGl6ZWRHcm9zc0Jhc2UsCiAgICAgICAgICAgIHJlYWxpemVkVGF4QmFzZTogci5yZWFsaXplZFRheEJhc2UsCiAgICAgICAgICAgIHJlYWxpemVkTmV0QmFzZTogci5yZWFsaXplZE5ldEJhc2UsCiAgICAgICAgICAgIHBvc2l0aW9uczogci5wb3NpdGlvbnMKICAgICAgICAgIH0pKSwKICAgICAgICAgIHBvc2l0aW9uc0FnZ3JlZ2F0ZWQ6IHBvc2l0aW9uc0FnZwogICAgICAgIH07CiAgICAgICAgY29uc3QgZGF0YSA9IEpTT04uc3RyaW5naWZ5KHBheWxvYWQsIG51bGwsIDIpOwogICAgICAgIGRvd25sb2FkRmlsZShgZ2xvYmFsX292ZXJ2aWV3XyR7bm93LnNsaWNlKDAsMTApfS5qc29uYCwgImFwcGxpY2F0aW9uL2pzb24iLCBkYXRhKTsKICAgICAgfWNhdGNoKGUpewogICAgICAgIGNvbnNvbGUud2FybignW0dPIGV4cG9ydCBqc29uXSBmYWlsZWQnLCBlKTsKICAgICAgICBhbGVydCgnRWtzcG9ydCBKU09OIG5pZSBwb3dpw7NkxYIgc2nEmTogJysoZSYmZS5tZXNzYWdlP2UubWVzc2FnZTplKSk7CiAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZ1bmN0aW9uIGV4cG9ydE92ZXJ2aWV3Q1NWKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBjb21wID0gYXdhaXQgcmVmcmVzaCgpOyAvLyBmcmVzaCBzbmFwc2hvdAogICAgICAgIGNvbnN0IHJvd3MgPSBidWlsZEFsbFBvc2l0aW9ucyhjb21wLnJlc3VsdHMpOwogICAgICAgIGNvbnN0IGhlYWRlciA9IFsnVGlja2VyJywnUG9ydGZlbCcsJ0lsb8WbxIcnLCfFmnIuIGtvc3p0JywnS29zenQgd8WCYXNueScsJ0t1cnMnLCdXYXJ0b8WbxIcnLCdQL0wnLCclJywnzpQgZHppZW5ueScsJ1dhbHV0YSddOwogICAgICAgIGNvbnN0IGxpbmVzID0gW107CiAgICAgICAgbGluZXMucHVzaChoZWFkZXIuam9pbignOycpKTsKICAgICAgICBmb3IoY29uc3QgciBvZiByb3dzKXsKICAgICAgICAgIGNvbnN0IHBjdCA9IChyLnBjdCE9bnVsbCAmJiBpc0Zpbml0ZShyLnBjdCkpID8gKHIucGN0KjEwMCkudG9GaXhlZCgyKSA6ICcnOwogICAgICAgICAgY29uc3QgZHAgID0gKHIuZHAhPW51bGwgJiYgaXNGaW5pdGUoci5kcCkpICA/IHIuZHAudG9GaXhlZCgyKSA6ICcnOwogICAgICAgICAgY29uc3QgbGluZSA9IFsKICAgICAgICAgICAgdG9Dc3ZDZWxsKHIudGlja2VyKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKHIucGYpLAogICAgICAgICAgICB0b0NzdkNlbGwoTnVtYmVyKHIucXR5KS50b0ZpeGVkKDQpKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKE51bWJlcihyLmF2ZykudG9GaXhlZCg0KSksCiAgICAgICAgICAgIHRvQ3N2Q2VsbChOdW1iZXIoci5jb3N0KS50b0ZpeGVkKDIpKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKHIucHJpY2UhPW51bGwgJiYgaXNGaW5pdGUoci5wcmljZSkgPyBOdW1iZXIoci5wcmljZSkudG9GaXhlZCgyKSA6ICcnKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKE51bWJlcihyLnZhbHVlKS50b0ZpeGVkKDIpKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKE51bWJlcihyLnBsKS50b0ZpeGVkKDIpKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKHBjdCksCiAgICAgICAgICAgIHRvQ3N2Q2VsbChkcCksCiAgICAgICAgICAgIHRvQ3N2Q2VsbChyLmN1cnJlbmN5fHwnJykKICAgICAgICAgIF0uam9pbignOycpOwogICAgICAgICAgbGluZXMucHVzaChsaW5lKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3N2ID0gJ1x1ZmVmZicgKyBsaW5lcy5qb2luKCdcbicpOwogICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKTsKICAgICAgICBkb3dubG9hZEZpbGUoYGdsb2JhbF9vdmVydmlld19wb3NpdGlvbnNfJHtub3d9LmNzdmAsICJ0ZXh0L2NzdjtjaGFyc2V0PXV0Zi04IiwgY3N2KTsKICAgICAgfWNhdGNoKGUpewogICAgICAgIGNvbnNvbGUud2FybignW0dPIGV4cG9ydCBjc3ZdIGZhaWxlZCcsIGUpOwogICAgICAgIGFsZXJ0KCdFa3Nwb3J0IENTViBuaWUgcG93acOzZMWCIHNpxJk6ICcrKGUmJmUubWVzc2FnZT9lLm1lc3NhZ2U6ZSkpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBidG5Dc3YgID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWV4cG9ydC1jc3YnKTsKICAgIGNvbnN0IGJ0bkpzb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tZXhwb3J0LWpzb24nKTsKICAgIGlmKGJ0bkNzdikgIGJ0bkNzdi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGV4cG9ydE92ZXJ2aWV3Q1NWKTsKICAgIGlmKGJ0bkpzb24pIGJ0bkpzb24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBleHBvcnRPdmVydmlld0pTT04pOwogIH0pKCk7Cn0pKCk7PC9zY3JpcHQ+CjwhLS0gPT09IFsvR1QgQURET05dIEdsb2JhbCBPdmVydmlldyBUYWIgPT09IC0tPgoKPHNjcmlwdD4KLy8gPT09IEhlbHBlcjogaWdub3JlIGluY29uc2lzdGVudCBzZWxsIHRyYW5zYWN0aW9ucyAobm9uLWRlc3RydWN0aXZlKSA9PT0Kd2luZG93Ll9faWdub3JlSW5jb25zaXN0ZW50U2VsbHMgPSBmdW5jdGlvbigpewogIHRyeXsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIGNvbnN0IGlkcyA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IGVycnMgPSBBcnJheS5pc0FycmF5KHBmLl9fZXJyb3JzKSA/IHBmLl9fZXJyb3JzIDogW107CiAgICAvLyBQaWNrIHNlbGxzIG9ubHkKICAgIGZvcihjb25zdCBlIG9mIGVycnMpewogICAgICBpZihlICYmIC9TcHJ6ZWRhxbwgYmV6IHBvenljaml8QnJhayBwYXJ0aWkvLnRlc3QoZS5tZXNzYWdlfHwnJykpewogICAgICAgIC8vIGZpbmQgbWF0Y2hpbmcgdHggYnkgdGlja2VyIGFuZCBkYXRlIChiZXN0IGVmZm9ydCkKICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gKHBmLnRyYW5zYWN0aW9uc3x8W10pLmZpbHRlcih0ID0+IHQudHlwZT09PSdzZWxsJyAmJiAodC50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpPT09KGUudGlja2VyfHwnJykudG9VcHBlckNhc2UoKSk7CiAgICAgICAgLy8gbWFyayBhbGwgc2VsbHMgZm9yIHRoaXMgdGlja2VyIHRoYXQgd291bGQgZXJyb3IKICAgICAgICBmb3IoY29uc3QgdCBvZiBjYW5kaWRhdGVzKXsgaWRzLmFkZCh0LmlkKTsgfQogICAgICB9CiAgICB9CiAgICBpZighaWRzLnNpemUpeyBhbGVydCgnQnJhayBzcHJ6ZWRhxbx5IGRvIHppZ25vcm93YW5pYS4nKTsgcmV0dXJuOyB9CiAgICBjb25zdCBvayA9IGNvbmZpcm0oJ1ppZ25vcm93YcSHICcraWRzLnNpemUrJyB0cmFuc2FrY2ppIHNwcnplZGHFvHksIGt0w7NyZSBzxIUgbmllc3DDs2puZT8gKG1vxbxuYSBjb2ZuxIXEhyDihqnvuI8gQ29mbmlqKScpOwogICAgaWYoIW9rKSByZXR1cm47CiAgICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiSWdub3J1aiBuaWVzcMOzam5lIHNwcnplZGHFvGUiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KICAgIHBmLnRyYW5zYWN0aW9ucyA9IHBmLnRyYW5zYWN0aW9ucy5tYXAodCA9PiBpZHMuaGFzKHQuaWQpID8gT2JqZWN0LmFzc2lnbih7fSwgdCwge2lnbm9yZTp0cnVlLCBub3RlOiAodC5ub3RlPyB0Lm5vdGUrJyAnIDogJycpKydbSUdOT1JFRDogbmllc3DDs2pub8WbxIddJ30pIDogdCk7CiAgICBwZi51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7CiAgICByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgc2F2ZSgpOyByZW5kZXIoKTsKICB9Y2F0Y2goZSl7CiAgICBhbGVydCgnT3BlcmFjamEgbmllIHBvd2lvZMWCYSBzacSZOiAnKyhlICYmIGUubWVzc2FnZSB8fCBlKSk7CiAgfQp9Owo8L3NjcmlwdD4KPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgICAvLyBJbnRlcndhxYIgb2TFm3dpZcW8YW5pYTogMTAgc2VrdW5kICgxMDAwMCBtcykKICAgIGNvbnN0IEFVVE9fUkVGUkVTSF9JTlRFUlZBTF9NUyA9IDEwMDAwOwogICAgbGV0IF9fYXV0b1JlZnJlc2hUaW1lciA9IG51bGw7CgogICAgZnVuY3Rpb24gc3RhcnRDb25kaXRpb25hbEF1dG9SZWZyZXNoKCl7CiAgICAgICAgaWYgKF9fYXV0b1JlZnJlc2hUaW1lcikgY2xlYXJJbnRlcnZhbChfX2F1dG9SZWZyZXNoVGltZXIpOwoKICAgICAgICBfX2F1dG9SZWZyZXNoVGltZXIgPSBzZXRJbnRlcnZhbChhc3luYyAoKT0+ewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgLy8gU3ByYXdkemVuaWU6IEN6eSBKQUtJS09MV0lFSyBzemN6ZWfDs8WCICg8ZGV0YWlscz4pIGplc3Qgb3R3YXJ0eT8KICAgICAgICAgICAgICAgIC8vIFptaWVubmEgX19vcGVuRGV0YWlsc1RpY2tlcnMgcHJ6ZWNob3d1amUgc2V0IG90d2FydHljaCB0aWNrZXLDs3cuCiAgICAgICAgICAgICAgICBjb25zdCBkZXRhaWxzQXJlT3BlbiA9ICh3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMgJiYgd2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzLnNpemUgPiAwKTsKCiAgICAgICAgICAgICAgICBpZiAoIWRldGFpbHNBcmVPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSmXFm2xpIG5pZSBtYSBvdHdhcnR5Y2ggc3pjemVnw7PFgsOzdywgd3lrb25haiBvZMWbd2llxbxhbmllCiAgICAgICAgICAgICAgICAgICAgLy8gVcW8eXdhbXkgJ3JlZnJlc2goKScgcG9uaWV3YcW8IHBvYmllcmEgb25hIG5vd2UgZGFuZSBpIG1hbHVqZSBVSS4KICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5yZWZyZXNoID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHdpbmRvdy5yZWZyZXNoKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygd2luZG93LnJlbmRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBXIG9zdGF0ZWN6bm/Fm2NpIHXFvHlqIHJlbmRlcigpLCBqZcWbbGkgcmVmcmVzaCgpIG5pZSBqZXN0IGRvc3TEmXBuZQogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cucmVuZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBKZcWbbGkgc3pjemVnw7PFgnkgc8SFIG90d2FydGUsIHBvbWnFhCBwZcWCbmUgb2TFm3dpZcW8YW5pZS9yZS1yZW5kZXJvd2FuaWUKICAgICAgICAgICAgICAgICAgICAvLyAoemFwb2JpZWdhIHRvIG1pZ290YW5pdSkKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQXV0b21hdHljem5lIG9kxZt3aWXFvGFuaWUgd3N0cnp5bWFuZTogb3R3YXJ0ZSBzemN6ZWfDs8WCeSBwb3p5Y2ppLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0LFgsSFZCB3IGF1dG9tYXR5Y3pueW0gb2TFm3dpZcW8YW5pdSB3YXJ1bmtvd3ltOicsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgQVVUT19SRUZSRVNIX0lOVEVSVkFMX01TKTsKICAgIH0KCiAgICAvLyBVcnVjaG9tIGludGVyd2HFgiBwcnp5IHN0YXJjaWUgYXBsaWthY2ppCiAgICBzdGFydENvbmRpdGlvbmFsQXV0b1JlZnJlc2goKTsKCn0pKCk7Cjwvc2NyaXB0PgoKPC9ib2R5Pgo8L2h0bWw+Cgo8c2NyaXB0PgovLyBTb3VuZCB0aWNrZXIgdG8gaG9ub3VyIHJlcGVhdCBpbnRlcnZhbCBpbmRlcGVuZGVudGx5IG9mIHF1b3RlIHBvbGxpbmcKaWYoIXdpbmRvdy5fX3NvdW5kVGlja2VyKXsKICB3aW5kb3cuX19zb3VuZFRpY2tlciA9IHNldEludGVydmFsKCgpPT57CiAgICB0cnl7IGlmKHdpbmRvdy5jaGVja0FuZFBsYXlQb3J0Zm9saW9BbGVydHMpIGNoZWNrQW5kUGxheVBvcnRmb2xpb0FsZXJ0cygpOyB9Y2F0Y2goXyl7fQogICAgdHJ5eyBpZih3aW5kb3cuY2hlY2tBbmRQbGF5V2lzaGxpc3RBbGVydCkgY2hlY2tBbmRQbGF5V2lzaGxpc3RBbGVydCgpOyB9Y2F0Y2goXyl7fQogIH0sIDEwMDApOwp9CgovKiA9PT0gQ29tcGFueSBOb3RlcyAobG9jYWxTdG9yYWdlICsgRmlyZXN0b3JlIHN5bmMpID09PSAqLwooZnVuY3Rpb24oKXsKICBjb25zdCBOT1RFU19LRVkgPSAnY29tcGFueU5vdGVzX3YxJzsKICBmdW5jdGlvbiBsb2FkQ29tcGFueU5vdGVzKCl7IHRyeXsgcmV0dXJuIEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oTk9URVNfS0VZKXx8J3t9Jyl8fHt9OyB9Y2F0Y2goXyl7IHJldHVybiB7fTsgfSB9CiAgZnVuY3Rpb24gc2F2ZUNvbXBhbnlOb3RlcyhtYXApeyB0cnl7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKE5PVEVTX0tFWSwgSlNPTi5zdHJpbmdpZnkobWFwfHx7fSkpOyB9Y2F0Y2goXyl7IH0gfQogIHdpbmRvdy5nZXRDb21wYW55Tm90ZSA9ICh0aWNrZXIpPT4gKGxvYWRDb21wYW55Tm90ZXMoKVsodGlja2VyfHwnJykudG9VcHBlckNhc2UoKV18fCcnKTsKICB3aW5kb3cuc2V0Q29tcGFueU5vdGUgPSAodGlja2VyLCB0ZXh0KT0+eyBjb25zdCBtPWxvYWRDb21wYW55Tm90ZXMoKTsgbVsodGlja2VyfHwnJykudG9VcHBlckNhc2UoKV09U3RyaW5nKHRleHR8fCcnKTsgc2F2ZUNvbXBhbnlOb3RlcyhtKTsgfTsKCiAgYXN5bmMgZnVuY3Rpb24gc2F2ZU5vdGVSZW1vdGUodGlja2VyLCB0ZXh0KXsKICAgIHRyeXsKICAgICAgY29uc3QgY3R4ID0gYXdhaXQgKHR5cGVvZiBmYkluaXQgPT09ICdmdW5jdGlvbicgPyBmYkluaXQoKSA6IG51bGwpOwogICAgICBjb25zdCBhdXRoID0gY3R4ICYmIGN0eC5hdXRoLCBkYiA9IGN0eCAmJiBjdHguZGI7CiAgICAgIGlmKCFhdXRoIHx8ICFhdXRoLmN1cnJlbnRVc2VyIHx8ICFkYikgcmV0dXJuIGZhbHNlOwogICAgICBjb25zdCB1aWQgPSBhdXRoLmN1cnJlbnRVc2VyLnVpZDsKICAgICAgY29uc3QgaWQgPSBgJHt1aWR9XyR7U3RyaW5nKHRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCl9YDsKICAgICAgY29uc3QgZnYgPSAod2luZG93LmZpcmViYXNlICYmIHdpbmRvdy5maXJlYmFzZS5maXJlc3RvcmUgJiYgd2luZG93LmZpcmViYXNlLmZpcmVzdG9yZS5GaWVsZFZhbHVlKSB8fCBudWxsOwogICAgICBjb25zdCB0cyA9IGZ2ICYmIGZ2LnNlcnZlclRpbWVzdGFtcCA/IGZ2LnNlcnZlclRpbWVzdGFtcCgpIDogbmV3IERhdGUoKTsKICAgICAgYXdhaXQgZGIuY29sbGVjdGlvbignY29tcGFueU5vdGVzJykuZG9jKGlkKS5zZXQoeyB1aWQsIHRpY2tlcjogU3RyaW5nKHRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCksIG5vdGU6IFN0cmluZyh0ZXh0fHwnJyksIHVwZGF0ZWRBdDogdHMgfSwgeyBtZXJnZTogdHJ1ZSB9KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9Y2F0Y2goZSl7IGNvbnNvbGUud2FybignW25vdGVzXSBzYXZlIHJlbW90ZSBmYWlsZWQnLCBlKTsgcmV0dXJuIGZhbHNlOyB9CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGxvYWROb3RlUmVtb3RlKHRpY2tlcil7CiAgICB0cnl7CiAgICAgIGNvbnN0IGN0eCA9IGF3YWl0ICh0eXBlb2YgZmJJbml0ID09PSAnZnVuY3Rpb24nID8gZmJJbml0KCkgOiBudWxsKTsKICAgICAgY29uc3QgYXV0aCA9IGN0eCAmJiBjdHguYXV0aCwgZGIgPSBjdHggJiYgY3R4LmRiOwogICAgICBpZighYXV0aCB8fCAhYXV0aC5jdXJyZW50VXNlciB8fCAhZGIpIHJldHVybiBudWxsOwogICAgICBjb25zdCB1aWQgPSBhdXRoLmN1cnJlbnRVc2VyLnVpZDsKICAgICAgY29uc3QgaWQgPSBgJHt1aWR9XyR7U3RyaW5nKHRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCl9YDsKICAgICAgY29uc3Qgc25hcCA9IGF3YWl0IGRiLmNvbGxlY3Rpb24oJ2NvbXBhbnlOb3RlcycpLmRvYyhpZCkuZ2V0KCk7CiAgICAgIHJldHVybiBzbmFwLmV4aXN0cyA/IChzbmFwLmRhdGEoKSAmJiAoc25hcC5kYXRhKCkubm90ZXx8JycpKSA6IG51bGw7CiAgICB9Y2F0Y2goZSl7IHJldHVybiBudWxsOyB9CiAgfQoKICB3aW5kb3cub3BlbkNvbXBhbnlJbmZvTW9kYWwgPSBhc3luYyBmdW5jdGlvbih0aWNrZXIpewogICAgbGV0IGN1ciA9IGF3YWl0IGxvYWROb3RlUmVtb3RlKHRpY2tlcik7CiAgICBpZiAoY3VyID09IG51bGwpIGN1ciA9IGdldENvbXBhbnlOb3RlKHRpY2tlcik7CgogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiBgTm90YXRrYSBvIHNww7PFgmNlOiAke3RpY2tlcn1gLAogICAgICBpbm5lckhUTUw6IGA8Zm9ybT4KICAgICAgICA8bGFiZWw+VHdvamUgbm90YXRraSBvIHNww7PFgmNlPC9sYWJlbD4KICAgICAgICA8dGV4dGFyZWEgbmFtZT0ibm90ZSIgcm93cz0iOCIgc3R5bGU9IndpZHRoOjEwMCUiPiR7X19lc2MoY3VyfHwnJyl9PC90ZXh0YXJlYT4KICAgICAgICA8cCBjbGFzcz0ic21hbGwgbXV0ZWQiPlphcGlzeXdhbmUgbG9rYWxuaWUgaSBzeW5jaHJvbml6b3dhbmUgeiBGaXJlc3RvcmUgKGplxZtsaSB6YWxvZ293YW55KS48L3A+CiAgICAgIDwvZm9ybT5gLAogICAgICBva1RleHQ6ICdaYXBpc3onCiAgICB9KTsKICAgIGlmKCFkYXRhKSByZXR1cm47CgogICAgc2V0Q29tcGFueU5vdGUodGlja2VyLCBkYXRhLm5vdGV8fCcnKTsKICAgIGNvbnN0IG9rID0gYXdhaXQgc2F2ZU5vdGVSZW1vdGUodGlja2VyLCBkYXRhLm5vdGV8fCcnKTsKICAgIHRyeXsgc2hvd1RvYXN0ICYmIHNob3dUb2FzdCh7IHRpdGxlOiBvayA/ICdaYXBpc2FubyBub3RhdGvEmSAoRmlyZXN0b3JlICsgbG9rYWxuaWUpJyA6ICdaYXBpc2FubyBub3RhdGvEmSAobG9rYWxuaWUpJywgbWVzc2FnZTogdGlja2VyIH0pOyB9Y2F0Y2goXyl7fQogIH07CgogIGNvbnN0IF9fb3JpZ0V4cG9ydCA9IHdpbmRvdy5leHBvcnRKU09OOwogIGlmICh0eXBlb2YgX19vcmlnRXhwb3J0ID09PSAnZnVuY3Rpb24nKXsKICAgIHdpbmRvdy5leHBvcnRKU09OID0gZnVuY3Rpb24oKXsKICAgICAgdHJ5eyBEQi5jb21wYW55Tm90ZXMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGxvYWRDb21wYW55Tm90ZXMoKSkpOyB9Y2F0Y2goXyl7fQogICAgICByZXR1cm4gX19vcmlnRXhwb3J0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KICB0cnl7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW1wb3J0RmlsZScpPy5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKT0+ewogICAgICBzZXRUaW1lb3V0KCgpPT57IHRyeXsgaWYoREIgJiYgREIuY29tcGFueU5vdGVzKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTk9URVNfS0VZLCBKU09OLnN0cmluZ2lmeShEQi5jb21wYW55Tm90ZXMpKTsgfSB9Y2F0Y2goXyl7IH0gfSwgMCk7CiAgICB9LCB7Y2FwdHVyZTpmYWxzZX0pOwogIH1jYXRjaChfKXt9Cn0pKCk7Cjwvc2NyaXB0Pgo8IS0tIEFMTE9XX1JVTEVTX0FMRVJUU19TTklQUEVUClN1Z2dlc3RlZCBGaXJlc3RvcmUgcnVsZXMgZm9yIGFsZXJ0cyBjb2xsZWN0aW9uIChyZXBsYWNlIHdpdGggeW91ciBzZXR1cCk6CnJ1bGVzX3ZlcnNpb24gPSAnMic7CnNlcnZpY2UgY2xvdWQuZmlyZXN0b3JlIHsKICBtYXRjaCAvZGF0YWJhc2VzL3tkYXRhYmFzZX0vZG9jdW1lbnRzIHsKICAgIG1hdGNoIC9hbGVydHMve2FsZXJ0SWR9IHsKICAgICAgYWxsb3cgcmVhZDogaWYgcmVxdWVzdC5hdXRoICE9IG51bGwgJiYgcmVzb3VyY2UuZGF0YS51aWQgPT0gcmVxdWVzdC5hdXRoLnVpZDsKICAgICAgYWxsb3cgY3JlYXRlOiBpZiByZXF1ZXN0LmF1dGggIT0gbnVsbCAmJiByZXF1ZXN0LnJlc291cmNlLmRhdGEudWlkID09IHJlcXVlc3QuYXV0aC51aWQ7CiAgICAgIGFsbG93IHVwZGF0ZSwgZGVsZXRlOiBpZiByZXF1ZXN0LmF1dGggIT0gbnVsbCAmJiByZXNvdXJjZS5kYXRhLnVpZCA9PSByZXF1ZXN0LmF1dGgudWlkOwogICAgfQogIH0KfQotLT4KCgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBpZiAodHlwZW9mIHdpbmRvdy5vcGVuTW9kYWwgIT09ICdmdW5jdGlvbicpewogICAgd2luZG93Lm9wZW5Nb2RhbCA9IGZ1bmN0aW9uKHt0aXRsZT0nSW5mb3JtYWNqYScsIGlubmVySFRNTD0nJywgb2tUZXh0PSdPSycsIGNhbmNlbFRleHQ9J0FudWx1aid9PXt9KXsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKT0+ewogICAgICAgIGNvbnN0IG92ZXJsYXkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBPYmplY3QuYXNzaWduKG92ZXJsYXkuc3R5bGUsIHtwb3NpdGlvbjonZml4ZWQnLCBpbnNldDonMCcsIGJhY2tncm91bmQ6J3JnYmEoMiw2LDIzLDAuNjYpJywgYmFja2Ryb3BGaWx0ZXI6J2JsdXIoNnB4KScsIHpJbmRleDonOTk5OTknLCBkaXNwbGF5OidmbGV4JywgYWxpZ25JdGVtczonY2VudGVyJywganVzdGlmeUNvbnRlbnQ6J2NlbnRlcicsIHBhZGRpbmc6JzE2cHgnfSk7CiAgICAgICAgY29uc3QgYm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgT2JqZWN0LmFzc2lnbihib3guc3R5bGUsIHtiYWNrZ3JvdW5kOidsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDE3LDI0LDM5LC45OCksIHJnYmEoMTUsMjMsNDIsLjk4KSknLGNvbG9yOid2YXIoLS10ZXh0KScsYm9yZGVyOicxcHggc29saWQgIzMzNDE1NScsbWF4V2lkdGg6JzcyMHB4Jywgd2lkdGg6JzEwMCUnLCBib3JkZXJSYWRpdXM6JzE2cHgnLCBwYWRkaW5nOicxNnB4Jyxib3hTaGFkb3c6JzAgMTBweCAyNXB4IHJnYmEoMCwwLDAsLjM1KSd9KTsKICAgICAgICBib3guaW5uZXJIVE1MID0gYAogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjtnYXA6OHB4O21hcmdpbi1ib3R0b206OHB4OyI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luOjA7Zm9udC1zaXplOjE4cHg7Ij4ke3RpdGxlfTwvaDM+CiAgICAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0ibW9kYWwteCIgYXJpYS1sYWJlbD0iWmFta25paiIgc3R5bGU9ImJvcmRlcjpub25lO2JhY2tncm91bmQ6dHJhbnNwYXJlbnQ7Zm9udC1zaXplOjE4cHg7Y3Vyc29yOnBvaW50ZXI7Y29sb3I6Izk0YTNiOCI+w5c8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtYm9keSI+JHtpbm5lckhUTUx9PC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7Z2FwOjhweDtqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmQ7bWFyZ2luLXRvcDoxMnB4OyI+CiAgICAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGdob3N0IG1vZGFsLWNhbmNlbCI+JHtjYW5jZWxUZXh0fHwnQW51bHVqJ308L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gbW9kYWwtb2siPiR7b2tUZXh0fHwnT0snfTwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+YDsKICAgICAgICBvdmVybGF5LmFwcGVuZENoaWxkKGJveCk7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChvdmVybGF5KTsKICAgICAgICBmdW5jdGlvbiBjbGVhbnVwKCl7IHRyeXsgb3ZlcmxheS5yZW1vdmUoKTsgfWNhdGNoKF8pe30gfQogICAgICAgIGZ1bmN0aW9uIGNvbGxlY3RGb3JtKCl7CiAgICAgICAgICBjb25zdCBmb3JtID0gYm94LnF1ZXJ5U2VsZWN0b3IoJ2Zvcm0nKTsKICAgICAgICAgIGlmKCFmb3JtKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgY29uc3QgZmQgPSBuZXcgRm9ybURhdGEoZm9ybSk7CiAgICAgICAgICBjb25zdCBvYmogPSB7fTsgZm9yIChjb25zdCBbayx2XSBvZiBmZC5lbnRyaWVzKCkpIG9ialtrXT12OyByZXR1cm4gb2JqOwogICAgICAgIH0KICAgICAgICBjb25zdCBjYW5jZWwgPSAoKT0+eyBjbGVhbnVwKCk7IHJlc29sdmUobnVsbCk7IH07CiAgICAgICAgYm94LnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC1vaycpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgY29uc3QgZGF0YT1jb2xsZWN0Rm9ybSgpOyBjbGVhbnVwKCk7IHJlc29sdmUoZGF0YXx8e30pOyB9KTsKICAgICAgICBib3gucXVlcnlTZWxlY3RvcignLm1vZGFsLWNhbmNlbCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2FuY2VsKTsKICAgICAgICBib3gucXVlcnlTZWxlY3RvcignLm1vZGFsLXgnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGNhbmNlbCk7CiAgICAgICAgb3ZlcmxheS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+eyBpZihlLnRhcmdldD09PW92ZXJsYXkpIGNhbmNlbCgpOyB9KTsKICAgICAgICBzZXRUaW1lb3V0KCgpPT57IGNvbnN0IGVsID0gYm94LnF1ZXJ5U2VsZWN0b3IoJ3RleHRhcmVhLCBpbnB1dCwgc2VsZWN0LCBidXR0b24nKTsgZWwgJiYgZWwuZm9jdXMgJiYgZWwuZm9jdXMoKTsgfSwwKTsKICAgICAgfSk7CiAgICB9OwogIH0KfSkoKTsKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICBjb25zdCBiID0gZS50YXJnZXQuY2xvc2VzdCgnLndsLWluZm8nKTsgaWYoIWIpIHJldHVybjsKICBjb25zdCB0ID0gYi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyk7IGlmKCF0KSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cub3BlbkNvbXBhbnlJbmZvTW9kYWwgPT09ICdmdW5jdGlvbicpeyBlLnByZXZlbnREZWZhdWx0KCk7IHdpbmRvdy5vcGVuQ29tcGFueUluZm9Nb2RhbCh0KTsgfQp9LCB0cnVlKTsKPC9zY3JpcHQ+CgoKPHNjcmlwdD4KLy8gPT09IFRyYWRpbmdWaWV3IGhlbHBlcnMgJiBnbG9iYWwgb3BlbmVyID09PQooZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBfX3R2UGFyc2VTeW1ib2wodCl7CiAgICB2YXIgcyA9IFN0cmluZyh0fHwnJykudG9VcHBlckNhc2UoKS50cmltKCk7CiAgICBpZighcykgcmV0dXJuICcnOwogICAgaWYocy5pbmNsdWRlcygnOicpKSByZXR1cm4gczsgICAgICAgICAgIC8vIGFscmVhZHkgRVhDSEFOR0U6U1lNQk9MCiAgICBpZihzLmluY2x1ZGVzKCcuJykpewogICAgICB2YXIgcGFydHMgPSBzLnNwbGl0KCcuJyk7CiAgICAgIHZhciBiYXNlID0gcGFydHNbMF0sIHN1ZiA9IHBhcnRzWzFdOwogICAgICBpZihzdWYgPT09ICdXQScpIHJldHVybiAnR1BXOicgKyBiYXNlOyAvLyBXYXJzYXcgR1BXCiAgICAgIGlmKHN1ZiA9PT0gJ0wnKSAgcmV0dXJuICdMU0U6JyArIGJhc2U7IC8vIExvbmRvbgogICAgICBpZihzdWYgPT09ICdERScpIHJldHVybiAnWEVUUjonICsgYmFzZTsgLy8gWGV0cmEgKGJlc3QtZWZmb3J0KQogICAgICBpZihzdWYgPT09ICdGJykgIHJldHVybiAnRldCOicgKyBiYXNlOyAgLy8gRnJhbmtmdXJ0IGJlc3QtZWZmb3J0CiAgICAgIHJldHVybiBzOyAvLyBrZWVwIHN1ZmZpeCAoZS5nLiwgQlJLLkIsIEJGLkIpIC8vIGZhbGxiYWNrOiBzdHJpcCBzdWZmaXgKICAgIH0KICAgIHJldHVybiBzOyAvLyBubyBleGNoYW5nZQogIH0KICBmdW5jdGlvbiBtYWtlVHJhZGluZ1ZpZXdVUkwodCl7CiAgICB2YXIgc3ltID0gX190dlBhcnNlU3ltYm9sKHQpOwogICAgdmFyIHEgPSBlbmNvZGVVUklDb21wb25lbnQoc3ltIHx8IFN0cmluZyh0fHwnJykudG9VcHBlckNhc2UoKSk7CiAgICByZXR1cm4gJ2h0dHBzOi8vcGwudHJhZGluZ3ZpZXcuY29tL2NoYXJ0Lz9zeW1ib2w9JyArIHE7CiAgfQogIC8vIGdsb2JhbCBkZWxlZ2F0aW9uICh3b3JrcyBmb3IgaG9sZGluZ3MgKyB3aXNobGlzdCkKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpewogICAgdmFyIGJ0biA9IGUudGFyZ2V0LmNsb3Nlc3QoJy50di1saW5rJyk7CiAgICBpZighYnRuKSByZXR1cm47CiAgICB2YXIgdCA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyk7CiAgICBpZighdCkgcmV0dXJuOwogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgdHJ5eyB3aW5kb3cub3BlbihtYWtlVHJhZGluZ1ZpZXdVUkwodCksICdfYmxhbmsnLCAnbm9vcGVuZXInKTsgfWNhdGNoKF8peyBsb2NhdGlvbi5ocmVmID0gbWFrZVRyYWRpbmdWaWV3VVJMKHQpOyB9CiAgfSwgdHJ1ZSk7CiAgLy8gZXhwb3NlIGZvciBwb3RlbnRpYWwgcmV1c2UKICB3aW5kb3cubWFrZVRyYWRpbmdWaWV3VVJMID0gbWFrZVRyYWRpbmdWaWV3VVJMOwp9KSgpOwo8L3NjcmlwdD4KPHNjcmlwdCBpZD0icGx1cy1pY29uLXJlbGFiZWwiPgooZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBzd2FwKGJ0bil7CiAgICBpZighYnRuKSByZXR1cm47CiAgICBjb25zdCB0eHQgPSAoYnRuLnRleHRDb250ZW50IHx8ICIiKS50cmltKCk7CiAgICBpZiAodHh0ID09PSAiKyIgfHwgdHh0ID09PSAi77yLIikgewogICAgICBidG4udGV4dENvbnRlbnQgPSAi4p6VIjsKICAgICAgaWYgKCFidG4uZ2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIikpIHsKICAgICAgICBidG4uc2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIiwiRG9kYWogcGFydGnEmSIpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGFwcGx5KCl7CiAgICBjb25zdCBzZWwgPSAnI2hvbGRpbmdzVGFibGU=";
    function b64ToUtf8(b64){ const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return new TextDecoder().decode(bytes); }
    function computeBaseHref(){ try{ const u=new URL(window.location.href); return u.origin + u.pathname.replace(/[^\/]*$/,''); }catch(_e){ return document.baseURI || '/'; } }
    function mount(){ const html=b64ToUtf8(APP_B64).replace("__BASE__", computeBaseHref()); appFrame.srcdoc=html; }

    window.addEventListener('message', (ev) => {
      if (ev.source !== appFrame.contentWindow) return;
      const msg = ev.data || {};
      if (msg.type === 'request_init') {
        appFrame.contentWindow.postMessage({ type: 'storage_apply', payload: lastSnapshot }, '*');
        appFrame.contentWindow.postMessage({ type: 'set_clear_on_exit', value: true }, '*');
        // Trigger programmatic auto-sync inside the iframe
        setTimeout(()=>{ try{ appFrame.contentWindow.postMessage({ type:'auto_sync' }, '*'); }catch(_e){} }, 150);
        setTimeout(()=>{ try{ appFrame.contentWindow.postMessage({ type:'auto_sync' }, '*'); }catch(_e){} }, 600);
        setTimeout(()=>{ try{ appFrame.contentWindow.postMessage({ type:'auto_sync' }, '*'); }catch(_e){} }, 1500);
      } else if (msg.type === 'storage_event') {
        const { key, value } = msg;
        if (!key || isReservedKey(key)) return;
        if (value === null || typeof value === 'undefined') delete lastSnapshot[key];
        else lastSnapshot[key] = value;
        const u = auth.currentUser; if (u) debounce(u.uid);
      } else if (msg.type === 'storage_clear') {
        lastSnapshot = {};
        const u = auth.currentUser; if (u) debounce(u.uid);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginView.classList.remove('hide');
        appContainer.classList.add('hide');
        if (verifyView) verifyView.classList.add('hide');
        who.textContent = '—';
        appFrame.removeAttribute('srcdoc');
        return;
      }

      // Odśwież dane użytkownika, żeby mieć aktualny status emailVerified
      try { if (typeof user.reload === 'function') await user.reload(); } catch(_){}

      if (!user.emailVerified) {
        loginView.classList.add('hide');
        appContainer.classList.add('hide');
        if (verifyView) {
          verifyView.classList.remove('hide');
          if (verifyEmail) verifyEmail.textContent = user.email || user.uid;
        }
        who.textContent = user.email || user.uid;
        appFrame.removeAttribute('srcdoc');
        return;
      }

      if (verifyView) verifyView.classList.add('hide');
      who.textContent = user.email || user.uid;
      loginView.classList.add('hide');
      appContainer.classList.remove('hide');
      try {
        const snap = await getDoc(doc(db, 'users', user.uid, 'gt', 'state'));
        lastSnapshot = (snap.exists() && snap.data().localStorage) ? snap.data().localStorage : {};
      } catch(e) { lastSnapshot = {}; }
      mount();
    });
  </script>
</body>
</html>
