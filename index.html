
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GT Multi-User (Firestore Login) — v4.5 auto-sync</title>
  <style>
    :root { --bg:#0b0f16; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --border:#1f2937; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial; }
    .center { display:flex; align-items:center; justify-content:center; min-height:100%; }
    .card { width:100%; max-width:420px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    .card h1 { font-size:22px; margin:0 0 8px; }
    .card p.small { color:var(--muted); margin:0 0 16px; }
    label { display:block; font-size:13px; color:var(--muted); margin:12px 0 6px; }
    input { width:100%; box-sizing:border-box; background:#0f172a; color:#e5e7eb; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; }
    input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.25); }
    .row { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    button { flex:1; cursor:pointer; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#0f172a; color:#e5e7eb; }
    button.primary { background:var(--accent); color:#001b0c; border-color:#16a34a; }
    button.link { background:transparent; border-color:transparent; text-decoration:underline; color:var(--muted); flex:none; }
    .error { color:var(--danger); font-size:13px; min-height:18px; margin-top:10px; }
    .hide { display:none !important; }
    #appContainer { position:fixed; inset:0; }
    #appFrame { width:100%; height:100%; border:0; background:#000; }
    .topbar { position:fixed; bottom:12px; left:12px; z-index:50; display:flex; gap:8px; align-items:center; pointer-events:none; }
    .pill { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); font-size:12px; }
    .danger { background:rgba(239,68,68,.12); border-color:#7f1d1d; }
      .topbar > * { pointer-events:auto; }
  </style>
</head>
<body>
  <div id="loginView" class="center">
    <div class="card">
      <h1>Zaloguj się</h1>
      <p class="small">Email/hasło • Dane w Firestore (nowy proj...kt). Iframe ma stubs + firewall; stan ląduje w Twoim koncie.</p>
      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
      <label for="password">Hasło</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="min. 6 znaków" />
      <div class="row">
        <button id="loginBtn" class="primary">Zaloguj</button>
        <button id="signupBtn">Utwórz konto</button> </div>
      <button id="resetBtn" class="link" type="button">Zapomniałem hasła</button>
      <div id="err" class="error"></div>
    </div>
  </div>


  <div id="verifyView" class="center hide">
    <div class="card">
      <h1>Potwierdź adres email</h1>
      <p class="small">Na adres <span id="verifyEmail"></span> wysłaliśmy link aktywacyjny.</p>
      <p class="small">Kliknij link w wiadomości, a następnie wróć tutaj.</p>
      <div class="row">
        <button id="resendVerifyBtn">Wyślij ponownie link</button>
        <button id="refreshVerifyBtn">Sprawdź ponownie</button>
      </div>
      <div id="verifyErr" class="error small"></div>
    </div>
  </div>


<div id="appContainer" class="hide">
    <div class="topbar">
      <span id="who" class="pill">—</span>
      <button id="logoutBtn" class="pill danger">Wyloguj</button>
    </div>
    <iframe id="appFrame" loading="eager"></iframe>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, setPersistence, browserLocalPersistence, sendEmailVerification, deleteUser, updatePassword} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs, deleteDoc} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfhxDgCqOaCfRKxtMECpRSjQU0TTgtGrM",
      authDomain: "mywallets-b55d9.firebaseapp.com",
      projectId: "mywallets-b55d9",
      storageBucket: "mywallets-b55d9.firebasestorage.app",
      messagingSenderId: "724728432741",
      appId: "1:724728432741:web:2a0a6302a68c78fc0ade8c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    const loginView = document.getElementById('loginView');
    const appContainer = document.getElementById('appContainer');
    const appFrame = document.getElementById('appFrame');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const err = document.getElementById('err');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn'); const logoutBtn = document.getElementById('logoutBtn');
    const verifyView = document.getElementById('verifyView');
    const verifyEmail = document.getElementById('verifyEmail');
    const resendVerifyBtn = document.getElementById('resendVerifyBtn');
    const refreshVerifyBtn = document.getElementById('refreshVerifyBtn');
    const verifyErr = document.getElementById('verifyErr');
    const resetBtn = document.getElementById('resetBtn');
    
    // ENTER = Zaloguj
    function handleEnter(e){ if(e.key === 'Enter'){ e.preventDefault(); loginBtn.click(); } }
    emailEl.addEventListener('keydown', handleEnter);
    passwordEl.addEventListener('keydown', handleEnter);
function showError(e) {
      console.error(e);
      let msg = (e && e.message) ? e.message : String(e);
      if (e && e.code) {
        const map = {
          "auth/invalid-email": "Nieprawidłowy email",
          "auth/missing-password": "Podaj hasło (min. 6 znaków)",
          "auth/weak-password": "Hasło zbyt krótkie (min. 6 znaków)",
          "auth/email-already-in-use": "Email już istnieje",
          "auth/user-not-found": "Błędny email lub hasło",
          "auth/wrong-password": "Błędny email lub hasło",
          "auth/too-many-requests": "Za dużo prób, spróbuj później",
          "auth/unauthorized-domain": "Dodaj domenę do Authorized domains (Firebase Auth)",
          "auth/invalid-credential": "Błędny email lub hasło",
          "auth/invalid-login-credentials": "Błędny email lub hasło",
};
        msg = map[e.code] || msg;
      }
      err.textContent = msg;
      setTimeout(() => { if (err.textContent === msg) err.textContent = ""; }, 7000);
    }

    const disable = (flag) => [loginBtn, signupBtn, resetBtn].forEach(b => { if (b) b.disabled = !!flag; });
    function validEmail(s) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
    function validPass(s) { return typeof s === 'string' && s.length >= 6; }
    function creds(){ return { email: emailEl.value.trim().toLowerCase(), password: passwordEl.value }; }

    // Ignore reserved keys like "__name__"
    const isReservedKey = (k) => /^__.*__$/.test(k);
    const sanitizeSnapshot = (obj) => { const out = {}; for (const k in obj) { if (!isReservedKey(k)) out[k] = obj[k]; } return out; };

    loginBtn.onclick = async () => {
      const {email,password} = creds();
      if (!validEmail(email)) return showError({ code: "auth/invalid-email" });
      if (!validPass(password)) return showError({ code: "auth/weak-password" });
      try { disable(true); await signInWithEmailAndPassword(auth, email, password); }
      catch(e){ showError(e); } finally { disable(false); }
    };
    signupBtn.onclick = async () => {
      const {email,password} = creds();
      if (!validEmail(email)) return showError({ code: "auth/invalid-email" });
      if (!validPass(password)) return showError({ code: "auth/weak-password" });
      try {
        disable(true);
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        try {
          await sendEmailVerification(cred.user);
        } catch(e) {
          console.warn('[Email verification] Nie udało się wysłać maila weryfikacyjnego', e);
        }
        const ref = doc(db, 'users', cred.user.uid, 'gt', 'state');
        await setDoc(ref, { localStorage: {}, updatedAt: serverTimestamp(), version: 1 }, { merge: true });
      } catch(e) { showError(e); } finally { disable(false); }
    };
    if (resetBtn) {
      resetBtn.onclick = async () => {
        const email = (emailEl.value || '').trim().toLowerCase();
        if (!validEmail(email)) return showError({ code: 'auth/invalid-email' });
        try {
          disable(true);
          await sendPasswordResetEmail(auth, email);
          err.textContent = 'Jeśli konto istnieje, wysłaliśmy link do resetu hasła na podany email.';
          setTimeout(() => { if (err.textContent) err.textContent = ''; }, 8000);
        } catch(e) {
          console.error(e);
          err.textContent = 'Jeśli konto istnieje, wysłaliśmy link do resetu hasła na podany email.';
          setTimeout(() => { if (err.textContent) err.textContent = ''; }, 8000);
        } finally {
          disable(false);
        }
      };
    }

    logoutBtn.onclick = async () => { await signOut(auth); };
    if (resendVerifyBtn) {
      resendVerifyBtn.onclick = async () => {
        const user = auth.currentUser;
        if (!user) {
          if (verifyErr) verifyErr.textContent = 'Brak zalogowanego użytkownika.';
          return;
        }
        try {
          resendVerifyBtn.disabled = true;
          if (verifyErr) verifyErr.textContent = '';
          await sendEmailVerification(user);
          if (verifyErr) verifyErr.textContent = 'Link weryfikacyjny został wysłany ponownie.';
        } catch(e) {
          console.error(e);
          if (verifyErr) verifyErr.textContent = 'Nie udało się wysłać maila weryfikacyjnego: ' + (e && e.message ? e.message : e);
        } finally {
          resendVerifyBtn.disabled = false;
        }
      };
    }
    if (refreshVerifyBtn) {
      refreshVerifyBtn.onclick = () => {
        window.location.reload();
      };
    }



    let lastSnapshot = {};
    let timer = null;
    const debounce = (uid) => { clearTimeout(timer); timer = setTimeout(async()=>{
      try { const sanitized = sanitizeSnapshot(lastSnapshot);
        await setDoc(doc(db, 'users', uid, 'gt', 'state'), { localStorage: sanitized, updatedAt: serverTimestamp(), version:1 }, { merge:true }); }
      catch(e){ console.error(e); }
    }, 250); };


    // Global helper for password change (used from iframe Settings)
    window.__requestPasswordChange = async (newPassword) => {
      const user = auth.currentUser;
      if (!user) {
        alert('Brak zalogowanego użytkownika.');
        return;
      }
      try {
        await updatePassword(user, newPassword);
        alert('Hasło zostało zmienione.');
      } catch (e) {
        console.error('Błąd przy zmianie hasła:', e);
        if (e && e.code === 'auth/requires-recent-login') {
          alert('Aby zmienić hasło, wyloguj się i zaloguj ponownie, a następnie spróbuj ponownie.');
        } else if (e && e.code === 'auth/weak-password') {
          alert('Hasło jest zbyt słabe. Użyj co najmniej 6 znaków, najlepiej z cyframi i liczbami.');
        } else {
          alert('Nie udało się zmienić hasła. Spróbuj ponownie później.');
        }
      }
    };

    // Global helper for account deactivation (used from iframe Settings)
    window.__requestAccountDeletion = async () => {
      const user = auth.currentUser;
      if (!user) {
        alert('Brak zalogowanego użytkownika.');
        return;
      }

      const ok = window.confirm('Czy na pewno chcesz dezaktywować konto i usunąć wszystkie dane?\nTej operacji nie można cofnąć.');
      if (!ok) return;

      try {
        // 1. Usuń dane użytkownika z Firestore (kolekcja users/{uid}/gt/*)
        try {
          const colRef = collection(db, 'users', user.uid, 'gt');
          const snap = await getDocs(colRef);
          const deletions = [];
          snap.forEach((docSnap) => {
            deletions.push(deleteDoc(docSnap.ref));
          });
          await Promise.all(deletions);
        } catch (e) {
          console.error('Błąd przy usuwaniu danych Firestore:', e);
        }

        // 2. Usuń konto użytkownika z Firebase Auth
        try {
          await deleteUser(user);
        } catch (e) {
          console.error('Błąd przy usuwaniu konta:', e);
          if (e && e.code === 'auth/requires-recent-login') {
            alert('Aby dezaktywować konto, zaloguj się ponownie i spróbuj jeszcze raz.');
            return;
          } else {
            alert('Nie udało się usunąć konta. Spróbuj ponownie później.');
            return;
          }
        }

        // 3. Wyloguj (na wszelki wypadek) i wyczyść stan lokalny
        try {
          lastSnapshot = {};
        } catch(_){}
        try {
          await signOut(auth);
        } catch(_){}

        alert('Konto zostało dezaktywowane i dane zostały usunięte.');
      } catch (e) {
        console.error('Błąd przy dezaktywacji konta:', e);
        alert('Wystąpił błąd podczas dezaktywacji konta. Spróbuj ponownie później.');
      }
    };


    const APP_B64 = "PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9InBsIj4KPGhlYWQ+CjxiYXNlIGhyZWY9Il9fQkFTRV9fIj4KCjwhLS0gR1Qgd3JhcHBlcjogTFMgYWRhcHRlciArIEZpcmVzdG9yZSBzdHVicyArIGZpcmV3YWxsICsgYXV0by1zeW5jIC0tPgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBjb25zdCBMU19QUkVGSVg9IkdUX011bHRpVXNlcl92MV9fIjsKICBjb25zdCBQVVJHRV9VTlBSRUZJWEVEPWZhbHNlOwoKICAvLyAtLS0gTmV0d29yayBmaXJld2FsbDogYmxvY2sgRmlyZWJhc2UvRmlyZXN0b3JlIGVuZHBvaW50cyBmcm9tIGlubmVyIGFwcCAtLS0KICAoZnVuY3Rpb24oKXsKICAgIGNvbnN0IEJMT0NLID0gLyhefFwuKWZpcmViYXNlaW9cLmNvbSR8KF58XC4pKGdzdGF0aWN8Z29vZ2xlYXBpcylcLmNvbSR8KF58XC4pKGZpcmVzdG9yZVwuZ29vZ2xlYXBpcylcLmNvbSQvaTsKICAgIHRyeXsKICAgICAgY29uc3QgX2ZldGNoID0gd2luZG93LmZldGNoOwogICAgICB3aW5kb3cuZmV0Y2ggPSBmdW5jdGlvbihpbnB1dCwgaW5pdCl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHVybCA9ICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSA/IGlucHV0IDogKGlucHV0ICYmIGlucHV0LnVybCkgfHwgJyc7CiAgICAgICAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgICAgaWYgKEJMT0NLLnRlc3QodS5ob3N0bmFtZSkpIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0Jsb2NrZWQgYnkgaWZyYW1lIGZpcmV3YWxsOiAnK3UuaG9zdG5hbWUpKTsKICAgICAgICB9IGNhdGNoKF9lKXt9CiAgICAgICAgcmV0dXJuIF9mZXRjaC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfWNhdGNoKF9lKXt9CiAgICB0cnl7CiAgICAgIGNvbnN0IF9vcGVuID0gWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLm9wZW47CiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgICAgaWYgKEJMT0NLLnRlc3QodS5ob3N0bmFtZSkpIHsgdGhpcy5fX2Jsb2NrZWRfYnlfZmlyZXdhbGxfXyA9IHRydWU7IH0KICAgICAgICB9IGNhdGNoKF9lKXt9CiAgICAgICAgcmV0dXJuIF9vcGVuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICAgIGNvbnN0IF9zZW5kID0gWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLnNlbmQ7CiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5fX2Jsb2NrZWRfYnlfZmlyZXdhbGxfXykgeyB0aGlzLmFib3J0KCk7IHRocm93IG5ldyBFcnJvcignQmxvY2tlZCBieSBpZnJhbWUgZmlyZXdhbGwgKFhIUiknKTsgfQogICAgICAgIHJldHVybiBfc2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfWNhdGNoKF9lKXt9CiAgfSkoKTsKCiAgLy8gLS0tIExvY2FsU3RvcmFnZSBhZGFwdGVyIHdpdGggcHJlZml4ICsgb3B0aW9uYWwgcHVyZ2Ugb2Ygb2xkIGtleXMgLS0tCiAgKGZ1bmN0aW9uKCl7CiAgICBjb25zdCBvcmlnPXdpbmRvdy5sb2NhbFN0b3JhZ2U7CiAgICB0cnl7CiAgICAgIGlmKFBVUkdFX1VOUFJFRklYRUQpewogICAgICAgIGNvbnN0IHRvRGVsPVtdOwogICAgICAgIGZvcihsZXQgaT0wO2k8b3JpZy5sZW5ndGg7aSsrKXtjb25zdCBrPW9yaWcua2V5KGkpOyBpZihrICYmICFrLnN0YXJ0c1dpdGgoTFNfUFJFRklYKSkgdG9EZWwucHVzaChrKTt9CiAgICAgICAgdG9EZWwuZm9yRWFjaChrPT57dHJ5e29yaWcucmVtb3ZlSXRlbShrKTt9Y2F0Y2goX2Upe319KTsKICAgICAgfQogICAgfWNhdGNoKF9lKXt9CiAgICBjb25zdCBtYXBLZXk9KGspPT5MU19QUkVGSVgrazsKICAgIGNvbnN0IF9zZXQ9b3JpZy5zZXRJdGVtLmJpbmQob3JpZyk7CiAgICBjb25zdCBfZ2V0PW9yaWcuZ2V0SXRlbS5iaW5kKG9yaWcpOwogICAgY29uc3QgX3JlbT1vcmlnLnJlbW92ZUl0ZW0uYmluZChvcmlnKTsKICAgIFN0b3JhZ2UucHJvdG90eXBlLnNldEl0ZW09ZnVuY3Rpb24oayx2KXsgdHJ5e19zZXQobWFwS2V5KGspLHYpO31jYXRjaChfZSl7fTsgdHJ5e3BhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTonc3RvcmFnZV9ldmVudCcsa2V5OmssdmFsdWU6dn0sJyonKTt9Y2F0Y2goX2Upe307IH07CiAgICBTdG9yYWdlLnByb3RvdHlwZS5nZXRJdGVtPWZ1bmN0aW9uKGspeyByZXR1cm4gX2dldChtYXBLZXkoaykpOyB9OwogICAgU3RvcmFnZS5wcm90b3R5cGUucmVtb3ZlSXRlbT1mdW5jdGlvbihrKXsgdHJ5e19yZW0obWFwS2V5KGspKTt9Y2F0Y2goX2Upe307IHRyeXtwYXJlbnQucG9zdE1lc3NhZ2Uoe3R5cGU6J3N0b3JhZ2VfZXZlbnQnLGtleTprLHZhbHVlOm51bGx9LCcqJyk7fWNhdGNoKF9lKXt9OyB9OwogICAgU3RvcmFnZS5wcm90b3R5cGUuY2xlYXI9ZnVuY3Rpb24oKXsgdHJ5e2NvbnN0IGtleXM9W107IGZvcihsZXQgaT0wO2k8b3JpZy5sZW5ndGg7aSsrKXtjb25zdCBrZXk9b3JpZy5rZXkoaSk7IGlmKGtleSYma2V5LnN0YXJ0c1dpdGgoTFNfUFJFRklYKSkga2V5cy5wdXNoKGtleSk7fSBrZXlzLmZvckVhY2goaz0+X3JlbShrKSk7fWNhdGNoKF9lKXt9OyB0cnl7cGFyZW50LnBvc3RNZXNzYWdlKHt0eXBlOidzdG9yYWdlX2NsZWFyJ30sJyonKTt9Y2F0Y2goX2Upe307IH07CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsKGV2KT0+ewogICAgICBjb25zdCBtc2c9ZXYuZGF0YXx8e307CiAgICAgIGlmKG1zZy50eXBlPT09J3N0b3JhZ2VfYXBwbHknJiZtc2cucGF5bG9hZCl7CiAgICAgICAgT2JqZWN0LmtleXMobXNnLnBheWxvYWQpLmZvckVhY2goaz0+eyB0cnl7X3NldChtYXBLZXkoayksbXNnLnBheWxvYWRba10pO31jYXRjaChfZSl7fTsgfSk7CiAgICAgIH0gZWxzZSBpZihtc2cudHlwZT09PSdzZXRfY2xlYXJfb25fZXhpdCcpeyB3aW5kb3cuX19HVF9DTEVBUl9PTl9FWElUX189ISFtc2cudmFsdWU7IH0KICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsKCk9PnsKICAgICAgaWYod2luZG93Ll9fR1RfQ0xFQVJfT05fRVhJVF9fKXsKICAgICAgICB0cnl7Y29uc3Qga2V5cz1bXTsgZm9yKGxldCBpPTA7aTxvcmlnLmxlbmd0aDtpKyspe2NvbnN0IGtleT1vcmlnLmtleShpKTsgaWYoa2V5JiZrZXkuc3RhcnRzV2l0aChMU19QUkVGSVgpKSBrZXlzLnB1c2goa2V5KTt9IGtleXMuZm9yRWFjaChrPT57dHJ5e19yZW0oayk7fWNhdGNoKF9lKXt9fSk7fWNhdGNoKF9lKXt9CiAgICAgIH0KICAgIH0pOwogICAgdHJ5eyBwYXJlbnQucG9zdE1lc3NhZ2Uoe3R5cGU6J3JlcXVlc3RfaW5pdCd9LCcqJyk7IH1jYXRjaChfZSl7fQogIH0pKCk7CgogIC8vIC0tLSBGaXJlc3RvcmUgY29tcGF0IHN0dWJzIGJhY2tlZCBieSBsb2NhbFN0b3JhZ2UgKGtleTogR1RGU19TVE9SRSkgKyBhdXRvLXN5bmMgaG9vayAtLS0KICAoZnVuY3Rpb24oKXsKICAgIGZ1bmN0aW9uIG5vb3AoKXt9CiAgICBmdW5jdGlvbiByZXNvbHZlZCh2KXsgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2KTsgfQogICAgZnVuY3Rpb24gbm93KCl7IHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7IH0KCiAgICBjb25zdCBTVFVCX0tFWSA9ICJHVEZTX1NUT1JFIjsKCiAgICBmdW5jdGlvbiBsb2FkU3RvcmUoKXsKICAgICAgdHJ5eyBjb25zdCByYXcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVFVCX0tFWSk7IGlmKCFyYXcpIHJldHVybiB7IGM6e30gfTsgcmV0dXJuIEpTT04ucGFyc2UocmF3KTsgfWNhdGNoKGUpeyByZXR1cm4geyBjOnt9IH07IH0KICAgIH0KICAgIGZ1bmN0aW9uIHNhdmVTdG9yZShzdG9yZSl7CiAgICAgIHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RVQl9LRVksIEpTT04uc3RyaW5naWZ5KHN0b3JlKSk7IH1jYXRjaChfZSl7fQogICAgfQogICAgY29uc3Qgc3RvcmUgPSBsb2FkU3RvcmUoKTsKCiAgICBmdW5jdGlvbiBjbG9uZSh2KXsgdHJ5eyByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh2KSk7IH1jYXRjaChfZSl7IHJldHVybiB2OyB9IH0KICAgIGZ1bmN0aW9uIGVuc3VyZUNvbChuYW1lKXsgaWYoIXN0b3JlLmNbbmFtZV0pIHN0b3JlLmNbbmFtZV0gPSB7fTsgcmV0dXJuIHN0b3JlLmNbbmFtZV07IH0KICAgIGZ1bmN0aW9uIG1ha2VJZCgpeyByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiwgMTApICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiwgMTApOyB9CgogICAgZnVuY3Rpb24gbWFrZURvY1NuYXBzaG90KGlkLCBkYXRhKXsKICAgICAgcmV0dXJuIHsgaWQsIGV4aXN0czogZGF0YSAhPSBudWxsLCBkYXRhOiAoKSA9PiBjbG9uZShkYXRhIHx8IHt9KSB9OwogICAgfQogICAgZnVuY3Rpb24gbWFrZVF1ZXJ5U25hcHNob3QoZG9jcyl7CiAgICAgIHJldHVybiB7IGVtcHR5OiAhZG9jcyB8fCBkb2NzLmxlbmd0aCA9PT0gMCwgc2l6ZTogKGRvY3MgfHwgW10pLmxlbmd0aCwgZG9jczogKGRvY3MgfHwgW10pLm1hcChkID0+ICh7IGlkOiBkLmlkLCBkYXRhOiAoKSA9PiBjbG9uZShkLmRhdGEpIH0pKSB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5V2hlcmUoYXJyLCBmaWVsZCwgb3AsIHZhbHVlKXsKICAgICAgaWYgKCFhcnIpIHJldHVybiBbXTsKICAgICAgaWYgKG9wICE9PSAnPT0nICYmIG9wICE9PSAnaW4nICYmIG9wICE9PSAnYXJyYXktY29udGFpbnMnICYmIG9wICE9PSAnPj0nICYmIG9wICE9PSAnPD0nICYmIG9wICE9PSAnPicgJiYgb3AgIT09ICc8JykgcmV0dXJuIGFycjsKICAgICAgcmV0dXJuIGFyci5maWx0ZXIoaXRlbSA9PiB7CiAgICAgICAgY29uc3QgdiA9IGl0ZW0uZGF0YVtmaWVsZF07CiAgICAgICAgc3dpdGNoKG9wKXsKICAgICAgICAgIGNhc2UgJz09JzogcmV0dXJuIHYgPT09IHZhbHVlOwogICAgICAgICAgY2FzZSAnPj0nOiByZXR1cm4gdiA+PSB2YWx1ZTsKICAgICAgICAgIGNhc2UgJzw9JzogcmV0dXJuIHYgPD0gdmFsdWU7CiAgICAgICAgICBjYXNlICc+JzogIHJldHVybiB2ID4gIHZhbHVlOwogICAgICAgICAgY2FzZSAnPCc6ICByZXR1cm4gdiA8ICB2YWx1ZTsKICAgICAgICAgIGNhc2UgJ2luJzogcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmluY2x1ZGVzKHYpOwogICAgICAgICAgY2FzZSAnYXJyYXktY29udGFpbnMnOiByZXR1cm4gQXJyYXkuaXNBcnJheSh2KSAmJiB2LmluY2x1ZGVzKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbGxlY3Rpb25SZWYobmFtZSl7CiAgICAgIGNvbnN0IGFwaSA9IHt9OwogICAgICBhcGkuZG9jID0gZnVuY3Rpb24oaWQpewogICAgICAgIGNvbnN0IGRvY0lkID0gaWQgfHwgbWFrZUlkKCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGlkOiBkb2NJZCwKICAgICAgICAgIGdldDogKCkgPT4geyBjb25zdCBjb2wgPSBlbnN1cmVDb2wobmFtZSk7IGNvbnN0IGRhdGEgPSBjb2xbZG9jSWRdOyByZXR1cm4gcmVzb2x2ZWQobWFrZURvY1NuYXBzaG90KGRvY0lkLCBkYXRhKSk7IH0sCiAgICAgICAgICBzZXQ6IChkYXRhLCBvcHRzKSA9PiB7IGNvbnN0IGNvbCA9IGVuc3VyZUNvbChuYW1lKTsgY29sW2RvY0lkXSA9IChvcHRzICYmIG9wdHMubWVyZ2UpID8gT2JqZWN0LmFzc2lnbih7fSwgY29sW2RvY0lkXXx8e30sIGNsb25lKGRhdGEpKSA6IGNsb25lKGRhdGEpOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoKTsgfSwKICAgICAgICAgIHVwZGF0ZTogKHBhdGNoKSA9PiB7IGNvbnN0IGNvbCA9IGVuc3VyZUNvbChuYW1lKTsgY29sW2RvY0lkXSA9IE9iamVjdC5hc3NpZ24oe30sIGNvbFtkb2NJZF18fHt9LCBjbG9uZShwYXRjaCkpOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoKTsgfSwKICAgICAgICAgIGRlbGV0ZTogKCkgPT4geyBjb25zdCBjb2wgPSBlbnN1cmVDb2wobmFtZSk7IGRlbGV0ZSBjb2xbZG9jSWRdOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoKTsgfSwKICAgICAgICAgIG9uU25hcHNob3Q6IChjYikgPT4geyBjb25zdCBjb2wgPSBlbnN1cmVDb2wobmFtZSk7IGNvbnN0IGRhdGEgPSBjb2xbZG9jSWRdOyB0cnl7IGNiKG1ha2VEb2NTbmFwc2hvdChkb2NJZCwgZGF0YSkpOyB9Y2F0Y2goX2Upe30gcmV0dXJuIG5vb3A7IH0KICAgICAgICB9OwogICAgICB9OwogICAgICBhcGkuYWRkID0gZnVuY3Rpb24oZGF0YSl7IGNvbnN0IGlkID0gbWFrZUlkKCk7IGNvbnN0IGNvbCA9IGVuc3VyZUNvbChuYW1lKTsgY29sW2lkXSA9IGNsb25lKGRhdGEpOyBzYXZlU3RvcmUoc3RvcmUpOyByZXR1cm4gcmVzb2x2ZWQoeyBpZCB9KTsgfTsKCiAgICAgIGZ1bmN0aW9uIHF1ZXJ5T2JqKGxpc3QpewogICAgICAgIGNvbnN0IHEgPSB7fTsKICAgICAgICBxLl9saXN0ID0gbGlzdCB8fCBPYmplY3QuZW50cmllcyhlbnN1cmVDb2wobmFtZSkpLm1hcCgoW2lkLGRhdGFdKSA9PiAoeyBpZCwgZGF0YSB9KSk7CiAgICAgICAgcS53aGVyZSA9IGZ1bmN0aW9uKGZpZWxkLCBvcCwgdmFsdWUpeyBxLl9saXN0ID0gYXBwbHlXaGVyZShxLl9saXN0LCBmaWVsZCwgb3AsIHZhbHVlKTsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5vcmRlckJ5ID0gZnVuY3Rpb24oZmllbGQsIGRpcil7IHEuX2xpc3Quc29ydCgoYSxiKT0+eyBpZiAoYS5kYXRhW2ZpZWxkXSA9PSBiLmRhdGFbZmllbGRdKSByZXR1cm4gMDsgcmV0dXJuIChhLmRhdGFbZmllbGRdIDwgYi5kYXRhW2ZpZWxkXSA/IC0xIDogMSkgKiAoZGlyPT09J2Rlc2MnPy0xOjEpOyB9KTsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5saW1pdCA9IGZ1bmN0aW9uKG4peyBxLl9saXN0ID0gcS5fbGlzdC5zbGljZSgwLCBuKTsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5zdGFydEFmdGVyID0gZnVuY3Rpb24oKXsgcmV0dXJuIHE7IH07CiAgICAgICAgcS5lbmRCZWZvcmUgPSBmdW5jdGlvbigpeyByZXR1cm4gcTsgfTsKICAgICAgICBxLmdldCA9IGZ1bmN0aW9uKCl7IHJldHVybiByZXNvbHZlZChtYWtlUXVlcnlTbmFwc2hvdChxLl9saXN0KSk7IH07CiAgICAgICAgcS5vblNuYXBzaG90ID0gZnVuY3Rpb24oY2IpeyB0cnl7IGNiKG1ha2VRdWVyeVNuYXBzaG90KHEuX2xpc3QpKTsgfWNhdGNoKF9lKXt9OyByZXR1cm4gbm9vcDsgfTsKICAgICAgICByZXR1cm4gcTsKICAgICAgfQogICAgICBhcGkud2hlcmUgPSBmdW5jdGlvbihmaWVsZCwgb3AsIHZhbHVlKXsgcmV0dXJuIHF1ZXJ5T2JqKCkud2hlcmUoZmllbGQsIG9wLCB2YWx1ZSk7IH07CiAgICAgIGFwaS5nZXQgPSBmdW5jdGlvbigpeyByZXR1cm4gcXVlcnlPYmooKS5nZXQoKTsgfTsKICAgICAgYXBpLm9uU25hcHNob3QgPSBmdW5jdGlvbihjYil7IHJldHVybiBxdWVyeU9iaigpLm9uU25hcHNob3QoY2IpOyB9OwoKICAgICAgcmV0dXJuIGFwaTsKICAgIH0KCiAgICBpZiAoIXdpbmRvdy5maXJlYmFzZSkgd2luZG93LmZpcmViYXNlID0ge307CiAgICB3aW5kb3cuZmlyZWJhc2UuYXBwcyA9IFt7fV07CiAgICB3aW5kb3cuZmlyZWJhc2UuaW5pdGlhbGl6ZUFwcCA9IGZ1bmN0aW9uKCl7IHJldHVybiB7fTsgfTsKICAgIHdpbmRvdy5maXJlYmFzZS5maXJlc3RvcmUgPSBmdW5jdGlvbigpeyByZXR1cm4geyBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uUmVmLCBkb2M6IChpZCk9PmNvbGxlY3Rpb25SZWYoJ19yb290JykuZG9jKGlkKSwgRmllbGRWYWx1ZTogeyBzZXJ2ZXJUaW1lc3RhbXA6ICgpID0+ICh7IF9fc2VydmVyVGltZXN0YW1wOnRydWUsIGF0OiBub3coKSB9KSB9IH07IH07CiAgICB3aW5kb3cuZmlyZWJhc2UuZmlyZXN0b3JlLkZpZWxkVmFsdWUgPSB7IHNlcnZlclRpbWVzdGFtcDogKCkgPT4gKHsgX19zZXJ2ZXJUaW1lc3RhbXA6dHJ1ZSwgYXQ6IG5vdygpIH0pIH07CiAgICB3aW5kb3cuZmlyZWJhc2UuYXV0aCA9IGZ1bmN0aW9uKCl7IHJldHVybiB7IHNldFBlcnNpc3RlbmNlOiAoKT0+cmVzb2x2ZWQoKSwgc2lnbkluQW5vbnltb3VzbHk6ICgpPT5yZXNvbHZlZCh7IHVzZXI6eyB1aWQ6J3N0dWInIH0gfSksIGN1cnJlbnRVc2VyOiB7IHVpZDonc3R1YicgfSwgb25BdXRoU3RhdGVDaGFuZ2VkOiAoY2IpPT57IHRyeXsgY2IoeyB1aWQ6J3N0dWInIH0pOyB9Y2F0Y2goX2Upe307IHJldHVybiAoKT0+e307IH0gfTsgfTsKICAgIHdpbmRvdy5maXJlYmFzZS5hdXRoLkF1dGggPSB7IFBlcnNpc3RlbmNlOiB7IExPQ0FMOidMT0NBTCcsIFNFU1NJT046J1NFU1NJT04nLCBOT05FOidOT05FJyB9IH07CiAgICBjb25zb2xlLmxvZygiR1QgRmlyZXN0b3JlIHN0dWI6IHJlYWR5Iik7CgogICAgLy8gLS0tIEF1dG8tc3luYyBoYW5kbGVyIGZyb20gd3JhcHBlciAtLS0KICAgIGZ1bmN0aW9uIHNlZWRTdHViRnJvbUxvY2FsKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBMU19LRVkgPSAodHlwZW9mIGRldGVjdExTS2V5PT09J2Z1bmN0aW9uJykgPyBkZXRlY3RMU0tleSgpIDogJ3BvcnRmZWxlX2Zpcm15X3YxJzsKICAgICAgICBjb25zdCByYXcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19LRVkpOwogICAgICAgIGlmICghcmF3KSByZXR1cm4gZmFsc2U7CiAgICAgICAgbGV0IGRhdGE9bnVsbDsgdHJ5eyBkYXRhID0gSlNPTi5wYXJzZShyYXcpOyB9Y2F0Y2goX2UpeyByZXR1cm4gZmFsc2U7IH0KICAgICAgICBjb25zdCBGQl9DT0wgPSAodHlwZW9mIHdpbmRvdy5GQl9DT0whPT0ndW5kZWZpbmVkJykgPyB3aW5kb3cuRkJfQ09MIDogJ2d0X3BvcnRmb2xpb3MnOwogICAgICAgIGNvbnN0IEZCX0RPQyA9ICh0eXBlb2Ygd2luZG93LkZCX0RPQyE9PSd1bmRlZmluZWQnKSA/IHdpbmRvdy5GQl9ET0MgOiAnZGVmYXVsdCc7CiAgICAgICAgY29uc3QgY29sID0gZW5zdXJlQ29sKEZCX0NPTCk7CiAgICAgICAgY29sW0ZCX0RPQ10gPSBjbG9uZShkYXRhKTsKICAgICAgICBzYXZlU3RvcmUoc3RvcmUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9Y2F0Y2goX2UpewogICAgICAgIGNvbnNvbGUud2Fybignc2VlZFN0dWJGcm9tTG9jYWwgZXJyb3InLCBfZSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdHJ5SGFyZERvd25sb2FkKCl7CiAgICAgIHRyeXsKICAgICAgICBpZiAodHlwZW9mIGhhcmREb3dubG9hZD09PSdmdW5jdGlvbicpewogICAgICAgICAgcmV0dXJuIGhhcmREb3dubG9hZCh0cnVlKTsKICAgICAgICB9CiAgICAgIH1jYXRjaChfZSl7IGNvbnNvbGUud2FybignaGFyZERvd25sb2FkIGNhbGwgZXJyb3InLCBfZSk7IH0KICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7CiAgICB9CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZXYpPT57CiAgICAgIGNvbnN0IG1zZyA9IGV2LmRhdGF8fHt9OwogICAgICBpZiAobXNnLnR5cGU9PT0nYXV0b19zeW5jJyl7CiAgICAgICAgY29uc3Qgc2VlZGVkID0gc2VlZFN0dWJGcm9tTG9jYWwoKTsKICAgICAgICAvLyBuYXdldCBqZcWbbGkgbmllIHVkYcWCbyBzacSZIHphc2lsacSHLCBzcHLDs2J1aiBwb2JyYcSHCiAgICAgICAgdHJ5SGFyZERvd25sb2FkKCk7CiAgICAgIH0KICAgIH0pOwogIH0pKCk7Cn0pKCk7Cjwvc2NyaXB0PgoKCiAgPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIiAvPgogIDx0aXRsZT5Qb3J0ZmVsZSDigJQgdjI8L3RpdGxlPgogIDxzdHlsZT4KICAgIDpyb290ewogICAgICAtLWJnOiMwZjE3MmE7ICAgICAgICAvKiBzbGF0ZS05MDAgKi8KICAgICAgLS1wYW5lbDojMTExODI3OyAgICAgLyogZ3JheS05MDAgKi8KICAgICAgLS1wYW5lbC0yOiMxZjI5Mzc7ICAgLyogZ3JheS04MDAgKi8KICAgICAgLS1tdXRlZDojOTRhM2I4OyAgICAgLyogc2xhdGUtNDAwICovCiAgICAgIC0tdGV4dDojZTVlN2ViOyAgICAgIC8qIGdyYXktMjAwICovCiAgICAgIC0tYWNjZW50OiMyMmQzZWU7ICAgIC8qIGN5YW4tNDAwICovCiAgICAgIC0tYWNjZW50LTI6IzA2YjZkNDsgIC8qIGN5YW4tNTAwICovCiAgICAgIC0tZGFuZ2VyOiNlZjQ0NDQ7ICAgIC8qIHJlZC01MDAgKi8KICAgICAgLS1vazojMTBiOTgxOyAgICAgICAgLyogZW1lcmFsZC01MDAgKi8KICAgICAgLS13YXJuOiNmNTllMGI7ICAgICAgLyogYW1iZXItNTAwICovCiAgICAgIC0tc2hhZG93OiAwIDEwcHggMjVweCByZ2JhKDAsMCwwLC4zNSk7CiAgICAgIC0tcmFkaXVzOiAxNHB4OwogICAgfQogICAgKnsgYm94LXNpemluZzogYm9yZGVyLWJveDsgfQogICAgaHRtbCxib2R5e2hlaWdodDoxMDAlfQogICAgYm9keXsKICAgICAgbWFyZ2luOjA7CiAgICAgIGZvbnQtZmFtaWx5OiB1aS1zYW5zLXNlcmlmLCBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIFNlZ29lIFVJLCBSb2JvdG8sIEludGVyLCBOb3RvIFNhbnMsIFVidW50dSwgQ2FudGFyZWxsLCBBcmlhbCwgQXBwbGUgQ29sb3IgRW1vamksIFNlZ29lIFVJIEVtb2ppLCBTZWdvZSBVSSBTeW1ib2w7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMjBkZWcsIzBiMTIyMiAwJSwjMGYxNzJhIDQwJSwgIzEwMTUyNSAxMDAlKTsKICAgICAgY29sb3I6IHZhcigtLXRleHQpOwogICAgfQogICAgaGVhZGVyewogICAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgICAgIHBhZGRpbmc6MTRweCAxOHB4OyBwb3NpdGlvbjpzdGlja3k7IHRvcDowOyB6LWluZGV4OjU7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgwZGVnLCByZ2JhKDE1LDIzLDQyLC42KSwgcmdiYSgxNSwyMyw0MiwuNikpOwogICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICMxMTE4Mjc7CiAgICAgIGJveC1zaGFkb3c6IHZhcigtLXNoYWRvdyk7CiAgICB9CiAgICBoZWFkZXIgaDF7IG1hcmdpbjowOyBmb250LXdlaWdodDo3MDA7IGZvbnQtc2l6ZTogY2xhbXAoMThweCwgMnZ3LCAyMnB4KTsgbGV0dGVyLXNwYWNpbmc6LjNweDsgfQogICAgaGVhZGVyIC5hY3Rpb25zeyBkaXNwbGF5OmZsZXg7IGdhcDo4cHg7IGZsZXgtd3JhcDp3cmFwO30KICAgIC5idG57CiAgICAgIGJvcmRlcjpub25lOyBib3JkZXItcmFkaXVzOjEwcHg7CiAgICAgIHBhZGRpbmc6MTBweCAxNHB4OyBjb2xvcjojMGIxMjIyOyBmb250LXdlaWdodDo2MDA7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWFjY2VudCk7IGN1cnNvcjpwb2ludGVyOwogICAgICB0cmFuc2l0aW9uOi4ycyB0cmFuc2Zvcm0gZWFzZSwgLjJzIGJveC1zaGFkb3cgZWFzZSwgLjJzIGZpbHRlciBlYXNlOwogICAgICBib3gtc2hhZG93OiAwIDhweCAyMHB4IHJnYmEoMzQsMjExLDIzOCwuMjUpOwogICAgfQogICAgLmJ0bjpob3ZlcnsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xcHgpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS4wNSk7IH0KICAgIC5idG46YWN0aXZleyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMHB4KSBzY2FsZSguOTgpOyB9CiAgICAuYnRuLnNlY29uZGFyeXsgYmFja2dyb3VuZDojMzM0MTU1OyBjb2xvcjogdmFyKC0tdGV4dCk7IGJveC1zaGFkb3c6bm9uZTsgfQogICAgLmJ0bi5naG9zdHsgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7IGNvbG9yOiB2YXIoLS10ZXh0KTsgYm9yZGVyOjFweCBzb2xpZCAjMzM0MTU1OyB9CiAgICAuYnRuLndhcm57IGJhY2tncm91bmQ6IHZhcigtLXdhcm4pOyBjb2xvcjojMGIxMjIyOyB9CiAgICAuYnRuLmRhbmdlcnsgYmFja2dyb3VuZDogdmFyKC0tZGFuZ2VyKTsgY29sb3I6I2ZmZjsgfQogICAgLmJ0bi5va3sgYmFja2dyb3VuZDogdmFyKC0tb2spOyBjb2xvcjojMGIxMjIyOyB9CiAgICAubGF5b3V0eyBkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMzMwcHggMWZyOyBnYXA6MTRweDsgcGFkZGluZzoxNHB4OyB9CiAgICBAbWVkaWEgKG1heC13aWR0aDogOTgwcHgpeyAubGF5b3V0eyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsgfSB9CiAgICAuY2FyZHsKICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgxNywyNCwzOSwuODUpLCByZ2JhKDE2LDIzLDQyLC45MikpOwogICAgICBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7CiAgICAgIGJvcmRlci1yYWRpdXM6IHZhcigtLXJhZGl1cyk7CiAgICAgIGJveC1zaGFkb3c6IHZhcigtLXNoYWRvdyk7CiAgICB9CiAgICAuc2lkZWJhcnsgcGFkZGluZzoxNHB4OyBtaW4taGVpZ2h0OiBjYWxjKDEwMHN2aCAtIDgwcHgpOyB9CiAgICAuc2lkZWJhciAuaGVhZHsgZGlzcGxheTpmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6Y2VudGVyOyBtYXJnaW4tYm90dG9tOjhweDsgfQogICAgLnBvcnRmb2xpb3N7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBnYXA6OHB4OyB9CiAgICAucG9ydGZvbGlvLWl0ZW17CiAgICAgIHBhZGRpbmc6MTBweDsgYm9yZGVyLXJhZGl1czoxMnB4OyBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICMwZjE3MmEsICMwYjEyMjIpOwogICAgICBjdXJzb3I6cG9pbnRlcjsgdHJhbnNpdGlvbjouMTVzIGVhc2U7CiAgICB9CiAgICAucG9ydGZvbGlvLWl0ZW06aG92ZXJ7IGJvcmRlci1jb2xvcjojMzM0MTU1OyB9CiAgICAucG9ydGZvbGlvLWl0ZW0uYWN0aXZleyBib3JkZXItY29sb3I6IHZhcigtLWFjY2VudCk7IGJveC1zaGFkb3c6IDAgMCAwIDFweCBpbnNldCB2YXIoLS1hY2NlbnQpOyB9CiAgICAucG9ydGZvbGlvLWl0ZW0gLm5hbWV7IGZvbnQtd2VpZ2h0OjcwMDsgZm9udC1zaXplOjE1cHg7IH0KICAgIC5wb3J0Zm9saW8taXRlbSAucm93eyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBnYXA6OHB4OyBjb2xvcjogdmFyKC0tbXV0ZWQpOyBmb250LXNpemU6MTNweDsgbWFyZ2luLXRvcDo0cHg7IH0KICAgIC5tYWlueyBwYWRkaW5nOjE0cHg7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBnYXA6MTRweDsgfQogICAgLnBhbmVseyBwYWRkaW5nOjE0cHg7IH0KICAgIC5wYW5lbCBoMnsgbWFyZ2luOjAgMCAxMHB4IDA7IGZvbnQtc2l6ZToxOHB4OyB9CiAgICAuZ3JpZHsgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgxMiwgMWZyKTsgZ2FwOjE0cHg7IH0KICAgIC5jb2wtNHsgZ3JpZC1jb2x1bW46IHNwYW4gNDsgfSAuY29sLTZ7IGdyaWQtY29sdW1uOiBzcGFuIDY7IH0gLmNvbC04eyBncmlkLWNvbHVtbjogc3BhbiA4OyB9IC5jb2wtMTJ7IGdyaWQtY29sdW1uOiBzcGFuIDEyOyB9CiAgICBAbWVkaWEgKG1heC13aWR0aDogOTgwcHgpeyAuY29sLTQsLmNvbC02LC5jb2wtOHsgZ3JpZC1jb2x1bW46IHNwYW4gMTI7IH0gfQogICAgLnN0YXR7CiAgICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICAgICAgcGFkZGluZzoxMnB4OyBib3JkZXItcmFkaXVzOjEycHg7IGJhY2tncm91bmQ6IzBiMTIyMjsgYm9yZGVyOjFweCBzb2xpZCAjMWYyOTM3OwogICAgfQogICAgLm11dGVkeyBjb2xvcjogdmFyKC0tbXV0ZWQpOyB9CiAgICAucm93eyBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjhweDsgZmxleC13cmFwOiB3cmFwOyB9CiAgICAuc3BhY2VyeyBmbGV4OiAxIDEgYXV0bzsgfQogICAgdGV4dGFyZWEsIGlucHV0LCBzZWxlY3R7CiAgICAgIHdpZHRoOjEwMCU7IHBhZGRpbmc6MTBweCAxMnB4OyBib3JkZXItcmFkaXVzOjEwcHg7IGJvcmRlcjoxcHggc29saWQgIzMzNDE1NTsgYmFja2dyb3VuZDojMGIxMjIyOwogICAgICBjb2xvcjp2YXIoLS10ZXh0KTsgb3V0bGluZTpub25lOyBmb250LXNpemU6MTRweDsKICAgIH0KICAgIGxhYmVseyBkaXNwbGF5OmJsb2NrOyBmb250LXNpemU6MTNweDsgY29sb3I6IHZhcigtLW11dGVkKTsgbWFyZ2luLWJvdHRvbTo2cHg7IH0KICAgIHRhYmxleyB3aWR0aDoxMDAlOyBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyB9CiAgICB0aCwgdGR7IHRleHQtYWxpZ246bGVmdDsgcGFkZGluZzoxMHB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCAjMWYyOTM3OyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyB9CiAgICB0aHsgY29sb3I6ICNjYmQ1ZTE7IGZvbnQtd2VpZ2h0OjcwMDsgYmFja2dyb3VuZDojMGIxMjIyOyBwb3NpdGlvbjpzdGlja3k7IHRvcDowOyB9CiAgICB0cjpob3ZlciB0ZHsgYmFja2dyb3VuZDogcmdiYSgzLCA3LCAxOCwgLjQpOyB9CiAgICAudGlja2VyeyBmb250LWZhbWlseTogdWktbW9ub3NwYWNlLCBTRk1vbm8tUmVndWxhciwgTWVubG8sIE1vbmFjbywgQ29uc29sYXMsICJMaWJlcmF0aW9uIE1vbm8iLCAiQ291cmllciBOZXciLCBtb25vc3BhY2U7IGxldHRlci1zcGFjaW5nOi4zcHg7IGZvbnQtd2VpZ2h0OjcwMDsgfQogICAgZGV0YWlscyBzdW1tYXJ5eyBjdXJzb3I6cG9pbnRlcjsgdXNlci1zZWxlY3Q6bm9uZTsgfQogICAgLnRhZ3sgcGFkZGluZzo0cHggOHB4OyBib3JkZXItcmFkaXVzOjk5OXB4OyBiYWNrZ3JvdW5kOiMxMTE4Mjc7IGJvcmRlcjoxcHggc29saWQgIzFmMjkzNzsgZm9udC1zaXplOjEycHg7IGNvbG9yOiNjYmQ1ZTE7IH0KICAgIGZvb3RlcnsgY29sb3I6dmFyKC0tbXV0ZWQpOyB0ZXh0LWFsaWduOmNlbnRlcjsgcGFkZGluZzoxOHB4IDhweDsgfQogICAgZGlhbG9neyBib3JkZXI6bm9uZTsgYm9yZGVyLXJhZGl1czoxNnB4OyBwYWRkaW5nOjA7IGJhY2tncm91bmQ6dHJhbnNwYXJlbnQ7IAogICAgICBjb2xvcjogdmFyKC0tdGV4dCk7Cn0KICAgIC5tb2RhbHsKICAgICAgY29sb3I6IHZhcigtLXRleHQpOwogYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgxNywyNCwzOSwuOTgpLCByZ2JhKDE1LDIzLDQyLC45OCkpOyBib3JkZXI6MXB4IHNvbGlkICMzMzQxNTU7IGJvcmRlci1yYWRpdXM6MTZweDsgd2lkdGg6bWluKDcyMHB4LCA5NnZ3KTsgYm94LXNoYWRvdzogdmFyKC0tc2hhZG93KTsgfQogICAgLm1vZGFsIGhlYWRlcnsgcG9zaXRpb246c3RpY2t5OyB0b3A6MDsgYmFja2dyb3VuZDp0cmFuc3BhcmVudDsgYm94LXNoYWRvdzpub25lOyBib3JkZXI6bm9uZTsgcGFkZGluZzoxNHB4OyB9CiAgICAubW9kYWwgLmNvbnRlbnR7IHBhZGRpbmc6MTRweDsgfQogICAgLm1vZGFsIGZvb3RlcnsgZGlzcGxheTpmbGV4OyBnYXA6OHB4OyBqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmQ7IHBhZGRpbmc6MTRweDsgfQogICAgLnNtYWxseyBmb250LXNpemU6MTJweDsgY29sb3I6dmFyKC0tbXV0ZWQpOyB9CiAgICAubm90ZXsgZm9udC1zaXplOjEzcHg7IGNvbG9yOiNlNWU3ZWI7IG9wYWNpdHk6Ljk7IH0KICAgIC5kYW5nZXItdGV4dHsgY29sb3I6IHZhcigtLWRhbmdlcik7IH0KICAgIC5vay10ZXh0eyBjb2xvcjogdmFyKC0tb2spOyB9CiAgICAKLndhcm4tdGV4dHsgY29sb3I6IHZhcigtLXdhcm4sICNmZmIwMjApOyB9Ci53YXJuLXN0cm9uZy10ZXh0eyBjb2xvcjojZmY2YTAwOyBmb250LXdlaWdodDo2MDA7IH0KLyogUGVyY2VudGFnZSBiYWRnZSBoZWxwZXIgKi8KLnBjdC1iYWRnZXsgZm9udC13ZWlnaHQ6NzAwOyBwYWRkaW5nOjJweCA2cHg7IGJvcmRlci1yYWRpdXM6OHB4OyBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LC4wNCk7IGRpc3BsYXk6aW5saW5lLWJsb2NrOyBtaW4td2lkdGg6NjJweDsgdGV4dC1hbGlnbjpyaWdodDsgfQoucGN0LXBvc3sgY29sb3I6IHZhcigtLW9rKTsgfQoucGN0LW5lZ3sgY29sb3I6IHZhcigtLWRhbmdlcik7IH0KLmNlbnRlcnsgdGV4dC1hbGlnbjpjZW50ZXI7IH0KICAgIC5saW5reyBjb2xvcjogdmFyKC0tYWNjZW50KTsgY3Vyc29yOnBvaW50ZXI7IHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOyB9CiAgCiAgICAubmVhci10YXJnZXR7IGFuaW1hdGlvbjogcHVsc2UgMS4ycyBpbmZpbml0ZTsgfQogICAgLmhpdC10YXJnZXR7IGFuaW1hdGlvbjogcHVsc2Utc3Ryb25nIDAuOHMgaW5maW5pdGU7IH0KICAgIEBrZXlmcmFtZXMgcHVsc2V7CiAgICAgIDAleyBib3gtc2hhZG93OiAwIDAgMCAwIHJnYmEoMTYsMTg1LDEyOSwuMzUpOyB9CiAgICAgIDUwJXsgYm94LXNoYWRvdzogMCAwIDAgNnB4IHJnYmEoMTYsMTg1LDEyOSwuMDUpOyBiYWNrZ3JvdW5kOiByZ2JhKDE2LDE4NSwxMjksLjA2KTsgfQogICAgICAxMDAleyBib3gtc2hhZG93OiAwIDAgMCAwIHJnYmEoMTYsMTg1LDEyOSwuMCk7IH0KICAgIH0KICAgIEBrZXlmcmFtZXMgcHVsc2Utc3Ryb25newogICAgICAwJXsgYm94LXNoYWRvdzogMCAwIDAgMCByZ2JhKDM0LDE5Nyw5NCwuNik7IH0KICAgICAgNTAleyBib3gtc2hhZG93OiAwIDAgMCAxMHB4IHJnYmEoMzQsMTk3LDk0LC4xMik7IGJhY2tncm91bmQ6IHJnYmEoMzQsMTk3LDk0LC4xMik7IH0KICAgICAgMTAwJXsgYm94LXNoYWRvdzogMCAwIDAgMCByZ2JhKDM0LDE5Nyw5NCwuMCk7IH0KICAgIH0KCiAgCiAgLyogPT09IENvbGxhcHNpYmxlIEhpc3RvcnkgPT09ICovCiAgI2hpc3RvcnlQYW5lbCAjdHhUYWJsZVdyYXAgeyB0cmFuc2l0aW9uOiBtYXgtaGVpZ2h0IDAuMjVzIGVhc2U7IH0KICAjaGlzdG9yeVBhbmVsLmNvbGxhcHNlZCAjdHhUYWJsZVdyYXAgeyBtYXgtaGVpZ2h0OiAwOyBvdmVyZmxvdzogaGlkZGVuOyBwYWRkaW5nOiAwOyBtYXJnaW46IDA7IGJvcmRlcjogMDsgfQogICNoaXN0b3J5UGFuZWwuY29sbGFwc2VkICNmaWx0ZXJRdWVyeSwgCiAgI2hpc3RvcnlQYW5lbC5jb2xsYXBzZWQgbGFiZWxbZm9yPSJmaWx0ZXJRdWVyeSJdIHsgZGlzcGxheTogbm9uZTsgfQogICNoaXN0b3J5UGFuZWwgLmNsaWNrYWJsZSB7IGN1cnNvcjogcG9pbnRlcjsgfQogICNoaXN0b3J5UGFuZWwgLmNoZXYgeyBkaXNwbGF5OmlubGluZS1ibG9jazsgdHJhbnNpdGlvbjogdHJhbnNmb3JtIC4ycyBlYXNlOyB9CiAgI2hpc3RvcnlQYW5lbC5jb2xsYXBzZWQgLmNoZXYgeyB0cmFuc2Zvcm06IHJvdGF0ZSgtOTBkZWcpOyB9CgoKLyogPT09IENvbG9yZWQgYmxpbmtpbmcgZm9yIEJVWSAoZ3JlZW4pIGFuZCBTRUxMIChyZWQpID09PSAqLwpAa2V5ZnJhbWVzIGJsaW5rUmVkIHsgMCV7b3V0bGluZS1jb2xvcjogdHJhbnNwYXJlbnQ7fSA1MCV7b3V0bGluZS1jb2xvcjogcmdiYSgyMjAsMzgsMzgsMC45KTt9IDEwMCV7b3V0bGluZS1jb2xvcjogdHJhbnNwYXJlbnQ7fSB9CkBrZXlmcmFtZXMgYmxpbmtHcmVlbiB7IDAle291dGxpbmUtY29sb3I6IHRyYW5zcGFyZW50O30gNTAle291dGxpbmUtY29sb3I6IHJnYmEoMTYsMTg1LDEyOSwwLjkpO30gMTAwJXtvdXRsaW5lLWNvbG9yOiB0cmFuc3BhcmVudDt9IH0KCi5oaXQtdGFyZ2V0LXNlbGwgICB7IG91dGxpbmU6IDNweCBzb2xpZDsgYW5pbWF0aW9uOiBibGlua1JlZCAxcyBpbmZpbml0ZTsgICAgfQoubmVhci10YXJnZXQtc2VsbCAgeyBvdXRsaW5lOiAycHggZGFzaGVkOyBhbmltYXRpb246IGJsaW5rUmVkIDEuNnMgaW5maW5pdGU7IH0KLmhpdC10YXJnZXQtYnV5ICAgIHsgb3V0bGluZTogM3B4IHNvbGlkOyBhbmltYXRpb246IGJsaW5rR3JlZW4gMXMgaW5maW5pdGU7ICB9Ci5uZWFyLXRhcmdldC1idXkgICB7IG91dGxpbmU6IDJweCBkYXNoZWQ7IGFuaW1hdGlvbjogYmxpbmtHcmVlbiAxLjZzIGluZmluaXRlOyB9CgovKiBjb21wYXRpYmlsaXR5IChvbGQgZ2VuZXJpYyBjbGFzc2VzKSAqLwouaGl0LXRhcmdldCB7IG91dGxpbmU6IDNweCBzb2xpZDsgYW5pbWF0aW9uOiBibGlua1JlZCAxLjJzIGluZmluaXRlOyB9Ci5uZWFyLXRhcmdldHsgb3V0bGluZTogMnB4IGRhc2hlZDsgYW5pbWF0aW9uOiBibGlua1JlZCAycyBpbmZpbml0ZTsgfQoKLyogPT09IE1vYmlsZSB0d2Vha3MgPT09ICovCkBtZWRpYSAobWF4LXdpZHRoOiA5ODBweCl7CiAgLmxheW91dHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnI7IHBhZGRpbmc6MTBweDsgZ2FwOjEwcHg7IH0KICAuc2lkZWJhcnsgbWluLWhlaWdodDogYXV0bzsgfQogIG1haW57IHBhZGRpbmc6MTBweDsgZ2FwOjEwcHg7IH0KICBoZWFkZXJ7IHBhZGRpbmc6MTBweDsgfQogIGhlYWRlciAuYWN0aW9uc3sgZ2FwOjZweDsgfQogIGhlYWRlciAuYWN0aW9ucyA+ICp7IGZsZXg6IDEgMSA0OCU7IH0gLyogMiBwZXIgcm93ICovCiAgLnBhbmVseyBwYWRkaW5nOjEwcHg7IH0KICAuZ3JpZHsgZ2FwOjEwcHg7IH0KICB0aCwgdGR7IHBhZGRpbmc6OHB4OyB9CiAgLmJ0bnsgcGFkZGluZzoxMHB4IDEycHg7IGZvbnQtc2l6ZToxNHB4OyB9Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCl7CiAgaGVhZGVyIGgxeyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjsgZ2FwOjhweDsgfQogIGhlYWRlciBoMSAuYnRueyBhbGlnbi1zZWxmOmZsZXgtc3RhcnQ7IH0KICBoZWFkZXIgLmFjdGlvbnMgPiAqeyBmbGV4OiAxIDEgMTAwJTsgfSAvKiBmdWxsIHdpZHRoICovCiAgLnRhYmxlLXdyYXB7IG92ZXJmbG93LXg6YXV0bzsgLXdlYmtpdC1vdmVyZmxvdy1zY3JvbGxpbmc6IHRvdWNoOyB9CiAgdGFibGV7IG1pbi13aWR0aDogNjQwcHg7IH0gLyogZW5hYmxlIGhvcml6b250YWwgc2Nyb2xsIGZvciB3aWRlIHRhYmxlcyAqLwogIC50aWNrZXJ7IGZvbnQtc2l6ZToxM3B4OyB9CiAgdGgsIHRkeyBmb250LXNpemU6MTNweDsgfQp9Ci8qID09PSBEYWlseSBjaGFuZ2UgYXJyb3dzID09PSAqLwouY2hhbmdlLWFycm93eyBmb250LXdlaWdodDogNzAwOyBtYXJnaW4tcmlnaHQ6IDRweDsgfQouY2hhbmdlLWFycm93LnVweyBjb2xvcjogdmFyKC0tb2spOyB9Ci5jaGFuZ2UtYXJyb3cuZG93bnsgY29sb3I6IHZhcigtLWRhbmdlcik7IH0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KCjwhLS0gRmlyZWJhc2UgU0RLcyAoY29tcGF0KSAtLT4KICAKPHNjcmlwdD4KLyogPT09IEVhcmx5IFRYIGhlbHBlcnMgc2hpbSAoZW5zdXJlQnV5TG90SWRJblR4IC8gYXBwbHlDYXNoKSBbR09dID09PSAqLwooZnVuY3Rpb24oKXsKICB0cnl7CiAgICBpZiAodHlwZW9mIHdpbmRvdy5lbnN1cmVCdXlMb3RJZEluVHggIT09ICdmdW5jdGlvbicpIHsKICAgICAgd2luZG93LmVuc3VyZUJ1eUxvdElkSW5UeCA9IGZ1bmN0aW9uKHR4KXsKICAgICAgICB0cnl7CiAgICAgICAgICBpZih0eCAmJiB0eC50eXBlPT09J2J1eScgJiYgIXR4LmxvdElkKXsKICAgICAgICAgICAgdHgubG90SWQgPSB0eC5pZCB8fCAoJ2xvdF8nK0RhdGUubm93KCkudG9TdHJpbmcoMzYpKydfJytNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSk7CiAgICAgICAgICB9CiAgICAgICAgfWNhdGNoKF8pe30KICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2Ygd2luZG93Ll9fZ29fYXBwbHlDYXNoU2hpbSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB3aW5kb3cuX19nb19hcHBseUNhc2hTaGltID0gZnVuY3Rpb24oc3RhdGUsIHR5cGUsIGFtb3VudCl7CiAgICAgICAgY29uc3QgYSA9IE51bWJlcihhbW91bnQpfHwwOwogICAgICAgIGlmKCFzdGF0ZSB8fCAhdHlwZSkgcmV0dXJuOwogICAgICAgIGlmKHR5cGU9PT0nZGVwb3NpdCcgfHwgdHlwZT09PSd0cmFuc2Zlcl9pbicpeyBzdGF0ZS5jYXNoID0gKE51bWJlcihzdGF0ZS5jYXNoKXx8MCkgKyBhOyByZXR1cm47IH0KICAgICAgICBpZih0eXBlPT09J3dpdGhkcmF3JyB8fCB0eXBlPT09J3RyYW5zZmVyX291dCcpeyBzdGF0ZS5jYXNoID0gKE51bWJlcihzdGF0ZS5jYXNoKXx8MCkgLSBhOyByZXR1cm47IH0KICAgICAgICAvLyBlbHNlIGlnbm9yZQogICAgICB9OwogICAgfQogIH1jYXRjaChfKXt9Cn0pKCk7Ci8qID09PSBlbmQgZWFybHkgVFggc2hpbXMgPT09ICovCgo8L3NjcmlwdD4KPHNjcmlwdD4KLyogPT09IExpZ2h0d2VpZ2h0IGFwcGx5KiBmYWxsYmFja3MgZm9yIEdPIGNoYXJ0ICh1c2VkIG9ubHkgaWYgYXBwIHZlcnNpb25zIG5vdCB5ZXQgbG9hZGVkKSA9PT0gKi8KKGZ1bmN0aW9uKCl7CiAgZnVuY3Rpb24gX19nb19ib29rKHN0YXRlLCB0a3IpewogICAgc3RhdGUuaG9sZGluZ3MgPSBzdGF0ZS5ob2xkaW5ncyB8fCB7fTsKICAgIGlmKCFzdGF0ZS5ob2xkaW5nc1t0a3JdKSBzdGF0ZS5ob2xkaW5nc1t0a3JdID0geyBxdHk6IDAsIGxvdHM6IFtdIH07CiAgICBjb25zdCBiID0gc3RhdGUuaG9sZGluZ3NbdGtyXTsKICAgIGIubG90cyA9IEFycmF5LmlzQXJyYXkoYi5sb3RzKSA/IGIubG90cyA6IFtdOwogICAgYi5xdHkgPSBOdW1iZXIoYi5xdHkpfHwwOwogICAgcmV0dXJuIGI7CiAgfQogIGZ1bmN0aW9uIF9fZ29fY29uc3VtZUxvdHMoYm9vaywgcXR5LCBsaW5rcyl7CiAgICBsZXQgbGVmdCA9IE51bWJlcihxdHkpfHwwOwogICAgaWYoIWJvb2sgfHwgIUFycmF5LmlzQXJyYXkoYm9vay5sb3RzKSkgcmV0dXJuIDA7CiAgICAvLyBJZiBleHBsaWNpdCBsb3RMaW5rcyBwcm92aWRlZCwgY29uc3VtZSB0aG9zZSBmaXJzdAogICAgaWYoQXJyYXkuaXNBcnJheShsaW5rcykgJiYgbGlua3MubGVuZ3RoKXsKICAgICAgZm9yKGNvbnN0IGxuIG9mIGxpbmtzKXsKICAgICAgICBpZihsZWZ0PD0wKSBicmVhazsKICAgICAgICBjb25zdCBpZCA9IGxuLmxvdElkOyBsZXQgcnEgPSBOdW1iZXIobG4ucXR5KXx8MDsKICAgICAgICBmb3IoY29uc3QgbG90IG9mIGJvb2subG90cyl7CiAgICAgICAgICBpZihsZWZ0PD0wKSBicmVhazsKICAgICAgICAgIGlmKGlkICYmIGxvdC5sb3RJZD09PWlkKXsKICAgICAgICAgICAgY29uc3QgdGFrZSA9IE1hdGgubWluKGxvdC5xdHl8fDAsIHJxLCBsZWZ0KTsKICAgICAgICAgICAgbG90LnF0eSA9IChsb3QucXR5fHwwKSAtIHRha2U7CiAgICAgICAgICAgIGJvb2sucXR5ID0gKGJvb2sucXR5fHwwKSAtIHRha2U7CiAgICAgICAgICAgIGxlZnQgLT0gdGFrZTsgcnEgLT0gdGFrZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIEZJRk8gZm9yIHRoZSByZXN0CiAgICBmb3IoY29uc3QgbG90IG9mIGJvb2subG90cyl7CiAgICAgIGlmKGxlZnQ8PTApIGJyZWFrOwogICAgICBjb25zdCB0YWtlID0gTWF0aC5taW4obG90LnF0eXx8MCwgbGVmdCk7CiAgICAgIGxvdC5xdHkgPSAobG90LnF0eXx8MCkgLSB0YWtlOwogICAgICBib29rLnF0eSA9IChib29rLnF0eXx8MCkgLSB0YWtlOwogICAgICBsZWZ0IC09IHRha2U7CiAgICB9CiAgICAvLyBjbGVhbnVwIGVtcHR5IGxvdHMKICAgIGJvb2subG90cyA9IGJvb2subG90cy5maWx0ZXIobCA9PiAobC5xdHl8fDApID4gMCk7CiAgICByZXR1cm4gbGVmdDsgLy8gcmVtYWluaW5nIChpZiA+MCwgbm90IGVub3VnaCBxdHkpCiAgfQogIGlmKHR5cGVvZiB3aW5kb3cuX19nb19hcHBseUJ1eSAhPT0gJ2Z1bmN0aW9uJyl7CiAgICB3aW5kb3cuX19nb19hcHBseUJ1eSA9IGZ1bmN0aW9uKHN0YXRlLCBwZiwgdHgpewogICAgICBjb25zdCB0a3IgPSBTdHJpbmcodHgudGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGNvbnN0IHEgPSBOdW1iZXIodHgucXR5KXx8MCwgcCA9IE51bWJlcih0eC5wcmljZSl8fDAsIGYgPSBOdW1iZXIodHguZmVlcyl8fDA7CiAgICAgIHN0YXRlLmNhc2ggPSAoTnVtYmVyKHN0YXRlLmNhc2gpfHwwKSAtIChxKnAgKyBmKTsKICAgICAgdHJ5eyBpZih0eXBlb2YgZW5zdXJlQnV5TG90SWRJblR4PT09J2Z1bmN0aW9uJykgZW5zdXJlQnV5TG90SWRJblR4KHR4KTsgfWNhdGNoKF8pe30KICAgICAgY29uc3QgYm9vayA9IF9fZ29fYm9vayhzdGF0ZSwgdGtyKTsKICAgICAgY29uc3QgbG90ID0geyBsb3RJZDogdHgubG90SWQgfHwgKCdsb3RfJytNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSksIHF0eTogcSwgcHJpY2U6IHAgfTsKICAgICAgYm9vay5sb3RzLnB1c2gobG90KTsKICAgICAgYm9vay5xdHkgPSAoYm9vay5xdHl8fDApICsgcTsKICAgIH07CiAgfQogIGlmKHR5cGVvZiB3aW5kb3cuX19nb19hcHBseVNlbGwgIT09ICdmdW5jdGlvbicpewogICAgd2luZG93Ll9fZ29fYXBwbHlTZWxsID0gZnVuY3Rpb24oc3RhdGUsIHBmLCB0eCl7CiAgICAgIGNvbnN0IHRrciA9IFN0cmluZyh0eC50aWNrZXJ8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwLCBwID0gTnVtYmVyKHR4LnByaWNlfHx0eC5zZWxsUHJpY2V8fDApLCBmID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogICAgICBzdGF0ZS5jYXNoID0gKE51bWJlcihzdGF0ZS5jYXNoKXx8MCkgKyAocSpwIC0gZik7CiAgICAgIGNvbnN0IGJvb2sgPSBfX2dvX2Jvb2soc3RhdGUsIHRrcik7CiAgICAgIF9fZ29fY29uc3VtZUxvdHMoYm9vaywgcSwgQXJyYXkuaXNBcnJheSh0eC5sb3RMaW5rcyk/dHgubG90TGlua3M6W10pOwogICAgfTsKICB9CiAgaWYodHlwZW9mIHdpbmRvdy5fX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55SW4gIT09ICdmdW5jdGlvbicpewogICAgd2luZG93Ll9fZ29fYXBwbHlUcmFuc2ZlckNvbXBhbnlJbiA9IGZ1bmN0aW9uKHN0YXRlLCBwZiwgdHgpewogICAgICBjb25zdCB0a3IgPSBTdHJpbmcodHgudGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGNvbnN0IHEgPSBOdW1iZXIodHgucXR5KXx8MCwgcCA9IE51bWJlcih0eC5wcmljZSl8fDA7CiAgICAgIGNvbnN0IGJvb2sgPSBfX2dvX2Jvb2soc3RhdGUsIHRrcik7CiAgICAgIGJvb2subG90cy5wdXNoKHsgbG90SWQ6IHR4LmxvdElkIHx8ICgnbG90XycrTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMikpLCBxdHk6IHEsIHByaWNlOiBwIH0pOwogICAgICBib29rLnF0eSA9IChib29rLnF0eXx8MCkgKyBxOwogICAgfTsKICB9CiAgaWYodHlwZW9mIHdpbmRvdy5fX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55T3V0ICE9PSAnZnVuY3Rpb24nKXsKICAgIHdpbmRvdy5fX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55T3V0ID0gZnVuY3Rpb24oc3RhdGUsIHBmLCB0eCl7CiAgICAgIGNvbnN0IHRrciA9IFN0cmluZyh0eC50aWNrZXJ8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgICBjb25zdCBib29rID0gX19nb19ib29rKHN0YXRlLCB0a3IpOwogICAgICBfX2dvX2NvbnN1bWVMb3RzKGJvb2ssIHEsIEFycmF5LmlzQXJyYXkodHgubG90TGlua3MpP3R4LmxvdExpbmtzOltdKTsKICAgIH07CiAgfQp9KSgpOwovKiA9PT0gZW5kIGxpZ2h0d2VpZ2h0IGFwcGx5KiBmYWxsYmFja3MgPT09ICovCjwvc2NyaXB0Pgo8c2NyaXB0PgovKiA9PT0gRWFybHkgY3VycmVuY3kgZm9ybWF0dGVyIHNoaW0gKGJlZm9yZSBhcHAgYm9vdCkgW0dPXSA9PT0gKi8KKGZ1bmN0aW9uKCl7CiAgdHJ5ewogICAgaWYgKHR5cGVvZiB3aW5kb3cuX19nb19mbXRDdXJyZW5jeSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB3aW5kb3cuX19nb19mbXRDdXJyZW5jeSA9IGZ1bmN0aW9uKHYsIGNvZGUpewogICAgICAgIHRyeSB7IGlmICh0eXBlb2YgZm10Q3VycmVuY3kgPT09ICdmdW5jdGlvbicpIHJldHVybiBmbXRDdXJyZW5jeSh2LCBjb2RlKTsgfSBjYXRjaChfKSB7fQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgSW50bC5OdW1iZXJGb3JtYXQodW5kZWZpbmVkLCB7IHN0eWxlOidjdXJyZW5jeScsIGN1cnJlbmN5Oihjb2RlfHwnUExOJykgfSkuZm9ybWF0KHZ8fDApOyB9CiAgICAgICAgY2F0Y2goXykgeyByZXR1cm4gU3RyaW5nKE1hdGgucm91bmQoKHZ8fDApKjEwMCkvMTAwKSArICcgJyArIChjb2RlfHwnJyk7IH0KICAgICAgfTsKICAgIH0KICB9Y2F0Y2goXyl7fQp9KSgpOwovKiA9PT0gZW5kIHNoaW0gPT09ICovCjwvc2NyaXB0PgoKICAKICAKCgo8c2NyaXB0PgovLyBHbG9iYWwgc2hpbXMgdG8gYXZvaWQgUmVmZXJlbmNlRXJyb3Igd2hlbiBfX2ZtdE51bSAvIF9fZXNjIGFyZSB1c2VkIGJlZm9yZSBtb2R1bGUgbG9hZHMKd2luZG93Ll9fZXNjID0gd2luZG93Ll9fZXNjIHx8IGZ1bmN0aW9uKHMpewogIHRyeXsgaWYodHlwZW9mIHdpbmRvdy5lc2NhcGVIdG1sPT09J2Z1bmN0aW9uJykgcmV0dXJuIHdpbmRvdy5lc2NhcGVIdG1sKFN0cmluZyhzfHwnJykpOyB9Y2F0Y2goXyl7fQogIGNvbnN0IHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOyB0LnRleHRDb250ZW50ID0gU3RyaW5nKHN8fCcnKTsgcmV0dXJuIHQuaW5uZXJIVE1MOwp9Owp3aW5kb3cuX19mbXROdW0gPSB3aW5kb3cuX19mbXROdW0gfHwgZnVuY3Rpb24odil7CiAgdHJ5eyBpZih0eXBlb2Ygd2luZG93LmZtdE51bT09PSdmdW5jdGlvbicpIHJldHVybiB3aW5kb3cuZm10TnVtKHYpOyB9Y2F0Y2goXyl7fQogIGNvbnN0IG4gPSBOdW1iZXIodik7IGlmKCFpc0Zpbml0ZShuKSkgcmV0dXJuICfigJQnOwogIHJldHVybiBuLnRvTG9jYWxlU3RyaW5nKHVuZGVmaW5lZCwge21heGltdW1GcmFjdGlvbkRpZ2l0czogMn0pOwp9Owo8L3NjcmlwdD4KPHNjcmlwdD4KLy8gPT09IEdsb2JhbCBkYXRlIGhlbHBlcnMgc2hpbSAoYWRkZWQgYnkgZml4KSA9PT0Kd2luZG93LnRvTXMgPSB3aW5kb3cudG9NcyB8fCBmdW5jdGlvbihkKXsKICB0cnl7CiAgICBpZiAoZCA9PSBudWxsKSByZXR1cm4gTmFOOwogICAgaWYgKHR5cGVvZiBkID09PSAnbnVtYmVyJykgcmV0dXJuIGQ7CiAgICBpZiAoZCBpbnN0YW5jZW9mIERhdGUpIHJldHVybiBkLmdldFRpbWUoKTsKICAgIGlmIChkICYmIHR5cGVvZiBkLnRvRGF0ZSA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIGQudG9EYXRlKCkuZ2V0VGltZSgpOwogICAgaWYgKGQgJiYgdHlwZW9mIGQuc2Vjb25kcyAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBOdW1iZXIoZC5zZWNvbmRzKSAqIDEwMDA7CiAgICBjb25zdCBtcyA9IERhdGUucGFyc2UoU3RyaW5nKGQpKTsKICAgIHJldHVybiBOdW1iZXIuaXNGaW5pdGUobXMpID8gbXMgOiBOYU47CiAgfWNhdGNoKF8peyByZXR1cm4gTmFOOyB9Cn07Cgp3aW5kb3cuaW5SYW5nZU1zID0gd2luZG93LmluUmFuZ2VNcyB8fCBmdW5jdGlvbihtcywgcmFuZ2UpewogIGlmICghcmFuZ2UpIHJldHVybiB0cnVlOwogIGlmICghTnVtYmVyLmlzRmluaXRlKG1zKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHMgPSBOdW1iZXIoKChyYW5nZSAmJiByYW5nZS5zdGFydCkgPz8gLUluZmluaXR5KSk7CiAgY29uc3QgZSA9IE51bWJlcigoKHJhbmdlICYmIHJhbmdlLmVuZCkgPz8gSW5maW5pdHkpKTsKICByZXR1cm4gbXMgPj0gcyAmJiBtcyA8PSBlOwp9Owo8L3NjcmlwdD4KCgo8c3R5bGU+CiN0b2FzdHNXcmFwe3Bvc2l0aW9uOmZpeGVkO3JpZ2h0OjEwcHg7Ym90dG9tOjEwcHg7ei1pbmRleDo5OTk5O2Rpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW47Z2FwOjhweDttYXgtd2lkdGg6OTJ2d30KLnRvYXN0e3BhZGRpbmc6MTBweCAxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtib3gtc2hhZG93OjAgNHB4IDE0cHggcmdiYSgwLDAsMCwuMik7YmFja2dyb3VuZDp2YXIoLS10YWJsZS1iZywgI2Y4ZjlmYSk7Y29sb3I6dmFyKC0tdGV4dC1jb2xvciwjMTExKTtmb250LXNpemU6LjlyZW07b3BhY2l0eTouOTg7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtnYXA6OHB4fQoudG9hc3QuaGl0e2JvcmRlci1sZWZ0OjRweCBzb2xpZCAjMTZhMzRhfQoudG9hc3QubmVhcntib3JkZXItbGVmdDo0cHggc29saWQgI2Q5NzcwNn0KLnRvYXN0IC50aW1le29wYWNpdHk6LjY7Zm9udC1zaXplOi44cmVtO21hcmdpbi1sZWZ0OmF1dG99CiNhbGVydHNUYWJCdG4gLmJhZGdle21hcmdpbi1sZWZ0OjZweDtwYWRkaW5nOjAgNnB4O2JvcmRlci1yYWRpdXM6MTBweDtiYWNrZ3JvdW5kOiNlZjQ0NDQ7Y29sb3I6I2ZmZjtmb250LXNpemU6Ljc1cmVtO2Rpc3BsYXk6aW5saW5lLWJsb2NrfQoKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgoKPHN0eWxlPgovKiBEaXNhYmxlIGJsaW5raW5nIGluc2lkZSBBbGVydHMgcGFuZWwgKi8KI2FsZXJ0c1BhbmVsIC5oaXQtdGFyZ2V0LXNlbGwsIAojYWxlcnRzUGFuZWwgLmhpdC10YXJnZXQtYnV5LCAKI2FsZXJ0c1BhbmVsIC5uZWFyLXRhcmdldC1zZWxsLCAKI2FsZXJ0c1BhbmVsIC5uZWFyLXRhcmdldC1idXkgeyBhbmltYXRpb246IG5vbmUgIWltcG9ydGFudDsgfQovKiBVc2Ugbm9uLWJsaW5raW5nIHN0eWxlcyBmb3Igcm93cyAqLwojYWxlcnRzUGFuZWwgdHIuc3RhdGUtaGl0ICB7IGJvcmRlci1sZWZ0OiA0cHggc29saWQgcmdiYSgzNCwxOTcsOTQsLjkpOyB9ICAgLyogZ3JlZW4gKi8KI2FsZXJ0c1BhbmVsIHRyLnN0YXRlLW5lYXIgeyBib3JkZXItbGVmdDogNHB4IHNvbGlkIHJnYmEoMjQ1LDE1OCwxMSwuOSk7IH0gIC8qIGFtYmVyICovCiNhbGVydHNQYW5lbCB0ci5zdGF0ZS1oaXQsICNhbGVydHNQYW5lbCB0ci5zdGF0ZS1uZWFyIHsgYmFja2dyb3VuZDogaW5oZXJpdDsgfQoKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgo8c3R5bGU+Ci8qID09PSBHbG9iYWwgRGFyayBUaGVtZSBmb3IgQUxMIG1vZGFscy9wb3B1cHMgPT09ICovCjpyb290ewogIC0tX19tb2RhbC1iZzogdmFyKC0tc3VyZmFjZSwgIzBmMTcyYSk7CiAgLS1fX21vZGFsLWJnMjogdmFyKC0tc3VyZmFjZS0yLCAjMGIxMjIwKTsKICAtLV9fbW9kYWwtdGV4dDogdmFyKC0tdGV4dCwgI2U1ZTdlYik7CiAgLS1fX21vZGFsLW11dGVkOiB2YXIoLS1tdXRlZCwgIzk0YTNiOCk7CiAgLS1fX21vZGFsLWJvcmRlcjogdmFyKC0tYm9yZGVyLWNvbG9yLCAjMzM0MTU1KTsKICAtLV9fbW9kYWwtcmluZzogdmFyKC0tYWNjZW50LCAjNjBhNWZhKTsKICAtLV9fYmFja2Ryb3A6IHJnYmEoMiw2LDIzLDAuNjYpOwp9CgovKiBOYXRpdmUgPGRpYWxvZz4gKi8KZGlhbG9nLCBbcm9sZT0iZGlhbG9nIl0sIC5tb2RhbCwgLnBvcHVwLCAuZGlhbG9nLCAuYXBwLW1vZGFsLCAuYXBwLXBvcHVwIHsKICBiYWNrZ3JvdW5kOgogICAgbGluZWFyLWdyYWRpZW50KDE4MGRlZywgY29sb3ItbWl4KGluIG9rbGFiLCB2YXIoLS1fX21vZGFsLWJnKSA5OCUsIHRyYW5zcGFyZW50KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3ItbWl4KGluIG9rbGFiLCB2YXIoLS1fX21vZGFsLWJnMikgOTglLCB0cmFuc3BhcmVudCkpOwogIGNvbG9yOiB2YXIoLS1fX21vZGFsLXRleHQpOwogIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLV9fbW9kYWwtYm9yZGVyKTsKICBib3JkZXItcmFkaXVzOiAxNnB4OwogIGJveC1zaGFkb3c6IDAgMTJweCAyOHB4IHJnYmEoMCwwLDAsLjM1KTsKfQoKLyogRW5zdXJlIGNvbW1vbiBpbm5lciB3cmFwcGVycyBpbmhlcml0ICovCmRpYWxvZyAubW9kYWwtY29udGVudCwKLm1vZGFsIC5tb2RhbC1jb250ZW50LAoucG9wdXAgLm1vZGFsLWNvbnRlbnQsCltyb2xlPSJkaWFsb2ciXSAubW9kYWwtY29udGVudCB7IGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OyBjb2xvcjogaW5oZXJpdDsgYm9yZGVyOiAwOyB9CgovKiBCYWNrZHJvcCBmb3IgbmF0aXZlIDxkaWFsb2c+ICovCmRpYWxvZzo6YmFja2Ryb3AgeyAKICBiYWNrZ3JvdW5kOiB2YXIoLS1fX2JhY2tkcm9wKTsKICAtd2Via2l0LWJhY2tkcm9wLWZpbHRlcjogYmx1cig2cHgpOwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cig2cHgpOwp9CgovKiBHZW5lcmljIG92ZXJsYXkvYmFja2Ryb3AgY2xhc3NlcyB1c2VkIGJ5IGN1c3RvbSBtb2RhbHMgKi8KLmJhY2tkcm9wLCAub3ZlcmxheSwgLm1vZGFsLWJhY2tkcm9wLCAucG9wdXAtYmFja2Ryb3AgewogIGJhY2tncm91bmQ6IHZhcigtLV9fYmFja2Ryb3ApICFpbXBvcnRhbnQ7CiAgLXdlYmtpdC1iYWNrZHJvcC1maWx0ZXI6IGJsdXIoNnB4KTsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNnB4KTsKfQoKLyogSGVhZC9mb290IGFyZWFzICovCi5tb2RhbC1oZWFkZXIsIC5wb3B1cC1oZWFkZXIgewogIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1fX21vZGFsLWJvcmRlcik7CiAgcGFkZGluZzogMTJweCAxNnB4Owp9Ci5tb2RhbC1mb290ZXIsIC5wb3B1cC1mb290ZXIgewogIGJvcmRlci10b3A6IDFweCBzb2xpZCB2YXIoLS1fX21vZGFsLWJvcmRlcik7CiAgcGFkZGluZzogMTJweCAxNnB4OwogIGRpc3BsYXk6IGZsZXg7IGdhcDogMTJweDsganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDsgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLyogQ29udHJvbHMgKi8KLm1vZGFsIGlucHV0LCAubW9kYWwgdGV4dGFyZWEsIC5tb2RhbCBzZWxlY3QsCmRpYWxvZyBpbnB1dCwgZGlhbG9nIHRleHRhcmVhLCBkaWFsb2cgc2VsZWN0LAoucG9wdXAgaW5wdXQsIC5wb3B1cCB0ZXh0YXJlYSwgLnBvcHVwIHNlbGVjdCwKW3JvbGU9ImRpYWxvZyJdIGlucHV0LCBbcm9sZT0iZGlhbG9nIl0gdGV4dGFyZWEsIFtyb2xlPSJkaWFsb2ciXSBzZWxlY3QgewogIGJhY2tncm91bmQ6IHZhcigtLXN1cmZhY2UtMiwgIzExMTgyNyk7CiAgY29sb3I6IHZhcigtLV9fbW9kYWwtdGV4dCk7CiAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tX19tb2RhbC1ib3JkZXIpOwogIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgcGFkZGluZzogMTBweCAxMnB4OwogIG91dGxpbmU6IG5vbmU7Cn0KLm1vZGFsIGlucHV0OjpwbGFjZWhvbGRlciwgLm1vZGFsIHRleHRhcmVhOjpwbGFjZWhvbGRlciwKZGlhbG9nIGlucHV0OjpwbGFjZWhvbGRlciwgZGlhbG9nIHRleHRhcmVhOjpwbGFjZWhvbGRlciwKLnBvcHVwIGlucHV0OjpwbGFjZWhvbGRlciwgLnBvcHVwIHRleHRhcmVhOjpwbGFjZWhvbGRlciwKW3JvbGU9ImRpYWxvZyJdIGlucHV0OjpwbGFjZWhvbGRlciwgW3JvbGU9ImRpYWxvZyJdIHRleHRhcmVhOjpwbGFjZWhvbGRlciB7CiAgY29sb3I6IGNvbG9yLW1peChpbiBva2xhYiwgdmFyKC0tX19tb2RhbC1tdXRlZCkgODAlLCB0cmFuc3BhcmVudCk7Cn0KLm1vZGFsIGlucHV0OmZvY3VzLCAubW9kYWwgdGV4dGFyZWE6Zm9jdXMsIC5tb2RhbCBzZWxlY3Q6Zm9jdXMsCmRpYWxvZyBpbnB1dDpmb2N1cywgZGlhbG9nIHRleHRhcmVhOmZvY3VzLCBkaWFsb2cgc2VsZWN0OmZvY3VzLAoucG9wdXAgaW5wdXQ6Zm9jdXMsIC5wb3B1cCB0ZXh0YXJlYTpmb2N1cywgLnBvcHVwIHNlbGVjdDpmb2N1cywKW3JvbGU9ImRpYWxvZyJdIGlucHV0OmZvY3VzLCBbcm9sZT0iZGlhbG9nIl0gdGV4dGFyZWE6Zm9jdXMsIFtyb2xlPSJkaWFsb2ciXSBzZWxlY3Q6Zm9jdXMgewogIGJveC1zaGFkb3c6IDAgMCAwIDNweCBjb2xvci1taXgoaW4gb2tsYWIsIHZhcigtLV9fbW9kYWwtcmluZykgMzAlLCB0cmFuc3BhcmVudCk7CiAgYm9yZGVyLWNvbG9yOiB2YXIoLS1fX21vZGFsLXJpbmcpOwp9CgovKiBDaGVja2JveC9SYWRpbyBhY2NlbnQgKi8KLm1vZGFsIGlucHV0W3R5cGU9ImNoZWNrYm94Il0sIC5tb2RhbCBpbnB1dFt0eXBlPSJyYWRpbyJdLApkaWFsb2cgaW5wdXRbdHlwZT0iY2hlY2tib3giXSwgZGlhbG9nIGlucHV0W3R5cGU9InJhZGlvIl0sCi5wb3B1cCBpbnB1dFt0eXBlPSJjaGVja2JveCJdLCAucG9wdXAgaW5wdXRbdHlwZT0icmFkaW8iXSwKW3JvbGU9ImRpYWxvZyJdIGlucHV0W3R5cGU9ImNoZWNrYm94Il0sIFtyb2xlPSJkaWFsb2ciXSBpbnB1dFt0eXBlPSJyYWRpbyJdewogIGFjY2VudC1jb2xvcjogdmFyKC0tX19tb2RhbC1yaW5nKTsKfQoKLyogQ2xvc2UgaWNvbiAqLwoubW9kYWwgLm1vZGFsLXgsIGRpYWxvZyAubW9kYWwteCwgLnBvcHVwIC5tb2RhbC14IHsKICBjb2xvcjogdmFyKC0tX19tb2RhbC1tdXRlZCk7Cn0KLm1vZGFsIC5tb2RhbC14OmhvdmVyLCBkaWFsb2cgLm1vZGFsLXg6aG92ZXIsIC5wb3B1cCAubW9kYWwteDpob3ZlciB7CiAgb3BhY2l0eTogLjk7Cn0KCi8qIEJ1dHRvbnMgKHVzZSBleGlzdGluZyAuYnRuIHN0eWxpbmcgaWYgcHJlc2VudCkgKi8KLm1vZGFsIC5idG4sIGRpYWxvZyAuYnRuLCAucG9wdXAgLmJ0biB7CiAgYm9yZGVyLXJhZGl1czogMTJweDsKICBwYWRkaW5nOiAxMHB4IDE0cHg7CiAgZm9udC13ZWlnaHQ6IDYwMDsKfQoubW9kYWwgLmJ0bi5naG9zdCwgZGlhbG9nIC5idG4uZ2hvc3QsIC5wb3B1cCAuYnRuLmdob3N0IHsKICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1fX21vZGFsLWJvcmRlcik7CiAgY29sb3I6IHZhcigtLV9fbW9kYWwtbXV0ZWQpOwp9CgovKiBTdWJ0bGUgZW50ZXIgYW5pbWF0aW9uOyByZXNwZWN0cyByZWR1Y2VkIG1vdGlvbiAqLwpAbWVkaWEgKHByZWZlcnMtcmVkdWNlZC1tb3Rpb246IG5vLXByZWZlcmVuY2UpewogIGRpYWxvZ1tvcGVuXSwgLm1vZGFsLCAucG9wdXAsIFtyb2xlPSJkaWFsb2ciXSB7CiAgICBhbmltYXRpb246IG1vZGFsRmFkZUluIC4xNnMgZWFzZS1vdXQ7CiAgfQogIEBrZXlmcmFtZXMgbW9kYWxGYWRlSW4geyBmcm9tIHsgb3BhY2l0eTogLjA7IHRyYW5zZm9ybTogc2NhbGUoLjk4KTt9IHRvIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiBzY2FsZSgxKTt9IH0KfQoKCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KPHN0eWxlPgovKiA9PT0gR08gcGVyaW9kIGNoaXAgcG9saXNoID09PSAqLwouZ28tY2hpcC1sYWJlbHtkaXNwbGF5OmlubGluZS1ibG9jazsgbWFyZ2luLXJpZ2h0OjhweDsgb3BhY2l0eTouOTsgZm9udC13ZWlnaHQ6NjAwO30KI2dvLXBlcmlvZHsKICBwYWRkaW5nOjRweCAxMHB4OwogIGJvcmRlci1yYWRpdXM6MTBweDsKICBib3JkZXI6MXB4IHNvbGlkIHZhcigtLW11dGVkLCByZ2JhKDEyOCwxMjgsMTI4LC40KSk7CiAgYmFja2dyb3VuZDogdmFyKC0tYmctMiwgcmdiYSgyNTUsMjU1LDI1NSwuMDUpKTsKICBvdXRsaW5lOm5vbmU7Cn0KI2dvLXBlcmlvZDpmb2N1c3sgYm94LXNoYWRvdzowIDAgMCAycHggcmdiYSgxMDAsMTUwLDI1NSwuMjUpOyB9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CjxzdHlsZT4KLmNvbXBhbnktbmFtZS1kaXNwbGF5IHsKICBkaXNwbGF5OiBibG9jazsKICBmb250LXNpemU6IDExcHg7CiAgY29sb3I6IHZhcigtLW11dGVkKTsKICBmb250LXdlaWdodDogNDAwOwogIG1hcmdpbi10b3A6IDJweDsKICBvcGFjaXR5OiAwLjg1Owp9CgoKCiAgCgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CjxzdHlsZSBpZD0iaG9sZGluZ3MtYWN0aW9ucy1hbGlnbiI+Ci8qIEFsaWduICcrJyBhbmQgdHJhbnNmZXIgYnV0dG9ucyBpbiBob2xkaW5ncyBzdW1tYXJ5IHRvIHRoZSBmYXIgcmlnaHQgKi8KI2hvbGRpbmdzVGFibGVXcmFwIGRldGFpbHMgPiBzdW1tYXJ5ewogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKfQovKiBwdXNoIHRoZSBmaXJzdCBzbWFsbCBidXR0b24gdG8gdGhlIHJpZ2h0OyB0aGUgcmVzdCB3aWxsIGZvbGxvdyAqLwojaG9sZGluZ3NUYWJsZVdyYXAgZGV0YWlscyA+IHN1bW1hcnkgLmJ0bi5zbWFsbDpmaXJzdC1vZi10eXBlewogIG1hcmdpbi1sZWZ0OiBhdXRvOwp9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CjxzdHlsZSBpZD0iYWxlcnRzLWhpc3RvcnktY29udHJvbHMtZml4Ij4KLyogQ29tbW9uIGNsYXNzIGZvciB0aGUgYWxlcnRzIGhpc3RvcnkgY29udHJvbHMgY29udGFpbmVyICovCi5hbGVydHMtaGlzdG9yeS1jb250cm9sc3sKICBkaXNwbGF5OiBmbGV4ICFpbXBvcnRhbnQ7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKICB3aGl0ZS1zcGFjZTogbm93cmFwOwogIGZsZXgtd3JhcDogbm93cmFwOwp9Ci8qIEVuc3VyZSBidXR0b24gdGV4dCBjb2xvciBmb2xsb3dzIHRoZW1lIChzYW1lIGZvciBib3RoKSAqLwouYWxlcnRzLWhpc3RvcnktY29udHJvbHMgYnV0dG9uLAouYWxlcnRzLWhpc3RvcnktY29udHJvbHMgLmJ0biwKLmFsZXJ0cy1oaXN0b3J5LWNvbnRyb2xzIGFbcm9sZT0iYnV0dG9uIl17CiAgY29sb3I6IHZhcigtLWZvcmVncm91bmQsIGluaGVyaXQpICFpbXBvcnRhbnQ7Cn0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KCjxzdHlsZSBpZD0iYWxlcnRzLWhpc3RvcnktaW5saW5lLWZpeDIiPgovKiBGb3JjZSAnT2TFm3dpZcW8JyBhbmQgJ1d5Y3p5xZvEhycgdG8gc2l0IGlubGluZSBhbmQgc2hhcmUgdGV4dCBjb2xvciAqLwojYWxlcnRzUGFuZWwgLmZpbHRlcnMgLmNvbC0zLAojYWxlcnRzUGFuZWwgLmZpbHRlcnMgLmNvbCwKI2FsZXJ0c1BhbmVsIC5maWx0ZXJzIC5jb250cm9scywKI2FsZXJ0c1BhbmVsIC5maWx0ZXJzewogIGRpc3BsYXk6IGZsZXggIWltcG9ydGFudDsKICBhbGlnbi1pdGVtczogY2VudGVyICFpbXBvcnRhbnQ7CiAgZ2FwOiA4cHggIWltcG9ydGFudDsKICBmbGV4LXdyYXA6IG5vd3JhcCAhaW1wb3J0YW50Owp9CiNhbGVydHNSZWZyZXNoQnRuLCAjYWxlcnRzQ2xlYXJCdG57CiAgZGlzcGxheTogaW5saW5lLWZsZXggIWltcG9ydGFudDsKICB3aWR0aDogYXV0byAhaW1wb3J0YW50OwogIG1pbi13aWR0aDogMCAhaW1wb3J0YW50OwogIGZsZXg6IDAgMCBhdXRvICFpbXBvcnRhbnQ7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcCAhaW1wb3J0YW50OwogIHZlcnRpY2FsLWFsaWduOiBtaWRkbGUgIWltcG9ydGFudDsKfQovKiB1bmlmeWluZyB0ZXh0IGNvbG9yIC0gbWF0Y2ggbm9ybWFsIC5idG4gZGFyayB0ZXh0IHVzZWQgb24gYWNjZW50IGJ1dHRvbnMgKi8KI2FsZXJ0c0NsZWFyQnRuLCAjYWxlcnRzUmVmcmVzaEJ0bnsKICBjb2xvcjogIzBiMTIyMiAhaW1wb3J0YW50Owp9Ci8qIHN1YnRsZSBzcGFjaW5nIGlmIGxheW91dCBlbmdpbmUgaWdub3JlcyBnYXAgKi8KI2FsZXJ0c1JlZnJlc2hCdG57IG1hcmdpbi1yaWdodDogOHB4ICFpbXBvcnRhbnQ7IH0KCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KPHN0eWxlIGlkPSJhbGVydHMtaW5saW5lLWNvbnRyb2xzLWNzcyI+Ci5hbGVydHMtaW5saW5lLWNvbnRyb2xzewogIGRpc3BsYXk6IGZsZXggIWltcG9ydGFudDsKICBhbGlnbi1pdGVtczogY2VudGVyICFpbXBvcnRhbnQ7CiAgZ2FwOiA4cHggIWltcG9ydGFudDsKICBmbGV4LXdyYXA6IG5vd3JhcCAhaW1wb3J0YW50Owp9Ci8qIGtlZXAgYnV0dG9ucyBjb21wYWN0ICovCi5hbGVydHMtaW5saW5lLWNvbnRyb2xzICNhbGVydHNSZWZyZXNoQnRuLAouYWxlcnRzLWlubGluZS1jb250cm9scyAjYWxlcnRzQ2xlYXJCdG57CiAgZGlzcGxheTogaW5saW5lLWZsZXggIWltcG9ydGFudDsKICBmbGV4OiAwIDAgYXV0byAhaW1wb3J0YW50OwogIHdpZHRoOiBhdXRvICFpbXBvcnRhbnQ7CiAgbWluLXdpZHRoOiAwICFpbXBvcnRhbnQ7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcCAhaW1wb3J0YW50Owp9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+Cgo8c3R5bGUgaWQ9ImdvLWltcHJvdmVkLWNoYXJ0LWNzcy12MyI+CiAgLmdvLWNoYXJ0LXdyYXAgeyBwb3NpdGlvbjpyZWxhdGl2ZTsgaGVpZ2h0OiA2NDBweDsgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjIpOyBib3JkZXItcmFkaXVzOiAxMnB4OyBib3JkZXI6IDFweCBzb2xpZCAjMWYyOTM3OyBvdmVyZmxvdzogaGlkZGVuOyB9CkBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCl7IC5nby1jaGFydC13cmFweyBoZWlnaHQ6IDQ4MHB4OyB9IH0KQG1lZGlhIChtaW4td2lkdGg6IDE0MDBweCl7IC5nby1jaGFydC13cmFweyBoZWlnaHQ6IDc0MHB4OyB9IH0KICAjZ28tbGluZS1jaGFydCB7IHdpZHRoOjEwMCU7IGhlaWdodDoxMDAlOyBkaXNwbGF5OmJsb2NrOyBjdXJzb3I6IGNyb3NzaGFpcjsgfQogIC5jaGFydC10b29sdGlwLWltcHJvdmVkIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC45NSk7CiAgICBib3JkZXI6IDJweCBzb2xpZCAjMjJkM2VlOwogICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIHBhZGRpbmc6IDE0cHggMTZweDsKICAgIGZvbnQtc2l6ZTogMTJweDsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgei1pbmRleDogMTAwMDsKICAgIG1heC13aWR0aDogMzQwcHg7CiAgICBib3gtc2hhZG93OiAwIDhweCAyNHB4IHJnYmEoMzQsMjExLDIzOCwwLjMpOwogICAgZGlzcGxheTogbm9uZTsKICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig2cHgpOwogICAgbWluLXdpZHRoOiAyODBweDsKICB9CiAgLmNoYXJ0LXRvb2x0aXAtaW1wcm92ZWQudmlzaWJsZSB7IGRpc3BsYXk6IGJsb2NrOyB9CiAgLnRvb2x0aXAtcm93LWltcHJvdmVkewogICAgZGlzcGxheTpmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgZ2FwOjEycHg7CiAgICBtYXJnaW46NnB4IDA7IHBhZGRpbmc6NHB4IDA7IGJvcmRlci1ib3R0b206MXB4IHNvbGlkIHJnYmEoMTQ4LDE2MywxODQsMC4yKTsKICB9CiAgLnRvb2x0aXAtcm93LWltcHJvdmVkOmxhc3QtY2hpbGR7IGJvcmRlci1ib3R0b206bm9uZTsgfQogIC50b29sdGlwLWxhYmVsLWltcHJvdmVkeyBjb2xvcjojOTRhM2I4OyBmb250LXdlaWdodDo1MDA7IH0KICAudG9vbHRpcC12YWx1ZS1pbXByb3ZlZHsgZm9udC13ZWlnaHQ6NzAwOyBjb2xvcjojMjJkM2VlOyBmb250LWZhbWlseTogdWktbW9ub3NwYWNlLCBTRk1vbm8tUmVndWxhciwgTWVubG8sIE1vbmFjbywgQ29uc29sYXMsICJDb3VyaWVyIE5ldyIsIG1vbm9zcGFjZTsgdGV4dC1hbGlnbjpyaWdodDsgfQo8L3N0eWxlPgoKPHN0eWxlPiNnby1saW5lLWNoYXJ0LW92ZXJsYXl7cG9zaXRpb246YWJzb2x1dGU7aW5zZXQ6MDt3aWR0aDoxMDAlO2hlaWdodDoxMDAlO3BvaW50ZXItZXZlbnRzOm5vbmU7fTwvc3R5bGU+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0veGxzeEAwLjE4LjUvZGlzdC94bHN4LmZ1bGwubWluLmpzIj48L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KPGlucHV0IHR5cGU9ImZpbGUiIGlkPSJ4dGJJbXBvcnRGaWxlIiBhY2NlcHQ9Ii54bHN4LC54bHMiIHN0eWxlPSJkaXNwbGF5Om5vbmUiIC8+CjxkaXYgaWQ9InRvYXN0c1dyYXAiPjwvZGl2PgoKPGhlYWRlcj4KICA8aDE+8J+TiiBQb3J0ZmVsZSAgPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IiBpZD0icG9ydGZvbGlvc1RhYkJ0biIgdGl0bGU9IldpZG9rIHBvcnRmZWxpIj7wn5OCIFBvcnRmZWxlPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9Indpc2hsaXN0VGFiQnRuIiB0aXRsZT0iTGlzdGEgxbx5Y3plxYQgKGNlbnkga3VwbmEpIj7irZAgTGlzdGEgxbx5Y3plxYQ8L2J1dHRvbj4gPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IiBpZD0iYWxlcnRzVGFiQnRuIiB0aXRsZT0iSGlzdG9yaWEgYWxhcm3Ds3ciPvCflJQgQWxhcm15PC9idXR0b24+PC9oMT4KPGRpdiBjbGFzcz0iYWN0aW9ucyI+PGJ1dHRvbiBjbGFzcz0iYnRuIG9rIiBpZD0iYWRkUG9ydGZvbGlvQnRuIj7inpUgTm93eSBwb3J0ZmVsPC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gc2Vjb25kYXJ5IiBpZD0idHJhbnNmZXJCdG4iPvCflIEgUHJ6ZWxldyBtacSZZHp5IHBvcnRmZWxhbWk8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImV4cG9ydEJ0biI+4qyH77iPIEVrc3BvcnR1aiBKU09OPC9idXR0b24+CiAgICA8bGFiZWwgZm9yPSJpbXBvcnRGaWxlIiBjbGFzcz0iYnRuIGdob3N0IiBzdHlsZT0iY3Vyc29yOnBvaW50ZXIiPuKshu+4jyBJbXBvcnR1aiBKU09OPC9sYWJlbD4KICAgIDxpbnB1dCB0eXBlPSJmaWxlIiBpZD0iaW1wb3J0RmlsZSIgYWNjZXB0PSIuanNvbixhcHBsaWNhdGlvbi9qc29uIiBzdHlsZT0iZGlzcGxheTpub25lIiAvPgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHdhcm4iIGlkPSJzZXR0aW5nc0J0biI+4pqZ77iPIFVzdGF3aWVuaWE8L2J1dHRvbj4KICAKICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImZpcmViYXNlVXBsb2FkQnRuIiB0aXRsZT0iV3nFm2xpaiBkbyBGaXJlYmFzZSI+4piB77iPIFd5xZtsaWo8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImZpcmViYXNlRG93bmxvYWRCdG4iIHRpdGxlPSJQb2JpZXJ6IHogRmlyZWJhc2UiPuKYge+4jyBQb2JpZXJ6PC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJmaXJlYmFzZURpYWdCdG4iIHRpdGxlPSJTcHJhd2TFuiBwb8WCxIVjemVuaWUgeiBGaXJlc3RvcmUiPvCfp6ogVGVzdDwvYnV0dG9uPgogICAgCiAgICA8L2Rpdj4KPC9oZWFkZXI+CjxkaXYgY2xhc3M9ImxheW91dCI+CiAgPGFzaWRlIGNsYXNzPSJzaWRlYmFyIGNhcmQiPgogICAgPGRpdiBjbGFzcz0iaGVhZCI+CiAgICAgIDxkaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NzAwIj5Ud29qZSBwb3J0ZmVsZTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5LYcW8ZHkgcG9ydGZlbCB0byBvc29ibmEg4oCeZmlybWHigJ0gemUgc3dvasSFIHN0cmF0ZWdpxIU8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBvayIgaWQ9ImRlcG9zaXRCdG4iIHRpdGxlPSJTenlia2kgcHJ6ZWxldyBnb3TDs3draSBkbyB3eWJyYW5lZ28gcG9ydGZlbGEiPvCfkrA8L2J1dHRvbj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0icG9ydGZvbGlvcyIgaWQ9InBvcnRmb2xpb0xpc3QiPjwvZGl2PgogIDwvYXNpZGU+CiAgPG1haW4+CjxzZWN0aW9uIGlkPSJhbGVydHNQYW5lbCIgc3R5bGU9ImRpc3BsYXk6bm9uZSI+CiAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICA8ZGl2IGNsYXNzPSJjYXJkLWhlYWRlciI+CiAgICAgIDxoMj7wn5SUIEhpc3RvcmlhIGFsYXJtw7N3PC9oMj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0iY2FyZC1ib2R5Ij4KICAgICAgPGRpdiBjbGFzcz0iZ3JpZCIgc3R5bGU9ImdhcDogOHB4OyBhbGlnbi1pdGVtczogZW5kOyI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTMiPgogICAgICAgICAgPGxhYmVsPlpha3JlczwvbGFiZWw+CiAgICAgICAgICA8c2VsZWN0IGlkPSJhbGVydHNTY29wZSI+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+V3N6eXN0a288L29wdGlvbj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0icG9ydGZvbGlvIj5Qb3J0ZmVsZTwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJ3aXNobGlzdCI+TGlzdGEgxbx5Y3plxYQ8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0zIj4KICAgICAgICAgIDxsYWJlbD5TdGFuPC9sYWJlbD4KICAgICAgICAgIDxzZWxlY3QgaWQ9ImFsZXJ0c1N0YXRlIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj5Xc3p5c3Rrbzwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJoaXQiPvCfjq8gQ2VsIG9zacSFZ25pxJl0eTwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJuZWFyIj7ij7MgQmxpc2tvIGNlbHU8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0zIj4KICAgICAgICAgIDxsYWJlbD5Sb2R6YWo8L2xhYmVsPgogICAgICAgICAgPHNlbGVjdCBpZD0iYWxlcnRzS2luZCI+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+V3N6eXN0a288L29wdGlvbj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ic2VsbCI+U0VMTDwvb3B0aW9uPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJidXkiPkJVWTwvb3B0aW9uPgogICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTMiPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0iYWxlcnRzUmVmcmVzaEJ0biI+8J+UhCBPZMWbd2llxbw8L2J1dHRvbj4gPGJ1dHRvbiBpZD0iYWxlcnRzQ2xlYXJCdG4iIGNsYXNzPSJidG4gc21hbGwiIHRpdGxlPSJTa2FzdWogaGlzdG9yacSZIGFsYXJtw7N3Ij7wn5eRIFd5Y3p5xZvEhzwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iYWxlcnRzU3RhdHMiIGNsYXNzPSJzbWFsbCIgc3R5bGU9Im1hcmdpbjo4cHggMDsiPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj4KICAgICAgICA8dGFibGU+CiAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICA8dGg+RGF0YTwvdGg+CiAgICAgICAgICAgICAgPHRoPlRpY2tlcjwvdGg+CiAgICAgICAgICAgICAgPHRoPlN0YW48L3RoPgogICAgICAgICAgICAgIDx0aD5Sb2R6YWo8L3RoPgogICAgICAgICAgICAgIDx0aD5DZW5hPC90aD4KICAgICAgICAgICAgICA8dGg+Q2VsPC90aD4KICAgICAgICAgICAgICA8dGg+xblyw7NkxYJvPC90aD4KICAgICAgICAgICAgPC90cj4KICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHkgaWQ9ImFsZXJ0c1RhYmxlQm9keSI+CiAgICAgICAgICAgIDx0cj48dGQgY29sc3Bhbj0iNyIgY2xhc3M9Im11dGVkIj5CcmFrIGRhbnljaOKApjwvdGQ+PC90cj4KICAgICAgICAgIDwvdGJvZHk+CiAgICAgICAgPC90YWJsZT4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9zZWN0aW9uPgoKCiAgICA8c2VjdGlvbiBpZD0id2lzaGxpc3RQYW5lbCIgY2xhc3M9ImNhcmQgcGFuZWwiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMj7irZAgTGlzdGEgxbx5Y3plxYQgKGNlbGUgS1VQTkEpPC9oMj4KICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZXIiPjwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPlRpY2tlcjwvbGFiZWw+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciIHN0eWxlPSJnYXA6NnB4Ij4KICAgICAgICAgICAgPGlucHV0IGlkPSJ3bFRpY2tlciIgcGxhY2Vob2xkZXI9Im5wLiBUU0xBIC8gUEtOLldBIiAvPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJ3bFNlYXJjaCI+U3p1a2FqPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+Q2VuYSBkb2NlbG93YSAoa3Vwbm8pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBpZD0id2xQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcGxhY2Vob2xkZXI9Im5wLiAzMDAuMDAiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPiZuYnNwOzwvbGFiZWw+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2siIGlkPSJ3bEFkZCI+4p6VIERvZGFqIGRvIGxpc3R5PC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5XeW5pa2kgd3lzenVraXdhbmlhPC9sYWJlbD4KICAgICAgICAgIDxkaXYgaWQ9IndsU2VhcmNoUmVzdWx0cyIgY2xhc3M9ImNhcmQgcGFuZWwiIHN0eWxlPSJwYWRkaW5nOjhweDsgbWF4LWhlaWdodDoyMjBweDsgb3ZlcmZsb3c6YXV0byI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjEwcHgiPjwvZGl2PgogICAgICA8ZGl2IGlkPSJ3bFRhYmxlV3JhcCI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InNtYWxsIiBzdHlsZT0ibWFyZ2luLXRvcDo4cHgiPlNvcnRvd2FuaWUgd2cuIG9kbGVnxYJvxZtjaSBvZCBjZWx1OyBnZHkga3VycyDiiaQgY2VsOiB3aWVyc3ogbXJ1Z2EgbmEgemllbG9ubzsgZ2R5IGJsaXNrbyAo4omkIHRvbGVyYW5jamEgeiBVc3Rhd2llxYQpOiBkZWxpa2F0bmUgbXJ1Z2FuaWUuPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQgcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMiBpZD0icGZUaXRsZSI+V3liaWVyeiBwb3J0ZmVsPC9oMj4KICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZXIiPjwvZGl2PgogICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBzZWNvbmRhcnkiIGlkPSJyZW5hbWVCdG4iPuKcj++4jyBabWllxYQgbmF6d8SZPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRhbmdlciIgaWQ9ImRlbGV0ZUJ0biI+8J+Xke+4jyBVc3XFhCBwb3J0ZmVsPC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgICA8bGFiZWw+U3RyYXRlZ2lhIC8gTm90YXRraTwvbGFiZWw+CiAgICAgICAgICA8dGV4dGFyZWEgaWQ9InN0cmF0ZWd5Qm94IiByb3dzPSI0IiBwbGFjZWhvbGRlcj0iT3Bpc3oga3LDs3RrbyB6YXNhZHkgdGVqICdmaXJteScgKG5wLiBkeXdpZGVuZHksIG1vbWVudHVtLCBzd2luZyBpdHAuKSI+PC90ZXh0YXJlYT4KICAgICAgICAgIDxkaXYgY2xhc3M9InNtYWxsIj5aYXBpc3l3YW5lIGF1dG9tYXR5Y3puaWUuPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGRpdiBjbGFzcz0iZ3JpZCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0Ij4KICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIj5TYWxkbyBnb3TDs3draTwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjYXNoQmFsYW5jZSIgc3R5bGU9ImZvbnQtc2l6ZToyMHB4OyBmb250LXdlaWdodDo4MDAiPuKAlDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2siIGlkPSJjYXNoQWN0aW9uc0J0biI+8J+StSBPcGVyYWNqZTwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQiPgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibXV0ZWQiPlp5c2svU3RyYXRhICh6cmVhbGl6b3dhbmUpPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZToyMHB4OyBmb250LXdlaWdodDo4MDAiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJyZWFsaXplZFBMIj7igJQ8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNtYWxsIj4oPHNwYW4gaWQ9InJlYWxpemVkUExuZXQiPm5ldHRvPC9zcGFuPik8L3NwYW4+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0YWciPmxpY3pvbmUgdHlsa28gcG8gc3ByemVkYcW8eTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIG9rIiBpZD0iYnV5QnRuIj7wn5uSIFpha3VwPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gb2siIGlkPSJzZWxsQnRuIj7wn5K4IFNwcnplZGHFvCAoZG93b2xuZSBwYXJ0aWUpPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gc2Vjb25kYXJ5IiBpZD0id2l0aGRyYXdCdG4iPvCfj6cgV3lwxYJhdGE8L2J1dHRvbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImNhcmQgcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMj5TdGFuIHBvc2lhZGFuaWEgKHBhcnRpZSBpIMWbcmVkbmkga29zenQpPC9oMj4KICAgICAgICA8ZGl2IGNsYXNzPSJzcGFjZXIiPjwvZGl2PgogICAgICAgIDxzcGFuIGNsYXNzPSJzbWFsbCI+S3Vyc3kgbmEgxbx5d28geiBGaW5uaHViIChiZXoga29ud2Vyc2ppIHdhbHV0KS4gVXN0YXcgdG9rZW4gdyDimpnvuI8gVXN0YXdpZW5pYS48L3NwYW4+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJob2xkaW5nc1RhYmxlV3JhcCI+PC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gaWQ9Imhpc3RvcnlQYW5lbCIgY2xhc3M9ImNhcmQgcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgIDxoMiBpZD0iaGlzdG9yeVRpdGxlIiBjbGFzcz0iY2xpY2thYmxlIj5IaXN0b3JpYSBvcGVyYWNqaTwvaDI+CiAgICAgICAgPGRpdiBjbGFzcz0ic3BhY2VyIj48L2Rpdj4KICAgICAgICA8YnV0dG9uIGlkPSJoaXN0b3J5Q29sbGFwc2VCdG4iIGNsYXNzPSJidG4gc21hbGwgb2siIHRpdGxlPSJad2nFhC9Sb3p3acWEIj48c3BhbiBjbGFzcz0iY2hldiI+4pa+PC9zcGFuPjwvYnV0dG9uPgogICAgICAgIDxsYWJlbCBjbGFzcz0ic21hbGwiIGZvcj0iZmlsdGVyUXVlcnkiPkZpbHRyPC9sYWJlbD4KICAgICAgICA8aW5wdXQgaWQ9ImZpbHRlclF1ZXJ5IiBwbGFjZWhvbGRlcj0ibnAuIHR5cDpzZWxsIFRTTEEgMjAyNS0wOSIgc3R5bGU9Im1heC13aWR0aDozMDBweCIgLz4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gc21hbGwgZ2hvc3QiIGlkPSJmaWx0ZXJDbGVhckJ0biI+V3ljennFm8SHPC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJ0eFRhYmxlV3JhcCI+PC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPGZvb3Rlcj4KICAgICAgdjIg4oCiIERhbmUgemFwaXN5d2FuZSBsb2thbG5pZSB3IHByemVnbMSFZGFyY2UgKGxvY2FsU3RvcmFnZSkgb3JheiB3IGNobXVyemUuIFphd3N6ZSBtb8W8ZXN6IDxzcGFuIGNsYXNzPSJsaW5rIiBpZD0iZXhwb3J0TGluazIiPmVrc3BvcnRvd2HEhyBKU09OPC9zcGFuPiBpIHDDs8W6bmllaiBnbyA8c3BhbiBjbGFzcz0ibGluayIgaWQ9ImltcG9ydExpbmsyIj56YWltcG9ydG93YcSHPC9zcGFuPi4KICAgIDwvZm9vdGVyPgogIDwvbWFpbj4KPC9kaXY+Cgo8IS0tIE1vZGFsZSAtLT4KPGRpYWxvZyBpZD0ibW9kYWwiPgogIDxkaXYgY2xhc3M9Im1vZGFsIj4KICAgIDxoZWFkZXI+CiAgICAgIDxoMyBpZD0ibW9kYWxUaXRsZSI+TW9kYWw8L2gzPgogICAgPC9oZWFkZXI+CiAgICA8ZGl2IGNsYXNzPSJjb250ZW50IiBpZD0ibW9kYWxDb250ZW50Ij7igJQ8L2Rpdj4KICAgIDxmb290ZXI+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9Im1vZGFsQ2FuY2VsIj5BbnVsdWo8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBpZD0ibW9kYWxPayI+WmFwaXN6PC9idXR0b24+CiAgICA8L2Zvb3Rlcj4KICA8L2Rpdj4KPC9kaWFsb2c+Cgo8c2NyaXB0PgooKCk9PnsKICBjb25zdCBLRVkgPSAicG9ydGZlbGVfZmlybXlfdjEiOwoKCi8vID09PSBbVU5ET10gTWlnYXdraSBiYXp5IHogVFRMIDIgZG5pID09PQpjb25zdCBVTkRPX0tFWSA9IEtFWSArICdfX3VuZG8nOwpjb25zdCBVTkRPX1RUTF9NUyA9IDIqMjQqNjAqNjAqMTAwMDsgLy8gMiBkbmkKY29uc3QgVU5ET19NQVggPSA2MDsgLy8gb2dyYW5pY3plbmllIHdpZWxrb8WbY2kgaGlzdG9yaWkgKHJpbmcgYnVmZmVyKQp3aW5kb3cuX19VTkRPX1JFU1RPUklORyA9IGZhbHNlOyAvLyBndWFyZCBwcnplZCBuYXPFgnVjaGVtIEZpcmVzdG9yZSB3IHRyYWtjaWUgcHJ6eXdyYWNhbmlhCgpmdW5jdGlvbiBfX3VuZG9Mb2FkKCl7CiAgdHJ5eyByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShVTkRPX0tFWSkgfHwgJ1tdJyk7IH1jYXRjaChfKXsgcmV0dXJuIFtdOyB9Cn0KZnVuY3Rpb24gX191bmRvU2F2ZShzdGFjayl7IHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oVU5ET19LRVksIEpTT04uc3RyaW5naWZ5KHN0YWNrKSk7IH1jYXRjaChfKXt9IH0KZnVuY3Rpb24gX191bmRvUHJ1bmUoc3RhY2s9bnVsbCl7CiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICBjb25zdCBzID0gKHN0YWNrIHx8IF9fdW5kb0xvYWQoKSkuZmlsdGVyKGl0ID0+IChub3cgLSAoaXQudHN8fDApKSA8IFVORE9fVFRMX01TKTsKICBpZihzLmxlbmd0aCA+IFVORE9fTUFYKSBzLnNwbGljZSgwLCBzLmxlbmd0aCAtIFVORE9fTUFYKTsKICBfX3VuZG9TYXZlKHMpOwogIF9fdW5kb1VwZGF0ZUJ0bigpOwogIHJldHVybiBzOwp9CmZ1bmN0aW9uIF9fbWFrZVNuYXBzaG90KGtpbmQ9J3R4Jyl7CiAgcmV0dXJuIHsgdHM6IERhdGUubm93KCksIGtpbmQsIGxhYmVsOiAnJywgZGI6IEpTT04uc3RyaW5naWZ5KERCKSwgY3VycmVudFBmSWQgfTsKfQpmdW5jdGlvbiBwdXNoVW5kbyh7bGFiZWw9J1ptaWFuYScsIGtpbmQ9J3R4J30gPSB7fSl7CiAgdHJ5ewogICAgY29uc3QgcyA9IF9fdW5kb1BydW5lKCk7CiAgICBjb25zdCBzbmFwID0gX19tYWtlU25hcHNob3Qoa2luZCk7IHNuYXAubGFiZWwgPSBsYWJlbDsKICAgIHMucHVzaChzbmFwKTsKICAgIF9fdW5kb1NhdmUocyk7CiAgICBfX3VuZG9VcGRhdGVCdG4oKTsKICB9Y2F0Y2goXyl7fQp9CmZ1bmN0aW9uIGNhblVuZG8oKXsgcmV0dXJuIF9fdW5kb1BydW5lKCkubGVuZ3RoID4gMDsgfQoKZnVuY3Rpb24gX19maW5kU25hcHNob3RUb1VuZG8obW9kZT0ndHgnKXsKICAvLyBtb2RlOiAndHgnIChkb215xZtsbmllIHNrYWN6ZW15IGRvIG9zdGF0bmllaiB0cmFuc2FrY3lqbmVqKSwgJ2FueScgKGtyb2tvd28pCiAgY29uc3QgcyA9IF9fdW5kb1BydW5lKCk7CiAgaWYocy5sZW5ndGg9PT0wKSByZXR1cm4ge3N0YWNrOnMsIHRhcmdldDpudWxsLCBpZHg6LTF9OwogIGlmKG1vZGU9PT0nYW55Jyl7CiAgICByZXR1cm4ge3N0YWNrOnMsIHRhcmdldDpzW3MubGVuZ3RoLTFdLCBpZHg6cy5sZW5ndGgtMX07CiAgfQogIGZvcihsZXQgaT1zLmxlbmd0aC0xO2k+PTA7aS0tKXsKICAgIGlmKChzW2ldLmtpbmR8fCd0eCcpPT09J3R4JykgcmV0dXJuIHtzdGFjazpzLCB0YXJnZXQ6c1tpXSwgaWR4Oml9OwogIH0KICAvLyBqZcWbbGkgbmllIG1hICd0eCcsIHdlxbogb3N0YXRuacSFIGpha8SFa29sd2llawogIHJldHVybiB7c3RhY2s6cywgdGFyZ2V0OnNbcy5sZW5ndGgtMV0sIGlkeDpzLmxlbmd0aC0xfTsKfQoKZnVuY3Rpb24gdW5kbyh7bW9kZT0ndHgnfT17fSl7CiAgY29uc3QgZm91bmQgPSBfX2ZpbmRTbmFwc2hvdFRvVW5kbyhtb2RlKTsKICBjb25zdCBzID0gZm91bmQuc3RhY2s7CiAgY29uc3QgdGFyZ2V0ID0gZm91bmQudGFyZ2V0OwogIGNvbnN0IGlkeCA9IGZvdW5kLmlkeDsKICBpZighdGFyZ2V0KXsgYWxlcnQoJ0JyYWsgY29mbmnEmcSHIChoaXN0b3JpYSBwdXN0YSBsdWIgcG8gVFRMKS4nKTsgcmV0dXJuOyB9CiAgdHJ5ewogICAgd2luZG93Ll9fVU5ET19SRVNUT1JJTkcgPSB0cnVlOwogICAgREIgPSBKU09OLnBhcnNlKHRhcmdldC5kYik7CiAgICBjdXJyZW50UGZJZCA9IHRhcmdldC5jdXJyZW50UGZJZCB8fCAoREIucG9ydGZvbGlvcyAmJiBEQi5wb3J0Zm9saW9zWzBdICYmIERCLnBvcnRmb2xpb3NbMF0uaWQpIHx8IG51bGw7CiAgICBpZiAodHlwZW9mIHNhdmUgPT09ICdmdW5jdGlvbicpIHNhdmUoKTsKICAgIGlmICh0eXBlb2YgcmVuZGVyID09PSAnZnVuY3Rpb24nKSByZW5kZXIoKTsKICAgIHRyeXsgaWYodHlwZW9mIHdpbmRvdy5oYXJkVXBsb2FkPT09J2Z1bmN0aW9uJyl7IGNvbnN0IHIgPSB3aW5kb3cuaGFyZFVwbG9hZCgpOyBpZihyICYmIHR5cGVvZiByLnRoZW49PT0nZnVuY3Rpb24nKXsgci50aGVuKCgpPT57fSkuY2F0Y2goKCk9Pnt9KTsgfSB9IH1jYXRjaChfKXt9CiAgICBhbGVydCgnQ29mbmnEmXRvOiAnICsgKHRhcmdldC5sYWJlbCB8fCAnem1pYW7EmScpKTsKICB9Y2F0Y2goZSl7CiAgICBhbGVydCgnTmllIHVkYcWCbyBzacSZIGNvZm7EhcSHOiAnICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsKICB9ZmluYWxseXsKICAgIC8vIHVzdcWEIHdzenlzdGtpZSBtaWdhd2tpIG9kIGtvxYRjYSBhxbwgZG8gd3licmFuZWogKHfFgsSFY3puaWUpCiAgICBzLnNwbGljZShpZHgsIHMubGVuZ3RoIC0gaWR4KTsKICAgIF9fdW5kb1NhdmUocyk7CiAgICBfX3VuZG9VcGRhdGVCdG4oKTsKICAgIHNldFRpbWVvdXQoKCk9Pnsgd2luZG93Ll9fVU5ET19SRVNUT1JJTkcgPSBmYWxzZTsgfSwgMTUwMCk7CiAgfQp9CgpmdW5jdGlvbiBfX3VuZG9VcGRhdGVCdG4oKXsKICB0cnl7CiAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndW5kb0J0bicpOwogICAgaWYoIWJ0bikgcmV0dXJuOwogICAgY29uc3QgbiA9IChfX3VuZG9Mb2FkKCkgfHwgW10pLmZpbHRlcihpdCA9PiAoRGF0ZS5ub3coKSAtIChpdC50c3x8MCkpIDwgVU5ET19UVExfTVMpLmxlbmd0aDsKICAgIGJ0bi5kaXNhYmxlZCA9IG49PT0wOwogICAgYnRuLnRpdGxlID0gbiA/IGBDb2ZuaWogKHcgaGlzdG9yaWk6ICR7bn07IHd5Z2FzYSBwbyAyIGRuaWFjaClgIDogJ0JyYWsgcnplY3p5IGRvIGNvZm5pxJljaWEnOwogIH1jYXRjaChfKXt9Cn0KCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKT0+ewogIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1bmRvQnRuJyk7CiAgaWYoYnRuKSBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICAgIC8vIFNoaWZ0K2tsaWsgLT4gdHJ5YiAnYW55JyAoa3Jva293byksIHp3eWvFgnkga2xpayAtPiAndHgnIChza29rIGRvIG9zdGF0bmllaiB0cmFuc2FrY2ppKQogICAgdW5kbyh7bW9kZTogZSAmJiBlLnNoaWZ0S2V5ID8gJ2FueScgOiAndHgnfSk7CiAgfSk7CiAgX191bmRvVXBkYXRlQnRuKCk7Cn0pOwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57CiAgY29uc3Qga2V5ID0gU3RyaW5nKGUua2V5fHwnJykudG9Mb3dlckNhc2UoKTsKICBpZigoZS5jdHJsS2V5fHxlLm1ldGFLZXkpICYmIGtleT09PSd6Jyl7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAvLyBDdHJsL0NtZCtTaGlmdCtaIC0+ICdhbnknLCB6d3lrxYJlIEN0cmwvQ21kK1ogLT4gJ3R4JwogICAgdW5kbyh7bW9kZTogZS5zaGlmdEtleSA/ICdhbnknIDogJ3R4J30pOwogIH0KfSk7CgogIGNvbnN0ICQgPSBzZWwgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWwpOwogIGNvbnN0ICQkID0gc2VsID0+IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWwpKTsKCiAgY29uc3QgZm10Q3VycmVuY3kgPSAobiwgY3VyKSA9PiB7CiAgICBpZihuID09PSBudWxsIHx8IG4gPT09IHVuZGVmaW5lZCB8fCBpc05hTihuKSkgcmV0dXJuICLigJQiOwogICAgdHJ5ewogICAgICByZXR1cm4gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdwbC1QTCcsIHsgc3R5bGU6J2N1cnJlbmN5JywgY3VycmVuY3k6IGN1ciB8fCAnUExOJywgbWluaW11bUZyYWN0aW9uRGlnaXRzOjIsIG1heGltdW1GcmFjdGlvbkRpZ2l0czoyIH0pLmZvcm1hdChuKTsKICAgIH1jYXRjaChlKXsKICAgICAgcmV0dXJuIChuLnRvRml4ZWQoMikpICsgJyAnICsgKGN1cnx8J1BMTicpOwogICAgfQogIH07CiAgY29uc3QgZm10TnVtID0gKG4sIGQ9MikgPT4gKG4gPz8gbj09PTApID8gTnVtYmVyKG4pLnRvRml4ZWQoZCkgOiAi4oCUIjsKICBjb25zdCBpZCA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpICsgRGF0ZS5ub3coKS50b1N0cmluZygzNik7CgogIGNvbnN0IGRlZmF1bHREQiA9ICgpPT4gKHsKICAgIHZlcnNpb246IDEsCiAgICBzZXR0aW5nczogeyB0YXhSYXRlOiAwLjE5LCBhbGxvd05lZ2F0aXZlQ2FzaDogZmFsc2UsIGN1cnJlbmN5RGVmYXVsdDogIlBMTiIsIGZpbm5odWJUb2tlbjogIiIsIHByaWNlUG9sbFNlY29uZHM6IDQ1LCBhcHByb2FjaFRvbGVyYW5jZVBjdDogMSB9LAogICAgcG9ydGZvbGlvczogW10sCiAgICB3YXRjaGxpc3Q6IFtdCiAgfSk7CiAgbGV0IERCID0gbnVsbDsKICB0cnl7CiAgICBEQiA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKSkgfHwgZGVmYXVsdERCKCk7CiAgfWNhdGNoKGUpewogICAgREIgPSBkZWZhdWx0REIoKTsKICB9CiAgY29uc3Qgc2F2ZSA9ICgpPT4gbG9jYWxTdG9yYWdlLnNldEl0ZW0oS0VZLCBKU09OLnN0cmluZ2lmeShEQikpOwoKICBsZXQgY3VycmVudFBmSWQgPSBEQi5wb3J0Zm9saW9zWzBdPy5pZCB8fCBudWxsOwoKICAvLyBVSSBFbGVtZW50cwogIGNvbnN0IHBvcnRmb2xpb0xpc3RFbCA9ICQoIiNwb3J0Zm9saW9MaXN0Iik7CiAgY29uc3QgcGZUaXRsZUVsID0gJCgiI3BmVGl0bGUiKTsKICBjb25zdCBzdHJhdGVneUJveCA9ICQoIiNzdHJhdGVneUJveCIpOwogIGNvbnN0IGNhc2hCYWxhbmNlRWwgPSAkKCIjY2FzaEJhbGFuY2UiKTsKICBjb25zdCByZWFsaXplZFBMRWwgPSAkKCIjcmVhbGl6ZWRQTCIpOwogIGNvbnN0IHJlYWxpemVkUExuZXRFbCA9ICQoIiNyZWFsaXplZFBMbmV0Iik7CiAgY29uc3QgaG9sZGluZ3NUYWJsZVdyYXAgPSAkKCIjaG9sZGluZ3NUYWJsZVdyYXAiKTsKICBjb25zdCB0eFRhYmxlV3JhcCA9ICQoIiN0eFRhYmxlV3JhcCIpOwogIGNvbnN0IGZpbHRlclF1ZXJ5RWwgPSAkKCIjZmlsdGVyUXVlcnkiKTsKCiAgLy8gTW9kYWwgaGVscGVycwogIGNvbnN0IG1vZGFsID0gJCgiI21vZGFsIik7CiAgY29uc3QgbW9kYWxUaXRsZSA9ICQoIiNtb2RhbFRpdGxlIik7CiAgY29uc3QgbW9kYWxDb250ZW50ID0gJCgiI21vZGFsQ29udGVudCIpOwogIGNvbnN0IG1vZGFsT2sgPSAkKCIjbW9kYWxPayIpOwogIGNvbnN0IG1vZGFsQ2FuY2VsID0gJCgiI21vZGFsQ2FuY2VsIik7CiAgbGV0IG1vZGFsUmVzb2x2ZSA9IG51bGw7CiAgbW9kYWxDYW5jZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IGNsb3NlTW9kYWwobnVsbCkpOwogIGZ1bmN0aW9uIG9wZW5Nb2RhbCh7dGl0bGUsIGlubmVySFRNTCwgb2tUZXh0PSJaYXBpc3oiLCBjYW5jZWxUZXh0PSJBbnVsdWoifSl7CiAgICBtb2RhbFRpdGxlLnRleHRDb250ZW50ID0gdGl0bGU7CiAgICBtb2RhbENvbnRlbnQuaW5uZXJIVE1MID0gaW5uZXJIVE1MOwogICAgJCgiI21vZGFsT2siKS50ZXh0Q29udGVudCA9IG9rVGV4dDsKICAgICQoIiNtb2RhbENhbmNlbCIpLnRleHRDb250ZW50ID0gY2FuY2VsVGV4dDsKICAgIG1vZGFsLnNob3dNb2RhbCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlcz0+IG1vZGFsUmVzb2x2ZSA9IHJlcyk7CiAgfQogIGZ1bmN0aW9uIGNsb3NlTW9kYWwocmVzdWx0KXsKICAgIG1vZGFsLmNsb3NlKCk7CiAgICBpZihtb2RhbFJlc29sdmUpeyBjb25zdCByID0gbW9kYWxSZXNvbHZlOyBtb2RhbFJlc29sdmUgPSBudWxsOyByKHJlc3VsdCk7IH0KICB9CiAgbW9kYWxPay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT4gewogICAgLy8gQnkgZGVmYXVsdCwgY29sbGVjdCBmb3JtIHZhbHVlcyBpbnRvIGFuIG9iamVjdAogICAgY29uc3QgZm9ybSA9IG1vZGFsQ29udGVudC5xdWVyeVNlbGVjdG9yKCJmb3JtIik7CiAgICBpZihmb3JtKXsKICAgICAgY29uc3QgZGF0YSA9IE9iamVjdC5mcm9tRW50cmllcyhuZXcgRm9ybURhdGEoZm9ybSkuZW50cmllcygpKTsKICAgICAgY2xvc2VNb2RhbChkYXRhKTsKICAgIH1lbHNlewogICAgICBjbG9zZU1vZGFsKHRydWUpOwogICAgfQogIH0pOwoKICAvLyBDb3JlIG9wZXJhdGlvbnMKCiAgLy8gPT09IFJlYnVpbGQgZnJvbSB0cmFuc2FjdGlvbnMgKGNocm9ub2xvZ2ljYWwgcmVwbGF5KSA9PT0KICAKLy8gLS0tIEhlbHBlcjogZmluZCBsb3QgYnkgbG90SWQgYWNyb3NzIGhvbGRpbmdzCmZ1bmN0aW9uIGdldExvdEJ5SWQocGYsIGxvdElkKXsKICBpZighcGYgfHwgIWxvdElkKSByZXR1cm4gbnVsbDsKICBmb3IoY29uc3QgW3RpY2tlciwgaF0gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICBmb3IoY29uc3QgbG90IG9mIChoLmxvdHN8fFtdKSl7CiAgICAgIGlmKGxvdC5sb3RJZCA9PT0gbG90SWQpIHJldHVybiBsb3Q7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGVuc3VyZUJ1eUxvdElkSW5UeCh0eCl7CiAgICAvLyBBc3NpZ24gc3RhYmxlIGxvdElkIHRvIGJ1eSB0eCBpZiBtaXNzaW5nIChiYWNrd2FyZCBjb21wYXQpCiAgICBpZih0eC50eXBlPT09ImJ1eSIgJiYgIXR4LmxvdElkKXsKICAgICAgdHgubG90SWQgPSB0eC5pZCB8fCBpZCgpOwogICAgfQogIH0KICBmdW5jdGlvbiBjbG9uZUVtcHR5U3RhdGUocGYpewogICAgcmV0dXJuIHsgY2FzaDogMCwgaG9sZGluZ3M6IHt9IH07CiAgfQogIGZ1bmN0aW9uIGFwcGx5QnV5KHN0YXRlLCBwZiwgdHgpewogICAgY29uc3QgdGtyID0gdHgudGlja2VyLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgY29uc3QgcCA9IE51bWJlcih0eC5wcmljZSl8fDA7CiAgICBjb25zdCBmID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogICAgc3RhdGUuY2FzaCAtPSAocSpwICsgZik7CiAgICBzdGF0ZS5ob2xkaW5nc1t0a3JdIHx8PSB7IGxvdHM6IFtdIH07CiAgICBjb25zdCBsb3RJZFN0YWJsZSA9IHR4LmxvdElkOwogICAgY29uc3QgbG90ID0geyBsb3RJZDogbG90SWRTdGFibGUsIGRhdGU6IHR4LmRhdGUgfHwgdG9kYXkoKSwgcXR5OiBxLCB1bml0Q29zdDogcCArIChmL3F8fDApLCByYXdQcmljZTogcCwgZmVlczogZiwgbm90ZTogdHgubm90ZXx8IiIsIHRhcmdldFBjdDogKHR4LnRhcmdldFBjdD8/bnVsbCksIHRhcmdldFByaWNlOiAodHgudGFyZ2V0UHJpY2U/P251bGwpLCBidXlUYXJnZXRQY3Q6ICh0eC5idXlUYXJnZXRQY3Q/P251bGwpLCBidXlUYXJnZXRQcmljZTogKHR4LmJ1eVRhcmdldFByaWNlPz9udWxsKSB9OwogICAgc3RhdGUuaG9sZGluZ3NbdGtyXS5sb3RzLnB1c2gobG90KTsKICB9CiAgZnVuY3Rpb24gYXBwbHlTZWxsKHN0YXRlLCBwZiwgdHgpewogIGNvbnN0IHRrciA9IHR4LnRpY2tlci50cmltKCkudG9VcHBlckNhc2UoKTsKICBjb25zdCBwU2VsbCA9IE51bWJlcih0eC5wcmljZXx8dHguc2VsbFByaWNlfHwwKTsKICBjb25zdCBmID0gTnVtYmVyKHR4LmZlZXMpfHwwOwogIGNvbnN0IGxpbmtzID0gKHR4LmxvdExpbmtzfHxbXSkubWFwKHg9Pih7bG90SWQ6IHgubG90SWQsIHF0eTogTnVtYmVyKHgucXR5KXx8MH0pKS5maWx0ZXIoeD0+eC5xdHk+MCk7CiAgLy8gUHJlcGFyZSBlcnJvcnMgYXJyYXkKICBzdGF0ZS5fX2Vycm9ycyA9IHN0YXRlLl9fZXJyb3JzIHx8IFtdOwogIGZ1bmN0aW9uIHNvZnRFcnJvcihtc2cpewogICAgdHJ5eyBzdGF0ZS5fX2Vycm9ycy5wdXNoKHt0aWNrZXI6dGtyLCBpZDogdHguaWR8fG51bGwsIGRhdGU6IHR4LmRhdGV8fG51bGwsIG1lc3NhZ2U6IFN0cmluZyhtc2cpfSk7IH1jYXRjaChfKXt9CiAgfQogIGxldCBwcm9jZWVkcyA9IDAsIGdyb3NzUEwgPSAwOwogIGNvbnN0IGJvb2sgPSBzdGF0ZS5ob2xkaW5nc1t0a3JdOwogIGlmKCFib29rKXsKICAgIHNvZnRFcnJvcigiU3ByemVkYcW8IGJleiBwb3p5Y2ppICgiK3RrcisiKS4iKTsKICAgIC8vIEtlZXAgdHggZGVyaXZlZCBmaWVsZHMgY29uc2lzdGVudCBidXQgZG8gbm90IG11dGF0ZSBzdGF0ZQogICAgdHgucXR5ID0gbGlua3MucmVkdWNlKChhLGIpPT5hK2IucXR5LDApOwogICAgdHgucHJvY2VlZHMgPSAwOyB0eC5ncm9zc1BMID0gMDsgdHgudGF4ID0gMDsgdHgubmV0UEwgPSAwOwogICAgcmV0dXJuOwogIH0KICBmb3IoY29uc3QgbGluayBvZiBsaW5rcyl7CiAgICBjb25zdCBsb3QgPSBib29rLmxvdHMuZmluZChsPT5sLmxvdElkPT09bGluay5sb3RJZCk7CiAgICBpZighbG90KXsKICAgICAgc29mdEVycm9yKCJCcmFrIHBhcnRpaSAiK2xpbmsubG90SWQrIiBwcnp5IHNwcnplZGHFvHkgIit0a3IpOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIGlmKGxpbmsucXR5ID4gbG90LnF0eSArIDFlLTkpewogICAgICBzb2Z0RXJyb3IoIlNwcnplZGHFvCBwcnpla3JhY3phIGlsb8WbxIcgdyBwYXJ0aWkgKCIrdGtyKyIpLiIpOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIHByb2NlZWRzICs9IGxpbmsucXR5ICogcFNlbGw7CiAgICBncm9zc1BMICs9IGxpbmsucXR5ICogKHBTZWxsIC0gbG90LnVuaXRDb3N0KTsKICB9CiAgZ3Jvc3NQTCAtPSBmOwogIGNvbnN0IHRheCA9IGdyb3NzUEw+MCA/IGdyb3NzUEwqKERCLnNldHRpbmdzLnRheFJhdGV8fDAuMTkpIDogMDsKICBjb25zdCBuZXRQTCA9IGdyb3NzUEwgLSB0YXg7CiAgLy8gVXBkYXRlIGNhc2ggJiByZWR1Y2UgbG90cyBvbmx5IGZvciBsaW5rcyB0aGF0IHdlcmUgdmFsaWQKICBzdGF0ZS5jYXNoICs9IChwcm9jZWVkcyAtIGYpOwogIGZvcihjb25zdCBsaW5rIG9mIGxpbmtzKXsKICAgIGNvbnN0IGxvdCA9IChib29rLmxvdHN8fFtdKS5maW5kKGw9PmwubG90SWQ9PT1saW5rLmxvdElkKTsKICAgIGlmKGxvdCAmJiBsaW5rLnF0eSA8PSBsb3QucXR5ICsgMWUtOSl7CiAgICAgIGxvdC5xdHkgLT0gbGluay5xdHk7CiAgICB9CiAgfQogIGJvb2subG90cyA9IGJvb2subG90cy5maWx0ZXIobD0+bC5xdHk+MWUtOSk7CiAgLy8gTXV0YXRlIHR4IHRvIGtlZXAgZGVyaXZlZCBmaWVsZHMgY29uc2lzdGVudAogIHR4LnF0eSA9IGxpbmtzLnJlZHVjZSgoYSxiKT0+YStiLnF0eSwwKTsKICB0eC5wcmljZSA9IHBTZWxsOwogIHR4LnByb2NlZWRzID0gcHJvY2VlZHM7CiAgdHguZ3Jvc3NQTCA9IGdyb3NzUEw7CiAgdHgudGF4ID0gdGF4OwogIHR4Lm5ldFBMID0gbmV0UEw7Cn0KCmZ1bmN0aW9uIGFwcGx5VHJhbnNmZXJDb21wYW55SW4oc3RhdGUsIHBmLCB0eCl7CiAgICBjb25zdCB0a3IgPSAodHgudGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICBjb25zdCBxID0gTnVtYmVyKHR4LnF0eSl8fDA7CiAgICBjb25zdCB1YyA9IE51bWJlcih0eC51bml0Q29zdCA/PyB0eC5wcmljZSA/PyAwKSB8fCAwOwogICAgc3RhdGUuaG9sZGluZ3NbdGtyXSB8fD0geyBsb3RzOiBbXSB9OwogICAgY29uc3QgbG90SWQgPSB0eC5uZXdMb3RJZCB8fCB0eC5sb3RJZCB8fCBpZCgpOwogICAgY29uc3QgbG90ID0geyBsb3RJZCwgZGF0ZTogdHguZGF0ZSB8fCB0b2RheSgpLCBxdHk6IHEsIHVuaXRDb3N0OiB1YywgcmF3UHJpY2U6IHVjLCBmZWVzOiBOdW1iZXIodHguZmVlcyl8fDAsIG5vdGU6IHR4Lm5vdGV8fCIiIH07CiAgICBzdGF0ZS5ob2xkaW5nc1t0a3JdLmxvdHMucHVzaChsb3QpOwogIH0KCmZ1bmN0aW9uIGFwcGx5VHJhbnNmZXJDb21wYW55T3V0KHN0YXRlLCBwZiwgdHgpewogICAgY29uc3QgdGtyID0gKHR4LnRpY2tlcnx8JycpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgY29uc3QgcSA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgY29uc3QgYm9vayA9IHN0YXRlLmhvbGRpbmdzW3Rrcl07CiAgICBpZighYm9vaykgcmV0dXJuOyAvLyBub3RoaW5nIHRvIHJlbW92ZQogICAgaWYodHgubG90SWQpewogICAgICBjb25zdCBpZHggPSBib29rLmxvdHMuZmluZEluZGV4KGw9PmwubG90SWQ9PT10eC5sb3RJZCk7CiAgICAgIGlmKGlkeD49MCl7CiAgICAgICAgY29uc3QgbG90ID0gYm9vay5sb3RzW2lkeF07CiAgICAgICAgbG90LnF0eSAtPSBxOwogICAgICAgIGlmKGxvdC5xdHkgPD0gMWUtOSl7IGJvb2subG90cy5zcGxpY2UoaWR4LDEpOyB9CiAgICAgIH0KICAgIH1lbHNlewogICAgICAvLyBGYWxsYmFjazogcmVtb3ZlIHF0eSBmcm9tIGZpcnN0IGxvdHMgRklGTwogICAgICBsZXQgcmVtYWluaW5nID0gcTsKICAgICAgZm9yKGNvbnN0IGxvdCBvZiBib29rLmxvdHMpewogICAgICAgIGlmKHJlbWFpbmluZzw9MWUtOSkgYnJlYWs7CiAgICAgICAgY29uc3QgdGFrZSA9IE1hdGgubWluKGxvdC5xdHksIHJlbWFpbmluZyk7CiAgICAgICAgbG90LnF0eSAtPSB0YWtlOwogICAgICAgIHJlbWFpbmluZyAtPSB0YWtlOwogICAgICB9CiAgICAgIGJvb2subG90cyA9IGJvb2subG90cy5maWx0ZXIobD0+bC5xdHk+MWUtOSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhcHBseUNhc2goc3RhdGUsIHR5cGUsIGFtb3VudCl7CiAgICBjb25zdCBhID0gTnVtYmVyKGFtb3VudCl8fDA7CiAgICBpZih0eXBlPT09ImRlcG9zaXQiIHx8IHR5cGU9PT0idHJhbnNmZXJfaW4iKSBzdGF0ZS5jYXNoICs9IGE7CiAgICBpZih0eXBlPT09IndpdGhkcmF3IiB8fCB0eXBlPT09InRyYW5zZmVyX291dCIpIHN0YXRlLmNhc2ggLT0gYTsKICB9CiAgZnVuY3Rpb24gcmVidWlsZFBvcnRmb2xpbyhwZil7CiAgICAvLyAtLS0gUHJlc2VydmUgcGVyLWxvdCBtdXRlZCBmbGFncyBCRUZPUkUgcmVidWlsZCAoYnkgc3RhYmxlIGxvdElkKSAtLS0KICAgIGNvbnN0IF9fcHJldk11dGVkID0ge307CiAgICB0cnl7CiAgICAgIGNvbnN0IHByZXZIb2xkaW5ncyA9IHBmICYmIHBmLmhvbGRpbmdzID8gcGYuaG9sZGluZ3MgOiB7fTsKICAgICAgZm9yKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocHJldkhvbGRpbmdzKSl7CiAgICAgICAgZm9yKGNvbnN0IGxvdCBvZiAoYm9vay5sb3RzfHxbXSkpewogICAgICAgICAgaWYobG90ICYmIGxvdC5sb3RJZCl7IF9fcHJldk11dGVkW2xvdC5sb3RJZF0gPSAhIWxvdC5tdXRlZDsgfQogICAgICAgIH0KICAgICAgfQogICAgfWNhdGNoKF8pe30KCiAgICAvLyBSZXBsYXkgZnJvbSBvbGRlc3QgdG8gbmV3ZXN0CiAgICBjb25zdCB0eHNDaHJvbm8gPSBwZi50cmFuc2FjdGlvbnMuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICBjb25zdCBzdGF0ZSA9IGNsb25lRW1wdHlTdGF0ZShwZik7CiAgICBzdGF0ZS5fX2Vycm9ycyA9IFtdOwogICAgZm9yKGNvbnN0IHR4IG9mIHR4c0Nocm9ubyl7CiAgICAgIGlmKHR4LnR5cGU9PT0iZGVwb3NpdCIgfHwgdHgudHlwZT09PSJ3aXRoZHJhdyIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9pbiIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9vdXQiKXsKICAgICAgICBhcHBseUNhc2goc3RhdGUsIHR4LnR5cGUsIHR4LmFtb3VudCk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0iYnV5Iil7CiAgICAgICAgZW5zdXJlQnV5TG90SWRJblR4KHR4KTsKICAgICAgICBhcHBseUJ1eShzdGF0ZSwgcGYsIHR4KTsKICAgICAgfWVsc2UgaWYodHgudHlwZSA9PT0gInNlbGwiKXsKICAgICAgICBjb25zdCBzZWxsRGF0ZU1zID0gdG9Ncyh0eC5kYXRlKTsKICAgICAgICBhcHBseVNlbGwoc3RhdGUsIHBmLCB0eCk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0idHJhbnNmZXJfY29tcGFueV9pbiIpewogICAgICAgIGFwcGx5VHJhbnNmZXJDb21wYW55SW4oc3RhdGUsIHBmLCB0eCk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0idHJhbnNmZXJfY29tcGFueV9vdXQiKXsKICAgICAgICBhcHBseVRyYW5zZmVyQ29tcGFueU91dChzdGF0ZSwgcGYsIHR4KTsKICAgICAgfQogICAgfQoKICAgIC8vIC0tLSBSZS1hcHBseSBtdXRlZCBmbGFncyB0byByZWJ1aWx0IGxvdHMgKG1hdGNoaW5nIGJ5IGxvdElkKSAtLS0KICAgIHRyeXsKICAgICAgZm9yKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUuaG9sZGluZ3N8fHt9KSl7CiAgICAgICAgZm9yKGNvbnN0IGxvdCBvZiAoYm9vay5sb3RzfHxbXSkpewogICAgICAgICAgaWYobG90ICYmIGxvdC5sb3RJZCAmJiAoX19wcmV2TXV0ZWRbbG90LmxvdElkXSA9PT0gdHJ1ZSB8fCBfX3ByZXZNdXRlZFtsb3QubG90SWRdID09PSBmYWxzZSkpewogICAgICAgICAgICBsb3QubXV0ZWQgPSBfX3ByZXZNdXRlZFtsb3QubG90SWRdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfWNhdGNoKF8pe30KCiAgICAKICAgIC8vIC0tLSBQcnVuZSBlbXB0eS96ZXJvLXF0eSBsb3RzIGFuZCByZW1vdmUgZW1wdHkgdGlja2VycyAoYW50aS1naG9zdCkgLS0tCiAgICB0cnkgewogICAgICBmb3IgKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMoc3RhdGUuaG9sZGluZ3MgfHwge30pKSB7CiAgICAgICAgY29uc3QgbG90cyA9IEFycmF5LmlzQXJyYXkoYm9vay5sb3RzKSA/IGJvb2subG90cyA6IFtdOwogICAgICAgIC8vIGRyb3AgemVyby1xdHkgbG90cwogICAgICAgIGJvb2subG90cyA9IGxvdHMuZmlsdGVyKGwgPT4gTnVtYmVyKGwgJiYgbC5xdHkgfHwgMCkgPiAxZS05KTsKICAgICAgICAvLyByZW1vdmUgdGlja2VyIGVudGlyZWx5IGlmIG5vIGxvdHMgbGVmdAogICAgICAgIGlmICghYm9vay5sb3RzLmxlbmd0aCkgewogICAgICAgICAgZGVsZXRlIHN0YXRlLmhvbGRpbmdzW3RrXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKF8pIHt9CnBmLl9fZXJyb3JzID0gQXJyYXkuaXNBcnJheShzdGF0ZS5fX2Vycm9ycykgPyBzdGF0ZS5fX2Vycm9ycyA6IFtdOwogICAgcGYuY2FzaCA9IHN0YXRlLmNhc2g7CiAgICBwZi5ob2xkaW5ncyA9IHN0YXRlLmhvbGRpbmdzOwogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOwogIH0KICBmdW5jdGlvbiBnZXRQZihpZCl7IHJldHVybiBEQi5wb3J0Zm9saW9zLmZpbmQocD0+cC5pZD09PWlkKSB8fCBudWxsOyB9CiAgZnVuY3Rpb24gZW5zdXJlQ3VycmVuY3koY3VyKXsgcmV0dXJuIGN1ciB8fCBEQi5zZXR0aW5ncy5jdXJyZW5jeURlZmF1bHQgfHwgIlBMTiI7IH0KCiAgZnVuY3Rpb24gYWRkUG9ydGZvbGlvKCl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IkRvZGFuaWUgcG9ydGZlbGEiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBuZXdQZiA9IHsKICAgICAgaWQ6IGlkKCksCiAgICAgIG5hbWU6ICJOb3d5IHBvcnRmZWwiLAogICAgICBjdXJyZW5jeTogREIuc2V0dGluZ3MuY3VycmVuY3lEZWZhdWx0IHx8ICJQTE4iLAogICAgICBzdHJhdGVneTogIiIsCiAgICAgIGNhc2g6IDAsCiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgaG9sZGluZ3M6IHt9LCAvLyB0aWNrZXIgLT4geyBsb3RzOiBbIHtsb3RJZCwgZGF0ZSwgcXR5LCB1bml0Q29zdCwgcmF3UHJpY2UsIGZlZXMsIG5vdGV9IF0gfQogICAgICB0cmFuc2FjdGlvbnM6IFtdIC8vIGxpc3Qgb2YgdHggb2JqZWN0cwogICAgfTsKICAgIERCLnBvcnRmb2xpb3MucHVzaChuZXdQZik7CiAgICBjdXJyZW50UGZJZCA9IG5ld1BmLmlkOwogICAgc2F2ZSgpOyByZW5kZXIoKTsKICB9CgogIGZ1bmN0aW9uIGRlbGV0ZVBvcnRmb2xpbyhwZklkKXsKICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiVXN1bmlcdTAxMTljaWUgcG9ydGZlbGEiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBpZHggPSBEQi5wb3J0Zm9saW9zLmZpbmRJbmRleChwPT5wLmlkPT09cGZJZCk7CiAgICBpZihpZHg+PTApeyBEQi5wb3J0Zm9saW9zLnNwbGljZShpZHgsMSk7IGlmKGN1cnJlbnRQZklkPT09cGZJZCkgY3VycmVudFBmSWQgPSBEQi5wb3J0Zm9saW9zWzBdPy5pZCB8fCBudWxsOyBzYXZlKCk7IHJlbmRlcigpOyB9CiAgfQoKICBmdW5jdGlvbiByZW5hbWVQb3J0Zm9saW8ocGZJZCwgbmFtZSl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlptaWFuYSBuYXp3eSBwb3J0ZmVsYSIsIGtpbmQ6J21ldGEnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBwZi5uYW1lID0gbmFtZTsgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB0cnkgeyByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogIH0KCiAgZnVuY3Rpb24gc2V0U3RyYXRlZ3kocGZJZCwgdGV4dCl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IkVkeWNqYSBzdHJhdGVnaWkvbm90YXRraSIsIGtpbmQ6J21ldGEnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBwZi5zdHJhdGVneSA9IHRleHQ7IHBmLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsgdHJ5IHsgcmVidWlsZFBvcnRmb2xpbyhwZik7IH0gY2F0Y2goXykge30gc2F2ZSgpOyByZW5kZXIoKTsKICB9CgogIGZ1bmN0aW9uIGRlcG9zaXQocGZJZCwgYW1vdW50LCBub3RlPSIiKXsKICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiV3BcdTAxNDJhdGEgZ290XHUwMGYzd2tpIiwga2luZDondHgnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBjb25zdCBhbXQgPSBOdW1iZXIoYW1vdW50KXx8MDsKICAgIHBmLmNhc2ggKz0gYW10OwogICAgcGYudHJhbnNhY3Rpb25zLnVuc2hpZnQoeyBpZDppZCgpLCB0eXBlOiJkZXBvc2l0IiwgZGF0ZTp0b2RheSgpLCBhbW91bnQ6YW10LCBub3RlIH0pOwogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB0cnkgeyByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogIH0KICBmdW5jdGlvbiB3aXRoZHJhdyhwZklkLCBhbW91bnQsIG5vdGU9IiIpewogIHRyeXsgcHVzaFVuZG8oe2xhYmVsOiJXeXBcdTAxNDJhdGEgZ290XHUwMGYzd2tpIiwga2luZDondHgnfSk7IH1jYXRjaChfKXt9CgogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBjb25zdCBhbXQgPSBOdW1iZXIoYW1vdW50KXx8MDsKICAgIGlmKCFEQi5zZXR0aW5ncy5hbGxvd05lZ2F0aXZlQ2FzaCAmJiBwZi5jYXNoIDwgYW10KXsgYWxlcnQoIkJyYWsgxZtyb2Rrw7N3LiBXxYLEhWN6IG9wY2rEmSAnWmV6d8OzbCBuYSBzYWxkbyB1amVtbmUnIHcgVXN0YXdpZW5pYWNoLCBqZcWbbGkgY2hjZXN6IGtvbnR5bnVvd2HEhy4iKTsgcmV0dXJuOyB9CiAgICBwZi5jYXNoIC09IGFtdDsKICAgIHBmLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsgaWQ6aWQoKSwgdHlwZToid2l0aGRyYXciLCBkYXRlOnRvZGF5KCksIGFtb3VudDphbXQsIG5vdGUgfSk7CiAgICBwZi51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7IHRyeSB7IHJlYnVpbGRQb3J0Zm9saW8ocGYpOyB9IGNhdGNoKF8pIHt9IHNhdmUoKTsgcmVuZGVyKCk7CiAgfQoKICBmdW5jdGlvbiB0cmFuc2Zlcihmcm9tSWQsIHRvSWQsIGFtb3VudCwgbm90ZT0iIil7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlByemVsZXcgbWlcdTAxMTlkenkgcG9ydGZlbGFtaSIsIGtpbmQ6J3R4J30pOyB9Y2F0Y2goXyl7fQoKICBpZihmcm9tSWQ9PT10b0lkKXsgYWxlcnQoIld5YmllcnogcsOzxbxuZSBwb3J0ZmVsZS4iKTsgcmV0dXJuOyB9CiAgY29uc3QgZnJvbSA9IGdldFBmKGZyb21JZCksIHRvID0gZ2V0UGYodG9JZCk7CiAgY29uc3QgYW10ID0gTnVtYmVyKGFtb3VudCl8fDA7CiAgaWYoIWZyb20gfHwgIXRvKSByZXR1cm4gYWxlcnQoIk5pZXByYXdpZMWCb3dlIHBvcnRmZWxlLiIpOwogIGlmKCFEQi5zZXR0aW5ncy5hbGxvd05lZ2F0aXZlQ2FzaCAmJiBmcm9tLmNhc2ggPCBhbXQpeyBhbGVydCgiQnJhayDFm3JvZGvDs3cgdyBwb3J0ZmVsdSDFunLDs2TFgm93eW0uIik7IHJldHVybjsgfQogIGZyb20uY2FzaCAtPSBhbXQ7CiAgdG8uY2FzaCArPSBhbXQ7CiAgY29uc3Qgc3RhbXAgPSB0b2RheSgpOwogIGNvbnN0IGxpbmtJZCA9IGlkKCk7CiAgZnJvbS50cmFuc2FjdGlvbnMudW5zaGlmdCh7IGlkOmlkKCksIGxpbmtJZCwgdHlwZToidHJhbnNmZXJfb3V0IiwgZGF0ZTpzdGFtcCwgYW1vdW50OmFtdCwgbm90ZSwgY291bnRlcnBhcnR5UG9ydGZvbGlvSWQ6IHRvLmlkIH0pOwogIHRvLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsgaWQ6aWQoKSwgbGlua0lkLCB0eXBlOiJ0cmFuc2Zlcl9pbiIsICBkYXRlOnN0YW1wLCBhbW91bnQ6YW10LCBub3RlLCBjb3VudGVycGFydHlQb3J0Zm9saW9JZDogZnJvbS5pZCB9KTsKICBmcm9tLnVwZGF0ZWRBdCA9IHRvLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICBzYXZlKCk7IHJlbmRlcigpOwp9CgoKYXN5bmMgZnVuY3Rpb24gdHJhbnNmZXJDb21wYW55RGlhbG9nKGZyb21QZklkLCB0aWNrZXIpIHsKICBjb25zdCBmcm9tUGYgPSBnZXRQZihmcm9tUGZJZCk7CiAgaWYoIWZyb21QZikgcmV0dXJuIGFsZXJ0KCJCxYLEhWQ6IHBvcnRmZWwgxbpyw7NkxYJvd3kgbmllIGlzdG5pZWplLiIpOwogIGNvbnN0IGJvb2sgPSAoZnJvbVBmLmhvbGRpbmdzfHx7fSlbdGlja2VyXTsKICBpZighYm9vayB8fCAhYm9vay5sb3RzIHx8ICFib29rLmxvdHMubGVuZ3RoKSByZXR1cm4gYWxlcnQoIkJyYWsgcGFraWV0w7N3IGRvIHByemVuaWVzaWVuaWEuIik7CiAgY29uc3QgdGFyZ2V0UG9ydGZvbGlvcyA9IERCLnBvcnRmb2xpb3MuZmlsdGVyKHAgPT4gcC5pZCAhPT0gZnJvbVBmSWQpOwogIGlmKCF0YXJnZXRQb3J0Zm9saW9zLmxlbmd0aCkgcmV0dXJuIGFsZXJ0KCJCcmFrIGlubnljaCBwb3J0ZmVsaSBkbyBwcnplbmllc2llbmlhLiIpOwogIGNvbnN0IG9wdHMgPSB0YXJnZXRQb3J0Zm9saW9zLm1hcChwID0+IGA8b3B0aW9uIHZhbHVlPSIke3AuaWR9Ij4ke19fZXNjKHAubmFtZSl9ICgke3AuY3VycmVuY3l9KTwvb3B0aW9uPmApLmpvaW4oIiIpOwogIGNvbnN0IHRvdGFsUXR5ID0gYm9vay5sb3RzLnJlZHVjZSgoc3VtLCBsb3QpID0+IHN1bSArIE51bWJlcihsb3QucXR5fHwwKSwgMCk7CiAgY29uc3QgdG90YWxWYWx1ZSA9IGJvb2subG90cy5yZWR1Y2UoKHN1bSwgbG90KSA9PiBzdW0gKyAoTnVtYmVyKGxvdC5xdHl8fDApICogTnVtYmVyKGxvdC51bml0Q29zdHx8MCkpLCAwKTsKICBjb25zdCBsb3RzTGlzdCA9IGJvb2subG90cy5tYXAoKGxvdCwgaSkgPT4gCiAgICBgPHRyPgogICAgICA8dGQ+JHtpKzF9PC90ZD4KICAgICAgPHRkPiR7X19lc2MobG90LmRhdGV8fCIiKX08L3RkPgogICAgICA8dGQ+JHtfX2ZtdE51bShsb3QucXR5fHwwKX08L3RkPgogICAgICA8dGQ+JHtfX2dvX2ZtdEN1cnJlbmN5KGxvdC51bml0Q29zdHx8MCwgZnJvbVBmLmN1cnJlbmN5KX08L3RkPgogICAgICA8dGQ+JHtfX2dvX2ZtdEN1cnJlbmN5KChOdW1iZXIobG90LnF0eXx8MCkgKiBOdW1iZXIobG90LnVuaXRDb3N0fHwwKSksIGZyb21QZi5jdXJyZW5jeSl9PC90ZD4KICAgIDwvdHI+YAogICkuam9pbigiIik7CgogIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgdGl0bGU6IGBQcnplbmllxZsgY2HFgsSFIHNww7PFgmvEmSAke3RpY2tlcn1gLAogICAgaW5uZXJIVE1MOiBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+CiAgICAgICAgPGxhYmVsPlBvcnRmZWwgZG9jZWxvd3k8L2xhYmVsPgogICAgICAgIDxzZWxlY3QgbmFtZT0idG9Qb3J0Zm9saW9JZCIgcmVxdWlyZWQ+JHtvcHRzfTwvc2VsZWN0PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgIDxsYWJlbD5EYXRhIHByemVuaWVzaWVuaWE8L2xhYmVsPgogICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgcmVxdWlyZWQgLz4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgPGxhYmVsPk5vdGF0a2EgKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHBsYWNlaG9sZGVyPSJucC4gcmVvcmdhbml6YWNqYSBwb3J0ZmVsaSIgLz4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgPGg0PlBha2lldHkgZG8gcHJ6ZW5pZXNpZW5pYTo8L2g0PgogICAgICAgIDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPgogICAgICAgICAgPHRhYmxlPgogICAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgICAgPHRyPjx0aD4jPC90aD48dGg+RGF0YTwvdGg+PHRoPklsb8WbxIc8L3RoPjx0aD5Lb3N6dC9zenQ8L3RoPjx0aD5XYXJ0b8WbxIc8L3RoPjwvdHI+CiAgICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICAgIDx0Ym9keT4ke2xvdHNMaXN0fTwvdGJvZHk+CiAgICAgICAgICAgIDx0Zm9vdD4KICAgICAgICAgICAgICA8dHIgc3R5bGU9ImZvbnQtd2VpZ2h0OmJvbGQiPgogICAgICAgICAgICAgICAgPHRkIGNvbHNwYW49IjIiPlJBWkVNOjwvdGQ+CiAgICAgICAgICAgICAgICA8dGQ+JHtfX2ZtdE51bSh0b3RhbFF0eSl9PC90ZD4KICAgICAgICAgICAgICAgIDx0ZD7igJQ8L3RkPgogICAgICAgICAgICAgICAgPHRkPiR7X19nb19mbXRDdXJyZW5jeSh0b3RhbFZhbHVlLCBmcm9tUGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90Zm9vdD4KICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwgd2Fybi10ZXh0Ij4KICAgICAgICAgIFVXQUdBOiBPcGVyYWNqYSBwcnplbmllc2llIHdzenlzdGtpZSBwYWtpZXR5IGFrY2ppICR7dGlja2VyfSAKICAgICAgICAgIHogcG9ydGZlbGEgIiR7ZnJvbVBmLm5hbWV9IiBkbyB3eWJyYW5lZ28gcG9ydGZlbGEgZG9jZWxvd2Vnby4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Zvcm0+YCwKICAgIG9rVGV4dDogIlByemVuaWXFmyBzcMOzxYJrxJkiLAogICAgY2FuY2VsVGV4dDogIkFudWx1aiIKICB9KTsKICBpZihkYXRhKSB7CiAgICBhd2FpdCB0cmFuc2ZlckNvbXBhbnkoZnJvbVBmSWQsIGRhdGEudG9Qb3J0Zm9saW9JZCwgdGlja2VyLCBkYXRhLmRhdGUsIGRhdGEubm90ZXx8IiIpOwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdHJhbnNmZXJDb21wYW55KGZyb21QZklkLCB0b1BmSWQsIHRpY2tlciwgZGF0ZSwgbm90ZSA9ICIiKSB7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlRyYW5zZmVyIHNwXHUwMGYzXHUwMTQya2kiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgaWYoZnJvbVBmSWQgPT09IHRvUGZJZCkgcmV0dXJuIGFsZXJ0KCJQb3J0ZmVsIMW6csOzZMWCb3d5IGkgZG9jZWxvd3kgc8SFIGlkZW50eWN6bmUuIik7CiAgY29uc3QgZnJvbVBmID0gZ2V0UGYoZnJvbVBmSWQpOwogIGNvbnN0IHRvUGYgPSBnZXRQZih0b1BmSWQpOwogIGlmKCFmcm9tUGYgfHwgIXRvUGYpIHJldHVybiBhbGVydCgiQsWCxIVkOiBuaWVwcmF3aWTFgm93ZSBwb3J0ZmVsZS4iKTsKICBjb25zdCBib29rID0gKGZyb21QZi5ob2xkaW5nc3x8e30pW3RpY2tlcl07CiAgaWYoIWJvb2sgfHwgIWJvb2subG90cyB8fCAhYm9vay5sb3RzLmxlbmd0aCkgcmV0dXJuIGFsZXJ0KCJCcmFrIHBha2lldMOzdyBkbyBwcnplbmllc2llbmlhLiIpOwogIGlmKGZyb21QZi5jdXJyZW5jeSAhPT0gdG9QZi5jdXJyZW5jeSkgewogICAgY29uc3QgcHJvY2VlZCA9IGNvbmZpcm0oCiAgICAgIGBVd2FnYTogUsOzxbxuZSB3YWx1dHkhXG5gICsKICAgICAgYFo6ICR7ZnJvbVBmLm5hbWV9ICgke2Zyb21QZi5jdXJyZW5jeX0pXG5gICsKICAgICAgYERvOiAke3RvUGYubmFtZX0gKCR7dG9QZi5jdXJyZW5jeX0pXG5cbmAgKwogICAgICBgQ3p5IGtvbnR5bnVvd2HEhyBwcnplbmllc2llbmllP2AKICAgICk7CiAgICBpZighcHJvY2VlZCkgcmV0dXJuOwogIH0KICB0cnl7CiAgICBjb25zdCB0cmFuc2ZlckRhdGUgPSBkYXRlIHx8IHRvZGF5KCk7CiAgICBjb25zdCBsaW5rSWQgPSBpZCgpOwogICAgdG9QZi5ob2xkaW5nc1t0aWNrZXJdID0gdG9QZi5ob2xkaW5nc1t0aWNrZXJdIHx8IHsgbG90czogW10gfTsKICAgIGZvcihjb25zdCBsb3Qgb2YgYm9vay5sb3RzKXsKICAgICAgY29uc3QgbmV3TG90SWQgPSBpZCgpOwogICAgICBjb25zdCBuZXdMb3QgPSB7CiAgICAgICAgLi4ubG90LAogICAgICAgIGxvdElkOiBuZXdMb3RJZCwKICAgICAgICB0cmFuc2ZlcnJlZEZyb206IHsKICAgICAgICAgIG9yaWdpbmFsTG90SWQ6IGxvdC5sb3RJZCwKICAgICAgICAgIGZyb21Qb3J0Zm9saW9JZDogZnJvbVBmSWQsCiAgICAgICAgICBmcm9tUG9ydGZvbGlvTmFtZTogZnJvbVBmLm5hbWUsCiAgICAgICAgICB0cmFuc2ZlckRhdGU6IHRyYW5zZmVyRGF0ZSwKICAgICAgICAgIHRyYW5zZmVyTGlua0lkOiBsaW5rSWQKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRvUGYuaG9sZGluZ3NbdGlja2VyXS5sb3RzLnB1c2gobmV3TG90KTsKICAgICAgdG9QZi50cmFuc2FjdGlvbnMudW5zaGlmdCh7CiAgICAgICAgaWQ6IGlkKCksCiAgICAgICAgbGlua0lkOiBsaW5rSWQsCiAgICAgICAgdHlwZTogInRyYW5zZmVyX2NvbXBhbnlfaW4iLAogICAgICAgIGRhdGU6IHRyYW5zZmVyRGF0ZSwKICAgICAgICB0aWNrZXI6IHRpY2tlciwKICAgICAgICBxdHk6IE51bWJlcihsb3QucXR5KXx8MCwKICAgICAgICBwcmljZTogTnVtYmVyKGxvdC5yYXdQcmljZSA/PyBsb3QudW5pdENvc3QpIHx8IDAsCiAgICAgICAgdW5pdENvc3Q6IE51bWJlcihsb3QudW5pdENvc3QpfHwwLAogICAgICAgIGZlZXM6IE51bWJlcihsb3QuZmVlcyl8fDAsCiAgICAgICAgbm90ZTogYFRyYW5zZmVyIHNww7PFgmtpICR7dGlja2VyfSB6IHBvcnRmZWxhICIke2Zyb21QZi5uYW1lfSIuICR7bm90ZX1gLnRyaW0oKSwKICAgICAgICBjb3VudGVycGFydHlQb3J0Zm9saW9JZDogZnJvbVBmSWQsCiAgICAgICAgb3JpZ2luYWxMb3RJZDogbG90LmxvdElkLAogICAgICAgIG5ld0xvdElkOiBuZXdMb3RJZAogICAgICB9KTsKICAgIH0KICAgIGZvcihjb25zdCBsb3Qgb2YgYm9vay5sb3RzKXsKICAgICAgZnJvbVBmLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsKICAgICAgICBpZDogaWQoKSwKICAgICAgICBsaW5rSWQ6IGxpbmtJZCwKICAgICAgICB0eXBlOiAidHJhbnNmZXJfY29tcGFueV9vdXQiLAogICAgICAgIGRhdGU6IHRyYW5zZmVyRGF0ZSwKICAgICAgICB0aWNrZXI6IHRpY2tlciwKICAgICAgICBxdHk6IE51bWJlcihsb3QucXR5KXx8MCwKICAgICAgICBwcmljZTogTnVtYmVyKGxvdC5yYXdQcmljZSA/PyBsb3QudW5pdENvc3QpIHx8IDAsCiAgICAgICAgdW5pdENvc3Q6IE51bWJlcihsb3QudW5pdENvc3QpfHwwLAogICAgICAgIGZlZXM6IE51bWJlcihsb3QuZmVlcyl8fDAsCiAgICAgICAgbm90ZTogYFRyYW5zZmVyIHNww7PFgmtpICR7dGlja2VyfSBkbyBwb3J0ZmVsYSAiJHt0b1BmLm5hbWV9Ii4gJHtub3RlfWAudHJpbSgpLAogICAgICAgIGNvdW50ZXJwYXJ0eVBvcnRmb2xpb0lkOiB0b1BmSWQsCiAgICAgICAgbG90SWQ6IGxvdC5sb3RJZAogICAgICB9KTsKICAgIH0KICAgIGRlbGV0ZSBmcm9tUGYuaG9sZGluZ3NbdGlja2VyXTsKICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgIGZyb21QZi51cGRhdGVkQXQgPSBub3c7CiAgICB0b1BmLnVwZGF0ZWRBdCA9IG5vdzsKICAgIHRyeSB7IHJlYnVpbGRQb3J0Zm9saW8oZnJvbVBmKTsgcmVidWlsZFBvcnRmb2xpbyh0b1BmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogICAgYWxlcnQoCiAgICAgIGBUcmFuc2ZlciB6YWtvxYRjem9ueSFcblxuYCArCiAgICAgIGBTcMOzxYJrYTogJHt0aWNrZXJ9XG5gICsKICAgICAgYFo6ICR7ZnJvbVBmLm5hbWV9IOKGkiAke3RvUGYubmFtZX1cbmAgKwogICAgICBgUGFraWV0w7N3OiAke2Jvb2subG90cy5sZW5ndGh9XG5gICsKICAgICAgYERhdGE6ICR7dHJhbnNmZXJEYXRlfWAKICAgICk7CiAgfWNhdGNoKGVycm9yKXsKICAgIGNvbnNvbGUuZXJyb3IoIkLFgsSFZCB0cmFuc2ZlcnUgc3DDs8WCa2k6IiwgZXJyb3IpOwogICAgYWxlcnQoYELFgsSFZCBwb2RjemFzIHRyYW5zZmVydTogJHtlcnJvci5tZXNzYWdlfWApOwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gYnV5KHBmSWQsIHt0aWNrZXIsIGRhdGUsIHF0eSwgcHJpY2UsIGZlZXMsIG5vdGUsIHRhcmdldFBjdCwgdGFyZ2V0UHJpY2UsIGJ1eVRhcmdldFBjdCwgYnV5VGFyZ2V0UHJpY2V9KXsKICB0cnl7IHB1c2hVbmRvKHtsYWJlbDoiWmFrdXAiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBwZiA9IGdldFBmKHBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIHRpY2tlciA9ICh0aWNrZXJ8fCIiKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgIGNvbnN0IHEgPSBNYXRoLm1heCgwLCBOdW1iZXIocXR5KXx8MCk7CiAgICBjb25zdCBwID0gTnVtYmVyKHByaWNlKXx8MDsKICAgIGNvbnN0IGYgPSBOdW1iZXIoZmVlcyl8fDA7CiAgICBpZighdGlja2VyIHx8IHE8PTAgfHwgcDw9MCl7IHJldHVybiBhbGVydCgiVXp1cGXFgm5paiBwb3ByYXduaWU6IHRpY2tlciwgaWxvxZvEhywgY2VuxJkuIik7IH0KICAgIGNvbnN0IGNhc2hPdXQgPSBxKnAgKyBmOwogICAgaWYoIURCLnNldHRpbmdzLmFsbG93TmVnYXRpdmVDYXNoICYmIHBmLmNhc2ggPCBjYXNoT3V0KXsgcmV0dXJuIGFsZXJ0KCJCcmFrIMWbcm9ka8OzdyBuYSB6YWt1cCAoc3ByYXdkxbogc2FsZG8gZ290w7N3a2kpLiIpOyB9CiAgICBwZi5jYXNoIC09IGNhc2hPdXQ7CiAgICBwZi5ob2xkaW5nc1t0aWNrZXJdIHx8PSB7IGxvdHM6IFtdIH07CiAgICBjb25zdCBsb3QgPSB7IGxvdElkOiBpZCgpLCBkYXRlOiBkYXRlIHx8IHRvZGF5KCksIHF0eTogcSwgdW5pdENvc3Q6IHAgKyAoZi9xfHwwKSwgcmF3UHJpY2U6IHAsIGZlZXM6IGYsIG5vdGU6IG5vdGV8fCIiLCB0YXJnZXRQY3Q6ICh0YXJnZXRQY3QhPT11bmRlZmluZWQgJiYgdGFyZ2V0UGN0IT09IiIgPyBOdW1iZXIodGFyZ2V0UGN0KSA6IG51bGwpLCB0YXJnZXRQcmljZTogKHRhcmdldFByaWNlIT09dW5kZWZpbmVkICYmIHRhcmdldFByaWNlIT09IiIgPyBOdW1iZXIodGFyZ2V0UHJpY2UpIDogbnVsbCksIGJ1eVRhcmdldFBjdDogKGJ1eVRhcmdldFBjdCE9PXVuZGVmaW5lZCAmJiBidXlUYXJnZXRQY3QhPT0iIiA/IE51bWJlcihidXlUYXJnZXRQY3QpIDogbnVsbCksIGJ1eVRhcmdldFByaWNlOiAoYnV5VGFyZ2V0UHJpY2UhPT11bmRlZmluZWQgJiYgYnV5VGFyZ2V0UHJpY2UhPT0iIiA/IE51bWJlcihidXlUYXJnZXRQcmljZSkgOiBudWxsKSB9OwogICAgcGYuaG9sZGluZ3NbdGlja2VyXS5sb3RzLnB1c2gobG90KTsKICAgIHBmLnRyYW5zYWN0aW9ucy51bnNoaWZ0KHsgaWQ6aWQoKSwgdHlwZToiYnV5IiwgZGF0ZTogZGF0ZSB8fCB0b2RheSgpLCB0aWNrZXIsIHF0eTpxLCBwcmljZTpwLCBmZWVzOmYsIG5vdGU6IG5vdGUsIGxvdElkOiBsb3QubG90SWQsIHRhcmdldFBjdDogbG90LnRhcmdldFBjdCwgdGFyZ2V0UHJpY2U6IGxvdC50YXJnZXRQcmljZSwgYnV5VGFyZ2V0UGN0OiBsb3QuYnV5VGFyZ2V0UGN0LCBidXlUYXJnZXRQcmljZTogbG90LmJ1eVRhcmdldFByaWNlIH0pOwogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB0cnkgeyByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogIH0KCiAgZnVuY3Rpb24gc2VsbChwZklkLCB7dGlja2VyLCBkYXRlLCBzZWxsUHJpY2UsIGZlZXMsIGFsbG9jYXRpb25zLCBub3RlfSl7CiAgdHJ5eyBwdXNoVW5kbyh7bGFiZWw6IlNwcnplZGFcdTAxN2MiLCBraW5kOid0eCd9KTsgfWNhdGNoKF8pe30KCiAgICBjb25zdCBwZiA9IGdldFBmKHBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIHRpY2tlciA9ICh0aWNrZXJ8fCIiKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgIGNvbnN0IHBTZWxsID0gTnVtYmVyKHNlbGxQcmljZSl8fDA7CiAgICBjb25zdCBmID0gTnVtYmVyKGZlZXMpfHwwOwogICAgaWYoIXRpY2tlciB8fCBwU2VsbDw9MCl7IHJldHVybiBhbGVydCgiVXp1cGXFgm5paiBwb3ByYXduaWU6IHRpY2tlciBpIGNlbsSZIHNwcnplZGHFvHkuIik7IH0KICAgIGNvbnN0IGJvb2sgPSBwZi5ob2xkaW5nc1t0aWNrZXJdOyBpZighYm9vayl7IHJldHVybiBhbGVydCgiQnJhayBwb3p5Y2ppIG5hIHRlbiB0aWNrZXIuIik7IH0KICAgIC8vIFZhbGlkYXRlIGFsbG9jYXRpb25zCiAgICBsZXQgdG90YWxRdHkgPSAwOwogICAgYWxsb2NhdGlvbnMgPSBhbGxvY2F0aW9ucy5maWx0ZXIoYT0+YS5xdHk+MCk7CiAgICBpZihhbGxvY2F0aW9ucy5sZW5ndGg9PT0wKXsgcmV0dXJuIGFsZXJ0KCJXeWJpZXJ6IGlsb8WbxIcgZG8gc3ByemVkYcW8eSB3IGNvIG5ham1uaWVqIGplZG5laiBwYXJ0aWkuIik7IH0KICAgIGZvcihjb25zdCBhIG9mIGFsbG9jYXRpb25zKXsgdG90YWxRdHkgKz0gYS5xdHk7IH0KICAgIC8vIFByb2NlZWRzIGFuZCBQL0wKICAgIGNvbnN0IHByb2NlZWRzID0gdG90YWxRdHkgKiBwU2VsbDsKICAgIGxldCBncm9zc1BMID0gMDsKICAgIGZvcihjb25zdCBhIG9mIGFsbG9jYXRpb25zKXsKICAgICAgY29uc3QgbG90ID0gYm9vay5sb3RzLmZpbmQobD0+bC5sb3RJZD09PWEubG90SWQpOwogICAgICBpZighbG90KSByZXR1cm4gYWxlcnQoIk5pZSB6bmFsZXppb25vIHBhcnRpaS4iKTsKICAgICAgaWYoYS5xdHkgPiBsb3QucXR5KXsgcmV0dXJuIGFsZXJ0KCJTcHJ6ZWRhd2FuYSBpbG/Fm8SHIHByemVrcmFjemEgaWxvxZvEhyB3IHBhcnRpaS4iKTsgfQogICAgICBncm9zc1BMICs9IGEucXR5ICogKHBTZWxsIC0gbG90LnVuaXRDb3N0KTsKICAgIH0KICAgIGdyb3NzUEwgLT0gZjsKICAgIGNvbnN0IHRheCA9IGdyb3NzUEw+MCA/IGdyb3NzUEwgKiAoREIuc2V0dGluZ3MudGF4UmF0ZSB8fCAwLjE5KSA6IDA7CiAgICBjb25zdCBuZXRQTCA9IGdyb3NzUEwgLSB0YXg7CiAgICAvLyBBcHBseSBpbnZlbnRvcnkgY2hhbmdlcwogICAgZm9yKGNvbnN0IGEgb2YgYWxsb2NhdGlvbnMpewogICAgICBjb25zdCBsb3QgPSBib29rLmxvdHMuZmluZChsPT5sLmxvdElkPT09YS5sb3RJZCk7CiAgICAgIGxvdC5xdHkgLT0gYS5xdHk7CiAgICB9CiAgICBib29rLmxvdHMgPSBib29rLmxvdHMuZmlsdGVyKGw9PmwucXR5PjAuMDAwMDAwMSk7CiAgICAvLyBBZGQgY2FzaAogICAgcGYuY2FzaCArPSAocHJvY2VlZHMgLSBmKTsKICAgIC8vIFJlY29yZCBUWAogICAgcGYudHJhbnNhY3Rpb25zLnVuc2hpZnQoewogICAgICBpZDppZCgpLCB0eXBlOiJzZWxsIiwgZGF0ZTogZGF0ZSB8fCB0b2RheSgpLCB0aWNrZXIsCiAgICAgIHF0eTogdG90YWxRdHksIHByaWNlOiBwU2VsbCwgZmVlczogZiwKICAgICAgcHJvY2VlZHMsIGdyb3NzUEwsIHRheCwgbmV0UEwsCiAgICAgIGxvdExpbmtzOiBhbGxvY2F0aW9ucy5tYXAoYT0+KHsgbG90SWQ6YS5sb3RJZCwgcXR5OmEucXR5IH0pKSwKICAgICAgbm90ZQogICAgfSk7CiAgICAvLyBDbGVhbnVwIGVtcHR5IHRpY2tlcgogICAgaWYoYm9vay5sb3RzLmxlbmd0aD09PTApeyBkZWxldGUgcGYuaG9sZGluZ3NbdGlja2VyXTsgfQogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB0cnkgeyByZWJ1aWxkUG9ydGZvbGlvKHBmKTsgfSBjYXRjaChfKSB7fSBzYXZlKCk7IHJlbmRlcigpOwogIH0KCiAgLy8gPT09IFhUQiBJTVBPUlRFUiB2MTogWExTWCAtPiBrb25maWd1cmF0b3IgQlVZL1NFTEwgPT09CiAgbGV0IF9feHRiSW1wb3J0UG9ydGZvbGlvSWQgPSBudWxsOwogIGxldCBfX3h0YkFnZ3JlZ2F0ZWQgPSBudWxsOwogIGxldCBfX3h0YkltcG9ydE1vZGFsID0gbnVsbDsKCiAgZnVuY3Rpb24gc3RhcnRYdGJJbXBvcnRGb3JQb3J0Zm9saW8ocGZJZCl7CiAgICBfX3h0YkltcG9ydFBvcnRmb2xpb0lkID0gcGZJZDsKICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInh0YkltcG9ydEZpbGUiKTsKICAgIGlmKCFpbnB1dCl7CiAgICAgIGFsZXJ0KCJCcmFrIHBvbGEgcGxpa3UgWFRCIHcgSFRNTC4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaW5wdXQudmFsdWUgPSAiIjsKICAgIGlucHV0LmNsaWNrKCk7CiAgfQoKICBmdW5jdGlvbiBfX3h0YkV4Y2VsRGF0ZVRvSnModmFsdWUpewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgY29uc3QgZXBvY2ggPSBuZXcgRGF0ZShEYXRlLlVUQygxODk5LCAxMSwgMzApKTsKICAgICAgY29uc3QgbXMgPSB2YWx1ZSAqIDI0ICogNjAgKiA2MCAqIDEwMDA7CiAgICAgIHJldHVybiBuZXcgRGF0ZShlcG9jaC5nZXRUaW1lKCkgKyBtcyk7CiAgICB9CiAgICByZXR1cm4gdmFsdWUgfHwgbnVsbDsKICB9CgogIGZ1bmN0aW9uIF9feHRiUGFyc2VOdW1iZXIodmFsKXsKICAgIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgcmV0dXJuIHZhbDsKICAgIGlmICh2YWwgPT0gbnVsbCkgcmV0dXJuIE5hTjsKICAgIGxldCBzID0gU3RyaW5nKHZhbCkucmVwbGFjZSgvXFxzKy9nLCAiIik7CiAgICBzID0gcy5yZXBsYWNlKCIsIiwgIi4iKTsKICAgIGNvbnN0IG4gPSBOdW1iZXIocyk7CiAgICByZXR1cm4gaXNOYU4obikgPyBOYU4gOiBuOwogIH0KCiAgZnVuY3Rpb24gX194dGJEZXRlY3RIZWFkZXJSb3cocm93cywgcmVxdWlyZWRDb2xzKXsKICAgIGZvcihsZXQgaT0wO2k8cm93cy5sZW5ndGg7aSsrKXsKICAgICAgY29uc3QgciA9IHJvd3NbaV0gfHwgW107CiAgICAgIGxldCBvayA9IHRydWU7CiAgICAgIGZvcihjb25zdCBuYW1lIG9mIHJlcXVpcmVkQ29scyl7CiAgICAgICAgaWYoIXIuaW5jbHVkZXMobmFtZSkpeyBvayA9IGZhbHNlOyBicmVhazsgfQogICAgICB9CiAgICAgIGlmKG9rKSByZXR1cm4gaTsKICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIGZ1bmN0aW9uIF9feHRiQnVpbGRJbmRleE1hcChoZWFkZXJSb3cpewogICAgY29uc3QgbWFwID0ge307CiAgICBoZWFkZXJSb3cuZm9yRWFjaCgobmFtZSwgaWR4KT0+ewogICAgICBpZih0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgJiYgbmFtZS50cmltKCkpewogICAgICAgIG1hcFtuYW1lLnRyaW0oKV0gPSBpZHg7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG1hcDsKICB9CgogIGZ1bmN0aW9uIF9feHRiTm9ybWFsaXplU3ltYm9sKHN5bSl7CiAgICBpZighc3ltKSByZXR1cm4geyBmdWxsOiIiLCBiYXNlOiIiIH07CiAgICBjb25zdCBzID0gU3RyaW5nKHN5bSkudHJpbSgpOwogICAgY29uc3QgcGFydHMgPSBzLnNwbGl0KCIuIik7CiAgICByZXR1cm4geyBmdWxsOnMsIGJhc2U6cGFydHNbMF0gfTsKICB9CgogIGZ1bmN0aW9uIF9feHRiUGFyc2VDYXNoU2hlZXQoc2hlZXQpewogICAgY29uc3Qgb3V0ID0gW107CiAgICBpZighc2hlZXQpIHJldHVybiBvdXQ7CiAgICBjb25zdCBhcnJheSA9IFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCwge2hlYWRlcjoxLCBkZWZ2YWw6bnVsbCwgcmF3OnRydWV9KTsKICAgIGlmKCFhcnJheSB8fCAhYXJyYXkubGVuZ3RoKSByZXR1cm4gb3V0OwoKICAgIGNvbnN0IGhlYWRlcklkeCA9IF9feHRiRGV0ZWN0SGVhZGVyUm93KGFycmF5LCBbIklEIiwiVHlwZSIsIlRpbWUiLCJDb21tZW50IiwiU3ltYm9sIiwiQW1vdW50Il0pOwogICAgaWYoaGVhZGVySWR4ID09PSAtMSkgcmV0dXJuIG91dDsKICAgIGNvbnN0IGhlYWRlciA9IGFycmF5W2hlYWRlcklkeF07CiAgICBjb25zdCBpZHggPSBfX3h0YkJ1aWxkSW5kZXhNYXAoaGVhZGVyKTsKCiAgICBmb3IobGV0IHI9aGVhZGVySWR4KzE7cjxhcnJheS5sZW5ndGg7cisrKXsKICAgICAgY29uc3Qgcm93ID0gYXJyYXlbcl0gfHwgW107CiAgICAgIGNvbnN0IG1heWJlVG90YWwgPSByb3dbaWR4WyJJRCJdXTsKICAgICAgaWYobWF5YmVUb3RhbCA9PT0gIlRvdGFsIikgYnJlYWs7CgogICAgICBjb25zdCB0eXBlID0gcm93W2lkeFsiVHlwZSJdXTsKICAgICAgY29uc3QgdGltZSA9IHJvd1tpZHhbIlRpbWUiXV07CiAgICAgIGNvbnN0IGNvbW1lbnQgPSByb3dbaWR4WyJDb21tZW50Il1dOwogICAgICBjb25zdCBzeW1ib2wgPSByb3dbaWR4WyJTeW1ib2wiXV07CiAgICAgIGNvbnN0IGFtb3VudCA9IHJvd1tpZHhbIkFtb3VudCJdXTsKCiAgICAgIGlmKCF0eXBlIHx8ICF0aW1lIHx8ICFjb21tZW50IHx8ICFzeW1ib2wgfHwgYW1vdW50ID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgY29uc3QgdCA9IFN0cmluZyh0eXBlKS50b1VwcGVyQ2FzZSgpOwogICAgICBpZiAodCAhPT0gIlNUT0NLIFBVUkNIQVNFIiAmJiB0ICE9PSAiU1RPQ0sgU0FMRSIpIGNvbnRpbnVlOwoKICAgICAgY29uc3Qgbm9ybSA9IF9feHRiTm9ybWFsaXplU3ltYm9sKHN5bWJvbCk7CgogICAgICBjb25zdCBtID0gU3RyaW5nKGNvbW1lbnQpLm1hdGNoKC8oT1BFTnxDTE9TRSlccytCVVlccysoWzAtOS4sXSspXC8oWzAtOS4sXSspXHMrQFxzKyhbMC05LixdKykvaSk7CiAgICAgIGlmKCFtKSBjb250aW51ZTsKICAgICAgY29uc3QgcXR5ID0gX194dGJQYXJzZU51bWJlcihtWzJdKTsKICAgICAgY29uc3QgcHJpY2UgPSBfX3h0YlBhcnNlTnVtYmVyKG1bNF0pOwogICAgICBpZighcXR5IHx8ICFwcmljZSkgY29udGludWU7CgogICAgICBjb25zdCBzaWRlID0gKHQgPT09ICJTVE9DSyBQVVJDSEFTRSIpID8gIkJVWSIgOiAiU0VMTCI7CgogICAgICBvdXQucHVzaCh7CiAgICAgICAgc3ltYm9sRnVsbDogbm9ybS5mdWxsLAogICAgICAgIHN5bWJvbDogbm9ybS5iYXNlLAogICAgICAgIHNpZGU6IHNpZGUsCiAgICAgICAgcXR5OiBxdHksCiAgICAgICAgcHJpY2U6IHByaWNlLAogICAgICAgIHRpbWU6IF9feHRiRXhjZWxEYXRlVG9Kcyh0aW1lKSwKICAgICAgICBzaGVldDogIkNBU0giLAogICAgICAgIHJhd1R5cGU6IHR5cGUsCiAgICAgICAgY29tbWVudDogU3RyaW5nKGNvbW1lbnR8fCIiKQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBvdXQ7CiAgfQoKICBmdW5jdGlvbiBfX3h0YkJ1aWxkQWdncmVnYXRlZChyb3dzKXsKICAgIGNvbnN0IGFnZyA9IHt9OwogICAgcm93cy5mb3JFYWNoKHIgPT4gewogICAgICBjb25zdCB0aWNrZXIgPSAoci5zeW1ib2wgfHwgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGlmKCF0aWNrZXIpIHJldHVybjsKICAgICAgaWYoIWFnZ1t0aWNrZXJdKXsKICAgICAgICBhZ2dbdGlja2VyXSA9IHsKICAgICAgICAgIHRpY2tlciwKICAgICAgICAgIHN5bWJvbEZ1bGw6IHIuc3ltYm9sRnVsbCB8fCB0aWNrZXIsCiAgICAgICAgICBidXlzOiBbXSwKICAgICAgICAgIHNlbGxzOiBbXSwKICAgICAgICAgIGJ1eVRvdGFsUXR5OiAwLAogICAgICAgICAgYnV5VG90YWxDYXNoOiAwLAogICAgICAgICAgYnV5Rmlyc3REYXRlOiBudWxsLAogICAgICAgICAgc2VsbFRvdGFsUXR5OiAwLAogICAgICAgICAgc2VsbFRvdGFsQ2FzaDogMCwKICAgICAgICAgIHNlbGxGaXJzdERhdGU6IG51bGwKICAgICAgICB9OwogICAgICB9CiAgICAgIGNvbnN0IGVudHJ5ID0gYWdnW3RpY2tlcl07CiAgICAgIGlmKHIuc2lkZSA9PT0gIkJVWSIpewogICAgICAgIGVudHJ5LmJ1eXMucHVzaChyKTsKICAgICAgICBlbnRyeS5idXlUb3RhbFF0eSArPSByLnF0eTsKICAgICAgICBlbnRyeS5idXlUb3RhbENhc2ggKz0gci5xdHkgKiByLnByaWNlOwogICAgICAgIGNvbnN0IGR0ID0gci50aW1lIGluc3RhbmNlb2YgRGF0ZSA/IHIudGltZSA6IF9feHRiRXhjZWxEYXRlVG9KcyhyLnRpbWUpOwogICAgICAgIGlmKGR0ICYmICghZW50cnkuYnV5Rmlyc3REYXRlIHx8IGR0IDwgZW50cnkuYnV5Rmlyc3REYXRlKSkgZW50cnkuYnV5Rmlyc3REYXRlID0gZHQ7CiAgICAgIH1lbHNlIGlmKHIuc2lkZSA9PT0gIlNFTEwiKXsKICAgICAgICBlbnRyeS5zZWxscy5wdXNoKHIpOwogICAgICAgIGVudHJ5LnNlbGxUb3RhbFF0eSArPSByLnF0eTsKICAgICAgICBlbnRyeS5zZWxsVG90YWxDYXNoICs9IHIucXR5ICogci5wcmljZTsKICAgICAgICBjb25zdCBkdCA9IHIudGltZSBpbnN0YW5jZW9mIERhdGUgPyByLnRpbWUgOiBfX3h0YkV4Y2VsRGF0ZVRvSnMoci50aW1lKTsKICAgICAgICBpZihkdCAmJiAoIWVudHJ5LnNlbGxGaXJzdERhdGUgfHwgZHQgPCBlbnRyeS5zZWxsRmlyc3REYXRlKSkgZW50cnkuc2VsbEZpcnN0RGF0ZSA9IGR0OwogICAgICB9CiAgICB9KTsKCiAgICBPYmplY3Qua2V5cyhhZ2cpLmZvckVhY2godCA9PiB7CiAgICAgIGNvbnN0IGUgPSBhZ2dbdF07CiAgICAgIGUuYnV5QXZnUHJpY2UgPSBlLmJ1eVRvdGFsUXR5ID4gMCA/IChlLmJ1eVRvdGFsQ2FzaCAvIGUuYnV5VG90YWxRdHkpIDogMDsKICAgICAgZS5zZWxsQXZnUHJpY2UgPSBlLnNlbGxUb3RhbFF0eSA+IDAgPyAoZS5zZWxsVG90YWxDYXNoIC8gZS5zZWxsVG90YWxRdHkpIDogMDsKICAgIH0pOwogICAgcmV0dXJuIGFnZzsKICB9CgogIGZ1bmN0aW9uIF9feHRiRW5zdXJlSW1wb3J0TW9kYWwoKXsKICAgIGlmKF9feHRiSW1wb3J0TW9kYWwpIHJldHVybiBfX3h0YkltcG9ydE1vZGFsOwogICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgd3JhcC5pZCA9ICJ4dGJJbXBvcnRNb2RhbCI7CiAgICB3cmFwLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKICAgIHdyYXAuc3R5bGUuaW5zZXQgPSAiMCI7CiAgICB3cmFwLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB3cmFwLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgIHdyYXAuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAiY2VudGVyIjsKICAgIHdyYXAuc3R5bGUuYmFja2dyb3VuZCA9ICJyZ2JhKDE1LDIzLDQyLDAuOCkiOwogICAgd3JhcC5zdHlsZS56SW5kZXggPSAiOTk5OSI7CgogICAgY29uc3QgY2FyZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY2FyZC5zdHlsZS5iYWNrZ3JvdW5kID0gIiMwMjA2MTciOwogICAgY2FyZC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMTJweCI7CiAgICBjYXJkLnN0eWxlLmJvcmRlciA9ICIxcHggc29saWQgcmdiYSgxNDgsMTYzLDE4NCwwLjYpIjsKICAgIGNhcmQuc3R5bGUucGFkZGluZyA9ICIxMnB4IDE0cHgiOwogICAgY2FyZC5zdHlsZS5tYXhXaWR0aCA9ICI3ODBweCI7CiAgICBjYXJkLnN0eWxlLndpZHRoID0gIjEwMCUiOwogICAgY2FyZC5zdHlsZS5tYXhIZWlnaHQgPSAiODB2aCI7CiAgICBjYXJkLnN0eWxlLmJveFNoYWRvdyA9ICIwIDIycHggNjBweCByZ2JhKDE1LDIzLDQyLDAuOSkiOwogICAgY2FyZC5zdHlsZS5mb250U2l6ZSA9ICIxMnB4IjsKICAgIGNhcmQuc3R5bGUuY29sb3IgPSAiI2U1ZTdlYiI7CiAgICBjYXJkLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICBjYXJkLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAiY29sdW1uIjsKICAgIGNhcmQuc3R5bGUuZ2FwID0gIjhweCI7CgogICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHRpdGxlLmlkID0gInh0YkltcG9ydFRpdGxlIjsKICAgIHRpdGxlLnN0eWxlLmZvbnRXZWlnaHQgPSAiNjAwIjsKICAgIHRpdGxlLnN0eWxlLmZvbnRTaXplID0gIjEzcHgiOwogICAgY2FyZC5hcHBlbmRDaGlsZCh0aXRsZSk7CgogICAgY29uc3QgZGVzYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGVzYy50ZXh0Q29udGVudCA9ICJXeWJpZXJ6LCBrdMOzcmUgc3DDs8WCa2kgeiBwbGlrdSBYVEIgY2hjZXN6IHphaW1wb3J0b3dhxIcuIEJVWSB6b3N0YW7EhSBkb2RhbmUgamFrbyBub3dlIHpha3VweSwgU0VMTCBtb8W8ZXN6IHBvd2nEhXphxIcgeiB3eWJyYW55bWkgcGFydGlhbWkuIjsKICAgIGRlc2Muc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CiAgICBkZXNjLnN0eWxlLmNvbG9yID0gIiM5NGEzYjgiOwogICAgY2FyZC5hcHBlbmRDaGlsZChkZXNjKTsKCiAgICBjb25zdCBib2R5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBib2R5LmlkID0gInh0YkltcG9ydEJvZHkiOwogICAgYm9keS5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgYm9keS5zdHlsZS5mbGV4RGlyZWN0aW9uID0gImNvbHVtbiI7CiAgICBib2R5LnN0eWxlLmdhcCA9ICI2cHgiOwogICAgYm9keS5zdHlsZS5vdmVyZmxvdyA9ICJhdXRvIjsKICAgIGJvZHkuc3R5bGUucGFkZGluZyA9ICI0cHggMCI7CiAgICBjYXJkLmFwcGVuZENoaWxkKGJvZHkpOwoKICAgIGNvbnN0IGZvb3RlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZm9vdGVyLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICBmb290ZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAiZmxleC1lbmQiOwogICAgZm9vdGVyLnN0eWxlLmdhcCA9ICI4cHgiOwogICAgZm9vdGVyLnN0eWxlLm1hcmdpblRvcCA9ICI2cHgiOwoKICAgIGNvbnN0IGNhbmNlbEJ0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgY2FuY2VsQnRuLnR5cGUgPSAiYnV0dG9uIjsKICAgIGNhbmNlbEJ0bi50ZXh0Q29udGVudCA9ICJBbnVsdWoiOwogICAgY2FuY2VsQnRuLnN0eWxlLnBhZGRpbmcgPSAiNHB4IDEwcHgiOwogICAgY2FuY2VsQnRuLnN0eWxlLmJvcmRlclJhZGl1cyA9ICI5OTlweCI7CiAgICBjYW5jZWxCdG4uc3R5bGUuYm9yZGVyID0gIjFweCBzb2xpZCByZ2JhKDE0OCwxNjMsMTg0LDAuNikiOwogICAgY2FuY2VsQnRuLnN0eWxlLmJhY2tncm91bmQgPSAidHJhbnNwYXJlbnQiOwogICAgY2FuY2VsQnRuLnN0eWxlLmNvbG9yID0gIiNlNWU3ZWIiOwogICAgY2FuY2VsQnRuLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgY2FuY2VsQnRuLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgIGNhbmNlbEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uKCl7CiAgICAgIHdyYXAuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgX194dGJBZ2dyZWdhdGVkID0gbnVsbDsKICAgICAgX194dGJJbXBvcnRQb3J0Zm9saW9JZCA9IG51bGw7CiAgICB9KTsKCiAgICBjb25zdCBpbXBvcnRCdG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgIGltcG9ydEJ0bi50eXBlID0gImJ1dHRvbiI7CiAgICBpbXBvcnRCdG4uaWQgPSAieHRiSW1wb3J0Q29uZmlybSI7CiAgICBpbXBvcnRCdG4udGV4dENvbnRlbnQgPSAiSW1wb3J0dWogemF6bmFjem9uZSI7CiAgICBpbXBvcnRCdG4uc3R5bGUucGFkZGluZyA9ICI0cHggMTBweCI7CiAgICBpbXBvcnRCdG4uc3R5bGUuYm9yZGVyUmFkaXVzID0gIjk5OXB4IjsKICAgIGltcG9ydEJ0bi5zdHlsZS5ib3JkZXIgPSAibm9uZSI7CiAgICBpbXBvcnRCdG4uc3R5bGUuYmFja2dyb3VuZCA9ICIjMjJjNTVlIjsKICAgIGltcG9ydEJ0bi5zdHlsZS5jb2xvciA9ICIjMDIwNjE3IjsKICAgIGltcG9ydEJ0bi5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgIGltcG9ydEJ0bi5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICBpbXBvcnRCdG4uc3R5bGUuZm9udFdlaWdodCA9ICI2MDAiOwoKICAgIGZvb3Rlci5hcHBlbmRDaGlsZChjYW5jZWxCdG4pOwogICAgZm9vdGVyLmFwcGVuZENoaWxkKGltcG9ydEJ0bik7CiAgICBjYXJkLmFwcGVuZENoaWxkKGZvb3Rlcik7CgogICAgd3JhcC5hcHBlbmRDaGlsZChjYXJkKTsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQod3JhcCk7CgogICAgaW1wb3J0QnRuLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgX194dGJQZXJmb3JtSW1wb3J0KTsKCiAgICBfX3h0YkltcG9ydE1vZGFsID0gd3JhcDsKICAgIHJldHVybiB3cmFwOwogIH0KCiAgZnVuY3Rpb24gX194dGJGb3JtYXREYXRlKGQpewogICAgaWYoIShkIGluc3RhbmNlb2YgRGF0ZSkpIHJldHVybiAiIjsKICAgIGNvbnN0IHkgPSBkLmdldEZ1bGxZZWFyKCk7CiAgICBjb25zdCBtID0gU3RyaW5nKGQuZ2V0TW9udGgoKSsxKS5wYWRTdGFydCgyLCIwIik7CiAgICBjb25zdCBkYSA9IFN0cmluZyhkLmdldERhdGUoKSkucGFkU3RhcnQoMiwiMCIpOwogICAgcmV0dXJuIHkgKyAiLSIgKyBtICsgIi0iICsgZGE7CiAgfQoKICBmdW5jdGlvbiBfX3h0YlJlbmRlckltcG9ydE1vZGFsKHBmSWQsIGFnZ3JlZ2F0ZWQpewogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsKICAgIGNvbnN0IG1vZGFsID0gX194dGJFbnN1cmVJbXBvcnRNb2RhbCgpOwogICAgY29uc3QgdGl0bGUgPSBtb2RhbC5xdWVyeVNlbGVjdG9yKCIjeHRiSW1wb3J0VGl0bGUiKTsKICAgIGNvbnN0IGJvZHkgPSBtb2RhbC5xdWVyeVNlbGVjdG9yKCIjeHRiSW1wb3J0Qm9keSIpOwogICAgaWYodGl0bGUpIHRpdGxlLnRleHRDb250ZW50ID0gIkltcG9ydCB6IFhUQiBkbyBwb3J0ZmVsYTogIiArIChwZiAmJiBwZi5uYW1lID8gcGYubmFtZSA6IHBmSWQpOwogICAgYm9keS5pbm5lckhUTUwgPSAiIjsKCiAgICBjb25zdCB0aWNrZXJzID0gT2JqZWN0LmtleXMoYWdncmVnYXRlZCkuc29ydCgpOwogICAgaWYoIXRpY2tlcnMubGVuZ3RoKXsKICAgICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBpbmZvLnRleHRDb250ZW50ID0gIkJyYWsgdHJhbnNha2NqaSBCVVkvU0VMTCBkbyB6YWltcG9ydG93YW5pYS4iOwogICAgICBpbmZvLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgICBpbmZvLnN0eWxlLmNvbG9yID0gIiM5NGEzYjgiOwogICAgICBib2R5LmFwcGVuZENoaWxkKGluZm8pOwogICAgICByZXR1cm47CiAgICB9CgogICAgdGlja2Vycy5mb3JFYWNoKHRpY2tlciA9PiB7CiAgICAgIGNvbnN0IGVudHJ5ID0gYWdncmVnYXRlZFt0aWNrZXJdOwogICAgICBjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgcm93LmNsYXNzTmFtZSA9ICJ4dGItaW1wb3J0LXJvdyI7CiAgICAgIHJvdy5kYXRhc2V0LnRpY2tlciA9IHRpY2tlcjsKICAgICAgcm93LnN0eWxlLmJvcmRlciA9ICIxcHggc29saWQgcmdiYSg1MSw2NSw4NSwwLjkpIjsKICAgICAgcm93LnN0eWxlLmJvcmRlclJhZGl1cyA9ICI4cHgiOwogICAgICByb3cuc3R5bGUucGFkZGluZyA9ICI2cHggOHB4IjsKICAgICAgcm93LnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgIHJvdy5zdHlsZS5mbGV4RGlyZWN0aW9uID0gImNvbHVtbiI7CiAgICAgIHJvdy5zdHlsZS5nYXAgPSAiNHB4IjsKICAgICAgcm93LnN0eWxlLmJhY2tncm91bmQgPSAicmdiYSgxNSwyMyw0MiwwLjcpIjsKCiAgICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBoZWFkZXIuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgICAgaGVhZGVyLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gInNwYWNlLWJldHdlZW4iOwogICAgICBoZWFkZXIuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwoKICAgICAgY29uc3QgdGl0bGVEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdGl0bGVEaXYudGV4dENvbnRlbnQgPSAoZW50cnkuc3ltYm9sRnVsbCB8fCB0aWNrZXIpOwogICAgICB0aXRsZURpdi5zdHlsZS5mb250V2VpZ2h0ID0gIjYwMCI7CiAgICAgIHRpdGxlRGl2LnN0eWxlLmZvbnRTaXplID0gIjEycHgiOwoKICAgICAgaGVhZGVyLmFwcGVuZENoaWxkKHRpdGxlRGl2KTsKICAgICAgcm93LmFwcGVuZENoaWxkKGhlYWRlcik7CgogICAgICBjb25zdCBjb2xzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGNvbHMuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgICAgY29scy5zdHlsZS5nYXAgPSAiOHB4IjsKICAgICAgY29scy5zdHlsZS5mbGV4V3JhcCA9ICJ3cmFwIjsKCiAgICAgIC8vIEJVWSBjb2x1bW4KICAgICAgY29uc3QgYnV5Q29sID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGJ1eUNvbC5zdHlsZS5mbGV4ID0gIjEgMSAyNjBweCI7CiAgICAgIGJ1eUNvbC5zdHlsZS5taW5XaWR0aCA9ICIwIjsKCiAgICAgIGlmKGVudHJ5LmJ1eVRvdGFsUXR5ID4gMCl7CiAgICAgICAgY29uc3QgbGJsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKICAgICAgICBsYmwuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgICAgICBsYmwuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgICAgIGxibC5zdHlsZS5nYXAgPSAiNHB4IjsKICAgICAgICBjb25zdCBjYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgY2IudHlwZSA9ICJjaGVja2JveCI7CiAgICAgICAgY2IuY2xhc3NOYW1lID0gInh0Yi1pbXBvcnQtYnV5LWNoZWNrYm94IjsKICAgICAgICBjYi5jaGVja2VkID0gdHJ1ZTsKICAgICAgICBsYmwuYXBwZW5kQ2hpbGQoY2IpOwoKICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICAgIHNwYW4udGV4dENvbnRlbnQgPSAiWmFpbXBvcnR1aiBCVVkiOwogICAgICAgIGxibC5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICBidXlDb2wuYXBwZW5kQ2hpbGQobGJsKTsKCiAgICAgICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGluZm8uc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CiAgICAgICAgaW5mby5zdHlsZS5jb2xvciA9ICIjY2JkNWY1IjsKICAgICAgICBjb25zdCBhdmcgPSBlbnRyeS5idXlBdmdQcmljZSB8fCAwOwogICAgICAgIGluZm8udGV4dENvbnRlbnQgPSAiUXR5OiAiICsgZW50cnkuYnV5VG90YWxRdHkudG9GaXhlZCg0KSArICIgfCDFmnIuIGNlbmE6ICIgKyBhdmcudG9GaXhlZCg0KSArICIgfCBUcmFuc2FrY2ppOiAiICsgZW50cnkuYnV5cy5sZW5ndGggKyAoZW50cnkuYnV5Rmlyc3REYXRlID8gIiB8IG9kOiAiICsgX194dGJGb3JtYXREYXRlKGVudHJ5LmJ1eUZpcnN0RGF0ZSkgOiAiIik7CiAgICAgICAgYnV5Q29sLmFwcGVuZENoaWxkKGluZm8pOwogICAgICB9ZWxzZXsKICAgICAgICBjb25zdCBpbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgaW5mby5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgICAgICBpbmZvLnN0eWxlLmNvbG9yID0gIiM2NDc0OGIiOwogICAgICAgIGluZm8udGV4dENvbnRlbnQgPSAiQnJhayB0cmFuc2FrY2ppIEJVWSBkbGEgdGVqIHNww7PFgmtpIHcgcGxpa3UuIjsKICAgICAgICBidXlDb2wuYXBwZW5kQ2hpbGQoaW5mbyk7CiAgICAgIH0KCiAgICAgIC8vIFNFTEwgY29sdW1uCiAgICAgIGNvbnN0IHNlbGxDb2wgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgc2VsbENvbC5zdHlsZS5mbGV4ID0gIjEgMSAyNjBweCI7CiAgICAgIHNlbGxDb2wuc3R5bGUubWluV2lkdGggPSAiMCI7CgogICAgICBpZihlbnRyeS5zZWxsVG90YWxRdHkgPiAwKXsKICAgICAgICBjb25zdCB0b3AgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICB0b3Auc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgICAgICB0b3Auc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgICAgIHRvcC5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICJzcGFjZS1iZXR3ZWVuIjsKICAgICAgICB0b3Auc3R5bGUuZ2FwID0gIjRweCI7CgogICAgICAgIGNvbnN0IGxibCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICAgICAgbGJsLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgICAgbGJsLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgICAgICBsYmwuc3R5bGUuZ2FwID0gIjRweCI7CiAgICAgICAgY29uc3QgY2IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgIGNiLnR5cGUgPSAiY2hlY2tib3giOwogICAgICAgIGNiLmNsYXNzTmFtZSA9ICJ4dGItaW1wb3J0LXNlbGwtY2hlY2tib3giOwogICAgICAgIGNiLmNoZWNrZWQgPSB0cnVlOwogICAgICAgIGxibC5hcHBlbmRDaGlsZChjYik7CiAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgICBzcGFuLnRleHRDb250ZW50ID0gIlphaW1wb3J0dWogU0VMTCI7CiAgICAgICAgbGJsLmFwcGVuZENoaWxkKHNwYW4pOwogICAgICAgIHRvcC5hcHBlbmRDaGlsZChsYmwpOwoKICAgICAgICBjb25zdCBsb3RzQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgbG90c0J0bi50eXBlID0gImJ1dHRvbiI7CiAgICAgICAgbG90c0J0bi50ZXh0Q29udGVudCA9ICJQb2thxbwgcGFydGllIjsKICAgICAgICBsb3RzQnRuLmNsYXNzTmFtZSA9ICJ4dGItc2VsbC1sb3RzLXRvZ2dsZSI7CiAgICAgICAgbG90c0J0bi5kYXRhc2V0LnRpY2tlciA9IHRpY2tlcjsKICAgICAgICBsb3RzQnRuLnN0eWxlLnBhZGRpbmcgPSAiMnB4IDhweCI7CiAgICAgICAgbG90c0J0bi5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiOTk5cHgiOwogICAgICAgIGxvdHNCdG4uc3R5bGUuYm9yZGVyID0gIjFweCBzb2xpZCByZ2JhKDE0OCwxNjMsMTg0LDAuNykiOwogICAgICAgIGxvdHNCdG4uc3R5bGUuYmFja2dyb3VuZCA9ICJ0cmFuc3BhcmVudCI7CiAgICAgICAgbG90c0J0bi5zdHlsZS5jb2xvciA9ICIjZTVlN2ViIjsKICAgICAgICBsb3RzQnRuLnN0eWxlLmZvbnRTaXplID0gIjEwcHgiOwogICAgICAgIGxvdHNCdG4uc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgICAgIHRvcC5hcHBlbmRDaGlsZChsb3RzQnRuKTsKCiAgICAgICAgc2VsbENvbC5hcHBlbmRDaGlsZCh0b3ApOwoKICAgICAgICBjb25zdCBpbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgaW5mby5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgICAgICBpbmZvLnN0eWxlLmNvbG9yID0gIiNmZWNhY2EiOwogICAgICAgIGNvbnN0IGF2ZyA9IGVudHJ5LnNlbGxBdmdQcmljZSB8fCAwOwogICAgICAgIGluZm8udGV4dENvbnRlbnQgPSAiUXR5IChYVEIpOiAiICsgZW50cnkuc2VsbFRvdGFsUXR5LnRvRml4ZWQoNCkgKyAiIHwgxZpyLiBjZW5hIFNFTEw6ICIgKyBhdmcudG9GaXhlZCg0KSArICIgfCBUcmFuc2FrY2ppOiAiICsgZW50cnkuc2VsbHMubGVuZ3RoICsgKGVudHJ5LnNlbGxGaXJzdERhdGUgPyAiIHwgb2Q6ICIgKyBfX3h0YkZvcm1hdERhdGUoZW50cnkuc2VsbEZpcnN0RGF0ZSkgOiAiIik7CiAgICAgICAgc2VsbENvbC5hcHBlbmRDaGlsZChpbmZvKTsKCiAgICAgICAgY29uc3QgbG90c1dyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBsb3RzV3JhcC5jbGFzc05hbWUgPSAieHRiLXNlbGwtbG90cyI7CiAgICAgICAgbG90c1dyYXAuZGF0YXNldC50aWNrZXIgPSB0aWNrZXI7CiAgICAgICAgbG90c1dyYXAuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICBsb3RzV3JhcC5zdHlsZS5tYXJnaW5Ub3AgPSAiNHB4IjsKICAgICAgICBsb3RzV3JhcC5zdHlsZS5ib3JkZXJUb3AgPSAiMXB4IHNvbGlkIHJnYmEoNTEsNjUsODUsMC45KSI7CiAgICAgICAgbG90c1dyYXAuc3R5bGUucGFkZGluZ1RvcCA9ICI0cHgiOwoKICAgICAgICBjb25zdCBwZkhvbGQgPSBwZiAmJiBwZi5ob2xkaW5ncyAmJiBwZi5ob2xkaW5nc1t0aWNrZXJdID8gcGYuaG9sZGluZ3NbdGlja2VyXSA6IG51bGw7CiAgICAgICAgY29uc3QgbG90cyA9IHBmSG9sZCAmJiBBcnJheS5pc0FycmF5KHBmSG9sZC5sb3RzKSA/IHBmSG9sZC5sb3RzIDogW107CgogICAgICAgIGlmKGxvdHMubGVuZ3RoKXsKICAgICAgICAgIGNvbnN0IHRibCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRhYmxlIik7CiAgICAgICAgICB0Ymwuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgICAgICB0Ymwuc3R5bGUuYm9yZGVyQ29sbGFwc2UgPSAiY29sbGFwc2UiOwogICAgICAgICAgY29uc3QgdGhlYWQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0aGVhZCIpOwogICAgICAgICAgY29uc3QgaHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpOwogICAgICAgICAgWyIiLCAiRGF0YSIsICJRdHkiLCAiQ2VuYSB6YWt1cHUiXS5mb3JFYWNoKHR4dCA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGgiKTsKICAgICAgICAgICAgdGgudGV4dENvbnRlbnQgPSB0eHQ7CiAgICAgICAgICAgIHRoLnN0eWxlLmZvbnRTaXplID0gIjEwcHgiOwogICAgICAgICAgICB0aC5zdHlsZS5mb250V2VpZ2h0ID0gIjUwMCI7CiAgICAgICAgICAgIHRoLnN0eWxlLnRleHRBbGlnbiA9ICJsZWZ0IjsKICAgICAgICAgICAgdGguc3R5bGUucGFkZGluZyA9ICIycHggNHB4IjsKICAgICAgICAgICAgdGguc3R5bGUuY29sb3IgPSAiIzk0YTNiOCI7CiAgICAgICAgICAgIGhyLmFwcGVuZENoaWxkKHRoKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhlYWQuYXBwZW5kQ2hpbGQoaHIpOwogICAgICAgICAgdGJsLmFwcGVuZENoaWxkKHRoZWFkKTsKCiAgICAgICAgICBjb25zdCB0YiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRib2R5Iik7CiAgICAgICAgICBsb3RzLmZvckVhY2gobG90ID0+IHsKICAgICAgICAgICAgY29uc3QgdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpOwogICAgICAgICAgICB0ci5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKCiAgICAgICAgICAgIGNvbnN0IHRkQ2IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZCIpOwogICAgICAgICAgICB0ZENiLnN0eWxlLnBhZGRpbmcgPSAiMnB4IDRweCI7CiAgICAgICAgICAgIGNvbnN0IGNiTG90ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgY2JMb3QudHlwZSA9ICJjaGVja2JveCI7CiAgICAgICAgICAgIGNiTG90LmNsYXNzTmFtZSA9ICJ4dGItc2VsbC1sb3QtY2hlY2tib3giOwogICAgICAgICAgICBjYkxvdC5kYXRhc2V0LnRpY2tlciA9IHRpY2tlcjsKICAgICAgICAgICAgY2JMb3QuZGF0YXNldC5sb3RpZCA9IGxvdC5sb3RJZDsKICAgICAgICAgICAgY2JMb3QuZGF0YXNldC5xdHkgPSBOdW1iZXIobG90LnF0eXx8MCk7CiAgICAgICAgICAgIHRkQ2IuYXBwZW5kQ2hpbGQoY2JMb3QpOwogICAgICAgICAgICB0ci5hcHBlbmRDaGlsZCh0ZENiKTsKCiAgICAgICAgICAgIGNvbnN0IHRkRGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgICAgICAgICAgIHRkRGF0ZS5zdHlsZS5wYWRkaW5nID0gIjJweCA0cHgiOwogICAgICAgICAgICB0ZERhdGUudGV4dENvbnRlbnQgPSBsb3QuZGF0ZSB8fCAiIjsKICAgICAgICAgICAgdHIuYXBwZW5kQ2hpbGQodGREYXRlKTsKCiAgICAgICAgICAgIGNvbnN0IHRkUXR5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGQiKTsKICAgICAgICAgICAgdGRRdHkuc3R5bGUucGFkZGluZyA9ICIycHggNHB4IjsKICAgICAgICAgICAgdGRRdHkudGV4dENvbnRlbnQgPSAoTnVtYmVyKGxvdC5xdHkpfHwwKS50b0ZpeGVkKDQpOwogICAgICAgICAgICB0ci5hcHBlbmRDaGlsZCh0ZFF0eSk7CgogICAgICAgICAgICBjb25zdCB0ZFByaWNlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGQiKTsKICAgICAgICAgICAgdGRQcmljZS5zdHlsZS5wYWRkaW5nID0gIjJweCA0cHgiOwogICAgICAgICAgICB0ZFByaWNlLnRleHRDb250ZW50ID0gKE51bWJlcihsb3QudW5pdENvc3QpfHwwKS50b0ZpeGVkKDQpOwogICAgICAgICAgICB0ci5hcHBlbmRDaGlsZCh0ZFByaWNlKTsKCiAgICAgICAgICAgIHRiLmFwcGVuZENoaWxkKHRyKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdGJsLmFwcGVuZENoaWxkKHRiKTsKICAgICAgICAgIGxvdHNXcmFwLmFwcGVuZENoaWxkKHRibCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICBjb25zdCBub0xvdHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIG5vTG90cy50ZXh0Q29udGVudCA9ICJCcmFrIG90d2FydHljaCBwYXJ0aWkgbmEgdGVuIHRpY2tlciB3IHBvcnRmZWx1LiI7CiAgICAgICAgICBub0xvdHMuc3R5bGUuZm9udFNpemUgPSAiMTFweCI7CiAgICAgICAgICBub0xvdHMuc3R5bGUuY29sb3IgPSAiI2Y5NzM3MyI7CiAgICAgICAgICBsb3RzV3JhcC5hcHBlbmRDaGlsZChub0xvdHMpOwogICAgICAgIH0KCiAgICAgICAgc2VsbENvbC5hcHBlbmRDaGlsZChsb3RzV3JhcCk7CiAgICAgIH1lbHNlewogICAgICAgIGNvbnN0IGluZm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBpbmZvLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgICAgIGluZm8uc3R5bGUuY29sb3IgPSAiIzY0NzQ4YiI7CiAgICAgICAgaW5mby50ZXh0Q29udGVudCA9ICJCcmFrIHRyYW5zYWtjamkgU0VMTCBkbGEgdGVqIHNww7PFgmtpIHcgcGxpa3UuIjsKICAgICAgICBzZWxsQ29sLmFwcGVuZENoaWxkKGluZm8pOwogICAgICB9CgogICAgICBjb2xzLmFwcGVuZENoaWxkKGJ1eUNvbCk7CiAgICAgIGNvbHMuYXBwZW5kQ2hpbGQoc2VsbENvbCk7CiAgICAgIHJvdy5hcHBlbmRDaGlsZChjb2xzKTsKICAgICAgYm9keS5hcHBlbmRDaGlsZChyb3cpOwogICAgfSk7CgogICAgLy8gdG9nZ2xlIGJ1dHRvbnMKICAgIGNvbnN0IHRvZ2dsZXMgPSBtb2RhbC5xdWVyeVNlbGVjdG9yQWxsKCIueHRiLXNlbGwtbG90cy10b2dnbGUiKTsKICAgIHRvZ2dsZXMuZm9yRWFjaChidG4gPT4gewogICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbigpewogICAgICAgIGNvbnN0IHQgPSBidG4uZGF0YXNldC50aWNrZXI7CiAgICAgICAgY29uc3Qgd3JhcCA9IG1vZGFsLnF1ZXJ5U2VsZWN0b3IoIi54dGItc2VsbC1sb3RzW2RhdGEtdGlja2VyPSciK3QrIiddIik7CiAgICAgICAgaWYoIXdyYXApIHJldHVybjsKICAgICAgICB3cmFwLnN0eWxlLmRpc3BsYXkgPSB3cmFwLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiA/ICJibG9jayIgOiAibm9uZSI7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBfX3h0YlBlcmZvcm1JbXBvcnQoKXsKICAgIGNvbnN0IHBmSWQgPSBfX3h0YkltcG9ydFBvcnRmb2xpb0lkOwogICAgaWYoIXBmSWQgfHwgIV9feHRiQWdncmVnYXRlZCl7CiAgICAgIGFsZXJ0KCJCcmFrIGRhbnljaCBpbXBvcnR1IFhUQi4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcGYgPSBnZXRQZihwZklkKTsKICAgIGlmKCFwZil7CiAgICAgIGFsZXJ0KCJQb3J0ZmVsIG5pZSBpc3RuaWVqZS4iKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IG1vZGFsID0gX194dGJJbXBvcnRNb2RhbCB8fCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgieHRiSW1wb3J0TW9kYWwiKTsKICAgIGNvbnN0IGJvZHkgPSBtb2RhbCA/IG1vZGFsLnF1ZXJ5U2VsZWN0b3IoIiN4dGJJbXBvcnRCb2R5IikgOiBudWxsOwoKICAgIGxldCBidXlzSW1wb3J0ZWQgPSAwOwogICAgbGV0IHNlbGxzSW1wb3J0ZWQgPSAwOwogICAgbGV0IHNraXBwZWQgPSAwOwoKICAgIGZ1bmN0aW9uIHRvRGF0ZVN0cihkKXsKICAgICAgY29uc3QgeCA9IGQgaW5zdGFuY2VvZiBEYXRlID8gZCA6IF9feHRiRXhjZWxEYXRlVG9KcyhkKTsKICAgICAgaWYoISh4IGluc3RhbmNlb2YgRGF0ZSkpIHJldHVybiB0b2RheSgpOwogICAgICBjb25zdCB5ID0geC5nZXRGdWxsWWVhcigpOwogICAgICBjb25zdCBtID0gU3RyaW5nKHguZ2V0TW9udGgoKSsxKS5wYWRTdGFydCgyLCIwIik7CiAgICAgIGNvbnN0IGRhID0gU3RyaW5nKHguZ2V0RGF0ZSgpKS5wYWRTdGFydCgyLCIwIik7CiAgICAgIHJldHVybiB5KyItIittKyItIitkYTsKICAgIH0KCiAgICBjb25zdCB0aWNrZXJzID0gT2JqZWN0LmtleXMoX194dGJBZ2dyZWdhdGVkKTsKICAgIHRpY2tlcnMuZm9yRWFjaCh0aWNrZXIgPT4gewogICAgICBjb25zdCBlbnRyeSA9IF9feHRiQWdncmVnYXRlZFt0aWNrZXJdOwogICAgICBjb25zdCByb3dFbCA9IGJvZHkgPyBib2R5LnF1ZXJ5U2VsZWN0b3IoIi54dGItaW1wb3J0LXJvd1tkYXRhLXRpY2tlcj0nIit0aWNrZXIrIiddIikgOiBudWxsOwogICAgICBpZighcm93RWwpIHJldHVybjsKCiAgICAgIGNvbnN0IGJ1eUNiID0gcm93RWwucXVlcnlTZWxlY3RvcigiLnh0Yi1pbXBvcnQtYnV5LWNoZWNrYm94Iik7CiAgICAgIGNvbnN0IHNlbGxDYiA9IHJvd0VsLnF1ZXJ5U2VsZWN0b3IoIi54dGItaW1wb3J0LXNlbGwtY2hlY2tib3giKTsKCiAgICAgIC8vIEJVWSBpbXBvcnQKICAgICAgaWYoYnV5Q2IgJiYgYnV5Q2IuY2hlY2tlZCAmJiBlbnRyeS5idXlUb3RhbFF0eSA+IDApewogICAgICAgIHRyeXsKICAgICAgICAgIGNvbnN0IGRhdGVTdHIgPSBlbnRyeS5idXlGaXJzdERhdGUgPyB0b0RhdGVTdHIoZW50cnkuYnV5Rmlyc3REYXRlKSA6IHRvZGF5KCk7CiAgICAgICAgICBjb25zdCBxdHkgPSBlbnRyeS5idXlUb3RhbFF0eTsKICAgICAgICAgIGNvbnN0IHByaWNlID0gZW50cnkuYnV5QXZnUHJpY2UgfHwgMDsKICAgICAgICAgIGJ1eShwZklkLCB7CiAgICAgICAgICAgIHRpY2tlciwKICAgICAgICAgICAgZGF0ZTogZGF0ZVN0ciwKICAgICAgICAgICAgcXR5OiBxdHksCiAgICAgICAgICAgIHByaWNlOiBwcmljZSwKICAgICAgICAgICAgZmVlczogMCwKICAgICAgICAgICAgbm90ZTogIkltcG9ydCBYVEIgQlVZICgiICsgZW50cnkuYnV5cy5sZW5ndGggKyAiIHRyYW5zLikiLAogICAgICAgICAgICB0YXJnZXRQY3Q6IG51bGwsCiAgICAgICAgICAgIHRhcmdldFByaWNlOiBudWxsLAogICAgICAgICAgICBidXlUYXJnZXRQY3Q6IG51bGwsCiAgICAgICAgICAgIGJ1eVRhcmdldFByaWNlOiBudWxsCiAgICAgICAgICB9KTsKICAgICAgICAgIGJ1eXNJbXBvcnRlZCsrOwogICAgICAgIH1jYXRjaChlcnIpewogICAgICAgICAgY29uc29sZS5lcnJvcigiWFRCIGltcG9ydCBCVVkgZXJyb3IiLCBlcnIpOwogICAgICAgICAgc2tpcHBlZCsrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU0VMTCBpbXBvcnQKICAgICAgaWYoc2VsbENiICYmIHNlbGxDYi5jaGVja2VkICYmIGVudHJ5LnNlbGxUb3RhbFF0eSA+IDApewogICAgICAgIHRyeXsKICAgICAgICAgIGNvbnN0IGxvdENicyA9IHJvd0VsLnF1ZXJ5U2VsZWN0b3JBbGwoIi54dGItc2VsbC1sb3QtY2hlY2tib3giKTsKICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gW107CiAgICAgICAgICBsb3RDYnMuZm9yRWFjaChjYiA9PiB7CiAgICAgICAgICAgIGlmKGNiLmNoZWNrZWQpewogICAgICAgICAgICAgIHNlbGVjdGVkLnB1c2goewogICAgICAgICAgICAgICAgbG90SWQ6IGNiLmRhdGFzZXQubG90aWQsCiAgICAgICAgICAgICAgICBxdHk6IE51bWJlcihjYi5kYXRhc2V0LnF0eSl8fDAKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBpZighc2VsZWN0ZWQubGVuZ3RoKXsKICAgICAgICAgICAgc2tpcHBlZCsrOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0b3RhbFh0YlF0eSA9IGVudHJ5LnNlbGxUb3RhbFF0eSB8fCAwOwogICAgICAgICAgaWYodG90YWxYdGJRdHkgPD0gMCl7CiAgICAgICAgICAgIHNraXBwZWQrKzsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgbGV0IHJlbWFpbmluZyA9IHRvdGFsWHRiUXR5OwogICAgICAgICAgY29uc3QgYWxsb2NhdGlvbnMgPSBbXTsKICAgICAgICAgIC8vIEFsb2t1amVteSBjesSZxZtjaW93byB6IHphem5hY3pvbnljaCBwYXJ0aWkgYcW8IGRvIHd5Y3plcnBhbmlhIGlsb8WbY2kgWFRCCiAgICAgICAgICBzZWxlY3RlZC5mb3JFYWNoKHMgPT4gewogICAgICAgICAgICBpZihyZW1haW5pbmcgPD0gMCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBsb3RRdHkgPSBOdW1iZXIocy5xdHkpIHx8IDA7CiAgICAgICAgICAgIGlmKGxvdFF0eSA8PSAwKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHVzZVF0eSA9IE1hdGgubWluKGxvdFF0eSwgcmVtYWluaW5nKTsKICAgICAgICAgICAgaWYodXNlUXR5ID4gMCl7CiAgICAgICAgICAgICAgYWxsb2NhdGlvbnMucHVzaCh7IGxvdElkOiBzLmxvdElkLCBxdHk6IHVzZVF0eSB9KTsKICAgICAgICAgICAgICByZW1haW5pbmcgLT0gdXNlUXR5OwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmKCFhbGxvY2F0aW9ucy5sZW5ndGgpewogICAgICAgICAgICBza2lwcGVkKys7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHNlbGxQcmljZSA9IGVudHJ5LnNlbGxBdmdQcmljZSB8fCAwOwogICAgICAgICAgY29uc3Qgc2VsbERhdGVTdHIgPSBlbnRyeS5zZWxsRmlyc3REYXRlID8gdG9EYXRlU3RyKGVudHJ5LnNlbGxGaXJzdERhdGUpIDogdG9kYXkoKTsKICAgICAgICAgIHNlbGwocGZJZCwgewogICAgICAgICAgICB0aWNrZXIsCiAgICAgICAgICAgIGRhdGU6IHNlbGxEYXRlU3RyLAogICAgICAgICAgICBzZWxsUHJpY2U6IHNlbGxQcmljZSwKICAgICAgICAgICAgZmVlczogMCwKICAgICAgICAgICAgYWxsb2NhdGlvbnM6IGFsbG9jYXRpb25zLAogICAgICAgICAgICBub3RlOiAiSW1wb3J0IFhUQiBTRUxMICh6YXpuYWN6b25lIHBhcnRpZSwgIiArIGVudHJ5LnNlbGxzLmxlbmd0aCArICIgdHJhbnMuKSIKICAgICAgICAgIH0pOwogICAgICAgICAgc2VsbHNJbXBvcnRlZCsrOwogICAgICAgIH1jYXRjaChlcnIpewogICAgICAgICAgY29uc29sZS5lcnJvcigiWFRCIGltcG9ydCBTRUxMIGVycm9yIiwgZXJyKTsKICAgICAgICAgIHNraXBwZWQrKzsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKCiAgICBpZihtb2RhbCkgbW9kYWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIF9feHRiSW1wb3J0UG9ydGZvbGlvSWQgPSBudWxsOwogICAgX194dGJBZ2dyZWdhdGVkID0gbnVsbDsKCiAgICBhbGVydCgKICAgICAgIkltcG9ydCBYVEIgemFrb8WEY3pvbnkuXFxuIiArCiAgICAgICJCVVkgZG9kYW5lOiAiICsgYnV5c0ltcG9ydGVkICsgIlxcbiIgKwogICAgICAiU0VMTCB3eWtvbmFuZTogIiArIHNlbGxzSW1wb3J0ZWQgKyAiXFxuIiArCiAgICAgICJQb21pbmnEmXRlIC8gYsWCxJlkbmU6ICIgKyBza2lwcGVkCiAgICApOwogIH0KCiAgZnVuY3Rpb24gX194dGJIYW5kbGVGaWxlSW5wdXRDaGFuZ2UoZXYpewogICAgY29uc3QgaW5wdXQgPSBldi50YXJnZXQ7CiAgICBjb25zdCBmaWxlID0gaW5wdXQuZmlsZXMgJiYgaW5wdXQuZmlsZXNbMF07CiAgICBpZighZmlsZSkgcmV0dXJuOwogICAgaWYodHlwZW9mIFhMU1ggPT09ICJ1bmRlZmluZWQiKXsKICAgICAgYWxlcnQoIkJyYWsgYmlibGlvdGVraSBYTFNYIChTaGVldEpTKS4gU3ByYXdkxbogcG/FgsSFY3plbmllIHogaW50ZXJuZXRlbS4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcGZJZCA9IF9feHRiSW1wb3J0UG9ydGZvbGlvSWQ7CiAgICBpZighcGZJZCl7CiAgICAgIGFsZXJ0KCJOYWpwaWVydyB3eWJpZXJ6IHBvcnRmZWwgZGxhIGltcG9ydHUgWFRCLiIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbihlKXsKICAgICAgbGV0IHdiOwogICAgICB0cnl7CiAgICAgICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KGUudGFyZ2V0LnJlc3VsdCk7CiAgICAgICAgd2IgPSBYTFNYLnJlYWQoZGF0YSwge3R5cGU6ImFycmF5IiwgY2VsbERhdGVzOnRydWV9KTsKICAgICAgfWNhdGNoKGVycil7CiAgICAgICAgY29uc29sZS5lcnJvcigiWFRCIGltcG9ydDogYsWCxIVkIHBhcnNvd2FuaWEgcGxpa3UiLCBlcnIpOwogICAgICAgIGFsZXJ0KCJOaWUgdWRhxYJvIHNpxJkgb2Rjenl0YcSHIHBsaWt1IFhUQiAoWExTWCkuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHNoZWV0TmFtZXMgPSB3Yi5TaGVldE5hbWVzIHx8IFtdOwoKICAgICAgY29uc3QgY2FzaE5hbWUgPSBzaGVldE5hbWVzLmZpbmQobiA9PiBuLnRvVXBwZXJDYXNlKCkuc3RhcnRzV2l0aCgiQ0FTSCBPUEVSQVRJT04iKSk7CiAgICAgIGNvbnN0IHJvd3NBbGwgPSBbXTsKICAgICAgaWYoY2FzaE5hbWUgJiYgd2IuU2hlZXRzW2Nhc2hOYW1lXSl7CiAgICAgICAgcm93c0FsbC5wdXNoKC4uLl9feHRiUGFyc2VDYXNoU2hlZXQod2IuU2hlZXRzW2Nhc2hOYW1lXSkpOwogICAgICB9CgogICAgICBpZighcm93c0FsbC5sZW5ndGgpewogICAgICAgIGFsZXJ0KCJOaWUgem5hbGV6aW9ubyDFvGFkbnljaCBwb3p5Y2ppIGFrY3lqbnljaCAoU3RvY2sgcHVyY2hhc2Uvc2FsZSkgdyBhcmt1c3p1IENBU0ggT1BFUkFUSU9OIEhJU1RPUlkuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBhZ2dyZWdhdGVkID0gX194dGJCdWlsZEFnZ3JlZ2F0ZWQocm93c0FsbCk7CiAgICAgIF9feHRiQWdncmVnYXRlZCA9IGFnZ3JlZ2F0ZWQ7CiAgICAgIF9feHRiSW1wb3J0UG9ydGZvbGlvSWQgPSBwZklkOwogICAgICBfX3h0YlJlbmRlckltcG9ydE1vZGFsKHBmSWQsIGFnZ3JlZ2F0ZWQpOwogICAgICBjb25zdCBtb2RhbCA9IF9feHRiRW5zdXJlSW1wb3J0TW9kYWwoKTsKICAgICAgbW9kYWwuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgIH07CiAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7CiAgfQoKICAoZnVuY3Rpb24oKXsKICAgIGNvbnN0IGZpID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInh0YkltcG9ydEZpbGUiKTsKICAgIGlmKGZpKSBmaS5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBfX3h0YkhhbmRsZUZpbGVJbnB1dENoYW5nZSk7CiAgfSkoKTsKCgogIC8vIFJlbmRlcmluZwoKICAvLyBDb21wdXRlIGhvbGRpbmdzICh1c2luZyBsaXZlIHF1b3RlIGlmIGF2YWlsYWJsZSwgZWxzZSB1bml0Q29zdCkgYW5kIHRvdGFscwogIGZ1bmN0aW9uIGNvbXB1dGVIb2xkaW5nc0FuZFRvdGFsVmFsdWVzKHBmKXsKICAgIHRyeXsKICAgICAgbGV0IGhvbGRpbmdzVmFsdWUgPSAwOwogICAgICBmb3IoY29uc3QgW3RpY2tlciwgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICAgICAgY29uc3QgbG90cyA9IChib29rICYmIEFycmF5LmlzQXJyYXkoYm9vay5sb3RzKSkgPyBib29rLmxvdHMgOiBbXTsKICAgICAgICBjb25zdCBxUHJpY2UgPSBnZXRRdW90ZSh0aWNrZXIpOwogICAgICAgIGZvcihjb25zdCBsIG9mIGxvdHMpewogICAgICAgICAgY29uc3QgcXR5ID0gTnVtYmVyKGwucXR5KXx8MDsKICAgICAgICAgIGNvbnN0IHVuaXQgPSAocVByaWNlIT1udWxsID8gTnVtYmVyKHFQcmljZSkgOiBOdW1iZXIobC51bml0Q29zdCl8fDApOwogICAgICAgICAgaG9sZGluZ3NWYWx1ZSArPSBxdHkgKiB1bml0OwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCB0b3RhbFdpdGhDYXNoID0gaG9sZGluZ3NWYWx1ZSArIChOdW1iZXIocGYuY2FzaCl8fDApOwogICAgICByZXR1cm4geyBob2xkaW5nc1ZhbHVlLCB0b3RhbFdpdGhDYXNoIH07CiAgICB9Y2F0Y2goZSl7CiAgICAgIHJldHVybiB7IGhvbGRpbmdzVmFsdWU6IDAsIHRvdGFsV2l0aENhc2g6IE51bWJlcihwZi5jYXNoKXx8MCB9OwogICAgfQogIH0KCmZ1bmN0aW9uIHJlbmRlclBvcnRmb2xpb0xpc3QoKXsKICBzZXRUaW1lb3V0KCgpPT57IHRyeSB7IHVwZGF0ZVNpZGViYXJCbGlua1N0YXRlcygpOyB9IGNhdGNoKGUpIHt9IH0sIDApOwoKICAgIHBvcnRmb2xpb0xpc3RFbC5pbm5lckhUTUwgPSAiIjsKICAgIGZvcihjb25zdCBwZiBvZiAoKHR5cGVvZiBTVCE9PSd1bmRlZmluZWQnICYmIFNULkRCICYmIEFycmF5LmlzQXJyYXkoU1QuREIucG9ydGZvbGlvcykpID8gU1QuREIucG9ydGZvbGlvcyA6ICgodHlwZW9mIERCIT09J3VuZGVmaW5lZCcgJiYgQXJyYXkuaXNBcnJheShEQi5wb3J0Zm9saW9zKSkgPyBEQi5wb3J0Zm9saW9zIDogW10pKSl7CiAgICAgIGNvbnN0IHRvdGFsTG90cyA9IE9iamVjdC52YWx1ZXMocGYuaG9sZGluZ3MpLnJlZHVjZSgoYWNjLCB2KT0+IGFjYyArIHYubG90cy5sZW5ndGgsIDApOwogICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbC5jbGFzc05hbWUgPSAicG9ydGZvbGlvLWl0ZW0iICsgKHBmLmlkPT09Y3VycmVudFBmSWQgPyAiIGFjdGl2ZSI6ICIiKTsKICAgICAgZWwuZGF0YXNldC5wZklkID0gcGYuaWQ7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgX3N0YXRlID0gcG9ydGZvbGlvVGFyZ2V0U3RhdGUocGYpOwogICAgICAgIGlmKF9zdGF0ZSA9PT0gImhpdCIpIGVsLmNsYXNzTGlzdC5hZGQoImhpdC10YXJnZXQiKTsKICAgICAgICBlbHNlIGlmKF9zdGF0ZSA9PT0gIm5lYXIiKSBlbC5jbGFzc0xpc3QuYWRkKCJuZWFyLXRhcmdldCIpOwogICAgICB9IGNhdGNoKGUpIHt9CgogICAgICBlbC5pbm5lckhUTUwgPSBgCiAgICAgICAgPGRpdiBjbGFzcz0ibmFtZSI+JHtfX2VzYyhwZi5uYW1lKX08L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgPGRpdiBjbGFzcz0idGFnIj5Hb3TDs3drYTogJHtfX2dvX2ZtdEN1cnJlbmN5KHBmLmNhc2gsIHBmLmN1cnJlbmN5KX08L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgPGRpdiBjbGFzcz0idGFnIj5Ba2NqZTogJHtfX2dvX2ZtdEN1cnJlbmN5KChjb21wdXRlSG9sZGluZ3NBbmRUb3RhbFZhbHVlcyhwZikuaG9sZGluZ3NWYWx1ZSksIHBmLmN1cnJlbmN5KX08L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9InRhZyI+UmF6ZW06ICR7X19nb19mbXRDdXJyZW5jeSgoY29tcHV0ZUhvbGRpbmdzQW5kVG90YWxWYWx1ZXMocGYpLnRvdGFsV2l0aENhc2gpLCBwZi5jdXJyZW5jeSl9PC9kaXY+CiAgICAgICAgPC9kaXY+CgogICAgICAgICAgPGRpdiBjbGFzcz0idGFnIj5QYXJ0aWU6ICR7dG90YWxMb3RzfTwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJzbWFsbCI+V2FsdXRhOiAke3BmLmN1cnJlbmN5fTwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwiPm1vZHlmOiAke25ldyBEYXRlKHBmLnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCdwbC1QTCcpfTwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QgYnRuLXh0Yi1pbXBvcnQiIHR5cGU9ImJ1dHRvbiIgdGl0bGU9IkltcG9ydCB0cmFuc2FrY2ppIHogWFRCIGRvIHRlZ28gcG9ydGZlbGEiPuKshu+4jyBJbXBvcnQgeiBYVEI8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgYDsKICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IHsgCiAgICAgIHRyeXsgCiAgICAgICAgY29uc3QgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tYWluJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpOwogICAgICAgIGlmKG1haW4pewogICAgICAgICAgbWFpbi5xdWVyeVNlbGVjdG9yQWxsKCc6c2NvcGUgPiBzZWN0aW9uJykuZm9yRWFjaChzZWM9PnsKICAgICAgICAgICAgaWYoc2VjLmlkPT09J2FsZXJ0c1BhbmVsJyB8fCBzZWMuaWQ9PT0nd2lzaGxpc3RQYW5lbCcpIHNlYy5zdHlsZS5kaXNwbGF5PSdub25lJzsgZWxzZSBzZWMuc3R5bGUuZGlzcGxheT0nJzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KICAgICAgY3VycmVudFBmSWQgPSBwZi5pZDsgcmVuZGVyKCk7IAogICAgfSk7CgogICAgICBjb25zdCBpbXBvcnRCdG4gPSBlbC5xdWVyeVNlbGVjdG9yKCIuYnRuLXh0Yi1pbXBvcnQiKTsKICAgICAgaWYgKGltcG9ydEJ0bikgewogICAgICAgIGltcG9ydEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChldik9PnsKICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgc3RhcnRYdGJJbXBvcnRGb3JQb3J0Zm9saW8ocGYuaWQpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBwb3J0Zm9saW9MaXN0RWwuYXBwZW5kQ2hpbGQoZWwpOwogICAgfQogICAgaWYoIWN1cnJlbnRQZklkICYmIERCLnBvcnRmb2xpb3MubGVuZ3RoPT09MCl7CiAgICAgIGNvbnN0IGVtcHR5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIGVtcHR5LmNsYXNzTmFtZT0ic21hbGwiOwogICAgICBlbXB0eS5pbm5lckhUTUwgPSAiQnJhayBwb3J0ZmVsaS4gS2xpa25paiA8Yj5Ob3d5IHBvcnRmZWw8L2I+LCBhYnkgcm96cG9jesSFxIcuIjsKICAgICAgcG9ydGZvbGlvTGlzdEVsLmFwcGVuZENoaWxkKGVtcHR5KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlck1haW4oKXsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOwogICAgaWYoIXBmKXsKICAgICAgcGZUaXRsZUVsLnRleHRDb250ZW50ID0gIld5YmllcnogcG9ydGZlbCI7CiAgICAgIGNhc2hCYWxhbmNlRWwudGV4dENvbnRlbnQgPSAi4oCUIjsKICAgICAgcmVhbGl6ZWRQTEVsLnRleHRDb250ZW50ID0gIuKAlCI7CiAgICAgIHJlYWxpemVkUExuZXRFbC50ZXh0Q29udGVudCA9ICJuZXR0byI7CiAgICAgIHN0cmF0ZWd5Qm94LnZhbHVlID0gIiI7CiAgICAgIGhvbGRpbmdzVGFibGVXcmFwLmlubmVySFRNTCA9ICIiOwogICAgICB0eFRhYmxlV3JhcC5pbm5lckhUTUwgPSAiIjsKICAgICAgcmV0dXJuOwogICAgfQogICAgZW5zdXJlVHJhbnNhY3Rpb25zQ29oZXJlbnQocGYpOwogICAgbWF5YmVXYXJuVHhMb3NzKHBmKTsKICAgIHBmVGl0bGVFbC50ZXh0Q29udGVudCA9IGAke3BmLm5hbWV9ICgke3BmLmN1cnJlbmN5fSlgOwogICAgc3RyYXRlZ3lCb3gudmFsdWUgPSBwZi5zdHJhdGVneSB8fCAiIjsKICAgIGNhc2hCYWxhbmNlRWwudGV4dENvbnRlbnQgPSBfX2dvX2ZtdEN1cnJlbmN5KHBmLmNhc2gsIHBmLmN1cnJlbmN5KTsKICAgIGNvbnN0IHtzdW1Hcm9zcywgc3VtVGF4LCBzdW1OZXR9ID0gcmVhbGl6ZWRTdW1zKHBmKTsKICAgIHJlYWxpemVkUExFbC50ZXh0Q29udGVudCA9IF9fZ29fZm10Q3VycmVuY3koc3VtR3Jvc3MsIHBmLmN1cnJlbmN5KTsKICAgIHJlYWxpemVkUExuZXRFbC50ZXh0Q29udGVudCA9IF9fZ29fZm10Q3VycmVuY3koc3VtTmV0LCBwZi5jdXJyZW5jeSk7CgogICAgLy8gSG9sZGluZ3MgdGFibGUKICAgIGhvbGRpbmdzVGFibGVXcmFwLmlubmVySFRNTCA9IGJ1aWxkSG9sZGluZ3NUYWJsZUhUTUwocGYpOwovLyBTaG93IGludGVncml0eSB3YXJuaW5ncyAobm9uLWJsb2NraW5nKQp0cnl7CiAgY29uc3QgZXJyV3JhcElkID0gJ3BmRXJyb3JzQmFubmVyJzsKICBsZXQgb2xkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZXJyV3JhcElkKTsKICBpZihvbGQpIG9sZC5yZW1vdmUoKTsKICBjb25zdCBlcnJzID0gQXJyYXkuaXNBcnJheShwZi5fX2Vycm9ycykgPyBwZi5fX2Vycm9ycyA6IFtdOwogIGlmKGVycnMubGVuZ3RoKXsKICAgIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHdyYXAuaWQgPSBlcnJXcmFwSWQ7CiAgICB3cmFwLmNsYXNzTmFtZSA9ICdiYW5uZXIgd2Fybic7CiAgICBjb25zdCBkZXRhaWxzID0gZXJycy5zbGljZSgwLDQpLm1hcChlID0+IGAke2UuZGF0ZXx8J+KAlCd9IOKAoiAke2UudGlja2VyfHwn4oCUJ30g4oCiICR7ZS5tZXNzYWdlfHwnJ31gKS5qb2luKCc8YnI+Jyk7CiAgICB3cmFwLmlubmVySFRNTCA9IGA8ZGl2PuKaoO+4jyBOaWVzcMOzam5lIHRyYW5zYWtjamU6ICR7ZXJycy5sZW5ndGh9LiA8c3BhbiBjbGFzcz0ic21hbGwiIHN0eWxlPSJvcGFjaXR5Oi44NSI+RWR5Y2phIG5pZSB6b3N0YcWCYSB6YWJsb2tvd2FuYSDigJQgc3ByYXdkxbogc3pjemVnw7PFgnkgaSBwb3ByYXcgZGF0eS9hbG9rYWNqZS48L3NwYW4+PGRpdiBjbGFzcz0ic21hbGwiIHN0eWxlPSJtYXJnaW4tdG9wOjZweCI+JHtkZXRhaWxzfSR7ZXJycy5sZW5ndGg+ND8nPGJyPuKApic6Jyd9PC9kaXY+PC9kaXY+PGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2dhcDo4cHgiPjxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCIgaWQ9InBmRXJyb3JzRGlzbWlzcyI+T0s8L2J1dHRvbj48YnV0dG9uIGNsYXNzPSJidG4gd2FybiIgaWQ9InBmRXJyb3JzSWdub3JlIj5JZ25vcnVqIHNwcnplZGHFvGU8L2J1dHRvbj48L2Rpdj5gOwogICAgY29uc3QgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21haW4nKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubWFpbicpIHx8IGRvY3VtZW50LmJvZHk7CiAgICBtYWluLnByZXBlbmQod3JhcCk7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGZFcnJvcnNEaXNtaXNzJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiB3cmFwLnJlbW92ZSgpKTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGZFcnJvcnNJZ25vcmUnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IHsgdHJ5eyBfX2lnbm9yZUluY29uc2lzdGVudFNlbGxzKCk7IH1jYXRjaChfKXsgYWxlcnQoJ0LFgsSFZCBpZ25vcm93YW5pYS4nKTsgfSB9KTsKICB9Cn1jYXRjaChfKXt9CgogICAgCiAgICAvLyBVcGRhdGUgbGVmdCBzaWRlYmFyIHRpbGUgYmxpbmtpbmcgZm9yIHRoZSBjdXJyZW50IHBvcnRmb2xpbwogICAgKGZ1bmN0aW9uKCl7CiAgICAgIGNvbnN0IHN0YXRlID0gcG9ydGZvbGlvVGFyZ2V0U3RhdGUocGYpOyAvLyAiaGl0IiB8ICJuZWFyIiB8ICJub25lIgogICAgICAvLyBDbGVhciBwcmV2aW91cyBibGlua2luZyBjbGFzc2VzIG9uIGFsbCBzaWRlYmFyIGl0ZW1zCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5wb3J0Zm9saW8taXRlbScpLmZvckVhY2goZWw9PnsKICAgICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKCdoaXQtdGFyZ2V0JywnbmVhci10YXJnZXQnKTsKICAgICAgfSk7CiAgICAgIC8vIEFwcGx5IHRvIHRoZSBjdXJyZW50IHBvcnRmb2xpbydzIHRpbGUKICAgICAgY29uc3QgY3VyRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAucG9ydGZvbGlvLWl0ZW1bZGF0YS1wZi1pZD0iJHtwZi5pZH0iXWApOwogICAgICBpZihjdXJFbCl7CiAgICAgICAgaWYoc3RhdGUgPT09ICJoaXQiKSBjdXJFbC5jbGFzc0xpc3QuYWRkKCdoaXQtdGFyZ2V0Jyk7CiAgICAgICAgZWxzZSBpZihzdGF0ZSA9PT0gIm5lYXIiKSBjdXJFbC5jbGFzc0xpc3QuYWRkKCduZWFyLXRhcmdldCcpOwogICAgICB9CiAgICB9KSgpOwoKLy8gVHJhbnNhY3Rpb25zIHRhYmxlCiAgICB0eFRhYmxlV3JhcC5pbm5lckhUTUwgPSBidWlsZFR4VGFibGVIVE1MKHBmLCBmaWx0ZXJRdWVyeUVsLnZhbHVlLnRyaW0oKSk7CiAgICB0cnkgeyB1cGRhdGVTaWRlYmFyQmxpbmtTdGF0ZXMoKTsgfSBjYXRjaChlKSB7fQp9CgogIGZ1bmN0aW9uIHJlYWxpemVkU3VtcyhwZiwgcmFuZ2UpewogICAgbGV0IHN1bUdyb3NzID0gMCwgc3VtVGF4ID0gMCwgc3VtTmV0ID0gMDsKICAgIGZvcihjb25zdCB0IG9mIHBmLnRyYW5zYWN0aW9ucyl7CiAgICAgIGlmKHQudHlwZT09PSJzZWxsIil7CiAgICAgICAgdHJ5eyBjb25zdCBtcyA9IHRvTXModCAmJiB0LmRhdGUpOyBpZihyYW5nZSAmJiAhaW5SYW5nZU1zKG1zLCByYW5nZSkpIGNvbnRpbnVlOyB9Y2F0Y2goXyl7fQogICAgICAgIHN1bUdyb3NzICs9IE51bWJlcih0Lmdyb3NzUEwpfHwwOwogICAgICAgIHN1bVRheCAgICs9IE51bWJlcih0LnRheCl8fDA7CiAgICAgICAgc3VtTmV0ICAgKz0gTnVtYmVyKHQubmV0UEwgfHwgKHQuZ3Jvc3NQTCAtICh0Lmdyb3NzUEw+MCA/IChEQi5zZXR0aW5ncy50YXhSYXRlfHwwLjE5KSp0Lmdyb3NzUEwgOiAwKSkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4ge3N1bUdyb3NzLCBzdW1UYXgsIHN1bU5ldH07CiAgfQoKICAKICAKICAKICBmdW5jdGlvbiBidWlsZEhvbGRpbmdzVGFibGVIVE1MKHBmKXsKICAgIGNvbnN0IHNlY3Rpb25zID0gW107CiAgICBjb25zdCBfX3Jvd3MgPSBbXTsKICAgIGZvcihjb25zdCBbdGlja2VyLCBib29rXSBvZiBPYmplY3QuZW50cmllcyhwZi5ob2xkaW5ncykpewogICAgICBjb25zdCBfX2NuID0gZ2V0Q29tcGFueU5hbWUodGlja2VyKTsKICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSBfX2NuID8gYCR7X19lc2ModGlja2VyKX0gPHNwYW4gY2xhc3M9Im11dGVkIHNtYWxsIiBzdHlsZT0iZm9udC13ZWlnaHQ6NDAwIj4ke19fZXNjKF9fY24pfTwvc3Bhbj5gIDogX19lc2ModGlja2VyKTsKICAgICAgY29uc3QgbG90cyA9IGJvb2subG90cyB8fCBbXTsKICAgICAgY29uc3QgdG90YWxRdHkgPSBsb3RzLnJlZHVjZSgoYSxsKT0+YStOdW1iZXIobC5xdHl8fDApLDApOwogICAgICBjb25zdCBjb3N0QmFzaXMgPSBsb3RzLnJlZHVjZSgoYSxsKT0+YSArIE51bWJlcihsLnF0eXx8MCkqTnVtYmVyKGwudW5pdENvc3R8fDApLDApOwogICAgICBjb25zdCBhdmdDb3N0ID0gdG90YWxRdHk+MCA/IGNvc3RCYXNpcyAvIHRvdGFsUXR5IDogMDsKICAgICAgY29uc3QgbGFzdFByaWNlID0gZ2V0UXVvdGUodGlja2VyKTsKCiAgICAgIGxldCBuZWFyZXN0VGFyZ2V0ID0gbnVsbCwgc3RhdHVzQ2xhc3MgPSAiIjsKbGV0IG5lYXJlc3REaXN0ID0gSW5maW5pdHk7CmxldCBzdGF0dXNSYW5rID0gLTE7IC8vIDM6IGhpdC1zZWxsLCAyOiBoaXQtYnV5LCAxOiBuZWFyLXNlbGwsIDA6IG5lYXItYnV5CmZvcihjb25zdCBsIG9mIGxvdHMpewogIGwuX3RpY2tlciA9IHRpY2tlcjsKICBjb25zdCBzZWxsVCA9IGNvbXB1dGVUYXJnZXRQcmljZShsKTsKICBjb25zdCBidXlUICA9IGNvbXB1dGVCdXlUYXJnZXRQcmljZShsKTsKICBjb25zdCBzdCA9IHRhcmdldFN0YXR1cyhsKTsKICBjb25zdCByYW5rID0gc3Quc3RhdGU9PT0iaGl0IiA/IChzdC5raW5kPT09InNlbGwiPzM6MikgOiAoc3Quc3RhdGU9PT0ibmVhciIgPyAoc3Qua2luZD09PSJzZWxsIj8xOjApIDogLTEpOwogIGlmKHJhbmsgPiBzdGF0dXNSYW5rKXsKICAgIHN0YXR1c1JhbmsgPSByYW5rOwogICAgaWYocmFuaz09PTMpIHN0YXR1c0NsYXNzID0gImhpdC10YXJnZXQtc2VsbCI7CiAgICBlbHNlIGlmKHJhbms9PT0yKSBzdGF0dXNDbGFzcyA9ICJoaXQtdGFyZ2V0LWJ1eSI7CiAgICBlbHNlIGlmKHJhbms9PT0xKSBzdGF0dXNDbGFzcyA9ICJuZWFyLXRhcmdldC1zZWxsIjsKICAgIGVsc2UgaWYocmFuaz09PTApIHN0YXR1c0NsYXNzID0gIm5lYXItdGFyZ2V0LWJ1eSI7CiAgfQogIC8vIHN1cHByZXNzIGJsaW5raW5nIGZvciBhY2tub3dsZWRnZWQgYWxhcm1zCiAgKGZ1bmN0aW9uKCl7CiAgICBjb25zdCBtYXAgPSB7ImhpdC10YXJnZXQtc2VsbCI6e3N0YXRlOiJoaXQiLGtpbmQ6InNlbGwifSwiaGl0LXRhcmdldC1idXkiOntzdGF0ZToiaGl0IixraW5kOiJidXkifSwibmVhci10YXJnZXQtc2VsbCI6e3N0YXRlOiJuZWFyIixraW5kOiJzZWxsIn0sIm5lYXItdGFyZ2V0LWJ1eSI6e3N0YXRlOiJuZWFyIixraW5kOiJidXkifX07CiAgICBjb25zdCBpbmZvID0gbWFwW3N0YXR1c0NsYXNzXTsKICAgIGlmKGluZm8gJiYgaXNBbGVydEFja2VkKHRpY2tlciwgaW5mby5raW5kLCBpbmZvLnN0YXRlKSl7IHN0YXR1c0NsYXNzID0gIiI7IH0KICB9KSgpOwoKICBjb25zdCBjYW5kaWRhdGVzID0gW107CiAgaWYoc2VsbFQhPW51bGwpIGNhbmRpZGF0ZXMucHVzaChzZWxsVCk7CiAgaWYoYnV5VCE9bnVsbCkgIGNhbmRpZGF0ZXMucHVzaChidXlUKTsKICBmb3IoY29uc3QgdCBvZiBjYW5kaWRhdGVzKXsKICAgIGlmKGxhc3RQcmljZSE9bnVsbCl7CiAgICAgIGNvbnN0IGQgPSBNYXRoLmFicygobGFzdFByaWNlIC0gdCkvdCk7CiAgICAgIGlmKGQgPCBuZWFyZXN0RGlzdCl7IG5lYXJlc3REaXN0ID0gZDsgbmVhcmVzdFRhcmdldCA9IHQ7IH0KICAgIH0gZWxzZSB7CiAgICAgIGlmKG5lYXJlc3RUYXJnZXQ9PW51bGwpIG5lYXJlc3RUYXJnZXQgPSB0OyBlbHNlIG5lYXJlc3RUYXJnZXQgPSBNYXRoLm1pbihuZWFyZXN0VGFyZ2V0LCB0KTsKICAgIH0KICB9CiAgICAgIC8vIExvZyBwZXItdGlja2VyIGFsYXJtIHRvIEZpcmVzdG9yZSAoZGVkdXBsaWNhdGVkKQogICAgICAoZnVuY3Rpb24oKXsKICAgICAgICBjb25zdCBtYXAgPSB7CiAgICAgICAgICAiaGl0LXRhcmdldC1zZWxsIjoge3N0YXRlOiJoaXQiLCAga2luZDoic2VsbCJ9LAogICAgICAgICAgImhpdC10YXJnZXQtYnV5IjogIHtzdGF0ZToiaGl0IiwgIGtpbmQ6ImJ1eSJ9LAogICAgICAgICAgIm5lYXItdGFyZ2V0LXNlbGwiOntzdGF0ZToibmVhciIsIGtpbmQ6InNlbGwifSwKICAgICAgICAgICJuZWFyLXRhcmdldC1idXkiOiB7c3RhdGU6Im5lYXIiLCBraW5kOiJidXkifQogICAgICAgIH07CiAgICAgICAgY29uc3QgaW5mbyA9IG1hcFtzdGF0dXNDbGFzc107CiAgICAgICAgaWYoaW5mbyAmJiBuZWFyZXN0VGFyZ2V0IT1udWxsICYmIGxhc3RQcmljZSE9bnVsbCl7CiAgICAgICAgICBjb25zdCBrZXkgPSBbJ3BmJywgKHBmJiZwZi5pZCl8fCdkZWZhdWx0JywgdGlja2VyLCBpbmZvLmtpbmRdLmpvaW4oJ3wnKTsKICAgICAgICAgIGlmKF9fc2hvdWxkTG9nQWxhcm0oa2V5LCBpbmZvLnN0YXRlKSl7IHRyeXsgd2luZG93LnNob3dUb2FzdCAmJiBzaG93VG9hc3Qoe3RpY2tlcjpyLnQsIHN0YXRlOmluZm8uc3RhdGUsIGtpbmQ6aW5mby5raW5kfSk7IH1jYXRjaChfKXt9IHRyeXsgd2luZG93LnNob3dUb2FzdCAmJiBzaG93VG9hc3Qoe3RpY2tlciwgc3RhdGU6aW5mby5zdGF0ZSwga2luZDppbmZvLmtpbmR9KTsgfWNhdGNoKF8pe30KICAgICAgICAgICAgdHJ5eyBsb2dBbGFybUV2ZW50KHtzY29wZToncG9ydGZvbGlvJywgcGZJZDoocGYmJnBmLmlkKXx8bnVsbCwgdGlja2VyLCBzdGF0ZTppbmZvLnN0YXRlLCBraW5kOmluZm8ua2luZCwgcHJpY2U6bGFzdFByaWNlLCB0YXJnZXQ6bmVhcmVzdFRhcmdldH0pOyB9Y2F0Y2goXyl7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSkoKTsKICAgIAp9CgogICAgICBjb25zdCBsb3RSb3dzQXJyID0gbG90cy5tYXAoKGwsaSk9PnsKICAgICAgICBjb25zdCB0ID0gY29tcHV0ZVRhcmdldFByaWNlKGwpOwogICAgICAgIGNvbnN0IHN0ID0gdGFyZ2V0U3RhdHVzKGwpOwogICAgICAgIGNvbnN0IGNscyA9IHN0LnN0YXRlPT09ImhpdCIgPyAoc3Qua2luZD09PSJzZWxsIj8iaGl0LXRhcmdldC1zZWxsIjoiaGl0LXRhcmdldC1idXkiKSA6IChzdC5zdGF0ZT09PSJuZWFyIiA/IChzdC5raW5kPT09InNlbGwiPyJuZWFyLXRhcmdldC1zZWxsIjoibmVhci10YXJnZXQtYnV5IikgOiAiIik7CiAgICAgICAgcmV0dXJuICgKICAgICAgICAgIGA8dHIgZGF0YS1sb3RpZD0iJHtsLmxvdElkfSIgY2xhc3M9IiR7Y2xzfSI+YCsKICAgICAgICAgICAgYDx0ZD4ke2krMX08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHtfX2VzYyhsLmRhdGV8fCIiKX08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHtfX2ZtdE51bShsLnF0eSl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19nb19mbXRDdXJyZW5jeShsLnVuaXRDb3N0LCBwZi5jdXJyZW5jeSl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19nb19mbXRDdXJyZW5jeShsLnF0eSpsLnVuaXRDb3N0LCBwZi5jdXJyZW5jeSl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPmArCiAgICAgICAgICAgICggKHQhPW51bGw/YDxzcGFuIGNsYXNzPSJzZWxsLXRhcmdldCIgc3R5bGU9ImNvbG9yOiNkYzI2MjYiPiR7X19nb19mbXRDdXJyZW5jeSh0LCBwZi5jdXJyZW5jeSl9PC9zcGFuPmA6YGApICsKICAgICAgICAgICAgICAoIChjb21wdXRlQnV5VGFyZ2V0UHJpY2UobCkhPW51bGwpP2A8ZGl2IGNsYXNzPSJidXktdGFyZ2V0IiBzdHlsZT0iY29sb3I6IzE2YTM0YSI+JHtfX2dvX2ZtdEN1cnJlbmN5KGNvbXB1dGVCdXlUYXJnZXRQcmljZShsKSwgcGYuY3VycmVuY3kpfTwvZGl2PmA6YGApICsKICAgICAgICAgICAgICAodD09bnVsbCAmJiBjb21wdXRlQnV5VGFyZ2V0UHJpY2UobCk9PW51bGw/ICfigJQnOiAnJykKICAgICAgICAgICAgKSsKICAgICAgICAgICAgYDwvdGQ+YCsKICAgICAgICAgICAgYDx0ZD4ke2xhc3RQcmljZSE9bnVsbD9fX2ZtdE51bShsYXN0UHJpY2UpOiLigJQifTwvdGQ+PHRkPiR7KCgpPT57IGNvbnN0IF9fcCA9IChsYXN0UHJpY2UhPW51bGw/IE51bWJlcihsYXN0UHJpY2UpIDogbnVsbCk7IGNvbnN0IF9fdWMgPSBOdW1iZXIobC51bml0Q29zdCl8fDA7IGNvbnN0IF9fcSA9IE51bWJlcihsLnF0eSl8fDA7IGNvbnN0IF9fcGwgPSAoX19wIT1udWxsICYmIGlzRmluaXRlKF9fcCkpID8gKF9fcSooX19wLV9fdWMpKSA6IG51bGw7IHJldHVybiAoX19wbD09bnVsbCkgPyAi4oCUIiA6ICgiPHNwYW4gY2xhc3M9JyIrKF9fcGw+PTA/Im9rLXRleHQiOiJkYW5nZXItdGV4dCIpKyInPiIrX19nb19mbXRDdXJyZW5jeShfX3BsLCBwZi5jdXJyZW5jeSkrIjwvc3Bhbj4iKTsgfSkoKX08L3RkPjx0ZD4keygoKT0+eyBjb25zdCBfX3AgPSAobGFzdFByaWNlIT1udWxsPyBOdW1iZXIobGFzdFByaWNlKSA6IG51bGwpOyBjb25zdCBfX3VjID0gTnVtYmVyKGwudW5pdENvc3QpfHwwOyBjb25zdCBfX3BjdCA9IChfX3AhPW51bGwgJiYgX191Yz4wKSA/ICgoKF9fcC1fX3VjKS9fX3VjKSoxMDApIDogbnVsbDsgcmV0dXJuIChfX3BjdD09bnVsbCkgPyAi4oCUIiA6IGZtdFBjdChfX3BjdCk7IH0pKCl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7KCgpPT57IAogIGNvbnN0IF9fY2ggPSBnZXRRdW90ZUNoYW5nZVBjdCh0aWNrZXIpOyAKICBjb25zdCBfX3RyID0gZ2V0UXVvdGVUcmVuZCh0aWNrZXIpOyAKICBjb25zdCBfX2Fycm93ID0gKF9fdHI9PT0xKT8nPHNwYW4gY2xhc3M9ImNoYW5nZS1hcnJvdyB1cCI+4payPC9zcGFuPic6KF9fdHI9PT0tMSk/JzxzcGFuIGNsYXNzPSJjaGFuZ2UtYXJyb3cgZG93biI+4pa8PC9zcGFuPic6Jyc7CiAgcmV0dXJuIChfX2NoIT1udWxsKSA/IChfX2Fycm93ICsgIjxzcGFuIGNsYXNzPSdwY3QtYmFkZ2UgIisoX19jaD49MD8icGN0LXBvcyBvay10ZXh0IjoicGN0LW5lZyBkYW5nZXItdGV4dCIpKyInPiIrZm10UGN0KF9fY2gpKyI8L3NwYW4+IikgOiAi4oCUIjsgCn0pKCl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7c3Quc3RhdGU9PT0iaGl0Ij8i8J+OryI6KHN0LnN0YXRlPT09Im5lYXIiPyLij7MiOiLigJQiKX08L3RkPmArCiAgICAgICAgICBgPHRkPjxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCBsb3QtZWRpdCIgZGF0YS10aWNrZXI9IiR7dGlja2VyfSIgZGF0YS1sb3Q9IiR7bC5sb3RJZH0iPvCfk508L2J1dHRvbj4gPGJ1dHRvbiBjbGFzcz0iYnRuIG9rIGxvdC1zZWxsIiBkYXRhLXRpY2tlcj0iJHt0aWNrZXJ9IiBkYXRhLWxvdD0iJHtsLmxvdElkfSIgZGF0YS1tYXhxdHk9IiR7bC5xdHl9Ij7wn5K4PC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCBsb3QtbXV0ZSIgZGF0YS1hY3Rpb249ImxvdC1tdXRlIiBkYXRhLXRpY2tlcj0iJHt0aWNrZXJ9IiBkYXRhLWxvdD0iJHtsLmxvdElkfSIgdGl0bGU9IiR7bC5tdXRlZD8nV8WCxIVjeiBhbGVydCc6J1d5Y2lzeiBhbGVydCd9Ij4ke2wubXV0ZWQ/J/CflJUnOifwn5SUJ308L2J1dHRvbj48L3RkPjwvdHI+YAogICAgICAgICk7CiAgICAgIH0pOwogICAgICBjb25zdCBsb3RSb3dzSFRNTCA9IGxvdFJvd3NBcnIuam9pbigiIikgfHwgJzx0ciBkYXRhLWxvdGlkPVwiJHtsb3QubG90SWR9XCI+PHRkIGNvbHNwYW49IjgiIGNsYXNzPSJjZW50ZXIgbXV0ZWQiPkJyYWsgcGFydGlpPC90ZD48L3RyPic7CgogICAgICBjb25zdCBkZXRhaWxzSFRNTCA9ICgKICAgICAgICBgPGRldGFpbHM+PHN1bW1hcnk+JHtkaXNwbGF5TmFtZX0gPGJ1dHRvbiBjbGFzcz0iYnRuIHNtYWxsIGdob3N0IGFkZC1sb3QiIGRhdGEtdGlja2VyPSIke19fZXNjKHRpY2tlcil9IiB0aXRsZT0iRG9kYWogbm93xIUgcGFydGnEmSI+4p6VPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBzbWFsbCBnaG9zdCB0cmFuc2Zlci1jb21wYW55IiBkYXRhLXRpY2tlcj0iJHtfX2VzYyh0aWNrZXIpfSIgdGl0bGU9IlByemVuaWXFmyBjYcWCxIUgc3DDs8WCa8SZIGRvIGlubmVnbyBwb3J0ZmVsYSI+8J+UhDwvYnV0dG9uPjwvc3VtbWFyeT5gKwogICAgICAgIGA8ZGl2IHN0eWxlPSJwYWRkaW5nOjhweCAwIj5gKwogICAgICAgICAgYDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPmArCiAgICAgICAgICAgIGA8dGFibGU+YCsKICAgICAgICAgICAgICBgPHRoZWFkPmArCiAgICAgICAgICAgICAgICBgPHRyPjx0aD4jPC90aD48dGg+RGF0YTwvdGg+PHRoPklsb8WbxIc8L3RoPjx0aD5Lb3N6dCAvIHN6dC48L3RoPjx0aD5XYXJ0b8WbxIcga3NpxJlnb3dhPC90aD48dGg+U3VnZXJvd2FuYSBjZW5hPC90aD48dGg+S3VyczwvdGg+PHRoPlAvTDwvdGg+PHRoPlAvTCAlPC90aD48dGg+zpQgZHppZW5ueTwvdGg+PHRoPlN0YXR1czwvdGg+PHRoPkFrY2plPC90aD48L3RyPmArCiAgICAgICAgICAgICAgYDwvdGhlYWQ+YCsKICAgICAgICAgICAgICBgPHRib2R5PiR7bG90Um93c0hUTUx9PC90Ym9keT5gKwogICAgICAgICAgICBgPC90YWJsZT5gKwogICAgICAgICAgYDwvZGl2PmArCiAgICAgICAgYDwvZGl2PmArCiAgICAgICAgYDwvZGV0YWlscz5gCiAgICAgICk7CgogICAgICBfX3Jvd3MucHVzaCh7IGRpc3Q6IG5lYXJlc3REaXN0LCBodG1sOiBgPHRib2R5PmArCiAgICAgICAgICBgPHRyIGNsYXNzPSIke3N0YXR1c0NsYXNzfSI+YCsKICAgICAgICAgICAgYDx0ZCBjbGFzcz0idGlja2VyIj4ke2RldGFpbHNIVE1MfSA8L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHtfX2ZtdE51bSh0b3RhbFF0eSl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19nb19mbXRDdXJyZW5jeShhdmdDb3N0LCBwZi5jdXJyZW5jeSl9PC90ZD5gKwogICAgICAgICAgICBgPHRkPiR7X19nb19mbXRDdXJyZW5jeShjb3N0QmFzaXMsIHBmLmN1cnJlbmN5KX08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHtsYXN0UHJpY2UhPW51bGw/X19mbXROdW0obGFzdFByaWNlKToi4oCUIn08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHsoKCk9PnsgCiAgY29uc3QgX19jaCA9IGdldFF1b3RlQ2hhbmdlUGN0KHRpY2tlcik7IAogIGNvbnN0IF9fdHIgPSBnZXRRdW90ZVRyZW5kKHRpY2tlcik7IAogIGNvbnN0IF9fYXJyb3cgPSAoX190cj09PTEpPyc8c3BhbiBjbGFzcz0iY2hhbmdlLWFycm93IHVwIj7ilrI8L3NwYW4+JzooX190cj09PS0xKT8nPHNwYW4gY2xhc3M9ImNoYW5nZS1hcnJvdyBkb3duIj7ilrw8L3NwYW4+JzonJzsKICByZXR1cm4gKF9fY2ghPW51bGwpID8gKF9fYXJyb3cgKyAiPHNwYW4gY2xhc3M9J3BjdC1iYWRnZSAiKyhfX2NoPj0wPyJwY3QtcG9zIG9rLXRleHQiOiJwY3QtbmVnIGRhbmdlci10ZXh0IikrIic+IitmbXRQY3QoX19jaCkrIjwvc3Bhbj4iKSA6ICLigJQiOyAKfSkoKX08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHsoKCk9PnsgaWYobmVhcmVzdFRhcmdldD09bnVsbCkgcmV0dXJuICLigJQiOyAgbGV0IGtpbmQ9bnVsbCwgYmVzdD1JbmZpbml0eTsgIGZvcihjb25zdCBsIG9mIGxvdHMpeyAgICBjb25zdCBzPWNvbXB1dGVUYXJnZXRQcmljZShsKTsgaWYocyE9bnVsbCl7IGNvbnN0IGQ9TWF0aC5hYnMoKG5lYXJlc3RUYXJnZXQtcykvbmVhcmVzdFRhcmdldCk7IGlmKGQ8YmVzdCl7IGJlc3Q9ZDsga2luZD0nc2VsbCc7IH0gfSAgICBjb25zdCBiPWNvbXB1dGVCdXlUYXJnZXRQcmljZShsKTsgaWYoYiE9bnVsbCl7IGNvbnN0IGQ9TWF0aC5hYnMoKG5lYXJlc3RUYXJnZXQtYikvbmVhcmVzdFRhcmdldCk7IGlmKGQ8YmVzdCl7IGJlc3Q9ZDsga2luZD0nYnV5JzsgfSB9ICB9ICBjb25zdCBsYmwgPSBraW5kPT09J3NlbGwnPydjZWwgc3ByemVkYcW8eSc6KGtpbmQ9PT0nYnV5Jz8nY2VsIHpha3VwdSc6JycpOyAgcmV0dXJuIF9fZ29fZm10Q3VycmVuY3kobmVhcmVzdFRhcmdldCwgcGYuY3VycmVuY3kpICsgKGxibD9gPGRpdiBjbGFzcz0ic21hbGwiIHN0eWxlPSJvcGFjaXR5Oi43NTsgJHtraW5kPT09J3NlbGwnPydjb2xvcjojMTZhMzRhJzooa2luZD09PSdidXknPydjb2xvcjojZGMyNjI2JzonJyl9Ij4ke2xibH08L2Rpdj5gOiIiKTsgfSkoKX08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+JHsoKCk9PnsgY29uc3QgcD1sYXN0UHJpY2U7IGNvbnN0IHQ9bmVhcmVzdFRhcmdldDsgaWYocD09bnVsbHx8dD09bnVsbHx8dDw9MCkgcmV0dXJuICLigJQiOyBjb25zdCBkaXN0ID0gTWF0aC5hYnMocCAtIHQpIC8gdDsgY29uc3QgcGN0U3RyID0gKGRpc3QqMTAwKS50b0ZpeGVkKDIpICsgIiUiOyBjb25zdCBsb2NhbFRvbCA9IChOdW1iZXIoREIuc2V0dGluZ3MuYXBwcm9hY2hUb2xlcmFuY2VQY3QpfHwxKS8xMDA7IGNvbnN0IGNscyA9IChkaXN0PD0xZS02KSA/ICJvay10ZXh0IiA6IChkaXN0IDw9IChsb2NhbFRvbC8yKSA/ICJ3YXJuLXN0cm9uZy10ZXh0IiA6ICJ3YXJuLXRleHQiKTsgcmV0dXJuIGA8c3BhbiBjbGFzcz0iJHtjbHN9Ij4ke3BjdFN0cn08L3NwYW4+YDsgfSkoKX08L3RkPmArCiAgICAgICAgICAgIGA8dGQ+PHNwYW4gY2xhc3M9InNtYWxsIj4ke3N0YXR1c0NsYXNzPyAoc3RhdHVzQ2xhc3M9PT0iaGl0LXRhcmdldCI/IvCfjq8gY2VsIG9zacSFZ25pxJl0eSI6IuKPsyBibGlza28gY2VsdSIpOiLigJQifTwvc3Bhbj48L3RkPmArCiAgICAgICAgICAgIGA8dGQgY2xhc3M9InJvdyIgc3R5bGU9ImdhcDo2cHgiPjxidXR0b24gY2xhc3M9ImJ0biBkYW5nZXIgZGVsLWNvbXBhbnkiIGRhdGEtdGlja2VyPSIke19fZXNjKHRpY2tlcil9Ij7wn5eRPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCB0di1saW5rIiBkYXRhLXRpY2tlcj0iJHtfX2VzYyh0aWNrZXIpfSIgdGl0bGU9IlRyYWRpbmdWaWV3Ij7wn5OIPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCBpbmZvLWNvbXBhbnkiIGRhdGEtdGlja2VyPSIke19fZXNjKHRpY2tlcil9Ij7ihLnvuI88L2J1dHRvbj48L3RkPmArCiAgICAgICAgICBgPC90cj5gKwogICAgICAgIGA8L3Rib2R5PmAKICAgICAgfSk7CiAgICB9CiAgICAvKiBzb3J0IGJ5IG5lYXJlc3QgdGFyZ2V0IGRpc3RhbmNlICovCiAgICBpZihfX3Jvd3MubGVuZ3RoKXsKICAgICAgX19yb3dzLnNvcnQoKGEsYik9PnsKICAgICAgICBjb25zdCBhZCA9IChhLmRpc3Q9PW51bGx8fCFpc0Zpbml0ZShhLmRpc3QpKT9JbmZpbml0eTphLmRpc3Q7CiAgICAgICAgY29uc3QgYmQgPSAoYi5kaXN0PT1udWxsfHwhaXNGaW5pdGUoYi5kaXN0KSk/SW5maW5pdHk6Yi5kaXN0OwogICAgICAgIHJldHVybiBhZCAtIGJkOwogICAgICB9KTsKICAgICAgZm9yKGNvbnN0IHIgb2YgX19yb3dzKXsgc2VjdGlvbnMucHVzaChyLmh0bWwpOyB9CiAgICB9CiAgICBjb25zdCBzZWN0aW9uc0hUTUwgPSBzZWN0aW9ucy5qb2luKCIiKSB8fCAnPHRib2R5Pjx0cj48dGQgY29sc3Bhbj0iOCIgY2xhc3M9ImNlbnRlciBtdXRlZCI+QnJhayBwb3p5Y2ppPC90ZD48L3RyPjwvdGJvZHk+JzsKICAgIGNvbnN0IGggPSAoCiAgICAgIGA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj5gKwogICAgICAgIGA8dGFibGU+YCsKICAgICAgICAgIGA8dGhlYWQ+YCsKICAgICAgICAgICAgYDx0cj5gKwogICAgICAgICAgICAgIGA8dGg+VGlja2VyPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+SWxvxZvEhzwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPsWaci4ga29zenQgLyBzenQuPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+V2FydG/Fm8SHIGtzacSZZ293YTwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPkt1cnM8L3RoPjx0aD7OlCBkemllbm55PC90aD5gKwogICAgICAgICAgICAgIGA8dGg+TmFqYmxpxbxzenkgY2VsPC90aD48dGg+UG96b3N0YcWCbyBkbyBjZWx1PC90aD5gKwogICAgICAgICAgICAgIGA8dGg+U3RhdHVzPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+QWtjamU8L3RoPmArCiAgICAgICAgICAgIGA8L3RyPmArCiAgICAgICAgICBgPC90aGVhZD5gKwogICAgICAgICAgc2VjdGlvbnNIVE1MKwogICAgICAgIGA8L3RhYmxlPmArCiAgICAgIGA8L2Rpdj5gCiAgICApOwogICAgcmV0dXJuIGg7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUZpbHRlcihxKXsKICAgIC8vIFNpbXBsZSBmaWx0ZXIgcGFyc2VyOiAidHlwOnNlbGwgVFNMQSAyMDI1LTA5IgogICAgcSA9IChxfHwiIikudHJpbSgpOwogICAgY29uc3QgcGFydHMgPSBxLnNwbGl0KC9ccysvKS5maWx0ZXIoQm9vbGVhbik7CiAgICBjb25zdCBmID0geyB0ZXh0OiBbXSB9OwogICAgZm9yKGNvbnN0IHAgb2YgcGFydHMpewogICAgICBjb25zdCBtID0gcC5tYXRjaCgvXnR5cDooXHcrKS9pKTsKICAgICAgaWYobSl7IGYudHlwZSA9IG1bMV0udG9Mb3dlckNhc2UoKTsgY29udGludWU7IH0KICAgICAgZi50ZXh0LnB1c2gocC50b0xvd2VyQ2FzZSgpKTsKICAgIH0KICAgIHJldHVybiBmOwogIH0KCiAgCiAgZnVuY3Rpb24gYnVpbGRUeFRhYmxlSFRNTChwZiwgZmlsdGVyUSl7CiAgICBjb25zdCBmID0gcGFyc2VGaWx0ZXIoZmlsdGVyUSk7CiAgICBjb25zdCByb3dzQXJyID0gW107CiAgICBjb25zdCB0eHMgPSBwZi50cmFuc2FjdGlvbnM7CiAgICBmb3IoY29uc3QgdCBvZiB0eHMpewogICAgICBpZihmLnR5cGUgJiYgdC50eXBlIT09Zi50eXBlKSBjb250aW51ZTsKICAgICAgY29uc3QgdGV4dEJsb2IgPSBKU09OLnN0cmluZ2lmeSh0KS50b0xvd2VyQ2FzZSgpOwogICAgICBpZihmLnRleHQ/Lmxlbmd0aCl7CiAgICAgICAgbGV0IG9rID0gdHJ1ZTsKICAgICAgICBmb3IoY29uc3Qgd29yZCBvZiBmLnRleHQpewogICAgICAgICAgaWYoIXRleHRCbG9iLmluY2x1ZGVzKHdvcmQpKXsgb2s9ZmFsc2U7IGJyZWFrOyB9CiAgICAgICAgfQogICAgICAgIGlmKCFvaykgY29udGludWU7CiAgICAgIH0KICAgICAgcm93c0Fyci5wdXNoKHR4Um93SFRNTChwZiwgdCkpOwogICAgfQogICAgY29uc3Qgcm93c0hUTUwgPSByb3dzQXJyLmpvaW4oIiIpIHx8ICc8dHI+PHRkIGNvbHNwYW49IjExIiBjbGFzcz0iY2VudGVyIG11dGVkIj5CcmFrIG9wZXJhY2ppPC90ZD48L3RyPic7CiAgICBjb25zdCBoID0gKAogICAgICBgPGRpdiBjbGFzcz0idGFibGUtd3JhcCI+YCsKICAgICAgICBgPHRhYmxlPmArCiAgICAgICAgICBgPHRoZWFkPmArCiAgICAgICAgICAgIGA8dHI+YCsKICAgICAgICAgICAgICBgPHRoPkRhdGE8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5UeXA8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5UaWNrZXI8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5JbG/Fm8SHPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+Q2VuYTwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPk9wxYJhdHk8L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5Hb3TDs3drYSDCsTwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPlp5c2sgYnJ1dHRvPC90aD5gKwogICAgICAgICAgICAgIGA8dGg+UG9kYXRlazwvdGg+YCsKICAgICAgICAgICAgICBgPHRoPlp5c2sgbmV0dG88L3RoPmArCiAgICAgICAgICAgICAgYDx0aD5Vd2FnaTwvdGg+PHRoPkFrY2plPC90aD5gKwogICAgICAgICAgICBgPC90cj5gKwogICAgICAgICAgYDwvdGhlYWQ+YCsKICAgICAgICAgIGA8dGJvZHk+YCsgcm93c0hUTUwgKyBgPC90Ym9keT5gKwogICAgICAgIGA8L3RhYmxlPmArCiAgICAgIGA8L2Rpdj5gCiAgICApOwogICAgcmV0dXJuIGg7CiAgfQoKICBmdW5jdGlvbiB0eFJvd0hUTUwocGYsIHQpewogICAgY29uc3QgY3VyID0gcGYuY3VycmVuY3k7CiAgICBsZXQgY2FzaERlbHRhID0gMDsKICAgIGlmKHQudHlwZT09PSJkZXBvc2l0IikgY2FzaERlbHRhID0gdC5hbW91bnQ7CiAgICBpZih0LnR5cGU9PT0id2l0aGRyYXciKSBjYXNoRGVsdGEgPSAtdC5hbW91bnQ7CiAgICBpZih0LnR5cGU9PT0iYnV5IikgY2FzaERlbHRhID0gLSh0LnF0eSp0LnByaWNlICsgKHQuZmVlc3x8MCkpOwogICAgaWYodC50eXBlPT09InNlbGwiKSBjYXNoRGVsdGEgPSAodC5wcm9jZWVkcyB8fCB0LnF0eSp0LnByaWNlKSAtICh0LmZlZXN8fDApOwogICAgaWYodC50eXBlPT09InRyYW5zZmVyX2luIikgY2FzaERlbHRhID0gdC5hbW91bnQ7CiAgICBpZih0LnR5cGU9PT0idHJhbnNmZXJfb3V0IikgY2FzaERlbHRhID0gLXQuYW1vdW50OwoKICAgIHJldHVybiBgPHRyIGRhdGEtdHg9IiR7dC5pZH0iIGNsYXNzPSJ0eC1yb3ciIHN0eWxlPSJjdXJzb3I6cG9pbnRlciI+CiAgICAgIDx0ZD4ke19fZXNjKHQuZGF0ZXx8IiIpfTwvdGQ+CiAgICAgIDx0ZD4ke21hcFR5cGUodC50eXBlKX08L3RkPgogICAgICA8dGQgY2xhc3M9InRpY2tlciI+JHtfX2VzYyh0LnRpY2tlcnx8IiIpfTwvdGQ+CiAgICAgIDx0ZD4ke3QucXR5P19fZm10TnVtKHQucXR5KToi4oCUIn08L3RkPgogICAgICA8dGQ+JHt0LnByaWNlP19fZ29fZm10Q3VycmVuY3kodC5wcmljZSwgY3VyKTogKHQuYW1vdW50P19fZ29fZm10Q3VycmVuY3kodC5hbW91bnQsIGN1cik6IuKAlCIpfTwvdGQ+CiAgICAgIDx0ZD4ke3QuZmVlcz9fX2dvX2ZtdEN1cnJlbmN5KHQuZmVlcywgY3VyKToi4oCUIn08L3RkPgogICAgICA8dGQ+JHtfX2dvX2ZtdEN1cnJlbmN5KGNhc2hEZWx0YSwgY3VyKX08L3RkPgogICAgICA8dGQgY2xhc3M9IiR7KHQuZ3Jvc3NQTD8/MCk+PTAgPyAnb2stdGV4dCc6J2Rhbmdlci10ZXh0J30iPiR7dC5ncm9zc1BMIT09dW5kZWZpbmVkP19fZ29fZm10Q3VycmVuY3kodC5ncm9zc1BMLCBjdXIpOiLigJQifTwvdGQ+CiAgICAgIDx0ZD4ke3QudGF4IT09dW5kZWZpbmVkP19fZ29fZm10Q3VycmVuY3kodC50YXgsIGN1cik6IuKAlCJ9PC90ZD4KICAgICAgPHRkIGNsYXNzPSIkeyh0Lm5ldFBMPz8wKT49MCA/ICdvay10ZXh0JzonZGFuZ2VyLXRleHQnfSI+JHt0Lm5ldFBMIT09dW5kZWZpbmVkP19fZ29fZm10Q3VycmVuY3kodC5uZXRQTCwgY3VyKToi4oCUIn08L3RkPgogICAgICA8dGQgY2xhc3M9Im5vdGUiPiR7X19lc2ModC5ub3RlfHwiIil9PC90ZD4KICAgICAgPHRkPgogICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCB0eC1lZGl0IiBkYXRhLXR4PSIke3QuaWR9Ij7wn5OdPC9idXR0b24+CiAgICAgICAgJHt0LnR5cGU9PT0nYnV5Jz9gPGJ1dHRvbiBjbGFzcz0iYnRuIG9rIHR4LXNlbGwtZnJvbS1idXkiIGRhdGEtdHg9IiR7dC5pZH0iPvCfkrg8L2J1dHRvbj5gOicnfQogICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkYW5nZXIgdHgtZGVsIiBkYXRhLXR4PSIke3QuaWR9Ij7inYw8L2J1dHRvbj4KICAgICAgPC90ZD4KICAgIDwvdHI+YDsKICB9CiAgLy8gLS0gSW50ZWdyaXR5OiBrZWVwIHRyYW5zYWN0aW9ucyBhcnJheSB2YWxpZCAmIHNvcnRlZCAoZGVzYyBieSBkYXRlKSAtLQogIGZ1bmN0aW9uIGVuc3VyZVRyYW5zYWN0aW9uc0NvaGVyZW50KHBmKXsKICAgIHRyeXsKICAgICAgaWYoIXBmIHx8ICFBcnJheS5pc0FycmF5KHBmLnRyYW5zYWN0aW9ucykpIHsgcGYudHJhbnNhY3Rpb25zID0gW107IHJldHVybjsgfQogICAgICAvLyBkcm9wIG51bGwvdW5kZWZpbmVkCiAgICAgIHBmLnRyYW5zYWN0aW9ucyA9IHBmLnRyYW5zYWN0aW9ucy5maWx0ZXIodCA9PiB0ICYmIHR5cGVvZiB0ID09PSAnb2JqZWN0Jyk7CiAgICAgIC8vIG5vcm1hbGl6ZSBkYXRlIHN0cmluZ3MgYW5kIHNvcnQgbmV3ZXN0LWZpcnN0CiAgICAgIHBmLnRyYW5zYWN0aW9ucy5zb3J0KChhLGIpPT57CiAgICAgICAgY29uc3QgYWQgPSBEYXRlLnBhcnNlKGEuZGF0ZSB8fCAnMTk3MC0wMS0wMScpOwogICAgICAgIGNvbnN0IGJkID0gRGF0ZS5wYXJzZShiLmRhdGUgfHwgJzE5NzAtMDEtMDEnKTsKICAgICAgICByZXR1cm4gYmQgLSBhZDsKICAgICAgfSk7CiAgICB9Y2F0Y2goXyl7fQogIH0KCiAgLy8gLS0gVUkgaGVscGVyOiBzaG93IHdhcm5pbmcgYmFubmVyIG9uY2UgcGVyIHBhZ2UgbG9hZAogIGxldCBfX3R4V2FyblNob3duID0gZmFsc2U7CiAgZnVuY3Rpb24gbWF5YmVXYXJuVHhMb3NzKHBmKXsKICAgIHRyeXsKICAgICAgaWYoIXBmKSByZXR1cm47CiAgICAgIGNvbnN0IEtFWSA9ICdfX3R4Q291bnRfJytwZi5pZDsKICAgICAgY29uc3QgcHJldiA9IE51bWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLRVkpIHx8ICcwJyk7CiAgICAgIGNvbnN0IGN1ciA9IEFycmF5LmlzQXJyYXkocGYudHJhbnNhY3Rpb25zKSA/IHBmLnRyYW5zYWN0aW9ucy5sZW5ndGggOiAwOwogICAgICAvLyBJZiBpdCBsb29rcyBsaWtlIHdlIGxvc3QgdHJhbnNhY3Rpb25zLCBudWRnZSB0byB1c2UgVW5kbwogICAgICBpZihwcmV2ICYmIGN1ciA8IHByZXYgJiYgIV9fdHhXYXJuU2hvd24pewogICAgICAgIF9fdHhXYXJuU2hvd24gPSB0cnVlOwogICAgICAgIGNvbnN0IHcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICB3LmNsYXNzTmFtZSA9ICdiYW5uZXIgd2Fybic7CiAgICAgICAgdy5pbm5lckhUTUwgPSAn4pqg77iPIFd5a3J5dG8gc3BhZGVrIGxpY3pieSB0cmFuc2FrY2ppICgnK2N1cisnIHogJytwcmV2KycpLiA8YnV0dG9uIGNsYXNzPSJidG4gc21hbGwiIGlkPSJ0eFVuZG9Ob3ciPkNvZm5pajwvYnV0dG9uPic7CiAgICAgICAgY29uc3QgaGlzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaXN0b3J5UGFuZWwnKTsKICAgICAgICAoaGlzdD8ucGFyZW50RWxlbWVudCB8fCBkb2N1bWVudC5ib2R5KS5pbnNlcnRCZWZvcmUodywgaGlzdCk7CiAgICAgICAgY29uc3QgYnRuID0gdy5xdWVyeVNlbGVjdG9yKCcjdHhVbmRvTm93Jyk7CiAgICAgICAgaWYoYnRuKXsgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgdHJ5eyB1bmRvKHttb2RlOid0eCd9KTsgfWNhdGNoKF8peyBhbGVydCgiU3Byw7NidWogcsSZY3puaWUga2xpa27EhcSHIENvZm5paiAoQ3RybCtaKSIpOyB9IH0pOyB9CiAgICAgICAgc2V0VGltZW91dCgoKT0+eyB3LnJlbW92ZSgpOyB9LCAxMjAwMCk7CiAgICAgIH0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oS0VZLCBTdHJpbmcoY3VyKSk7CiAgICB9Y2F0Y2goXyl7fQogIH0KCgogIGZ1bmN0aW9uIG1hcFR5cGUodCl7CiAgICByZXR1cm4gewogICAgICBkZXBvc2l0OiJ3cMWCYXRhIiwKICAgICAgd2l0aGRyYXc6Ind5cMWCYXRhIiwKICAgICAgdHJhbnNmZXJfaW46InByemVsZXcg4oCUIHByenljaMOzZCIsCiAgICAgIHRyYW5zZmVyX291dDoicHJ6ZWxldyDigJQgcm96Y2jDs2QiLAogICAgICB0cmFuc2Zlcl9jb21wYW55X2luOiJ0cmFuc2ZlciBzcMOzxYJraSDigJQgcHJ6eWNow7NkIiwKICAgIHRyYW5zZmVyX2NvbXBhbnlfb3V0OiJ0cmFuc2ZlciBzcMOzxYJraSDigJQgcm96Y2jDs2QiLAogICAgYnV5OiJ6YWt1cCIsCiAgICAgIHNlbGw6InNwcnplZGHFvCIsCiAgICB9W3RdIHx8IHQ7CiAgfQoKICBmdW5jdGlvbiB0b2RheSgpewogICAgcmV0dXJuIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKTsKICB9CgogIGZ1bmN0aW9uIF9fZXNjKHMpewogICAgcmV0dXJuIChzfHwiIikucmVwbGFjZSgvWyY8PiInXS9nLCBtPT4gKHsnJic6JyZhbXA7JywnPCc6JyZsdDsnLCc+JzonJmd0OycsJyInOicmcXVvdDsnLCInIjonJiMzOTsnfVttXSkpOwogIH0KICBjb25zdCBRVU9URVMgPSB7fTsKY29uc3QgQ09NUEFOWV9OQU1FUyA9IHt9OyAvLyB0aWNrZXIgLT4ge25hbWUsIHRzfQogLy8gdGlja2VyIC0+IHtwcmljZSwgdHN9CiAgbGV0IHF1b3RlVGltZXIgPSBudWxsOwogIGxldCBpc1BvbGxpbmdRdW90ZXMgPSBmYWxzZTsKbGV0IF9fcG9sbGVyU3RhcnRlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiBzZXRRdW90ZSh0aWNrZXIsIHByaWNlLCBleHRyYXMpewogIHRyeXsKICAgIGNvbnN0IHByZXYgPSBRVU9URVNbdGlja2VyXSB8fCB7Cn07CiAgICBjb25zdCBuZXdQcmljZSA9IE51bWJlcihwcmljZSkgfHwgbnVsbDsKICAgIGNvbnN0IHByZXZQcmljZSA9IChwcmV2ICYmIHR5cGVvZiBwcmV2LnByaWNlICE9PSAndW5kZWZpbmVkJykgPyBwcmV2LnByaWNlIDogbnVsbDsKICAgIGxldCB0cmVuZCA9IG51bGw7CiAgICBpZihuZXdQcmljZSAhPSBudWxsICYmIHByZXZQcmljZSAhPSBudWxsKXsKICAgICAgdHJlbmQgPSAobmV3UHJpY2UgPiBwcmV2UHJpY2UpID8gMSA6IChuZXdQcmljZSA8IHByZXZQcmljZSA/IC0xIDogMCk7CiAgICB9CiAgICBRVU9URVNbdGlja2VyXSA9IHsKICAgICAgcHJpY2U6IG5ld1ByaWNlLAogICAgICBwcmV2UHJpY2U6IHByZXZQcmljZSA/PyBudWxsLAogICAgICB0cmVuZDogdHJlbmQsCiAgICAgIHRzOiBEYXRlLm5vdygpLAogICAgICBwYzogKGV4dHJhcyAmJiBleHRyYXMucGMgIT0gbnVsbCkgPyBOdW1iZXIoZXh0cmFzLnBjKSA6IChwcmV2LnBjID8/IG51bGwpLAogICAgICBkcDogKGV4dHJhcyAmJiBleHRyYXMuZHAgIT0gbnVsbCkgPyBOdW1iZXIoZXh0cmFzLmRwKSA6IChwcmV2LmRwID8/IG51bGwpLAogICAgICBkOiAgKGV4dHJhcyAmJiBleHRyYXMuZCAgIT0gbnVsbCkgPyBOdW1iZXIoZXh0cmFzLmQpICA6IChwcmV2LmQgID8/IG51bGwpLAogICAgfTsKICB9Y2F0Y2goXyl7CiAgICBRVU9URVNbdGlja2VyXSA9IHsgcHJpY2U6IE51bWJlcihwcmljZSl8fG51bGwsIHByZXZQcmljZTogbnVsbCwgdHJlbmQ6IG51bGwsIHRzOiBEYXRlLm5vdygpIH07CiAgfQogIHRyeXsgaWYodHlwZW9mIG1heWJlU2NhbkFsYXJtc0dsb2JhbD09PSdmdW5jdGlvbicpIG1heWJlU2NhbkFsYXJtc0dsb2JhbCgpOyB9Y2F0Y2goXyl7IH0KfQogIGZ1bmN0aW9uIGdldFF1b3RlKHRpY2tlcil7CiAgcmV0dXJuIFFVT1RFU1t0aWNrZXJdPy5wcmljZSA/PyBudWxsOwp9CgpmdW5jdGlvbiBzZXRDb21wYW55TmFtZSh0aWNrZXIsIG5hbWUpewogIHRyeXsKICAgIGlmKCF0aWNrZXIgfHwgIW5hbWUpIHJldHVybjsKICAgIGNvbnN0IHQgPSBTdHJpbmcodGlja2VyKS50b1VwcGVyQ2FzZSgpOwogICAgQ09NUEFOWV9OQU1FU1t0XSA9IHtuYW1lOiBTdHJpbmcobmFtZSksIHRzOiBEYXRlLm5vdygpfTsKICB9Y2F0Y2goXyl7fQp9CmZ1bmN0aW9uIGdldENvbXBhbnlOYW1lKHRpY2tlcil7CiAgdHJ5ewogICAgY29uc3QgdCA9IFN0cmluZyh0aWNrZXIpLnRvVXBwZXJDYXNlKCk7CiAgICByZXR1cm4gKENPTVBBTllfTkFNRVNbdF0gJiYgQ09NUEFOWV9OQU1FU1t0XS5uYW1lKSB8fCBudWxsOwogIH1jYXRjaChfKXsgcmV0dXJuIG51bGw7IH0KfQoKCmZ1bmN0aW9uIGdldFF1b3RlUHJldkNsb3NlKHRpY2tlcil7CiAgcmV0dXJuIFFVT1RFU1t0aWNrZXJdPy5wYyA/PyBudWxsOwp9CmZ1bmN0aW9uIGdldFF1b3RlQ2hhbmdlUGN0KHRpY2tlcil7CiAgY29uc3QgcSA9IFFVT1RFU1t0aWNrZXJdOwogIGlmKCFxKSByZXR1cm4gbnVsbDsKICBpZihOdW1iZXIuaXNGaW5pdGUocS5kcCkpIHJldHVybiBxLmRwOwogIGNvbnN0IGMgPSBxLnByaWNlLCBwYyA9IHEucGM7CiAgaWYoYyE9bnVsbCAmJiBwYz4wKSByZXR1cm4gKChjIC0gcGMpIC8gcGMpICogMTAwOwogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGdldFF1b3RlVHJlbmQodGlja2VyKXsKICByZXR1cm4gUVVPVEVTW3RpY2tlcl0/LnRyZW5kID8/IG51bGw7Cn0KCmNvbnN0IGZtdFBjdCA9ICh4LCBkPTIpPT4gKHg9PT1udWxsIHx8IHg9PT11bmRlZmluZWQgfHwgaXNOYU4oTnVtYmVyKHgpKSkgPyAi4oCUIiA6ICgoTnVtYmVyKHgpPj0wPyIrIjoiIikgKyBOdW1iZXIoeCkudG9GaXhlZChkKSArICIlIik7CiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hRdW90ZUZpbm5odWIodGlja2VyLCB0b2tlbk92ZXJyaWRlKXsKICBjb25zdCB0b2tlbiA9IHRva2VuT3ZlcnJpZGUgfHwgREIuc2V0dGluZ3MuZmlubmh1YlRva2VuIHx8ICIiOwogIGlmKCF0b2tlbil7IHJldHVybiB7cHJpY2U6bnVsbCwgZXJyb3I6J0JyYWsgdG9rZW51ICjimpnvuI8gVXN0YXdpZW5pYSknfTsgfQogIHRyeXsKICAgIGNvbnN0IHVybCA9IGBodHRwczovL2Zpbm5odWIuaW8vYXBpL3YxL3F1b3RlP3N5bWJvbD0ke2VuY29kZVVSSUNvbXBvbmVudCh0aWNrZXIpfSZ0b2tlbj0ke2VuY29kZVVSSUNvbXBvbmVudCh0b2tlbil9YDsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCk7CiAgICBjb25zdCBqID0gYXdhaXQgcmVzLmpzb24oKS5jYXRjaCgoKT0+KHt9KSk7CiAgICBjb25zdCBlcnIgPSBqICYmIGouZXJyb3IgPyBqLmVycm9yIDogKCFyZXMub2sgPyAoJ0hUVFAgJytyZXMuc3RhdHVzKSA6IG51bGwpOwogICAgY29uc3QgcCA9IChqICYmIChqLmMgPz8gai5wYykpID8/IG51bGw7CiAgICBpZihwIT1udWxsKSBzZXRRdW90ZSh0aWNrZXIsIHAsIHsgcGM6IGo/LnBjLCBkcDogaj8uZHAsIGQ6IGo/LmQgfSk7CiAgICByZXR1cm4ge3ByaWNlOiBwLCBlcnJvcjogZXJyfTsKICB9Y2F0Y2goZSl7IHJldHVybiB7cHJpY2U6bnVsbCwgZXJyb3I6IGUubWVzc2FnZXx8J0ZldGNoIGVycm9yJ307IH0KfQoKYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21wYW55UHJvZmlsZSh0aWNrZXIsIHRva2VuT3ZlcnJpZGUpewogIGNvbnN0IHRva2VuID0gdG9rZW5PdmVycmlkZSB8fCAoREIgJiYgREIuc2V0dGluZ3MgJiYgREIuc2V0dGluZ3MuZmlubmh1YlRva2VuKSB8fCAiIjsKICBpZighdG9rZW4peyByZXR1cm4ge25hbWU6bnVsbCwgZXJyb3I6J0JyYWsgdG9rZW51J307IH0KICB0cnl7CiAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9maW5uaHViLmlvL2FwaS92MS9zdG9jay9wcm9maWxlMj9zeW1ib2w9JHtlbmNvZGVVUklDb21wb25lbnQodGlja2VyKX0mdG9rZW49JHtlbmNvZGVVUklDb21wb25lbnQodG9rZW4pfWA7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgY29uc3QgaiA9IGF3YWl0IHJlcy5qc29uKCkuY2F0Y2goKCk9Pih7fSkpOwogICAgY29uc3QgZXJyID0gaiAmJiBqLmVycm9yID8gai5lcnJvciA6ICghcmVzLm9rID8gKCdIVFRQICcrcmVzLnN0YXR1cykgOiBudWxsKTsKICAgIGNvbnN0IG5hbWUgPSAoaiAmJiBqLm5hbWUpIHx8IG51bGw7CiAgICByZXR1cm4ge25hbWUsIGVycm9yOiBlcnJ9OwogIH1jYXRjaChlKXsgcmV0dXJuIHtuYW1lOm51bGwsIGVycm9yOiBlICYmIGUubWVzc2FnZSB8fCAnRmV0Y2ggZXJyb3InfTsgfQp9CgoKCiAgYXN5bmMgZnVuY3Rpb24gc2VhcmNoU3ltYm9sRmlubmh1YihxdWVyeSl7CiAgY29uc3QgdG9rZW4gPSAoREIgJiYgREIuc2V0dGluZ3MgJiYgREIuc2V0dGluZ3MuZmlubmh1YlRva2VuV2lzaGxpc3QpIHx8IChEQiAmJiBEQi5zZXR0aW5ncyAmJiBEQi5zZXR0aW5ncy5maW5uaHViVG9rZW4pIHx8ICcnOwogIGlmKCF0b2tlbil7IHJldHVybiB7cmVzdWx0OltdLCBlcnJvcjonQnJhayB0b2tlbnUgKOKame+4jyBVc3Rhd2llbmlhKSd9OyB9CiAgdHJ5ewogICAgY29uc3QgdXJsID0gYGh0dHBzOi8vZmlubmh1Yi5pby9hcGkvdjEvc2VhcmNoP3E9JHtlbmNvZGVVUklDb21wb25lbnQocXVlcnkpfSZ0b2tlbj0ke2VuY29kZVVSSUNvbXBvbmVudCh0b2tlbil9YDsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybCk7CiAgICBjb25zdCBqID0gYXdhaXQgcmVzLmpzb24oKS5jYXRjaCgoKT0+KHt9KSk7CiAgICBjb25zdCBlcnIgPSBqICYmIGouZXJyb3IgPyBqLmVycm9yIDogKCFyZXMub2sgPyAoJ0hUVFAgJytyZXMuc3RhdHVzKSA6IG51bGwpOwogICAgY29uc3QgYXJyID0gQXJyYXkuaXNBcnJheShqLnJlc3VsdCkgPyBqLnJlc3VsdCA6IFtdOwogICAgYXJyLmZvckVhY2goaXRlbSA9PiB7CiAgICAgIGlmKGl0ZW0gJiYgaXRlbS5zeW1ib2wgJiYgaXRlbS5kZXNjcmlwdGlvbil7CiAgICAgICAgc2V0Q29tcGFueU5hbWUoU3RyaW5nKGl0ZW0uc3ltYm9sKS50b1VwcGVyQ2FzZSgpLCBpdGVtLmRlc2NyaXB0aW9uKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4ge3Jlc3VsdDogYXJyLCBlcnJvcjogZXJyfTsKICB9Y2F0Y2goZSl7IHJldHVybiB7cmVzdWx0OltdLCBlcnJvcjogZSAmJiBlLm1lc3NhZ2UgfHwgJ1NlYXJjaCBlcnJvcid9OyB9Cn0KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIGZvciBhIHNpbmdsZSwgcmF0ZS1saW1pdGVkIGZldGNoIGxvb3AKYXN5bmMgZnVuY3Rpb24gcnVuU2VxdWVudGlhbEZldGNoZXModGlja2VycywgdG9rZW4sIGRlbGF5TXMgPSAxMjAwKSB7CiAgICBpZiAoIXRva2VuIHx8ICF0aWNrZXJzLmxlbmd0aCkgewogICAgICAgIHJldHVybjsgLy8gTm90aGluZyB0byBkbwogICAgfQogICAgY29uc3QgdW5pcXVlVGlja2VycyA9IEFycmF5LmZyb20obmV3IFNldCh0aWNrZXJzKSk7CgogICAgZm9yIChjb25zdCB0IG9mIHVuaXF1ZVRpY2tlcnMpIHsKICAgICAgICAvLyBQYXNzIHRoZSBzcGVjaWZpYyB0b2tlbiB0byB0aGUgZmV0Y2ggZnVuY3Rpb25zCiAgICAgICAgYXdhaXQgZmV0Y2hRdW90ZUZpbm5odWIodCwgdG9rZW4pOyAKCiAgICAgICAgaWYgKCFDT01QQU5ZX05BTUVTW3RdIHx8IChEYXRlLm5vdygpIC0gQ09NUEFOWV9OQU1FU1t0XS50cyA+IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IGF3YWl0IGZldGNoQ29tcGFueVByb2ZpbGUodCwgdG9rZW4pOyAKICAgICAgICAgICAgICAgIGlmIChwcm9maWxlICYmIHByb2ZpbGUubmFtZSkgc2V0Q29tcGFueU5hbWUodCwgcHJvZmlsZS5uYW1lKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgICB9CiAgICAgICAgLy8gWmFjaG93dWplbXkgb3J5Z2luYWxuZSBvcMOzxbpuaWVuaWUgMS4ycywgYWJ5IG5pZSBwcnpla3JvY3p5xIcgbGltaXR1IDYwL21pbiBkbGEgSkVETkVHTyBrbHVjemEKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXlNcykpOyAKICAgIH0KfQoKZnVuY3Rpb24gc3RhcnRQb2xsaW5nUXVvdGVzKCl7CiAgaWYoX19wb2xsZXJTdGFydGVkKXsgcmV0dXJuOyB9IF9fcG9sbGVyU3RhcnRlZCA9IHRydWU7CiAgbGV0IHNlY3MgPSBOdW1iZXIoREIuc2V0dGluZ3MucHJpY2VQb2xsU2Vjb25kcyl8fDMwOwogIGlmKHNlY3MgPCAxMCkgc2VjcyA9IDEwOwogIGlmKHF1b3RlVGltZXIpIGNsZWFySW50ZXJ2YWwocXVvdGVUaW1lcik7CgogIGNvbnN0IGRvUG9sbCA9IGFzeW5jICgpPT57CiAgICBpZiAoaXNQb2xsaW5nUXVvdGVzKSByZXR1cm47CiAgICBpc1BvbGxpbmdRdW90ZXMgPSB0cnVlOwogICAgdHJ5IHsKICAgICAgICAvLyAxLiBQb2R6aWVsIHRpY2tlcnkgbmEgZHdpZSBncnVweQogICAgICAgIGNvbnN0IHBvcnRmb2xpb1RpY2tlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQoCiAgICAgICAgICAgIERCLnBvcnRmb2xpb3MuZmxhdE1hcChwZiA9PiBPYmplY3Qua2V5cyhwZi5ob2xkaW5ncyB8fCB7fSkpCiAgICAgICAgKSk7CiAgICAgICAgY29uc3Qgd2lzaGxpc3RUaWNrZXJzID0gQXJyYXkuZnJvbShuZXcgU2V0KAogICAgICAgICAgICAoREIud2F0Y2hsaXN0IHx8IFtdKS5tYXAodyA9PiAody50aWNrZXIgfHwgIiIpLnRvVXBwZXJDYXNlKCkpCiAgICAgICAgKSk7CgogICAgICAgIC8vIDIuIFBvYmllcnogb2JhIGtsdWN6ZQogICAgICAgIGNvbnN0IHRva2VuUG9ydGZvbGlvID0gREIuc2V0dGluZ3MuZmlubmh1YlRva2VuIHx8ICIiOwogICAgICAgIGNvbnN0IHRva2VuV2lzaGxpc3QgPSBEQi5zZXR0aW5ncy5maW5uaHViVG9rZW5XaXNobGlzdCB8fCAiIjsKCiAgICAgICAgLy8gT3J5Z2luYWxuZSBvcMOzxbpuaWVuaWUgMS4ycyAoMTIwMG1zKSB6IFR3b2plZ28ga29kdQogICAgICAgIGNvbnN0IGRlbGF5ID0gMTIwMDsgCgogICAgICAgIC8vIDMuIFpkZWN5ZHVqIG8gdHJ5YmllIHd5a29uYW5pYQogICAgICAgIGlmICh0b2tlbldpc2hsaXN0ICYmIHRva2VuV2lzaGxpc3QgIT09IHRva2VuUG9ydGZvbGlvKSB7CiAgICAgICAgICAgIC8vIC0tLSBUUllCIFLDk1dOT0xFR8WBWSAtLS0KICAgICAgICAgICAgLy8gTWFteSBkd2EgcsOzxbxuZSBrbHVjemUuIFVydWNoYW1pYW15IGR3aWUgcMSZdGxlIGZldGNoIHcgdHltIHNhbXltIGN6YXNpZS4KICAgICAgICAgICAgY29uc29sZS5sb2coIkZpbm5odWI6IFVydWNoYW1pYW0gMiByw7N3bm9sZWfFgmUgcMSZdGxlIG9kxZt3aWXFvGFuaWEgKFBvcnRmZWwgKyBXaXNobGlzdGEpIik7CiAgICAgICAgICAgIGNvbnN0IHBvcnRmb2xpb1Rhc2sgPSBydW5TZXF1ZW50aWFsRmV0Y2hlcyhwb3J0Zm9saW9UaWNrZXJzLCB0b2tlblBvcnRmb2xpbywgZGVsYXkpOwogICAgICAgICAgICBjb25zdCB3aXNobGlzdFRhc2sgPSBydW5TZXF1ZW50aWFsRmV0Y2hlcyh3aXNobGlzdFRpY2tlcnMsIHRva2VuV2lzaGxpc3QsIGRlbGF5KTsKCiAgICAgICAgICAgIC8vIEN6ZWthbXkgbmEgemFrb8WEY3plbmllIG9idQogICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbcG9ydGZvbGlvVGFzaywgd2lzaGxpc3RUYXNrXSk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIC0tLSBUUllCIFNFS1dFTkNZSk5ZIC0tLQogICAgICAgICAgICAvLyBNYW15IHR5bGtvIGplZGVuIGtsdWN6IChsdWIgdGVuIHNhbSB3IG9idSBwb2xhY2gpLgogICAgICAgICAgICAvLyBVxbx5d2FteSBqZWRuZWdvIGtsdWN6YSBkbGEgd3N6eXN0a2ljaCB0aWNrZXLDs3cgdyBqZWRuZWogcMSZdGxpLgogICAgICAgICAgICBjb25zb2xlLmxvZygiRmlubmh1YjogVXJ1Y2hhbWlhbSAxIHNla3dlbmN5am7EhSBwxJl0bMSZIG9kxZt3aWXFvGFuaWEgKFdzcMOzbG55IGtsdWN6KSIpOwogICAgICAgICAgICBjb25zdCB0b2tlblRvVXNlID0gdG9rZW5Qb3J0Zm9saW8gfHwgdG9rZW5XaXNobGlzdDsgLy8gVcW8eWoga3TDs3JlZ29rb2x3aWVrLCBrdMOzcnkgaXN0bmllamUKCiAgICAgICAgICAgIC8vIMWBxIVjenlteSB3c3p5c3RraWUgdGlja2VyeSB3IGplZG7EhSBsaXN0xJkKICAgICAgICAgICAgY29uc3QgYWxsVGlja2VycyA9IEFycmF5LmZyb20obmV3IFNldChbLi4ucG9ydGZvbGlvVGlja2VycywgLi4ud2lzaGxpc3RUaWNrZXJzXSkpOwoKICAgICAgICAgICAgYXdhaXQgcnVuU2VxdWVudGlhbEZldGNoZXMoYWxsVGlja2VycywgdG9rZW5Ub1VzZSwgZGVsYXkpOwogICAgICAgIH0KCiAgICAgICAgLy8gNC4gV3N6eXN0a2llIHBvYnJhbmlhIHpha2/FhGN6b25lLCByZW5kZXJ1aiAobG9naWthIGphayB3Y3plxZtuaWVqKQogICAgICAgIHdpbmRvdy5fX2xhc3RBcGlSZWZyZXNoQXQgPSBEYXRlLm5vdygpOyAKICAgICAgICB0cnl7IGlmKHdpbmRvdy5zZXRBcGlUaW1lKSB3aW5kb3cuc2V0QXBpVGltZSh3aW5kb3cuX19sYXN0QXBpUmVmcmVzaEF0KTsgfWNhdGNoKF8pe30KICAgICAgICB0cnkgeyByZW5kZXJNYWluKCk7IH0gY2F0Y2goZSkge30KICAgICAgICB0cnkgeyByZW5kZXJXaXNobGlzdCgpOyB9IGNhdGNoKGUpIHt9CiAgICAgICAgdHJ5IHsgdXBkYXRlU2lkZWJhckJsaW5rU3RhdGVzKCk7IH0gY2F0Y2goZSkge30KICAgICAgICB0cnkgeyB1cGRhdGVXaXNobGlzdEJsaW5rU3RhdGUoKTsgfSBjYXRjaChlKSB7fQogICAgICAgIHRyeSB7IGNoZWNrQW5kUGxheVBvcnRmb2xpb0FsZXJ0cygpOyBjaGVja0FuZFBsYXlXaXNobGlzdEFsZXJ0KCk7IH0gY2F0Y2goZSkge30KCiAgICB9IGZpbmFsbHkgewogICAgICBpc1BvbGxpbmdRdW90ZXMgPSBmYWxzZTsKICAgIH0KICB9OwoKICBkb1BvbGwoKTsgLy8gVXJ1Y2hvbSBuYXR5Y2htaWFzdAogIHF1b3RlVGltZXIgPSBzZXRJbnRlcnZhbChkb1BvbGwsIHNlY3MqMTAwMCk7IC8vIEkgdXN0YXcgaW50ZXJ3YcWCCn0KCiAgZnVuY3Rpb24gY29tcHV0ZVRhcmdldFByaWNlKGxvdCl7CiAgICAvLyBTcHJ6ZWRhxbwgKHRha2UtcHJvZml0KQogICAgaWYobG90Py50YXJnZXRQcmljZSAmJiBOdW1iZXIobG90LnRhcmdldFByaWNlKT4wKSByZXR1cm4gTnVtYmVyKGxvdC50YXJnZXRQcmljZSk7CiAgICBpZihsb3Q/LnRhcmdldFBjdCAmJiBOdW1iZXIobG90LnRhcmdldFBjdCkhPTApewogICAgICByZXR1cm4gTnVtYmVyKGxvdC51bml0Q29zdCkgKiAoMSArIE51bWJlcihsb3QudGFyZ2V0UGN0KS8xMDApOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBmdW5jdGlvbiBjb21wdXRlQnV5VGFyZ2V0UHJpY2UobG90KXsKICAgIGlmKGxvdD8uYnV5VGFyZ2V0UHJpY2UgJiYgTnVtYmVyKGxvdC5idXlUYXJnZXRQcmljZSk+MCkgcmV0dXJuIE51bWJlcihsb3QuYnV5VGFyZ2V0UHJpY2UpOwogICAgaWYobG90Py5idXlUYXJnZXRQY3QgJiYgTnVtYmVyKGxvdC5idXlUYXJnZXRQY3QpIT0wKXsKICAgICAgcmV0dXJuIE51bWJlcihsb3QudW5pdENvc3QpICogKDEgLSBOdW1iZXIobG90LmJ1eVRhcmdldFBjdCkvMTAwKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KCmZ1bmN0aW9uIHRhcmdldFN0YXR1cyhsb3QpeyBpZihsb3QgJiYgbG90Lm11dGVkKSByZXR1cm4ge3N0YXRlOidub25lJ307IAogIGNvbnN0IHByaWNlID0gZ2V0UXVvdGUobG90Ll90aWNrZXJ8fCIiKTsKICBjb25zdCBzZWxsVCA9IGNvbXB1dGVUYXJnZXRQcmljZShsb3QpOwogIGNvbnN0IGJ1eVQgID0gY29tcHV0ZUJ1eVRhcmdldFByaWNlKGxvdCk7CiAgaWYocHJpY2U9PW51bGwpIHJldHVybiB7c3RhdGU6Im5vbmUifTsKICBjb25zdCB0b2wgPSAoTnVtYmVyKERCLnNldHRpbmdzLmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MSkvMTAwOyAvLyBucC4gMSUKCiAgY29uc3QgY2FuZCA9IFtdOwoKICBpZihzZWxsVCE9bnVsbCl7CiAgICBpZihwcmljZSA+PSBzZWxsVCkgY2FuZC5wdXNoKHtzdGF0ZToiaGl0Iiwga2luZDoic2VsbCIsIHByaWNlLCB0YXJnZXQ6c2VsbFR9KTsKICAgIGVsc2UgaWYocHJpY2UgPj0gc2VsbFQqKDEgLSB0b2wpKSBjYW5kLnB1c2goe3N0YXRlOiJuZWFyIiwga2luZDoic2VsbCIsIHByaWNlLCB0YXJnZXQ6c2VsbFR9KTsKICAgIGVsc2UgY2FuZC5wdXNoKHtzdGF0ZToiZmFyIiwga2luZDoic2VsbCIsIHByaWNlLCB0YXJnZXQ6c2VsbFR9KTsKICB9CgogIGlmKGJ1eVQhPW51bGwpewogICAgaWYocHJpY2UgPD0gYnV5VCkgY2FuZC5wdXNoKHtzdGF0ZToiaGl0Iiwga2luZDoiYnV5IiwgcHJpY2UsIHRhcmdldDpidXlUfSk7CiAgICBlbHNlIGlmKHByaWNlIDw9IGJ1eVQqKDEgKyB0b2wpKSBjYW5kLnB1c2goe3N0YXRlOiJuZWFyIiwga2luZDoiYnV5IiwgcHJpY2UsIHRhcmdldDpidXlUfSk7CiAgICBlbHNlIGNhbmQucHVzaCh7c3RhdGU6ImZhciIsIGtpbmQ6ImJ1eSIsIHByaWNlLCB0YXJnZXQ6YnV5VH0pOwogIH0KCiAgaWYoY2FuZC5sZW5ndGg9PT0wKSByZXR1cm4ge3N0YXRlOiJub25lIn07CgogIGNvbnN0IHByaW8gPSB7ICJoaXQiOjAsICJuZWFyIjoxLCAiZmFyIjoyIH07CiAgY2FuZC5zb3J0KChhLGIpPT57CiAgICBpZihwcmlvW2Euc3RhdGVdIT09cHJpb1tiLnN0YXRlXSkgcmV0dXJuIHByaW9bYS5zdGF0ZV0tcHJpb1tiLnN0YXRlXTsKICAgIGNvbnN0IGRhID0gTWF0aC5hYnMoKHByaWNlIC0gYS50YXJnZXQpL2EudGFyZ2V0KTsKICAgIGNvbnN0IGRiID0gTWF0aC5hYnMoKHByaWNlIC0gYi50YXJnZXQpL2IudGFyZ2V0KTsKICAgIHJldHVybiBkYSAtIGRiOwogIH0pOwogIHJldHVybiBjYW5kWzBdOwp9CgogIC8vIENvbXB1dGUgcG9ydGZvbGlvLWxldmVsIGFsZXJ0IHN0YXRlIGJhc2VkIG9uIGN1cnJlbnQgcXVvdGVzIGFuZCBsb3QgdGFyZ2V0cwogIGZ1bmN0aW9uIHBvcnRmb2xpb1RhcmdldFN0YXRlKHBmKXsKICAvLyByZXR1cm5zIHtzdGF0ZTogImhpdCJ8Im5lYXIifCJub25lIiwga2luZDogInNlbGwifCJidXkifG51bGx9CiAgbGV0IGhpdFNlbGw9ZmFsc2UsIGhpdEJ1eT1mYWxzZSwgbmVhclNlbGw9ZmFsc2UsIG5lYXJCdXk9ZmFsc2U7CiAgY29uc3QgdG9sID0gKE51bWJlcihEQi5zZXR0aW5ncy5hcHByb2FjaFRvbGVyYW5jZVBjdCl8fDEpLzEwMDsKICBmb3IoY29uc3QgW3RpY2tlciwgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICBjb25zdCBsb3RzID0gYm9vaz8ubG90cyB8fCBbXTsKICAgIGNvbnN0IHByaWNlID0gZ2V0UXVvdGUodGlja2VyKTsKICAgIGlmKHByaWNlPT1udWxsKSBjb250aW51ZTsKICAgIGZvcihjb25zdCBsIG9mIGxvdHMpewogICAgICBjb25zdCBzZWxsVCA9IGNvbXB1dGVUYXJnZXRQcmljZShsKTsKICAgICAgY29uc3QgYnV5VCAgPSBjb21wdXRlQnV5VGFyZ2V0UHJpY2UobCk7CiAgICAgIGlmKHNlbGxUIT1udWxsKXsKICAgICAgICBpZiAocHJpY2UgPj0gc2VsbFQgJiYgIShsICYmIGwubXV0ZWQpKSB7IGhpdFNlbGwgPSB0cnVlOyBicmVhazsgfQogICAgICAgIGlmKHByaWNlID49IHNlbGxUKigxIC0gdG9sKSAmJiAhKGwgJiYgbC5tdXRlZCkpIG5lYXJTZWxsID0gdHJ1ZTsKICAgICAgfQogICAgICBpZihidXlUIT1udWxsKXsKICAgICAgICBpZiAocHJpY2UgPD0gYnV5VCAmJiAhKGwgJiYgbC5tdXRlZCkpIHsgaGl0QnV5ID0gdHJ1ZTsgYnJlYWs7IH0KICAgICAgICBpZihwcmljZSA8PSBidXlUKigxICsgdG9sKSAmJiAhKGwgJiYgbC5tdXRlZCkpIG5lYXJCdXkgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBpZihoaXRTZWxsIHx8IGhpdEJ1eSkgYnJlYWs7CiAgfQogIGlmKGhpdFNlbGwpIHJldHVybiB7c3RhdGU6ImhpdCIsICBraW5kOiJzZWxsIn07CiAgaWYoaGl0QnV5KSAgcmV0dXJuIHtzdGF0ZToiaGl0IiwgIGtpbmQ6ImJ1eSJ9OwogIGlmKG5lYXJTZWxsKSByZXR1cm4ge3N0YXRlOiJuZWFyIiwga2luZDoic2VsbCJ9OwogIGlmKG5lYXJCdXkpICByZXR1cm4ge3N0YXRlOiJuZWFyIiwga2luZDoiYnV5In07CiAgcmV0dXJuIHtzdGF0ZToibm9uZSIsIGtpbmQ6bnVsbH07Cn0KCgpmdW5jdGlvbiB1cGRhdGVTaWRlYmFyQmxpbmtTdGF0ZXMoKXsKICAvLyBDbGVhciBwcmV2aW91cyBibGlua2luZyBjbGFzc2VzIG9uIGFsbCBzaWRlYmFyIGl0ZW1zCiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnBvcnRmb2xpby1pdGVtJykuZm9yRWFjaChlbD0+ewogICAgZWwuY2xhc3NMaXN0LnJlbW92ZSgnaGl0LXRhcmdldCcsJ25lYXItdGFyZ2V0JywnaGl0LXRhcmdldC1zZWxsJywnbmVhci10YXJnZXQtc2VsbCcsJ2hpdC10YXJnZXQtYnV5JywnbmVhci10YXJnZXQtYnV5Jyk7CiAgfSk7CiAgLy8gRm9yIGVhY2ggcG9ydGZvbGlvLCBhZGQgYmxpbmsgb25seSBpZiB0aGVyZSdzIGF0IGxlYXN0IG9uZSBOT04tQUNLRUQgdGlja2VyIHdpdGggaGl0L25lYXIKICBmb3IoY29uc3QgcGYgb2YgKCh0eXBlb2YgU1QhPT0ndW5kZWZpbmVkJyAmJiBTVC5EQiAmJiBBcnJheS5pc0FycmF5KFNULkRCLnBvcnRmb2xpb3MpKSA/IFNULkRCLnBvcnRmb2xpb3MgOiAoKHR5cGVvZiBEQiE9PSd1bmRlZmluZWQnICYmIEFycmF5LmlzQXJyYXkoREIucG9ydGZvbGlvcykpID8gREIucG9ydGZvbGlvcyA6IFtdKSkpewogICAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAucG9ydGZvbGlvLWl0ZW1bZGF0YS1wZi1pZD0iJHtwZi5pZH0iXWApOwogICAgaWYoIWVsKSBjb250aW51ZTsKICAgIGxldCBwZlN0YXRlID0gbnVsbDsKICAgIHRyeXsKICAgICAgZm9yKGNvbnN0IFt0aWNrZXIsIGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHBmLmhvbGRpbmdzfHx7fSkpewogICAgICAgIGNvbnN0IGxvdHMgPSBib29rLmxvdHN8fFtdOwogICAgICAgIGxldCByYW5rPS0xLCBzdGF0ZT0nbm9uZScsIGtpbmQ9bnVsbDsKICAgICAgICBmb3IoY29uc3QgbCBvZiBsb3RzKXsKICAgICAgICAgIGwuX3RpY2tlciA9IHRpY2tlcjsKICAgICAgICAgIGNvbnN0IHN0ID0gdGFyZ2V0U3RhdHVzKGwpOwogICAgICAgICAgY29uc3QgciA9IHN0LnN0YXRlPT09ImhpdCIgPyAoc3Qua2luZD09PSJzZWxsIj8zOjIpIDogKHN0LnN0YXRlPT09Im5lYXIiID8gKHN0LmtpbmQ9PT0ic2VsbCI/MTowKSA6IC0xKTsKICAgICAgICAgIGlmKHI+cmFuayl7IHJhbms9cjsgc3RhdGU9c3Quc3RhdGU7IGtpbmQ9c3Qua2luZDsgfQogICAgICAgIH0KICAgICAgICBpZihyYW5rPj0wICYmIChzdGF0ZT09PSdoaXQnIHx8IHN0YXRlPT09J25lYXInKSAmJiBraW5kICYmICFpc0FsZXJ0QWNrZWQodGlja2VyLCBraW5kLCBzdGF0ZSkpewogICAgICAgICAgcGZTdGF0ZSA9IHtzdGF0ZSwga2luZH07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH1jYXRjaChfKXt9CiAgICBpZihwZlN0YXRlKXsKICAgICAgaWYocGZTdGF0ZS5zdGF0ZSA9PT0gImhpdCIpIGVsLmNsYXNzTGlzdC5hZGQocGZTdGF0ZS5raW5kPT09InNlbGwiPydoaXQtdGFyZ2V0LXNlbGwnOidoaXQtdGFyZ2V0LWJ1eScpOwogICAgICBlbHNlIGlmKHBmU3RhdGUuc3RhdGUgPT09ICJuZWFyIikgZWwuY2xhc3NMaXN0LmFkZChwZlN0YXRlLmtpbmQ9PT0ic2VsbCI/J25lYXItdGFyZ2V0LXNlbGwnOiduZWFyLXRhcmdldC1idXknKTsKICAgIH0KICB9Cn0KCgoKCiAgCiAgLy8gPT09IFNvdW5kIEFsZXJ0cyBFbmdpbmUgPT09CihmdW5jdGlvbigpewogIGxldCBfX2F1ZGlvID0geyBjdHg6IG51bGwsIHVubG9ja2VkOiBmYWxzZSB9OwogIGxldCBfX2xhc3RQb3J0Zm9saW9TaWcgPSAnbm9uZSc7CiAgbGV0IF9fbGFzdFdpc2hsaXN0U2lnID0gJ25vbmUnOwogIGxldCBfX2xhc3RQb3J0Zm9saW9CZWVwID0gMDsKICBsZXQgX19sYXN0V2lzaGxpc3RCZWVwID0gMDsKICBmdW5jdGlvbiBfX3JlcGVhdE1zKCl7IHJldHVybiBNYXRoLm1heCg1MDAwLCBOdW1iZXIoREI/LnNldHRpbmdzPy5zb3VuZFJlcGVhdFNlY29uZHMgPz8gNjApICogMTAwMCk7IH0KCiAgZnVuY3Rpb24gX19nZXRTb3VuZFZvbHVtZVBjdCgpewogICAgdHJ5IHsgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgTnVtYmVyKERCPy5zZXR0aW5ncz8uc291bmRWb2x1bWUgPz8gNDApKSk7IH0KICAgIGNhdGNoKF8pIHsgcmV0dXJuIDQwOyB9CiAgfQogIGZ1bmN0aW9uIF9fZ2FpbkZyb21Wb2wobXVsdCl7IGNvbnN0IGJhc2UgPSAoX19nZXRTb3VuZFZvbHVtZVBjdCgpLzEwMCk7IHJldHVybiBNYXRoLm1heCgwLjAwMDUsIE1hdGgubWluKDEuMCwgYmFzZSAqIDAuMjAgKiAobXVsdHx8MSkpKTsgfQoKICBmdW5jdGlvbiBlbnN1cmVBdWRpbygpewogICAgdHJ5ewogICAgICBpZighX19hdWRpby5jdHgpewogICAgICAgIGNvbnN0IEFDID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0OwogICAgICAgIGlmKCFBQykgcmV0dXJuIG51bGw7CiAgICAgICAgX19hdWRpby5jdHggPSBuZXcgQUMoKTsKICAgICAgfQogICAgICByZXR1cm4gX19hdWRpby5jdHg7CiAgICB9Y2F0Y2goZSl7IHJldHVybiBudWxsOyB9CiAgfQoKICBmdW5jdGlvbiB1bmxvY2tBdWRpbygpewogICAgY29uc3QgY3R4ID0gZW5zdXJlQXVkaW8oKTsKICAgIGlmKCFjdHgpIHJldHVybjsKICAgIGlmKGN0eC5zdGF0ZSA9PT0gJ3N1c3BlbmRlZCcpewogICAgICBjdHgucmVzdW1lKCkuY2F0Y2goKCk9Pnt9KS50aGVuKCgpPT57IF9fYXVkaW8udW5sb2NrZWQgPSB0cnVlOyB9KTsKICAgIH1lbHNlewogICAgICBfX2F1ZGlvLnVubG9ja2VkID0gdHJ1ZTsKICAgIH0KICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIHVubG9ja0F1ZGlvKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdW5sb2NrQXVkaW8pOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdW5sb2NrQXVkaW8pOwogIH0KICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCB1bmxvY2tBdWRpbywgeyBvbmNlOmZhbHNlLCBjYXB0dXJlOnRydWUgfSk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB1bmxvY2tBdWRpbywgeyBvbmNlOmZhbHNlLCBjYXB0dXJlOnRydWUgfSk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdW5sb2NrQXVkaW8sIHsgb25jZTpmYWxzZSwgY2FwdHVyZTp0cnVlIH0pOwoKCi8vID09PSBXZWIgQXVkaW8gdW5sb2NrIGhlbHBlciB0byBjb21wbHkgd2l0aCBDaHJvbWUgYXV0b3BsYXkgcG9saWN5ID09PQooZnVuY3Rpb24oKXsKICB0cnl7CiAgICBpZighd2luZG93Ll9fQVVESU8pewogICAgICB3aW5kb3cuX19BVURJTyA9IHsgY3R4OiBudWxsLCB1bmxvY2tlZDogZmFsc2UsIHF1ZXVlOiBbXSB9OwogICAgfQogICAgZnVuY3Rpb24gX19yZXN1bWVBdWRpbygpewogICAgICB0cnl7CiAgICAgICAgY29uc3QgQSA9IHdpbmRvdy5fX0FVRElPOwogICAgICAgIGlmKCFBLmN0eCl7CiAgICAgICAgICBjb25zdCBDdHggPSB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQ7CiAgICAgICAgICBpZighQ3R4KSByZXR1cm47CiAgICAgICAgICBBLmN0eCA9IG5ldyBDdHgoKTsKICAgICAgICB9CiAgICAgICAgQS5jdHgucmVzdW1lKCkudGhlbihmdW5jdGlvbigpewogICAgICAgICAgQS51bmxvY2tlZCA9IChBLmN0eCAmJiBBLmN0eC5zdGF0ZSA9PT0gJ3J1bm5pbmcnKTsKICAgICAgICAgIGlmKEEudW5sb2NrZWQpewogICAgICAgICAgICBbJ3BvaW50ZXJkb3duJywndG91Y2hzdGFydCcsJ2NsaWNrJywna2V5ZG93biddLmZvckVhY2goZnVuY3Rpb24oZXYpewogICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXYsIF9fcmVzdW1lQXVkaW8sIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIGZsdXNoIHBlbmRpbmcgYmVlcHMKICAgICAgICAgICAgdmFyIHEgPSBBLnF1ZXVlLnNwbGljZSgwKTsKICAgICAgICAgICAgcS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsgdHJ5eyBmbigpOyB9Y2F0Y2goZSl7fSB9KTsKICAgICAgICAgICAgaWYodHlwZW9mIGNvbnNvbGUhPT0ndW5kZWZpbmVkJyAmJiBjb25zb2xlLmRlYnVnKXsKICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCdbYXVkaW9dIHVubG9ja2VkICsgcXVldWUgZmx1c2hlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oXyl7fSk7CiAgICAgIH1jYXRjaChfKXt9CiAgICB9CiAgICB3aW5kb3cuZW5zdXJlQXVkaW9VbmxvY2tlZCA9IGZ1bmN0aW9uKCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBBID0gd2luZG93Ll9fQVVESU87CiAgICAgICAgaWYoQS51bmxvY2tlZCkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYoIUEuY3R4KXsKICAgICAgICAgIGNvbnN0IEN0eCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICAgIGlmKCFDdHgpIHJldHVybiBmYWxzZTsKICAgICAgICAgIEEuY3R4ID0gbmV3IEN0eCgpOwogICAgICAgIH0KICAgICAgICBbJ3BvaW50ZXJkb3duJywndG91Y2hzdGFydCcsJ2NsaWNrJywna2V5ZG93biddLmZvckVhY2goZnVuY3Rpb24oZXYpewogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldiwgX19yZXN1bWVBdWRpbywgeyBvbmNlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH0pOwogICAgICAgIH0pOwogICAgICAgIGlmKHR5cGVvZiBjb25zb2xlIT09J3VuZGVmaW5lZCcgJiYgY29uc29sZS5kZWJ1Zyl7CiAgICAgICAgICBjb25zb2xlLmRlYnVnKCdbYXVkaW9dIHdhaXRpbmcgZm9yIHVzZXIgZ2VzdHVyZSB0byB1bmxvY2suLi4nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9Y2F0Y2goXyl7IHJldHVybiBmYWxzZTsgfQogICAgfTsKICB9Y2F0Y2goXyl7fQp9KSgpOwovLyA9PT0gZW5kIHVubG9jayBoZWxwZXIgPT09CgoKICAKZnVuY3Rpb24gcGxheUJlZXAoZnJlcSwgZHVyYXRpb25NcywgZ2FpblZhbCl7CiAgdHJ5ewogICAgdmFyIGYgPSBOdW1iZXIoZnJlcSl8fDEwMDA7CiAgICB2YXIgbXMgPSBOdW1iZXIoZHVyYXRpb25Ncyl8fDIwMDsKICAgIHZhciBnID0gTnVtYmVyKGdhaW5WYWwpOyAKICAgIGlmKCFpc0Zpbml0ZShnKSB8fCBnPD0wKSBnID0gMS4wOwogICAgdmFyIG9rID0gKHR5cGVvZiBlbnN1cmVBdWRpb1VubG9ja2VkPT09J2Z1bmN0aW9uJykgPyBlbnN1cmVBdWRpb1VubG9ja2VkKCkgOiB0cnVlOwoKICAgIHZhciBkb1BsYXkgPSBmdW5jdGlvbigpewogICAgICB0cnl7CiAgICAgICAgdmFyIEEgPSB3aW5kb3cuX19BVURJTyB8fCAod2luZG93Ll9fQVVESU8gPSB7IGN0eDpudWxsLCB1bmxvY2tlZDpmYWxzZSwgcXVldWU6W10gfSk7CiAgICAgICAgdmFyIEN0eCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICBpZighQS5jdHgpIEEuY3R4ID0gbmV3IEN0eCgpOwogICAgICAgIC8vIEVuc3VyZSBjb250ZXh0IGlzIHJ1bm5pbmcKICAgICAgICBpZihBLmN0eC5zdGF0ZSAhPT0gJ3J1bm5pbmcnKXsKICAgICAgICAgIC8vIEJlc3QgZWZmb3J0IHJlc3VtZQogICAgICAgICAgaWYgKEEuY3R4LnJlc3VtZSkgQS5jdHgucmVzdW1lKCkuY2F0Y2goZnVuY3Rpb24oKXsgfSk7CiAgICAgICAgfQogICAgICAgIHZhciBjdHggPSBBLmN0eDsKICAgICAgICB2YXIgb3NjID0gY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTsKICAgICAgICB2YXIgZ2FpbiA9IGN0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgb3NjLnR5cGUgPSAnc2luZSc7CiAgICAgICAgb3NjLmZyZXF1ZW5jeS52YWx1ZSA9IGY7CgogICAgICAgIC8vIHNpbXBsZSBhbnRpLWNsaWNrIGVudmVsb3BlCiAgICAgICAgdmFyIHQgPSBjdHguY3VycmVudFRpbWU7CiAgICAgICAgdmFyIGR1ciA9IG1zLzEwMDA7CiAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKDAuMDAwMSwgdCk7CiAgICAgICAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoTWF0aC5tYXgoMC4wMDAyLCBNYXRoLm1pbihnLCAyLjApKSwgdCArIDAuMDIpOwogICAgICAgIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDAwMSwgdCArIGR1cik7CgogICAgICAgIG9zYy5jb25uZWN0KGdhaW4pOwogICAgICAgIGdhaW4uY29ubmVjdChjdHguZGVzdGluYXRpb24pOwogICAgICAgIG9zYy5zdGFydCh0KTsKICAgICAgICBvc2Muc3RvcCh0ICsgZHVyKTsKICAgICAgfWNhdGNoKF8pe30KICAgIH07CgogICAgaWYoKHdpbmRvdy5fX0FVRElPICYmIHdpbmRvdy5fX0FVRElPLnVubG9ja2VkKSB8fCBvayl7CiAgICAgIGRvUGxheSgpOwogICAgfWVsc2V7CiAgICAgIC8vIHF1ZXVlIHVudGlsIHVubG9jayB2aWEgZmlyc3QgY2xpY2svdG91Y2gva2V5ZG93bgogICAgICB0cnl7CiAgICAgICAgdmFyIEEgPSB3aW5kb3cuX19BVURJTyB8fCAod2luZG93Ll9fQVVESU8gPSB7IGN0eDpudWxsLCB1bmxvY2tlZDpmYWxzZSwgcXVldWU6W10gfSk7CiAgICAgICAgLy8gS2VlcCBxdWV1ZSBzbWFsbAogICAgICAgIGlmIChBLnF1ZXVlLmxlbmd0aCA8IDUpIEEucXVldWUucHVzaChkb1BsYXkpOwogICAgICB9Y2F0Y2goXyl7fQogICAgfQogIH1jYXRjaChfKXt9Cn0KCgogIGZ1bmN0aW9uIHBvcnRmb2xpb0dsb2JhbFNpZ25hbCgpewogICAgbGV0IGFueUhpdD1mYWxzZSwgYW55TmVhcj1mYWxzZTsKICAgIGZvcihjb25zdCBwZiBvZiAoREIucG9ydGZvbGlvc3x8W10pKXsKICAgICAgY29uc3Qgc2lnID0gKHR5cGVvZiBwb3J0Zm9saW9UYXJnZXRTdGF0ZT09PSdmdW5jdGlvbicpID8gcG9ydGZvbGlvVGFyZ2V0U3RhdGUocGYpIDoge3N0YXRlOidub25lJ307CiAgICAgIGlmKHNpZy5zdGF0ZT09PSdoaXQnKXsgYW55SGl0PXRydWU7IGJyZWFrOyB9CiAgICAgIGlmKHNpZy5zdGF0ZT09PSduZWFyJyl7IGFueU5lYXI9dHJ1ZTsgfQogICAgfQogICAgcmV0dXJuIGFueUhpdCA/ICdoaXQnIDogKGFueU5lYXIgPyAnbmVhcicgOiAnbm9uZScpOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tBbmRQbGF5UG9ydGZvbGlvQWxlcnRzKCl7CiAgICBjb25zdCBzID0gcG9ydGZvbGlvR2xvYmFsU2lnbmFsKCk7CiAgICBjb25zdCBub3dNcyA9IERhdGUubm93KCk7CiAgICBpZihzPT09J2hpdCcgJiYgREI/LnNldHRpbmdzPy5zb3VuZEhpdFRhcmdldCAhPT0gZmFsc2UpewogICAgICBpZihfX2xhc3RQb3J0Zm9saW9TaWchPT0naGl0JyB8fCAobm93TXMgLSBfX2xhc3RQb3J0Zm9saW9CZWVwKSA+PSBfX3JlcGVhdE1zKCkpewogICAgICAgIHBsYXlCZWVwKDExMDAsIDI2MCwgMS4zKTsgIHRyeXsgaWYoX19zaG91bGRJbmNyZW1lbnRCYWRnZSgncG9ydGZvbGlvX2dsb2JhbCcsICdoaXQnKSl7IGNvbnN0IGs9J2FsZXJ0c191bnJlYWRfY291bnQnOyBjb25zdCBuPU51bWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKXx8MCl8fDA7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKGssIFN0cmluZyhNYXRoLm1pbihuKzEsOTk5KSkpOyBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2U9PT0nZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOyB9IH1jYXRjaChfKXt9IF9fbGFzdFBvcnRmb2xpb0JlZXAgPSBub3dNczsKICAgICAgfQogICAgfWVsc2UgaWYocz09PSduZWFyJyAmJiBEQj8uc2V0dGluZ3M/LnNvdW5kTmVhclRhcmdldCAhPT0gZmFsc2UpewogICAgICBpZihfX2xhc3RQb3J0Zm9saW9TaWchPT0nbmVhcicgfHwgKG5vd01zIC0gX19sYXN0UG9ydGZvbGlvQmVlcCkgPj0gX19yZXBlYXRNcygpKXsKICAgICAgICBwbGF5QmVlcCg2NTAsIDIyMCwgMS4wKTsgIHRyeXsgaWYoX19zaG91bGRJbmNyZW1lbnRCYWRnZSgncG9ydGZvbGlvX2dsb2JhbCcsICduZWFyJykpeyBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsgY29uc3Qgbj1OdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oayl8fDApfHwwOyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrLCBTdHJpbmcoTWF0aC5taW4obisxLDk5OSkpKTsgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsgfSB9Y2F0Y2goXyl7fSBfX2xhc3RQb3J0Zm9saW9CZWVwID0gbm93TXM7CiAgICAgIH0KICAgIH0KICAgICBfX2xhc3RQb3J0Zm9saW9TaWcgPSBzOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tBbmRQbGF5V2lzaGxpc3RBbGVydCgpewogICAgaWYodHlwZW9mIHdpc2hsaXN0U2lnbmFsIT09J2Z1bmN0aW9uJykgcmV0dXJuOwogICAgY29uc3QgcyA9IHdpc2hsaXN0U2lnbmFsKCk7IC8vICdoaXQnIHwgJ25lYXInIHwgJ25vbmUnCiAgICBjb25zdCBub3dNcyA9IERhdGUubm93KCk7CiAgICBpZihzPT09J2hpdCcgJiYgREI/LnNldHRpbmdzPy5zb3VuZEhpdFRhcmdldCAhPT0gZmFsc2UpewogICAgICBpZihfX2xhc3RXaXNobGlzdFNpZyE9PSdoaXQnIHx8IChub3dNcyAtIF9fbGFzdFdpc2hsaXN0QmVlcCkgPj0gX19yZXBlYXRNcygpKXsKICAgICAgICBwbGF5QmVlcCgxMDAwLCAyNDAsIDEuMyk7ICB0cnl7IGlmKF9fc2hvdWxkSW5jcmVtZW50QmFkZ2UoJ3dpc2hsaXN0X2dsb2JhbCcsICdoaXQnKSl7IGNvbnN0IGs9J2FsZXJ0c191bnJlYWRfY291bnQnOyBjb25zdCBuPU51bWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKXx8MCl8fDA7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKGssIFN0cmluZyhNYXRoLm1pbihuKzEsOTk5KSkpOyBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2U9PT0nZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOyB9IH1jYXRjaChfKXt9IF9fbGFzdFdpc2hsaXN0QmVlcCA9IG5vd01zOwogICAgICB9CiAgICB9ZWxzZSBpZihzPT09J25lYXInICYmIERCPy5zZXR0aW5ncz8uc291bmROZWFyVGFyZ2V0ICE9PSBmYWxzZSl7CiAgICAgIGlmKF9fbGFzdFdpc2hsaXN0U2lnIT09J25lYXInIHx8IChub3dNcyAtIF9fbGFzdFdpc2hsaXN0QmVlcCkgPj0gX19yZXBlYXRNcygpKXsKICAgICAgICBwbGF5QmVlcCg2MDAsIDIwMCwgMS4wKTsgIHRyeXsgaWYoX19zaG91bGRJbmNyZW1lbnRCYWRnZSgnd2lzaGxpc3RfZ2xvYmFsJywgJ25lYXInKSl7IGNvbnN0IGs9J2FsZXJ0c191bnJlYWRfY291bnQnOyBjb25zdCBuPU51bWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKXx8MCl8fDA7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKGssIFN0cmluZyhNYXRoLm1pbihuKzEsOTk5KSkpOyBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2U9PT0nZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOyB9IH1jYXRjaChfKXt9IF9fbGFzdFdpc2hsaXN0QmVlcCA9IG5vd01zOwogICAgICB9CiAgICB9CiAgICBfX2xhc3RXaXNobGlzdFNpZyA9IHM7CiAgfQoKICB0cnl7CiAgICB3aW5kb3cuY2hlY2tBbmRQbGF5UG9ydGZvbGlvQWxlcnRzID0gY2hlY2tBbmRQbGF5UG9ydGZvbGlvQWxlcnRzOwogICAgd2luZG93LmNoZWNrQW5kUGxheVdpc2hsaXN0QWxlcnQgPSBjaGVja0FuZFBsYXlXaXNobGlzdEFsZXJ0OwogICAgd2luZG93Ll9fdGVzdEJlZXAgPSAoZj04MDAsZD0yNTAsbT0xLjApPT57IHRyeXsgcGxheUJlZXAoZixkLG0pOyB9Y2F0Y2goXyl7IH0gfTsKICB9Y2F0Y2goXyl7fQp9KSgpOzsKCiAgCi8qID09PSBBY2tub3dsZWRnZWQgQWxlcnRzIChzdXBwcmVzcyBibGlua2luZyBmb3IgcmVhZCBvbmVzKSA9PT0gKi8Kd2luZG93Ll9fYWNrZWRBbGVydHMgPSB3aW5kb3cuX19hY2tlZEFsZXJ0cyB8fCB7fTsKZnVuY3Rpb24gX19hY2tLZXkodGlja2VyLCBraW5kLCBzdGF0ZSl7IHRyeXsgcmV0dXJuIFtTdHJpbmcodGlja2VyfHwnJykudG9VcHBlckNhc2UoKSwgU3RyaW5nKGtpbmR8fCcnKSwgU3RyaW5nKHN0YXRlfHwnJyldLmpvaW4oJ3wnKTsgfWNhdGNoKF8peyByZXR1cm4gU3RyaW5nKHRpY2tlcnx8JycpOyB9IH0KZnVuY3Rpb24gaXNBbGVydEFja2VkKHRpY2tlciwga2luZCwgc3RhdGUpeyB0cnl7IHJldHVybiAhIXdpbmRvdy5fX2Fja2VkQWxlcnRzW19fYWNrS2V5KHRpY2tlcixraW5kLHN0YXRlKV07IH1jYXRjaChfKXsgcmV0dXJuIGZhbHNlOyB9IH0KZnVuY3Rpb24gYWNrQWxlcnQodGlja2VyLCBraW5kLCBzdGF0ZSl7IHRyeXsgd2luZG93Ll9fYWNrZWRBbGVydHNbX19hY2tLZXkodGlja2VyLGtpbmQsc3RhdGUpXSA9IERhdGUubm93KCk7IH1jYXRjaChfKXt9IH0KCmZ1bmN0aW9uIGFja0N1cnJlbnRBbGVydHMoKXsKICB0cnl7CiAgICAvLyBQb3J0Zm9saW9zIC0gcGVyIHRpY2tlciBiZXN0IHN0YXRlCiAgICBjb25zdCB0b2wgPSAoTnVtYmVyKERCPy5zZXR0aW5ncz8uYXBwcm9hY2hUb2xlcmFuY2VQY3QpfHwxKS8xMDA7CiAgICBmb3IoY29uc3QgcGYgb2YgKERCPy5wb3J0Zm9saW9zfHxbXSkpewogICAgICBmb3IoY29uc3QgW3RpY2tlciwgYm9va10gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICAgICAgY29uc3QgbG90cyA9IGJvb2subG90c3x8W107CiAgICAgICAgY29uc3QgcHJpY2UgPSBnZXRRdW90ZSh0aWNrZXIpOwogICAgICAgIGlmKHByaWNlPT1udWxsKSBjb250aW51ZTsKICAgICAgICBsZXQgcmFuayA9IC0xLCBzdGF0ZT0nbm9uZScsIGtpbmQ9bnVsbDsKICAgICAgICBmb3IoY29uc3QgbCBvZiBsb3RzKXsKICAgICAgICAgIGwuX3RpY2tlciA9IHRpY2tlcjsKICAgICAgICAgIGNvbnN0IHN0ID0gdGFyZ2V0U3RhdHVzKGwpOwogICAgICAgICAgY29uc3QgciA9IHN0LnN0YXRlPT09ImhpdCIgPyAoc3Qua2luZD09PSJzZWxsIj8zOjIpIDogKHN0LnN0YXRlPT09Im5lYXIiID8gKHN0LmtpbmQ9PT0ic2VsbCI/MTowKSA6IC0xKTsKICAgICAgICAgIGlmKHIgPiByYW5rKXsgcmFuaz1yOyBzdGF0ZSA9IHN0LnN0YXRlOyBraW5kID0gc3Qua2luZDsgfQogICAgICAgIH0KICAgICAgICBpZihyYW5rPj0wICYmIChzdGF0ZT09PSdoaXQnIHx8IHN0YXRlPT09J25lYXInKSAmJiBraW5kKSBhY2tBbGVydCh0aWNrZXIsIGtpbmQsIHN0YXRlKTsKICAgICAgfQogICAgfQogICAgLy8gV2lzaGxpc3QgLSBhY3RpdmUgdGFyZ2V0IG9ubHkKICAgIGNvbnN0IHRvbDIgPSAoTnVtYmVyKERCPy5zZXR0aW5ncz8uYXBwcm9hY2hUb2xlcmFuY2VQY3QpfHwxKS8xMDA7CiAgICAoREI/LndhdGNobGlzdHx8W10pLmZvckVhY2godz0+ewogICAgICBjb25zdCB0ID0gKHcudGlja2VyfHwnJykudG9VcHBlckNhc2UoKTsKICAgICAgY29uc3QgcCA9IGdldFF1b3RlKHQpOwogICAgICBjb25zdCB0YXJnZXRzID0gQXJyYXkuaXNBcnJheSh3LnRhcmdldHMpID8gdy50YXJnZXRzLm1hcCh4PT5OdW1iZXIoeCl8fDApLmZpbHRlcih4PT54PjApIDogW107CiAgICAgIGNvbnN0IGFpID0gTWF0aC5taW4oTWF0aC5tYXgoTnVtYmVyKHcuYWN0aXZlSW5kZXgpfHwwLCAwKSwgTWF0aC5tYXgodGFyZ2V0cy5sZW5ndGgtMSwwKSk7CiAgICAgIGNvbnN0IGQgPSB0YXJnZXRzLmxlbmd0aCA/IE51bWJlcih0YXJnZXRzW2FpXSl8fDAgOiAoTnVtYmVyKHcucHJpY2UpfHwwKTsKICAgICAgaWYoIXQgfHwgIShkPjApIHx8IHA9PW51bGwpIHJldHVybjsKICAgICAgaWYocCA8PSBkKSBhY2tBbGVydCh0LCAnYnV5JywgJ2hpdCcpOwogICAgICBlbHNlIGlmKHAgPD0gZCooMSt0b2wyKSkgYWNrQWxlcnQodCwgJ2J1eScsICduZWFyJyk7CiAgICB9KTsKICB9Y2F0Y2goXyl7fQp9Ci8qID09PSBXaXNobGlzdCAoTGlzdGEgxbx5Y3plxYQpID09PSAqLwogIAogIGZ1bmN0aW9uIGVuc3VyZVdhdGNobGlzdFN0cnVjdHVyZSgpewogICAgdHJ5ewogICAgICBEQi53YXRjaGxpc3QgPSBEQi53YXRjaGxpc3QgfHwgW107CiAgICAgIGZvcihjb25zdCB3IG9mIERCLndhdGNobGlzdCl7CiAgICAgICAgaWYoIUFycmF5LmlzQXJyYXkody50YXJnZXRzKSl7CiAgICAgICAgICBjb25zdCBiYXNlID0gTnVtYmVyKHcucHJpY2UpfHwwOwogICAgICAgICAgdy50YXJnZXRzID0gYmFzZT4wID8gW2Jhc2VdIDogW107CiAgICAgICAgICB0cnl7IGRlbGV0ZSB3LnByaWNlOyB9Y2F0Y2goXyl7fQogICAgICAgIH0KICAgICAgICBpZih0eXBlb2Ygdy5hY3RpdmVJbmRleCE9PSdudW1iZXInKSB3LmFjdGl2ZUluZGV4ID0gMDsKICAgICAgICBpZih0eXBlb2Ygdy5uYW1lIT09J3N0cmluZycpIHcubmFtZSA9IHcubmFtZXx8Jyc7CiAgICAgIH0KICAgIH1jYXRjaChfKXt9CiAgfQpmdW5jdGlvbiBlbnN1cmVXYXRjaGxpc3QoKXsgREIud2F0Y2hsaXN0ID0gREIud2F0Y2hsaXN0IHx8IFtdOyBlbnN1cmVXYXRjaGxpc3RTdHJ1Y3R1cmUoKTsgfQoKICAKZnVuY3Rpb24gc2V0QWN0aXZlVmlldyh2KXsKICBjb25zdCBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1haW4nKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJyk7CiAgaWYoIW1haW4pIHJldHVybjsKICBjb25zdCBwYW5lbHMgPSBtYWluLnF1ZXJ5U2VsZWN0b3JBbGwoJzpzY29wZSA+IHNlY3Rpb24nKTsKICBwYW5lbHMuZm9yRWFjaChzZWM9PnsKICAgIGlmKHY9PT0nd2lzaGxpc3QnKSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nd2lzaGxpc3RQYW5lbCcpID8gJycgOiAnbm9uZSc7CiAgICBlbHNlIGlmKHY9PT0nYWxlcnRzJykgc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J2FsZXJ0c1BhbmVsJykgPyAnJyA6ICdub25lJzsKICAgIGVsc2Ugc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnIHx8IHNlYy5pZD09PSdhbGVydHNQYW5lbCcpID8gJ25vbmUnIDogJyc7CiAgfSk7CiAgY29uc3QgYnRuVyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aXNobGlzdFRhYkJ0bicpOwogIGlmKGJ0blcpeyBidG5XLmNsYXNzTGlzdC50b2dnbGUoJ3NlY29uZGFyeScsIHYhPT0nd2lzaGxpc3QnKTsgfQogIGNvbnN0IGJ0bkEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzVGFiQnRuJyk7CiAgaWYoYnRuQSl7IGJ0bkEuY2xhc3NMaXN0LnRvZ2dsZSgnc2Vjb25kYXJ5JywgdiE9PSdhbGVydHMnKTsgfQp9CgoKICBmdW5jdGlvbiB3aXNobGlzdFNpZ25hbCgpewogICAgZW5zdXJlV2F0Y2hsaXN0KCk7CiAgICBjb25zdCB0b2wgPSAoTnVtYmVyKERCLnNldHRpbmdzLmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MSkvMTAwOwogICAgbGV0IGhpdD1mYWxzZSwgbmVhcj1mYWxzZTsKICAgIGZvcihjb25zdCB3IG9mIERCLndhdGNobGlzdCl7CiAgICAgIGNvbnN0IHQgPSAody50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICBjb25zdCBwID0gZ2V0UXVvdGUodCk7CiAgICAgIGNvbnN0IHRhcmdldHMgPSBBcnJheS5pc0FycmF5KHcudGFyZ2V0cykgPyB3LnRhcmdldHMubWFwKHg9Pk51bWJlcih4KXx8MCkuZmlsdGVyKHg9Png+MCkgOiBbXTsKICAgICAgY29uc3QgYWkgPSBNYXRoLm1pbihNYXRoLm1heChOdW1iZXIody5hY3RpdmVJbmRleCl8fDAsIDApLCBNYXRoLm1heCh0YXJnZXRzLmxlbmd0aC0xLDApKTsKICAgICAgY29uc3QgZCA9ICh0YXJnZXRzLmxlbmd0aCA/IE51bWJlcih0YXJnZXRzW2FpXSl8fDAgOiAoTnVtYmVyKHcucHJpY2UpfHwwKSk7CiAgICAgIGlmKCF0IHx8ICEoZD4wKSB8fCBwPT1udWxsKSBjb250aW51ZTsKICAgICAgaWYocCA8PSBkKXsgaGl0ID0gdHJ1ZTsgYnJlYWs7IH0KICAgICAgaWYocCA8PSBkKigxK3RvbCkpIG5lYXIgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIGhpdCA/ICdoaXQnIDogKG5lYXIgPyAnbmVhcicgOiAnbm9uZScpOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlV2lzaGxpc3RCbGlua1N0YXRlKCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aXNobGlzdFRhYkJ0bicpOwogICAgICBpZighYnRuKSByZXR1cm47CiAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdoaXQtdGFyZ2V0LWJ1eScsJ25lYXItdGFyZ2V0LWJ1eScpOwogICAgICBjb25zdCBzaWcgPSB3aXNobGlzdFNpZ25hbCgpOwogICAgICBpZihzaWc9PT0naGl0JykgYnRuLmNsYXNzTGlzdC5hZGQoJ2hpdC10YXJnZXQtYnV5Jyk7CiAgICAgIGVsc2UgaWYoc2lnPT09J25lYXInKSBidG4uY2xhc3NMaXN0LmFkZCgnbmVhci10YXJnZXQtYnV5Jyk7CiAgICB9Y2F0Y2goZSl7fQogIH0KCiAgZnVuY3Rpb24gYWRkV2F0Y2hJdGVtKHRpY2tlciwgcHJpY2UpewogICAgZW5zdXJlV2F0Y2hsaXN0KCk7CiAgICB0aWNrZXIgPSAodGlja2VyfHwnJykudG9VcHBlckNhc2UoKS50cmltKCk7CiAgICBjb25zdCBwID0gTnVtYmVyKHByaWNlKXx8MDsKICAgIGlmKCF0aWNrZXIgfHwgIShwPjApKXsgYWxlcnQoJ1BvZGFqIHBvcHJhd255IHRpY2tlciBpIGNlbsSZLicpOyByZXR1cm47IH0KICAgIGNvbnN0IGV4ID0gREIud2F0Y2hsaXN0LmZpbmQodz0+IHcudGlja2VyPT09dGlja2VyKTsKICAgIGlmKGV4KXsgZXgucHJpY2UgPSBwOyBleC51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7IH0KICAgIGVsc2UgeyBEQi53YXRjaGxpc3QucHVzaCh7IGlkOmlkKCksIHRpY2tlciwgcHJpY2U6cCwgY3JlYXRlZEF0Om5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgdXBkYXRlZEF0Om5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9KTsgfQogICAgc2F2ZSgpOyByZW5kZXJXaXNobGlzdCgpOyB1cGRhdGVXaXNobGlzdEJsaW5rU3RhdGUoKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVdhdGNoSXRlbSh3aWQpewogICAgZW5zdXJlV2F0Y2hsaXN0KCk7CiAgICBjb25zdCBpID0gREIud2F0Y2hsaXN0LmZpbmRJbmRleCh3PT4gdy5pZD09PXdpZCk7CiAgICBpZihpPj0wKXsgREIud2F0Y2hsaXN0LnNwbGljZShpLDEpOyBzYXZlKCk7IHJlbmRlcldpc2hsaXN0KCk7IHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpOyB9CiAgfQoKICBhc3luYyBmdW5jdGlvbiBlZGl0V2F0Y2hJdGVtKHdpZCl7CiAgICBlbnN1cmVXYXRjaGxpc3QoKTsKICAgIGNvbnN0IGl0ZW0gPSBEQi53YXRjaGxpc3QuZmluZCh3PT4gdy5pZD09PXdpZCk7CiAgICBpZighaXRlbSkgcmV0dXJuOwogICAgY29uc3QgdCA9IChpdGVtLnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAvLyBCdWlsZCBkZWZhdWx0IHRhcmdldHMgc3RyaW5nIGZyb20gZXhpc3RpbmcgdGFyZ2V0cyBvciBmYWxsYmFjayB0byBvbGQgcHJpY2UKICAgIGNvbnN0IGRlZmF1bHRUYXJnZXRzID0gKEFycmF5LmlzQXJyYXkoaXRlbS50YXJnZXRzKSAmJiBpdGVtLnRhcmdldHMubGVuZ3RoKSAKICAgICAgPyBpdGVtLnRhcmdldHMuam9pbignLCAnKQogICAgICA6ICgoaXRlbS5wcmljZSE9bnVsbCAmJiBpdGVtLnByaWNlIT09JycpID8gKGl0ZW0ucHJpY2UrJycpIDogJycpOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiBgRWR5dHVqIGNlbGUga3VwbmEg4oCUICR7X19lc2ModCl9YCwKICAgICAgaW5uZXJIVE1MOiBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+PGxhYmVsPkNlbnkgZG9jZWxvd2UgKGt1cG5vKSDigJQgd3Bpc3ogcG8gcHJ6ZWNpbmt1LCB3IGtvbGVqbm/Fm2NpIHJlYWxpemFjamk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InRhcmdldHMiIHR5cGU9InRleHQiIHBsYWNlaG9sZGVyPSJucC4gMzUwLCAzMDAsIDI1MCIgdmFsdWU9IiR7X19lc2MoZGVmYXVsdFRhcmdldHMpfSIgLz4KICAgICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIHNtYWxsIj5Ba3R5d25hIGLEmWR6aWUgcGllcndzemE7IHBvIHpha3VwaWUgcHJ6ZcWCxIVjenkgc2nEmSBuYSBrb2xlam7EhS48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9mb3JtPmAsCiAgICAgIG9rVGV4dDoiWmFwaXN6IgogICAgfSk7CiAgICBpZighZGF0YSkgcmV0dXJuOwogICAgY29uc3QgcmF3ID0gKGRhdGEudGFyZ2V0c3x8JycpKycnOwogICAgY29uc3QgdGFyZ2V0cyA9IHJhdy5zcGxpdCgvWyw7XHNdKy8pLm1hcCh4PT5OdW1iZXIoeCkpLmZpbHRlcih4PT54PjApOwogICAgaWYoIXRhcmdldHMubGVuZ3RoKXsgYWxlcnQoJ1BvZGFqIGNvIG5ham1uaWVqIGplZG7EhSBwb3ByYXduxIUgY2VuxJkgZG9jZWxvd8SFLicpOyByZXR1cm47IH0KICAgIGl0ZW0udGFyZ2V0cyA9IHRhcmdldHM7CiAgICBpZih0eXBlb2YgaXRlbS5hY3RpdmVJbmRleCE9PSdudW1iZXInIHx8IGl0ZW0uYWN0aXZlSW5kZXg+PXRhcmdldHMubGVuZ3RoKSBpdGVtLmFjdGl2ZUluZGV4ID0gMDsKICAgIHRyeXsgZGVsZXRlIGl0ZW0ucHJpY2U7IH1jYXRjaChfKXt9CiAgICBpdGVtLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgIHNhdmUoKTsgcmVuZGVyV2lzaGxpc3QoKTsgdXBkYXRlV2lzaGxpc3RCbGlua1N0YXRlKCk7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJXaXNobGlzdCgpewogICAgZW5zdXJlV2F0Y2hsaXN0KCk7CiAgICBjb25zdCB3cmFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsVGFibGVXcmFwJyk7CiAgICBpZighd3JhcCkgcmV0dXJuOwogICAgY29uc3QgdG9sID0gKE51bWJlcihEQi5zZXR0aW5ncy5hcHByb2FjaFRvbGVyYW5jZVBjdCl8fDEpLzEwMDsKICAgIGNvbnN0IHJvd3MgPSAoREIud2F0Y2hsaXN0fHxbXSkubWFwKHc9PnsKICAgICAgY29uc3QgdCA9ICh3LnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGNvbnN0IHByaWNlID0gZ2V0UXVvdGUodCk7CiAgICAgIGNvbnN0IHRhcmdldHMgPSBBcnJheS5pc0FycmF5KHcudGFyZ2V0cykgPyB3LnRhcmdldHMubWFwKHg9Pk51bWJlcih4KXx8MCkuZmlsdGVyKHg9Png+MCkgOiAoKE51bWJlcih3LnByaWNlKXx8MCk/W051bWJlcih3LnByaWNlKV06W10pOwogICAgICBjb25zdCBhaSA9IE1hdGgubWluKE1hdGgubWF4KE51bWJlcih3LmFjdGl2ZUluZGV4KXx8MCwgMCksIE1hdGgubWF4KHRhcmdldHMubGVuZ3RoLTEsMCkpOwogICAgICBjb25zdCBkZXNpcmVkID0gdGFyZ2V0cy5sZW5ndGggPyBOdW1iZXIodGFyZ2V0c1thaV0pfHwwIDogMDsKICAgICAgbGV0IGRpc3QgPSBudWxsLCBzdGF0dXM9J+KAlCcsIGNscz0nJzsKICAgICAgaWYocHJpY2UhPW51bGwgJiYgZGVzaXJlZD4wKXsKICAgICAgICBkaXN0ID0gKHByaWNlIC0gZGVzaXJlZCkvZGVzaXJlZDsKICAgICAgICBpZihwcmljZSA8PSBkZXNpcmVkKXsgc3RhdHVzID0gJ/Cfjq8gS1VQJzsgY2xzPSdoaXQtdGFyZ2V0LWJ1eSc7IH0KICAgICAgICBlbHNlIGlmKHByaWNlIDw9IGRlc2lyZWQqKDErdG9sKSl7IHN0YXR1cyA9ICfij7MgYmxpc2tvJzsgY2xzPSduZWFyLXRhcmdldC1idXknOyB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsgLi4udywgdCwgcHJpY2UsIGRlc2lyZWQsIGRpc3QsIHN0YXR1cywgY2xzIH07CiAgICB9KS5zb3J0KChhLGIpPT57CiAgICAgIGNvbnN0IGFkID0gKGEuZGlzdD09bnVsbCkgPyAxZTkgOiBNYXRoLmFicyhhLmRpc3QpOwogICAgICBjb25zdCBiZCA9IChiLmRpc3Q9PW51bGwpID8gMWU5IDogTWF0aC5hYnMoYi5kaXN0KTsKICAgICAgcmV0dXJuIGFkIC0gYmQ7CiAgICB9KTsKCiAgICAKICAgIC8vIExvZyB3aXNobGlzdCBhbGFybXMgKGRlZHVwbGljYXRlZCksIGZvciByb3dzIGluICduZWFyJyBvciAnaGl0JyBzdGF0ZXMKICAgIHRyeXsKICAgICAgcm93cy5mb3JFYWNoKHI9PnsKICAgICAgICBjb25zdCBpbmZvID0gKHIuY2xzPT09J2hpdC10YXJnZXQtYnV5JykgPyB7c3RhdGU6J2hpdCcsIGtpbmQ6J2J1eSd9CiAgICAgICAgICAgICAgICAgICAgOiAoci5jbHM9PT0nbmVhci10YXJnZXQtYnV5JykgPyB7c3RhdGU6J25lYXInLCBraW5kOididXknfQogICAgICAgICAgICAgICAgICAgIDogbnVsbDsKICAgICAgICBpZihpbmZvICYmIHIuZGVzaXJlZD4wICYmIHIucHJpY2UhPW51bGwpewogICAgICAgICAgY29uc3Qga2V5ID0gWyd3bCcsIHIuaWQgfHwgci50LCBpbmZvLmtpbmRdLmpvaW4oJ3wnKTsKICAgICAgICAgIGlmKF9fc2hvdWxkTG9nQWxhcm0oa2V5LCBpbmZvLnN0YXRlKSl7IHRyeXsgd2luZG93LnNob3dUb2FzdCAmJiBzaG93VG9hc3Qoe3RpY2tlcjpyLnQsIHN0YXRlOmluZm8uc3RhdGUsIGtpbmQ6aW5mby5raW5kfSk7IH1jYXRjaChfKXt9IHRyeXsgd2luZG93LnNob3dUb2FzdCAmJiBzaG93VG9hc3Qoe3RpY2tlciwgc3RhdGU6aW5mby5zdGF0ZSwga2luZDppbmZvLmtpbmR9KTsgfWNhdGNoKF8pe30KICAgICAgICAgICAgbG9nQWxhcm1FdmVudCh7c2NvcGU6J3dpc2hsaXN0JywgdGlja2VyOnIudCwgc3RhdGU6aW5mby5zdGF0ZSwga2luZDppbmZvLmtpbmQsIHByaWNlOnIucHJpY2UsIHRhcmdldDpyLmRlc2lyZWR9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfWNhdGNoKF8pe30KY29uc3QgYm9keSA9IHJvd3MubWFwKHI9PnsKICAgICAgY29uc3QgcHJpY2VUeHQgPSAoci5wcmljZSE9bnVsbCkgPyBfX2ZtdE51bShyLnByaWNlKSA6ICfigJQnOwogICAgICBjb25zdCBkaXN0VHh0ID0gKHIuZGlzdD09bnVsbCkgPyAn4oCUJyA6ICggKHIuZGlzdCoxMDApLnRvRml4ZWQoMikgKyAnJScgKTsKICAgICAgcmV0dXJuIGA8dHIgY2xhc3M9IiR7ci5jbHN9Ij4KICAgICAgICA8dGQgY2xhc3M9InRpY2tlciI+JHtfX2VzYyhyLnQpfSR7KCgpPT57IGNvbnN0IGNuPWdldENvbXBhbnlOYW1lKHIudCk7IHJldHVybiBjbj9gPGRpdiBjbGFzcz0ibXV0ZWQgc21hbGwiIHN0eWxlPSJmb250LXdlaWdodDo0MDA7bWFyZ2luLXRvcDoycHgiPiR7X19lc2MoY24pfTwvZGl2PmA6Jyc7IH0pKCl9PC90ZD4KICAgICAgICA8dGQ+JHtwcmljZVR4dH08L3RkPgogICAgICAgIDx0ZD4keygoKT0+eyBjb25zdCBjaD1nZXRRdW90ZUNoYW5nZVBjdChyLnQpOyByZXR1cm4gKGNoIT1udWxsKT8gKCI8c3BhbiBjbGFzcz0ncGN0LWJhZGdlICIrKGNoPj0wPyJwY3QtcG9zIG9rLXRleHQiOiJwY3QtbmVnIGRhbmdlci10ZXh0IikrIic+IitmbXRQY3QoY2gpKyI8L3NwYW4+IikgOiAi4oCUIjsgfSkoKX08L3RkPgogICAgICAgIDx0ZD4ke19fZm10TnVtKHIuZGVzaXJlZCl9PC90ZD4KICAgICAgICA8dGQ+JHsoKCk9PnsgY29uc3QgX2MgPSByLmNsc3x8Jyc7IGNvbnN0IF9kPSh0eXBlb2Ygci5kaXN0PT09J251bWJlcicpP3IuZGlzdDpudWxsOyBsZXQgX2Nscz0nJzsgaWYoX2MuaW5jbHVkZXMoJ2hpdC10YXJnZXQtYnV5JykpeyBfY2xzPSdvay10ZXh0JzsgfSBlbHNlIGlmKF9jLmluY2x1ZGVzKCduZWFyLXRhcmdldC1idXknKSl7IF9jbHMgPSAoX2QhPW51bGwgJiYgX2Q8PSAodG9sLzIpKSA/ICd3YXJuLXN0cm9uZy10ZXh0JyA6ICd3YXJuLXRleHQnOyB9IHJldHVybiBgPHNwYW4gY2xhc3M9IiR7X2Nsc30iPiR7ZGlzdFR4dH08L3NwYW4+YDsgfSkoKX08L3RkPgogICAgICAgIDx0ZD4ke3Iuc3RhdHVzfTwvdGQ+CiAgICAgICAgPHRkIGNsYXNzPSJyb3ciIHN0eWxlPSJnYXA6NnB4Ij4KICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBvayB3bC1idXkiIGRhdGEtaWQ9IiR7ci5pZH0iPkt1cDwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGdob3N0IHdsLWVkaXQiIGRhdGEtaWQ9IiR7ci5pZH0iPkVkeXR1ajwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRhbmdlciB3bC1kZWwiIGRhdGEtaWQ9IiR7ci5pZH0iPlVzdcWEPC9idXR0b24+IDxidXR0b24gY2xhc3M9ImJ0biBnaG9zdCB0di1saW5rIiBkYXRhLXRpY2tlcj0iJHtyLnR9IiB0aXRsZT0iVHJhZGluZ1ZpZXciPlRWPC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3Qgd2wtaW5mbyIgZGF0YS10aWNrZXI9IiR7ci50fSI+4oS577iPPC9idXR0b24+CiAgICAgICAgPC90ZD4KICAgICAgPC90cj5gOwogICAgfSkuam9pbignJykgfHwgYDx0cj48dGQgY29sc3Bhbj0iOCIgY2xhc3M9ImNlbnRlciBtdXRlZCI+QnJhayBwb3p5Y2ppLiBEb2RhaiBwaWVyd3N6eSBjZWwga3VwbmEgcG93ecW8ZWouPC90ZD48L3RyPmA7CgogICAgY29uc3QgaHRtbCA9IGA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj4KICAgICAgPHRhYmxlPgogICAgICAgIDx0aGVhZD48dHI+CiAgICAgICAgICA8dGg+VGlja2VyPC90aD48dGg+S3VycyAobGl2ZSk8L3RoPjx0aD7OlCBkemllbm55PC90aD48dGg+Q2VsIGt1cG5hPC90aD48dGg+T2RsZWfFgm/Fm8SHPC90aD48dGg+U3RhdHVzPC90aD48dGg+QWtjamU8L3RoPgogICAgICAgIDwvdHI+PC90aGVhZD4KICAgICAgICA8dGJvZHk+JHtib2R5fTwvdGJvZHk+CiAgICAgIDwvdGFibGU+CiAgICA8L2Rpdj5gOwoKICAgIHdyYXAuaW5uZXJIVE1MID0gaHRtbDsKCiAgICAvLyBiaW5kIHJvdyBhY3Rpb25zCiAgICAKICAgIHdyYXAucXVlcnlTZWxlY3RvckFsbCgnLndsLWluZm8nKS5mb3JFYWNoKGJ0bj0+eyBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlPT57IGNvbnN0IHQ9ZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsgaWYodCkgb3BlbkNvbXBhbnlJbmZvTW9kYWwodCk7IH0pOyB9KTsKd3JhcC5xdWVyeVNlbGVjdG9yQWxsKCcud2wtZGVsJykuZm9yRWFjaChidG49PnsKICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZT0+ewogICAgICAgIGNvbnN0IGlkID0gZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1pZCcpOyByZW1vdmVXYXRjaEl0ZW0oaWQpOwogICAgICB9KTsKICAgIH0pOwogICAgd3JhcC5xdWVyeVNlbGVjdG9yQWxsKCcud2wtZWRpdCcpLmZvckVhY2goYnRuPT57CiAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGU9PnsKICAgICAgICBjb25zdCBpZCA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnKTsgZWRpdFdhdGNoSXRlbShpZCk7CiAgICAgIH0pOwogICAgfSk7CiAgICB3cmFwLnF1ZXJ5U2VsZWN0b3JBbGwoJy53bC1idXknKS5mb3JFYWNoKGJ0bj0+ewogICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyBlPT57CiAgICAgICAgY29uc3QgaWQgPSBlLmN1cnJlbnRUYXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWlkJyk7CiAgICAgICAgY29uc3QgaXRlbSA9IChEQi53YXRjaGxpc3R8fFtdKS5maW5kKHc9PiB3LmlkPT09aWQpOwogICAgICAgIGlmKCFpdGVtKSByZXR1cm47CiAgICAgICAgY29uc3QgdCA9IChpdGVtLnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgdHJ5eyBhd2FpdCBmZXRjaFF1b3RlRmlubmh1Yih0KTsgfWNhdGNoKGUpe30KICAgICAgICBjb25zdCBsYXN0UHJpY2UgPSBnZXRRdW90ZSh0KTsKICAgICAgICBjb25zdCBvcHRzID0gREIucG9ydGZvbGlvcy5tYXAocD0+YDxvcHRpb24gdmFsdWU9IiR7cC5pZH0iPiR7X19lc2MocC5uYW1lKX0gKCR7cC5jdXJyZW5jeX0pPC9vcHRpb24+YCkuam9pbignJyk7CiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgICAgICB0aXRsZTogYEt1cCAke19fZXNjKHQpfSAoeiBsaXN0eSDFvHljemXFhClgLAogICAgICAgICAgaW5uZXJIVE1MOiBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPlBvcnRmZWw8L2xhYmVsPjxzZWxlY3QgbmFtZT0icGZJZCI+JHtvcHRzfTwvc2VsZWN0PjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPklsb8WbxIc8L2xhYmVsPjxpbnB1dCBuYW1lPSJxdHkiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHJlcXVpcmVkIC8+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij48bGFiZWw+Q2VuYSAvIHN6dC48L2xhYmVsPjxpbnB1dCBuYW1lPSJwcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgdmFsdWU9IiR7bGFzdFByaWNlIT1udWxsP2xhc3RQcmljZTonJ30iIHJlcXVpcmVkIG9uaW5wdXQ9Il9fd2xTeW5jVGFyZ2V0cyh0aGlzLmZvcm0pIiAvPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMyI+PGxhYmVsPk9wxYJhdHk8L2xhYmVsPjxpbnB1dCBuYW1lPSJmZWVzIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIG1pbj0iMCIgdmFsdWU9IjAiIC8+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC0zIj48bGFiZWw+RGF0YTwvbGFiZWw+PGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3RvZGF5KCl9IiAvPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPkNlbCBTUFJaRURBxbtZICU8L2xhYmVsPjxpbnB1dCBuYW1lPSJ0YXJnZXRQY3QiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgcGxhY2Vob2xkZXI9Im5wLiA1ID0gKzUlIiBvbmlucHV0PSJfX3dsU3luY1RhcmdldHModGhpcy5mb3JtKSIgLz48L2Rpdj48ZGl2IGNsYXNzPSJjb2wtNiI+PGxhYmVsPkNlbCBTUFJaRURBxbtZIChjZW5hKTwvbGFiZWw+PGlucHV0IG5hbWU9InRhcmdldFByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiBwbGFjZWhvbGRlcj0ibnAuIDM1MC4wMCIgb25pbnB1dD0iX193bFN5bmNUYXJnZXRzKHRoaXMuZm9ybSkiIC8+PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij48bGFiZWw+S29sZWpuZSBrdXBubyAlPC9sYWJlbD48aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHBsYWNlaG9sZGVyPSJucC4gLTUgPSBrdXAgcHJ6eSAtNSUiIG9uaW5wdXQ9Il9fd2xTeW5jVGFyZ2V0cyh0aGlzLmZvcm0pIiAvPjwvZGl2PjxkaXYgY2xhc3M9ImNvbC02Ij48bGFiZWw+S29sZWpuZSBrdXBubyAoY2VuYSk8L2xhYmVsPjxpbnB1dCBuYW1lPSJidXlUYXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcGxhY2Vob2xkZXI9Im5wLiAyODAuMDAiIG9uaW5wdXQ9Il9fd2xTeW5jVGFyZ2V0cyh0aGlzLmZvcm0pIiAvPjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPjxsYWJlbD5Vc3XFhCB6IGxpc3R5IHBvIHpha3VwaWU8L2xhYmVsPjxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0icmVtb3ZlIiAvPjwvZGl2PgogICAgICAgICAgPC9mb3JtPmAsCiAgICAgICAgICBva1RleHQ6Ilpha3NpxJlndWogemFrdXAiCiAgICAgICAgfSk7CiAgICAgICAgaWYoIWRhdGEpIHJldHVybjsKICAgICAgICBjb25zdCBwZklkID0gZGF0YS5wZklkIHx8IGN1cnJlbnRQZklkOwogICAgICAgIGNvbnN0IHBheWxvYWQgPSB7IHRpY2tlcjp0LCBkYXRlOmRhdGEuZGF0ZSwgcXR5OmRhdGEucXR5LCBwcmljZTpkYXRhLnByaWNlLCBmZWVzOmRhdGEuZmVlcywgdGFyZ2V0UGN0OiBkYXRhLnRhcmdldFBjdHx8IiIsIHRhcmdldFByaWNlOiBkYXRhLnRhcmdldFByaWNlfHwiIiwgYnV5VGFyZ2V0UGN0OiBkYXRhLmJ1eVRhcmdldFBjdHx8IiIsIGJ1eVRhcmdldFByaWNlOiBkYXRhLmJ1eVRhcmdldFByaWNlfHwiIiB9OwogICAgICAgIGNvbnN0IHRzID0gTnVtYmVyKGRhdGEudGFyZ2V0U2VsbCl8fDA7CiAgICAgICAgY29uc3QgdGJuID0gTnVtYmVyKGRhdGEudGFyZ2V0QnV5TmV4dCl8fDA7CiAgICAgICAgaWYodHM+MCkgcGF5bG9hZC50YXJnZXRTZWxsID0gdHM7CiAgICAgICAgaWYodGJuPjApIHBheWxvYWQudGFyZ2V0QnV5TmV4dCA9IHRibjsKICAgICAgICBhd2FpdCBidXkocGZJZCwgcGF5bG9hZCk7CiAgICAgICAgaWYoZGF0YS5yZW1vdmUpeyByZW1vdmVXYXRjaEl0ZW0oaWQpOyB9IGVsc2UgeyByZW5kZXJXaXNobGlzdCgpOyB9CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvLyBTZWFyY2ggaGVscGVyIGZvciB3aXNobGlzdAogIGFzeW5jIGZ1bmN0aW9uIHdsU2VhcmNoU3ltYm9scyhxKXsKICAgIGNvbnN0IHtyZXN1bHQsIGVycm9yfSA9IGF3YWl0IHNlYXJjaFN5bWJvbEZpbm5odWIocXx8JyonKTsKICAgIGlmKGVycm9yKXsgYWxlcnQoJ0LFgsSFZCB3eXN6dWtpd2FuaWE6ICcrZXJyb3IpOyByZXR1cm47IH0KICAgIGNvbnN0IGJveCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFNlYXJjaFJlc3VsdHMnKTsKICAgIGlmKCFib3gpIHJldHVybjsKICAgIGNvbnN0IGxpc3QgPSAocmVzdWx0fHxbXSkuc2xpY2UoMCwyMCkubWFwKHI9PmAKICAgICAgPGRpdiBjbGFzcz0icm93IiBkYXRhLXN5bT0iJHtyLnN5bWJvbH0iIHN0eWxlPSJwYWRkaW5nOjRweCA2cHg7IGJvcmRlci1ib3R0b206MXB4IHNvbGlkICMxZjI5Mzc7IGN1cnNvcjpwb2ludGVyIj4KICAgICAgICA8ZGl2IGNsYXNzPSJ0aWNrZXIiIHN0eWxlPSJtaW4td2lkdGg6MTIwcHgiPiR7ci5zeW1ib2x9PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwiIHN0eWxlPSJvcGFjaXR5Oi45Ij4ke3IuZGVzY3JpcHRpb258fCcnfTwvZGl2PgogICAgICA8L2Rpdj5gKS5qb2luKCcnKSB8fCAnPGRpdiBjbGFzcz0ic21hbGwgbXV0ZWQiPkJyYWsgd3luaWvDs3cuPC9kaXY+JzsKICAgIGJveC5pbm5lckhUTUwgPSBsaXN0OwogICAgYm94LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXN5bV0nKS5mb3JFYWNoKGVsPT57CiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpPT57CiAgICAgICAgY29uc3Qgc3ltID0gZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1zeW0nKTsKICAgICAgICBjb25zdCB0RWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2xUaWNrZXInKTsKICAgICAgICBpZih0RWwpIHRFbC52YWx1ZSA9IHN5bTsKICAgICAgICB0cnl7IGF3YWl0IGZldGNoUXVvdGVGaW5uaHViKHN5bSk7IH1jYXRjaChlKXt9CiAgICAgICAgLy8gRmV0Y2ggYW5kIGNhY2hlIGNvbXBhbnkgbmFtZQp0cnl7IGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBmZXRjaENvbXBhbnlQcm9maWxlKHN5bSk7IGlmKHByb2ZpbGUgJiYgcHJvZmlsZS5uYW1lKSBzZXRDb21wYW55TmFtZShzeW0sIHByb2ZpbGUubmFtZSk7fWNhdGNoKF8pe30KcmVuZGVyV2lzaGxpc3QoKTsgdXBkYXRlV2lzaGxpc3RCbGlua1N0YXRlKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAKICAvLyBMaXZlIHN5bmMgYmV0d2VlbiAlIGFuZCBhYnNvbHV0ZSB0YXJnZXRzIGluIHdpc2hsaXN0IG1vZGFsCiAgZnVuY3Rpb24gX193bFN5bmNUYXJnZXRzKGZvcm0pewogICAgaWYoIWZvcm0pIHJldHVybjsKICAgIGNvbnN0IHByaWNlRWwgPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9InByaWNlIl0nKTsKICAgIGNvbnN0IHRndFBjdEVsID0gZm9ybS5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPSJ0YXJnZXRQY3QiXScpOwogICAgY29uc3QgdGd0UHJpY2VFbCA9IGZvcm0ucXVlcnlTZWxlY3RvcignaW5wdXRbbmFtZT0idGFyZ2V0UHJpY2UiXScpOwogICAgY29uc3QgYnV5UGN0RWwgPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9ImJ1eVRhcmdldFBjdCJdJyk7CiAgICBjb25zdCBidXlQcmljZUVsID0gZm9ybS5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPSJidXlUYXJnZXRQcmljZSJdJyk7CiAgICBjb25zdCBwID0gTnVtYmVyKHByaWNlRWwgJiYgcHJpY2VFbC52YWx1ZSkgfHwgMDsKICAgIC8vIFNFTEwgdGFyZ2V0CiAgICBpZihwPjApewogICAgICBpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50PT09dGd0UGN0RWwgfHwgKHRndFBjdEVsICYmIHRndFBjdEVsLl9sYXN0Q2hhbmdlZCkpewogICAgICAgIGNvbnN0IHBjdCA9IE51bWJlcih0Z3RQY3RFbC52YWx1ZSk7CiAgICAgICAgaWYoIU51bWJlci5pc05hTihwY3QpKSB7IGNvbnN0IHYgPSBwICogKDEgKyBwY3QvMTAwKTsgaWYodGd0UHJpY2VFbCkgdGd0UHJpY2VFbC52YWx1ZSA9IHYgPyB2LnRvRml4ZWQoNCkgOiAiIjsgfQogICAgICB9ZWxzZSBpZih0Z3RQcmljZUVsKXsKICAgICAgICBjb25zdCBhYnMgPSBOdW1iZXIodGd0UHJpY2VFbC52YWx1ZSk7CiAgICAgICAgaWYoYWJzPjApeyBjb25zdCBwY3QgPSAoKGFicy9wKS0xKSoxMDA7IGlmKHRndFBjdEVsKSB0Z3RQY3RFbC52YWx1ZSA9IHBjdC50b0ZpeGVkKDIpOyB9CiAgICAgIH0KICAgICAgLy8gQlVZLU5FWFQgdGFyZ2V0OiBpbnRlcnByZXQgJSBsaXRlcmFsbHkgKG5wLiAtNSA9PiAtNSUgb2QgY2VueSB6YWt1cHUpCiAgICAgIGlmKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ9PT1idXlQY3RFbCB8fCAoYnV5UGN0RWwgJiYgYnV5UGN0RWwuX2xhc3RDaGFuZ2VkKSl7CiAgICAgICAgY29uc3QgcGN0ID0gTnVtYmVyKGJ1eVBjdEVsLnZhbHVlKTsKICAgICAgICBpZighTnVtYmVyLmlzTmFOKHBjdCkpIHsgY29uc3QgdiA9IHAgKiAoMSArIHBjdC8xMDApOyBpZihidXlQcmljZUVsKSBidXlQcmljZUVsLnZhbHVlID0gdiA/IHYudG9GaXhlZCg0KSA6ICIiOyB9CiAgICAgIH1lbHNlIGlmKGJ1eVByaWNlRWwpewogICAgICAgIGNvbnN0IGFiczIgPSBOdW1iZXIoYnV5UHJpY2VFbC52YWx1ZSk7CiAgICAgICAgaWYoYWJzMj4wKXsgY29uc3QgcGN0MiA9ICgoYWJzMi9wKS0xKSoxMDA7IGlmKGJ1eVBjdEVsKSBidXlQY3RFbC52YWx1ZSA9IHBjdDIudG9GaXhlZCgyKTsgfQogICAgICB9CiAgICB9CiAgICAvLyBtYXJrIGxhc3QtY2hhbmdlZCBpbnB1dHMgKHRvIGF2b2lkIHBpbmctcG9uZykKICAgIFt0Z3RQY3RFbCwgYnV5UGN0RWxdLmZvckVhY2goZWw9PnsKICAgICAgaWYoZWwpewogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKCk9PnsgZWwuX2xhc3RDaGFuZ2VkID0gdHJ1ZTsgfSk7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsICgpPT57IGVsLl9sYXN0Q2hhbmdlZCA9IGZhbHNlOyB9KTsKICAgICAgfQogICAgfSk7CiAgfQoKICAKICAvLyBSZXNwb25zaXZlIHRhYmxlczogd3JhcCBhbnkgdGFibGUgd2l0aG91dCB3cmFwcGVyIHRvIGVuYWJsZSBob3Jpem9udGFsIHNjcm9sbCBvbiBtb2JpbGUKICBmdW5jdGlvbiBlbnN1cmVSZXNwb25zaXZlVGFibGVzKCl7CiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCd0YWJsZScpLmZvckVhY2godGJsPT57CiAgICAgIGlmKCF0YmwuY2xvc2VzdCgnLnRhYmxlLXdyYXAnKSl7CiAgICAgICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHdyYXAuY2xhc3NOYW1lID0gJ3RhYmxlLXdyYXAnOwogICAgICAgIHRibC5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh3cmFwLCB0YmwpOwogICAgICAgIHdyYXAuYXBwZW5kQ2hpbGQodGJsKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvLyBFdmVudCB3aXJpbmcKICAkKCIjYWRkUG9ydGZvbGlvQnRuIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYygpPT57CiAgICBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZToiTm93eSBwb3J0ZmVsIiwKICAgICAgaW5uZXJIVE1MOmA8Zm9ybSBjbGFzcz0icm93Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJmbGV4OjEiPgogICAgICAgICAgPGxhYmVsPk5hendhIHBvcnRmZWxhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJuYW1lIiBwbGFjZWhvbGRlcj0ibnAuIER5d2lkZW5keSAyMDI2IiByZXF1aXJlZCAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9IndpZHRoOjE4MHB4Ij4KICAgICAgICAgIDxsYWJlbD5XYWx1dGE8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImN1cnJlbmN5IiB2YWx1ZT0iJHtlbnN1cmVDdXJyZW5jeSgpfSIgcGxhY2Vob2xkZXI9IlBMTiIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgPC9mb3JtPmAKICAgIH0pLnRoZW4oZGF0YT0+ewogICAgICBpZighZGF0YSkgcmV0dXJuOwogICAgICBhZGRQb3J0Zm9saW8oKTsKICAgICAgcmVuYW1lUG9ydGZvbGlvKGN1cnJlbnRQZklkLCBkYXRhLm5hbWUgfHwgIk5vd3kgcG9ydGZlbCIpOwogICAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsKICAgICAgaWYocGYpeyBwZi5jdXJyZW5jeSA9IChkYXRhLmN1cnJlbmN5fHwiUExOIikudG9VcHBlckNhc2UoKTsgc2F2ZSgpOyByZW5kZXIoKTsgfQogICAgfSk7CiAgfSk7CgogICQoIiNyZW5hbWVCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm4gYWxlcnQoIk5hanBpZXJ3IHd5YmllcnogcG9ydGZlbC4iKTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZToiWm1pZcWEIG5henfEmSIsCiAgICAgIGlubmVySFRNTDpgPGZvcm0+CiAgICAgICAgPGxhYmVsPk5hendhPC9sYWJlbD4KICAgICAgICA8aW5wdXQgbmFtZT0ibmFtZSIgdmFsdWU9IiR7X19lc2MocGYubmFtZSl9IiAvPgogICAgICA8L2Zvcm0+YAogICAgfSk7CiAgICBpZihkYXRhICYmIGRhdGEubmFtZSl7IHJlbmFtZVBvcnRmb2xpbyhjdXJyZW50UGZJZCwgZGF0YS5uYW1lKTsgfQogIH0pOwoKICAkKCIjZGVsZXRlQnRuIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuOwogICAgY29uc3QgY29uZmlybURhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZToiVXN1xYQgcG9ydGZlbCIsCiAgICAgIG9rVGV4dDoiVGFrLCB1c3XFhCIsCiAgICAgIGNhbmNlbFRleHQ6IkplZG5hayBuaWUiLAogICAgICBpbm5lckhUTUw6YDxkaXYgY2xhc3M9ImNvbnRlbnQiPgogICAgICAgIDxwPkN6eSBuYSBwZXdubyBjaGNlc3ogdXN1bsSFxIcgcG9ydGZlbCA8Yj4ke19fZXNjKHBmLm5hbWUpfTwvYj4/IE9wZXJhY2rEmSBtb8W8bmEgY29mbsSFxIcgcHJ6ZXogMiBkbmkgKOKGqe+4jyBDb2ZuaWopLi48L3A+CiAgICAgICAgPHAgY2xhc3M9InNtYWxsIj5TYWxkbzogJHtfX2dvX2ZtdEN1cnJlbmN5KHBmLmNhc2gsIHBmLmN1cnJlbmN5KX0g4oCiIFBvenljamU6ICR7T2JqZWN0LmtleXMocGYuaG9sZGluZ3MpLmxlbmd0aH08L3A+CiAgICAgIDwvZGl2PmAKICAgIH0pOwogICAgaWYoY29uZmlybURhdGEhPT1udWxsKXsgZGVsZXRlUG9ydGZvbGlvKGN1cnJlbnRQZklkKTsgfQogIH0pOwoKICAkKCIjc2V0dGluZ3NCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCBzID0gREIuc2V0dGluZ3M7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6IlVzdGF3aWVuaWEiLAogICAgICBpbm5lckhUTUw6YDxmb3JtIGNsYXNzPSJzZXR0aW5ncy1mb3JtIj4KICA8c3R5bGU+CiAgICAvKiBTY29wZWQgc3R5bGVzIGZvciBTZXR0aW5ncyBtb2RhbCAqLwogICAgLnNldHRpbmdzLWZvcm17IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBnYXA6MTRweDsgfQogICAgLnNldHRpbmdzLXNlY3Rpb25zeyBkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOyBnYXA6MTJweDsgfQogICAgLnNldHRpbmdzLWNhcmR7CiAgICAgIGJvcmRlcjoxcHggc29saWQgIzMzNDE1NTsgYm9yZGVyLXJhZGl1czoxMnB4OyBwYWRkaW5nOjEycHg7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMTcsMjQsMzksLjk2KSwgcmdiYSgxNSwyMyw0MiwuOTYpKTsKICAgIH0KICAgIC5zZXR0aW5ncy1jYXJkIGg0eyBtYXJnaW46MCAwIDhweCAwOyBmb250LXNpemU6MTVweDsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDo4cHg7IH0KICAgIC5zZXR0aW5ncy1ncmlkeyBkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDEyLCAxZnIpOyBnYXA6MTBweDsgfQogICAgLnMtY29sLTN7IGdyaWQtY29sdW1uOiBzcGFuIDM7IH0KICAgIC5zLWNvbC00eyBncmlkLWNvbHVtbjogc3BhbiA0OyB9CiAgICAucy1jb2wtNnsgZ3JpZC1jb2x1bW46IHNwYW4gNjsgfQogICAgLnMtY29sLTEyeyBncmlkLWNvbHVtbjogc3BhbiAxMjsgfQogICAgQG1lZGlhIChtYXgtd2lkdGg6IDcyMHB4KXsKICAgICAgLnNldHRpbmdzLWdyaWQgPiAqeyBncmlkLWNvbHVtbjogc3BhbiAxMiAhaW1wb3J0YW50OyB9CiAgICB9CiAgICAuZGVzY3sgZm9udC1zaXplOjEycHg7IG9wYWNpdHk6Ljg7IG1hcmdpbi10b3A6NnB4OyB9CiAgICAuc3dpdGNoewogICAgICBkaXNwbGF5OmlubGluZS1mbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMHB4OyBjdXJzb3I6cG9pbnRlcjsgdXNlci1zZWxlY3Q6bm9uZTsKICAgICAgcGFkZGluZzo4cHggMTBweDsgYm9yZGVyLXJhZGl1czoxMHB4OyBib3JkZXI6MXB4IHNvbGlkICMzMzQxNTU7IGJhY2tncm91bmQ6IzBiMTIyMjsKICAgIH0KICAgIC5zd2l0Y2ggaW5wdXR7IGFwcGVhcmFuY2U6bm9uZTsgd2lkdGg6MzZweDsgaGVpZ2h0OjIwcHg7IGJvcmRlci1yYWRpdXM6OTk5cHg7IGJhY2tncm91bmQ6IzMzNDE1NTsgcG9zaXRpb246cmVsYXRpdmU7IG91dGxpbmU6bm9uZTsgdHJhbnNpdGlvbjouMnM7IH0KICAgIC5zd2l0Y2ggaW5wdXQ6YmVmb3JleyBjb250ZW50OiIiOyBwb3NpdGlvbjphYnNvbHV0ZTsgd2lkdGg6MTZweDsgaGVpZ2h0OjE2cHg7IHRvcDoycHg7IGxlZnQ6MnB4OyBib3JkZXItcmFkaXVzOjUwJTsgYmFja2dyb3VuZDojZTVlN2ViOyB0cmFuc2l0aW9uOi4yczsgfQogICAgLnN3aXRjaCBpbnB1dDpjaGVja2VkeyBiYWNrZ3JvdW5kOiMxMGI5ODE7IH0KICAgIC5zd2l0Y2ggaW5wdXQ6Y2hlY2tlZDpiZWZvcmV7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNnB4KTsgYmFja2dyb3VuZDojMGIxMjIyOyB9CiAgICAuaW5saW5leyBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEwcHg7IH0KICAgIC5tdXRlZHsgY29sb3I6Izk0YTNiODsgfQogICAgLmt2eyBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47IGdhcDoxMHB4OyBmb250LXNpemU6MTJweDsgfQogICAgLmt2IGNvZGV7IGZvbnQtc2l6ZToxMnB4OyBvcGFjaXR5Oi45OyB9CiAgICAucm93eyBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDo4cHg7IH0KICAgIC5zbWFsbHsgZm9udC1zaXplOjEycHg7IGNvbG9yOiM5NGEzYjg7IH0KICAKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgoKICA8ZGl2IGNsYXNzPSJzZXR0aW5ncy1zZWN0aW9ucyI+CgogICAgPCEtLSBPR8OTTE5FIC0tPgogICAgPGRpdiBjbGFzcz0ic2V0dGluZ3MtY2FyZCI+CiAgICAgIDxoND7impnvuI8gT2fDs2xuZTwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTQiPgogICAgICAgICAgPGxhYmVsPkRvbXnFm2xuYSB3YWx1dGE8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImN1cnJlbmN5RGVmYXVsdCIgdmFsdWU9IiR7cy5jdXJyZW5jeURlZmF1bHR8fCdQTE4nfSIgLz4KICAgICAgICAgIDxkaXYgY2xhc3M9ImRlc2MiPlXFvHl3YW5hIHByenkgbm93eWNoIHBvcnRmZWxhY2ggaSBmb3JtYXRvd2FuaXUgd2FydG/Fm2NpLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTQiPgogICAgICAgICAgPGxhYmVsPlN0YXdrYSBwb2RhdGt1IChCZWxraSk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InRheFJhdGUiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiBtYXg9IjEiIHZhbHVlPSIke3MudGF4UmF0ZX0iIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXNjIj5ucC4gMC4xOSA9IDE5JSAobmFsaWN6YW5lIHR5bGtvIHByenkgenlza3UgemUgc3ByemVkYcW8eSkuPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtNCI+CiAgICAgICAgICA8bGFiZWw+U2FsZG8gdWplbW5lPC9sYWJlbD4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0ic3dpdGNoIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJhbGxvd05lZ2F0aXZlQ2FzaCIgJHtzLmFsbG93TmVnYXRpdmVDYXNoPydjaGVja2VkJzonJ30gLz4KICAgICAgICAgICAgPHNwYW4+WmV6d8OzbCBuYSBzYWxkbyB1amVtbmUgKGtyZWR5dC9tYXJnaW4pPC9zcGFuPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KCiAgICA8IS0tIEFQSSBpIENFTlkgLS0+CiAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncy1jYXJkIj4KICAgICAgPGg0IGNsYXNzPSJzZXR0aW5ncy10aXRsZS1yb3ciPgogICAgICAgIDxzcGFuPvCfk6EgQVBJIGkgY2VueTwvc3Bhbj4KICAgICAgICA8YSBocmVmPSJodHRwczovL2Zpbm5odWIuaW8vIiB0YXJnZXQ9Il9ibGFuayIgcmVsPSJub29wZW5lciBub3JlZmVycmVyIiBjbGFzcz0iYnRuIGdob3N0Ij4KICAgICAgICAgIFpkb2LEhWTFuiBkYXJtb3d5IGtsdWN6IEFQSQogICAgICAgIDwvYT4KICAgICAgPC9oND4KICAgICAgPGRpdiBjbGFzcz0ic2V0dGluZ3MtZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtNiI+CiAgICAgICAgICA8bGFiZWw+Rmlubmh1YiBBUEkgVG9rZW48L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImZpbm5odWJUb2tlbiIgdmFsdWU9IiR7cy5maW5uaHViVG9rZW58fCcnfSIgLz4KICAgICAgICAgIAogICAgICAgIDwvZGl2PgoKPGRpdiBjbGFzcz0icy1jb2wtNiI+CiAgPGxhYmVsPkZpbm5odWIgQVBJIFRva2VuIChXaXNobGlzdCk8L2xhYmVsPgogIDxpbnB1dCBuYW1lPSJmaW5uaHViVG9rZW5XaXNobGlzdCIgdmFsdWU9IiR7cy5maW5uaHViVG9rZW5XaXNobGlzdHx8Jyd9IiAvPgogIDxkaXYgY2xhc3M9ImRlc2MiPk9zb2JueSBrbHVjeiBkbGEgTGlzdHkgxbt5Y3plxYQgKHByenlzcGllc3phIG9kxZt3aWXFvGFuaWUpLjwvZGl2Pgo8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC0zIj4KICAgICAgICAgIDxsYWJlbD5PZMWbd2llxbxhbmllIGt1cnPDs3cgW3NdPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJwcmljZVBvbGxTZWNvbmRzIiB0eXBlPSJudW1iZXIiIG1pbj0iNSIgc3RlcD0iMSIgdmFsdWU9IiR7cy5wcmljZVBvbGxTZWNvbmRzfHwzMH0iIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXNjIj5DesSZc3RvdGxpd2/Fm8SHIHBvYmllcmFuaWEgY2VuLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTMiPgogICAgICAgICAgPGxhYmVsPlRvbGVyYW5jamEg4oCeemJsacW8YSBzacSZ4oCdIFslXTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYXBwcm9hY2hUb2xlcmFuY2VQY3QiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4xIiBtaW49IjAiIHZhbHVlPSIke3MuYXBwcm9hY2hUb2xlcmFuY2VQY3R8fDF9IiAvPgogICAgICAgICAgPGRpdiBjbGFzcz0iZGVzYyI+SWxlICUgb2QgY2VsdSB1em5hamVteSB6YSDigJ5ibGlza2/igJ0uPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogICAgPCEtLSBBTEVSVFkgRMW5V0nEmEtPV0UgLS0+CiAgICA8ZGl2IGNsYXNzPSJzZXR0aW5ncy1jYXJkIj4KICAgICAgPGg0PvCfm47vuI8gQWxlcnR5IGTFundpxJlrb3dlPC9oND4KICAgICAgPGRpdiBjbGFzcz0ic2V0dGluZ3MtZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtNCI+CiAgICAgICAgICA8bGFiZWw+R8WCw7N3bmU8L2xhYmVsPgogICAgICAgICAgPGxhYmVsIGNsYXNzPSJzd2l0Y2giPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9InNvdW5kQWxlcnRzRW5hYmxlZCIgJHtzLnNvdW5kQWxlcnRzRW5hYmxlZCE9PWZhbHNlPydjaGVja2VkJzonJ30gLz4KICAgICAgICAgICAgPHNwYW4+V8WCxIVjeiBhbGFybXkgZMW6d2nEmWtvd2U8L3NwYW4+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTQiPgogICAgICAgICAgPGxhYmVsPuKAnkNlbCBvc2nEhWduacSZdHnigJ08L2xhYmVsPgogICAgICAgICAgPGxhYmVsIGNsYXNzPSJzd2l0Y2giPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9InNvdW5kSGl0VGFyZ2V0IiAke3Muc291bmRIaXRUYXJnZXQhPT1mYWxzZT8nY2hlY2tlZCc6Jyd9IC8+CiAgICAgICAgICAgIDxzcGFuPk9kdHdhcnphaiBwcnp5IHRyYWZpZW5pdSB3IGNlbDwvc3Bhbj4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtNCI+CiAgICAgICAgICA8bGFiZWw+4oCeQmxpc2tvIGNlbHXigJ08L2xhYmVsPgogICAgICAgICAgPGxhYmVsIGNsYXNzPSJzd2l0Y2giPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9InNvdW5kTmVhclRhcmdldCIgJHtzLnNvdW5kTmVhclRhcmdldCE9PWZhbHNlPydjaGVja2VkJzonJ30gLz4KICAgICAgICAgICAgPHNwYW4+T2R0d2FyemFqIHByenkgemJsacW8ZW5pdTwvc3Bhbj4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgY2xhc3M9InMtY29sLTYiPgogICAgICAgICAgPGxhYmVsPkfFgm/Fm25vxZvEhyBhbGFybXU8L2xhYmVsPgogICAgICAgICAgPGRpdiBjbGFzcz0iaW5saW5lIj4KICAgICAgICAgICAgPGlucHV0IG5hbWU9InNvdW5kVm9sdW1lIiB0eXBlPSJyYW5nZSIgbWluPSIwIiBtYXg9IjE1MCIgc3RlcD0iMSIKICAgICAgICAgICAgICAgICAgIHZhbHVlPSIkeyhzLnNvdW5kVm9sdW1lPz82MCl9IgogICAgICAgICAgICAgICAgICAgb25pbnB1dD0idGhpcy5uZXh0RWxlbWVudFNpYmxpbmcudmFsdWU9dGhpcy52YWx1ZSArICclJyIgLz4KICAgICAgICAgICAgPG91dHB1dCBjbGFzcz0ic21hbGwiPiR7KHMuc291bmRWb2x1bWU/PzYwKX0lPC9vdXRwdXQ+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzLWNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5Qb3d0YXJ6YW5pZSBhbGFybXUgW3NdPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJzb3VuZFJlcGVhdFNlY29uZHMiIHR5cGU9Im51bWJlciIgbWluPSI1IiBzdGVwPSI1IiB2YWx1ZT0iJHsocy5zb3VuZFJlcGVhdFNlY29uZHM/PzYwKX0iIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZXNjIj5DbyBpbGUgc2VrdW5kIHBvbm93acSHIHN5Z25hxYIsIGdkeSBzdGFuIG5hZGFsIHRyd2EuPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogIDwvZGl2PgoKICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWNhcmQiPgogICAgICA8aDQ+SGlzdG9yaWEgaSBjb2ZhbmllPC9oND4KICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZ2hvc3QiIGlkPSJ1bmRvQnRuIiB0aXRsZT0iQ29mbmlqIG9zdGF0bmnEhSB6bWlhbsSZIChoaXN0b3JpYSAyIGRuaSkiPuKGqe+4jyBDb2ZuaWo8L2J1dHRvbj4KICAgICAgICA8c3BhbiBjbGFzcz0ic21hbGwgbXV0ZWQiPkN0cmwvQ21kK1og4oCUIGNvZm5paiB0cmFuc2FrY2rEmSDigKIgU2hpZnQr4oap77iPIC8gQ3RybC9DbWQrU2hpZnQrWiDigJQga3Jva293bzwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InNldHRpbmdzLWNhcmQiPgogICAgICA8aDQ+8J+nqCBVc3Rhd2llbmlhIGtvbnRhPC9oND4KICAgICAgPGRpdiBjbGFzcz0ic2V0dGluZ3MtZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtMTIiPgogICAgICAgICAgPGxhYmVsPk5vd2UgaGFzxYJvPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJuZXdQYXNzd29yZCIgdHlwZT0icGFzc3dvcmQiIG1pbmxlbmd0aD0iNiIgYXV0b2NvbXBsZXRlPSJuZXctcGFzc3dvcmQiIHBsYWNlaG9sZGVyPSJtaW4uIDYgem5ha8OzdyIgLz4KICAgICAgICAgIDxkaXYgY2xhc3M9ImRlc2MiPk5vd2UgaGFzxYJvIHpvc3RhbmllIHphcGlzYW5lIHBvIGtsaWtuacSZY2l1IHByenljaXNrdSAiWmFwaXN6IiBuYSBkb2xlIG9rbmEuPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtMTIiPgogICAgICAgICAgPGxhYmVsPlBvd3TDs3J6IG5vd2UgaGFzxYJvPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJuZXdQYXNzd29yZENvbmZpcm0iIHR5cGU9InBhc3N3b3JkIiBtaW5sZW5ndGg9IjYiIGF1dG9jb21wbGV0ZT0ibmV3LXBhc3N3b3JkIiBwbGFjZWhvbGRlcj0id3Bpc3ogcG9ub3duaWUgbm93ZSBoYXPFgm8iIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icy1jb2wtMTIiPgogICAgICAgICAgPGRpdiBjbGFzcz0iYmFubmVyIHdhcm4iPgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxzdHJvbmc+VXdhZ2EhPC9zdHJvbmc+CiAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwiPkRlemFrdHl3YWNqYSB1c3VuaWUgVHdvamUga29udG8gaSBkYW5lIHogc2Vyd2VyYS4gT3BlcmFjamEgamVzdCBuaWVvZHdyYWNhbG5hLjwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gd2FybiIgb25jbGljaz0iaWYod2luZG93LnBhcmVudCAmJiB3aW5kb3cucGFyZW50Ll9fcmVxdWVzdEFjY291bnREZWxldGlvbil7IHdpbmRvdy5wYXJlbnQuX19yZXF1ZXN0QWNjb3VudERlbGV0aW9uKCk7IH0iPgogICAgICAgICAgICAgIERlemFrdHl3dWoga29udG8KICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KCjwvZm9ybT5gCiAgICB9KTsKICAgIGlmKGRhdGEpewogICAgICAvLyBabWlhbmEgaGFzxYJhIChvYnPFgnVnaXdhbmEgcHJ6ZXogYXBsaWthY2rEmSBnxYLDs3duxIUpCiAgICAgIGlmIChkYXRhLm5ld1Bhc3N3b3JkIHx8IGRhdGEubmV3UGFzc3dvcmRDb25maXJtKSB7CiAgICAgICAgaWYgKCFkYXRhLm5ld1Bhc3N3b3JkIHx8ICFkYXRhLm5ld1Bhc3N3b3JkQ29uZmlybSkgewogICAgICAgICAgYWxlcnQoIkFieSB6bWllbmnEhyBoYXPFgm8sIHd5cGXFgm5paiBvYmEgcG9sYTogbm93ZSBoYXPFgm8gaSBwb3d0w7NyemVuaWUuIik7CiAgICAgICAgfSBlbHNlIGlmIChkYXRhLm5ld1Bhc3N3b3JkICE9PSBkYXRhLm5ld1Bhc3N3b3JkQ29uZmlybSkgewogICAgICAgICAgYWxlcnQoIk5vd2UgaGFzxYJvIGkgcG90d2llcmR6ZW5pZSBuaWUgc8SFIHRha2llIHNhbWUuIik7CiAgICAgICAgfSBlbHNlIGlmIChkYXRhLm5ld1Bhc3N3b3JkLmxlbmd0aCA8IDYpIHsKICAgICAgICAgIGFsZXJ0KCJIYXPFgm8gbXVzaSBtaWXEhyBjbyBuYWptbmllaiA2IHpuYWvDs3cuIik7CiAgICAgICAgfSBlbHNlIGlmICh3aW5kb3cucGFyZW50ICYmIHdpbmRvdy5wYXJlbnQuX19yZXF1ZXN0UGFzc3dvcmRDaGFuZ2UpIHsKICAgICAgICAgIHdpbmRvdy5wYXJlbnQuX19yZXF1ZXN0UGFzc3dvcmRDaGFuZ2UoZGF0YS5uZXdQYXNzd29yZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFsZXJ0KCJabWlhbmEgaGFzxYJhIG5pZSBqZXN0IGRvc3TEmXBuYSB3IHRlaiB3ZXJzamkgYXBsaWthY2ppLiIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgREIuc2V0dGluZ3MudGF4UmF0ZSA9IE51bWJlcihkYXRhLnRheFJhdGUpfHwwLjE5OwogICAgICBEQi5zZXR0aW5ncy5jdXJyZW5jeURlZmF1bHQgPSAoZGF0YS5jdXJyZW5jeURlZmF1bHR8fCJQTE4iKS50b1VwcGVyQ2FzZSgpOwogICAgICBEQi5zZXR0aW5ncy5hbGxvd05lZ2F0aXZlQ2FzaCA9ICEhZGF0YS5hbGxvd05lZ2F0aXZlQ2FzaDsKICAgICAgREIuc2V0dGluZ3MuZmlubmh1YlRva2VuID0gZGF0YS5maW5uaHViVG9rZW58fCIiOwogICAgICBEQi5zZXR0aW5ncy5maW5uaHViVG9rZW5XaXNobGlzdCA9IGRhdGEuZmlubmh1YlRva2VuV2lzaGxpc3R8fCIiOwogICAgICBEQi5zZXR0aW5ncy5wcmljZVBvbGxTZWNvbmRzID0gTnVtYmVyKGRhdGEucHJpY2VQb2xsU2Vjb25kcyl8fDMwOwogICAgICBEQi5zZXR0aW5ncy5hcHByb2FjaFRvbGVyYW5jZVBjdCA9IE51bWJlcihkYXRhLmFwcHJvYWNoVG9sZXJhbmNlUGN0KXx8MTsKICAgICAgREIuc2V0dGluZ3Muc291bmRBbGVydHNFbmFibGVkID0gISFkYXRhLnNvdW5kQWxlcnRzRW5hYmxlZDsKICAgICAgREIuc2V0dGluZ3Muc291bmRIaXRUYXJnZXQgPSAhIWRhdGEuc291bmRIaXRUYXJnZXQ7CiAgICAgIERCLnNldHRpbmdzLnNvdW5kTmVhclRhcmdldCA9ICEhZGF0YS5zb3VuZE5lYXJUYXJnZXQ7CiAgICAgIERCLnNldHRpbmdzLnNvdW5kVm9sdW1lID0gTnVtYmVyKGRhdGEuc291bmRWb2x1bWUgPz8gREIuc2V0dGluZ3Muc291bmRWb2x1bWUgPz8gNDApOwogICAgICBEQi5zZXR0aW5ncy5zb3VuZFJlcGVhdFNlY29uZHMgPSBOdW1iZXIoZGF0YS5zb3VuZFJlcGVhdFNlY29uZHMgPz8gREIuc2V0dGluZ3Muc291bmRSZXBlYXRTZWNvbmRzID8/IDYwKTsKICAgICAgc2F2ZSgpOyByZW5kZXIoKTsKICAgICAgc3RhcnRQb2xsaW5nUXVvdGVzKCk7CiAgICB9CiAgICBpZihkYXRhKXsKICAgICAgREIuc2V0dGluZ3MudGF4UmF0ZSA9IE51bWJlcihkYXRhLnRheFJhdGUpfHwwLjE5OwogICAgICBEQi5zZXR0aW5ncy5jdXJyZW5jeURlZmF1bHQgPSAoZGF0YS5jdXJyZW5jeURlZmF1bHR8fCJQTE4iKS50b1VwcGVyQ2FzZSgpOwogICAgICBEQi5zZXR0aW5ncy5hbGxvd05lZ2F0aXZlQ2FzaCA9ICEhZGF0YS5hbGxvd05lZ2F0aXZlQ2FzaDsKICAgICAgc2F2ZSgpOyByZW5kZXIoKTsKICAgIH0KICB9KTsKCiAgJCgiI2RlcG9zaXRCdG4iKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm4gYWxlcnQoIk5hanBpZXJ3IHd5YmllcnogcG9ydGZlbC4iKTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICB0aXRsZToiV3DFgmF0YSBkbyBwb3J0ZmVsYSIsCiAgICAgIGlubmVySFRNTDpgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5Ld290YSAoJHtwZi5jdXJyZW5jeX0pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJhbW91bnQiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiByZXF1aXJlZCAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYSAob3Bjam9uYWxuaWUpPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiAvPgogICAgICAgIDwvZGl2PgogICAgICA8L2Zvcm0+YAogICAgfSk7CiAgICBpZihkYXRhICYmIGRhdGEuYW1vdW50KXsgZGVwb3NpdChjdXJyZW50UGZJZCwgZGF0YS5hbW91bnQsIGRhdGEubm90ZXx8IiIpOyB9CiAgfSk7CgogICQoIiNjYXNoQWN0aW9uc0J0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybiBhbGVydCgiTmFqcGllcncgd3liaWVyeiBwb3J0ZmVsLiIpOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiJPcGVyYWNqZSBnb3TDs3drb3dlIiwKICAgICAgaW5uZXJIVE1MOmA8Zm9ybSBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGxhYmVsPkt3b3RhICgke3BmLmN1cnJlbmN5fSk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImFtb3VudCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGxhYmVsPlJvZHphajwvbGFiZWw+CiAgICAgICAgICA8c2VsZWN0IG5hbWU9ImtpbmQiPgogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJkZXBvc2l0Ij5XcMWCYXRhPC9vcHRpb24+CiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IndpdGhkcmF3Ij5XeXDFgmF0YTwvb3B0aW9uPgogICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5Ob3RhdGthPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiAvPgogICAgICAgIDwvZGl2PgogICAgICA8L2Zvcm0+YAogICAgfSk7CiAgICBpZighZGF0YSkgcmV0dXJuOwogICAgaWYoZGF0YS5raW5kPT09ImRlcG9zaXQiKSBkZXBvc2l0KGN1cnJlbnRQZklkLCBkYXRhLmFtb3VudCwgZGF0YS5ub3RlfHwiIik7CiAgICBlbHNlIHdpdGhkcmF3KGN1cnJlbnRQZklkLCBkYXRhLmFtb3VudCwgZGF0YS5ub3RlfHwiIik7CiAgfSk7CgogICQoIiN3aXRoZHJhd0J0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIGNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybiBhbGVydCgiTmFqcGllcncgd3liaWVyeiBwb3J0ZmVsLiIpOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZW5Nb2RhbCh7CiAgICAgIHRpdGxlOiJXeXDFgmF0YSB6IHBvcnRmZWxhIiwKICAgICAgaW5uZXJIVE1MOmA8Zm9ybSBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGxhYmVsPkt3b3RhICgke3BmLmN1cnJlbmN5fSk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImFtb3VudCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgIDxsYWJlbD5Ob3RhdGthIChvcGNqb25hbG5pZSk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZm9ybT5gCiAgICB9KTsKICAgIGlmKGRhdGEgJiYgZGF0YS5hbW91bnQpeyB3aXRoZHJhdyhjdXJyZW50UGZJZCwgZGF0YS5hbW91bnQsIGRhdGEubm90ZXx8IiIpOyB9CiAgfSk7CgogICQoIiN0cmFuc2ZlckJ0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIGlmKERCLnBvcnRmb2xpb3MubGVuZ3RoPDIpeyByZXR1cm4gYWxlcnQoIkRvZGFqIHByenluYWptbmllaiBkd2EgcG9ydGZlbGUsIGFieSB3eWtvbmHEhyBwcnplbGV3LiIpOyB9CiAgICBjb25zdCBvcHRzID0gREIucG9ydGZvbGlvcy5tYXAocD0+YDxvcHRpb24gdmFsdWU9IiR7cC5pZH0iPiR7X19lc2MocC5uYW1lKX0gKCR7cC5jdXJyZW5jeX0pPC9vcHRpb24+YCkuam9pbigiIik7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6IlByemVsZXcgbWnEmWR6eSBwb3J0ZmVsYW1pIiwKICAgICAgaW5uZXJIVE1MOmA8Zm9ybSBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGxhYmVsPsW5csOzZMWCbzwvbGFiZWw+CiAgICAgICAgICA8c2VsZWN0IG5hbWU9ImZyb21JZCI+JHtvcHRzfTwvc2VsZWN0PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5DZWw8L2xhYmVsPgogICAgICAgICAgPHNlbGVjdCBuYW1lPSJ0b0lkIj4ke29wdHN9PC9zZWxlY3Q+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTYiPgogICAgICAgICAgPGxhYmVsPkt3b3RhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJhbW91bnQiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiByZXF1aXJlZCAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC02Ij4KICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPgogICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9Im5vdGUiIHBsYWNlaG9sZGVyPSJucC4gcG/FvHljemthIHogZmlybXkgQSBkbyBCIiAvPgogICAgICAgIDwvZGl2PgogICAgICA8L2Zvcm0+YAogICAgfSk7CiAgICBpZighZGF0YSkgcmV0dXJuOwogICAgdHJhbnNmZXIoZGF0YS5mcm9tSWQsIGRhdGEudG9JZCwgZGF0YS5hbW91bnQsIGRhdGEubm90ZXx8IiIpOwogIH0pOwoKICAkKCIjYnV5QnRuIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuIGFsZXJ0KCJOYWpwaWVydyB3eWJpZXJ6IHBvcnRmZWwuIik7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6Ilpha3VwIChub3dhIHBhcnRpYSkiLAogICAgICBpbm5lckhUTUw6YDxmb3JtIGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+VGlja2VyIDxzcGFuIGNsYXNzPSJzbWFsbCI+KEVudGVyIHBvYmllcnplIGt1cnMgeiBGaW5uaHViKTwvc3Bhbj48L2xhYmVsPgogICAgICAgICAgPGRpdiBjbGFzcz0icm93IiBzdHlsZT0iZ2FwOjZweCI+PGlucHV0IG5hbWU9InRpY2tlciIgaWQ9ImJ1eVRpY2tlciIgcGxhY2Vob2xkZXI9Im5wLiBUU0xBIC8gUEtOLldBIiByZXF1aXJlZCAvPjxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIHNlY29uZGFyeSIgaWQ9ImJ0bkZldGNoUHJpY2UiPlBvYmllcnogY2VuxJk8L2J1dHRvbj48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBnaG9zdCIgaWQ9ImJ0blNlYXJjaFN5bWJvbCI+U3p1a2FqIHN5bWJvbHU8L2J1dHRvbj48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+SWxvxZvEhzwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0icXR5IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiByZXF1aXJlZCAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5DZW5hIC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0icHJpY2UiIGlkPSJidXlQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHZhbHVlPSIwIiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+Q2VsIHp5c2t1ICUgKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHBsYWNlaG9sZGVyPSJucC4gNSA9ICs1JSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+Q2VsIGNlbmEgLyBzenQuIChvcGNqb25hbG5pZSk8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InRhcmdldFByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgcGxhY2Vob2xkZXI9Im5wLiAxMjAuMDAiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPkNlbCBLVVBOQSAlIChzcGFkZWssIG9wY2ouKTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHBsYWNlaG9sZGVyPSJucC4gNSA9IC01JSBvZCBrb3N6dHUiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPkNlbCBLVVBOQSBjZW5hIC8gc3p0LiAob3Bjai4pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJidXlUYXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHBsYWNlaG9sZGVyPSJucC4gOTUuMDAiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIHNtYWxsIiBpZD0iYnV5UHJpY2VNc2ciIHN0eWxlPSJtaW4taGVpZ2h0OjIwcHgiPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC0xMiI+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgcGxhY2Vob2xkZXI9Im5wLiB6YWt1cCB3ZyBzdHJhdGVnaWkgbW9tZW50dW0iIC8+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIHNtYWxsIj5Vd2FnYToga3VycyB6IEZpbm5odWIgbW/FvGUgYnnEhyB3IHdhbHVjaWUgbm90b3dhbmlhIGluc3RydW1lbnR1IChiZXoga29ud2Vyc2ppKS48L2Rpdj4KICAgICAgPC9mb3JtPmAKICAgIH0pOwogICAgY29uc3QgdEVsID0gJCgiI2J1eVRpY2tlciIpLCBwRWwgPSAkKCIjYnV5UHJpY2UiKSwgbXNnRWwgPSAkKCIjYnV5UHJpY2VNc2ciKTsKICAgIGFzeW5jIGZ1bmN0aW9uIHVpRmV0Y2hQcmljZSgpewogICAgICBtc2dFbC50ZXh0Q29udGVudCA9ICJQb2JpZXJhbSBjZW7EmSB6IEZpbm5odWLigKYiOwogICAgICBjb25zdCBzeW0gPSAodEVsLnZhbHVlfHwiIikudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGlmKCFzeW0peyBtc2dFbC50ZXh0Q29udGVudCA9ICJQb2RhaiBzeW1ib2wgKG5wLiBUU0xBLCBQS04uV0EpIjsgcmV0dXJuOyB9CiAgICAgIGNvbnN0IHtwcmljZSwgZXJyb3J9ID0gYXdhaXQgZmV0Y2hRdW90ZUZpbm5odWIoc3ltKTsKICAgICAgaWYocHJpY2UhPW51bGwpeyBwRWwudmFsdWUgPSBwcmljZTsgbXNnRWwudGV4dENvbnRlbnQgPSAiT0s6ICIgKyBwcmljZTsgfQogICAgICBlbHNlIHsgbXNnRWwudGV4dENvbnRlbnQgPSAiQsWCxIVkOiAiICsgKGVycm9yfHwiYnJhayBkYW55Y2giKTsgfQogICAgfQogICAgdEVsPy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgYXN5bmMgKGV2KT0+ewogICAgICBpZihldi5rZXk9PT0iRW50ZXIiKXsKICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGF3YWl0IHVpRmV0Y2hQcmljZSgpOwogICAgICB9CiAgICB9KTsKICAgICQoIiNidG5GZXRjaFByaWNlIik/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdWlGZXRjaFByaWNlKTsKCiAgICAkKCIjYnRuU2VhcmNoU3ltYm9sIik/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgICAgY29uc3QgcSA9ICh0RWwudmFsdWV8fCIiKS50cmltKCk7CiAgICAgIGNvbnN0IHtyZXN1bHQsIGVycm9yfSA9IGF3YWl0IHNlYXJjaFN5bWJvbEZpbm5odWIocXx8IioiKTsKICAgICAgaWYoZXJyb3IpeyBhbGVydCgiU3p1a2FqIHN5bWJvbHUg4oCUIGLFgsSFZDogIitlcnJvcik7IHJldHVybjsgfQogICAgICBpZighcmVzdWx0Lmxlbmd0aCl7IGFsZXJ0KCJCcmFrIHd5bmlrw7N3IGRsYTogIitxKTsgcmV0dXJuOyB9CiAgICAgIC8vIHNpbXBsZSBwaWNrZXIgaW4tcGxhY2UKICAgICAgY29uc3QgbGlzdCA9IHJlc3VsdC5zbGljZSgwLDEwKS5tYXAocj0+YAogICAgICAgIDx0ciBkYXRhLXN5bT0iJHtyLnN5bWJvbH0iPjx0ZD4ke3Iuc3ltYm9sfTwvdGQ+PHRkPiR7ci5kZXNjcmlwdGlvbnx8Jyd9PC90ZD48dGQgY2xhc3M9InNtYWxsIj4ke3IudHlwZXx8Jyd9PC90ZD48dGQgY2xhc3M9InNtYWxsIj4ke3IuZGlzcGxheVN5bWJvbHx8Jyd9PC90ZD48L3RyPgogICAgICBgKS5qb2luKCIiKTsKICAgICAgY29uc3QgcGlja2VyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHBpY2tlci5jbGFzc05hbWUgPSAiY2FyZCBwYW5lbCI7CiAgICAgIHBpY2tlci5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0ic21hbGwiIHN0eWxlPSJtYXJnaW46NnB4IDAiPld5Ymllcnogc3ltYm9sOjwvZGl2PjxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPjx0YWJsZT48dGhlYWQ+PHRyPjx0aD5TeW1ib2w8L3RoPjx0aD5PcGlzPC90aD48dGg+VHlwPC90aD48dGg+RGlzcGxheTwvdGg+PC90cj48L3RoZWFkPjx0Ym9keT4ke2xpc3R9PC90Ym9keT48L3RhYmxlPjwvZGl2PmA7CiAgICAgIG1vZGFsQ29udGVudC5hcHBlbmRDaGlsZChwaWNrZXIpOwogICAgICBwaWNrZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoZSk9PnsKICAgICAgICBjb25zdCB0ciA9IGUudGFyZ2V0LmNsb3Nlc3QoJ3RyW2RhdGEtc3ltXScpOyBpZighdHIpIHJldHVybjsKICAgICAgICBjb25zdCBzeW0gPSB0ci5nZXRBdHRyaWJ1dGUoJ2RhdGEtc3ltJyk7CiAgICAgICAgdEVsLnZhbHVlID0gc3ltOwogICAgICAgIHBpY2tlci5yZW1vdmUoKTsKICAgICAgICBhd2FpdCB1aUZldGNoUHJpY2UoKTsKICAgICAgfSwge29uY2U6ZmFsc2V9KTsKICAgIH0pOwoKICAgIGlmKCFkYXRhKSByZXR1cm47CiAgICBidXkoY3VycmVudFBmSWQsIHsKICAgICAgdGlja2VyOiBkYXRhLnRpY2tlciwgZGF0ZTogZGF0YS5kYXRlLCBxdHk6IGRhdGEucXR5LCBwcmljZTogZGF0YS5wcmljZSwgZmVlczogZGF0YS5mZWVzLCBub3RlOiBkYXRhLm5vdGUsCiAgICAgIHRhcmdldFBjdDogZGF0YS50YXJnZXRQY3QsIHRhcmdldFByaWNlOiBkYXRhLnRhcmdldFByaWNlLCBidXlUYXJnZXRQY3Q6IGRhdGEuYnV5VGFyZ2V0UGN0LCBidXlUYXJnZXRQcmljZTogZGF0YS5idXlUYXJnZXRQcmljZQogICAgfSk7CiAgfSk7CgogIAokKCIjc2VsbEJ0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm4gYWxlcnQoIk5hanBpZXJ3IHd5YmllcnogcG9ydGZlbC4iKTsKICBjb25zdCB0aWNrZXJzID0gT2JqZWN0LmtleXMocGYuaG9sZGluZ3N8fHt9KTsKICBpZighdGlja2Vycy5sZW5ndGgpIHJldHVybiBhbGVydCgiQnJhayBwb3p5Y2ppIGRvIHNwcnplZGHFvHkuIik7CiAgY29uc3Qgb3B0c1RpY2sgPSB0aWNrZXJzLm1hcCh0PT5gPG9wdGlvbiB2YWx1ZT0iJHt0fSI+JHt0fTwvb3B0aW9uPmApLmpvaW4oIiIpOwoKICBjb25zdCBwcm9tID0gb3Blbk1vZGFsKHsKICAgIHRpdGxlOiJTcHJ6ZWRhxbwg4oCUIHd5YmllcnogcGFydGllIGkgaWxvxZtjaSIsCiAgICBpbm5lckhUTUw6YDxmb3JtIGlkPSJzZWxsRm9ybSIgY2xhc3M9ImNvbnRlbnQiPgogICAgICA8bGFiZWw+VGlja2VyPC9sYWJlbD4KICAgICAgPHNlbGVjdCBuYW1lPSJ0aWNrZXIiIGlkPSJzZWxsVGlja2VyIj4ke29wdHNUaWNrfTwvc2VsZWN0PgogICAgICA8ZGl2IGlkPSJzZWxsTG90c0JveCIgc3R5bGU9Im1hcmdpbi10b3A6MTJweCI+PC9kaXY+CiAgICA8L2Zvcm0+YCwKICAgIG9rVGV4dDoiWmFrc2nEmWd1aiIKICB9KTsKCiAgY29uc3Qgc2VsRWwgPSAkKCIjc2VsbFRpY2tlciIpOwogIGNvbnN0IGxvdHNCb3ggPSAkKCIjc2VsbExvdHNCb3giKTsKICBmdW5jdGlvbiByZW5kZXJMb3RzKCl7CiAgICBjb25zdCB0ID0gc2VsRWwudmFsdWU7CiAgICBjb25zdCBib29rID0gcGYuaG9sZGluZ3NbdF07CiAgICBpZighYm9vayl7IGxvdHNCb3guaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J3NtYWxsJz5CcmFrIHBhcnRpaS48L2Rpdj4iOyByZXR1cm47IH0KICAgIGNvbnN0IHJvd3MgPSAoYm9vay5sb3RzfHxbXSkubWFwKGw9PmAKICAgICAgPHRyPgogICAgICAgIDx0ZD48Y29kZT4ke2wubG90SWQuc2xpY2UoMCw4KX08L3RkPgogICAgICAgIDx0ZD4ke19fZXNjKGwuZGF0ZXx8IiIpfTwvdGQ+CiAgICAgICAgPHRkPiR7X19mbXROdW0obC5xdHkpfTwvdGQ+CiAgICAgICAgPHRkPiR7X19nb19mbXRDdXJyZW5jeShsLnVuaXRDb3N0LCBwZi5jdXJyZW5jeSl9PC90ZD4KICAgICAgICA8dGQ+PGlucHV0IG5hbWU9ImxvdF8ke2wubG90SWR9IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiBtYXg9IiR7bC5xdHl9IiBwbGFjZWhvbGRlcj0iMCIgLz48L3RkPgogICAgICA8L3RyPgogICAgYCkuam9pbigiIik7CiAgICBsb3RzQm94LmlubmVySFRNTCA9IGAKICAgICAgPGRpdiBjbGFzcz0iZ3JpZCI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgPGxhYmVsPkNlbmEgc3ByemVkYcW8eSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InNlbGxQcmljZSIgaWQ9InNlbGxQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ic2VsbEZlZXMiIGlkPSJzZWxsRmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHZhbHVlPSIwIiAvPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJzZWxsRGF0ZSIgaWQ9InNlbGxEYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPgogICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InNlbGxOb3RlIiBpZD0ic2VsbE5vdGUiIHBsYWNlaG9sZGVyPSJucC4gcmVhbGl6YWNqYSB6eXNrdSIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6MTBweCI+PC9kaXY+CiAgICAgIDx0YWJsZT4KICAgICAgICA8dGhlYWQ+CiAgICAgICAgICA8dHI+PHRoPlBhcnRpYTwvdGg+PHRoPkRhdGE8L3RoPjx0aD5JbG/Fm8SHIGRvc3TEmXBuYTwvdGg+PHRoPktvc3p0IC8gc3p0LjwvdGg+PHRoPklsb8WbxIcgZG8gc3ByemVkYcW8eTwvdGg+PC90cj4KICAgICAgICA8L3RoZWFkPgogICAgICAgIDx0Ym9keT4ke3Jvd3N9PC90Ym9keT4KICAgICAgPC90YWJsZT4KICAgICAgPGRpdiBjbGFzcz0ic21hbGwiPldwaXN6IGlsb8WbY2kgZG8gc3ByemVkYcW8eSB3IHd5YnJhbnljaCBwYXJ0aWFjaCAoc3ByemVkYcW8IHNwZWN5Zmljem5hIOKAlCBuaWUgRklGTykuPC9kaXY+CiAgICBgOwogIH0KICByZW5kZXJMb3RzKCk7CiAgc2VsRWwuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVuZGVyTG90cyk7CgogIHByb20udGhlbihkYXRhPT57CiAgICBpZighZGF0YSkgcmV0dXJuOyAvLyBjYW5jZWwKICAgIGNvbnN0IHQgPSAoZGF0YS50aWNrZXJ8fCIiKS50b1VwcGVyQ2FzZSgpLnRyaW0oKTsKICAgIGNvbnN0IHBTZWxsID0gTnVtYmVyKGRhdGEuc2VsbFByaWNlfHwwKTsKICAgIGNvbnN0IGZlZXMgPSBOdW1iZXIoZGF0YS5zZWxsRmVlc3x8MCk7CiAgICBjb25zdCBkYXRlID0gZGF0YS5zZWxsRGF0ZSB8fCB0b2RheSgpOwogICAgY29uc3Qgbm90ZSA9IGRhdGEuc2VsbE5vdGUgfHwgIiI7CiAgICBjb25zdCBhbGxvY2F0aW9ucyA9IE9iamVjdC5lbnRyaWVzKGRhdGEpCiAgICAgIC5maWx0ZXIoKFtrLHZdKT0+IGsuc3RhcnRzV2l0aCgnbG90XycpICYmIE51bWJlcih2KT4wKQogICAgICAubWFwKChbayx2XSk9Pih7IGxvdElkOiBrLnNsaWNlKDQpLCBxdHk6IE51bWJlcih2KSB9KSk7CiAgICBzZWxsKGN1cnJlbnRQZklkLCB7IHRpY2tlcjogdCwgZGF0ZSwgc2VsbFByaWNlOiBwU2VsbCwgZmVlcywgYWxsb2NhdGlvbnMsIG5vdGUgfSk7CiAgfSk7Cn0pOwoKICAvLyBFeC9JbSBwb3J0CiAgZnVuY3Rpb24gZXhwb3J0SlNPTigpewogICAgY29uc3QgZGF0YSA9IEpTT04uc3RyaW5naWZ5KERCLCBudWxsLCAyKTsKICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbZGF0YV0sIHt0eXBlOiJhcHBsaWNhdGlvbi9qc29uIn0pOwogICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICBhLmhyZWYgPSB1cmw7CiAgICBhLmRvd25sb2FkID0gYHBvcnRmZWxlX2Zpcm15X2JhY2t1cF8ke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKX0uanNvbmA7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOwogICAgYS5jbGljaygpOwogICAgc2V0VGltZW91dCgoKT0+ewogICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgIGEucmVtb3ZlKCk7CiAgICB9LCAxMDAwKTsKICB9CiAgJCgiI2V4cG9ydEJ0biIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZXhwb3J0SlNPTik7CiAgJCgiI2V4cG9ydExpbmsyIikuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBleHBvcnRKU09OKTsKICAkKCIjaW1wb3J0TGluazIiKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT4gJCgiI2ltcG9ydEZpbGUiKS5jbGljaygpKTsKICAkKCIjaW1wb3J0RmlsZSIpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGFzeW5jIChlKT0+ewogICAgY29uc3QgZmlsZSA9IGUudGFyZ2V0LmZpbGVzWzBdOwogICAgaWYoIWZpbGUpIHJldHVybjsKICAgIGNvbnN0IHR4dCA9IGF3YWl0IGZpbGUudGV4dCgpOwogICAgdHJ5ewogICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHR4dCk7CiAgICAgIGlmKCFvYmoucG9ydGZvbGlvcykgdGhyb3cgbmV3IEVycm9yKCJCcmFrIGtsdWN6YSBwb3J0Zm9saW9zLiIpOwogICAgICBEQiA9IG9iajsgdHJ5eyBlbnN1cmVXYXRjaGxpc3RTdHJ1Y3R1cmUoKTsgfWNhdGNoKF8pe30gc2F2ZSgpOyByZW5kZXIoKTsgc3RhcnRQb2xsaW5nUXVvdGVzKCk7CiAgICAgIGFsZXJ0KCJaYWltcG9ydG93YW5vIGRhbmUuIik7CiAgICB9Y2F0Y2goZXJyKXsKICAgICAgYWxlcnQoIkLFgsSFZCBpbXBvcnR1OiAiK2Vyci5tZXNzYWdlKTsKICAgIH0KICAgIGUudGFyZ2V0LnZhbHVlID0gIiI7CiAgfSk7CgogIAogIC8vIEhpc3RvcnkgYWN0aW9uczogRWRpdCAvIERlbGV0ZQogIHR4VGFibGVXcmFwLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpPT57CiAgICBjb25zdCByb3cgPSBlLnRhcmdldC5jbG9zZXN0KCd0ci50eC1yb3cnKTsKICAgIGNvbnN0IGJ0biA9IGUudGFyZ2V0LmNsb3Nlc3QoJ2J1dHRvbicpOwogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuOwogICAgaWYocm93ICYmICFidG4peyAvLyBjbGljayByb3cgdG8gZWRpdAogICAgICBjb25zdCB0eElkID0gcm93LmdldEF0dHJpYnV0ZSgnZGF0YS10eCcpOwogICAgICBjb25zdCB0eEluZGV4ID0gcGYudHJhbnNhY3Rpb25zLmZpbmRJbmRleCh4PT54LmlkPT09dHhJZCk7CiAgICAgIGlmKHR4SW5kZXg+PTApeyBjb25zdCBmYWtlQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7IGZha2VCdG4uY2xhc3NOYW1lPSd0eC1lZGl0JzsgZmFrZUJ0bi5zZXRBdHRyaWJ1dGUoJ2RhdGEtdHgnLCB0eElkKTsgZmFrZUJ0bi5jbGljaygpOyB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmKCFidG4pIHJldHVybjsKICAgIGNvbnN0IHR4SWQgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLXR4Jyk7IGlmKCF0eElkKSByZXR1cm47CiAgICBjb25zdCB0eEluZGV4ID0gcGYudHJhbnNhY3Rpb25zLmZpbmRJbmRleCh4PT54LmlkPT09dHhJZCk7CiAgICBpZih0eEluZGV4PDApIHJldHVybjsKCiAgICBpZihidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCd0eC1zZWxsLWZyb20tYnV5JykpewogICAgICBjb25zdCB0eElkID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10eCcpOwogICAgICBjb25zdCB0eEluZGV4ID0gcGYudHJhbnNhY3Rpb25zLmZpbmRJbmRleCh4PT54LmlkPT09dHhJZCk7CiAgICAgIGlmKHR4SW5kZXg8MCkgcmV0dXJuOwogICAgICBjb25zdCB0ID0gcGYudHJhbnNhY3Rpb25zW3R4SW5kZXhdOwogICAgICBpZih0LnR5cGUhPT0nYnV5Jyl7IHJldHVybjsgfQogICAgICBjb25zdCBsb3RJZCA9IHQubG90SWQ7IGNvbnN0IHRpY2tlciA9IHQudGlja2VyOyBjb25zdCBtYXhRdHkgPSB0LnF0eTsKICAgICAgY29uc3QgZm9ybUhUTUwgPSBgPGZvcm0gY2xhc3M9ImdyaWQiPgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+Q2VuYSBzcHJ6ZWRhxbx5IC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJzZWxsUHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHJlcXVpcmVkIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPk9wxYJhdHk8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiBtaW49IjAiIHZhbHVlPSIwIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5EYXRhPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3RvZGF5KCl9IiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5JbG/Fm8SHIGRvIHNwcnplZGHFvHk8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0icXR5IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgbWluPSIwIiBtYXg9IiR7bWF4UXR5fSIgdmFsdWU9IiR7bWF4UXR5fSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTEyIj4KICAgICAgICAgICAgPGxhYmVsPk5vdGF0a2E8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgcGxhY2Vob2xkZXI9InNwcnplZGHFvCB0ZWogdHJhbnNha2NqaSAoc3p5YmthKSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZm9ybT5gOwogICAgICBvcGVuTW9kYWwoeyB0aXRsZTpgU3ByemVkYWogdMSZIHRyYW5zYWtjasSZIOKAlCAke19fZXNjKHRpY2tlcil9YCwgaW5uZXJIVE1MOiBmb3JtSFRNTCwgb2tUZXh0OidaYWtzacSZZ3VqJyB9KS50aGVuKGRhdGE9PnsKICAgICAgICBpZighZGF0YSkgcmV0dXJuOwogICAgICAgIGNvbnN0IHF0eSA9IE51bWJlcihkYXRhLnF0eXx8MCk7CiAgICAgICAgY29uc3QgcHJpY2UgPSBOdW1iZXIoZGF0YS5zZWxsUHJpY2V8fDApOwogICAgICAgIGNvbnN0IGZlZXMgPSBOdW1iZXIoZGF0YS5mZWVzfHwwKTsKICAgICAgICBjb25zdCBkYXRlID0gZGF0YS5kYXRlIHx8IHRvZGF5KCk7CiAgICAgICAgY29uc3Qgbm90ZSA9IGRhdGEubm90ZSB8fCAnJzsKICAgICAgICBpZihxdHk8PTAgfHwgcHJpY2U8PTApeyBhbGVydCgnUG9kYWogaWxvxZvEhyBpIGNlbsSZLicpOyByZXR1cm47IH0KICAgICAgICBzZWxsKGN1cnJlbnRQZklkLCB7IHRpY2tlciwgZGF0ZSwgc2VsbFByaWNlOiBwcmljZSwgZmVlcywgYWxsb2NhdGlvbnM6IFt7IGxvdElkLCBxdHkgfV0sIG5vdGUgfSk7CiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYoYnRuLmNsYXNzTGlzdC5jb250YWlucygndHgtZGVsJykpewogICAgICBjb25zdCBvayA9IGNvbmZpcm0oIlVzdW7EhcSHIHTEmSB0cmFuc2FrY2rEmT8gT3BlcmFjamEgbmllb2R3cmFjYWxuYS4iKTsKICAgICAgaWYoIW9rKSByZXR1cm47CiAgICAgIHBmLnRyYW5zYWN0aW9ucy5zcGxpY2UodHhJbmRleCwxKTsKICAgICAgcmVidWlsZFBvcnRmb2xpbyhwZik7IHNhdmUoKTsgcmVuZGVyKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZihidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCd0eC1lZGl0JykpewogICAgICBjb25zdCB0ID0gcGYudHJhbnNhY3Rpb25zW3R4SW5kZXhdOwogICAgICAvLyBCdWlsZCBmb3JtIHBlciB0eXBlCiAgICAgIGxldCBmb3JtSFRNTCA9ICIiOwogICAgICBpZih0LnR5cGU9PT0iZGVwb3NpdCIgfHwgdC50eXBlPT09IndpdGhkcmF3IiB8fCB0LnR5cGU9PT0idHJhbnNmZXJfaW4iIHx8IHQudHlwZT09PSJ0cmFuc2Zlcl9vdXQiKXsKICAgICAgICBmb3JtSFRNTCA9IGA8Zm9ybT4KICAgICAgICAgIDxsYWJlbD5Ld290YSAoJHtwZi5jdXJyZW5jeX0pPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJhbW91bnQiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgdmFsdWU9IiR7dC5hbW91bnR8fDB9IiAvPgogICAgICAgICAgPGxhYmVsPkRhdGE8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3QuZGF0ZXx8dG9kYXkoKX0iIC8+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgdmFsdWU9IiR7X19lc2ModC5ub3RlfHwnJyl9IiAvPgogICAgICAgIDwvZm9ybT5gOwogICAgICB9ZWxzZSBpZih0LnR5cGU9PT0iYnV5Iil7CiAgICAgICAgZm9ybUhUTUwgPSBgPGZvcm0+CiAgICAgICAgICA8bGFiZWw+VGlja2VyPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0aWNrZXIiIHZhbHVlPSIke19fZXNjKHQudGlja2VyfHwnJyl9IiAvPgogICAgICAgICAgPGxhYmVsPklsb8WbxIc8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InF0eSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHZhbHVlPSIke3QucXR5fHwwfSIgLz4KICAgICAgICAgIDxsYWJlbD5DZW5hIC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0icHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LnByaWNlfHwwfSIgLz4KICAgICAgICAgIDxsYWJlbD5PcMWCYXR5PC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJmZWVzIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIke3QuZmVlc3x8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dC5kYXRlfHx0b2RheSgpfSIgLz4KICAgICAgICAgIDxsYWJlbD5Ob3RhdGthPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiB2YWx1ZT0iJHtfX2VzYyh0Lm5vdGV8fCcnKX0iIC8+CiAgICAgICAgCiAgICAgICAgPGxhYmVsPkNlbCB6eXNrdSAlIChvcGNqb25hbG5pZSk8L2xhYmVsPgogICAgICAgIDxpbnB1dCBuYW1lPSJ0YXJnZXRQY3QiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgdmFsdWU9IiR7dC50YXJnZXRQY3QgPz8gJyd9IiBwbGFjZWhvbGRlcj0ibnAuIDUgPSArNSUiIC8+CiAgICAgICAgPGxhYmVsPkNlbCBjZW5hIC8gc3p0LiAob3Bjam9uYWxuaWUpPC9sYWJlbD4KICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LnRhcmdldFByaWNlID8/ICcnfSIgcGxhY2Vob2xkZXI9Im5wLiAxMjAuMDAiIC8+CiAgICAgICAgPGxhYmVsPkNlbCBLVVBOQSAlIChzcGFkZWssIG9wY2ouKTwvbGFiZWw+CiAgICAgICAgPGlucHV0IG5hbWU9ImJ1eVRhcmdldFBjdCIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiB2YWx1ZT0iJHt0LmJ1eVRhcmdldFBjdCA/PyAnJ30iIHBsYWNlaG9sZGVyPSJucC4gNSA9IC01JSBvZCBrb3N6dHUiIC8+CiAgICAgICAgPGxhYmVsPkNlbCBLVVBOQSBjZW5hIC8gc3p0LiAob3Bjai4pPC9sYWJlbD4KICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LmJ1eVRhcmdldFByaWNlID8/ICcnfSIgcGxhY2Vob2xkZXI9Im5wLiA5NS4wMCIgLz4KICAgICAgICAKICAgICAgICA8L2Zvcm0+YDsKICAgICAgfWVsc2UgaWYodC50eXBlPT09InNlbGwiKXsKICAgICAgICAvLyBGb3Igbm93OiBlZGl0IHByaWNlL2ZlZXMvZGF0ZS9ub3RlOyBhbGxvY2F0aW9ucyBwb3pvc3RhasSFIGJleiB6bWlhbgogICAgICAgIGZvcm1IVE1MID0gYDxmb3JtPgogICAgICAgICAgPGRpdiBjbGFzcz0ic21hbGwiPkVkeWNqYSBzcHJ6ZWRhxbx5IGRvdHljenkgY2VueS9vcMWCYXQvZGF0eS91d2FnLiAoQWxva2FjamUgcGFydGlpIGJleiB6bWlhbiB3IHRlaiB3ZXJzamkpPC9kaXY+CiAgICAgICAgICA8bGFiZWw+VGlja2VyPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0aWNrZXIiIHZhbHVlPSIke19fZXNjKHQudGlja2VyfHwnJyl9IiAvPgogICAgICAgICAgPGxhYmVsPsWBxIVjem5hIGlsb8WbxIcgKGluZm9ybWFjeWpuaWUpPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgdmFsdWU9IiR7dC5xdHl8fDB9IiBkaXNhYmxlZCAvPgogICAgICAgICAgPGxhYmVsPkNlbmEgc3ByemVkYcW8eSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InByaWNlIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDAwMSIgdmFsdWU9IiR7dC5wcmljZXx8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZmVlcyIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAxIiB2YWx1ZT0iJHt0LmZlZXN8fDB9IiAvPgogICAgICAgICAgPGxhYmVsPkRhdGE8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9ImRhdGUiIHR5cGU9ImRhdGUiIHZhbHVlPSIke3QuZGF0ZXx8dG9kYXkoKX0iIC8+CiAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0ibm90ZSIgdmFsdWU9IiR7X19lc2ModC5ub3RlfHwnJyl9IiAvPgogICAgICAgIDwvZm9ybT5gOwogICAgICB9CgogICAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsgdGl0bGU6IkVkeXR1aiB0cmFuc2FrY2rEmSIsIGlubmVySFRNTDogZm9ybUhUTUwsIG9rVGV4dDoiWmFwaXN6IiB9KTsKICAgICAgaWYoIWRhdGEpIHJldHVybjsKCiAgICAgIC8vIEFwcGx5IGVkaXRzCiAgICAgIGlmKHQudHlwZT09PSJkZXBvc2l0IiB8fCB0LnR5cGU9PT0id2l0aGRyYXciIHx8IHQudHlwZT09PSJ0cmFuc2Zlcl9pbiIgfHwgdC50eXBlPT09InRyYW5zZmVyX291dCIpewogICAgICAgIHQuYW1vdW50ID0gTnVtYmVyKGRhdGEuYW1vdW50KXx8MDsKICAgICAgICB0LmRhdGUgPSBkYXRhLmRhdGUgfHwgdC5kYXRlOwogICAgICAgIHQubm90ZSA9IGRhdGEubm90ZSB8fCAiIjsKICAgICAgfWVsc2UgaWYodC50eXBlPT09ImJ1eSIpewogICAgICAgIHQudGlja2VyID0gKGRhdGEudGlja2VyfHx0LnRpY2tlcnx8IiIpLnRvVXBwZXJDYXNlKCkudHJpbSgpOwogICAgICAgIHQucXR5ID0gTnVtYmVyKGRhdGEucXR5KXx8dC5xdHk7CiAgICAgICAgdC5wcmljZSA9IE51bWJlcihkYXRhLnByaWNlKXx8dC5wcmljZTsKICAgICAgICB0LmZlZXMgPSBOdW1iZXIoZGF0YS5mZWVzKXx8dC5mZWVzOwogICAgICAgIHQuZGF0ZSA9IGRhdGEuZGF0ZSB8fCB0LmRhdGU7CiAgICAgICAgdC5ub3RlID0gZGF0YS5ub3RlIHx8ICIiOwogICAgICAgIGVuc3VyZUJ1eUxvdElkSW5UeCh0KTsKICAgICAgfWVsc2UgaWYodC50eXBlPT09InNlbGwiKXsKICAgICAgICB0LnRpY2tlciA9IChkYXRhLnRpY2tlcnx8dC50aWNrZXJ8fCIiKS50b1VwcGVyQ2FzZSgpLnRyaW0oKTsKICAgICAgICB0LnByaWNlID0gTnVtYmVyKGRhdGEucHJpY2UpfHx0LnByaWNlOwogICAgICAgIHQuZmVlcyA9IE51bWJlcihkYXRhLmZlZXMpfHx0LmZlZXM7CiAgICAgICAgdC5kYXRlID0gZGF0YS5kYXRlIHx8IHQuZGF0ZTsKICAgICAgICB0Lm5vdGUgPSBkYXRhLm5vdGUgfHwgIiI7CiAgICAgICAgLy8gZ3Jvc3MvbmV0IHdpbGwgYmUgcmVjb21wdXRlZCBkdXJpbmcgcmVidWlsZAogICAgICB9CiAgICAgIC8vIFJlYnVpbGQgdG8ga2VlcCBldmVyeXRoaW5nIGNvbnNpc3RlbnQKICAgICAgdHJ5ewogICAgICAgIHJlYnVpbGRQb3J0Zm9saW8ocGYpOwogICAgICB9Y2F0Y2goZXJyKXsKICAgICAgICBhbGVydCgiRWR5Y2phIHBvd29kdWplIG5pZXNww7Nqbm/Fm8SHIChucC4gc3ByemVkYcW8ID4gcG9zaWFkYW5lKS4gU3pjemVnw7PFgnk6ICIrZXJyLm1lc3NhZ2UpOwogICAgICAgIHJldHVybjsgLy8gZG8gbm90IHNhdmUvcmVuZGVyIG9uIGZhaWx1cmUKICAgICAgfQogICAgICBzYXZlKCk7IHJlbmRlcigpOwogICAgfQogIH0pOwoKICAKICAvLyBRdWljayBhY3Rpb25zIGluIGhvbGRpbmdzOiBlZGl0IGxvdCAoYnV5IHR4KSBvciBzZWxsIHRoaXMgbG90CiAgaG9sZGluZ3NUYWJsZVdyYXAuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoZSk9PnsKICAgIGNvbnN0IGJ0biA9IGUudGFyZ2V0LmNsb3Nlc3QoJ2J1dHRvbicpOyBpZighYnRuKSByZXR1cm47CiAgICAKCiAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnZGVsLWNvbXBhbnknKSl7CiAgICAgIGNvbnN0IHRpY2tlciA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyk7CiAgICAgIGlmKCF0aWNrZXIpIHJldHVybjsKICAgICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuOwogICAgICBjb25zdCBvayA9IGNvbmZpcm0oYE5hIHBld25vIHVzdW7EhcSHIHNww7PFgmvEmSAke3RpY2tlcn0geiBwb3J0ZmVsYSAoc2thc3VqZSBXU1pZU1RLSUUgdHJhbnNha2NqZSB0ZWogc3DDs8WCa2kpP2ApOwogICAgICBpZighb2spIHJldHVybjsKICAgICAgdHJ5ewogICAgICAgIHBmLnRyYW5zYWN0aW9ucyA9IChwZi50cmFuc2FjdGlvbnN8fFtdKS5maWx0ZXIodHggPT4gKHR4LnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCkgIT09IHRpY2tlcik7CiAgICAgICAgdHJ5eyBkZWxldGUgcGYuaG9sZGluZ3NbdGlja2VyXTsgfWNhdGNoKF8pe30KICAgICAgICByZWJ1aWxkUG9ydGZvbGlvKHBmKTsKICAgICAgICBzYXZlKCk7IHJlbmRlcigpOwogICAgICAgIHRyeXsgc2hvd1RvYXN0ICYmIHNob3dUb2FzdCh7dGl0bGU6J1VzdW5pxJl0byBzcMOzxYJrxJknLCBtZXNzYWdlOnRpY2tlcn0pOyB9Y2F0Y2goXyl7fQogICAgICB9Y2F0Y2goZXJyKXsKICAgICAgICBhbGVydCgnTmllIHVkYcWCbyBzacSZIHVzdW7EhcSHIHNww7PFgmtpOiAnICsgKGVyciAmJiBlcnIubWVzc2FnZSB8fCBlcnIpKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoYnRuLmNsYXNzTGlzdC5jb250YWlucygnaW5mby1jb21wYW55JykpewogICAgICBjb25zdCB0aWNrZXIgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLXRpY2tlcicpOwogICAgICBpZighdGlja2VyKSByZXR1cm47CiAgICAgIG9wZW5Db21wYW55SW5mb01vZGFsKHRpY2tlcik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ3RyYW5zZmVyLWNvbXBhbnknKSl7CiAgY29uc3QgdGlja2VyID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsKICBhd2FpdCB0cmFuc2ZlckNvbXBhbnlEaWFsb2coY3VycmVudFBmSWQsIHRpY2tlcik7CiAgcmV0dXJuOwp9CmNvbnN0IHBmID0gZ2V0UGYoY3VycmVudFBmSWQpOyBpZighcGYpIHJldHVybjsKICAgIGlmKGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoJ2xvdC1lZGl0JykpewogICAgICBjb25zdCB0aWNrZXIgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLXRpY2tlcicpOwogICAgICBjb25zdCBsb3RJZCA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtbG90Jyk7CiAgICAgIGNvbnN0IHR4SW5kZXggPSBwZi50cmFuc2FjdGlvbnMuZmluZEluZGV4KHg9PiB4LnR5cGU9PT0nYnV5JyAmJiB4LmxvdElkPT09bG90SWQpOwogICAgICBpZih0eEluZGV4PDApIHsgYWxlcnQoJ05pZSB6bmFsZXppb25vIHRyYW5zYWtjamkgemFrdXB1IGRsYSB0ZWogcGFydGlpLicpOyByZXR1cm47IH0KICAgICAgY29uc3QgdCA9IHBmLnRyYW5zYWN0aW9uc1t0eEluZGV4XTsKICAgICAgY29uc3QgZm9ybUhUTUwgPSBgPGZvcm0+CiAgICAgICAgICA8bGFiZWw+VGlja2VyPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0aWNrZXIiIHZhbHVlPSIke19fZXNjKHQudGlja2VyfHwnJyl9IiAvPgogICAgICAgICAgPGxhYmVsPklsb8WbxIc8L2xhYmVsPgogICAgICAgICAgPGlucHV0IG5hbWU9InF0eSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHZhbHVlPSIke3QucXR5fHwwfSIgLz4KICAgICAgICAgIDxsYWJlbD5DZW5hIC8gc3p0LjwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0icHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiB2YWx1ZT0iJHt0LnByaWNlfHwwfSIgLz4KICAgICAgICAgIDxsYWJlbD5PcMWCYXR5PC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJmZWVzIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIke3QuZmVlc3x8MH0iIC8+CiAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iZGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dC5kYXRlfHx0b2RheSgpfSIgLz4KICAgICAgICAgIDxsYWJlbD5DZWwgenlza3UgJTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIke3QudGFyZ2V0UGN0Pz8nJ30iIC8+CiAgICAgICAgICA8bGFiZWw+Q2VsIGNlbmEgLyBzenQuPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0YXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHZhbHVlPSIke3QudGFyZ2V0UHJpY2U/PycnfSIgLz4KICAgICAgICAgIDxsYWJlbD5DZWwgS1VQTkEgJTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIke3QuYnV5VGFyZ2V0UGN0Pz8nJ30iIC8+CiAgICAgICAgICA8bGFiZWw+Q2VsIEtVUE5BIGNlbmEgLyBzenQuPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJidXlUYXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHZhbHVlPSIke3QuYnV5VGFyZ2V0UHJpY2U/PycnfSIgLz4KICAgICAgICAgIDxsYWJlbD5Ob3RhdGthPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiB2YWx1ZT0iJHtfX2VzYyh0Lm5vdGV8fCcnKX0iIC8+CiAgICAgICAgPC9mb3JtPmA7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoeyB0aXRsZToiRWR5dHVqIHpha3VwIChwYXJ0aWEpIiwgaW5uZXJIVE1MOiBmb3JtSFRNTCwgb2tUZXh0OiJaYXBpc3oiICB9KTsKaWYoIWRhdGEpIHJldHVybjsKICAgICAgdC50aWNrZXIgPSAoZGF0YS50aWNrZXJ8fHQudGlja2VyfHwnJykudG9VcHBlckNhc2UoKS50cmltKCk7CiAgICAgIHQucXR5ID0gTnVtYmVyKGRhdGEucXR5KXx8dC5xdHk7CiAgICAgIHQucHJpY2UgPSBOdW1iZXIoZGF0YS5wcmljZSl8fHQucHJpY2U7CiAgICAgIHQuZmVlcyA9IE51bWJlcihkYXRhLmZlZXMpfHx0LmZlZXM7CiAgICAgIHQuZGF0ZSA9IGRhdGEuZGF0ZSB8fCB0LmRhdGU7CiAgICAgIHQubm90ZSA9IGRhdGEubm90ZSB8fCAiIjsKICAgICAgdC50YXJnZXRQY3QgPSAoZGF0YS50YXJnZXRQY3QhPT0nJyAmJiBkYXRhLnRhcmdldFBjdCE9PXVuZGVmaW5lZCkgPyBOdW1iZXIoZGF0YS50YXJnZXRQY3QpIDogbnVsbDsKICAgICAgdC50YXJnZXRQcmljZSA9IChkYXRhLnRhcmdldFByaWNlIT09JycgJiYgZGF0YS50YXJnZXRQcmljZSE9PXVuZGVmaW5lZCkgPyBOdW1iZXIoZGF0YS50YXJnZXRQcmljZSkgOiBudWxsOwogICAgICAgIHQuYnV5VGFyZ2V0UGN0ID0gKGRhdGEuYnV5VGFyZ2V0UGN0IT09JycgJiYgZGF0YS5idXlUYXJnZXRQY3QhPT11bmRlZmluZWQpID8gTnVtYmVyKFN0cmluZyhkYXRhLmJ1eVRhcmdldFBjdCkucmVwbGFjZSgnLCcsICcuJykpIDogbnVsbDsKICAgICAgICB0LmJ1eVRhcmdldFByaWNlID0gKGRhdGEuYnV5VGFyZ2V0UHJpY2UhPT0nJyAmJiBkYXRhLmJ1eVRhcmdldFByaWNlIT09dW5kZWZpbmVkKSA/IE51bWJlcihTdHJpbmcoZGF0YS5idXlUYXJnZXRQcmljZSkucmVwbGFjZSgnLCcsICcuJykpIDogbnVsbDsKICAgICAgdHJ5ewogICAgICAgIHJlYnVpbGRQb3J0Zm9saW8ocGYpOwogICAgICB9Y2F0Y2goZXJyKXsKICAgICAgICBhbGVydCgiRWR5Y2phIHBvd29kdWplIG5pZXNww7Nqbm/Fm8SHIChucC4gc3ByemVkYcW8ID4gcG9zaWFkYW5lKS4gU3pjemVnw7PFgnk6ICIrZXJyLm1lc3NhZ2UpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzYXZlKCk7IHJlbmRlcigpOwogICAgfQogICAgaWYoYnRuLmNsYXNzTGlzdC5jb250YWlucygnbG90LXNlbGwnKSl7CiAgICAgIGNvbnN0IHRpY2tlciA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGlja2VyJyk7CiAgICAgIGNvbnN0IGxvdElkID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS1sb3QnKTsKICAgICAgY29uc3QgbWF4UXR5ID0gTnVtYmVyKGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtbWF4cXR5Jyl8fDApOwogICAgICBjb25zdCBmb3JtSFRNTCA9IGA8Zm9ybSBjbGFzcz0iZ3JpZCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5DZW5hIHNwcnplZGHFvHkgLyBzenQuPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9InNlbGxQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+T3DFgmF0eTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJmZWVzIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIG1pbj0iMCIgdmFsdWU9IjAiIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPkRhdGE8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0iZGF0ZSIgdHlwZT0iZGF0ZSIgdmFsdWU9IiR7dG9kYXkoKX0iIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPklsb8WbxIcgZG8gc3ByemVkYcW8eTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJxdHkiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIG1heD0iJHttYXhRdHl9IiB2YWx1ZT0iJHttYXhRdHl9IiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPgogICAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJub3RlIiBwbGFjZWhvbGRlcj0ic3ByemVkYcW8IHBhcnRpaSAjIChzenlia2EpIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9mb3JtPmA7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoeyB0aXRsZTpgU3ByemVkYWogcGFydGnEmSDigJQgJHtfX2VzYyh0aWNrZXIpfWAsIGlubmVySFRNTDogZm9ybUhUTUwsIG9rVGV4dDoiWmFrc2nEmWd1aiIgfSk7CiAgICAgIGlmKCFkYXRhKSByZXR1cm47CiAgICAgIGNvbnN0IHF0eSA9IE51bWJlcihkYXRhLnF0eXx8MCk7CiAgICAgIGNvbnN0IHByaWNlID0gTnVtYmVyKGRhdGEuc2VsbFByaWNlfHwwKTsKICAgICAgY29uc3QgZmVlcyA9IE51bWJlcihkYXRhLmZlZXN8fDApOwogICAgICBjb25zdCBkYXRlID0gZGF0YS5kYXRlIHx8IHRvZGF5KCk7CiAgICAgIGNvbnN0IG5vdGUgPSBkYXRhLm5vdGUgfHwgIiI7CiAgICAgIGlmKHF0eTw9MCB8fCBwcmljZTw9MCl7IGFsZXJ0KCJQb2RhaiBpbG/Fm8SHIGkgY2VuxJkuIik7IHJldHVybjsgfQogICAgICBzZWxsKGN1cnJlbnRQZklkLCB7IHRpY2tlciwgZGF0ZSwgc2VsbFByaWNlOiBwcmljZSwgZmVlcywgYWxsb2NhdGlvbnM6IFt7IGxvdElkLCBxdHkgfV0sIG5vdGUgfSk7CiAgICB9CiAgICBpZihidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdhZGQtbG90JykpewogICAgICBjb25zdCB0aWNrZXIgPSAoYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKXx8JycpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICAgIGNvbnN0IGxhc3RQcmljZSA9IGdldFF1b3RlKHRpY2tlcik7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVuTW9kYWwoewogICAgICAgIHRpdGxlOiBgWmFrdXAgKG5vd2EgcGFydGlhKSDigJQgJHt0aWNrZXJ9YCwKICAgICAgICBpbm5lckhUTUw6IGA8Zm9ybSBjbGFzcz0iZ3JpZCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5UaWNrZXI8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0idGlja2VyIiB2YWx1ZT0iJHt0aWNrZXJ9IiByZWFkb25seSAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5JbG/Fm8SHPC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9InF0eSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIG1pbj0iMCIgcmVxdWlyZWQgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+Q2VuYSAvIHN6dC48L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0icHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBtaW49IjAiIHZhbHVlPSIke2xhc3RQcmljZSE9bnVsbD9sYXN0UHJpY2U6Jyd9IiByZXF1aXJlZCAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5PcMWCYXR5PC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IG5hbWU9ImZlZXMiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgbWluPSIwIiB2YWx1ZT0iMCIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+RGF0YTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJkYXRlIiB0eXBlPSJkYXRlIiB2YWx1ZT0iJHt0b2RheSgpfSIgLz4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iY29sLTQiPgogICAgICAgICAgICA8bGFiZWw+Q2VsIHp5c2t1ICUgKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0YXJnZXRQY3QiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgcGxhY2Vob2xkZXI9Im5wLiA1ID0gKzUlIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5DZWwgY2VuYSAvIHN6dC4gKG9wY2pvbmFsbmllKTwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBuYW1lPSJ0YXJnZXRQcmljZSIgdHlwZT0ibnVtYmVyIiBzdGVwPSIwLjAwMDEiIHBsYWNlaG9sZGVyPSJucC4gMTIwLjAwIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtNCI+CiAgICAgICAgICAgIDxsYWJlbD5DZWwgS1VQTkEgJSAoc3BhZGVrLCBvcGNqLik8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UGN0IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHBsYWNlaG9sZGVyPSJucC4gLTUgPSBrdXAgcHJ6eSAtNSUiIC8+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC00Ij4KICAgICAgICAgICAgPGxhYmVsPkNlbCBLVVBOQSwgY2VuYS9zenQuIChvcGNqLik8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgbmFtZT0iYnV5VGFyZ2V0UHJpY2UiIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAxIiBwbGFjZWhvbGRlcj0ibnAuIDkwLjAwIiAvPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtMTIiPgogICAgICAgICAgICA8bGFiZWw+Tm90YXRrYTwvbGFiZWw+CiAgICAgICAgICAgIDx0ZXh0YXJlYSBuYW1lPSJub3RlIiByb3dzPSIyIiBwbGFjZWhvbGRlcj0ibnAuIGRva3VwIHBvZCBvZGJpY2llIj48L3RleHRhcmVhPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9mb3JtPmAKICAgICAgfSk7CiAgICAgIGlmKCFkYXRhKSByZXR1cm47CiAgICAgIGJ1eShjdXJyZW50UGZJZCwgewogICAgICAgIHRpY2tlcjogZGF0YS50aWNrZXIsIGRhdGU6IGRhdGEuZGF0ZSwgcXR5OiBkYXRhLnF0eSwgcHJpY2U6IGRhdGEucHJpY2UsIGZlZXM6IGRhdGEuZmVlcywgbm90ZTogZGF0YS5ub3RlLAogICAgICAgIHRhcmdldFBjdDogZGF0YS50YXJnZXRQY3QsIHRhcmdldFByaWNlOiBkYXRhLnRhcmdldFByaWNlLAogICAgICAgIGJ1eVRhcmdldFBjdDogZGF0YS5idXlUYXJnZXRQY3QsIGJ1eVRhcmdldFByaWNlOiBkYXRhLmJ1eVRhcmdldFByaWNlCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CgogZWxzZSBpZihidG4uY2xhc3NMaXN0LmNvbnRhaW5zKCdsb3QtbXV0ZScpKXsKICAgICAgY29uc3QgbG90SWQgPSBidG4uZ2V0QXR0cmlidXRlKCdkYXRhLWxvdCcpOwogICAgICAvLyBmaW5kIHRoZSBsb3QgaW4gY3VycmVudCBwb3J0Zm9saW8KICAgICAgbGV0IHRhcmdldCA9IG51bGwsIHRhcmdldFRpY2tlcj1udWxsOwogICAgICBmb3IoY29uc3QgW3RrLCBib29rXSBvZiBPYmplY3QuZW50cmllcyhwZi5ob2xkaW5nc3x8e30pKXsKICAgICAgICBjb25zdCBmb3VuZCA9IChib29rLmxvdHN8fFtdKS5maW5kKHg9PiB4LmxvdElkID09PSBsb3RJZCk7CiAgICAgICAgaWYoZm91bmQpeyB0YXJnZXQgPSBmb3VuZDsgdGFyZ2V0VGlja2VyPXRrOyBicmVhazsgfQogICAgICB9CiAgICAgIGlmKCF0YXJnZXQpIHJldHVybjsKICAgICAgdGFyZ2V0Lm11dGVkID0gIXRhcmdldC5tdXRlZDsKICAgICAgc2F2ZSgpOyByZW5kZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQp9KTsKCgogIC8vIFRhYiBidXR0b24KICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lzaGxpc3RUYWJCdG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ewogICAgY29uc3QgaXNXaXNobGlzdFZpc2libGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lzaGxpc3RQYW5lbCcpPy5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZSc7CiAgICBzZXRBY3RpdmVWaWV3KGlzV2lzaGxpc3RWaXNpYmxlID8gJ3BvcnRmb2xpbycgOiAnd2lzaGxpc3QnKTsKICB9KTsKCiAgLy8gV2lzaGxpc3QgZm9ybSBhY3Rpb25zCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsU2VhcmNoJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIGNvbnN0IHEgPSAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsVGlja2VyJyk/LnZhbHVlfHwnJykudHJpbSgpOwogICAgYXdhaXQgd2xTZWFyY2hTeW1ib2xzKHEpOwogIH0pOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bEFkZCcpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICBjb25zdCB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsVGlja2VyJyk/LnZhbHVlfHwnJzsKICAgIGNvbnN0IHAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2xQcmljZScpPy52YWx1ZXx8Jyc7CiAgICBhZGRXYXRjaEl0ZW0odCwgcCk7CiAgICBjb25zdCB0RWw9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dsVGlja2VyJyk7IGlmKHRFbCkgdEVsLnZhbHVlPScnOwogICAgY29uc3QgcEVsPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFByaWNlJyk7IGlmKHBFbCkgcEVsLnZhbHVlPScnOwogICAgdHJ5eyBjb25zdCB0PWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3bFRpY2tlcicpPy52YWx1ZXx8Jyc7IGlmKHQpeyBjb25zdCBwcm9maWxlID0gYXdhaXQgZmV0Y2hDb21wYW55UHJvZmlsZSh0KTsgaWYocHJvZmlsZSAmJiBwcm9maWxlLm5hbWUpIHNldENvbXBhbnlOYW1lKHQsIHByb2ZpbGUubmFtZSk7IH0gfWNhdGNoKF8pe30KICAgIHJlbmRlcldpc2hsaXN0KCk7CiAgfSk7CgoKICAvLyBGaWx0ZXJzCiAgZmlsdGVyUXVlcnlFbC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpPT4gcmVuZGVyTWFpbigpKTsKCiAgLy8gU3RyYXRlZ3kgYXV0b3NhdmUKICBzdHJhdGVneUJveC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpPT57CiAgICBjb25zdCBwZiA9IGdldFBmKGN1cnJlbnRQZklkKTsgaWYoIXBmKSByZXR1cm47CiAgICBwZi5zdHJhdGVneSA9IHN0cmF0ZWd5Qm94LnZhbHVlOwogICAgcGYudXBkYXRlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOwogICAgc2F2ZSgpOwogIH0pOwoKICBmdW5jdGlvbiByZW5kZXIoKXsKICAgIHJlbmRlclBvcnRmb2xpb0xpc3QoKTsKICAgIHJlbmRlck1haW4oKTsKICAgIHRyeXsgZW5zdXJlUmVzcG9uc2l2ZVRhYmxlcygpOyB9Y2F0Y2goXyl7IH0KICB0cnkgeyB1cGRhdGVTaWRlYmFyQmxpbmtTdGF0ZXMoKTsgfSBjYXRjaChlKSB7fQogIHRyeSB7IHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpOyB9IGNhdGNoKGUpIHt9CiAgICAKICAvLyBGaWx0ZXIgY2xlYXIKICBjb25zdCBmaWx0ZXJDbGVhckJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWx0ZXJDbGVhckJ0bicpOwogIGlmKGZpbHRlckNsZWFyQnRuICYmICFmaWx0ZXJDbGVhckJ0bi5kYXRhc2V0LmJvdW5kKXsKICAgIGZpbHRlckNsZWFyQnRuLmRhdGFzZXQuYm91bmQ9JzEnOwogICAgZmlsdGVyQ2xlYXJCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBmaWx0ZXJRdWVyeUVsLnZhbHVlPScnOyByZW5kZXJNYWluKCk7IH0pOwogIH0Kc3RhcnRQb2xsaW5nUXVvdGVzKCk7CiAgfQoKICAvLyBJbml0aWFsIHJlbmRlcgogIHJlbmRlcigpOwogIHRyeSB7IHJlbmRlcldpc2hsaXN0KCk7IHVwZGF0ZVdpc2hsaXN0QmxpbmtTdGF0ZSgpOyB9IGNhdGNoKGUpIHt9CiAgLy8gVXB1YmxpY3puaWVuaWUgd2nEhXphxYQgZGxhIEZpcmViYXNlCiAgdHJ5ewogICAgd2luZG93LnNhdmUgPSBzYXZlOwogICAgd2luZG93LnJlbmRlciA9IHJlbmRlcjsKICAgIHdpbmRvdy5fX3NldEFwcERCID0gKG9iaik9PnsgCiAgICAgIERCID0gb2JqOyAKICAgICAgdHJ5ewogICAgICAgIC8vIE1pZ3JhdGUgd2lzaGxpc3QgaXRlbXMgdG8gbXVsdGktdGFyZ2V0IHNjaGVtYSBhZnRlciBsb2FkaW5nIGZyb20gc2VydmVyCiAgICAgICAgREIud2F0Y2hsaXN0ID0gREIud2F0Y2hsaXN0IHx8IFtdOwogICAgICAgIGZvcihjb25zdCB3IG9mIERCLndhdGNobGlzdCl7CiAgICAgICAgICBpZighQXJyYXkuaXNBcnJheSh3LnRhcmdldHMpKXsKICAgICAgICAgICAgY29uc3QgYmFzZSA9IE51bWJlcih3LnByaWNlKXx8MDsKICAgICAgICAgICAgdy50YXJnZXRzID0gYmFzZT4wID8gW2Jhc2VdIDogW107CiAgICAgICAgICAgIHRyeXsgZGVsZXRlIHcucHJpY2U7IH1jYXRjaChfKXt9CiAgICAgICAgICB9CiAgICAgICAgICBpZih0eXBlb2Ygdy5hY3RpdmVJbmRleCE9PSdudW1iZXInKSB3LmFjdGl2ZUluZGV4ID0gMDsKICAgICAgICAgIGlmKHR5cGVvZiB3Lm5hbWUhPT0nc3RyaW5nJykgdy5uYW1lID0gdy5uYW1lfHwnJzsKICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CiAgICAgIHNhdmUoKTsgCiAgICAgIHRyeSB7IHJlbmRlcigpOyB9IGNhdGNoKF8pe30KICAgICAgdHJ5IHsgcmVuZGVyV2lzaGxpc3QoKTsgdXBkYXRlV2lzaGxpc3RCbGlua1N0YXRlKCk7IH0gY2F0Y2goXyl7fQogICAgfTsKICB9Y2F0Y2goZSl7IGNvbnNvbGUud2FybignRXhwb3NlIGJpbmRpbmdzIGZhaWxlZCcsIGUpOyB9Cn0pKCk7Cjwvc2NyaXB0Pgo8c2NyaXB0PgovLyA9PT0gQ29sbGFwc2libGUgSGlzdG9yeSAocGVyc2lzdCBzdGF0ZSkgPT09CihmdW5jdGlvbigpewogIGZ1bmN0aW9uIHNldHVwSGlzdG9yeUNvbGxhcHNlKCl7CiAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaXN0b3J5UGFuZWwnKTsKICAgIGlmKCFwYW5lbCkgcmV0dXJuOwogICAgY29uc3QgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpc3RvcnlDb2xsYXBzZUJ0bicpOwogICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlzdG9yeVRpdGxlJyk7CiAgICBjb25zdCBLRVkgPSAnaGlzdG9yeUNvbGxhcHNlZCc7CiAgICB0cnl7CiAgICAgIGNvbnN0IGluaXRpYWwgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLRVkpID09PSAnMSc7CiAgICAgIGlmKGluaXRpYWwpIHBhbmVsLmNsYXNzTGlzdC5hZGQoJ2NvbGxhcHNlZCcpOwogICAgfWNhdGNoKGUpe30KICAgIGZ1bmN0aW9uIHRvZ2dsZSgpewogICAgICBwYW5lbC5jbGFzc0xpc3QudG9nZ2xlKCdjb2xsYXBzZWQnKTsKICAgICAgdHJ5eyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLRVksIHBhbmVsLmNsYXNzTGlzdC5jb250YWlucygnY29sbGFwc2VkJykgPyAnMSc6JzAnKTsgfWNhdGNoKGUpe30KICAgIH0KICAgIGlmKGJ0biAmJiAhYnRuLmRhdGFzZXQuYm91bmQpeyBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0b2dnbGUpOyBidG4uZGF0YXNldC5ib3VuZD0nMSc7IH0KICAgIGlmKHRpdGxlICYmICF0aXRsZS5kYXRhc2V0LmJvdW5kKXsgdGl0bGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0b2dnbGUpOyB0aXRsZS5kYXRhc2V0LmJvdW5kPScxJzsgfQogIH0KICAvLyBydW4gbm93IChzY3JpcHRzIGxvYWRlZCBhdCBlbmQgb2YgYm9keSksIGFuZCBhbHNvIGFmdGVyIGFueSBnbG9iYWwgcmUtcmVuZGVyIGlmIG5lZWRlZAogIHRyeSB7IHNldHVwSGlzdG9yeUNvbGxhcHNlKCk7IH0gY2F0Y2goZSkge30KICAvLyByZS1hcHBseSBvbiByZW5kZXJNYWluCiAgaWYodHlwZW9mIHJlbmRlck1haW4gPT09ICdmdW5jdGlvbicpewogICAgY29uc3Qgb3JpZyA9IHJlbmRlck1haW47CiAgICB3aW5kb3cucmVuZGVyTWFpbiA9IGZ1bmN0aW9uKCl7CiAgICAgIGNvbnN0IHJlc3VsdCA9IG9yaWcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdHJ5IHsgc2V0dXBIaXN0b3J5Q29sbGFwc2UoKTsgfSBjYXRjaChlKSB7fQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0KfSkoKTsKPC9zY3JpcHQ+CgogIDxzY3JpcHQ+CiAgLy8gU3RhdHVzIFVJIGJldHdlZW4gdGl0bGUgYW5kIGFjdGlvbnMKICAoZnVuY3Rpb24oKXsKICAgIGZ1bmN0aW9uIGZpbmRIZWFkZXIoKXsgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWRlcicpOyB9CiAgICBmdW5jdGlvbiBmaW5kQWN0aW9ucygpeyByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZGVyIC5hY3Rpb25zJyk7IH0KICAgIGZ1bmN0aW9uIGVuc3VyZVN0YXR1c0JldHdlZW4oKXsKICAgICAgY29uc3QgaCA9IGZpbmRIZWFkZXIoKTsgY29uc3QgYSA9IGZpbmRBY3Rpb25zKCk7IGlmKCFoKSByZXR1cm4gbnVsbDsKICAgICAgbGV0IHdyYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3luY1N0YXR1c1dyYXAnKTsKICAgICAgaWYoIXdyYXApewogICAgICAgIHdyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICB3cmFwLmlkPSdzeW5jU3RhdHVzV3JhcCc7CiAgICAgICAgd3JhcC5zdHlsZS5kaXNwbGF5PSdpbmxpbmUtZmxleCc7CiAgICAgICAgd3JhcC5zdHlsZS5hbGlnbkl0ZW1zPSdjZW50ZXInOwogICAgICAgIHdyYXAuc3R5bGUuZ2FwPSc2cHgnOwogICAgICAgIHdyYXAuc3R5bGUubWFyZ2luTGVmdD0nMTZweCc7CiAgICAgICAgY29uc3QgZG90ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyBkb3QuaWQ9J3N5bmNEb3QnOwogICAgICAgIGRvdC5zdHlsZS53aWR0aD0nMTJweCc7IGRvdC5zdHlsZS5oZWlnaHQ9JzEycHgnOyBkb3Quc3R5bGUuYm9yZGVyUmFkaXVzPSc1MCUnOyBkb3Quc3R5bGUuZGlzcGxheT0naW5saW5lLWJsb2NrJzsKICAgICAgICBkb3Quc3R5bGUuYm94U2hhZG93PScwIDAgMCAxcHggcmdiYSgwLDAsMCwwLjI1KSBpbnNldCc7IGRvdC5zdHlsZS5iYWNrZ3JvdW5kPScjOWNhM2FmJzsKICAgICAgICBjb25zdCB0eHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IHR4dC5pZD0nc3luY1RleHQnOyB0eHQuc3R5bGUuZm9udFNpemU9JzEycHgnOyB0eHQuc3R5bGUub3BhY2l0eT0nMC45JzsgdHh0LnRleHRDb250ZW50PSdGaXJlYmFzZTogLi4uJzsKICAgICAgICB3cmFwLmFwcGVuZENoaWxkKGRvdCk7IHdyYXAuYXBwZW5kQ2hpbGQodHh0KTsKICAgICAgICBpZihhKXsgaC5pbnNlcnRCZWZvcmUod3JhcCwgYSk7IH0gZWxzZSB7IGguYXBwZW5kQ2hpbGQod3JhcCk7IH0KICAgICAgfQogICAgICByZXR1cm4gd3JhcDsKICAgIH0KICAgIGZ1bmN0aW9uIGNvbG9yKGMpeyBjb25zdCBkPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzeW5jRG90Jyk7IGlmKGQpIGQuc3R5bGUuYmFja2dyb3VuZD1jOyB9CiAgICBmdW5jdGlvbiBsYWJlbCh0KXsgY29uc3QgZT1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3luY1RleHQnKTsgaWYoZSkgZS50ZXh0Q29udGVudD10OyB9CiAgICBmdW5jdGlvbiBwYWQobil7IHJldHVybiAobjwxMD8nMCc6JycpK247IH0gZnVuY3Rpb24gaGhtbXNzKHRzKXsgY29uc3QgZD1uZXcgRGF0ZSh0cyk7IHJldHVybiBwYWQoZC5nZXRIb3VycygpKSsnOicrcGFkKGQuZ2V0TWludXRlcygpKSsnOicrcGFkKGQuZ2V0U2Vjb25kcygpKTsgfQogICAgd2luZG93LnNldFN5bmNTdGF0dXMgPSBmdW5jdGlvbihzdGF0ZSl7CiAgICAgIGVuc3VyZVN0YXR1c0JldHdlZW4oKTsKICAgICAgaWYoc3RhdGU9PT0nc3luY2luZycpeyBjb2xvcignI2Y1OWUwYicpOyBsYWJlbCgnRmlyZWJhc2U6IFN5bmNocm9uaXphY2phLi4uJyk7IHJldHVybjsgfQogICAgICBpZihzdGF0ZT09PSdvaycpeyBjb2xvcignIzEwYjk4MScpOyB2YXIgdD13aW5kb3cuX19sYXN0U3luY0F0PygnICgnK2hobW1zcyh3aW5kb3cuX19sYXN0U3luY0F0KSsnKScpOicnOyBsYWJlbCgnRmlyZWJhc2U6IE9LJyt0KTsgcmV0dXJuOyB9CiAgICAgIGlmKHN0YXRlPT09J2Vycm9yJyl7IGNvbG9yKCcjZWY0NDQ0Jyk7IGxhYmVsKCdGaXJlYmFzZTogQsWCxIVkJyk7IHJldHVybjsgfQogICAgICBpZihzdGF0ZT09PSdvZmZsaW5lJyl7IGNvbG9yKCcjZWY0NDQ0Jyk7IGxhYmVsKCdGaXJlYmFzZTogT0ZGTElORScpOyByZXR1cm47IH0KICAgICAgaWYoc3RhdGU9PT0ncmVhZHknKXsgY29sb3IoJyMzYjgyZjYnKTsgbGFiZWwoJ0ZpcmViYXNlOiBHb3Rvd2UnKTsgcmV0dXJuOyB9CiAgICAgIGNvbG9yKCcjOWNhM2FmJyk7IGxhYmVsKCdGaXJlYmFzZTogLi4uJyk7CiAgICB9OwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpPT57CiAgICAgIGVuc3VyZVN0YXR1c0JldHdlZW4oKTsKICAgICAgd2luZG93LnNldFN5bmNTdGF0dXMobmF2aWdhdG9yLm9uTGluZT8ncmVhZHknOidvZmZsaW5lJyk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCAoKT0+d2luZG93LnNldFN5bmNTdGF0dXMoJ3JlYWR5JykpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb2ZmbGluZScsICgpPT53aW5kb3cuc2V0U3luY1N0YXR1cygnb2ZmbGluZScpKTsKICAgIH0sIHtvbmNlOnRydWV9KTsKICB9KSgpOwogIDwvc2NyaXB0PgoKCiAgPHNjcmlwdD4KICAvLyAtLS0gSEFSREZJWDogbWFudWFsIEZpcmViYXNlIFd5xZtsaWovUG9iaWVyeiArIGluY29nbml0byBhdXRoIC0tLQogIHdpbmRvdy5zZXRTeW5jU3RhdHVzID0gd2luZG93LnNldFN5bmNTdGF0dXMgfHwgZnVuY3Rpb24oKXt9OwogIGZ1bmN0aW9uIGZiTG9nKG1zZywgY2xzKXsKICAgIC8vIHBva2HFvCB0eWxrbyBixYLEmWR5L29zdHJ6ZcW8ZW5pYSDigJQgYnJhayB0b2FzdMOzdyBkbGEgT0sKICAgIGlmIChjbHMhPT0nZXJyJyAmJiBjbHMhPT0nd2FybicpIHJldHVybjsKCiAgICB0cnl7CiAgICAgIGNvbnN0IGJveCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmYkxvZycpOyBpZighYm94KSByZXR1cm47CiAgICAgIGJveC5pbm5lckhUTUwgPSAnPGI+RmlyZWJhc2U8L2I+OiAnICsgKG1zZ3x8JycpICsgKGNscz8oJzxzcGFuIGNsYXNzPSInK2NscysnIj48L3NwYW4+Jyk6JycpOyAKICAgICAgYm94LmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsKICAgICAgY2xlYXJUaW1lb3V0KHdpbmRvdy5fX2ZiTG9nVGltZXIpOyB3aW5kb3cuX19mYkxvZ1RpbWVyID0gc2V0VGltZW91dCgoKT0+eyBib3guY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOyB9LCA2MDAwKTsKICAgIH1jYXRjaChfKXt9CiAgfQoKICBjb25zdCBGQl9DRkcgPSB7CiAgICBhcGlLZXk6ICJBSXphU3lCR0Z1WHhMWVFmbXlvLVRheEpHRVIycVowd3pFdlBQeGsiLAogICAgYXV0aERvbWFpbjogImd0LXBvcnRmb2xpb3MuZmlyZWJhc2VhcHAuY29tIiwKICAgIHByb2plY3RJZDogImd0LXBvcnRmb2xpb3MiLAogICAgYXBwSWQ6ICIxOjIyNDIzMDEyMDAyMTp3ZWI6ODc5MDFhMTY3ZTFmYzYwNzk3OTJkYyIsCiAgICBzdG9yYWdlQnVja2V0OiAiZ3QtcG9ydGZvbGlvcy5hcHBzcG90LmNvbSIsCiAgICBtZXNzYWdpbmdTZW5kZXJJZDogIjIyNDIzMDEyMDAyMSIKICB9OwogIGNvbnN0IEZCX0NPTCA9ICJndF9wb3J0Zm9saW9zIjsKICBjb25zdCBGQl9ET0MgPSAiZGVmYXVsdCI7CgogIGZ1bmN0aW9uIGRldGVjdExTS2V5KCl7CiAgY29uc3QgRklYRUQgPSAicG9ydGZlbGVfZmlybXlfdjEiOyAvLyBzdGHFgnkga2x1Y3oKICAvLyBqZcWbbGkganXFvCBpc3RuaWVqZSDigJQgdcW8eWoKICB0cnl7IGlmKGxvY2FsU3RvcmFnZS5nZXRJdGVtKEZJWEVEKSkgcmV0dXJuIEZJWEVEOyB9Y2F0Y2goXyl7fQogIC8vIG1pZ3JhY2phIHogaW5ueWNoIHBvdGVuY2phbG55Y2gga2x1Y3p5CiAgdHJ5ewogICAgZm9yIChsZXQgaT0wO2k8bG9jYWxTdG9yYWdlLmxlbmd0aDtpKyspewogICAgICBjb25zdCBrID0gbG9jYWxTdG9yYWdlLmtleShpKTsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IHYgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGspKTsKICAgICAgICBpZiAodiAmJiB0eXBlb2Ygdj09PSdvYmplY3QnICYmIHYuc2V0dGluZ3MgJiYgQXJyYXkuaXNBcnJheSh2LnBvcnRmb2xpb3MpKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgWm5hbGV6aW9ubyBkYW5lIHcga2x1Y3p1OiAke2t9LCBtaWdydWrEmSBkbyAke0ZJWEVEfWApOwogICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oRklYRUQsIEpTT04uc3RyaW5naWZ5KHYpKTsKICAgICAgICAgIHJldHVybiBGSVhFRDsKICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CiAgICB9CiAgfWNhdGNoKF8pe30KICAvLyBqZcWbbGkgbmljIG5pZSB6bmFsZXppb25vIOKAlCB6d3LDs8SHIHN0YcWCeQogIHJldHVybiBGSVhFRDsKfQpjb25zdCBMU19LRVkgPSBkZXRlY3RMU0tleSgpOwoKICBhc3luYyBmdW5jdGlvbiBmYkluaXQoKXsKICAgIAogICAgLy8gRW5zdXJlIHNpbmdsZSBpbml0aWFsaXphdGlvbiBwZXIgcGFnZSAoc2luZ2xldG9uKQogICAgaWYgKHdpbmRvdy5fX2ZiSW5pdFByb21pc2UpIHJldHVybiB3aW5kb3cuX19mYkluaXRQcm9taXNlOwogICAgd2luZG93Ll9fZmJJbml0UHJvbWlzZSA9IChhc3luYyAoKSA9PiB7CnRyeXsKICAgICAgaWYgKCF3aW5kb3cuZmlyZWJhc2UgfHwgIWZpcmViYXNlLmFwcHMpIHRocm93IG5ldyBFcnJvcigiQnJhayBGaXJlYmFzZSBTREsiKTsKICAgICAgaWYgKCFmaXJlYmFzZS5hcHBzLmxlbmd0aCkgZmlyZWJhc2UuaW5pdGlhbGl6ZUFwcChGQl9DRkcpOwogICAgICBjb25zdCBhdXRoID0gZmlyZWJhc2UuYXV0aCgpOwogICAgICAvLyBkaWFnbm9zdHlrYSBzdGFudSBhdXRoICh6YWJlenBpZWN6b25lIHByemVkIHdpZWxva3JvdG55bSBwb2RwacSZY2llbSkKICAgICAgdHJ5ewogICAgICAgIGlmKCF3aW5kb3cuX19mYkF1dGhCb3VuZCl7CiAgICAgICAgICBhdXRoLm9uQXV0aFN0YXRlQ2hhbmdlZCgodXNlcik9PnsKICAgICAgICAgICAgaWYodXNlcil7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZpcmViYXNlIGF1dGg6IHphbG9nb3dhbm8gYW5vbmltb3dvJywgdXNlci51aWQpOwogICAgICAgICAgICAgIGlmKHR5cGVvZiB3aW5kb3cuc2V0U3luY1N0YXR1cz09PSdmdW5jdGlvbicpIHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdyZWFkeScpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRmlyZWJhc2UgYXV0aDogYnJhayB1xbx5dGtvd25pa2EnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB3aW5kb3cuX19mYkF1dGhCb3VuZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9Y2F0Y2goXyl7fQogICAgICB0cnl7IGF3YWl0IGF1dGguc2V0UGVyc2lzdGVuY2UoZmlyZWJhc2UuYXV0aC5BdXRoLlBlcnNpc3RlbmNlLkxPQ0FMKTsgfWNhdGNoKF8pe30KICAgICAgaWYgKCFhdXRoLmN1cnJlbnRVc2VyKSBhd2FpdCBhdXRoLnNpZ25JbkFub255bW91c2x5KCk7CiAgICAgIGNvbnN0IGRiID0gZmlyZWJhc2UuZmlyZXN0b3JlKCk7CiAgICAgIHJldHVybiB7YXV0aCwgZGJ9OwogICAgfWNhdGNoKGUpewogICAgICBjb25zb2xlLndhcm4oImZiSW5pdCBlcnJvcjoiLCBlKTsgYWxlcnQoIkLFgsSFZCBpbmljamFsaXphY2ppIEZpcmViYXNlOiAiICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsgcmV0dXJuIHt9OwogICAgfQogIAogICAgfSkoKTsKICAgIHJldHVybiB3aW5kb3cuX19mYkluaXRQcm9taXNlOwp9CgogIAovLyA9PT0gQXV0b1N5bmMgSGVscGVycyA9PT0KCi8vID09PSBBbGFybSBMb2dnaW5nIChGaXJlc3RvcmUpID09PQpjb25zdCBBTEFSTV9MT0dfUkVQRUFUX01TID0gMTUgKiA2MCAqIDEwMDA7IC8vIHJlLWxvZyBzYW1lIHN0YXRlIGFmdGVyIDE1IG1pbnV0ZXMKd2luZG93Ll9fbGFzdExvZ2dlZEFsZXJ0cyA9IHdpbmRvdy5fX2xhc3RMb2dnZWRBbGVydHMgfHwge307CgpmdW5jdGlvbiBfX3Nob3VsZExvZ0FsYXJtKGtleSwgc3RhdGUpewogIHRyeXsKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICBjb25zdCBwcmV2ID0gd2luZG93Ll9fbGFzdExvZ2dlZEFsZXJ0c1trZXldOwogICAgaWYoIXByZXYgfHwgcHJldi5zdGF0ZSAhPT0gc3RhdGUgfHwgKG5vdyAtIHByZXYudGltZSkgPiBBTEFSTV9MT0dfUkVQRUFUX01TKXsKICAgICAgd2luZG93Ll9fbGFzdExvZ2dlZEFsZXJ0c1trZXldID0ge3N0YXRlLCB0aW1lOiBub3d9OwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9Y2F0Y2goXyl7IHJldHVybiB0cnVlOyB9Cn0KCi8vIFRyYWNrIHN0YXRlIGNoYW5nZXMgZm9yIGJhZGdlIGNvdW50aW5nIChzZXBhcmF0ZSBmcm9tIGxvZ2dpbmcpCndpbmRvdy5fX2xhc3RCYWRnZVN0YXRlcyA9IHdpbmRvdy5fX2xhc3RCYWRnZVN0YXRlcyB8fCB7fTsKCmZ1bmN0aW9uIF9fc2hvdWxkSW5jcmVtZW50QmFkZ2Uoa2V5LCBzdGF0ZSl7CiAgdHJ5ewogICAgY29uc3QgcHJldiA9IHdpbmRvdy5fX2xhc3RCYWRnZVN0YXRlc1trZXldOwogICAgY29uc3QgY2hhbmdlZCA9ICFwcmV2IHx8IHByZXYgIT09IHN0YXRlOwogICAgaWYoY2hhbmdlZCl7CiAgICAgIHdpbmRvdy5fX2xhc3RCYWRnZVN0YXRlc1trZXldID0gc3RhdGU7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH1jYXRjaChfKXsgcmV0dXJuIGZhbHNlOyB9Cn0KCgoKLyoqCiAqIFNhdmUgYWxhcm0gZXZlbnQgdG8gRmlyZXN0b3JlLgogKiBkYXRhOiB7c2NvcGU6J3BvcnRmb2xpbyd8J3dpc2hsaXN0JywgcGZJZD8sIHRpY2tlciwgc3RhdGU6J2hpdCd8J25lYXInLCBraW5kOidzZWxsJ3wnYnV5JywgcHJpY2UsIHRhcmdldH0KICovCmFzeW5jIGZ1bmN0aW9uIGxvZ0FsYXJtRXZlbnQoZGF0YSl7CiAgdHJ5ewogICAgY29uc3QgcGFjayA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGF8fHt9KTsKICAgIGNvbnN0IHthdXRoLCBkYiwgZmlyZWJhc2V9ID0gYXdhaXQgZmJJbml0KCk7CiAgICBpZighZGIgfHwgIWF1dGggfHwgIWF1dGguY3VycmVudFVzZXIpeyByZXR1cm47IH0KICAgIGNvbnN0IHVpZCA9IGF1dGguY3VycmVudFVzZXIudWlkOwogICAgcGFjay51aWQgPSB1aWQ7CiAgICAvLyBOb3JtYWxpemUgdGlja2VyL2tpbmQvc3RhdGUKICAgIGlmKHBhY2sudGlja2VyKSBwYWNrLnRpY2tlciA9IFN0cmluZyhwYWNrLnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICBpZihwYWNrLmtpbmQpICAgcGFjay5raW5kICAgPSBTdHJpbmcocGFjay5raW5kfHwnJykudG9Mb3dlckNhc2UoKTsKICAgIGlmKHBhY2suc3RhdGUpICBwYWNrLnN0YXRlICA9IFN0cmluZyhwYWNrLnN0YXRlfHwnJykudG9Mb3dlckNhc2UoKTsKICAgIC8vIEFkZCBjcmVhdGVkQXQgc2VydmVyIHRpbWVzdGFtcCBpZiBhdmFpbGFibGUsIGVsc2UgY2xpZW50CiAgICB0cnl7CiAgICAgIHBhY2suY3JlYXRlZEF0ID0gKGZpcmViYXNlPy5maXJlc3RvcmU/LkZpZWxkVmFsdWU/LnNlcnZlclRpbWVzdGFtcCAmJiBmaXJlYmFzZS5maXJlc3RvcmUuRmllbGRWYWx1ZS5zZXJ2ZXJUaW1lc3RhbXAoKSkgfHwgbmV3IERhdGUoKTsKICAgIH1jYXRjaChfKXsKICAgICAgcGFjay5jcmVhdGVkQXQgPSBuZXcgRGF0ZSgpOwogICAgfQogICAgYXdhaXQgZGIuY29sbGVjdGlvbignYWxlcnRzJykuYWRkKHBhY2spOwogIH1jYXRjaChlKXsKICAgIGNvbnNvbGUud2FybignbG9nQWxhcm1FdmVudCBmYWlsZWQ6JywgZSk7CiAgfQp9CmNvbnN0IEFVVE9fU1lOQ19FTkFCTEVEID0gdHJ1ZTsKY29uc3QgQVVUT19TWU5DX0lOVEVSVkFMX01TID0gODAwMDsgLy8gY28ga2lsa2Egc2VrdW5kCmNvbnN0IERFVklDRV9LRVkgPSAnZ3RfZGV2aWNlSWQnOwpmdW5jdGlvbiBnZXREZXZpY2VJZCgpewogIHRyeXsKICAgIGxldCBpZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKERFVklDRV9LRVkpOwogICAgaWYoIWlkKXsgaWQgPSAnZGV2XycgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyLDEwKTsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oREVWSUNFX0tFWSwgaWQpOyB9CiAgICByZXR1cm4gaWQ7CiAgfWNhdGNoKF8peyByZXR1cm4gJ2Rldl91bmtub3duJzsgfQp9CmZ1bmN0aW9uIGRqYjIoc3RyKXsKICBsZXQgaCA9IDUzODEsIGkgPSBzdHIubGVuZ3RoOwogIHdoaWxlKGkpIGggPSAoaCAqIDMzKSBeIHN0ci5jaGFyQ29kZUF0KC0taSk7CiAgcmV0dXJuIChoPj4+MCkudG9TdHJpbmcoMTYpOwp9CndpbmRvdy5fX2RpcnR5U2luY2UgPSBudWxsOwp3aW5kb3cuX19sYXN0VXBsb2FkSGFzaCA9IG51bGw7CndpbmRvdy5fX2lzU3luY2luZyA9IGZhbHNlOwp3aW5kb3cuX19kZXZpY2VJZCA9IGdldERldmljZUlkKCk7CndpbmRvdy5fX21hcmtEaXJ0eSA9IGZ1bmN0aW9uKCl7CiAgd2luZG93Ll9fZGlydHlTaW5jZSA9IERhdGUubm93KCk7CiAgLy8gb3Bjam9uYWxueSBsb2cKICB0cnl7IGZiTG9nKCdabWllbmlvbm8gZGFuZSBsb2thbG5lIOKAlCBhdXRvLXN5bmMgd2tyw7N0Y2Ugd3nFm2xlJywgJ29rJyk7IH1jYXRjaChfKXt9Cn07CmFzeW5jIGZ1bmN0aW9uIGhhcmRVcGxvYWQoKXsKICAgIGNvbnN0IHtkYn0gPSBhd2FpdCBmYkluaXQoKTsgaWYoIWRiKSByZXR1cm4gZmFsc2U7CiAgICBsZXQgZGF0YT1udWxsOyB0cnl7IGRhdGEgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKExTX0tFWSkpOyB9Y2F0Y2goXyl7fQogICAgaWYgKCFkYXRhKXsgYWxlcnQoIkJyYWsgZGFueWNoIGxva2FsbnljaCBkbyB3eXPFgmFuaWEgKGtsdWN6OiAiK0xTX0tFWSsiKSIpOyByZXR1cm4gZmFsc2U7IH0KICAgIGRhdGEuX3RzID0gRGF0ZS5ub3coKTsgZGF0YS5fdmVyID0gZGF0YS52ZXJzaW9ufHwxOwogICAgdHJ5ewogICAgICB3aW5kb3cuc2V0U3luY1N0YXR1cygnc3luY2luZycpOwogICAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKEZCX0NPTCkuZG9jKEZCX0RPQykuc2V0KGRhdGEsIHttZXJnZTpmYWxzZX0pOwogICAgdHJ5eyB3aW5kb3cuX19sYXN0VXBsb2FkSGFzaCA9IGRqYjIoSlNPTi5zdHJpbmdpZnkoZGF0YSkpOyB9Y2F0Y2goXyl7fQogICAgd2luZG93Ll9fZGlydHlTaW5jZSA9IG51bGw7CiAgICAgIHdpbmRvdy5fX2xhc3RTeW5jQXQgPSBEYXRlLm5vdygpOyB3aW5kb3cuc2V0U3luY1N0YXR1cygnb2snKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9Y2F0Y2goZSl7CiAgICAgIGNvbnNvbGUud2FybigiVVBMT0FEIGVycm9yOiIsIGUpOyB3aW5kb3cuc2V0U3luY1N0YXR1cygnZXJyb3InKTsgYWxlcnQoIkLFgsSFZCB6YXBpc3U6ICIgKyAoZSAmJiBlLm1lc3NhZ2UgfHwgZSkpOyByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBhc3luYyBmdW5jdGlvbiBoYXJkRG93bmxvYWQoc2lsZW50PWZhbHNlKXsKICAgIAogICAgY29uc3Qge2RifSA9IGF3YWl0IGZiSW5pdCgpOyBpZighZGIpIHJldHVybiBmYWxzZTsKICAgIHRyeXsKICAgICAgd2luZG93LnNldFN5bmNTdGF0dXMoJ3N5bmNpbmcnKTsKICAgICAgY29uc3Qgc25hcCA9IGF3YWl0IGRiLmNvbGxlY3Rpb24oRkJfQ09MKS5kb2MoRkJfRE9DKS5nZXQoKTsKICAgICAgaWYoIXNuYXAuZXhpc3RzKXsgd2luZG93LnNldFN5bmNTdGF0dXMoJ2Vycm9yJyk7IGlmKCFzaWxlbnQpIGFsZXJ0KCJCcmFrIGRva3VtZW50dSB3IGNobXVyemUuIE5hanBpZXJ3IHXFvHlqICdXecWbbGlqJy4iKTsgZmJMb2coJ0JyYWsgZG9rdW1lbnR1ICcrRkJfQ09MKycvJytGQl9ET0MsICdlcnInKTsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIGNvbnN0IGRhdGEgPSBzbmFwLmRhdGEoKTsgaWYoIWRhdGEpeyB3aW5kb3cuc2V0U3luY1N0YXR1cygnZXJyb3InKTsgYWxlcnQoIkRva3VtZW50IHB1c3R5L25pZXBvcHJhd255LiIpOyByZXR1cm4gZmFsc2U7IH0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTFNfS0VZLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgIAogICAgICAvLyBha3R1YWxpemFjamEgYXBsaWthY2ppCiAgICAgIGlmICh0eXBlb2Ygd2luZG93Ll9fc2V0QXBwREIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0cnkgeyB3aW5kb3cuX19zZXRBcHBEQihkYXRhKTsgfSBjYXRjaChlKXsgY29uc29sZS5lcnJvcignQsWCxIVkIF9fc2V0QXBwREI6JywgZSk7IH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5zYXZlPT09J2Z1bmN0aW9uJykgdHJ5eyB3aW5kb3cuc2F2ZSgpOyB9Y2F0Y2goXyl7fQogICAgICAgIGlmICh0eXBlb2Ygd2luZG93LnJlbmRlcj09PSdmdW5jdGlvbicpIHRyeXsgd2luZG93LnJlbmRlcigpOyB9Y2F0Y2goXyl7fQogICAgICB9CiAgICAgIGlmICh0eXBlb2YgREIhPT0ndW5kZWZpbmVkJykgd2luZG93LkRCID0gZGF0YTsKICAgICAgaWYgKHR5cGVvZiBzYXZlPT09J2Z1bmN0aW9uJykgdHJ5eyBzYXZlKCk7IH1jYXRjaChfKXt9CiAgICAgIGlmICh0eXBlb2YgcmVuZGVyPT09J2Z1bmN0aW9uJykgdHJ5eyByZW5kZXIoKTsgfWNhdGNoKF8pe30KICAgICAgd2luZG93Ll9fbGFzdFN5bmNBdCA9IERhdGUubm93KCk7IHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdvaycpOwogICAgICAvKiBzdWNjZXNzIGFsZXJ0IHN1cHByZXNzZWQgKi9mYkxvZygnUG9icmFubyBkYW5lIHogY2htdXJ5JywgJ29rJyk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfWNhdGNoKGUpewogICAgICBjb25zb2xlLndhcm4oIkRPV05MT0FEIGVycm9yOiIsIGUpOyB3aW5kb3cuc2V0U3luY1N0YXR1cygnZXJyb3InKTsgYWxlcnQoIkLFgsSFZCBvZGN6eXR1OiAiICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsgZmJMb2coJ0LFgsSFZCBvZGN6eXR1OiAnKyhlJiZlLm1lc3NhZ2V8fGUpLCAnZXJyJyk7IHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIAogIGFzeW5jIGZ1bmN0aW9uIGhhcmREaWFnKCl7CiAgZnVuY3Rpb24gZm9sZENvdW50cyhkYil7CiAgICBjb25zdCBvdXQgPSB7IHBvcnRmb2xpb3M6IDAsIGNvbXBhbmllczogMCwgcG9zaXRpb25zOiAwIH07CiAgICB0cnl7CiAgICAgIGNvbnN0IHNldFRpY2tlcnMgPSBuZXcgU2V0KCk7CiAgICAgIGNvbnN0IHBmcyA9IEFycmF5LmlzQXJyYXkoZGI/LnBvcnRmb2xpb3MpID8gZGIucG9ydGZvbGlvcyA6IFtdOwogICAgICBvdXQucG9ydGZvbGlvcyA9IHBmcy5sZW5ndGg7CiAgICAgIGZvcihjb25zdCBwZiBvZiBwZnMpewogICAgICAgIGNvbnN0IGhvbGRpbmdzID0gcGYgJiYgcGYuaG9sZGluZ3MgPyBwZi5ob2xkaW5ncyA6IHt9OwogICAgICAgIGZvcihjb25zdCBbdGlja2VyLCBoXSBvZiBPYmplY3QuZW50cmllcyhob2xkaW5ncykpewogICAgICAgICAgaWYgKHRpY2tlcikgc2V0VGlja2Vycy5hZGQoU3RyaW5nKHRpY2tlcikudHJpbSgpKTsKICAgICAgICAgIGNvbnN0IGxvdHMgPSAoaCAmJiBBcnJheS5pc0FycmF5KGgubG90cykpID8gaC5sb3RzLmxlbmd0aCA6IDA7CiAgICAgICAgICBvdXQucG9zaXRpb25zICs9IGxvdHM7CiAgICAgICAgfQogICAgICB9CiAgICAgIG91dC5jb21wYW5pZXMgPSBzZXRUaWNrZXJzLnNpemU7CiAgICB9Y2F0Y2goXyl7fQogICAgcmV0dXJuIG91dDsKICB9CgogIGxldCBsb2NhbCA9IHtwb3J0Zm9saW9zOjAsIGNvbXBhbmllczowLCBwb3NpdGlvbnM6MH07CiAgdHJ5ewogICAgY29uc3QgbG9jYWxEYXRhID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19LRVkpfHwnbnVsbCcpOwogICAgbG9jYWwgPSBmb2xkQ291bnRzKGxvY2FsRGF0YSk7CiAgICBjb25zb2xlLmxvZygnRGlhZyBsb2thbG5pZTonLCB7ZXhpc3RzOiAhIWxvY2FsRGF0YSwgLi4ubG9jYWx9KTsKICB9Y2F0Y2goZSl7IGNvbnNvbGUud2FybignQsWCxIVkIG9kY3p5dHUgbG9rYWxuZWdvOicsIGUpOyB9CgogIGNvbnN0IHtkYn0gPSBhd2FpdCBmYkluaXQoKTsgaWYoIWRiKSByZXR1cm4gZmFsc2U7CiAgdHJ5ewogICAgd2luZG93LnNldFN5bmNTdGF0dXMoJ3N5bmNpbmcnKTsKICAgIGF3YWl0IGRiLmNvbGxlY3Rpb24oRkJfQ09MKS5kb2MoRkJfRE9DKS5zZXQoe19waW5nOiBEYXRlLm5vdygpLCBfZGlhZzondGVzdCBjb25uZWN0aW9uJ30sIHttZXJnZTp0cnVlfSk7CiAgICBjb25zdCBzbmFwID0gYXdhaXQgZGIuY29sbGVjdGlvbihGQl9DT0wpLmRvYyhGQl9ET0MpLmdldCgpOwogICAgaWYoIXNuYXAuZXhpc3RzKXsgZmJMb2coJ0RpYWc6IHphcGlzIG9rLCBvZGN6eXQgYnJhayBkb2t1bWVudHUnLCAnZXJyJyk7IHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdlcnJvcicpOyByZXR1cm4gZmFsc2U7IH0KICAgIGNvbnN0IGRhdGEgPSBzbmFwLmRhdGEoKTsKICAgIGNvbnN0IHJlbW90ZSA9IGZvbGRDb3VudHMoZGF0YSk7CiAgICBjb25zdCBsYXN0VHMgPSBkYXRhPyAoZGF0YS5fdHM/IG5ldyBEYXRlKGRhdGEuX3RzKS50b0xvY2FsZVN0cmluZygpIDogJ2JyYWsnKSA6ICdicmFrJzsKCiAgICBmYkxvZygnRGlhZzogemFwaXMvb2Rjenl0IE9LJywgJ29rJyk7CiAgICB3aW5kb3cuc2V0U3luY1N0YXR1cygnb2snKTsKCiAgICBjb25zdCBtc2cgPSBgRGlhZ25vc3R5a2EgT0shCgpMb2thbG5pZSAoJHtMU19LRVl9KToKLSBQb3J0ZmVsaTogJHtsb2NhbC5wb3J0Zm9saW9zfQotIFNww7PFgmVrICh1bmlrYWxuZSB0aWNrZXJ5KTogJHtsb2NhbC5jb21wYW5pZXN9Ci0gUG96eWNqaSAobG90w7N3KTogJHtsb2NhbC5wb3NpdGlvbnN9CgpXIGNobXVyemU6Ci0gUG9ydGZlbGk6ICR7cmVtb3RlLnBvcnRmb2xpb3N9Ci0gU3DDs8WCZWsgKHVuaWthbG5lIHRpY2tlcnkpOiAke3JlbW90ZS5jb21wYW5pZXN9Ci0gUG96eWNqaSAobG90w7N3KTogJHtyZW1vdGUucG9zaXRpb25zfQoKT3N0YXRuaSB1cGxvYWQ6ICR7bGFzdFRzfWA7CiAgICBhbGVydChtc2cpOwogICAgcmV0dXJuIHRydWU7CiAgfWNhdGNoKGUpewogICAgZmJMb2coJ0RpYWcgZXJyb3I6ICcrKGUmJmUubWVzc2FnZXx8ZSksICdlcnInKTsKICAgIHdpbmRvdy5zZXRTeW5jU3RhdHVzKCdlcnJvcicpOwogICAgYWxlcnQoJ0RpYWcgZXJyb3I6ICcrKGUmJmUubWVzc2FnZXx8ZSkpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpPT57CiAgICBjb25zdCB1cCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaXJlYmFzZVVwbG9hZEJ0bicpOwogICAgY29uc3QgZG93biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaXJlYmFzZURvd25sb2FkQnRuJyk7CiAgICBpZiAodXApIHVwLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFyZFVwbG9hZCk7CiAgICBpZiAoZG93bikgZG93bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT5oYXJkRG93bmxvYWQodHJ1ZSkpOwogICAgY29uc3QgZGlhZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaXJlYmFzZURpYWdCdG4nKTsgaWYgKGRpYWcpIGRpYWcuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYXJkRGlhZyk7CiAgICAvLyBhdXRvLXNpbGVudCBkb3dubG9hZCBvbiBzdGFydCBpZiBkb2MgZXhpc3RzIChubyBhbGVydCkKICAgIChhc3luYyAoKT0+ewogICAgICBjb25zdCB7ZGJ9ID0gYXdhaXQgZmJJbml0KCk7IGlmKCFkYikgcmV0dXJuOwogICAgLy8gPT09IFJlYWwtdGltZSBuYXPFgnVjaCB6ZGFsbnljaCB6bWlhbiA9PT0KICAgIGlmIChkYikgewogIGlmICh3aW5kb3cuX19mYl91bnN1YikgeyB0cnl7IHdpbmRvdy5fX2ZiX3Vuc3ViKCk7IH1jYXRjaChfKXsgfSB9CiAgd2luZG93Ll9fZmJfdW5zdWIgPSBkYi5jb2xsZWN0aW9uKEZCX0NPTCkuZG9jKEZCX0RPQykub25TbmFwc2hvdCgoc25hcCk9PnsKICAgIGlmICh3aW5kb3cuX19VTkRPX1JFU1RPUklORykgeyB0cnl7Y29uc29sZS5sb2coJ1tVTkRPXSBpZ25vcmUgcmVtb3RlIGR1cmluZyByZXN0b3JlJyk7fWNhdGNoKF8peyB9IHJldHVybjsgfQoKICAgIHRyeXsKICAgICAgaWYgKCFzbmFwLmV4aXN0cykgcmV0dXJuOwogICAgICBjb25zdCByZW1vdGUgPSBzbmFwLmRhdGEoKTsKICAgICAgaWYgKHJlbW90ZSAmJiByZW1vdGUuX2RldmljZSAmJiByZW1vdGUuX2RldmljZSA9PT0gZ2V0RGV2aWNlSWQoKSkgcmV0dXJuOyAvLyBuYXN6YSB6bWlhbmEKICAgICAgZmJMb2coJ1d5a3J5dG8gemRhbG7EhSB6bWlhbsSZIOKAlCBhdXRvIHBvYmllcmFuaWXigKYnLCAnb2snKTsKICAgICAgaGFyZERvd25sb2FkKHRydWUpOwogICAgfWNhdGNoKGUpeyBjb25zb2xlLndhcm4oJ29uU25hcHNob3QgZXJyb3InLCBlKTsgfQogIH0pOwp9Ci8vID09PSBBdXRvIFBVU0ggKGNvIGtpbGthIHNla3VuZCkgPT09CiAgICB0cnl7CiAgICAgIGZ1bmN0aW9uIHN0YXJ0QXV0b1N5bmMoKXsKICAgICAgICBpZiAod2luZG93Ll9fYXV0b1N5bmNUaW1lcikgcmV0dXJuOwogICAgICAgIHdpbmRvdy5fX2F1dG9TeW5jVGltZXIgPSBzZXRJbnRlcnZhbChhc3luYyAoKT0+ewogICAgICAgICAgdHJ5ewogICAgICAgICAgICBpZiAoIUFVVE9fU1lOQ19FTkFCTEVEKSByZXR1cm47CiAgICAgICAgICAgIGlmICh3aW5kb3cuX19pc1N5bmNpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFuYXZpZ2F0b3Iub25MaW5lKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IHJhdyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExTX0tFWSkgfHwgJyc7CiAgICAgICAgICAgIGlmICghcmF3KSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGggPSBkamIyKHJhdyk7CiAgICAgICAgICAgIGlmICh3aW5kb3cuX19sYXN0VXBsb2FkSGFzaCAmJiB3aW5kb3cuX19sYXN0VXBsb2FkSGFzaCA9PT0gaCAmJiAhd2luZG93Ll9fZGlydHlTaW5jZSkgcmV0dXJuOwogICAgICAgICAgICB3aW5kb3cuX19pc1N5bmNpbmcgPSB0cnVlOwogICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICAgIHRyeXsKICAgICAgICAgICAgZmJMb2coJ0F1dG86IHd5c3nFgmFtIHptaWFueeKApicsICdvaycpOwogICAgICAgICAgICBhd2FpdCBoYXJkVXBsb2FkKCk7CiAgICAgICAgICB9Y2F0Y2goZSl7IGNvbnNvbGUud2FybignQXV0b1N5bmMgdXBsb2FkIGVycm9yJywgZSk7IH0KICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICB3aW5kb3cuX19pc1N5bmNpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9LCBBVVRPX1NZTkNfSU5URVJWQUxfTVMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN0b3BBdXRvU3luYygpeyBpZiAod2luZG93Ll9fYXV0b1N5bmNUaW1lcil7IGNsZWFySW50ZXJ2YWwod2luZG93Ll9fYXV0b1N5bmNUaW1lcik7IHdpbmRvdy5fX2F1dG9TeW5jVGltZXIgPSBudWxsOyB9IH0KICAgICAgLy8gd3JhcCBzYXZlKCkKICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuc2F2ZT09PSdmdW5jdGlvbicgJiYgIXdpbmRvdy5fX3NhdmVXcmFwcGVkKXsKICAgICAgICBjb25zdCBfX29yaWdTYXZlID0gd2luZG93LnNhdmU7CiAgICAgICAgd2luZG93LnNhdmUgPSBmdW5jdGlvbigpewogICAgICAgICAgY29uc3QgciA9IF9fb3JpZ1NhdmUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIHRyeXsgd2luZG93Ll9fbWFya0RpcnR5KCk7IH1jYXRjaChfKXt9CiAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9OwogICAgICAgIHdpbmRvdy5fX3NhdmVXcmFwcGVkID0gdHJ1ZTsKICAgICAgfQogICAgICAvLyBmbHVzaCBvbiBoaWRlL3VubG9hZAogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJywgKCk9PnsKICAgICAgICBpZiAoZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlPT09J2hpZGRlbicpeyB0cnl7IGlmICh3aW5kb3cuX19kaXJ0eVNpbmNlKSBoYXJkVXBsb2FkKCk7IH1jYXRjaChfKXsgfSB9CiAgICAgIH0pOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignYmVmb3JldW5sb2FkJywgKCk9PnsgdHJ5eyBpZiAod2luZG93Ll9fZGlydHlTaW5jZSkgbmF2aWdhdG9yLnNlbmRCZWFjb24gJiYgbmF2aWdhdG9yLnNlbmRCZWFjb24oJy9ub29wJyk7IH1jYXRjaChfKXsgfSB9KTsKICAgICAgc3RhcnRBdXRvU3luYygpOwogICAgfWNhdGNoKGUpeyBjb25zb2xlLndhcm4oJ0F1dG9TeW5jIGluaXQgZXJyb3InLCBlKTsgfQoKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IHNuYXAgPSBhd2FpdCBkYi5jb2xsZWN0aW9uKEZCX0NPTCkuZG9jKEZCX0RPQykuZ2V0KCk7CiAgICAgICAgaWYoc25hcC5leGlzdHMpeyBhd2FpdCBoYXJkRG93bmxvYWQodHJ1ZSk7IH0KICAgICAgICBlbHNlIHsgZmJMb2coJ0F1dG86IGJyYWsgZG9rdW1lbnR1IGRvIHBvYnJhbmlhJywgJ2VycicpOyB9CiAgICAgIH1jYXRjaChlKXsgZmJMb2coJ0F1dG8tbG9hZCBixYLEhWQ6ICcrKGUmJmUubWVzc2FnZXx8ZSksICdlcnInKTsgfQogICAgfSkoKTsKICB9KTsKICA8L3NjcmlwdD4KCgogIDxzdHlsZT4KICAgICNmYkxvZyB7CiAgICAgIHBvc2l0aW9uOiBmaXhlZDsgcmlnaHQ6IDEycHg7IGJvdHRvbTogMTJweDsgei1pbmRleDogOTk5OTsKICAgICAgbWF4LXdpZHRoOiAzOGNoOyBiYWNrZ3JvdW5kOiByZ2JhKDE3LDI0LDM5LDAuOSk7IGNvbG9yOiAjZWVlOwogICAgICBib3JkZXItcmFkaXVzOiAxMnB4OyBwYWRkaW5nOiAxMHB4IDEycHg7IGJveC1zaGFkb3c6IDAgNHB4IDE2cHggcmdiYSgwLDAsMCwwLjQpOwogICAgICBmb250OiAxMnB4LzEuMzUgc3lzdGVtLXVpLCBTZWdvZSBVSSwgUm9ib3RvLCBBcmlhbCwgc2Fucy1zZXJpZjsKICAgICAgZGlzcGxheTogbm9uZTsKICAgIH0KICAgICNmYkxvZy5zaG93eyBkaXNwbGF5OmJsb2NrOyB9CiAgICAjZmJMb2cgYnsgY29sb3I6IzkzYzVmZDsgfQogICAgI2ZiTG9nIC5lcnJ7IGNvbG9yOiNmY2E1YTU7IH0KICAgICNmYkxvZyAub2t7IGNvbG9yOiM4NmVmYWM7IH0KICAvKiA9PT0gRGFpbHkgY2hhbmdlIGFycm93cyA9PT0gKi8KLmNoYW5nZS1hcnJvd3sgZm9udC13ZWlnaHQ6IDcwMDsgbWFyZ2luLXJpZ2h0OiA0cHg7IH0KLmNoYW5nZS1hcnJvdy51cHsgY29sb3I6IHZhcigtLW9rKTsgfQouY2hhbmdlLWFycm93LmRvd257IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyB9CgogIC5iYW5uZXIud2FybnsKICAgIGJhY2tncm91bmQ6ICMyYjFmMWY7IGNvbG9yOiAjZmZkN2Q3OyBib3JkZXI6IDFweCBzb2xpZCAjNmIyYTJhOwogICAgcGFkZGluZzogOHB4IDEycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IG1hcmdpbjogOHB4IDA7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgZ2FwOjEycHg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOwogIH0KCjwvc3R5bGU+CiAgPGRpdiBpZD0iZmJMb2ciPjwvZGl2PgoKCjxzY3JpcHQ+Ci8vIEdsb2JhbCBjbGljayBkZWxlZ2F0ZSBmb3IgcGVyLWxvdCBtdXRlL3VubXV0ZQpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+ewogIGNvbnN0IGJ0biA9IGUudGFyZ2V0LmNsb3Nlc3QoJ2J1dHRvbi5sb3QtbXV0ZScpOwogIGlmKCFidG4pIHJldHVybjsKICB0cnl7CiAgICBjb25zdCBEQnJlZiA9IHdpbmRvdy5EQiB8fCB7fTsKICAgIGNvbnN0IHBmSWQgPSBEQnJlZi5jdXJyZW50UGZJZCB8fCBEQnJlZi5zZWxlY3RlZFBmSWQgfHwgKERCcmVmLnBvcnRmb2xpb3MgJiYgT2JqZWN0LmtleXMoREJyZWYucG9ydGZvbGlvcylbMF0pOwogICAgY29uc3QgcGYgPSAoREJyZWYucG9ydGZvbGlvcyAmJiBwZklkKSA/IERCcmVmLnBvcnRmb2xpb3NbcGZJZF0gOiBudWxsOwogICAgaWYoIXBmKSByZXR1cm47CiAgICBjb25zdCBsb3RJZCA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtbG90Jyk7CiAgICBsZXQgbG90ID0gbnVsbDsKICAgIGZvcihjb25zdCBbdGssIGJvb2tdIG9mIE9iamVjdC5lbnRyaWVzKHBmLmhvbGRpbmdzfHx7fSkpewogICAgICBsb3QgPSAoYm9vay5sb3RzfHxbXSkuZmluZCh4PT4geC5sb3RJZCA9PT0gbG90SWQpOwogICAgICBpZihsb3QpIGJyZWFrOwogICAgfQogICAgaWYoIWxvdCkgcmV0dXJuOwogICAgbG90Lm11dGVkID0gIWxvdC5tdXRlZDsKICAgIGlmKHR5cGVvZiBzYXZlID09PSAnZnVuY3Rpb24nKSBzYXZlKCk7CiAgICBpZih0eXBlb2YgcmVuZGVyID09PSAnZnVuY3Rpb24nKSByZW5kZXIoKTsKICB9Y2F0Y2goZXJyKXsKICAgIGNvbnNvbGUuZXJyb3IoImxvdC1tdXRlIHRvZ2dsZSBlcnJvciIsIGVycik7CiAgfQp9KTs8L3NjcmlwdD4KCgo8c2NyaXB0PgovLyA9PT0gUGVyc2lzdCBleHBhbmRlZCBjb21wYW55IHBhbmVscyBhY3Jvc3MgbXV0ZS9yZWZyZXNoIHJlbmRlcnMgPT09CihmdW5jdGlvbigpewogIGNvbnN0IFNTX0tFWSA9ICdvcGVuRGV0YWlsc1RpY2tlcnNfdjInOwoKICBmdW5jdGlvbiBsb2FkU2V0KCl7CiAgICB0cnl7IGNvbnN0IHJhdyA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oU1NfS0VZKTsgY29uc3QgYXJyID0gcmF3PyBKU09OLnBhcnNlKHJhdyk6IFtdOyByZXR1cm4gbmV3IFNldChBcnJheS5pc0FycmF5KGFycik/IGFycjogW10pO31jYXRjaChfKXsgcmV0dXJuIG5ldyBTZXQoKTsgfQogIH0KICBmdW5jdGlvbiBzYXZlU2V0KHNldCl7CiAgICB0cnl7IHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oU1NfS0VZLCBKU09OLnN0cmluZ2lmeShBcnJheS5mcm9tKHNldHx8W10pKSk7IH1jYXRjaChfKXt9CiAgfQogIHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2VycyA9IHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2VycyB8fCBsb2FkU2V0KCk7CgogIGZ1bmN0aW9uIGVuc3VyZURhdGFUaWNrZXIocm9vdCl7CiAgICBjb25zdCBjdHggPSByb290IHx8IGRvY3VtZW50OwogICAgY29uc3Qgbm9kZXMgPSBjdHgucXVlcnlTZWxlY3RvckFsbCgnI2hvbGRpbmdzVGFibGVXcmFwIGRldGFpbHM6bm90KFtkYXRhLXRpY2tlcl0pIHN1bW1hcnknKTsKICAgIG5vZGVzLmZvckVhY2goc3VtPT57CiAgICAgIHRyeXsKICAgICAgICAvLyBUYWtlIHRoZSBmaXJzdCB0ZXh0IG5vZGUgY29udGVudCBhcyB0aWNrZXIgKGJlZm9yZSBhbnkgYnV0dG9ucy9pY29ucykKICAgICAgICBsZXQgdHh0ID0gJyc7CiAgICAgICAgZm9yKGNvbnN0IG4gb2Ygc3VtLmNoaWxkTm9kZXMpewogICAgICAgICAgaWYobi5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpewogICAgICAgICAgICB0eHQgPSAobi50ZXh0Q29udGVudHx8JycpLnRyaW0oKTsKICAgICAgICAgICAgaWYodHh0KXsgYnJlYWs7IH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoIXR4dCl7CiAgICAgICAgICAvLyBmYWxsYmFjazogd2hvbGUgdGV4dCB3aXRob3V0IGlubmVyIGJ1dHRvbiBsYWJlbHMKICAgICAgICAgIHR4dCA9IChzdW0udGV4dENvbnRlbnR8fCcnKS50cmltKCkuc3BsaXQoJ1xuJylbMF0udHJpbSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBkZXRhaWxzID0gc3VtLmNsb3Nlc3QoJ2RldGFpbHMnKTsKICAgICAgICBpZihkZXRhaWxzICYmIHR4dCkgZGV0YWlscy5kYXRhc2V0LnRpY2tlciA9IHR4dDsKICAgICAgfWNhdGNoKF8pe30KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcmVtZW1iZXJPcGVuKCl7CiAgICB0cnl7CiAgICAgIGVuc3VyZURhdGFUaWNrZXIoKTsKICAgICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdob2xkaW5nc1RhYmxlV3JhcCcpOwogICAgICBpZighd3JhcCkgcmV0dXJuOwogICAgICBjb25zdCBvcGVuZWQgPSBBcnJheS5mcm9tKHdyYXAucXVlcnlTZWxlY3RvckFsbCgnZGV0YWlsc1tvcGVuXVtkYXRhLXRpY2tlcl0nKSkubWFwKGQ9PmQuZGF0YXNldC50aWNrZXIpOwogICAgICB3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMgPSBuZXcgU2V0KG9wZW5lZCk7CiAgICAgIHNhdmVTZXQod2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzKTsKICAgIH1jYXRjaChfKXt9CiAgfQoKICBmdW5jdGlvbiByZXN0b3JlT3Blbihyb290KXsKICAgIHRyeXsKICAgICAgZW5zdXJlRGF0YVRpY2tlcihyb290KTsKICAgICAgY29uc3QgY3R4ID0gcm9vdCB8fCBkb2N1bWVudDsKICAgICAgY29uc3Qgd3JhcCA9IGN0eC5nZXRFbGVtZW50QnlJZCA/IGN0eCA6IGRvY3VtZW50OwogICAgICAod3JhcC5xdWVyeVNlbGVjdG9yQWxsID8gd3JhcC5xdWVyeVNlbGVjdG9yQWxsKCcjaG9sZGluZ3NUYWJsZVdyYXAgZGV0YWlsc1tkYXRhLXRpY2tlcl0nKSA6IFtdKS5mb3JFYWNoKGQ9PnsKICAgICAgICBjb25zdCB0ID0gZC5kYXRhc2V0LnRpY2tlcjsKICAgICAgICBpZih3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMgJiYgd2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzLmhhcyh0KSkgZC5zZXRBdHRyaWJ1dGUoJ29wZW4nLCcnKTsKICAgICAgfSk7CiAgICB9Y2F0Y2goXyl7fQogIH0KCiAgLy8gS2VlcCBzZXQgaW4gc3luYyB3aGVuIHVzZXIgdG9nZ2xlcyBhbnkgZGV0YWlscwogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvZ2dsZScsIChlKT0+ewogICAgY29uc3QgZCA9IGUudGFyZ2V0ICYmIGUudGFyZ2V0LmNsb3Nlc3QgJiYgZS50YXJnZXQuY2xvc2VzdCgnI2hvbGRpbmdzVGFibGVXcmFwIGRldGFpbHNbZGF0YS10aWNrZXJdJyk7CiAgICBpZighZCkgcmV0dXJuOwogICAgY29uc3QgdCA9IGQuZGF0YXNldC50aWNrZXI7CiAgICBpZighdCkgcmV0dXJuOwogICAgaWYoIXdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2Vycykgd2luZG93Ll9fb3BlbkRldGFpbHNUaWNrZXJzID0gbmV3IFNldCgpOwogICAgaWYoZC5vcGVuKSB3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMuYWRkKHQpOyBlbHNlIHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2Vycy5kZWxldGUodCk7CiAgICBzYXZlU2V0KHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2Vycyk7CiAgfSwgdHJ1ZSk7CgogIC8vIEJlZm9yZSBhbnkgY2xpY2sgdGhhdCBtaWdodCByZS1yZW5kZXIsIHNuYXBzaG90IHRoZSBzdGF0ZSAoY2FwdHVyZSBwaGFzZSkKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IHRyeXsgcmVtZW1iZXJPcGVuKCk7IH1jYXRjaChfKXt9IH0sIHRydWUpOwoKICAvLyBPYnNlcnZlIERPTSBtdXRhdGlvbnMgYW5kIHJlLW9wZW4gYWZ0ZXIgY2hhbmdlcwogIGNvbnN0IG1vID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKGxpc3QpPT57CiAgICBsZXQgbmVlZCA9IGZhbHNlOwogICAgZm9yKGNvbnN0IG0gb2YgbGlzdCl7CiAgICAgIGlmKG0uYWRkZWROb2RlcyAmJiBtLmFkZGVkTm9kZXMubGVuZ3RoKXsKICAgICAgICBuZWVkID0gdHJ1ZTsgYnJlYWs7CiAgICAgIH0KICAgICAgaWYobS50eXBlID09PSAnY2hpbGRMaXN0JykgeyBuZWVkID0gdHJ1ZTsgYnJlYWs7IH0KICAgIH0KICAgIGlmKG5lZWQpewogICAgICAvLyBzbGlnaHQgZGVsYXkgdG8gYWxsb3cgaW5uZXJIVE1MIHRvIHNldHRsZQogICAgICBzZXRUaW1lb3V0KCgpPT5yZXN0b3JlT3BlbigpLCAwKTsKICAgIH0KICB9KTsKICBtby5vYnNlcnZlKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwge3N1YnRyZWU6dHJ1ZSwgY2hpbGRMaXN0OnRydWV9KTsKCiAgLy8gV3JhcCBhbGwga25vd24gcmVuZGVyKiBmdW5jdGlvbnMKICBmdW5jdGlvbiB3cmFwUmVuZGVycygpewogICAgY29uc3QgbmFtZXMgPSBbJ3JlbmRlcicsJ3JlbmRlck1haW4nLCdyZW5kZXJMb3RzJywncmVuZGVyUG9ydGZvbGlvTGlzdCcsJ3JlbmRlcldpc2hsaXN0J107CiAgICBuYW1lcy5mb3JFYWNoKG49PnsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IGZuID0gd2luZG93W25dOwogICAgICAgIGlmKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJyAmJiAhZm4uX19wYXRjaGVkS2VlcE9wZW4pewogICAgICAgICAgY29uc3Qgd3JhcHBlZCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJlbWVtYmVyT3BlbigpOwogICAgICAgICAgICBjb25zdCByZXMgPSBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT5yZXN0b3JlT3BlbigpLCAwKTsKICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICAgIH07CiAgICAgICAgICB3cmFwcGVkLl9fcGF0Y2hlZEtlZXBPcGVuID0gdHJ1ZTsKICAgICAgICAgIHdpbmRvd1tuXSA9IHdyYXBwZWQ7CiAgICAgICAgfQogICAgICB9Y2F0Y2goXyl7fQogICAgfSk7CiAgfQoKICAvLyBJbml0aWFsIHJlc3RvcmUgYWZ0ZXIgZmlyc3QgcGFpbnQKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpPT57IHNldFRpbWVvdXQoKCk9Pnsgd3JhcFJlbmRlcnMoKTsgcmVzdG9yZU9wZW4oKTsgfSwgMCk7IH0pOwogIC8vIEFsc28gdHJ5IHNvb24gaW4gY2FzZSBzY3JpcHRzIGRlZmluZSByZW5kZXJzIGxhdGVyCiAgc2V0VGltZW91dCh3cmFwUmVuZGVycywgMCk7CiAgc2V0VGltZW91dChyZXN0b3JlT3BlbiwgNTApOwp9KSgpOwoKLy8gPT09IEFQSSBsYXN0IHJlZnJlc2ggY2xvY2sgPT09CndpbmRvdy5zZXRBcGlUaW1lID0gZnVuY3Rpb24odHMpewogIHRyeXsKICAgIGlmKHR5cGVvZiBlbnN1cmVTdGF0dXNCZXR3ZWVuID09PSAnZnVuY3Rpb24nKSBlbnN1cmVTdGF0dXNCZXR3ZWVuKCk7CiAgICBjb25zdCB3cmFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N5bmNTdGF0dXNXcmFwJyk7CiAgICBpZighd3JhcCkgcmV0dXJuOwogICAgbGV0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwaVRpbWUnKTsKICAgIGlmKCFlbCl7CiAgICAgIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICBlbC5pZCA9ICdhcGlUaW1lJzsKICAgICAgZWwuc3R5bGUubWFyZ2luTGVmdCA9ICc2cHgnOwogICAgICBlbC5jbGFzc05hbWUgPSAnbXV0ZWQnOwogICAgICB3cmFwLmFwcGVuZENoaWxkKGVsKTsKICAgIH0KICAgIGZ1bmN0aW9uIHBhZChuKXsgcmV0dXJuIChuPDEwPycwJzonJykrbjsgfQogICAgY29uc3QgZCA9IG5ldyBEYXRlKHRzIHx8ICh3aW5kb3cuX19sYXN0QXBpUmVmcmVzaEF0fHxEYXRlLm5vdygpKSk7CiAgICBlbC50ZXh0Q29udGVudCA9ICfigKIgQVBJOiAnICsgcGFkKGQuZ2V0SG91cnMoKSkrJzonK3BhZChkLmdldE1pbnV0ZXMoKSkrJzonK3BhZChkLmdldFNlY29uZHMoKSk7CiAgfWNhdGNoKF8pe30KfTsKCjwvc2NyaXB0PgoKPHNjcmlwdD4KLy8gPT09IFRvYXN0cyAmIFVucmVhZCBiYWRnZSA9PT0KKGZ1bmN0aW9uKCl7CiAgZnVuY3Rpb24gZW5zdXJlV3JhcCgpeyByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvYXN0c1dyYXAnKTsgfQogIHdpbmRvdy5zaG93VG9hc3QgPSBmdW5jdGlvbih7dGlja2VyLCBzdGF0ZSwga2luZH0pewogICAgdHJ5ewogIGNvbnN0IHdyYXAgPSAodHlwZW9mIGVuc3VyZVdyYXA9PT0nZnVuY3Rpb24nKSA/IGVuc3VyZVdyYXAoKSA6IG51bGw7CiAgaWYod3JhcCl7CiAgICBjb25zdCBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgZWwuY2xhc3NOYW1lID0gJ3RvYXN0ICcgKyAoc3RhdGV8fCcnKTsKICAgIGNvbnN0IGxhYmVsID0gc3RhdGU9PT0naGl0JyA/ICfwn46vIENlbCBvc2nEhWduacSZdHknIDogKHN0YXRlPT09J25lYXInID8gJ+KPsyBCbGlza28gY2VsdScgOiAn8J+UlCBBbGFybScpOwogICAgZWwuaW5uZXJIVE1MID0gYDxzdHJvbmc+JHtsYWJlbH08L3N0cm9uZz4g4oCiICR7dGlja2VyID8gKHRpY2tlci50b1VwcGVyQ2FzZT8uKCl8fHRpY2tlcikgOiAn4oCUJ30g4oCiICR7a2luZCA/IGtpbmQudG9VcHBlckNhc2U/LigpIDogJ+KAlCd9IDxzcGFuIGNsYXNzPSJ0aW1lIj4ke25ldyBEYXRlKCkudG9Mb2NhbGVUaW1lU3RyaW5nKCl9PC9zcGFuPmA7CiAgICB3cmFwLmFwcGVuZENoaWxkKGVsKTsKICAgIHNldFRpbWVvdXQoKCk9PnsgdHJ5eyBlbC5yZW1vdmUoKTsgfWNhdGNoKF8peyB9IH0sIDYwMDApOwogIH0KICAvLyBidW1wIHVucmVhZCByZWdhcmRsZXNzIG9mIHRvYXN0IGNvbnRhaW5lciBhdmFpbGFiaWxpdHkKICB0cnl7CiAgICBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsKICAgIGNvbnN0IGN1cnIgPSBOdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oayl8fDApIHx8IDA7CiAgICBjb25zdCB2YWwgPSBNYXRoLm1pbihjdXJyKzEsIDk5OSk7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrLCBTdHJpbmcodmFsKSk7CiAgICBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2U9PT0nZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOwogIH1jYXRjaChfKXt9Cn1jYXRjaChfKXt9CgogIH07CiAgd2luZG93LnVwZGF0ZUFsZXJ0c0JhZGdlID0gZnVuY3Rpb24oKXsKICAgIHRyeXsKICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzVGFiQnRuJyk7CiAgICAgIGlmKCFlbCkgcmV0dXJuOwogICAgICBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsKICAgICAgY29uc3QgbiA9IE51bWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKXx8MCkgfHwgMDsKICAgICAgbGV0IGIgPSBlbC5xdWVyeVNlbGVjdG9yKCcuYmFkZ2UnKTsKICAgICAgaWYobj4wKXsKICAgICAgICBpZighYil7IGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IGIuY2xhc3NOYW1lPSdiYWRnZSc7IGVsLmFwcGVuZENoaWxkKGIpOyB9CiAgICAgICAgYi50ZXh0Q29udGVudCA9IFN0cmluZyhuKTsKICAgICAgfWVsc2UgaWYoYil7IGIucmVtb3ZlKCk7IH0KICAgIH1jYXRjaChfKXt9CiAgfTsKICB3aW5kb3cucmVzZXRBbGVydHNVbnJlYWQgPSBmdW5jdGlvbigpewogICAgdHJ5eyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnYWxlcnRzX3VucmVhZF9jb3VudCcsICcwJyk7IHVwZGF0ZUFsZXJ0c0JhZGdlKCk7IH1jYXRjaChfKXt9CiAgfTsKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgdXBkYXRlQWxlcnRzQmFkZ2UpOwp9KSgpOwo8L3NjcmlwdD4KCgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBfX2ZhbGxiYWNrU2V0QWN0aXZlKHYpewogICAgdHJ5ewogICAgICBjb25zdCBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1haW4nKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJyk7CiAgICAgIGlmKCFtYWluKSByZXR1cm47CiAgICAgIGNvbnN0IHBhbmVscyA9IG1haW4ucXVlcnlTZWxlY3RvckFsbCgnOnNjb3BlID4gc2VjdGlvbicpOwogICAgICBwYW5lbHMuZm9yRWFjaChzZWM9PnsKICAgICAgICBpZih2PT09J3dpc2hsaXN0Jykgc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnKSA/ICcnIDogJ25vbmUnOwogICAgICAgIGVsc2UgaWYodj09PSdhbGVydHMnKSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nYWxlcnRzUGFuZWwnKSA/ICcnIDogJ25vbmUnOwogICAgICAgIGVsc2Ugc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnIHx8IHNlYy5pZD09PSdhbGVydHNQYW5lbCcpID8gJ25vbmUnIDogJyc7CiAgICAgIH0pOwogICAgICBjb25zdCBidG5XID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpc2hsaXN0VGFiQnRuJyk7CiAgICAgIGlmKGJ0blcpeyBidG5XLmNsYXNzTGlzdC50b2dnbGUoJ3NlY29uZGFyeScsIHYhPT0nd2lzaGxpc3QnKTsgfQogICAgICBjb25zdCBidG5BID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1RhYkJ0bicpOwogICAgICBpZihidG5BKXsgYnRuQS5jbGFzc0xpc3QudG9nZ2xlKCdzZWNvbmRhcnknLCB2IT09J2FsZXJ0cycpOyB9CiAgICAgIGNvbnN0IGJ0blAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9ydGZvbGlvc1RhYkJ0bicpOwogICAgICBpZihidG5QKXsgYnRuUC5jbGFzc0xpc3QudG9nZ2xlKCdzZWNvbmRhcnknLCAhKHYhPT0nd2lzaGxpc3QnICYmIHYhPT0nYWxlcnRzJykpOyB9IC8vIHByaW1hcnkgd2hlbiBtYWluCiAgICB9Y2F0Y2goXyl7fQogIH0KICBjb25zdCBuYXZTZXQgPSAod2luZG93LnNldEFjdGl2ZVZpZXcgfHwgX19mYWxsYmFja1NldEFjdGl2ZSk7CiAgdHJ5ewogICAgY29uc3QgYnRuUCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb3J0Zm9saW9zVGFiQnRuJyk7CiAgICBpZihidG5QKXsgYnRuUC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IG5hdlNldCgnbWFpbicpOyB9KTsgfQogICAgY29uc3QgYnRuQSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbGVydHNUYWJCdG4nKTsKICAgIGlmKGJ0bkEpeyBidG5BLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgbmF2U2V0KCdhbGVydHMnKTsgd2luZG93LnJlc2V0QWxlcnRzVW5yZWFkICYmIHdpbmRvdy5yZXNldEFsZXJ0c1VucmVhZCgpOyB0cnl7IGFja0N1cnJlbnRBbGVydHMoKTsgdXBkYXRlU2lkZWJhckJsaW5rU3RhdGVzICYmIHVwZGF0ZVNpZGViYXJCbGlua1N0YXRlcygpOyB9Y2F0Y2goXyl7IH0gd2luZG93LnJlbmRlckFsZXJ0cyAmJiB3aW5kb3cucmVuZGVyQWxlcnRzKCk7IH0pOyB9CiAgICBjb25zdCBidG5XID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpc2hsaXN0VGFiQnRuJyk7CiAgICBpZihidG5XKXsgYnRuVy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IG5hdlNldCgnd2lzaGxpc3QnKTsgfSk7IH0KICB9Y2F0Y2goXyl7fQp9KSgpOwo8L3NjcmlwdD4KCgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBhc3luYyBmdW5jdGlvbiBqdW1wVG9UaWNrZXIodGlja2VyKXsKICAgIHRyeXsKICAgICAgdGlja2VyID0gKHRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAgIGlmKCF0aWNrZXIpIHJldHVybjsKICAgICAgLy8gcGljayBmaXJzdCBwb3J0Zm9saW8gdGhhdCBjb250YWlucyB0aGlzIHRpY2tlcgogICAgICBsZXQgcGZJZCA9IG51bGw7CiAgICAgIHRyeXsKICAgICAgICBmb3IoY29uc3QgcGYgb2YgKHdpbmRvdy5EQj8ucG9ydGZvbGlvc3x8W10pKXsKICAgICAgICAgIGlmKHBmICYmIHBmLmhvbGRpbmdzICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwZi5ob2xkaW5ncywgdGlja2VyKSl7CiAgICAgICAgICAgIHBmSWQgPSBwZi5pZCB8fCBwZi5uYW1lIHx8IG51bGw7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KICAgICAgLy8gc3dpdGNoIHZpZXcgdG8gbWFpbgogICAgICBjb25zdCBuYXZTZXQgPSAod2luZG93LnNldEFjdGl2ZVZpZXcgfHwgZnVuY3Rpb24odil7IAogICAgICAgIGNvbnN0IG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubWFpbicpIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21haW4nKTsKICAgICAgICBpZighbWFpbikgcmV0dXJuOwogICAgICAgIGNvbnN0IHBhbmVscyA9IG1haW4ucXVlcnlTZWxlY3RvckFsbCgnOnNjb3BlID4gc2VjdGlvbicpOwogICAgICAgIHBhbmVscy5mb3JFYWNoKHNlYz0+ewogICAgICAgICAgaWYodj09PSd3aXNobGlzdCcpIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSd3aXNobGlzdFBhbmVsJykgPyAnJyA6ICdub25lJzsKICAgICAgICAgIGVsc2UgaWYodj09PSdhbGVydHMnKSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nYWxlcnRzUGFuZWwnKSA/ICcnIDogJ25vbmUnOwogICAgICAgICAgZWxzZSBzZWMuc3R5bGUuZGlzcGxheSA9IChzZWMuaWQ9PT0nd2lzaGxpc3RQYW5lbCcgfHwgc2VjLmlkPT09J2FsZXJ0c1BhbmVsJykgPyAnbm9uZScgOiAnJzsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIG5hdlNldCgnbWFpbicpOwogICAgICAvLyBvcHRpb25hbGx5IHNlbGVjdCBwb3J0Zm9saW8gaWYgYXBwIGV4cG9zZXMgQVBJCiAgICAgIHRyeXsKICAgICAgICBpZihwZklkICYmIHR5cGVvZiB3aW5kb3cuc2V0Q3VycmVudFBvcnRmb2xpb0lkPT09J2Z1bmN0aW9uJyl7CiAgICAgICAgICBhd2FpdCB3aW5kb3cuc2V0Q3VycmVudFBvcnRmb2xpb0lkKHBmSWQpOwogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KICAgICAgLy8gZW5zdXJlIHJlbmRlcgogICAgICB0cnl7IGlmKHR5cGVvZiB3aW5kb3cucmVuZGVyPT09J2Z1bmN0aW9uJykgd2luZG93LnJlbmRlcigpOyBlbHNlIGlmKHR5cGVvZiB3aW5kb3cucmVuZGVyTWFpbj09PSdmdW5jdGlvbicpIHdpbmRvdy5yZW5kZXJNYWluKCk7IH1jYXRjaChfKXt9CiAgICAgIC8vIHNjcm9sbCB0byByb3cgY29udGFpbmluZyB0aWNrZXIKICAgICAgc2V0VGltZW91dCgoKT0+ewogICAgICAgIHRyeXsKICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkLnRpY2tlcicpKTsKICAgICAgICAgIGNvbnN0IGNlbGwgPSBjYW5kaWRhdGVzLmZpbmQodGQgPT4gKHRkLnRleHRDb250ZW50fHwnJykudG9VcHBlckNhc2UoKS5pbmNsdWRlcyh0aWNrZXIpKTsKICAgICAgICAgIGlmKGNlbGwpewogICAgICAgICAgICBjZWxsLnNjcm9sbEludG9WaWV3KHtiZWhhdmlvcjonc21vb3RoJywgYmxvY2s6J2NlbnRlcid9KTsKICAgICAgICAgICAgY2VsbC5jbGFzc0xpc3QuYWRkKCdoaWdobGlnaHQnKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+eyB0cnl7IGNlbGwuY2xhc3NMaXN0LnJlbW92ZSgnaGlnaGxpZ2h0Jyk7IH1jYXRjaChfKXt9IH0sIDIwMDApOwogICAgICAgICAgfQogICAgICAgIH1jYXRjaChfKXt9CiAgICAgIH0sIDUwKTsKICAgIH1jYXRjaChfKXt9CiAgfQogIC8vIHNpbXBsZSBoaWdobGlnaHQgc3R5bGUKICB0cnl7CiAgICBjb25zdCBjc3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgY3NzLnRleHRDb250ZW50ID0gJy5oaWdobGlnaHR7b3V0bGluZTozcHggc29saWQgI2Y1OWUwYjsgYm9yZGVyLXJhZGl1czo2cHg7IHRyYW5zaXRpb246IG91dGxpbmUtY29sb3IgLjNzfSc7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGNzcyk7CiAgfWNhdGNoKF8pe30KICAvLyBldmVudCBkZWxlZ2F0aW9uCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICAgIGNvbnN0IGEgPSBlLnRhcmdldC5jbG9zZXN0KCdhLmFsZXJ0LXRpY2tlcicpOwogICAgaWYoYSl7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgY29uc3QgdCA9IGEuZ2V0QXR0cmlidXRlKCdkYXRhLXRpY2tlcicpOwogICAgICBqdW1wVG9UaWNrZXIodCk7CiAgICB9CiAgfSk7CiAgLy8gZXhwb3NlIGZvciBkZWJ1Z2dpbmcKICB3aW5kb3cuanVtcFRvVGlja2VyID0ganVtcFRvVGlja2VyOwp9KSgpOwo8L3NjcmlwdD4KCjxzY3JpcHQ+Ci8vID09PSBBbGVydHMgcGFuZWwgbG9naWMgPT09Ci8vIChsb2NhbCBoZWxwZXJzIGZvciBBbGVydHMgcGFuZWwgdG8gYXZvaWQgZ2xvYmFsIGRlcHMpCmNvbnN0IF9fZXNjID0gKHMpPT57CiAgdHJ5ewogICAgaWYgKHR5cGVvZiB3aW5kb3cuZXNjYXBlSHRtbCA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHdpbmRvdy5lc2NhcGVIdG1sKFN0cmluZyhzfHwnJykpOwogIH1jYXRjaChfKXt9CiAgY29uc3QgdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgdC50ZXh0Q29udGVudCA9IFN0cmluZyhzfHwnJyk7CiAgcmV0dXJuIHQuaW5uZXJIVE1MOwp9Owpjb25zdCBfX2ZtdE51bSA9ICh2KT0+ewogIHRyeXsKICAgIGlmICh0eXBlb2Ygd2luZG93LmZtdE51bSA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHdpbmRvdy5mbXROdW0odik7CiAgfWNhdGNoKF8pe30KICBjb25zdCBuID0gTnVtYmVyKHYpOwogIGlmICghaXNGaW5pdGUobikpIHJldHVybiAn4oCUJzsKICByZXR1cm4gbi50b0xvY2FsZVN0cmluZyh1bmRlZmluZWQsIHttYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDJ9KTsKfTsKCgphc3luYyBmdW5jdGlvbiBmZXRjaEFsZXJ0c1BhZ2Uoe2xpbWl0PTEwMCwgc3RhcnRBZnRlcj1udWxsfT17fSl7CiAgY29uc3QgZW1wdHkgPSB7aXRlbXM6W10sIGxhc3REb2M6bnVsbH07CiAgdHJ5ewogICAgY29uc3Qge2F1dGgsIGRifSA9IGF3YWl0IGZiSW5pdCgpOyBpZighZGIgfHwgIWF1dGggfHwgIWF1dGguY3VycmVudFVzZXIpIHJldHVybiBlbXB0eTsKICAgIGNvbnN0IHVpZCA9IGF1dGguY3VycmVudFVzZXIudWlkOwogICAgbGV0IHFCYXNlID0gZGIuY29sbGVjdGlvbignYWxlcnRzJykud2hlcmUoJ3VpZCcsJz09JywgdWlkKTsKICAgIGxldCBxID0gcUJhc2Uub3JkZXJCeSgnY3JlYXRlZEF0JywnZGVzYycpOwogICAgaWYobGltaXQpIHEgPSBxLmxpbWl0KGxpbWl0KTsKICAgIGlmKHN0YXJ0QWZ0ZXIpIHEgPSBxLnN0YXJ0QWZ0ZXIoc3RhcnRBZnRlcik7CiAgICB0cnl7CiAgICAgIGNvbnN0IHNuYXAgPSBhd2FpdCBxLmdldCgpOwogICAgICBjb25zdCBvdXQgPSBbXTsgbGV0IGxhc3REb2MgPSBudWxsOwogICAgICBzbmFwLmZvckVhY2goZG9jPT57CiAgICAgICAgY29uc3QgZCA9IGRvYy5kYXRhKCkgfHwge307CiAgICAgICAgY29uc3QgY3JlYXRlZEF0ID0gKGQuY3JlYXRlZEF0ICYmIGQuY3JlYXRlZEF0LnRvRGF0ZSkgPyBkLmNyZWF0ZWRBdC50b0RhdGUoKSA6IChkLmNyZWF0ZWRBdENsaWVudCA/IG5ldyBEYXRlKGQuY3JlYXRlZEF0Q2xpZW50KSA6IG51bGwpOwogICAgICAgIG91dC5wdXNoKHsKICAgICAgICAgIGlkOiBkb2MuaWQsCiAgICAgICAgICB0aWNrZXI6IChkLnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICBzdGF0ZTogZC5zdGF0ZXx8JycsCiAgICAgICAgICBraW5kOiBkLmtpbmR8fCcnLAogICAgICAgICAgcHJpY2U6IChkLnByaWNlIT1udWxsPyBOdW1iZXIoZC5wcmljZSk6IG51bGwpLAogICAgICAgICAgdGFyZ2V0OiAoZC50YXJnZXQhPW51bGw/IE51bWJlcihkLnRhcmdldCk6IG51bGwpLAogICAgICAgICAgc2NvcGU6IGQuc2NvcGV8fCcnLAogICAgICAgICAgcGZJZDogZC5wZklkfHwnJywKICAgICAgICAgIGNyZWF0ZWRBdAogICAgICAgIH0pOwogICAgICAgIGxhc3REb2MgPSBkb2M7CiAgICAgIH0pOwogICAgICByZXR1cm4ge2l0ZW1zOiBvdXQsIGxhc3REb2N9OwogICAgfWNhdGNoKGUpewogICAgICBjb25zdCBtc2cgPSAoZSAmJiAoZS5tZXNzYWdlfHxlLnRvU3RyaW5nKCkpKSB8fCAnJzsKICAgICAgaWYobXNnLmluY2x1ZGVzKCdyZXF1aXJlcyBhbiBpbmRleCcpKXsKICAgICAgICBjb25zb2xlLmluZm8oJ0FsZXJ0czogZmFsbGluZyBiYWNrIHRvIGNsaWVudC1zaWRlIHNvcnQgKG5vIGNvbXBvc2l0ZSBpbmRleCB5ZXQpLicpOwogICAgICAgIGxldCBxMiA9IHFCYXNlOwogICAgICAgIGlmKGxpbWl0KSBxMiA9IHEyLmxpbWl0KGxpbWl0ICogNSk7CiAgICAgICAgY29uc3Qgc25hcDIgPSBhd2FpdCBxMi5nZXQoKTsKICAgICAgICBjb25zdCBpdGVtcyA9IFtdOwogICAgICAgIHNuYXAyLmZvckVhY2goZG9jPT57CiAgICAgICAgICBjb25zdCBkID0gZG9jLmRhdGEoKSB8fCB7fTsKICAgICAgICAgIGNvbnN0IGNyZWF0ZWRBdCA9IChkLmNyZWF0ZWRBdCAmJiBkLmNyZWF0ZWRBdC50b0RhdGUpID8gZC5jcmVhdGVkQXQudG9EYXRlKCkgOiAoZC5jcmVhdGVkQXRDbGllbnQgPyBuZXcgRGF0ZShkLmNyZWF0ZWRBdENsaWVudCkgOiBudWxsKTsKICAgICAgICAgIGl0ZW1zLnB1c2goewogICAgICAgICAgICBpZDogZG9jLmlkLAogICAgICAgICAgICB0aWNrZXI6IChkLnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICAgIHN0YXRlOiBkLnN0YXRlfHwnJywKICAgICAgICAgICAga2luZDogZC5raW5kfHwnJywKICAgICAgICAgICAgcHJpY2U6IChkLnByaWNlIT1udWxsPyBOdW1iZXIoZC5wcmljZSk6IG51bGwpLAogICAgICAgICAgICB0YXJnZXQ6IChkLnRhcmdldCE9bnVsbD8gTnVtYmVyKGQudGFyZ2V0KTogbnVsbCksCiAgICAgICAgICAgIHNjb3BlOiBkLnNjb3BlfHwnJywKICAgICAgICAgICAgcGZJZDogZC5wZklkfHwnJywKICAgICAgICAgICAgY3JlYXRlZEF0CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBpdGVtcy5zb3J0KChhLGIpPT4gKGIuY3JlYXRlZEF0Py5nZXRUaW1lKCl8fDApIC0gKGEuY3JlYXRlZEF0Py5nZXRUaW1lKCl8fDApKTsKICAgICAgICByZXR1cm4ge2l0ZW1zOiBpdGVtcy5zbGljZSgwLCBsaW1pdHx8aXRlbXMubGVuZ3RoKSwgbGFzdERvYzogbnVsbH07CiAgICAgIH1lbHNlewogICAgICAgIGNvbnNvbGUud2FybignZmV0Y2hBbGVydHNQYWdlIGZhaWxlZCcsIGUpOwogICAgICAgIHJldHVybiBlbXB0eTsKICAgICAgfQogICAgfQogIH1jYXRjaChlKXsKICAgIGNvbnNvbGUud2FybignZmV0Y2hBbGVydHNQYWdlIGZhaWxlZCcsIGUpOwogICAgcmV0dXJuIGVtcHR5OwogIH0KfQoKZnVuY3Rpb24gZm10RGF0ZVRpbWUoZHQpewogIHRyeXsKICAgIGlmKCFkdCkgcmV0dXJuICfigJQnOwogICAgY29uc3QgcGFkID0gbj0+IChuPDEwPycwJzonJykrbjsKICAgIHJldHVybiBkdC5nZXRGdWxsWWVhcigpKyctJytwYWQoZHQuZ2V0TW9udGgoKSsxKSsnLScrcGFkKGR0LmdldERhdGUoKSkrJyAnK3BhZChkdC5nZXRIb3VycygpKSsnOicrcGFkKGR0LmdldE1pbnV0ZXMoKSkrJzonK3BhZChkdC5nZXRTZWNvbmRzKCkpOwogIH1jYXRjaChfKXsgcmV0dXJuICfigJQnOyB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlbmRlckFsZXJ0cygpewogIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzVGFibGVCb2R5Jyk7CiAgY29uc3Qgc3RhdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzU3RhdHMnKTsKICBpZighYm9keSkgcmV0dXJuOwogIGJvZHkuaW5uZXJIVE1MID0gYDx0cj48dGQgY29sc3Bhbj0iNyIgY2xhc3M9Im11dGVkIj7FgWFkb3dhbmll4oCmPC90ZD48L3RyPmA7CiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2hBbGVydHNQYWdlKHtsaW1pdDoyMDB9KTsKICBsZXQgcm93cyA9IHJlcy5pdGVtczsKCiAgLy8gRmlsdGVycwogIGNvbnN0IGZTY29wZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhbGVydHNTY29wZScpPy52YWx1ZSB8fCAnJzsKICBjb25zdCBmU3RhdGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzU3RhdGUnKT8udmFsdWUgfHwgJyc7CiAgY29uc3QgZktpbmQgID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c0tpbmQnKT8udmFsdWUgIHx8ICcnOwogIHJvd3MgPSByb3dzLmZpbHRlcihyPT4gKCFmU2NvcGUgfHwgci5zY29wZT09PWZTY29wZSkgJiYgKCFmU3RhdGUgfHwgci5zdGF0ZT09PWZTdGF0ZSkgJiYgKCFmS2luZCB8fCByLmtpbmQ9PT1mS2luZCkpOwoKICAvLyBTdGF0cwogIGNvbnN0IHRvdGFsID0gcm93cy5sZW5ndGg7CiAgY29uc3QgaGl0cyA9IHJvd3MuZmlsdGVyKHI9PiByLnN0YXRlPT09J2hpdCcpLmxlbmd0aDsKICBjb25zdCBuZWFycyA9IHJvd3MuZmlsdGVyKHI9PiByLnN0YXRlPT09J25lYXInKS5sZW5ndGg7CiAgaWYoc3RhdHMpIHN0YXRzLnRleHRDb250ZW50ID0gYFdwaXPDs3c6ICR7dG90YWx9IOKAlCDwn46vIGhpdDogJHtoaXRzfSwg4o+zIG5lYXI6ICR7bmVhcnN9YDsKCiAgLy8gUmVuZGVyCiAgaWYoIXJvd3MubGVuZ3RoKXsKICAgIGJvZHkuaW5uZXJIVE1MID0gYDx0cj48dGQgY29sc3Bhbj0iNyIgY2xhc3M9Im11dGVkIj5CcmFrIGFsYXJtw7N3IGRvIHd5xZt3aWV0bGVuaWEuPC90ZD48L3RyPmA7CiAgICByZXR1cm47CiAgfQogIGJvZHkuaW5uZXJIVE1MID0gcm93cy5tYXAocj0+ewogICAgY29uc3Qgc3RhdGVUeHQgPSByLnN0YXRlPT09J2hpdCcgPyAn8J+OryBjZWwgb3NpxIVnbmnEmXR5JyA6IChyLnN0YXRlPT09J25lYXInID8gJ+KPsyBibGlza28gY2VsdScgOiByLnN0YXRlKTsKICAgIGNvbnN0IGtpbmRUeHQgPSByLmtpbmQgPyByLmtpbmQudG9VcHBlckNhc2UoKSA6ICfigJQnOwogICAgY29uc3Qgc2NvcGVUeHQgPSByLnNjb3BlPT09J3dpc2hsaXN0JyA/ICdXaXNobGlzdCcgOiAoci5zY29wZT09PSdwb3J0Zm9saW8nID8gJ1BvcnRmZWwnIDogJ+KAlCcpOwogICAgcmV0dXJuIGA8dHIgY2xhc3M9IiR7ci5zdGF0ZT09PSdoaXQnPyhyLmtpbmQ9PT0nc2VsbCc/J2hpdC10YXJnZXQtc2VsbCc6J2hpdC10YXJnZXQtYnV5Jyk6KHIuc3RhdGU9PT0nbmVhcic/KHIua2luZD09PSdzZWxsJz8nbmVhci10YXJnZXQtc2VsbCc6J25lYXItdGFyZ2V0LWJ1eScpOicnKX0iPgogICAgICA8dGQ+JHtmbXREYXRlVGltZShyLmNyZWF0ZWRBdCl9PC90ZD4KICAgICAgPHRkPjxhIGhyZWY9XCIjXCIgY2xhc3M9XCJhbGVydC10aWNrZXJcIiBkYXRhLXRpY2tlcj1cIiR7X19lc2Moci50aWNrZXJ8fCcnKX1cIj4ke19fZXNjKHIudGlja2VyfHwnJyl9PC9hPjwvdGQ+CiAgICAgIDx0ZD4ke3N0YXRlVHh0fTwvdGQ+CiAgICAgIDx0ZD4ke2tpbmRUeHR9PC90ZD4KICAgICAgPHRkPiR7ci5wcmljZSE9bnVsbD8gX19mbXROdW0oci5wcmljZSkgOiAn4oCUJ308L3RkPgogICAgICA8dGQ+JHtyLnRhcmdldCE9bnVsbD8gX19mbXROdW0oci50YXJnZXQpIDogJ+KAlCd9PC90ZD4KICAgICAgPHRkPiR7c2NvcGVUeHR9PC90ZD4KICAgIDwvdHI+YDsKICB9KS5qb2luKCcnKTsKfQoKCihmdW5jdGlvbiB3aXJlQWxlcnRzVUkoKXsKICB0cnl7CiAgICBjb25zdCBjbHIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzQ2xlYXJCdG4nKTsKICAgIGlmKGNscil7CiAgICAgIGNsci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgICAgICAgdHJ5ewogICAgICAgICAgY2xyLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIGNvbnN0IG9sZCA9IGNsci50ZXh0Q29udGVudDsKICAgICAgICAgIGNsci50ZXh0Q29udGVudCA9ICdLYXN1asSZ4oCmJzsKICAgICAgICAgIGF3YWl0IGNsZWFyQWxlcnRzSGlzdG9yeSgpOwogICAgICAgICAgY2xyLnRleHRDb250ZW50ID0gb2xkOwogICAgICAgIH1maW5hbGx5ewogICAgICAgICAgY2xyLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9Y2F0Y2goXyl7fQoKICB0cnl7CiAgICBmdW5jdGlvbiBfX2ZhbGxiYWNrU2V0QWN0aXZlKHYpewogICAgICB0cnl7CiAgICAgICAgY29uc3QgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tYWluJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpOwogICAgICAgIGlmKCFtYWluKSByZXR1cm47CiAgICAgICAgY29uc3QgcGFuZWxzID0gbWFpbi5xdWVyeVNlbGVjdG9yQWxsKCc6c2NvcGUgPiBzZWN0aW9uJyk7CiAgICAgICAgcGFuZWxzLmZvckVhY2goc2VjPT57CiAgICAgICAgICBpZih2PT09J3dpc2hsaXN0Jykgc2VjLnN0eWxlLmRpc3BsYXkgPSAoc2VjLmlkPT09J3dpc2hsaXN0UGFuZWwnKSA/ICcnIDogJ25vbmUnOwogICAgICAgICAgZWxzZSBpZih2PT09J2FsZXJ0cycpIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSdhbGVydHNQYW5lbCcpID8gJycgOiAnbm9uZSc7CiAgICAgICAgICBlbHNlIHNlYy5zdHlsZS5kaXNwbGF5ID0gKHNlYy5pZD09PSd3aXNobGlzdFBhbmVsJyB8fCBzZWMuaWQ9PT0nYWxlcnRzUGFuZWwnKSA/ICdub25lJyA6ICcnOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGJ0blcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lzaGxpc3RUYWJCdG4nKTsKICAgICAgICBpZihidG5XKXsgYnRuVy5jbGFzc0xpc3QudG9nZ2xlKCdzZWNvbmRhcnknLCB2IT09J3dpc2hsaXN0Jyk7IH0KICAgICAgICBjb25zdCBidG5BID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FsZXJ0c1RhYkJ0bicpOwogICAgICAgIGlmKGJ0bkEpeyBidG5BLmNsYXNzTGlzdC50b2dnbGUoJ3NlY29uZGFyeScsIHYhPT0nYWxlcnRzJyk7IH0KICAgICAgfWNhdGNoKF8pe30KICAgIH0KICAgIGNvbnN0IG5hdlNldCA9ICh3aW5kb3cuc2V0QWN0aXZlVmlldyB8fCBfX2ZhbGxiYWNrU2V0QWN0aXZlKTsKCiAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzVGFiQnRuJyk7CiAgICBpZihidG4pewogICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBuYXZTZXQoJ2FsZXJ0cycpOyByZW5kZXJBbGVydHMoKTsgdHJ5eyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnYWxlcnRzX3VucmVhZF9jb3VudCcsJzAnKTsgaWYodHlwZW9mIHVwZGF0ZUFsZXJ0c0JhZGdlPT09J2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsgfWNhdGNoKF8pe30gfSk7CiAgICB9CiAgICBjb25zdCByZWYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWxlcnRzUmVmcmVzaEJ0bicpOwogICAgaWYocmVmKXsKICAgICAgcmVmLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiByZW5kZXJBbGVydHMoKSk7CiAgICB9CiAgICBbJ2FsZXJ0c1Njb3BlJywnYWxlcnRzU3RhdGUnLCdhbGVydHNLaW5kJ10uZm9yRWFjaChpZD0+ewogICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgaWYoZWwpIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpPT4gcmVuZGVyQWxlcnRzKCkpOwogICAgfSk7CiAgfWNhdGNoKF8pe30KfSkoKTsKPC9zY3JpcHQ+Cgo8c2NyaXB0Pgp0cnl7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBmdW5jdGlvbihlKXsKICAgIHRyeXsKICAgICAgaWYoZSAmJiBlLmtleSA9PT0gJ2FsZXJ0c191bnJlYWRfY291bnQnKXsKICAgICAgICBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2UgPT09ICdmdW5jdGlvbicpIHVwZGF0ZUFsZXJ0c0JhZGdlKCk7CiAgICAgIH0KICAgIH1jYXRjaChfKXt9CiAgfSk7CiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsIGZ1bmN0aW9uKCl7CiAgICB0cnl7CiAgICAgIGlmKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gJ3Zpc2libGUnICYmIHR5cGVvZiB1cGRhdGVBbGVydHNCYWRnZSA9PT0gJ2Z1bmN0aW9uJykgdXBkYXRlQWxlcnRzQmFkZ2UoKTsKICAgIH1jYXRjaChfKXt9CiAgfSk7Cn1jYXRjaChfKXt9Cjwvc2NyaXB0PgoKCjxzY3JpcHQ+Ci8qID09PSBHbG9iYWwgQWxhcm0gU2Nhbm5lciAocnVucyBvbiBwcmljZSB1cGRhdGVzKSA9PT0gKi8KdHJ5ewogIHdpbmRvdy5fX2xhc3RHbG9iYWxBbGFybVNjYW5BdCA9IHdpbmRvdy5fX2xhc3RHbG9iYWxBbGFybVNjYW5BdCB8fCAwOwogIGNvbnN0IFNDQU5fTUlOX0lOVEVSVkFMX01TID0gMTAwMDsgLy8gdGhyb3R0bGUgdG8gYXZvaWQgaGVhdnkgbG9vcHMgZWFjaCB0aWNrCgogIHdpbmRvdy5zY2FuQWxhcm1zR2xvYmFsID0gZnVuY3Rpb24oKXsKICAgIHRyeXsKICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgaWYoKG5vdyAtIHdpbmRvdy5fX2xhc3RHbG9iYWxBbGFybVNjYW5BdCkgPCBTQ0FOX01JTl9JTlRFUlZBTF9NUykgcmV0dXJuOwogICAgICB3aW5kb3cuX19sYXN0R2xvYmFsQWxhcm1TY2FuQXQgPSBub3c7CgogICAgICBjb25zdCB0b2wgPSAoTnVtYmVyKERCPy5zZXR0aW5ncz8uYXBwcm9hY2hUb2xlcmFuY2VQY3QpfHwxKS8xMDA7CgogICAgICAvLyAtLS0gUG9ydGZvbGlvIGhvbGRpbmdzIC0tLQogICAgICB0cnl7CiAgICAgICAgY29uc3QgcGZzID0gQXJyYXkuaXNBcnJheShEQj8ucG9ydGZvbGlvcykgPyBEQi5wb3J0Zm9saW9zIDogW107CiAgICAgICAgZm9yKGNvbnN0IHBmIG9mIHBmcyl7CiAgICAgICAgICBjb25zdCBob2xkaW5ncyA9IHBmPy5ob2xkaW5ncyB8fCB7fTsKICAgICAgICAgIGZvcihjb25zdCBbdGlja2VyLCBib29rXSBvZiBPYmplY3QuZW50cmllcyhob2xkaW5ncykpewogICAgICAgICAgICBjb25zdCBsb3RzID0gQXJyYXkuaXNBcnJheShib29rPy5sb3RzKSA/IGJvb2subG90cyA6IFtdOwogICAgICAgICAgICBmb3IoY29uc3QgbG90IG9mIGxvdHMpewogICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgIGxvdC5fdGlja2VyID0gdGlja2VyOwogICAgICAgICAgICAgICAgaWYobG90ICYmIGxvdC5tdXRlZCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBzdCA9ICh0eXBlb2YgdGFyZ2V0U3RhdHVzPT09J2Z1bmN0aW9uJykgPyB0YXJnZXRTdGF0dXMobG90KSA6IHtzdGF0ZTonbm9uZSd9OwogICAgICAgICAgICAgICAgaWYoc3Quc3RhdGU9PT0naGl0JyB8fCBzdC5zdGF0ZT09PSduZWFyJyl7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGtpbmQgPSBzdC5raW5kIHx8IChzdC5zdGF0ZT09PSdoaXQnID8gJ3NlbGwnIDogJ2J1eScpOwogICAgICAgICAgICAgICAgICBjb25zdCBwcmljZSA9IGdldFF1b3RlKHRpY2tlcik7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IChraW5kPT09J3NlbGwnKSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gKHR5cGVvZiBjb21wdXRlVGFyZ2V0UHJpY2U9PT0nZnVuY3Rpb24nID8gY29tcHV0ZVRhcmdldFByaWNlKGxvdCkgOiBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAodHlwZW9mIGNvbXB1dGVCdXlUYXJnZXRQcmljZT09PSdmdW5jdGlvbicgPyBjb21wdXRlQnV5VGFyZ2V0UHJpY2UobG90KSA6IG51bGwpOwogICAgICAgICAgICAgICAgICBpZihwcmljZSE9bnVsbCAmJiB0YXJnZXQhPW51bGwpewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IFsncGYnLCBwZj8uaWQgfHwgJ2RlZmF1bHQnLCB0aWNrZXIsIGtpbmRdLmpvaW4oJ3wnKTsKICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgX19zaG91bGRMb2dBbGFybT09PSdmdW5jdGlvbicgPyBfX3Nob3VsZExvZ0FsYXJtKGtleSwgc3Quc3RhdGUpIDogdHJ1ZSl7CiAgICAgICAgICAgICAgICAgICAgICB0cnl7IGlmKHdpbmRvdy5zaG93VG9hc3QpIHNob3dUb2FzdCh7dGlja2VyLCBzdGF0ZTpzdC5zdGF0ZSwga2luZH0pOyB9Y2F0Y2goXyl7fQogICAgICAgICAgICAgICAgICAgICAgdHJ5eyBsb2dBbGFybUV2ZW50KHtzY29wZToncG9ydGZvbGlvJywgcGZJZDoocGYmJnBmLmlkKXx8JycsIHRpY2tlciwgc3RhdGU6c3Quc3RhdGUsIGtpbmQsIHByaWNlLCB0YXJnZXR9KTsgfWNhdGNoKF8pe30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9Y2F0Y2goXyl7fQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9Y2F0Y2goXyl7fQoKICAgICAgLy8gLS0tIFdpc2hsaXN0IChidXkgdGFyZ2V0cyBvbmx5KSAtLS0KICAgICAgdHJ5ewogICAgICAgIGNvbnN0IHdsID0gQXJyYXkuaXNBcnJheShEQj8ud2F0Y2hsaXN0KSA/IERCLndhdGNobGlzdCA6IFtdOwogICAgICAgIGZvcihjb25zdCB3IG9mIHdsKXsKICAgICAgICAgIHRyeXsKICAgICAgICAgICAgY29uc3QgdCA9ICh3Py50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBwcmljZSA9IGdldFF1b3RlKHQpOwogICAgICAgICAgICBjb25zdCB0YXJnZXRzID0gQXJyYXkuaXNBcnJheSh3Py50YXJnZXRzKSA/ICh3LnRhcmdldHMgfHwgW10pLm1hcChOdW1iZXIpLmZpbHRlcih4PT54PjApCiAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKChOdW1iZXIodz8ucHJpY2UpfHwwKSA/IFtOdW1iZXIody5wcmljZSldIDogW10pOwogICAgICAgICAgICBjb25zdCBhaSA9IE1hdGgubWluKE1hdGgubWF4KE51bWJlcih3Py5hY3RpdmVJbmRleCl8fDAsIDApLCBNYXRoLm1heCh0YXJnZXRzLmxlbmd0aC0xLDApKTsKICAgICAgICAgICAgY29uc3QgZGVzaXJlZCA9IHRhcmdldHMubGVuZ3RoID8gTnVtYmVyKHRhcmdldHNbYWldKXx8MCA6IDA7CiAgICAgICAgICAgIGlmKHByaWNlIT1udWxsICYmIGRlc2lyZWQ+MCl7CiAgICAgICAgICAgICAgbGV0IHN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICBpZihwcmljZSA8PSBkZXNpcmVkKXsgc3RhdGUgPSAnaGl0JzsgfQogICAgICAgICAgICAgIGVsc2UgaWYocHJpY2UgPD0gZGVzaXJlZCooMSt0b2wpKXsgc3RhdGUgPSAnbmVhcic7IH0KICAgICAgICAgICAgICBpZihzdGF0ZSl7CiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBbJ3dsJywgdz8uaWQgfHwgdCwgJ2J1eSddLmpvaW4oJ3wnKTsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBfX3Nob3VsZExvZ0FsYXJtPT09J2Z1bmN0aW9uJyA/IF9fc2hvdWxkTG9nQWxhcm0oa2V5LCBzdGF0ZSkgOiB0cnVlKXsKICAgICAgICAgICAgICAgICAgdHJ5eyBpZih3aW5kb3cuc2hvd1RvYXN0KSBzaG93VG9hc3Qoe3RpY2tlcjp0LCBzdGF0ZSwga2luZDonYnV5J30pOyB9Y2F0Y2goXyl7fQogICAgICAgICAgICAgICAgICB0cnl7IGxvZ0FsYXJtRXZlbnQoe3Njb3BlOid3aXNobGlzdCcsIHRpY2tlcjp0LCBzdGF0ZSwga2luZDonYnV5JywgcHJpY2UsIHRhcmdldDpkZXNpcmVkfSk7IH1jYXRjaChfKXt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9Y2F0Y2goXyl7fQogICAgICAgIH0KICAgICAgfWNhdGNoKF8pe30KICAgIH1jYXRjaChfKXt9CiAgfTsKCiAgLy8gSGVscGVyIHRoYXQgY2FuIGJlIGNhbGxlZCBmcm9tIHNldFF1b3RlCiAgd2luZG93Lm1heWJlU2NhbkFsYXJtc0dsb2JhbCA9IGZ1bmN0aW9uKCl7CiAgICB0cnl7IHdpbmRvdy5zY2FuQWxhcm1zR2xvYmFsICYmIHdpbmRvdy5zY2FuQWxhcm1zR2xvYmFsKCk7IH1jYXRjaChfKXt9CiAgfTsKfWNhdGNoKF8pe30KPC9zY3JpcHQ+CgoKPHNjcmlwdD4KLy8gPT09IENsZWFyIEFsZXJ0cyBIaXN0b3J5ID09PQphc3luYyBmdW5jdGlvbiBjbGVhckFsZXJ0c0hpc3RvcnkoKXsKICB0cnl7CiAgICBjb25zdCBnbyA9ICh0eXBlb2Ygd2luZG93LmNvbmZpcm09PT0nZnVuY3Rpb24nKSA/IHdpbmRvdy5jb25maXJtKCdTa2Fzb3dhxIcgaGlzdG9yacSZIGFsYXJtw7N3PyBPcGVyYWNqxJkgbW/FvG5hIGNvZm7EhcSHIHByemV6IDIgZG5pICjihqnvuI8gQ29mbmlqKS4uJykgOiB0cnVlOwogICAgaWYoIWdvKSByZXR1cm47CiAgICBjb25zdCBjdHggPSBhd2FpdCBmYkluaXQoKTsKICAgIGNvbnN0IHthdXRoLCBkYn0gPSBjdHggfHwge307CiAgICBpZighZGIgfHwgIWF1dGggfHwgIWF1dGguY3VycmVudFVzZXIpeyB0aHJvdyBuZXcgRXJyb3IoJ25vLWF1dGgnKTsgfQogICAgY29uc3QgdWlkID0gYXV0aC5jdXJyZW50VXNlci51aWQ7CiAgICBjb25zdCBxID0gZGIuY29sbGVjdGlvbignYWxlcnRzJykud2hlcmUoJ3VpZCcsJz09JywgdWlkKTsKICAgIGNvbnN0IHNuYXAgPSBhd2FpdCBxLmdldCgpOwogICAgaWYoc25hcCAmJiAhc25hcC5lbXB0eSl7CiAgICAgIGxldCBiYXRjaCA9IGRiLmJhdGNoKCk7CiAgICAgIGxldCBpID0gMCwgY29tbWl0cyA9IFtdOwogICAgICBzbmFwLmZvckVhY2goZG9jPT57CiAgICAgICAgYmF0Y2guZGVsZXRlKGRvYy5yZWYpOwogICAgICAgIGkrKzsKICAgICAgICBpZihpICUgNDAwID09PSAwKXsKICAgICAgICAgIGNvbW1pdHMucHVzaChiYXRjaC5jb21taXQoKSk7CiAgICAgICAgICBiYXRjaCA9IGRiLmJhdGNoKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29tbWl0cy5wdXNoKGJhdGNoLmNvbW1pdCgpKTsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY29tbWl0cyk7CiAgICB9CiAgICAvLyBzdWNjZXNzIHBhdGgKICAgIHRyeXsgd2luZG93Ll9fbGFzdExvZ2dlZEFsZXJ0cyA9IHt9OyB9Y2F0Y2goXyl7fQogICAgdHJ5eyBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oaywnMCcpOyBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2U9PT0nZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOyB9Y2F0Y2goXyl7fQogICAgLy8gUmVmcmVzaCBsaXN0CiAgICByZXR1cm4gcmVuZGVyQWxlcnRzKCk7CiAgfWNhdGNoKGUpewogICAgLy8gRmFsbGJhY2s6IGxvY2FsIGNsZWFyIChoaWRlIGFsbCBhbGVydHMgbG9jYWxseSkKICAgIHRyeXsKICAgICAgY29uc3QgdHMgPSBEYXRlLm5vdygpOwogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnYWxlcnRzX2hpZGRlbl9hbGxfdW50aWwnLCBTdHJpbmcodHMpKTsKICAgICAgd2luZG93Ll9fbGFzdExvZ2dlZEFsZXJ0cyA9IHt9OwogICAgICBjb25zdCBrPSdhbGVydHNfdW5yZWFkX2NvdW50JzsKICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oaywnMCcpOwogICAgICBpZih0eXBlb2YgdXBkYXRlQWxlcnRzQmFkZ2U9PT0nZnVuY3Rpb24nKSB1cGRhdGVBbGVydHNCYWRnZSgpOwogICAgICBpZih0eXBlb2YgcmVuZGVyQWxlcnRzPT09J2Z1bmN0aW9uJykgcmVuZGVyQWxlcnRzKCk7CiAgICAgIGNvbnNvbGUud2FybignY2xlYXJBbGVydHNIaXN0b3J5OiB1c2luZyBsb2NhbCBmYWxsYmFjayBkdWUgdG8nLCBlICYmIChlLmNvZGUgfHwgZS5tZXNzYWdlIHx8IGUudG9TdHJpbmcoKSkpOwogICAgICBhbGVydCgnQnJhayB1cHJhd25pZcWEIGRvIGthc293YW5pYSB3IEZpcmVzdG9yZSDigJQgd3ljenlzemN6b25vIGxva2FsbmllICh3aWRvaykuJyk7CiAgICAgIHJldHVybjsKICAgIH1jYXRjaChfKXt9CiAgfQp9Cjwvc2NyaXB0PgoKCjwhLS0gQUxMT1dfUlVMRVNfQUxFUlRTX1NOSVBQRVQKU3VnZ2VzdGVkIEZpcmVzdG9yZSBydWxlcyBmb3IgYWxlcnRzIGNvbGxlY3Rpb24gKHJlcGxhY2Ugd2l0aCB5b3VyIHNldHVwKToKcnVsZXNfdmVyc2lvbiA9ICcyJzsKc2VydmljZSBjbG91ZC5maXJlc3RvcmUgewogIG1hdGNoIC9kYXRhYmFzZXMve2RhdGFiYXNlfS9kb2N1bWVudHMgewogICAgbWF0Y2ggL2FsZXJ0cy97YWxlcnRJZH0gewogICAgICBhbGxvdyByZWFkOiBpZiByZXF1ZXN0LmF1dGggIT0gbnVsbCAmJiByZXNvdXJjZS5kYXRhLnVpZCA9PSByZXF1ZXN0LmF1dGgudWlkOwogICAgICBhbGxvdyBjcmVhdGU6IGlmIHJlcXVlc3QuYXV0aCAhPSBudWxsICYmIHJlcXVlc3QucmVzb3VyY2UuZGF0YS51aWQgPT0gcmVxdWVzdC5hdXRoLnVpZDsKICAgICAgYWxsb3cgdXBkYXRlLCBkZWxldGU6IGlmIHJlcXVlc3QuYXV0aCAhPSBudWxsICYmIHJlc291cmNlLmRhdGEudWlkID09IHJlcXVlc3QuYXV0aC51aWQ7CiAgICB9CiAgfQp9Ci0tPgoKCjwhLS0gPT09IFtHVCBBRERPTl0gR2xvYmFsIE92ZXJ2aWV3IFRhYiAoT3NvYm5hIFpha8WCYWRrYSkgPT09IC0tPgo8c3R5bGU+CiAgLyogTmFtZXNwYWNlZCBzdHlsZXMgdG8gYXZvaWQgY29sbGlzaW9ucyAqLwogICNnby10YWItb3ZlcmxheVtoaWRkZW5deyBkaXNwbGF5Om5vbmUgIWltcG9ydGFudCB9CiAgI2dvLXRhYi1vdmVybGF5ewogICAgcG9zaXRpb246Zml4ZWQ7IGluc2V0OjA7IHotaW5kZXg6OTk5OTsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudCgxMjAwcHggNjAwcHggYXQgMTAlIC0xMCUsIHJnYmEoMzQsMjExLDIzOCwuMDYpLCB0cmFuc3BhcmVudCA0MCUpLAogICAgICAgICAgICAgICAgcmFkaWFsLWdyYWRpZW50KDEyMDBweCA2MDBweCBhdCAxMTAlIDExMCUsIHJnYmEoMTYsMTg1LDEyOSwuMDYpLCB0cmFuc3BhcmVudCA0MCUpLAogICAgICAgICAgICAgICAgbGluZWFyLWdyYWRpZW50KDEyMGRlZywjMGIxMjIyIDAlLCMwZjE3MmEgNDAlLCAjMTAxNTI1IDEwMCUpOwogICAgY29sb3I6I2U1ZTdlYjsgZm9udC1mYW1pbHk6IHVpLXNhbnMtc2VyaWYsIHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgU2Vnb2UgVUksIFJvYm90bywgSW50ZXIsIE5vdG8gU2FucywgVWJ1bnR1LCBDYW50YXJlbGwsIEFyaWFsOwogIH0KICAjZ28tdGFiLWhlYWRlcnsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTBweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgICBwYWRkaW5nOjEycHggMTRweDsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgIzFmMjkzNzsKICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgwZGVnLCByZ2JhKDE1LDIzLDQyLC43NSksIHJnYmEoMTUsMjMsNDIsLjc1KSk7CiAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICB9CiAgI2dvLXRhYi1tYWlueyBwYWRkaW5nOjE0cHg7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBnYXA6MTRweDsgaGVpZ2h0OiBjYWxjKDEwMCUgLSA2MHB4KTsgb3ZlcmZsb3c6YXV0byB9CiAgI2dvLWZhYnsKICAgIHBvc2l0aW9uOmZpeGVkOyByaWdodDoxNnB4OyBib3R0b206MTZweDsgei1pbmRleDo5OTk4OwogICAgYm9yZGVyOm5vbmU7IGJvcmRlci1yYWRpdXM6MTRweDsgcGFkZGluZzoxMnB4IDE0cHg7IGN1cnNvcjpwb2ludGVyOyBmb250LXdlaWdodDo4MDA7CiAgICBiYWNrZ3JvdW5kOnZhcigtLW9rKTsgY29sb3I6IzAwMTAxODsgYm94LXNoYWRvdzowIDEycHggMjVweCByZ2JhKDE2LDE4NSwxMjksLjM1KTsKICB9CiAgI2dvLWZhYjpob3ZlcnsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xcHgpOyBmaWx0ZXI6IGJyaWdodG5lc3MoMS4wNSkgfQogICNnby1jbG9zZXsgYm9yZGVyOm5vbmU7IGJvcmRlci1yYWRpdXM6MTBweDsgcGFkZGluZzo4cHggMTBweDsgY3Vyc29yOnBvaW50ZXI7IGZvbnQtd2VpZ2h0OjgwMDsgYmFja2dyb3VuZDojMzM0MTU1OyBjb2xvcjojZTVlN2ViIH0KICAjZ28tY2xvc2U6aG92ZXJ7IGZpbHRlcjpicmlnaHRuZXNzKDEuMSkgfQogIC8qIENhcmRzLCB0YWJsZXMsIGV0Yy4gKHNjb3BlZCkgKi8KICAjZ28tdGFiLW92ZXJsYXkgLmdvLWNhcmR7IGJhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDE4MGRlZywgcmdiYSgxNywyNCwzOSwuOTIpLCByZ2JhKDE2LDIzLDQyLC45OCkpOyBib3JkZXI6MXB4IHNvbGlkICMxZjI5Mzc7IGJvcmRlci1yYWRpdXM6MTZweCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1wYW5lbHsgcGFkZGluZzoxNHB4IH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLWdyaWR7IGRpc3BsYXk6Z3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMTIsIDFmcik7IGdhcDoxNHB4IH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLWNvbC0zeyBncmlkLWNvbHVtbjogc3BhbiAzIH0gLmdvLWNvbC00eyBncmlkLWNvbHVtbjogc3BhbiA0IH0gLmdvLWNvbC02eyBncmlkLWNvbHVtbjogc3BhbiA2IH0gLmdvLWNvbC04eyBncmlkLWNvbHVtbjogc3BhbiA4IH0gLmdvLWNvbC0xMnsgZ3JpZC1jb2x1bW46IHNwYW4gMTIgfQogIEBtZWRpYSAobWF4LXdpZHRoOiA5ODBweCl7ICNnby10YWItb3ZlcmxheSAuZ28tY29sLTMsICNnby10YWItb3ZlcmxheSAuZ28tY29sLTQsICNnby10YWItb3ZlcmxheSAuZ28tY29sLTYsICNnby10YWItb3ZlcmxheSAuZ28tY29sLTh7IGdyaWQtY29sdW1uOiBzcGFuIDEyIH0gfQogICNnby10YWItb3ZlcmxheSB0YWJsZXsgd2lkdGg6MTAwJTsgYm9yZGVyLWNvbGxhcHNlOmNvbGxhcHNlIH0KICAjZ28tdGFiLW92ZXJsYXkgdGgsICNnby10YWItb3ZlcmxheSB0ZHsgcGFkZGluZzoxMHB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCAjMWYyOTM3OyB0ZXh0LWFsaWduOmxlZnQ7IHZlcnRpY2FsLWFsaWduOiB0b3AgfQogICNnby10YWItb3ZlcmxheSB0aHsgY29sb3I6I2NiZDVlMTsgYmFja2dyb3VuZDojMGIxMjIyOyBwb3NpdGlvbjpzdGlja3k7IHRvcDowIH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLXRpY2tlcnsgZm9udC1mYW1pbHk6IHVpLW1vbm9zcGFjZSwgTWVubG8sIENvbnNvbGFzLCAiQ291cmllciBOZXciLCBtb25vc3BhY2U7IGxldHRlci1zcGFjaW5nOi4zcHg7IGZvbnQtd2VpZ2h0OjcwMCB9CiAgI2dvLXRhYi1vdmVybGF5IGlucHV0LCAjZ28tdGFiLW92ZXJsYXkgc2VsZWN0ewogICAgd2lkdGg6MTAwJTsgcGFkZGluZzoxMHB4IDEycHg7IGJvcmRlci1yYWRpdXM6MTJweDsgYm9yZGVyOjFweCBzb2xpZCAjMzM0MTU1OwogICAgYmFja2dyb3VuZDojMGIxMjIyOyBjb2xvcjojZTVlN2ViOyBvdXRsaW5lOm5vbmU7IGZvbnQtc2l6ZToxNHB4CiAgfQogICNnby10YWItb3ZlcmxheSAuZ28tY2hpcHsgZGlzcGxheTppbmxpbmUtZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6NnB4OyBwYWRkaW5nOjZweCAxMHB4OyBib3JkZXItcmFkaXVzOjk5OXB4OyBiYWNrZ3JvdW5kOiMwYjEyMjI7IGJvcmRlcjoxcHggc29saWQgIzFmMjkzNzsgZm9udC13ZWlnaHQ6NzAwIH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLXRhZ3sgcGFkZGluZzozcHggOHB4OyBib3JkZXItcmFkaXVzOjk5OXB4OyBib3JkZXI6MXB4IHNvbGlkICMzMzQxNTU7IGNvbG9yOiNjYmQ1ZTE7IGZvbnQtc2l6ZToxMnB4OyBiYWNrZ3JvdW5kOiMwYzE0MjYgfQogICNnby10YWItb3ZlcmxheSAuZ28tc3RhdHsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpmbGV4LXN0YXJ0OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsgZ2FwOjhweDsgcGFkZGluZzoxMnB4OyBib3JkZXItcmFkaXVzOjE0cHg7IGJhY2tncm91bmQ6IzBiMTIyMjsgYm9yZGVyOjFweCBzb2xpZCAjMWYyOTM3IH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLWJpZ3sgZm9udC1zaXplOjIycHg7IGZvbnQtd2VpZ2h0OjkwMCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1tdXRlZHsgY29sb3I6Izk0YTNiOCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1iYWRnZXsgZm9udC13ZWlnaHQ6ODAwOyBwYWRkaW5nOjJweCA2cHg7IGJvcmRlci1yYWRpdXM6OHB4OyBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LC4wNCk7IGRpc3BsYXk6aW5saW5lLWJsb2NrOyBtaW4td2lkdGg6NjJweDsgdGV4dC1hbGlnbjpyaWdodCB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1wb3N7IGNvbG9yOiMxMGI5ODEgfSAuZ28tbmVneyBjb2xvcjojZWY0NDQ0IH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLW1pbml7IGZvbnQtc2l6ZToxMnB4IH0KICAjZ28tdGFiLW92ZXJsYXkgLmdvLXN3aXRjaHsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDo4cHggfQoKICAuYmFubmVyLndhcm57CiAgICBiYWNrZ3JvdW5kOiAjMmIxZjFmOyBjb2xvcjogI2ZmZDdkNzsgYm9yZGVyOiAxcHggc29saWQgIzZiMmEyYTsKICAgIHBhZGRpbmc6IDhweCAxMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyBtYXJnaW46IDhweCAwOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGdhcDoxMnB4OyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjsKICB9Cgo8L3N0eWxlPgo8c3R5bGU+CiAgLyogRGV0YWlscyByb3cgaW4gUG9zaXRpb25zIChhZ2dyZWdhdGlvbikgKi8KICAjZ28tdGFiLW92ZXJsYXkgLmdvLWRldGFpbC1yb3cgdGQgeyBwYWRkaW5nOiAwOyB9CiAgI2dvLXRhYi1vdmVybGF5IC5nby1kZXRhaWwtcm93IC50YWJsZS13cmFwIHsgbWFyZ2luOiA2cHggMDsgfQoKCiAgLmJhbm5lci53YXJuewogICAgYmFja2dyb3VuZDogIzJiMWYxZjsgY29sb3I6ICNmZmQ3ZDc7IGJvcmRlcjogMXB4IHNvbGlkICM2YjJhMmE7CiAgICBwYWRkaW5nOiA4cHggMTJweDsgYm9yZGVyLXJhZGl1czogMTBweDsgbWFyZ2luOiA4cHggMDsKICAgIGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBnYXA6MTJweDsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47CiAgfQoKPC9zdHlsZT4KCjxidXR0b24gaWQ9ImdvLWZhYiIgdGl0bGU9Ikdsb2JhbG55IFByemVnbMSFZCDigJMgb3NvYm5hIHpha8WCYWRrYSI+8J+TiCBQcnplZ2zEhWQ8L2J1dHRvbj4KCjxzZWN0aW9uIGlkPSJnby10YWItb3ZlcmxheSIgaGlkZGVuPgogIDxkaXYgaWQ9ImdvLXRhYi1oZWFkZXIiPgogICAgPGgzIHN0eWxlPSJtYXJnaW46MDtmb250LXNpemU6MThweCI+8J+TiCBHbG9iYWxueSBQcnplZ2zEhWQgTWFqxIV0a3UgPC9oMz4KICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4O2FsaWduLWl0ZW1zOmNlbnRlciI+CgoKICAgICAgPHNwYW4gY2xhc3M9ImdvLXN3aXRjaCBnby1taW5pIj48aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJnby1uby1hcGkiPiA8bGFiZWwgZm9yPSJnby1uby1hcGkiPkJleiBBUEkgKHR5bGtvIGlzdG5pZWrEhWNlIGNlbnkpPC9sYWJlbD48L3NwYW4+CiAgICAgIDxidXR0b24gaWQ9ImdvLXJlZnJlc2giIHRpdGxlPSJPZMWbd2llxbwiPvCflIQ8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBpZD0iZ28tZXhwb3J0LWNzdiIgdGl0bGU9IkVrc3BvcnQgQ1NWIj7irIfvuI8gQ1NWPC9idXR0b24+CiAgICAgIDxidXR0b24gaWQ9ImdvLWV4cG9ydC1qc29uIiB0aXRsZT0iRWtzcG9ydCBKU09OIj7irIfvuI8gSlNPTjwvYnV0dG9uPgogICAgICA8YnV0dG9uIGlkPSJnby1jbG9zZSI+4pyWIFphbWtuaWo8L2J1dHRvbj4KICAgIDwvZGl2PgogIDwvZGl2PgoKCiAgPGRpdiBpZD0iZ28tdGFiLW1haW4iPgogICAgPHNlY3Rpb24gY2xhc3M9ImdvLWNhcmQgZ28tcGFuZWwiPgogICAgICA8ZGl2IGNsYXNzPSJnby1ncmlkIiBzdHlsZT0iYWxpZ24taXRlbXM6ZW5kIj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtNCI+CiAgICAgICAgICA8bGFiZWw+V2FsdXRhIGJhem93YTwvbGFiZWw+CiAgICAgICAgICA8c2VsZWN0IGlkPSJnby1iYXNlIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iUExOIj5QTE48L29wdGlvbj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iVVNEIj5VU0Q8L29wdGlvbj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iRVVSIj5FVVI8L29wdGlvbj4KICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPGRpdiBjbGFzcz0iZ28tbXV0ZWQgZ28tbWluaSI+U3VteSBwcnplbGljemFuZSBiaWXFvMSFY3ltIEZYLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5Ub2tlbiBGaW5uaHViPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBpZD0iZ28tdG9rZW4iIHBsYWNlaG9sZGVyPSJucC4gZDBiLi4uIiAvPgogICAgICAgICAgPGRpdiBjbGFzcz0iZ28tbXV0ZWQgZ28tbWluaSI+SmXFm2xpIHB1c3RlIOKAlCBzcHLDs2J1asSZIHogVXN0YXdpZcWELjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNvbC00Ij4KICAgICAgICAgIDxsYWJlbD5PZMWbd2llxbxhbmllIChzZWsuKTwvbGFiZWw+CiAgICAgICAgICA8aW5wdXQgaWQ9ImdvLXBvbGwiIHR5cGU9Im51bWJlciIgbWluPSI1IiBzdGVwPSIxIiB2YWx1ZT0iNDUiIC8+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXI7bWFyZ2luLXRvcDo4cHgiPgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNoaXAiPvCfkrEgRlg6IDxzcGFuIGlkPSJnby1meCIgc3R5bGU9ImZvbnQtZmFtaWx5OnVpLW1vbm9zcGFjZSI+4oCUPC9zcGFuPjwvZGl2Pgo8ZGl2IGNsYXNzPSJnby1jaGlwIj7inI/vuI8gVVNE4oaSUExOOiA8aW5wdXQgaWQ9ImdvLWZ4LXVzZHBsbiIgdHlwZT0ibnVtYmVyIiBtaW49IjAiIHN0ZXA9IjAuMDAwMSIgc3R5bGU9IndpZHRoOjExMHB4Ij4gPGJ1dHRvbiBpZD0iZ28tZngtYXBwbHkiIGNsYXNzPSJnby1taW5pIiB0aXRsZT0iVXN0YXcga3VycyByxJljem5pZSI+VXN0YXc8L2J1dHRvbj4gPGJ1dHRvbiBpZD0iZ28tZngtY2xlYXIiIGNsYXNzPSJnby1taW5pIiB0aXRsZT0iV3ljennFm8SHIHLEmWN6bnkga3VycyI+V3ljennFm8SHPC9idXR0b24+PC9kaXY+CjxzY3JpcHQgaWQ9ImdvLWZ4LXN0b3JhZ2UiPgooZnVuY3Rpb24oKXsKICBjb25zdCBLRVkgPSAnZ3RfZnhfdXNkX3Bsbic7CiAgZnVuY3Rpb24gdG9OdW0odil7CiAgICBpZiAodj09PXVuZGVmaW5lZCB8fCB2PT09bnVsbCkgcmV0dXJuIE5hTjsKICAgIGNvbnN0IHMgPSBTdHJpbmcodikucmVwbGFjZSgnLCcsICcuJykudHJpbSgpOwogICAgcmV0dXJuIE51bWJlcihzKTsKICB9CiAgZnVuY3Rpb24gcmVhZFNhdmVkKCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IHYgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLRVkpOwogICAgICBjb25zdCBuID0gdG9OdW0odik7CiAgICAgIHJldHVybiAoTnVtYmVyLmlzRmluaXRlKG4pICYmIG4+MCkgPyBuIDogbnVsbDsKICAgIH1jYXRjaChfKXsgcmV0dXJuIG51bGw7IH0KICB9CiAgZnVuY3Rpb24gc2F2ZSh2YWwpewogICAgdHJ5ewogICAgICBjb25zdCBuID0gdG9OdW0odmFsKTsKICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobikgfHwgbjw9MCl7IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKEtFWSk7IHJldHVybiBudWxsOyB9CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEtFWSwgU3RyaW5nKG4pKTsKICAgICAgcmV0dXJuIG47CiAgICB9Y2F0Y2goXyl7IHJldHVybiBudWxsOyB9CiAgfQogIGZ1bmN0aW9uIGNsZWFyU2F2ZWQoKXsKICAgIHRyeXsgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oS0VZKTsgfWNhdGNoKF8pe30KICB9CgogIGZ1bmN0aW9uIGJpbmQoKXsKICAgIGNvbnN0IHJvb3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tdGFiLW92ZXJsYXknKTsKICAgIGlmKCFyb290KSByZXR1cm47CiAgICBjb25zdCBpbnB1dCA9IHJvb3QucXVlcnlTZWxlY3RvcignI2dvLWZ4LXVzZHBsbicpOwogICAgY29uc3QgYnRuQXBwbHkgPSByb290LnF1ZXJ5U2VsZWN0b3IoJyNnby1meC1hcHBseScpOwogICAgY29uc3QgYnRuQ2xlYXIgPSByb290LnF1ZXJ5U2VsZWN0b3IoJyNnby1meC1jbGVhcicpOwogICAgaWYoIWlucHV0KSByZXR1cm47CgogICAgY29uc3Qgc2F2ZWQgPSByZWFkU2F2ZWQoKTsKICAgIGlmKHNhdmVkKXsgaW5wdXQudmFsdWUgPSBzYXZlZDsgfQoKICAgIGlmKGJ0bkFwcGx5KXsKICAgICAgYnRuQXBwbHkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpeyBzYXZlKGlucHV0LnZhbHVlKTsgfSwge3Bhc3NpdmU6dHJ1ZX0pOwogICAgfQogICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uKGV2KXsKICAgICAgaWYoZXYua2V5PT09J0VudGVyJyl7CiAgICAgICAgc2F2ZShpbnB1dC52YWx1ZSk7CiAgICAgICAgaWYoYnRuQXBwbHkpeyB0cnl7IGJ0bkFwcGx5LmNsaWNrKCk7IH1jYXRjaChfKXsgfSB9CiAgICAgIH0KICAgIH0pOwogICAgaWYoYnRuQ2xlYXIpewogICAgICBidG5DbGVhci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCl7IGNsZWFyU2F2ZWQoKTsgfSwge3Bhc3NpdmU6dHJ1ZX0pOwogICAgfQogICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsIGZ1bmN0aW9uKCl7IHNhdmUoaW5wdXQudmFsdWUpOyB9KTsKICB9CgogIGlmKGRvY3VtZW50LnJlYWR5U3RhdGU9PT0nbG9hZGluZycpewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGJpbmQpOwogIH1lbHNlewogICAgYmluZCgpOwogIH0KfSkoKTsKPC9zY3JpcHQ+CgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNoaXAiPvCfp74gxblyw7NkxYJhOiBGaW5uaHViIFF1b3RlLCBGcmFua2Z1cnRlciAoRUNCKSAvIGV4Y2hhbmdlcmF0ZS5ob3N0PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY2hpcCI+8J+niiBDYWNoZSBUVEw6IDxzcGFuIGlkPSJnby10dGwiIGNsYXNzPSJnby1taW5pIj42MHM8L3NwYW4+PC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj48L2Rpdj4KICAgICAgICA8YnV0dG9uIGlkPSJnby1zYXZlIiBzdHlsZT0iYm9yZGVyOm5vbmU7Ym9yZGVyLXJhZGl1czoxMnB4O3BhZGRpbmc6MTBweCAxNHB4O2ZvbnQtd2VpZ2h0OjgwMDtiYWNrZ3JvdW5kOiMyMmQzZWU7Y29sb3I6IzAwMTAxOCI+8J+SviBaYXBpc3o8L2J1dHRvbj4KICAgICAgPC9kaXY+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImdvLWNhcmQgZ28tcGFuZWwiPgogICAgICA8aDQgc3R5bGU9Im1hcmdpbjowIDAgOHB4IDAiPvCflI4gU3p5YmtpZSBzdGF0eXN0eWtpICh3YWx1dGEgYmF6b3dhKTwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9ImdvLWdyaWQiPgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNvbC0zIj48ZGl2IGNsYXNzPSJnby1zdGF0Ij48ZGl2PjxkaXYgY2xhc3M9ImdvLW11dGVkIj5XYXJ0b8WbxIcgYWtjamk8L2Rpdj48ZGl2IGlkPSJnby10b3QtaG9sZCIgY2xhc3M9ImdvLWJpZyI+4oCUPC9kaXY+PC9kaXY+PHNwYW4gY2xhc3M9ImdvLXRhZyI+bGl2ZTwvc3Bhbj48L2Rpdj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtMyI+PGRpdiBjbGFzcz0iZ28tc3RhdCI+PGRpdj48ZGl2IGNsYXNzPSJnby1tdXRlZCI+R290w7N3a2E8L2Rpdj48ZGl2IGlkPSJnby10b3QtY2FzaCIgY2xhc3M9ImdvLWJpZyI+4oCUPC9kaXY+PC9kaXY+PHNwYW4gY2xhc3M9ImdvLXRhZyI+c3VtYTwvc3Bhbj48L2Rpdj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtMyI+PGRpdiBjbGFzcz0iZ28tc3RhdCI+PGRpdj48ZGl2IGNsYXNzPSJnby1tdXRlZCI+U3VtYSBtYWrEhXRrdTwvZGl2PjxkaXYgaWQ9ImdvLXRvdC1lcSIgY2xhc3M9ImdvLWJpZyI+4oCUPC9kaXY+PC9kaXY+PHNwYW4gY2xhc3M9ImdvLXRhZyI+YWtjamUrY2FzaDwvc3Bhbj48L2Rpdj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jb2wtMyI+PGRpdiBjbGFzcz0iZ28tc3RhdCI+PGRpdj48ZGl2IGNsYXNzPSJnby1tdXRlZCI+TmllenJlYWwuIFAvTDwvZGl2PjxkaXYgY2xhc3M9ImdvLWJpZyI+PHNwYW4gaWQ9ImdvLXRvdC11bnIiPuKAlDwvc3Bhbj4gPHNwYW4gaWQ9ImdvLXRvdC11bnItcGN0IiBjbGFzcz0iZ28tYmFkZ2UiPuKAlDwvc3Bhbj48L2Rpdj48ZGl2IGNsYXNzPSJnby1tdXRlZCBnby1taW5pIj52cyBrb3N6dCB3xYJhc255PC9kaXY+PC9kaXY+PHNwYW4gaWQ9ImdvLWRheSIgY2xhc3M9ImdvLXRhZyI+zpQgZHppZW5ueTog4oCUPC9zcGFuPjwvZGl2PjwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2dhcDo4cHg7YWxpZ24taXRlbXM6Y2VudGVyO2ZsZXgtd3JhcDp3cmFwO21hcmdpbi10b3A6NnB4Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn5KwIFpyZWFsLiBQL0wgKGJydXR0byk6IDxzcGFuIGlkPSJnby1yZWFsLWciIHN0eWxlPSJmb250LWZhbWlseTp1aS1tb25vc3BhY2UiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn6e+IFBvZGF0ZWs6IDxzcGFuIGlkPSJnby1yZWFsLXRheCIgc3R5bGU9ImZvbnQtZmFtaWx5OnVpLW1vbm9zcGFjZSI+4oCUPC9zcGFuPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNoaXAiPvCfj4EgWnJlYWwuIFAvTCAobmV0dG8pOiA8c3BhbiBpZD0iZ28tcmVhbC1uIiBzdHlsZT0iZm9udC1mYW1pbHk6dWktbW9ub3NwYWNlIj7igJQ8L3NwYW4+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ28tY2hpcCI+4o+x77iPIMWaci4gY3phcyAoemFta25pxJl0ZSk6IDxzcGFuIGlkPSJnby1hdmctaG9sZCIgc3R5bGU9ImZvbnQtZmFtaWx5OnVpLW1vbm9zcGFjZSI+4oCUPC9zcGFuPjwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9ImdvLWNoaXAiPvCfk4ggxZpyLiB6eXNrICUgLyBwb3p5Y2rEmSAoYnJ1dHRvKTogPHNwYW4gaWQ9ImdvLWF2Zy1wY3QiIHN0eWxlPSJmb250LWZhbWlseTp1aS1tb25vc3BhY2UiPuKAlDwvc3Bhbj48L2Rpdj4KCiAgICAKICAgICAgICA8ZGl2IGNsYXNzPSJnby1jaGlwIj7wn46vIFRQOiA8c3BhbiBpZD0iZ28tdHAtY291bnQiPuKAlDwvc3Bhbj48L2Rpdj48ZGl2IGNsYXNzPSJnby1jaGlwIj48bGFiZWwgZm9yPSJnby1wZXJpb2QiIGNsYXNzPSJnby1jaGlwLWxhYmVsIj7wn5OFIE9rcmVzPC9sYWJlbD4gPHNlbGVjdCBpZD0iZ28tcGVyaW9kIiBzdHlsZT0id2lkdGg6YXV0byI+PG9wdGlvbiB2YWx1ZT0iZGF5Ij5EemllxYQ8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJ3ZWVrIj5UeWR6aWXFhDwvb3B0aW9uPjxvcHRpb24gdmFsdWU9Im1vbnRoIj5NaWVzacSFYzwvb3B0aW9uPjxvcHRpb24gdmFsdWU9Inl0ZCI+VGVuIHJvazwvb3B0aW9uPjxvcHRpb24gdmFsdWU9IjF5Ij5Sb2s8L29wdGlvbj48b3B0aW9uIHZhbHVlPSIyeSI+MiBsYXRhPC9vcHRpb24+PG9wdGlvbiB2YWx1ZT0iM3kiPjMgbGF0YTwvb3B0aW9uPjxvcHRpb24gdmFsdWU9ImFsbCI+Q2HFgnkgb2tyZXM8L29wdGlvbj48L3NlbGVjdD48L2Rpdj4KICAgICAgICAKPC9zZWN0aW9uPgoKPCEtLSDwn6etIFtHT10gV2vFgmFkIHZzIFdhcnRvxZvEhyDigJQgd3lrcmVzIGxpbmlvd3kgLS0+CjxzdHlsZT4KICAvKiBNaW5pbWFsIHN0eWxlcyBmb3IgdGhlIEdPIGxpbmUgY2hhcnQgKi8KICAjZ28tbGluZS1jaGFydC1jYXJkeyBtYXJnaW4tdG9wOiAxMnB4OyB9CiAgLmdvLWxlZ2VuZHsgZGlzcGxheTpmbGV4OyBnYXA6MTZweDsgYWxpZ24taXRlbXM6Y2VudGVyOyBtYXJnaW46NnB4IDAgMTBweCAwOyBmbGV4LXdyYXA6d3JhcDsgfQogIC5nby1sZWdlbmQgLmRvdHsgd2lkdGg6MTJweDsgaGVpZ2h0OjEycHg7IGJvcmRlci1yYWRpdXM6OTk5cHg7IGRpc3BsYXk6aW5saW5lLWJsb2NrOyB2ZXJ0aWNhbC1hbGlnbjptaWRkbGU7IG1hcmdpbi1yaWdodDo2cHg7IH0KICAuZ28tbGVnZW5kIC5ibHVleyBiYWNrZ3JvdW5kOiMzYjgyZjY7IH0KICAuZ28tbGVnZW5kIC5ncmVlbnsgYmFja2dyb3VuZDojMjJjNTVlOyB9CiAgLmdvLWxlZ2VuZCAubXV0ZWR7IG9wYWNpdHk6MC42NTsgZm9udC1zaXplOjEycHg7IH0KICAuZ28tY2hhcnQtd3JhcHsgd2lkdGg6MTAwJTsgaGVpZ2h0OjI2MHB4OyBwb3NpdGlvbjpyZWxhdGl2ZTsgYm9yZGVyOjFweCBzb2xpZCAjMWYyOTM3OyBib3JkZXItcmFkaXVzOjEwcHg7IG92ZXJmbG93OmhpZGRlbjsgfQogICNnby1saW5lLWNoYXJ0eyB3aWR0aDoxMDAlOyBoZWlnaHQ6MTAwJTsgZGlzcGxheTpibG9jazsgfQogICNnby1jaGFydC1lbXB0eXsgcGFkZGluZzoxMnB4OyBmb250LXNpemU6MTNweDsgb3BhY2l0eTowLjg7IH0KICAuZ28tY2hhcnQtdG9vbHRpcHsKICAgIHBvc2l0aW9uOmFic29sdXRlOyBwb2ludGVyLWV2ZW50czpub25lOyBiYWNrZ3JvdW5kOiMwYjEyMjA7IGJvcmRlcjoxcHggc29saWQgIzFmMjkzNzsKICAgIHBhZGRpbmc6NnB4IDhweDsgYm9yZGVyLXJhZGl1czo4cHg7IGZvbnQtc2l6ZToxMnB4OyB3aGl0ZS1zcGFjZTpub3dyYXA7CiAgICB0cmFuc2Zvcm06dHJhbnNsYXRlKC01MCUsIC0xMjAlKTsKICB9CiAgLmdvLWdyaWRsaW5leyBvcGFjaXR5OjAuMTU7IH0KPC9zdHlsZT4KPHNlY3Rpb24gY2xhc3M9ImdvLWNhcmQgZ28tcGFuZWwiIGlkPSJnby1saW5lLWNoYXJ0LWNhcmQiPgogIDxoNCBzdHlsZT0ibWFyZ2luOjAgMCA4cHggMCI+8J+TiCBXa8WCYWQgd8WCYXNueSB2cyB3YXJ0b8WbxIcgKHpha3JlcyBjemFzdSBqYWsgdyBmaWx0cnplKTwvaDQ+CiAgPGRpdiBjbGFzcz0iZ28tbGVnZW5kIj4KICAgIDxzcGFuPjxzcGFuIGNsYXNzPSJkb3QgYmx1ZSI+PC9zcGFuPldrxYJhZCB3xYJhc255ICh3cMWCYXR5IOKIkiB3eXDFgmF0eSk8L3NwYW4+CiAgICA8c3Bhbj48c3BhbiBjbGFzcz0iZG90IGdyZWVuIj48L3NwYW4+V2FydG/Fm8SHIG1hasSFdGt1IChha2NqZSArIGdvdMOzd2thLCB3ZyBiaWXFvMSFY3ljaCBjZW4pPC9zcGFuPgogICAgPHNwYW4gY2xhc3M9Im11dGVkIj4qIGJyYWsgaGlzdG9yaWkgY2VuIOKAlCBsaW5pYSB3YXJ0b8WbY2kgem1pZW5pYSBzacSZIHByenkgdHJhbnNha2NqYWNoL3phc3RyenlrYWNoIGdvdMOzd2tpPC9zcGFuPgogIDwvZGl2PgogIDxkaXYgaWQ9ImdvLWxpbmUtY2hhcnQtaW5mbyIgY2xhc3M9Im11dGVkIiBzdHlsZT0ibWFyZ2luLWJvdHRvbTo2cHgiPgogICAgPHNwYW4gaWQ9ImdvLWluZm8tYmx1ZSI+PC9zcGFuPiDigKIgPHNwYW4gaWQ9ImdvLWluZm8tZ3JlZW4iPjwvc3Bhbj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJnby1jaGFydC13cmFwIj4KICAgIDxjYW52YXMgaWQ9ImdvLWxpbmUtY2hhcnQiPjwvY2FudmFzPgogICAgPGNhbnZhcyBpZD0iZ28tbGluZS1jaGFydC1vdmVybGF5Ij48L2NhbnZhcz4KCiAgICA8ZGl2IGNsYXNzPSJjaGFydC10b29sdGlwLWltcHJvdmVkIiBpZD0iZ28tY2hhcnQtdG9vbHRpcC1pbXAiPgogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwLXJvdy1pbXByb3ZlZCI+PHNwYW4gY2xhc3M9InRvb2x0aXAtbGFiZWwtaW1wcm92ZWQiPkRhdGE6PC9zcGFuPjxzcGFuIGNsYXNzPSJ0b29sdGlwLXZhbHVlLWltcHJvdmVkIiBpZD0idHQtZGF0ZS1pbXAiPi08L3NwYW4+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InRvb2x0aXAtcm93LWltcHJvdmVkIj48c3BhbiBjbGFzcz0idG9vbHRpcC1sYWJlbC1pbXByb3ZlZCI+V2vFgmFkIHfFgmFzbnk6PC9zcGFuPjxzcGFuIGNsYXNzPSJ0b29sdGlwLXZhbHVlLWltcHJvdmVkIiBpZD0idHQtaW52ZXN0ZWQtaW1wIj4tPC9zcGFuPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0b29sdGlwLXJvdy1pbXByb3ZlZCI+PHNwYW4gY2xhc3M9InRvb2x0aXAtbGFiZWwtaW1wcm92ZWQiPldhcnRvxZvEhyBwb3J0ZmVsYTo8L3NwYW4+PHNwYW4gY2xhc3M9InRvb2x0aXAtdmFsdWUtaW1wcm92ZWQiIGlkPSJ0dC12YWx1ZS1pbXAiPi08L3NwYW4+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InRvb2x0aXAtcm93LWltcHJvdmVkIj48c3BhbiBjbGFzcz0idG9vbHRpcC1sYWJlbC1pbXByb3ZlZCI+Wnlzay9TdHJhdGE6PC9zcGFuPjxzcGFuIGNsYXNzPSJ0b29sdGlwLXZhbHVlLWltcHJvdmVkIiBpZD0idHQtcHJvZml0LWltcCI+LTwvc3Bhbj48L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idG9vbHRpcC1yb3ctaW1wcm92ZWQiPjxzcGFuIGNsYXNzPSJ0b29sdGlwLWxhYmVsLWltcHJvdmVkIj5ST0kgKCUpOjwvc3Bhbj48c3BhbiBjbGFzcz0idG9vbHRpcC12YWx1ZS1pbXByb3ZlZCIgaWQ9InR0LXJvaS1pbXAiPi08L3NwYW4+PC9kaXY+CiAgICA8L2Rpdj4KICAgIAogICAgPGRpdiBpZD0iZ28tY2hhcnQtZW1wdHkiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPkJyYWsgZGFueWNoIGRvIHd5a3Jlc3UgdyB3eWJyYW55bSBva3Jlc2llLjwvZGl2PgogIDwvZGl2Pgo8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9ImdvLWNhcmQgZ28tcGFuZWwiPgogICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDo4cHgiPgogICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luOjAiPvCfk4IgUG9ydGZlbGU8L2g0PjxkaXYgc3R5bGU9ImZsZXg6MSI+PC9kaXY+PHNwYW4gY2xhc3M9ImdvLW11dGVkIGdvLW1pbmkiPktsaWtuaWosIGJ5IHJvendpbsSFxIcgcG96eWNqZS48L3NwYW4+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0YWJsZS13cmFwIj4KICAgICAgICA8dGFibGU+CiAgICAgICAgICA8dGhlYWQ+PHRyPjx0aD5Qb3J0ZmVsPC90aD48dGg+V2FsdXRhPC90aD48dGg+R290w7N3a2E8L3RoPjx0aD5Ba2NqZTwvdGg+PHRoPlJhemVtIChuYXQuKTwvdGg+PHRoPlJhemVtIChiYXouKTwvdGg+PHRoPktvc3p0IHfFgmFzbnk8L3RoPjx0aD5VbnJlYWwuIFAvTDwvdGg+PHRoPlVucmVhbC4gJTwvdGg+PHRoPlJlYWwuIG5ldHRvPC90aD48L3RyPjwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHkgaWQ9ImdvLXBmLWJvZHkiPjx0cj48dGQgY29sc3Bhbj0iMTAiIGNsYXNzPSJnby1tdXRlZCI+QnJhayBkYW55Y2jigKY8L3RkPjwvdHI+PC90Ym9keT4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KCiAgICA8c2VjdGlvbiBjbGFzcz0iZ28tY2FyZCBnby1wYW5lbCI+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4O2FsaWduLWl0ZW1zOmNlbnRlciI+CiAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW46MCI+8J+nqSBQb3p5Y2plIChhZ3JlZ2FjamEpPC9oND4KICAgICAgICA8ZGl2IHN0eWxlPSJmbGV4OjEiPjwvZGl2PgogICAgICAgIDxpbnB1dCBpZD0iZ28tZmlsdGVyIiBwbGFjZWhvbGRlcj0ibnAuIFRTTEEsIC5XQSwgenlzaz4wLCBzdHJhdGE+MCwgcGY6TmF6d2EiIHN0eWxlPSJtYXgtd2lkdGg6MzIwcHgiPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idGFibGUtd3JhcCI+CiAgICAgICAgPHRhYmxlPgogICAgICAgICAgPHRoZWFkPjx0cj48dGg+VGlja2VyPC90aD48dGg+UG9ydGZlbDwvdGg+PHRoPklsb8WbxIc8L3RoPjx0aD7FmnIuIGtvc3p0PC90aD48dGg+S29zenQgd8WCYXNueTwvdGg+PHRoPkt1cnM8L3RoPjx0aD5XYXJ0b8WbxIc8L3RoPjx0aD5VbnJlYWwuIFAvTDwvdGg+PHRoPiU8L3RoPjx0aD7OlCBkemllbm55PC90aD48L3RyPjwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHkgaWQ9ImdvLXBvcy1ib2R5Ij48dHI+PHRkIGNvbHNwYW49IjEwIiBjbGFzcz0iZ28tbXV0ZWQiPkJyYWsgcG96eWNqaeKApjwvdGQ+PC90cj48L3Rib2R5PgogICAgICAgIDwvdGFibGU+CiAgICAgIDwvZGl2PgogICAgPC9zZWN0aW9uPgogIDwvZGl2Pgo8L3NlY3Rpb24+Cgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICAidXNlIHN0cmljdCI7CgovLyA9PT0gUGVyaW9kIGZpbHRlciBoZWxwZXJzID09PQpmdW5jdGlvbiB0b01zKGQpewogIHRyeXsKICAgIGlmKGQ9PW51bGwpIHJldHVybiBOYU47CiAgICBpZih0eXBlb2YgZCA9PT0gJ251bWJlcicpIHJldHVybiBkOwogICAgaWYodHlwZW9mIGQgPT09ICdzdHJpbmcnKXsgY29uc3QgbXMgPSBEYXRlLnBhcnNlKGQpOyByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG1zKT9tczpOYU47IH0KICAgIGlmKGQgJiYgdHlwZW9mIGQudG9EYXRlID09PSAnZnVuY3Rpb24nKXsgdHJ5eyByZXR1cm4gZC50b0RhdGUoKS5nZXRUaW1lKCk7IH1jYXRjaChfKXsgcmV0dXJuIE5hTjsgfSB9CiAgICBpZihkICYmIHR5cGVvZiBkLnNlY29uZHMgIT09ICd1bmRlZmluZWQnKXsgcmV0dXJuIE51bWJlcihkLnNlY29uZHMpKjEwMDA7IH0KICB9Y2F0Y2goXyl7fQogIHJldHVybiBOYU47Cn0KZnVuY3Rpb24gZ2V0UGVyaW9kS2V5KCl7CiAgdHJ5eyByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19wZXJpb2QnKSB8fCAnYWxsJzsgfWNhdGNoKF8peyByZXR1cm4gJ2FsbCc7IH0KfQpmdW5jdGlvbiBzZXRQZXJpb2RLZXkoayl7CiAgdHJ5eyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X3BlcmlvZCcsIFN0cmluZyhrfHwnYWxsJykpOyB9Y2F0Y2goXyl7fQp9CmZ1bmN0aW9uIGdldFBlcmlvZFJhbmdlKGtleSl7CiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsKICBjb25zdCBlbmQgPSBub3cuZ2V0VGltZSgpOwogIGNvbnN0IG1zRGF5ID0gMjQqNjAqNjAqMTAwMDsKICBjb25zdCBzdGFydE9mVG9kYXkgPSBuZXcgRGF0ZShub3cuZ2V0RnVsbFllYXIoKSwgbm93LmdldE1vbnRoKCksIG5vdy5nZXREYXRlKCkpLmdldFRpbWUoKTsKICBzd2l0Y2goa2V5KXsKICAgIGNhc2UgJ2RheSc6ICByZXR1cm4ge3N0YXJ0OnN0YXJ0T2ZUb2RheSwgZW5kfTsKICAgIGNhc2UgJ3dlZWsnOiByZXR1cm4ge3N0YXJ0OmVuZCAtIDcqbXNEYXksIGVuZH07CiAgICBjYXNlICdtb250aCc6cmV0dXJuIHtzdGFydDplbmQgLSAzMCptc0RheSwgZW5kfTsKICAgIGNhc2UgJ3l0ZCc6ICByZXR1cm4ge3N0YXJ0Om5ldyBEYXRlKG5vdy5nZXRGdWxsWWVhcigpLDAsMSkuZ2V0VGltZSgpLCBlbmR9OwogICAgY2FzZSAnMXknOiAgIHJldHVybiB7c3RhcnQ6ZW5kIC0gMzY1Km1zRGF5LCBlbmR9OwogICAgY2FzZSAnMnknOiAgIHJldHVybiB7c3RhcnQ6ZW5kIC0gMiozNjUqbXNEYXksIGVuZH07CiAgICBjYXNlICczeSc6ICAgcmV0dXJuIHtzdGFydDplbmQgLSAzKjM2NSptc0RheSwgZW5kfTsKICAgIGRlZmF1bHQ6ICAgICByZXR1cm4ge3N0YXJ0Oi1JbmZpbml0eSwgZW5kfTsKICB9Cn0KZnVuY3Rpb24gaW5SYW5nZU1zKG1zLCByYW5nZSl7CiAgaWYoIXJhbmdlKSByZXR1cm4gdHJ1ZTsKICBpZighTnVtYmVyLmlzRmluaXRlKG1zKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHMgPSBOdW1iZXIocmFuZ2Uuc3RhcnQgPz8gLUluZmluaXR5KTsKICBjb25zdCBlID0gTnVtYmVyKHJhbmdlLmVuZCA/PyBJbmZpbml0eSk7CiAgcmV0dXJuIG1zID49IHMgJiYgbXMgPD0gZTsKfQoKICAvLyA9PT0gR0xPQkFMLCBDT09QRVJBVElWRSBSQVRFLUxJTUlURUQgUVVPVEUgTEFZRVIgKHNoYXJlZCBhY3Jvc3MgbW9kdWxlcykgPT09CiAgY29uc3QgTUlOX0lOVEVSVkFMX01TID0gMTEwMDsgICAgICAgLy8gIH4xIHJlcS9zZWMgKHNhZmUgZm9yIGZyZWUgdGllcnMpCiAgY29uc3QgQ0FDSEVfVFRMX01TICAgPSA2MCoxMDAwOyAgICAgLy8gIDYwcyBjYWNoZSBwZXIgc3ltYm9sCiAgY29uc3QgQkFDS09GRl80MjlfTVMgPSAxNSoxMDAwOyAgICAgLy8gIDE1cyBjb29sZG93biBvbiA0MjkKCiAgY29uc3QgVyA9IHdpbmRvdzsKICBXLl9fR1RfUVVPVEVfQ0FDSEUgPSBXLl9fR1RfUVVPVEVfQ0FDSEUgfHwgbmV3IE1hcCgpOyAvLyBzeW1ib2wgLT4ge3EsIGF0fQogIFcuX19HVF9RVU9URV9QRU5ESU5HID0gVy5fX0dUX1FVT1RFX1BFTkRJTkcgfHwgbmV3IE1hcCgpOyAvLyBzeW1ib2wgLT4gUHJvbWlzZQogIFcuX19HVF9RVU9URV9MQVNUX0NBTEwgPSBXLl9fR1RfUVVPVEVfTEFTVF9DQUxMIHx8IDA7CiAgVy5fX0dUX1FVT1RFX0NPT0xET1dOX1VOVElMID0gVy5fX0dUX1FVT1RFX0NPT0xET1dOX1VOVElMIHx8IDA7CgogIGZ1bmN0aW9uIG5vdygpeyByZXR1cm4gRGF0ZS5ub3coKTsgfQoKICBmdW5jdGlvbiByZWFkRnJvbUFwcFF1b3RlcyhzeW1ib2wpewogICAgdHJ5ewogICAgICAvLyBwcsOzYnVqZW15IHdzcMOzxYJkemllbGnEhyBkYW5lIGfFgsOzd25laiBhcGxpa2FjamksIGplxZtsaSBtYSBnbG9iYWwgUVVPVEVTCiAgICAgIGNvbnN0IFEgPSBXLlFVT1RFUyB8fCBXLl9fUVVPVEVTIHx8IG51bGw7CiAgICAgIGlmKCFRIHx8ICFRW3N5bWJvbF0pIHJldHVybiBudWxsOwogICAgICBjb25zdCB2ID0gUVtzeW1ib2xdOwogICAgICAvLyBoZXVyeXN0eWthOiByb3ptYWl0ZSBmb3JtYXR5CiAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ29iamVjdCcpewogICAgICAgIGNvbnN0IHByaWNlID0gTnVtYmVyKHYucHJpY2UgPz8gdi5jID8/IHYubGFzdCA/PyB2LnApIHx8IG51bGw7CiAgICAgICAgaWYgKHByaWNlKXsgcmV0dXJuIHsgYzogcHJpY2UsIHBjOiBOdW1iZXIodi5wcmV2UHJpY2UgPz8gdi5wYyA/PyAwKSB8fCBudWxsLCB0OiBub3coKSB9OyB9CiAgICAgIH1lbHNlIGlmIChpc0Zpbml0ZShOdW1iZXIodikpKXsKICAgICAgICByZXR1cm4geyBjOiBOdW1iZXIodiksIHBjOiBudWxsLCB0OiBub3coKSB9OwogICAgICB9CiAgICB9Y2F0Y2goXyl7fQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBhc3luYyBmdW5jdGlvbiBkZWxheShtcyl7IHJldHVybiBuZXcgUHJvbWlzZShyPT5zZXRUaW1lb3V0KHIsIG1zKSk7IH0KCiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hRdW90ZUNvb3Aoc3ltYm9sLCB0b2tlbiwgb3B0cz17fSl7CiAgICBjb25zdCBub0FwaSA9ICEhb3B0cy5ub0FwaTsKICAgIGNvbnN0IHR0bCA9IGlzRmluaXRlKG9wdHMudHRsTXMpID8gb3B0cy50dGxNcyA6IENBQ0hFX1RUTF9NUzsKICAgIGNvbnN0IGtleSA9IFN0cmluZyhzeW1ib2wpLnRvVXBwZXJDYXNlKCk7CgogICAgLy8gKDEpIGNhY2hlCiAgICBjb25zdCBjYWNoZWQgPSBXLl9fR1RfUVVPVEVfQ0FDSEUuZ2V0KGtleSk7CiAgICBpZiAoY2FjaGVkICYmIChub3coKSAtIGNhY2hlZC5hdCkgPCB0dGwpeyByZXR1cm4gY2FjaGVkLnE7IH0KCiAgICAvLyAoMikgdHJ5IHJlYWQgZnJvbSBhcHAncyBleGlzdGluZyBxdW90ZXMKICAgIGNvbnN0IGZyb21BcHAgPSByZWFkRnJvbUFwcFF1b3RlcyhrZXkpOwogICAgaWYgKGZyb21BcHApewogICAgICBXLl9fR1RfUVVPVEVfQ0FDSEUuc2V0KGtleSwge3E6IGZyb21BcHAsIGF0OiBub3coKX0pOwogICAgICByZXR1cm4gZnJvbUFwcDsKICAgIH0KCiAgICAvLyAoMykgbm8gZXh0ZXJuYWwgY2FsbHMgbW9kZQogICAgaWYgKG5vQXBpIHx8ICF0b2tlbil7CiAgICAgIC8vIGtlZXAgbGFzdCBrbm93biBjYWNoZSBvciByZXR1cm4gbnVsbAogICAgICByZXR1cm4gY2FjaGVkID8gY2FjaGVkLnEgOiBudWxsOwogICAgfQoKICAgIC8vIGRlLWR1cCBjb25jdXJyZW50IGZldGNoZXMgZm9yIHRoZSBzYW1lIHN5bWJvbAogICAgaWYgKFcuX19HVF9RVU9URV9QRU5ESU5HLmhhcyhrZXkpKSByZXR1cm4gYXdhaXQgVy5fX0dUX1FVT1RFX1BFTkRJTkcuZ2V0KGtleSk7CgogICAgY29uc3QgcCA9IChhc3luYyAoKT0+ewogICAgICAvLyBjb29sZG93biB3aW5kb3cgYWZ0ZXIgNDI5CiAgICAgIGNvbnN0IHVudGlsID0gVy5fX0dUX1FVT1RFX0NPT0xET1dOX1VOVElMIHx8IDA7CiAgICAgIGlmIChub3coKSA8IHVudGlsKSB7IGF3YWl0IGRlbGF5KHVudGlsIC0gbm93KCkpOyB9CgogICAgICAvLyByYXRlIGxpbWl0OiBzcGFjaW5nIGNhbGxzCiAgICAgIGNvbnN0IHdhaXQgPSBNYXRoLm1heCgwLCAoVy5fX0dUX1FVT1RFX0xBU1RfQ0FMTCArIE1JTl9JTlRFUlZBTF9NUykgLSBub3coKSk7CiAgICAgIGlmICh3YWl0PjApIGF3YWl0IGRlbGF5KHdhaXQpOwoKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IHVybCA9IGBodHRwczovL2Zpbm5odWIuaW8vYXBpL3YxL3F1b3RlP3N5bWJvbD0ke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfSZ0b2tlbj0ke2VuY29kZVVSSUNvbXBvbmVudCh0b2tlbil9YDsKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgIGlmIChyZXMuc3RhdHVzID09PSA0MjkpewogICAgICAgICAgLy8gYmFja29mZjsga2VlcCBvbGQgdmFsdWUgaWYgYW55CiAgICAgICAgICBXLl9fR1RfUVVPVEVfQ09PTERPV05fVU5USUwgPSBub3coKSArIEJBQ0tPRkZfNDI5X01TOwogICAgICAgICAgY29uc3QgY2FjaGVkID0gVy5fX0dUX1FVT1RFX0NBQ0hFLmdldChrZXkpOwogICAgICAgICAgcmV0dXJuIGNhY2hlZCA/IGNhY2hlZC5xIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc3QganMgPSBhd2FpdCByZXMuanNvbigpOwogICAgICAgIGNvbnN0IHEgPSB7IGM6TnVtYmVyKGpzLmMpfHxudWxsLCBwYzpOdW1iZXIoanMucGMpfHxudWxsLCBkOk51bWJlcihqcy5kKXx8bnVsbCwgZHA6TnVtYmVyKGpzLmRwKXx8bnVsbCwgdDoganMudHx8bm93KCkgfTsKICAgICAgICBXLl9fR1RfUVVPVEVfQ0FDSEUuc2V0KGtleSwge3EsIGF0OiBub3coKX0pOwogICAgICAgIHJldHVybiBxOwogICAgICB9ZmluYWxseXsKICAgICAgICBXLl9fR1RfUVVPVEVfTEFTVF9DQUxMID0gbm93KCk7CiAgICAgIH0KICAgIH0pKCk7CgogICAgVy5fX0dUX1FVT1RFX1BFTkRJTkcuc2V0KGtleSwgcCk7CiAgICB0cnl7IHJldHVybiBhd2FpdCBwOyB9CiAgICBmaW5hbGx5eyBXLl9fR1RfUVVPVEVfUEVORElORy5kZWxldGUoa2V5KTsgfQogIH0KCiAgLy8gPT09IE1vZHVsZS1sb2NhbCBjb2RlID09PQogIGNvbnN0IEtFWSA9ICJwb3J0ZmVsZV9maXJteV92MSI7CiAgY29uc3QgJCA9IChzLCByPWRvY3VtZW50KT0+IHIucXVlcnlTZWxlY3RvcihzKTsKICBjb25zdCBmbXRNb25leSA9IChuLCBjdXI9J1BMTicpID0+IHsKICAgIGNvbnN0IHggPSBOdW1iZXIobik7IGlmKCFpc0Zpbml0ZSh4KSkgcmV0dXJuICLigJQiOwogICAgdHJ5eyByZXR1cm4gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdwbC1QTCcse3N0eWxlOidjdXJyZW5jeScsIGN1cnJlbmN5OmN1ciwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOjIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czoyfSkuZm9ybWF0KHgpOyB9CiAgICBjYXRjaChlKXsgcmV0dXJuIHgudG9GaXhlZCgyKSsnICcrY3VyOyB9CiAgfTsKICBjb25zdCBmbXROdW0gPSAobixkPTIpPT4gaXNGaW5pdGUoTnVtYmVyKG4pKSA/IE51bWJlcihuKS50b0ZpeGVkKGQpIDogJ+KAlCc7CgogIGNvbnN0IFNUID0gewogICAgREI6bnVsbCwgYmFzZTonUExOJywgdG9rZW46JycsIHBvbGw6NDUsIEZYOntQTE46e1BMTjoxLCBmeFVzZHBsbkF0OjB9fSwgdGltZXI6bnVsbCwgbm9BcGk6ZmFsc2UsIHR0bE1zOjYwKjEwMDAKICB9OwoKICBmdW5jdGlvbiBsb2FkUHJlZnMoKXsKICB0cnl7CiAgICBTVC5wZXJpb2RLZXkgPSBnZXRQZXJpb2RLZXkoKTsKICAgIGNvbnN0IHNlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1wZXJpb2QnKTsKICAgIGlmKHNlbCl7IHNlbC52YWx1ZSA9IFNULnBlcmlvZEtleTsgfQogICAgU1QucGVyaW9kUmFuZ2UgPSBnZXRQZXJpb2RSYW5nZShTVC5wZXJpb2RLZXkpOwogIH1jYXRjaChfKXsgU1QucGVyaW9kS2V5ID0gJ2FsbCc7IFNULnBlcmlvZFJhbmdlID0gZ2V0UGVyaW9kUmFuZ2UoJ2FsbCcpOyB9CgogICAgdHJ5eyBTVC5EQiA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKSB8fCAne30nKTsgfSBjYXRjaChfKXsgU1QuREIgPSB7fTsgfQogICAgaWYoIVNULkRCIHx8ICFTVC5EQi5zZXR0aW5ncykgU1QuREIgPSBTVC5EQiB8fCB7c2V0dGluZ3M6e319OwogICAgU1QuYmFzZSAgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X2Jhc2UnKSB8fCAnUExOJzsKICAgIFNULnBvbGwgID0gTnVtYmVyKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfcG9sbCcpfHwgKFNULkRCLnNldHRpbmdzPy5wcmljZVBvbGxTZWNvbmRzIHx8IDQ1KSkgfHwgNDU7CiAgICBTVC50b2tlbiA9IChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X3RvaycpIHx8IFNULkRCLnNldHRpbmdzPy5maW5uaHViVG9rZW4gfHwgJycpLnRyaW0oKTsKICAgIFNULm5vQXBpID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19ub2FwaScpID09PSAnMSc7CiAgICAkKCcjZ28tYmFzZScpLnZhbHVlID0gU1QuYmFzZTsgJCgnI2dvLXBvbGwnKS52YWx1ZSA9IFNULnBvbGw7ICQoJyNnby10b2tlbicpLnZhbHVlID0gU1QudG9rZW47CiAgICAkKCcjZ28tbm8tYXBpJykuY2hlY2tlZCA9IFNULm5vQXBpOwogICAgJCgnI2dvLXR0bCcpLnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChTVC50dGxNcy8xMDAwKSsncyc7CiAgfQoKICAKYXN5bmMgZnVuY3Rpb24gZW5zdXJlRngoZnJvbSwgdG8pewogIHRyeXsKICAgIGlmKCFTVC5GWFtmcm9tXSkgU1QuRlhbZnJvbV0gPSB7fTsKICAgIGNvbnN0IHBhaXJLZXkgPSBmcm9tICsgJy0+JyArIHRvOwogICAgY29uc3Qgbm93VHMgPSBEYXRlLm5vdygpOwoKICAgIC8vIHNhbWUtY3VycmVuY3kgc2hvcnRjdXQKICAgIGlmKGZyb209PT10byl7CiAgICAgIFNULkZYW2Zyb21dW3RvXSA9IDE7CiAgICAgIHRyeXsgcGFpbnRGeCgpOyB9Y2F0Y2goXyl7fQogICAgICByZXR1cm4gMTsKICAgIH0KCiAgICAvLyBNYW51YWwgb3ZlcnJpZGUgZm9yIFVTRC0+UExOL1BMTi0+VVNEIChzZXQgdmlhICJVc3RhdyIpCiAgICB0cnl7CiAgICAgIGlmICgoZnJvbT09PSdVU0QnICYmIHRvPT09J1BMTicpIHx8IChmcm9tPT09J1BMTicgJiYgdG89PT0nVVNEJykpewogICAgICAgIGNvbnN0IG0gPSBOdW1iZXIobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19meF91c2RwbG4nKSB8fCAnJyk7CiAgICAgICAgaWYgKE51bWJlci5pc0Zpbml0ZShtKSAmJiBtPjApewogICAgICAgICAgLy8gcmVzcGVjdCBtYW51YWwgb3ZlcnJpZGUKICAgICAgICAgIFNULkZYWydVU0QnXSA9IFNULkZYWydVU0QnXSB8fCB7fTsKICAgICAgICAgIFNULkZYWydQTE4nXSA9IFNULkZYWydQTE4nXSB8fCB7fTsKICAgICAgICAgIFNULkZYWydVU0QnXVsnUExOJ10gPSBtOwogICAgICAgICAgU1QuRlhbJ1BMTiddWydVU0QnXSA9IDEvbTsKICAgICAgICAgIHRyeXsgcGFpbnRGeCgpOyB9Y2F0Y2goXyl7fQogICAgICAgICAgcmV0dXJuIChmcm9tPT09J1VTRCcpID8gbSA6ICgxL20pOwogICAgICAgIH0KICAgICAgfQogICAgfWNhdGNoKF8pe30KCiAgICAvLyBGb3IgVVNEPC0+UExOIHJlZnJlc2ggdXNpbmcgVFRMIChkZWZhdWx0cyB0byBTVC50dGxNcykKICAgIGNvbnN0IGlzVXNkUGxuID0gKGZyb209PT0nVVNEJyAmJiB0bz09PSdQTE4nKSB8fCAoZnJvbT09PSdQTE4nICYmIHRvPT09J1VTRCcpOwogICAgY29uc3QgdHRsTXMgPSBNYXRoLm1heCgxMF8wMDAsIE51bWJlcihTVC50dGxNcyl8fDYwXzAwMCk7CiAgICBjb25zdCBjYWNoZWQgPSBTVC5GWFtmcm9tXSAmJiBTVC5GWFtmcm9tXVt0b107CiAgICBjb25zdCBmcmVzaEVub3VnaCA9IGlzVXNkUGxuID8gKG5vd1RzIC0gKFNULmZ4VXNkcGxuQXR8fDApIDwgdHRsTXMpIDogTnVtYmVyLmlzRmluaXRlKGNhY2hlZCk7CgogICAgaWYgKE51bWJlci5pc0Zpbml0ZShjYWNoZWQpICYmIGZyZXNoRW5vdWdoKXsKICAgICAgcmV0dXJuIFNULkZYW2Zyb21dW3RvXTsKICAgIH0KCiAgICAvLyBEZWNpZGUgZmV0Y2ggZGlyZWN0aW9uIChub3JtYWxpemUgdG8gVVNELT5QTE4gaWYgcGFpciBpcyBQTE4tPlVTRCkKICAgIGxldCBhID0gZnJvbSwgYiA9IHRvLCBpbnZlcnQgPSBmYWxzZTsKICAgIGlmIChmcm9tPT09J1BMTicgJiYgdG89PT0nVVNEJyl7IGE9J1VTRCc7IGI9J1BMTic7IGludmVydCA9IHRydWU7IH0KCiAgICBsZXQgcmF0ZSA9IG51bGw7CgogICAgLy8gVHJ5IEZyYW5rZnVydGVyIChFQ0IpIGZpcnN0IOKAlCBDT1JTLWZyaWVuZGx5LCBubyBBUEkga2V5CiAgICB0cnl7CiAgICAgIGlmIChhPT09J1VTRCcgJiYgYj09PSdQTE4nKXsKICAgICAgICBjb25zdCByID0gYXdhaXQgZmV0Y2goJ2h0dHBzOi8vYXBpLmZyYW5rZnVydGVyLmFwcC9sYXRlc3Q/ZnJvbT1VU0QmdG89UExOJyk7CiAgICAgICAgaWYgKHIub2spewogICAgICAgICAgY29uc3QgaiA9IGF3YWl0IHIuanNvbigpOwogICAgICAgICAgcmF0ZSA9IE51bWJlcihqICYmIGoucmF0ZXMgJiYgai5yYXRlcy5QTE4pOwogICAgICAgIH0KICAgICAgfQogICAgfWNhdGNoKF8pe30KCiAgICAvLyBGYWxsYmFjazogZXhjaGFuZ2VyYXRlLmhvc3QgKGFsc28gQ09SUy1mcmllbmRseSkKICAgIGlmKCFOdW1iZXIuaXNGaW5pdGUocmF0ZSkgfHwgcmF0ZTw9MCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9hcGkuZXhjaGFuZ2VyYXRlLmhvc3QvbGF0ZXN0P2Jhc2U9JHtlbmNvZGVVUklDb21wb25lbnQoYSl9JnN5bWJvbHM9JHtlbmNvZGVVUklDb21wb25lbnQoYil9YDsKICAgICAgICBjb25zdCBqID0gYXdhaXQgKGF3YWl0IGZldGNoKHVybCkpLmpzb24oKS5jYXRjaCgoKT0+bnVsbCk7CiAgICAgICAgcmF0ZSA9IE51bWJlcihqICYmIGoucmF0ZXMgJiYgai5yYXRlc1tiXSk7CiAgICAgIH1jYXRjaChfKXt9CiAgICB9CgogICAgLy8gRmluYWxpemUKICAgIGlmIChOdW1iZXIuaXNGaW5pdGUocmF0ZSkgJiYgcmF0ZT4wKXsKICAgICAgY29uc3QgZmluYWwgPSBpbnZlcnQgPyAoMS9yYXRlKSA6IHJhdGU7CiAgICAgIGlmKCFTVC5GWFtmcm9tXSkgU1QuRlhbZnJvbV0gPSB7fTsKICAgICAgaWYoIVNULkZYW3RvXSkgU1QuRlhbdG9dID0ge307CiAgICAgIFNULkZYW2Zyb21dW3RvXSA9IGZpbmFsOwogICAgICBTVC5GWFt0b11bZnJvbV0gPSAxL2ZpbmFsOwoKICAgICAgLy8gSWYgc3BlY2lmaWNhbGx5IFVTRC0+UExOIHBhaXIsIHVwZGF0ZSBpbnB1dCBhbmQgcmVtZW1iZXIgdGltZXN0YW1wCiAgICAgIHRyeXsKICAgICAgICBpZiAoKGZyb209PT0nVVNEJyAmJiB0bz09PSdQTE4nKSB8fCAoZnJvbT09PSdQTE4nICYmIHRvPT09J1VTRCcpKXsKICAgICAgICAgIFNULmZ4VXNkcGxuQXQgPSBub3dUczsKICAgICAgICAgIGNvbnN0IHYgPSAoZnJvbT09PSdVU0QnKSA/IGZpbmFsIDogKDEvZmluYWwpOwogICAgICAgICAgLy8gc2hvdyBpbiB0aGUgaW5wdXQgKHdpdGhvdXQgdHJpcHBpbmcgbWFudWFsIG92ZXJyaWRlKQogICAgICAgICAgY29uc3QgaW5wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWZ4LXVzZHBsbicpOwogICAgICAgICAgaWYgKGlucCkgaW5wLnZhbHVlID0gKE51bWJlcih2KXx8MCkudG9GaXhlZCg0KTsKICAgICAgICAgIC8vIHN0b3JlIGZvciBjb252ZW5pZW5jZSBpbiB0aGUgVUkgaW5wdXQgaGVscGVyCiAgICAgICAgICB0cnl7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdndF9meF91c2RfcGxuJywgU3RyaW5nKHYpKTsgfWNhdGNoKF8pe30KICAgICAgICB9CiAgICAgIH1jYXRjaChfKXt9CgogICAgICB0cnl7IHBhaW50RngoKTsgfWNhdGNoKF8pe30KICAgICAgcmV0dXJuIFNULkZYW2Zyb21dW3RvXTsKICAgIH0KCiAgICAvLyBGYWxsYmFjayB0byBwcmV2aW91cyBvciAxIGlmIGFsbCBmYWlsZWQKICAgIGlmIChOdW1iZXIuaXNGaW5pdGUoY2FjaGVkKSkgcmV0dXJuIGNhY2hlZDsKICAgIFNULkZYW2Zyb21dW3RvXSA9IDE7CiAgICB0cnl7IHBhaW50RngoKTsgfWNhdGNoKF8pe30KICAgIHJldHVybiAxOwogIH1jYXRjaChlKXsKICAgIGNvbnNvbGUud2FybignRlggZXJyb3InLCBlKTsKICAgIHJldHVybiAxOwogIH0KfQpmdW5jdGlvbiBwYWludEZ4KCl7CiAgICB0cnl7CiAgICAgIGNvbnN0IHBhcnRzID0gW107CiAgICAgIGZvcihjb25zdCBmIGluIFNULkZYKXsgZm9yKGNvbnN0IHQgaW4gU1QuRlhbZl0peyBwYXJ0cy5wdXNoKGAke2Z9LT4ke3R9OiR7Zm10TnVtKFNULkZYW2ZdW3RdKX1gKTsgfSB9CiAgICAgICQoJyNnby1meCcpLnRleHRDb250ZW50ID0gcGFydHMuam9pbignICB8ICAnKSB8fCAn4oCUJzsKICAgIH1jYXRjaChfKXt9CiAgfQoKICBhc3luYyBmdW5jdGlvbiBmZXRjaEFsbFF1b3Rlc0Nvb3AoKXsKICAgIGNvbnN0IHNldCA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IHBmcyA9IEFycmF5LmlzQXJyYXkoU1QuREIucG9ydGZvbGlvcykgPyBTVC5EQi5wb3J0Zm9saW9zIDogW107CiAgICBmb3IoY29uc3QgcGYgb2YgcGZzKXsgZm9yKGNvbnN0IHQgb2YgT2JqZWN0LmtleXMocGYuaG9sZGluZ3N8fHt9KSl7IHNldC5hZGQoU3RyaW5nKHQpLnRyaW0oKS50b1VwcGVyQ2FzZSgpKTsgfSB9CiAgICBjb25zdCB0aWNrZXJzID0gQXJyYXkuZnJvbShzZXQpOwogICAgY29uc3QgdG9rZW4gPSAoJCgnI2dvLXRva2VuJykudmFsdWUgfHwgU1QudG9rZW4gfHwgJycpLnRyaW0oKTsKICAgIGNvbnN0IG5vQXBpID0gJCgnI2dvLW5vLWFwaScpLmNoZWNrZWQgfHwgIXRva2VuOwoKICAgIC8vIGZldGNoIG9ubHkgc3RhbGUvbWlzc2luZzsgcmVzcGVjdCBxdWV1ZSwgZGVkdXAgd2l0aCBhcHAKICAgIGNvbnN0IHByb21pc2VzID0gdGlja2Vycy5tYXAoc3ltID0+IGZldGNoUXVvdGVDb29wKHN5bSwgdG9rZW4sIHsgbm9BcGksIHR0bE1zOiBTVC50dGxNcyB9KSk7CiAgICBjb25zdCBxdW90ZXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICAvLyBtYXAgdG8gb2JqZWN0IGZvciBsYXRlciByZWFkcwogICAgY29uc3Qgb2JqID0ge307CiAgICB0aWNrZXJzLmZvckVhY2goKHQsaSk9PnsgY29uc3QgcSA9IHF1b3Rlc1tpXXx8bnVsbDsgaWYocSkgb2JqW3RdPXE7IH0pOwogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIHJlYWxpemVkU3VtcyhwZiwgcmFuZ2UpewogICAgbGV0IGc9MCx0PTAsbj0wOwogICAgZm9yKGNvbnN0IHR4IG9mIChwZi50cmFuc2FjdGlvbnN8fFtdKSl7CiAgICAgIGlmKHR4LnR5cGU9PT0nc2VsbCcpewogICAgICAgIHRyeXsgY29uc3QgbXMgPSB0b01zKHR4ICYmIHR4LmRhdGUpOyBpZihyYW5nZSAmJiAhaW5SYW5nZU1zKG1zLCByYW5nZSkpIGNvbnRpbnVlOyB9Y2F0Y2goXyl7fQogICAgICAgIGNvbnN0IGdyb3NzID0gTnVtYmVyKHR4Lmdyb3NzUEwpfHwwOwogICAgICAgIGNvbnN0IHRheCAgID0gTnVtYmVyKHR4LnRheCl8fCAoZ3Jvc3M+MCA/IGdyb3NzKihTVC5EQi5zZXR0aW5ncz8udGF4UmF0ZXx8MC4xOSkgOiAwKTsKICAgICAgICBjb25zdCBuZXQgICA9IE51bWJlcih0eC5uZXRQTCl8fCAoZ3Jvc3MgLSB0YXgpOwogICAgICAgIGcrPWdyb3NzOyB0Kz10YXg7IG4rPW5ldDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHtncm9zczpnLCB0YXg6dCwgbmV0Om59OwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gY29tcHV0ZVBvcnRmb2xpbyhwZiwgUSwgcmFuZ2UpewogICAgY29uc3QgYmFzZSA9ICQoJyNnby1iYXNlJykudmFsdWUgfHwgU1QuYmFzZSB8fCAnUExOJzsKICAgIGNvbnN0IGZ4ID0gYXdhaXQgZW5zdXJlRngocGYuY3VycmVuY3l8fCdQTE4nLCBiYXNlKTsKICAgIGxldCBob2xkaW5ncz0wLCBjb3N0PTAsIGRheT0wOwogICAgY29uc3QgcG9zaXRpb25zPVtdOwogICAgZm9yKGNvbnN0IFt0aWNrZXIsYm9va10gb2YgT2JqZWN0LmVudHJpZXMocGYuaG9sZGluZ3N8fHt9KSl7CiAgICAgIGxldCBxdHk9MCxjc3Q9MCxhdmc9MDsKICAgICAgZm9yKGNvbnN0IGxvdCBvZiAoYm9vay5sb3RzfHxbXSkpeyBjb25zdCBxPU51bWJlcihsb3QucXR5KXx8MDsgY29uc3QgdWM9TnVtYmVyKGxvdC51bml0Q29zdCl8fDA7IHF0eSs9cTsgY3N0Kz1xKnVjOyB9CiAgICAgIGF2ZyA9IHF0eT4wP2NzdC9xdHk6MDsKICAgICAgY29uc3QgcWQgPSAoUSAmJiBRW3RpY2tlcl0pID8gUVt0aWNrZXJdIDogbnVsbDsKICAgICAgY29uc3QgcHJpY2UgPSBxZCAmJiBpc0Zpbml0ZShxZC5jKSA/IE51bWJlcihxZC5jKSA6IGF2ZzsKICAgICAgY29uc3QgdmFsID0gcXR5KnByaWNlOyBob2xkaW5ncys9dmFsOyBjb3N0Kz1jc3Q7CiAgICAgIGlmKHFkICYmIGlzRmluaXRlKHFkLmQpKSBkYXkgKz0gcXR5Kk51bWJlcihxZC5kKTsKICAgICAgcG9zaXRpb25zLnB1c2goe3RpY2tlciwgcXR5LCBhdmcsIGNvc3Q6Y3N0LCBwcmljZSwgdmFsdWU6dmFsLCBkOnFkPy5kPz9udWxsLCBkcDpxZD8uZHA/P251bGx9KTsKICAgIH0KICAgIGNvbnN0IGNhc2ggPSBOdW1iZXIocGYuY2FzaCl8fDA7CiAgICBjb25zdCB7Z3Jvc3MsIHRheCwgbmV0fSA9IHJlYWxpemVkU3VtcyhwZiwgcmFuZ2UpOwogICAgcmV0dXJuIHsKICAgICAgcGYsIGZ4LAogICAgICBjYXNoTmF0OiBjYXNoLCBjYXNoQmFzZTogY2FzaCpmeCwKICAgICAgaG9sZGluZ3NOYXQ6IGhvbGRpbmdzLCBob2xkaW5nc0Jhc2U6IGhvbGRpbmdzKmZ4LAogICAgICBlcXVpdHlOYXQ6IGNhc2graG9sZGluZ3MsIGVxdWl0eUJhc2U6KGNhc2graG9sZGluZ3MpKmZ4LAogICAgICBjb3N0TmF0OiBjb3N0LCBjb3N0QmFzZTogY29zdCpmeCwKICAgICAgdW5yZWFsTmF0OiBob2xkaW5ncy1jb3N0LCB1bnJlYWxCYXNlOihob2xkaW5ncy1jb3N0KSpmeCwKICAgICAgdW5yZWFsUGN0OiBjb3N0PjA/IChob2xkaW5ncy1jb3N0KS9jb3N0IDogbnVsbCwKICAgICAgZGF5TW92ZU5hdDogZGF5LCBkYXlNb3ZlQmFzZTogZGF5KmZ4LAogICAgICByZWFsaXplZEdyb3NzTmF0Omdyb3NzLCByZWFsaXplZFRheE5hdDp0YXgsIHJlYWxpemVkTmV0TmF0Om5ldCwKICAgICAgcmVhbGl6ZWRHcm9zc0Jhc2U6Z3Jvc3MqZngsIHJlYWxpemVkVGF4QmFzZTp0YXgqZngsIHJlYWxpemVkTmV0QmFzZTpuZXQqZngsCiAgICAgIHBvc2l0aW9ucwogICAgfTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVBbGwoUSwgcmFuZ2UpewogICAgY29uc3QgYmFzZSA9ICQoJyNnby1iYXNlJykudmFsdWUgfHwgJ1BMTic7CiAgICBjb25zdCBwZnMgPSBBcnJheS5pc0FycmF5KFNULkRCLnBvcnRmb2xpb3MpID8gU1QuREIucG9ydGZvbGlvcyA6IFtdOwogICAgY29uc3QgcmVzdWx0cz1bXTsKICAgIGxldCB0b3QgPSB7aG9sZGluZ3NCYXNlOjAsY2FzaEJhc2U6MCxlcXVpdHlCYXNlOjAsY29zdEJhc2U6MCx1bnJlYWxCYXNlOjAsZGF5TW92ZUJhc2U6MCxyZWFsaXplZEdyb3NzQmFzZTowLHJlYWxpemVkVGF4QmFzZTowLHJlYWxpemVkTmV0QmFzZTowfTsKICAgIGZvcihjb25zdCBwZiBvZiBwZnMpewogICAgICBjb25zdCByID0gYXdhaXQgY29tcHV0ZVBvcnRmb2xpbyhwZiwgUSwgcmFuZ2UpOwogICAgICByZXN1bHRzLnB1c2gocik7CiAgICAgIHRvdC5ob2xkaW5nc0Jhc2UrPXIuaG9sZGluZ3NCYXNlOyB0b3QuY2FzaEJhc2UrPXIuY2FzaEJhc2U7IHRvdC5lcXVpdHlCYXNlKz1yLmVxdWl0eUJhc2U7CiAgICAgIHRvdC5jb3N0QmFzZSs9ci5jb3N0QmFzZTsgdG90LnVucmVhbEJhc2UrPXIudW5yZWFsQmFzZTsgdG90LmRheU1vdmVCYXNlKz1yLmRheU1vdmVCYXNlOwogICAgICB0b3QucmVhbGl6ZWRHcm9zc0Jhc2UrPXIucmVhbGl6ZWRHcm9zc0Jhc2U7IHRvdC5yZWFsaXplZFRheEJhc2UrPXIucmVhbGl6ZWRUYXhCYXNlOyB0b3QucmVhbGl6ZWROZXRCYXNlKz1yLnJlYWxpemVkTmV0QmFzZTsKICAgIH0KICAgIGNvbnN0IHVucmVhbFBjdCA9IHRvdC5jb3N0QmFzZT4wID8gKHRvdC51bnJlYWxCYXNlL3RvdC5jb3N0QmFzZSkgOiBudWxsOwogICAgcmV0dXJuIHtiYXNlLCByZXN1bHRzLCB0b3QsIHVucmVhbFBjdH07CiAgfQoKICBmdW5jdGlvbiBwYWludFRvdGFscyh7YmFzZSwgdG90LCB1bnJlYWxQY3R9KXsKICAgICQoJyNnby10b3QtaG9sZCcpLnRleHRDb250ZW50ID0gZm10TW9uZXkodG90LmhvbGRpbmdzQmFzZSwgYmFzZSk7CiAgICAkKCcjZ28tdG90LWNhc2gnKS50ZXh0Q29udGVudCA9IGZtdE1vbmV5KHRvdC5jYXNoQmFzZSwgYmFzZSk7CiAgICAkKCcjZ28tdG90LWVxJykudGV4dENvbnRlbnQgPSBmbXRNb25leSh0b3QuZXF1aXR5QmFzZSwgYmFzZSk7CiAgICAkKCcjZ28tdG90LXVucicpLnRleHRDb250ZW50ID0gZm10TW9uZXkodG90LnVucmVhbEJhc2UsIGJhc2UpOwogICAgY29uc3QgcGN0ID0gJCgnI2dvLXRvdC11bnItcGN0Jyk7IHBjdC50ZXh0Q29udGVudCA9IHVucmVhbFBjdD09PW51bGw/J+KAlCc6KHVucmVhbFBjdCoxMDApLnRvRml4ZWQoMikrJyUnOwogICAgcGN0LmNsYXNzTmFtZSA9ICdnby1iYWRnZSAnICsgKHVucmVhbFBjdD4wPydnby1wb3MnOih1bnJlYWxQY3Q8MD8nZ28tbmVnJzonJykpOwogICAgJCgnI2dvLWRheScpLnRleHRDb250ZW50ID0gJ86UIGR6aWVubnk6ICcgKyBmbXRNb25leSh0b3QuZGF5TW92ZUJhc2UsIGJhc2UpOwogICAgJCgnI2dvLXJlYWwtZycpLnRleHRDb250ZW50ID0gZm10TW9uZXkodG90LnJlYWxpemVkR3Jvc3NCYXNlLCBiYXNlKTsKICAgICQoJyNnby1yZWFsLXRheCcpLnRleHRDb250ZW50ID0gZm10TW9uZXkodG90LnJlYWxpemVkVGF4QmFzZSwgYmFzZSk7CiAgICAkKCcjZ28tcmVhbC1uJykudGV4dENvbnRlbnQgPSBmbXRNb25leSh0b3QucmVhbGl6ZWROZXRCYXNlLCBiYXNlKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlclBvc2l0aW9uc1RhYmxlKHBvc2l0aW9ucywgY3VyKXsKICAgIGlmKCFwb3NpdGlvbnMgfHwgIXBvc2l0aW9ucy5sZW5ndGgpIHJldHVybiBgPGRpdiBjbGFzcz0iZ28tbXV0ZWQgZ28tbWluaSI+QnJhayBwb3p5Y2ppLjwvZGl2PmA7CiAgICBjb25zdCByb3dzID0gcG9zaXRpb25zLm1hcChwPT57CiAgICAgIGNvbnN0IHBsID0gKHAudmFsdWUgLSBwLmNvc3QpOwogICAgICBjb25zdCBkcCA9IGlzRmluaXRlKHAuZHApID8gYDxzcGFuIGNsYXNzPSJnby1iYWRnZSAke3AuZHA+PTA/J2dvLXBvcyc6J2dvLW5lZyd9Ij4ke051bWJlcihwLmRwKS50b0ZpeGVkKDIpfSU8L3NwYW4+YCA6ICfigJQnOwogICAgICBjb25zdCBwbENscyA9IHBsPjA/J2dvLXBvcyc6KHBsPDA/J2dvLW5lZyc6JycpOwogICAgICByZXR1cm4gYDx0cj4KICAgICAgICA8dGQgY2xhc3M9ImdvLXRpY2tlciI+JHtlc2NhcGVIdG1sKHAudGlja2VyKX08L3RkPgogICAgICAgIDx0ZD4ke051bWJlcihwLnF0eSkudG9GaXhlZCgyKX08L3RkPgogICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHAuYXZnLCBjdXIpfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkocC5jb3N0LCBjdXIpfTwvdGQ+CiAgICAgICAgPHRkPiR7aXNGaW5pdGUocC5wcmljZSk/TnVtYmVyKHAucHJpY2UpLnRvRml4ZWQoMik6J+KAlCd9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShwLnZhbHVlLCBjdXIpfTwvdGQ+CiAgICAgICAgPHRkIGNsYXNzPSIke3BsQ2xzfSI+JHtmbXRNb25leShwbCwgY3VyKX08L3RkPgogICAgICAgIDx0ZD4ke2lzRmluaXRlKHAuY29zdCkmJnAuY29zdD4wPygoKHAudmFsdWUtcC5jb3N0KS9wLmNvc3QpKjEwMCkudG9GaXhlZCgyKSsnJSc6J+KAlCd9PC90ZD4KICAgICAgICA8dGQ+JHtkcH08L3RkPgogICAgICA8L3RyPmA7CiAgICB9KS5qb2luKCcnKTsKICAgIHJldHVybiBgPGRpdiBjbGFzcz0idGFibGUtd3JhcCIgc3R5bGU9Im1hcmdpbi10b3A6OHB4Ij4KICAgICAgPHRhYmxlPgogICAgICAgIDx0aGVhZD48dHI+PHRoPlRpY2tlcjwvdGg+PHRoPklsb8WbxIc8L3RoPjx0aD7FmnIuIGtvc3p0PC90aD48dGg+S29zenQgd8WCYXNueTwvdGg+PHRoPkt1cnM8L3RoPjx0aD5XYXJ0b8WbxIc8L3RoPjx0aD5QL0w8L3RoPjx0aD4lPC90aD48dGg+zpQgZHppZW5ueTwvdGg+PC90cj48L3RoZWFkPgogICAgICAgIDx0Ym9keT4ke3Jvd3N9PC90Ym9keT4KICAgICAgPC90YWJsZT4KICAgIDwvZGl2PmA7CiAgfQogIGZ1bmN0aW9uIGVzY2FwZUh0bWwocyl7IGNvbnN0IHQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTsgdC50ZXh0Q29udGVudD1TdHJpbmcoc3x8JycpOyByZXR1cm4gdC5pbm5lckhUTUw7IH0KCiAgZnVuY3Rpb24gYnVpbGRBbGxQb3NpdGlvbnMocmVzTGlzdCl7CiAgICBjb25zdCByb3dzID0gW107CiAgICBmb3IgKGxldCBpPTA7aTxyZXNMaXN0Lmxlbmd0aDtpKyspeyBjb25zdCByID0gcmVzTGlzdFtpXTsKICAgICAgZm9yKGNvbnN0IHAgb2Ygci5wb3NpdGlvbnMpewogICAgICAgIHJvd3MucHVzaCh7IHRpY2tlcjogcC50aWNrZXIsIHBmOiByLnBmLm5hbWV8fCfigJQnLCBxdHk6IHAucXR5LCBhdmc6IHAuYXZnLCBjb3N0OiBwLmNvc3QsCiAgICAgICAgICBwcmljZTogaXNGaW5pdGUocC5wcmljZSk/cC5wcmljZTpudWxsLCB2YWx1ZTogcC52YWx1ZSwgcGw6IHAudmFsdWUtcC5jb3N0LAogICAgICAgICAgcGN0OiBwLmNvc3Q+MD8gKHAudmFsdWUtcC5jb3N0KS9wLmNvc3QgOiBudWxsLCBkcDogaXNGaW5pdGUocC5kcCk/cC5kcDpudWxsLCBjdXJyZW5jeTogci5wZi5jdXJyZW5jeXx8J1BMTicsIHBmSWR4OiBpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByb3dzOwogIH0KCiAgZnVuY3Rpb24gcGFpbnRQb3J0Zm9saW9zKHJlc0xpc3QsIGJhc2UpewogICAgY29uc3QgdGJvZHkgPSAkKCcjZ28tcGYtYm9keScpOyB0Ym9keS5pbm5lckhUTUw9Jyc7CiAgICBpZighcmVzTGlzdC5sZW5ndGgpeyB0Ym9keS5pbm5lckhUTUwgPSAnPHRyPjx0ZCBjb2xzcGFuPSIxMCIgY2xhc3M9ImdvLW11dGVkIj5CcmFrIGRhbnljaOKApjwvdGQ+PC90cj4nOyByZXR1cm47IH0KICAgIGZvcihjb25zdCByIG9mIHJlc0xpc3QpewogICAgICBjb25zdCB1bnJlYWxDbHMgPSByLnVucmVhbEJhc2U+MCA/ICdnby1wb3MnIDogKHIudW5yZWFsQmFzZTwwID8gJ2dvLW5lZycgOiAnJyk7CiAgICAgIGNvbnN0IHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKTsKICAgICAgdHIuaW5uZXJIVE1MID0gYAogICAgICAgIDx0ZD48ZGV0YWlscz48c3VtbWFyeT4ke2VzY2FwZUh0bWwoci5wZi5uYW1lfHwn4oCUJyl9PC9zdW1tYXJ5PiR7cmVuZGVyUG9zaXRpb25zVGFibGUoci5wb3NpdGlvbnMsIHIucGYuY3VycmVuY3kpfTwvZGV0YWlscz48L3RkPgogICAgICAgIDx0ZD4ke3IucGYuY3VycmVuY3l8fCdQTE4nfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkoci5jYXNoTmF0LCByLnBmLmN1cnJlbmN5KX08L3RkPgogICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHIuaG9sZGluZ3NOYXQsIHIucGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkPjxiPiR7Zm10TW9uZXkoci5lcXVpdHlOYXQsIHIucGYuY3VycmVuY3kpfTwvYj48L3RkPgogICAgICAgIDx0ZD4ke2ZtdE1vbmV5KHIuZXF1aXR5QmFzZSwgYmFzZSl9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShyLmNvc3ROYXQsIHIucGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkIGNsYXNzPSIke3VucmVhbENsc30iPiR7Zm10TW9uZXkoci51bnJlYWxOYXQsIHIucGYuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkPiR7ci51bnJlYWxQY3Q9PT1udWxsPyfigJQnOihyLnVucmVhbFBjdCoxMDApLnRvRml4ZWQoMikrJyUnfTwvdGQ+CiAgICAgICAgPHRkPiR7Zm10TW9uZXkoci5yZWFsaXplZE5ldE5hdCwgci5wZi5jdXJyZW5jeSl9PC90ZD4KICAgICAgYDsKICAgICAgdGJvZHkuYXBwZW5kQ2hpbGQodHIpOwogICAgfQogIH0KCiAgCiAgLy8gPT09IEV4cGFuZGFibGUgZGV0YWlscyBmb3IgYWdncmVnYXRlZCBwb3NpdGlvbnMgPT09CiAgZnVuY3Rpb24gcmVuZGVyVGlja2VyRGV0YWlscyhwZiwgdGlja2VyKXsKICAgIHRyeXsKICAgICAgZnVuY3Rpb24gcmVhZExhc3RQcmljZSh0KXsKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCBrZXkgPSBTdHJpbmcodHx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICBjb25zdCBmcm9tQ2FjaGUgPSAod2luZG93Ll9fR1RfUVVPVEVfQ0FDSEUgJiYgd2luZG93Ll9fR1RfUVVPVEVfQ0FDSEUuZ2V0KSA/IHdpbmRvdy5fX0dUX1FVT1RFX0NBQ0hFLmdldChrZXkpIDogbnVsbDsKICAgICAgICAgIGNvbnN0IHEgPSBmcm9tQ2FjaGUgJiYgZnJvbUNhY2hlLnEgPyBmcm9tQ2FjaGUucSA6IG51bGw7CiAgICAgICAgICBpZihxICYmIGlzRmluaXRlKHEuYykpIHJldHVybiBOdW1iZXIocS5jKTsKICAgICAgICB9Y2F0Y2goXyl7fQogICAgICAgIHRyeXsKICAgICAgICAgIGNvbnN0IEsgPSBTdHJpbmcodHx8JycpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICBjb25zdCBxMiA9ICh3aW5kb3cuUVVPVEVTICYmIHdpbmRvdy5RVU9URVNbS10pID8gd2luZG93LlFVT1RFU1tLXSA6IG51bGw7CiAgICAgICAgICBpZihxMiAmJiBpc0Zpbml0ZShxMi5wcmljZSkpIHJldHVybiBOdW1iZXIocTIucHJpY2UpOwogICAgICAgIH1jYXRjaChfKXt9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgYm9vayA9IChwZiAmJiBwZi5ob2xkaW5ncyAmJiBwZi5ob2xkaW5nc1t0aWNrZXJdKSA/IHBmLmhvbGRpbmdzW3RpY2tlcl0gOiBudWxsOwogICAgICBjb25zdCBsb3RzID0gQXJyYXkuaXNBcnJheShib29rICYmIGJvb2subG90cykgPyBib29rLmxvdHMgOiBbXTsKICAgICAgY29uc3QgY3VyID0gcGYuY3VycmVuY3kgfHwgJ1BMTic7CiAgICAgIGNvbnN0IGxhc3QgPSByZWFkTGFzdFByaWNlKHRpY2tlcik7CiAgICBjb25zdCByb3dzID0gbG90cy5tYXAobD0+ewogICAgICAgIGNvbnN0IHF0eSA9IE51bWJlcihsLnF0eSl8fDA7CiAgICAgICAgY29uc3QgdWMgID0gTnVtYmVyKGwudW5pdENvc3QpfHwwOwogICAgICAgIGNvbnN0IGNvc3QgPSBxdHkqdWM7CiAgICAgICAgY29uc3QgcHJpY2UgPSAobGFzdCE9bnVsbCAmJiBpc0Zpbml0ZShsYXN0KSkgPyBOdW1iZXIobGFzdCkgOiB1YzsKICAgICAgICBjb25zdCB2YWwgPSBxdHkqcHJpY2U7CiAgICAgICAgY29uc3QgcGwgPSB2YWwgLSBjb3N0OwogICAgICAgIGNvbnN0IHBjdCA9IGNvc3Q+MCA/IChwbC9jb3N0KSoxMDAgOiBudWxsOwogICAgICAgIGNvbnN0IGRhdGUgPSBsLmRhdGUgfHwgJyc7CiAgICAgICAgY29uc3Qgbm90ZSA9IGwubm90ZSA/IFN0cmluZyhsLm5vdGUpIDogJyc7CiAgICAgICAgcmV0dXJuIGA8dHI+CiAgICAgICAgICA8dGQ+JHtlc2NhcGVIdG1sKGRhdGUpfTwvdGQ+CiAgICAgICAgICA8dGQ+JHtxdHkudG9GaXhlZCgyKX08L3RkPgogICAgICAgICAgPHRkPiR7Zm10TW9uZXkodWMsIGN1cil9PC90ZD4KICAgICAgICAgIDx0ZD4ke2ZtdE1vbmV5KGNvc3QsIGN1cil9PC90ZD4KICAgICAgICAgIDx0ZD4ke2lzRmluaXRlKHByaWNlKT9wcmljZS50b0ZpeGVkKDIpOifigJQnfTwvdGQ+CiAgICAgICAgICA8dGQ+JHtmbXRNb25leSh2YWwsIGN1cil9PC90ZD4KICAgICAgICAgIDx0ZCBjbGFzcz0iJHtwbD4wPydnby1wb3MnOihwbDwwPydnby1uZWcnOicnKX0iPiR7Zm10TW9uZXkocGwsIGN1cil9PC90ZD4KICAgICAgICAgIDx0ZD4ke3BjdD09PW51bGw/J+KAlCc6cGN0LnRvRml4ZWQoMikrJyUnfTwvdGQ+CiAgICAgICAgICA8dGQgY2xhc3M9ImdvLW1pbmkiPiR7ZXNjYXBlSHRtbChub3RlKX08L3RkPgogICAgICAgIDwvdHI+YDsKICAgICAgfSkuam9pbignJykgfHwgYDx0cj48dGQgY29sc3Bhbj0iOSIgY2xhc3M9ImdvLW1pbmkgZ28tbXV0ZWQgY2VudGVyIj5CcmFrIHRyYW5zYWtjamkvcGFydGlpIGRsYSAke2VzY2FwZUh0bWwodGlja2VyKX08L3RkPjwvdHI+YDsKCiAgICAgIHJldHVybiBgCiAgICAgIDxkaXYgY2xhc3M9InRhYmxlLXdyYXAiPgogICAgICAgIDx0YWJsZT4KICAgICAgICAgIDx0aGVhZD4KICAgICAgICAgICAgPHRyPjx0aD5EYXRhPC90aD48dGg+SWxvxZvEhzwvdGg+PHRoPkNlbmEgemFrdXB1PC90aD48dGg+S29zenQ8L3RoPjx0aD5LdXJzPC90aD48dGg+V2FydG/Fm8SHPC90aD48dGg+VW5yZWFsLiBQL0w8L3RoPjx0aD4lPC90aD48dGg+Tm90YXRrYTwvdGg+PC90cj4KICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHk+JHtyb3dzfTwvdGJvZHk+CiAgICAgICAgPC90YWJsZT4KICAgICAgPC9kaXY+YDsKICAgIH1jYXRjaChlKXsKICAgICAgY29uc29sZS53YXJuKCdyZW5kZXJUaWNrZXJEZXRhaWxzIGVycm9yJywgZSk7CiAgICAgIHJldHVybiBgPGRpdiBjbGFzcz0iZ28tbWluaSBnby1tdXRlZCI+QsWCxIVkIGdlbmVyb3dhbmlhIHN6Y3plZ8OzxYLDs3cuPC9kaXY+YDsKICAgIH0KICB9CmZ1bmN0aW9uIHBhaW50UG9zaXRpb25zKHJlc0xpc3QpewogICAgY29uc3QgdGJvZHkgPSAkKCcjZ28tcG9zLWJvZHknKTsKICAgIGNvbnN0IGZpbHRlciA9ICgkKCcjZ28tZmlsdGVyJykudmFsdWV8fCcnKS50cmltKCkudG9VcHBlckNhc2UoKTsKICAgIGNvbnN0IHJvd3MgPSBidWlsZEFsbFBvc2l0aW9ucyhyZXNMaXN0KS5maWx0ZXIocj0+ewogICAgICBpZighZmlsdGVyKSByZXR1cm4gdHJ1ZTsKICAgICAgY29uc3Qgd2FudEdhaW4gPSBmaWx0ZXIuaW5jbHVkZXMoJ1pZU0s+MCcpOwogICAgICBjb25zdCB3YW50TG9zcyA9IGZpbHRlci5pbmNsdWRlcygnU1RSQVRBPjAnKTsKICAgICAgY29uc3QgcGZRdWVyeSA9IC9QRjooW14gLF0rKS8uZXhlYyhmaWx0ZXIpOwogICAgICBjb25zdCBoYXNUaWNrZXIgPSByLnRpY2tlci50b1VwcGVyQ2FzZSgpLmluY2x1ZGVzKGZpbHRlcikgfHwgci5wZi50b1VwcGVyQ2FzZSgpLmluY2x1ZGVzKGZpbHRlcik7CiAgICAgIGNvbnN0IHBmTWF0Y2ggPSBwZlF1ZXJ5ID8gci5wZi50b1VwcGVyQ2FzZSgpLmluY2x1ZGVzKHBmUXVlcnlbMV0udG9VcHBlckNhc2UoKSkgOiB0cnVlOwogICAgICBjb25zdCBieUdhaW4gPSB3YW50R2FpbiA/IChyLnBsPjApIDogdHJ1ZTsKICAgICAgY29uc3QgYnlMb3NzID0gd2FudExvc3MgPyAoci5wbDwwKSA6IHRydWU7CiAgICAgIHJldHVybiAoaGFzVGlja2VyIHx8IHBmTWF0Y2gpICYmIGJ5R2FpbiAmJiBieUxvc3M7CiAgICB9KTsKCiAgICB0Ym9keS5pbm5lckhUTUw9Jyc7CiAgICBpZighcm93cy5sZW5ndGgpeyB0Ym9keS5pbm5lckhUTUw9Jzx0cj48dGQgY29sc3Bhbj0iMTAiIGNsYXNzPSJnby1tdXRlZCI+QnJhayBwb3p5Y2pp4oCmPC90ZD48L3RyPic7IHJldHVybjsgfQogICAgZm9yKGNvbnN0IHIgb2Ygcm93cyl7CiAgICAgIGNvbnN0IHBsQ2xzID0gci5wbD4wPydnby1wb3MnOihyLnBsPDA/J2dvLW5lZyc6JycpOwogICAgICBjb25zdCBkcCA9IHIuZHA9PT1udWxsID8gJ+KAlCcgOiBgPHNwYW4gY2xhc3M9ImdvLWJhZGdlICR7ci5kcD49MD8nZ28tcG9zJzonZ28tbmVnJ30iPiR7TnVtYmVyKHIuZHApLnRvRml4ZWQoMil9JTwvc3Bhbj5gOwogICAgICBjb25zdCB0ciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7CiAgICAgIHRyLmlubmVySFRNTCA9IGAKICAgICAgICA8dGQgY2xhc3M9ImdvLXRpY2tlciI+JHtlc2NhcGVIdG1sKHIudGlja2VyKX08L3RkPgogICAgICAgIDx0ZD4ke2VzY2FwZUh0bWwoci5wZil9PC90ZD4KICAgICAgICA8dGQ+JHtOdW1iZXIoci5xdHkpLnRvRml4ZWQoMil9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShyLmF2Zywgci5jdXJyZW5jeSl9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShyLmNvc3QsIHIuY3VycmVuY3kpfTwvdGQ+CiAgICAgICAgPHRkPiR7ci5wcmljZT09PW51bGw/J+KAlCc6TnVtYmVyKHIucHJpY2UpLnRvRml4ZWQoMil9PC90ZD4KICAgICAgICA8dGQ+JHtmbXRNb25leShyLnZhbHVlLCByLmN1cnJlbmN5KX08L3RkPgogICAgICAgIDx0ZCBjbGFzcz0iJHtwbENsc30iPiR7Zm10TW9uZXkoci5wbCwgci5jdXJyZW5jeSl9PC90ZD4KICAgICAgICA8dGQ+JHtyLnBjdD09PW51bGw/J+KAlCc6KHIucGN0KjEwMCkudG9GaXhlZCgyKSsnJSd9PC90ZD4KICAgICAgICA8dGQ+JHtkcH08L3RkPgogICAgICBgOwogICAgICB0Ym9keS5hcHBlbmRDaGlsZCh0cik7CiAgICAKICAgICAgLy8gYXR0YWNoIGV4cGFuZC1vbi1jbGljayBmb3IgZGV0YWlscwogICAgICB0ci5kYXRhc2V0LnRpY2tlciA9IHIudGlja2VyOwogICAgICB0ci5kYXRhc2V0LnBmSWR4ID0gU3RyaW5nKHIucGZJZHggPz8gLTEpOwogICAgICB0ci5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7CiAgICAgIHRyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oZXYpewogICAgICAgIGlmKGV2LnRhcmdldCAmJiAoZXYudGFyZ2V0LmNsb3Nlc3QoJ2J1dHRvbicpIHx8IGV2LnRhcmdldC5jbG9zZXN0KCdhJykpKSByZXR1cm47CiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0ci5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICAgICAgaWYoZXhpc3RpbmcgJiYgZXhpc3RpbmcuY2xhc3NMaXN0LmNvbnRhaW5zKCdnby1kZXRhaWwtcm93JykpewogICAgICAgICAgZXhpc3RpbmcucmVtb3ZlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlkeCA9IE51bWJlcih0ci5kYXRhc2V0LnBmSWR4KTsKICAgICAgICBjb25zdCB0aWNrZXIgPSB0ci5kYXRhc2V0LnRpY2tlcjsKICAgICAgICBjb25zdCBwZiA9IChyZXNMaXN0ICYmIGlkeD49MCAmJiByZXNMaXN0W2lkeF0pID8gcmVzTGlzdFtpZHhdLnBmIDogbnVsbDsKICAgICAgICBjb25zdCBkZXRhaWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOwogICAgICAgIGRldGFpbC5jbGFzc05hbWUgPSAnZ28tZGV0YWlsLXJvdyc7CiAgICAgICAgY29uc3QgY29sU3BhbiA9IHRyLmNoaWxkcmVuLmxlbmd0aDsKICAgICAgICBkZXRhaWwuaW5uZXJIVE1MID0gYDx0ZCBjb2xzcGFuPSIke2NvbFNwYW59IiBzdHlsZT0iYmFja2dyb3VuZDpyZ2JhKDE0OCwxNjMsMTg0LC4wOCk7cGFkZGluZzo4cHggMTJweDtib3JkZXItdG9wOjFweCBkYXNoZWQgIzMzNDE1NSI+CiAgICAgICAgICAke3JlbmRlclRpY2tlckRldGFpbHMocGYsIHRpY2tlcil9CiAgICAgICAgPC90ZD5gOwogICAgICAgIHRyLmFmdGVyKGRldGFpbCk7CiAgICAgIH0pOwogICAgfQogICAgCiAgfQoKCiAgCiAgLyogPT09IFtHTyBFeHRyYSBTdGF0c10gYXZnIGhvbGRpbmcgdGltZSAmIGF2ZyAlIHByb2ZpdCBwZXIgcG9zaXRpb24gKGNsb3NlZCB0cmFkZXMpIOKAlCBST0JVU1QgKHJlcGxheSkgPT09ICovCiAgZnVuY3Rpb24gY29tcHV0ZUNsb3NlZFRyYWRlU3RhdHMocmFuZ2UpewogIHRyeXsgU1QudHBDb3VudCA9IDA7IH1jYXRjaChfKXt9CiAgICB0cnl7CiAgICAgIC8vIFByZWZlciBhcHAgY29udGV4dCBTVC5EQiAodXNlZCB3IEdsb2JhbCBPdmVydmlldyksIGZhbGxiYWNrIHRvIERCL3dpbmRvdy5EQgogICAgICBjb25zdCBEQmN0eCA9ICh0eXBlb2YgU1QhPT0ndW5kZWZpbmVkJyAmJiBTVCAmJiBTVC5EQikgPyBTVC5EQgogICAgICAgICAgICAgICAgICA6ICgodHlwZW9mIERCIT09J3VuZGVmaW5lZCcgJiYgREIpID8gREIgOiAod2luZG93LkRCfHx7fSkpOwogICAgICBjb25zdCBwb3J0Zm9saW9zID0gQXJyYXkuaXNBcnJheShEQmN0eC5wb3J0Zm9saW9zKSA/IERCY3R4LnBvcnRmb2xpb3MgOiBbXTsKICAgICAgbGV0IHNhbXBsZXMgPSAwLCBzdW1EYXlzID0gMCwgc3VtUGN0ID0gMDsgbGV0IHRwQ291bnRUeCA9IDA7Ly8gSGVscGVyIHRvIHBhcnNlIGRhdGUgc2FmZWx5CiAgICAgIGNvbnN0IHRvTXMgPSAoZCk9PnsKICAgICAgICB0cnl7CiAgICAgICAgICBpZighZCkgcmV0dXJuIE5hTjsKICAgICAgICAgIC8vIEFjY2VwdCBJU08gc3RyaW5nIG9yIERhdGUgb2JqZWN0IG9yIEZpcmVzdG9yZSB0aW1lc3RhbXAtbGlrZSB7c2Vjb25kc30KICAgICAgICAgIGlmIChkIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIGQuZ2V0VGltZSgpOwogICAgICAgICAgaWYgKHR5cGVvZiBkID09PSAnb2JqZWN0JyAmJiBkICE9PSBudWxsICYmIE51bWJlci5pc0Zpbml0ZShkLnNlY29uZHMpKSByZXR1cm4gZC5zZWNvbmRzKjEwMDA7CiAgICAgICAgICBjb25zdCBtcyA9IERhdGUucGFyc2UoZCk7CiAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG1zKSA/IG1zIDogTmFOOwogICAgICAgIH1jYXRjaChfKXsgcmV0dXJuIE5hTjsgfQogICAgICB9OwoKICAgICAgLy8gSXRlcmF0ZSBlYWNoIHBvcnRmb2xpbyBpbmRlcGVuZGVudGx5CiAgICAgIGZvcihjb25zdCBwZiBvZiBwb3J0Zm9saW9zKXsKICAgICAgICBpZighcGYpIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IHR4cyA9IEFycmF5LmlzQXJyYXkocGYudHJhbnNhY3Rpb25zKSA/IHBmLnRyYW5zYWN0aW9ucy5zbGljZSgpIDogW107CiAgICAgICAgLy8gQ0hST05PTE9HSUNBTCAob2xkZXN0IC0+IG5ld2VzdCkKICAgICAgICBjb25zdCBjaHJvbm8gPSB0eHMucmV2ZXJzZSgpOwoKICAgICAgICAvLyBNaW5pbWFsIGluLW1lbW9yeSBob2xkaW5ncyBib29rIHBlciB0aWNrZXI6IEZJRk8gcXVldWUgb2YgbG90cyB7bG90SWQsIGRhdGVNcywgdW5pdENvc3QsIHF0eX0KICAgICAgICBjb25zdCBib29rID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICAgICAgLy8gUHJlLWluZGV4IGJ1eSBpbmZvIGJ5IGxvdElkIGZvciBmYXN0IGxvb2t1cCB3aGVuIGxvdExpbmtzIGV4aXN0CiAgICAgICAgY29uc3QgYnV5SWR4ID0gbmV3IE1hcCgpOwoKICAgICAgICBjb25zdCBwdXNoTG90ID0gKHRpY2tlciwgbG90SWQsIGRhdGVWYWwsIHVuaXRDb3N0LCBxdHkpPT57CiAgICAgICAgICBjb25zdCBkYXRlTXMgPSB0b01zKGRhdGVWYWwpOwogICAgICAgICAgaWYoIU51bWJlci5pc0Zpbml0ZShkYXRlTXMpIHx8ICFOdW1iZXIuaXNGaW5pdGUodW5pdENvc3QpIHx8IHVuaXRDb3N0PD0wIHx8ICFOdW1iZXIuaXNGaW5pdGUocXR5KSB8fCBxdHk8PTApIHJldHVybjsKICAgICAgICAgIGNvbnN0IHQgPSAodGlja2VyfHwnJykudHJpbSgpLnRvVXBwZXJDYXNlKCk7IGlmKCF0KSByZXR1cm47CiAgICAgICAgICAoYm9va1t0XSB8fD0gW10pLnB1c2goe2xvdElkLCBkYXRlTXMsIHVuaXRDb3N0LCBxdHl9KTsKICAgICAgICAgIGJ1eUlkeC5zZXQobG90SWQsIHtkYXRlTXMsIHVuaXRDb3N0fSk7IC8vIGFsc28gaW5kZXgKICAgICAgICB9OwoKICAgICAgICBmb3IoY29uc3QgdHggb2YgY2hyb25vKXsKICAgICAgICAgIGlmKCF0eCB8fCAhdHgudHlwZSkgY29udGludWU7CiAgICAgICAgICBjb25zdCB0ID0gdHgudHlwZTsKICAgICAgICAgIGlmKHQ9PT0nYnV5Jyl7CiAgICAgICAgICAgIGNvbnN0IHF0eSAgPSBOdW1iZXIodHgucXR5KXx8MDsKICAgICAgICAgICAgY29uc3QgcHJpY2U9IE51bWJlcih0eC5wcmljZSl8fDA7CiAgICAgICAgICAgIGNvbnN0IGZlZXMgPSBOdW1iZXIodHguZmVlcyl8fDA7CiAgICAgICAgICAgIGNvbnN0IGxvdElkPSB0eC5sb3RJZCB8fCAodHguaWQgPyBgbG90XyR7dHguaWR9YCA6IG51bGwpOwogICAgICAgICAgICBjb25zdCB1bml0Q29zdCA9IHF0eT4wID8gKHByaWNlICsgZmVlcy9NYXRoLm1heChxdHksMSkpIDogcHJpY2U7CiAgICAgICAgICAgIHB1c2hMb3QodHgudGlja2VyLCBsb3RJZCwgdHguZGF0ZSwgdW5pdENvc3QsIHF0eSk7CiAgICAgICAgICB9ZWxzZSBpZih0PT09J3RyYW5zZmVyX2NvbXBhbnlfaW4nKXsKICAgICAgICAgICAgY29uc3QgcXR5ICA9IE51bWJlcih0eC5xdHkpfHwwOwogICAgICAgICAgICBjb25zdCBsb3RJZD0gdHgubmV3TG90SWQgfHwgdHgubG90SWQgfHwgKHR4LmlkID8gYGxvdF8ke3R4LmlkfWAgOiBudWxsKTsKICAgICAgICAgICAgY29uc3QgdW5pdENvc3QgPSBOdW1iZXIodHgudW5pdENvc3QgPz8gdHgucHJpY2UgPz8gMCk7CiAgICAgICAgICAgIHB1c2hMb3QodHgudGlja2VyLCBsb3RJZCwgdHguZGF0ZSwgdW5pdENvc3QsIHF0eSk7CiAgICAgICAgICB9ZWxzZSBpZih0PT09J3NlbGwnKXsKICAgICAgICAgICAgLy8gQ291bnQgVFAgYXMgMSBwZXIgU0VMTCB0cmFuc2FjdGlvbiAod2l0aGluIHNlbGVjdGVkIHBlcmlvZCkKICAgICAgICAgICAgdHJ5eyBpZihpblJhbmdlTXModG9Ncyh0eC5kYXRlKSwgcmFuZ2UpKSB0cENvdW50VHgrKzsgfWNhdGNoKF8pey8qbm9vcCovfQoKICAgICAgICAgICAgLy8gQ291bnQgVFAgYXMgMSBwZXIgU0VMTCB0cmFuc2FjdGlvbiAod2l0aGluIHNlbGVjdGVkIHBlcmlvZCkKICAgICAgICAgICAgdHJ5eyBpZihpblJhbmdlTXModG9Ncyh0eC5kYXRlKSwgcmFuZ2UpKSB0cENvdW50VHgrKzsgfWNhdGNoKF8pey8qbm9vcCovfQoKICAgICAgICAgICAgY29uc3QgdGlja2VyID0gKHR4LnRpY2tlcnx8JycpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBzZWxsRGF0ZU1zID0gdG9Ncyh0eC5kYXRlKTsKICAgICAgICAgICAgY29uc3Qgc2VsbFByaWNlICA9IE51bWJlcih0eC5wcmljZSA/PyB0eC5zZWxsUHJpY2UgPz8gMCk7CiAgICAgICAgICAgIGxldCByZW1haW5pbmdRdHkgPSBOdW1iZXIodHgucXR5KXx8MDsKICAgICAgICAgICAgaWYoIXRpY2tlciB8fCAhTnVtYmVyLmlzRmluaXRlKHNlbGxEYXRlTXMpIHx8ICFOdW1iZXIuaXNGaW5pdGUoc2VsbFByaWNlKSB8fCBzZWxsUHJpY2U8PTApIGNvbnRpbnVlOwoKICAgICAgICAgICAgLy8gMSkgUHJlZmVyIHByZWNpc2UgYWxsb2NhdGlvbnMgaWYgdGhleSBleGlzdAogICAgICAgICAgICBjb25zdCBsaW5rcyA9IEFycmF5LmlzQXJyYXkodHgubG90TGlua3MpID8gdHgubG90TGlua3MgOiBbXTsKICAgICAgICAgICAgaWYobGlua3MubGVuZ3RoPjApewogICAgICAgICAgICAgIGZvcihjb25zdCBsaW5rIG9mIGxpbmtzKXsKICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSBsaW5rID8gYnV5SWR4LmdldChsaW5rLmxvdElkKSA6IG51bGw7CiAgICAgICAgICAgICAgICBpZighaW5mbyB8fCAhTnVtYmVyLmlzRmluaXRlKGluZm8uZGF0ZU1zKSB8fCAhTnVtYmVyLmlzRmluaXRlKGluZm8udW5pdENvc3QpIHx8IGluZm8udW5pdENvc3Q8PTApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgZGF5cyA9IE1hdGgubWF4KDAsIChzZWxsRGF0ZU1zIC0gaW5mby5kYXRlTXMpLzg2NDAwMDAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBjdCAgPSAoKHNlbGxQcmljZSAtIGluZm8udW5pdENvc3QpL2luZm8udW5pdENvc3QpKjEwMDsKICAgICAgICAgICAgICAgIGlmKCFpblJhbmdlTXMoc2VsbERhdGVNcyA/PyB0b01zKHR4LmRhdGUpLCByYW5nZSkpIHsgLyogc2tpcCBvdXQtb2YtcmFuZ2UgKi8gfSBlbHNlIHsgc3VtRGF5cyArPSBkYXlzOyBzdW1QY3QgKz0gcGN0OyBzYW1wbGVzICs9IDE7ICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOyAvLyBkb25lIHdpdGggdGhpcyBzZWxsCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIDIpIEZhbGxiYWNrOiByZWNvbnN0cnVjdCBGSUZPIGZyb20gY3VycmVudCBib29rCiAgICAgICAgICAgIGNvbnN0IHFsb3RzID0gYm9va1t0aWNrZXJdIHx8IFtdOwogICAgICAgICAgICBsZXQgbmVlZCA9IE1hdGgubWF4KDAsIHJlbWFpbmluZ1F0eSk7CiAgICAgICAgICAgIGxldCBpID0gMDsKICAgICAgICAgICAgd2hpbGUobmVlZD4wICYmIGk8cWxvdHMubGVuZ3RoKXsKICAgICAgICAgICAgICBjb25zdCBsb3QgPSBxbG90c1tpXTsKICAgICAgICAgICAgICBjb25zdCB0YWtlID0gTWF0aC5taW4obmVlZCwgbG90LnF0eSk7CiAgICAgICAgICAgICAgaWYodGFrZT4wICYmIE51bWJlci5pc0Zpbml0ZShsb3QuZGF0ZU1zKSAmJiBOdW1iZXIuaXNGaW5pdGUobG90LnVuaXRDb3N0KSAmJiBsb3QudW5pdENvc3Q+MCl7CiAgICAgICAgICAgICAgICBjb25zdCBkYXlzID0gTWF0aC5tYXgoMCwgKHNlbGxEYXRlTXMgLSBsb3QuZGF0ZU1zKS84NjQwMDAwMCk7CiAgICAgICAgICAgICAgICBjb25zdCBwY3QgID0gKChzZWxsUHJpY2UgLSBsb3QudW5pdENvc3QpL2xvdC51bml0Q29zdCkqMTAwOwogICAgICAgICAgICAgICAgaWYoIWluUmFuZ2VNcyhzZWxsRGF0ZU1zID8/IHRvTXModHguZGF0ZSksIHJhbmdlKSkgeyAvKiBza2lwIG91dC1vZi1yYW5nZSAqLyB9IGVsc2UgeyBzdW1EYXlzICs9IGRheXM7IHN1bVBjdCArPSBwY3Q7IHNhbXBsZXMgKz0gMTsgIH0KICAgICAgICAgICAgICAgIGxvdC5xdHkgLT0gdGFrZTsKICAgICAgICAgICAgICAgIG5lZWQgLT0gdGFrZTsKICAgICAgICAgICAgICAgIGlmKGxvdC5xdHk8PTApeyBpKys7IH0KICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGkrKzsgLy8gc2tpcCBicm9rZW4gbG90CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFJlbW92ZSBkZXBsZXRlZCBsb3RzCiAgICAgICAgICAgIGlmKGk+MCkgYm9va1t0aWNrZXJdID0gcWxvdHMuc2xpY2UoaSkuZmlsdGVyKEw9PkwucXR5PjApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHsgYXZnRGF5czogc2FtcGxlcyA/IChzdW1EYXlzL3NhbXBsZXMpIDogbnVsbCwgYXZnUGN0OiBzYW1wbGVzID8gKHN1bVBjdC9zYW1wbGVzKSA6IG51bGwsIHNhbXBsZXMsIHRwQ291bnRUeCB9OwogICAgfWNhdGNoKGUpewogICAgICBjb25zb2xlLndhcm4oJ1tHT10gY29tcHV0ZUNsb3NlZFRyYWRlU3RhdHMgKHJvYnVzdCkgZmFpbGVkJywgZSk7CiAgICAgIHJldHVybiB7IGF2Z0RheXM6IG51bGwsIGF2Z1BjdDogbnVsbCwgc2FtcGxlczogMCwgdHBDb3VudFR4OiAwIH07CiAgICB9CiAgfQogIGZ1bmN0aW9uIHBhaW50RXh0cmFTdGF0cyhzdGF0cyl7CiAgICB0cnl7CiAgICAgIGNvbnN0IGVsSCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1hdmctaG9sZCcpOwogICAgICBjb25zdCBlbFAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tYXZnLXBjdCcpOwogICAgICBpZihlbEgpeyBlbEgudGV4dENvbnRlbnQgPSAoc3RhdHMgJiYgTnVtYmVyLmlzRmluaXRlKHN0YXRzLmF2Z0RheXMpKSA/IChOdW1iZXIoc3RhdHMuYXZnRGF5cykudG9GaXhlZCgxKSsnIGQnKSA6ICfigJQnOyB9CiAgICAgIGlmKGVsUCl7IGVsUC50ZXh0Q29udGVudCA9IChzdGF0cyAmJiBOdW1iZXIuaXNGaW5pdGUoc3RhdHMuYXZnUGN0KSkgID8gKE51bWJlcihzdGF0cy5hdmdQY3QpLnRvRml4ZWQoMikrJyUnKSA6ICfigJQnOyB9CiAgICAgIGlmKHN0YXRzICYmIHN0YXRzLnNhbXBsZXM9PT0wKXsKICAgICAgICBpZihlbEgpIGVsSC50aXRsZSA9ICdCcmFrIHphbWtuacSZdHljaCB0cmFuc2FrY2ppIGRvIHd5bGljemVuaWEgbHViIGJyYWsgZG9wYXNvd2HFhCc7CiAgICAgICAgaWYoZWxQKSBlbFAudGl0bGUgPSAnQnJhayB6YW1rbmnEmXR5Y2ggdHJhbnNha2NqaSBkbyB3eWxpY3plbmlhIGx1YiBicmFrIGRvcGFzb3dhxYQnOwogICAgICB9CiAgICB9Y2F0Y2goXyl7fQogIH0KICAvLyBGYWxsYmFjay9yb2J1c3QgVFAgY291bnRlcjogY291bnRzIFNFTEwgdHJhbnNhY3Rpb25zIHdpdGhpbiByYW5nZSBkaXJlY3RseSBmcm9tIERCCiAgZnVuY3Rpb24gY291bnRTZWxsVHhJblJhbmdlKERCY3R4LCByYW5nZSl7CiAgICB0cnl7CiAgICAgIGNvbnN0IGRiID0gREJjdHggfHwgKHdpbmRvdy5TVCAmJiBTVC5EQikgfHwgd2luZG93LkRCIHx8IHt9OwogICAgICBjb25zdCBwZnMgPSBBcnJheS5pc0FycmF5KGRiLnBvcnRmb2xpb3MpID8gZGIucG9ydGZvbGlvcyA6IFtdOwogICAgICBsZXQgbiA9IDA7CiAgICAgIGZvcihjb25zdCBwZiBvZiBwZnMpewogICAgICAgIGNvbnN0IHR4cyA9IEFycmF5LmlzQXJyYXkocGYudHJhbnNhY3Rpb25zKSA/IHBmLnRyYW5zYWN0aW9ucyA6IFtdOwogICAgICAgIGZvcihjb25zdCB0eCBvZiB0eHMpewogICAgICAgICAgaWYodHggJiYgdHgudHlwZSA9PT0gJ3NlbGwnKXsKICAgICAgICAgICAgY29uc3QgZCA9IERhdGUucGFyc2UodHguZGF0ZSB8fCAnJyk7CiAgICAgICAgICAgIGlmKE51bWJlci5pc0Zpbml0ZShkKSAmJiAoIXJhbmdlIHx8IChkID49IChyYW5nZS5zdGFydCA/PyAtSW5maW5pdHkpICYmIGQgPD0gKHJhbmdlLmVuZCA/PyBJbmZpbml0eSkpKSl7CiAgICAgICAgICAgICAgbisrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuOwogICAgfWNhdGNoKF8peyByZXR1cm4gMDsgfQogIH0KLy8gPT09IFtHT10gTElOSU9XWSBXWUtSRVM6IFdrxYJhZCAoYmx1ZSkgdnMgV2FydG/Fm8SHIChncmVlbikgPT09PT09PT09PT09PT09PT09PT09CmxldCBfX0dPX0NIQVJUX0NBQ0hFID0gbnVsbDsKZnVuY3Rpb24gX19nb190b01zKGQpeyB0cnl7IGlmKHR5cGVvZiBkID09PSAnbnVtYmVyJykgcmV0dXJuIGQ7IHJldHVybiBEYXRlLnBhcnNlKGQgfHwgJzE5NzAtMDEtMDEnKTsgfWNhdGNoKF8peyByZXR1cm4gMDsgfSB9CmZ1bmN0aW9uIF9fZ29fZmxvb3JEYXkobXMpeyBjb25zdCBkdCA9IG5ldyBEYXRlKG1zKTsgZHQuc2V0SG91cnMoMCwwLDAsMCk7IHJldHVybiBkdC5nZXRUaW1lKCk7IH0KZnVuY3Rpb24gX19nb19mbXQoZCl7IHRyeXsgcmV0dXJuIG5ldyBEYXRlKGQpLnRvTG9jYWxlRGF0ZVN0cmluZygpOyB9Y2F0Y2goXyl7IHJldHVybiBTdHJpbmcoZCk7IH0gfQpmdW5jdGlvbiBfX2dvX3N1bShhKXsgcmV0dXJuIChhfHxbXSkucmVkdWNlKCh4LHkpPT54KygreXx8MCksMCk7IH0KCmZ1bmN0aW9uIF9fZ29fd2FwKGxvdHMpewogIHRyeXsKICAgIGlmKCFBcnJheS5pc0FycmF5KGxvdHMpIHx8ICFsb3RzLmxlbmd0aCkgcmV0dXJuIDA7CiAgICBsZXQgc1F0eT0wLCBzVmFsPTA7CiAgICBmb3IoY29uc3QgbCBvZiBsb3RzKXsgY29uc3QgcT1OdW1iZXIobC5xdHkpfHwwLCBwPU51bWJlcihsLnByaWNlKXx8MDsgc1F0eSs9cTsgc1ZhbCs9cSpwOyB9CiAgICByZXR1cm4gc1F0eT4wID8gKHNWYWwvc1F0eSkgOiAwOwogIH1jYXRjaChfKXsgcmV0dXJuIDA7IH0KfQoKCmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVHbG9iYWxMaW5lU2VyaWVzKFEsIHBlcmlvZFJhbmdlLCBiYXNlKXsKICBjb25zdCBzdGFydE1zID0gX19nb19mbG9vckRheShwZXJpb2RSYW5nZS5zdGFydCk7CiAgY29uc3QgZW5kTXMgICA9IF9fZ29fZmxvb3JEYXkocGVyaW9kUmFuZ2UuZW5kKTsKICBjb25zdCBzZXJpZXNCbHVlID0gW107IC8vIHdrxYJhZAogIGNvbnN0IHNlcmllc0dyZWVuID0gW107IC8vIGVxdWl0eQogIGNvbnN0IHBmU3RhdGVzID0gbmV3IE1hcCgpOyAgLy8gcGYuaWQgLT4geyBjYXNoLCBob2xkaW5nczogeyBUS1I6IHtxdHl9IH0gfQogIGNvbnN0IHBmRnggPSBuZXcgTWFwKCk7ICAgICAgLy8gcGYuaWQgLT4gZnggdG8gYmFzZQogIGNvbnN0IGFsbFR4ID0gW107CgogIC8vIENvbGxlY3QgJiBwcmVwYXJlCiAgZm9yKGNvbnN0IHBmIG9mIChTVC5EQj8ucG9ydGZvbGlvc3x8W10pKXsKICAgIHBmU3RhdGVzLnNldChwZi5pZHx8cGYubmFtZXx8cGYudGlja2VyfHxNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSwgeyBjYXNoOiAwLCBob2xkaW5nczoge30gfSk7CiAgICBjb25zdCBmeCA9IGF3YWl0IGVuc3VyZUZ4KHBmLmN1cnJlbmN5fHwnUExOJywgYmFzZSk7CiAgICBwZkZ4LnNldChwZi5pZHx8cGYubmFtZXx8cGYudGlja2VyLCBmeCk7CiAgICBjb25zdCB0eHMgPSAocGYudHJhbnNhY3Rpb25zfHxbXSkubWFwKHQ9Pih7Li4udCwgX19wZjogcGZ9KSk7CiAgICBhbGxUeC5wdXNoKC4uLnR4cyk7CiAgfQogIC8vIFNvcnQgYXNjZW5kaW5nIGJ5IGRhdGUKICBhbGxUeC5zb3J0KChhLGIpPT4gX19nb190b01zKGEuZGF0ZSkgLSBfX2dvX3RvTXMoYi5kYXRlKSk7CgogIC8vIEhlbHBlcnMgdGhhdCByZXVzZSBleGlzdGluZyBlbmdpbmUKICBmdW5jdGlvbiBlcXVpdHlOb3coKXsKICAgIGxldCB0b3RhbCA9IDA7CiAgICBmb3IoY29uc3QgcGYgb2YgKFNULkRCPy5wb3J0Zm9saW9zfHxbXSkpewogICAgICBjb25zdCBzdCA9IHBmU3RhdGVzLmdldChwZi5pZHx8cGYubmFtZXx8cGYudGlja2VyKTsKICAgICAgY29uc3QgZnggPSBwZkZ4LmdldChwZi5pZHx8cGYubmFtZXx8cGYudGlja2VyKSB8fCAxOwogICAgICB0b3RhbCArPSAoc3QuY2FzaHx8MCkgKiBmeDsKICAgICAgZm9yKGNvbnN0IFt0aywgYm9va10gb2YgT2JqZWN0LmVudHJpZXMoc3QuaG9sZGluZ3N8fHt9KSl7CiAgICAgICAgbGV0IHByaWNlID0gKFFbdGtdPy5wcmljZSA/PyAwKTsKICAgICAgICBpZighKHByaWNlPjApKXsKICAgICAgICAgIGNvbnN0IGxvdHMgPSAoYm9vayAmJiBBcnJheS5pc0FycmF5KGJvb2subG90cykpID8gYm9vay5sb3RzIDogW107CiAgICAgICAgICBjb25zdCB3YXAgPSBfX2dvX3dhcChsb3RzKTsKICAgICAgICAgIHByaWNlID0gd2FwPjAgPyB3YXAgOiAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBxdHkgPSAoYm9vayAmJiBBcnJheS5pc0FycmF5KGJvb2subG90cykgJiYgYm9vay5sb3RzLmxlbmd0aCkKICAgICAgICAgID8gX19nb19zdW0oYm9vay5sb3RzLm1hcChsPT4gK2wucXR5fHwwKSkKICAgICAgICAgIDogTnVtYmVyKChib29rJiZib29rLnF0eSl8fDApOwogICAgICAgIHRvdGFsICs9IHF0eSAqIHByaWNlICogZng7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0b3RhbDsKICB9CiAgZnVuY3Rpb24gYXBwbHlUeFRvU3RhdGUodHgpewogICAgY29uc3QgcGYgPSB0eC5fX3BmOwogICAgY29uc3Qgc3QgPSBwZlN0YXRlcy5nZXQocGYuaWR8fHBmLm5hbWV8fHBmLnRpY2tlcik7CiAgICBpZighc3QpIHJldHVybjsKICAgIC8vIGNhc2gtb25seSBmbG93cwogICAgaWYodHgudHlwZT09PSJkZXBvc2l0IiB8fCB0eC50eXBlPT09IndpdGhkcmF3IiB8fCB0eC50eXBlPT09InRyYW5zZmVyX2luIiB8fCB0eC50eXBlPT09InRyYW5zZmVyX291dCIpewogICAgICAodHlwZW9mIGFwcGx5Q2FzaD09PSdmdW5jdGlvbicgPyBhcHBseUNhc2ggOiBfX2dvX2FwcGx5Q2FzaFNoaW0pKHN0LCB0eC50eXBlLCB0eC5hbW91bnR8fDApOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZih0eC50eXBlPT09ImJ1eSIpeyB0cnl7IGlmKHR5cGVvZiBlbnN1cmVCdXlMb3RJZEluVHg9PT0nZnVuY3Rpb24nKSBlbnN1cmVCdXlMb3RJZEluVHgodHgpO31jYXRjaChfKXt9OyAodHlwZW9mIGFwcGx5QnV5PT09J2Z1bmN0aW9uJyA/IGFwcGx5QnV5IDogX19nb19hcHBseUJ1eSkoc3QsIHBmLCB0eCk7IHJldHVybjsgfQogICAgaWYodHgudHlwZT09PSJzZWxsIil7ICh0eXBlb2YgYXBwbHlTZWxsPT09J2Z1bmN0aW9uJyA/IGFwcGx5U2VsbCA6IF9fZ29fYXBwbHlTZWxsKShzdCwgcGYsIHR4KTsgcmV0dXJuOyB9CiAgICBpZih0eC50eXBlPT09InRyYW5zZmVyX2NvbXBhbnlfaW4iKXsgKHR5cGVvZiBhcHBseVRyYW5zZmVyQ29tcGFueUluPT09J2Z1bmN0aW9uJyA/IGFwcGx5VHJhbnNmZXJDb21wYW55SW4gOiBfX2dvX2FwcGx5VHJhbnNmZXJDb21wYW55SW4pKHN0LCBwZiwgdHgpOyByZXR1cm47IH0KICAgIGlmKHR4LnR5cGU9PT0idHJhbnNmZXJfY29tcGFueV9vdXQiKXsgKHR5cGVvZiBhcHBseVRyYW5zZmVyQ29tcGFueU91dD09PSdmdW5jdGlvbicgPyBhcHBseVRyYW5zZmVyQ29tcGFueU91dCA6IF9fZ29fYXBwbHlUcmFuc2ZlckNvbXBhbnlPdXQpKHN0LCBwZiwgdHgpOyByZXR1cm47IH0KICAgIC8vIGlnbm9yZSB1bmtub3ducwogIH0KCiAgLy8gQnVpbGQgYmFzZWxpbmUgdXAgdG8gc3RhcnQKICBsZXQgd2vFgmFkQmFzZSA9IDA7CiAgZm9yKGNvbnN0IHR4IG9mIGFsbFR4KXsKICAgIGNvbnN0IHRtcyA9IF9fZ29fdG9Ncyh0eC5kYXRlKTsKICAgIGlmKHRtcyA8IHN0YXJ0TXMpewogICAgICAvLyBjb250cmlidXRpb25zCiAgICAgIGlmKHR4LnR5cGU9PT0iZGVwb3NpdCIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9pbiIpewogICAgICAgIHdrxYJhZEJhc2UgKz0gKE51bWJlcih0eC5hbW91bnQpfHwwKSAqIChwZkZ4LmdldCh0eC5fX3BmLmlkKXx8MSk7CiAgICAgIH1lbHNlIGlmKHR4LnR5cGU9PT0id2l0aGRyYXciIHx8IHR4LnR5cGU9PT0idHJhbnNmZXJfb3V0Iil7CiAgICAgICAgd2vFgmFkQmFzZSAtPSAoTnVtYmVyKHR4LmFtb3VudCl8fDApICogKHBmRnguZ2V0KHR4Ll9fcGYuaWQpfHwxKTsKICAgICAgfQogICAgICBhcHBseVR4VG9TdGF0ZSh0eCk7CiAgICB9ZWxzZXsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIC8vIFNuYXBzaG90IGF0IHN0YXJ0CiAgc2VyaWVzQmx1ZS5wdXNoKHsgeDpzdGFydE1zLCB5OiB3a8WCYWRCYXNlIH0pOwogIHNlcmllc0dyZWVuLnB1c2goeyB4OnN0YXJ0TXMsIHk6IGVxdWl0eU5vdygpIH0pOwoKICAvLyBBcHBseSBpbi1yYW5nZQogIGZvcihjb25zdCB0eCBvZiBhbGxUeCl7CiAgICBjb25zdCB0bXMgPSBfX2dvX3RvTXModHguZGF0ZSk7CiAgICBpZih0bXMgPCBzdGFydE1zIHx8IHRtcyA+IGVuZE1zKSBjb250aW51ZTsKICAgIGlmKHR4LnR5cGU9PT0iZGVwb3NpdCIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9pbiIpewogICAgICB3a8WCYWRCYXNlICs9IChOdW1iZXIodHguYW1vdW50KXx8MCkgKiAocGZGeC5nZXQodHguX19wZi5pZCl8fDEpOwogICAgfWVsc2UgaWYodHgudHlwZT09PSJ3aXRoZHJhdyIgfHwgdHgudHlwZT09PSJ0cmFuc2Zlcl9vdXQiKXsKICAgICAgd2vFgmFkQmFzZSAtPSAoTnVtYmVyKHR4LmFtb3VudCl8fDApICogKHBmRnguZ2V0KHR4Ll9fcGYuaWQpfHwxKTsKICAgIH0KICAgIGFwcGx5VHhUb1N0YXRlKHR4KTsKICAgIGNvbnN0IGRheSA9IF9fZ29fZmxvb3JEYXkodG1zKTsKICAgIHNlcmllc0JsdWUucHVzaCh7IHg6IGRheSwgeTogd2vFgmFkQmFzZSB9KTsKICAgIHNlcmllc0dyZWVuLnB1c2goeyB4OiBkYXksIHk6IGVxdWl0eU5vdygpIH0pOwogIH0KCiAgLy8gRm9yY2UgZmluYWwgcG9pbnQgYXQgZW5kCiAgc2VyaWVzQmx1ZS5wdXNoKHsgeDplbmRNcywgeTogd2vFgmFkQmFzZSB9KTsKICBzZXJpZXNHcmVlbi5wdXNoKHsgeDplbmRNcywgeTogZXF1aXR5Tm93KCkgfSk7CgogIC8vIEJvdW5kcwogIGNvbnN0IHlzID0gWy4uLnNlcmllc0JsdWUsIC4uLnNlcmllc0dyZWVuXS5tYXAocD0+cC55KTsKICBsZXQgbWluWSA9IE1hdGgubWluKC4uLnlzLCAwKTsKICBsZXQgbWF4WSA9IE1hdGgubWF4KC4uLnlzLCAwKTsKICBpZigheXMubGVuZ3RoIHx8ICFOdW1iZXIuaXNGaW5pdGUobWluWSkgfHwgIU51bWJlci5pc0Zpbml0ZShtYXhZKSl7CiAgICAgIG1pblkgPSAwOyBtYXhZID0gMTsKICB9CiAgaWYobWF4WSAtIG1pblkgPCAxZS02KXsgbWF4WSA9IG1pblkgKyAxOyB9IC8vIGF2b2lkIDAgaGVpZ2h0CgogIHJldHVybiB7IHNlcmllc0JsdWUsIHNlcmllc0dyZWVuLCBib3VuZHM6eyBtaW5YOnN0YXJ0TXMsIG1heFg6ZW5kTXMsIG1pblksIG1heFkgfSB9Owp9CgpmdW5jdGlvbiBfX2dvX2ZtdEN1cnJlbmN5KHYsIGNvZGUpeyB0cnl7IGlmKHR5cGVvZiBmbXRDdXJyZW5jeT09PSdmdW5jdGlvbicpIHJldHVybiBmbXRDdXJyZW5jeSh2LCBjb2RlKTsgfWNhdGNoKF8peyB9IHRyeXsgcmV0dXJuIG5ldyBJbnRsLk51bWJlckZvcm1hdCh1bmRlZmluZWQse3N0eWxlOidjdXJyZW5jeScsY3VycmVuY3k6KGNvZGV8fCdQTE4nKX0pLmZvcm1hdCh2fHwwKTt9Y2F0Y2goXyl7IHJldHVybiBTdHJpbmcoTWF0aC5yb3VuZCgodnx8MCkqMTAwKS8xMDApKycgJysoY29kZXx8JycpOyB9IH0KCmZ1bmN0aW9uIGRyYXdHbG9iYWxMaW5lQ2hhcnQoY2FjaGUpewogICAgdHJ5ewogICAgICBjb25zdCBiYXNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWJhc2UnKT8udmFsdWUgfHwgJ1BMTic7CiAgICAgIGNvbnN0IGIgPSBjYWNoZT8uc2VyaWVzQmx1ZSB8fCBbXTsKICAgICAgY29uc3QgZyA9IGNhY2hlPy5zZXJpZXNHcmVlbiB8fCBbXTsKICAgICAgY29uc3QgbGFzdEIgPSBiLmxlbmd0aCA/IGJbYi5sZW5ndGgtMV0ueSA6IDA7CiAgICAgIGNvbnN0IGxhc3RHID0gZy5sZW5ndGggPyBnW2cubGVuZ3RoLTFdLnkgOiAwOwogICAgICBjb25zdCBpYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1pbmZvLWJsdWUnKTsgaWYoaWIpIGliLnRleHRDb250ZW50ID0gJ1drxYJhZDogJyArIF9fZ29fZm10Q3VycmVuY3kobGFzdEIsIGJhc2UpOwogICAgICBjb25zdCBpZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1pbmZvLWdyZWVuJyk7IGlmKGlnKSBpZy50ZXh0Q29udGVudCA9ICdXYXJ0b8WbxIc6ICcgKyBfX2dvX2ZtdEN1cnJlbmN5KGxhc3RHLCBiYXNlKTsKICAgIH1jYXRjaChfKXt9CgogICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNnby1saW5lLWNoYXJ0LWNhcmQgLmdvLWNoYXJ0LXdyYXAnKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZ28tY2hhcnQtd3JhcCcpOwogICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWxpbmUtY2hhcnQnKTsKICAgIGNvbnN0IGVtcHR5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWNoYXJ0LWVtcHR5Jyk7CiAgICBjb25zdCB0aXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tY2hhcnQtdG9vbHRpcC1pbXAnKTsKICAgIGlmKCF3cmFwIHx8ICFjYW52YXMgfHwgIWVtcHR5KSByZXR1cm47CgogICAgaWYoIWNhY2hlIHx8ICFjYWNoZS5zZXJpZXNCbHVlPy5sZW5ndGggfHwgIWNhY2hlLnNlcmllc0dyZWVuPy5sZW5ndGgpewogICAgICBlbXB0eS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsgY2FudmFzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IGlmKHRpcCkgdGlwLmNsYXNzTGlzdC5yZW1vdmUoJ3Zpc2libGUnKTsgcmV0dXJuOwogICAgfQogICAgZW1wdHkuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgY2FudmFzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwoKICAgIGNvbnN0IGRwciA9ICh3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpb3x8MSk7CiAgICBjb25zdCBkZXNpcmVkSCA9IDgyMDsgdHJ5eyB3cmFwLnN0eWxlLmhlaWdodCA9IGRlc2lyZWRIKydweCc7IHdyYXAuc3R5bGUubWluSGVpZ2h0ID0gJzgyMHB4Jzsgd3JhcC5zdHlsZS5tYXhIZWlnaHQgPSBkZXNpcmVkSCsncHgnOyB9Y2F0Y2goXyl7fQpjb25zdCB3ID0gTWF0aC5tYXgoMTAsIHdyYXAuY2xpZW50V2lkdGgpOwpjb25zdCBoID0gZGVzaXJlZEg7CiAgICBjYW52YXMud2lkdGggPSBNYXRoLmZsb29yKHcgKiBkcHIpOwogICAgY2FudmFzLmhlaWdodCA9IE1hdGguZmxvb3IoaCAqIGRwcik7CiAgICBjYW52YXMuc3R5bGUud2lkdGggPSB3ICsgJ3B4JzsKICAgIGNhbnZhcy5zdHlsZS5oZWlnaHQgPSBoICsgJ3B4JzsKICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcsIHsgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlIH0pOwogICAgY3R4LnNldFRyYW5zZm9ybSgxLDAsMCwxLDAsMCk7CiAgICBjdHguc2NhbGUoZHByLCBkcHIpOwogICAgY29uc3Qgb3ZlcmxheSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1saW5lLWNoYXJ0LW92ZXJsYXknKTsKICAgIGxldCBvY3R4ID0gbnVsbDsKICAgIGlmKG92ZXJsYXkpewogICAgICBvdmVybGF5LndpZHRoID0gTWF0aC5mbG9vcih3ICogZHByKTsKICAgICAgb3ZlcmxheS5oZWlnaHQgPSBNYXRoLmZsb29yKGggKiBkcHIpOwogICAgICBvdmVybGF5LnN0eWxlLndpZHRoID0gdyArICdweCc7CiAgICAgIG92ZXJsYXkuc3R5bGUuaGVpZ2h0ID0gaCArICdweCc7CiAgICAgIG9jdHggPSBvdmVybGF5LmdldENvbnRleHQoJzJkJyk7CiAgICAgIG9jdHguc2V0VHJhbnNmb3JtKDEsMCwwLDEsMCwwKTsKICAgICAgb2N0eC5zY2FsZShkcHIsIGRwcik7CiAgICB9CgoKICAgIGNvbnN0IHBhZCA9IHsgbGVmdDogMTEwLCByaWdodDogNjAsIHRvcDogNTYsIGJvdHRvbTogODQgfTsKCiAgICBjb25zdCB7bWluWCwgbWF4WH0gPSBjYWNoZS5ib3VuZHMgfHwge307CmNvbnN0IHhzID0gKGNhY2hlLnNlcmllc0JsdWV8fFtdKS5tYXAocD0+cC54KS5jb25jYXQoKGNhY2hlLnNlcmllc0dyZWVufHxbXSkubWFwKHA9PnAueCkpOwpjb25zdCBfbWluWCA9IE51bWJlci5pc0Zpbml0ZShtaW5YKSA/IG1pblggOiAoeHMubGVuZ3RoPyBNYXRoLm1pbiguLi54cyk6MCk7CmNvbnN0IF9tYXhYID0gTnVtYmVyLmlzRmluaXRlKG1heFgpID8gbWF4WCA6ICh4cy5sZW5ndGg/IE1hdGgubWF4KC4uLnhzKTooX21pblgrMSkpOwpjb25zdCBhbGxZID0gKGNhY2hlLnNlcmllc0JsdWV8fFtdKS5tYXAocD0+cC55KS5jb25jYXQoKGNhY2hlLnNlcmllc0dyZWVufHxbXSkubWFwKHA9PnAueSkpLmZpbHRlcih2PT5OdW1iZXIuaXNGaW5pdGUodikpOwpsZXQgX21pblkgPSBhbGxZLmxlbmd0aD8gTWF0aC5taW4oLi4uYWxsWSkgOiAwOwpsZXQgX21heFkgPSBhbGxZLmxlbmd0aD8gTWF0aC5tYXgoLi4uYWxsWSkgOiAoX21pblkrMSk7CmxldCBfcmFuZ2VZID0gTWF0aC5tYXgoMWUtNiwgX21heFkgLSBfbWluWSk7Cl9taW5ZID0gTWF0aC5tYXgoMCwgX21pblkgLSBfcmFuZ2VZKjAuMjApOwpfbWF4WSA9IF9tYXhZICsgX3JhbmdlWSowLjIwOwpfcmFuZ2VZID0gTWF0aC5tYXgoMWUtNiwgX21heFkgLSBfbWluWSk7CiAgICBjb25zdCBYID0geCA9PiBwYWQubGVmdCArICggKHggLSBfbWluWCkgLyBNYXRoLm1heCgxLCAoX21heFggLSBfbWluWCkpICkgKiAodyAtIHBhZC5sZWZ0IC0gcGFkLnJpZ2h0KTsKICAgIGNvbnN0IFkgPSB5ID0+IChoIC0gcGFkLmJvdHRvbSkgLSAoICh5IC0gX21pblkpIC8gTWF0aC5tYXgoMWUtNiwoX21heFkgLSBfbWluWSkpICkgKiAoaCAtIHBhZC50b3AgLSBwYWQuYm90dG9tKTsKCiAgICBjdHguY2xlYXJSZWN0KDAsMCx3LGgpOwogICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuMyknOwogICAgY3R4LmZpbGxSZWN0KDAsMCx3LGgpOwoKICAgIGNvbnN0IGN3ID0gdyAtIHBhZC5sZWZ0IC0gcGFkLnJpZ2h0OwogICAgY29uc3QgY2ggPSBoIC0gcGFkLnRvcCAtIHBhZC5ib3R0b207CgogICAgLy8gR3JpZAogICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMTQ4LCAxNjMsIDE4NCwgMC4yKSc7CiAgICBjdHgubGluZVdpZHRoID0gMTsKICAgIGZvcihsZXQgaT0wO2k8PTY7aSsrKXsKICAgICAgY29uc3QgeXkgPSBwYWQudG9wICsgKGNoLzYpKmk7CiAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4Lm1vdmVUbyhwYWQubGVmdCwgeXkpOyBjdHgubGluZVRvKHcgLSBwYWQucmlnaHQsIHl5KTsgY3R4LnN0cm9rZSgpOwogICAgICBjb25zdCB2YWwgPSBfbWF4WSAtIChfbWF4WSAtIF9taW5ZKSAqIChpLzYpOwogICAgICBjdHguZmlsbFN0eWxlID0gJyM5NGEzYjgnOyBjdHguZm9udCA9ICdib2xkIDEzcHggc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvJzsKICAgICAgY3R4LnRleHRBbGlnbiA9ICdyaWdodCc7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCBiYXNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWJhc2UnKT8udmFsdWUgfHwgJ1BMTic7CiAgICAgICAgY3R4LmZpbGxUZXh0KF9fZ29fZm10Q3VycmVuY3kodmFsLCBiYXNlKSwgcGFkLmxlZnQgLSAxMiwgeXkgKyA0KTsKICAgICAgfWNhdGNoKF8pe30KICAgIH0KICAgIC8vIEJvcmRlcgogICAgY3R4LnN0cm9rZVN0eWxlID0gJyMzMzQxNTUnOwogICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICBjdHguc3Ryb2tlUmVjdChwYWQubGVmdCwgcGFkLnRvcCwgY3csIGNoKTsKCiAgICBmdW5jdGlvbiBzdHJva2VTZXJpZXMoc2VyaWVzLCBjb2xvciwgd2lkdGgpewogICAgICBpZighc2VyaWVzIHx8ICFzZXJpZXMubGVuZ3RoKSByZXR1cm47CiAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgbGV0IGZpcnN0ID0gdHJ1ZTsKICAgICAgZm9yKGNvbnN0IHAgb2Ygc2VyaWVzKXsKICAgICAgICBjb25zdCB4eCA9IFgocC54KSwgeXkgPSBZKHAueSk7CiAgICAgICAgaWYoZmlyc3QpeyBjdHgubW92ZVRvKHh4LHl5KTsgZmlyc3Q9ZmFsc2U7IH0gZWxzZSB7IGN0eC5saW5lVG8oeHgseXkpOyB9CiAgICAgIH0KICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7IGN0eC5saW5lV2lkdGggPSB3aWR0aDsgY3R4LmxpbmVDYXA9J3JvdW5kJzsgY3R4LmxpbmVKb2luPSdyb3VuZCc7IGN0eC5zdHJva2UoKTsKICAgIH0KCiAgICBzdHJva2VTZXJpZXMoY2FjaGUuc2VyaWVzQmx1ZSwgJyMzYjgyZjYnLCA0LjYpOwogICAgc3Ryb2tlU2VyaWVzKGNhY2hlLnNlcmllc0dyZWVuLCAnIzIyYzU1ZScsIDQuNik7CgogICAgZnVuY3Rpb24gZHJhd1BvaW50cyhzZXJpZXMsIGZpbGwpewogICAgICBpZighc2VyaWVzIHx8ICFzZXJpZXMubGVuZ3RoKSByZXR1cm47CiAgICAgIGNvbnN0IHIgPSAzLjY7CiAgICAgIGN0eC5maWxsU3R5bGUgPSBmaWxsOwogICAgICBmb3IoY29uc3QgcCBvZiBzZXJpZXMpewogICAgICAgIGNvbnN0IHh4ID0gWChwLngpLCB5eSA9IFkocC55KTsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoeHgseXksciwwLE1hdGguUEkqMik7IGN0eC5maWxsKCk7CiAgICAgIH0KICAgIH0KICAgIGRyYXdQb2ludHMoY2FjaGUuc2VyaWVzQmx1ZSwgJ3JnYmEoNTksMTMwLDI0NiwwLjg1KScpOwogICAgZHJhd1BvaW50cyhjYWNoZS5zZXJpZXNHcmVlbiwncmdiYSgzNCwxOTcsOTQsMC44NSknKTsKCiAgICAvLyBYIGxhYmVscwogICAgY29uc3QgeFN0YXJ0ID0gbmV3IERhdGUoX21pblgpLCB4TWlkID0gbmV3IERhdGUoKF9taW5YK19tYXhYKS8yKSwgeEVuZCA9IG5ldyBEYXRlKF9tYXhYKTsKICAgIGN0eC5maWxsU3R5bGUgPSAnIzk0YTNiOCc7IGN0eC5mb250ID0gJzE0cHggc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvJzsgY3R4LnRleHRBbGlnbiA9ICdsZWZ0JzsKICAgIGN0eC5maWxsVGV4dCh4U3RhcnQudG9Mb2NhbGVEYXRlU3RyaW5nKCksIHBhZC5sZWZ0LCBoLTEyKTsKICAgIGNvbnN0IG1pZExhYmVsID0geE1pZC50b0xvY2FsZURhdGVTdHJpbmcoKTsgY29uc3QgbWlkVyA9IGN0eC5tZWFzdXJlVGV4dChtaWRMYWJlbCkud2lkdGg7CiAgICBjdHguZmlsbFRleHQobWlkTGFiZWwsICh3IC0gbWlkVykvMiwgaC0xMik7CiAgICBjb25zdCBlbmRMYWJlbCA9IHhFbmQudG9Mb2NhbGVEYXRlU3RyaW5nKCk7IGNvbnN0IGVuZFcgPSBjdHgubWVhc3VyZVRleHQoZW5kTGFiZWwpLndpZHRoOwogICAgCiAgICAvLyBTbmFwc2hvdCBiYXNlIGxheWVyIHRvIHByZXZlbnQgY3Jvc3NoYWlyIHRyYWlscwogICAgdHJ5ewogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHguc2V0VHJhbnNmb3JtKDEsMCwwLDEsMCwwKTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH1jYXRjaChfKXt9CgogICAgLy8gVG9vbHRpcCBldmVudHMgKGF0dGFjaCBvbmNlKQoKICAgIChmdW5jdGlvbiBhdHRhY2hUaXBIYW5kbGVycygpewogICAgICBpZighY2FudmFzKSByZXR1cm47CiAgICAgIGNvbnN0IGIgPSBjYWNoZS5zZXJpZXNCbHVlIHx8IFtdOwogICAgICBjb25zdCBnID0gY2FjaGUuc2VyaWVzR3JlZW4gfHwgW107CiAgICAgIGNvbnN0IHRpcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1jaGFydC10b29sdGlwLWltcCcpOwogICAgICBmdW5jdGlvbiBzaG93VGlwKHB0SWR4LCBjbGllbnRYLCBjbGllbnRZKXsKICAgICAgICBpZighdGlwKSByZXR1cm47CiAgICAgICAgY29uc3QgaSA9IE1hdGgubWF4KDAsIE1hdGgubWluKHB0SWR4LCBNYXRoLm1pbihiLmxlbmd0aCwgZy5sZW5ndGgpLTEpKTsKICAgICAgICBjb25zdCB2YiA9IChiW2ldICYmIGJbaV0ueSkgfHwgMDsKICAgICAgICBjb25zdCB2ZyA9IChnW2ldICYmIGdbaV0ueSkgfHwgMDsKICAgICAgICBjb25zdCBkdCA9IG5ldyBEYXRlKChiW2ldICYmIGJbaV0ueCkgfHwgKGdbaV0gJiYgZ1tpXS54KSB8fCBfbWluWCk7CiAgICAgICAgY29uc3QgYmFzZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1iYXNlJyk/LnZhbHVlIHx8ICdQTE4nOwogICAgICAgIHRpcC5jbGFzc0xpc3QuYWRkKCd2aXNpYmxlJyk7CiAgICAgICAgY29uc3QgZCA9IGRvY3VtZW50OyAKICAgICAgICBkLmdldEVsZW1lbnRCeUlkKCd0dC1kYXRlLWltcCcpLnRleHRDb250ZW50ICAgICA9IGR0LnRvTG9jYWxlRGF0ZVN0cmluZygncGwtUEwnKTsKICAgICAgICBkLmdldEVsZW1lbnRCeUlkKCd0dC1pbnZlc3RlZC1pbXAnKS50ZXh0Q29udGVudCA9IF9fZ29fZm10Q3VycmVuY3kodmIsIGJhc2UpOwogICAgICAgIGQuZ2V0RWxlbWVudEJ5SWQoJ3R0LXZhbHVlLWltcCcpLnRleHRDb250ZW50ICAgID0gX19nb19mbXRDdXJyZW5jeSh2ZywgYmFzZSk7CiAgICAgICAgY29uc3QgcHJvZml0ID0gdmcgLSB2YjsKICAgICAgICBkLmdldEVsZW1lbnRCeUlkKCd0dC1wcm9maXQtaW1wJykudGV4dENvbnRlbnQgICA9IF9fZ29fZm10Q3VycmVuY3kocHJvZml0LCBiYXNlKTsKICAgICAgICBjb25zdCByb2kgPSAodmI+MCkgPyAocHJvZml0IC8gdmIgKiAxMDApIDogMDsKICAgICAgICBkLmdldEVsZW1lbnRCeUlkKCd0dC1yb2ktaW1wJykudGV4dENvbnRlbnQgICAgICA9IChyb2kudG9GaXhlZCgyKSArICclJyk7CgogICAgICAgIGNvbnN0IHJlY3QgPSBjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgbGV0IGxlZnQgPSBjbGllbnRYIC0gcmVjdC5sZWZ0OwogICAgICAgIGxldCB0b3AgID0gY2xpZW50WSAtIHJlY3QudG9wIC0gMTQwOwogICAgICAgIGlmIChsZWZ0ICsgMzQwID4gcmVjdC53aWR0aCkgbGVmdCA9IHJlY3Qud2lkdGggLSAzNTA7CiAgICAgICAgaWYgKGxlZnQgPCAxMCkgbGVmdCA9IDEwOwogICAgICAgIHRpcC5zdHlsZS5sZWZ0ID0gbGVmdCArICdweCc7CiAgICAgICAgdGlwLnN0eWxlLnRvcCAgPSB0b3AgKyAncHgnOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGhpZGVUaXAoKXsgaWYodGlwKSB0aXAuY2xhc3NMaXN0LnJlbW92ZSgndmlzaWJsZScpOyB9CgogICAgICBpZighY2FudmFzLl9fdGlwQm91bmQpewogICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCAoZSk9PnsKICAgICAgICAgIC8vIFJlc3RvcmUgYmFzZSBzbmFwc2hvdCB0byBjbGVhciBwcmV2aW91cyBjcm9zc2hhaXJzCgogICAgICAgICAgY29uc3QgcmVjdCA9IGNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgIGNvbnN0IHJ4ID0gKGUuY2xpZW50WCAtIHJlY3QubGVmdCkgLyByZWN0LndpZHRoOwogICAgICAgICAgY29uc3QgZG9tYWluWCA9IF9taW5YICsgTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgcngpKSAqIChfbWF4WCAtIF9taW5YKTsKCiAgICAgICAgICBmdW5jdGlvbiBuZWFyZXN0SWR4KHNlcmllcyl7CiAgICAgICAgICAgIGlmKCFzZXJpZXMgfHwgIXNlcmllcy5sZW5ndGgpIHJldHVybiAtMTsKICAgICAgICAgICAgbGV0IGxvID0gMCwgaGkgPSBzZXJpZXMubGVuZ3RoLTE7CiAgICAgICAgICAgIHdoaWxlKGxvIDwgaGkpewogICAgICAgICAgICAgIGNvbnN0IG1pZCA9IChsbyArIGhpKSA+PiAxOwogICAgICAgICAgICAgIGlmKHNlcmllc1ttaWRdLnggPCBkb21haW5YKSBsbyA9IG1pZCArIDE7IGVsc2UgaGkgPSBtaWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGNhbmQgPSBsbzsKICAgICAgICAgICAgaWYobG8gPiAwICYmIChNYXRoLmFicyhzZXJpZXNbbG8tMV0ueCAtIGRvbWFpblgpIDwgTWF0aC5hYnMoc2VyaWVzW2xvXS54IC0gZG9tYWluWCkpKSBjYW5kID0gbG8tMTsKICAgICAgICAgICAgcmV0dXJuIGNhbmQ7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgYmkgPSBuZWFyZXN0SWR4KGIpOwogICAgICAgICAgY29uc3QgZ2kgPSBuZWFyZXN0SWR4KGcpOwogICAgICAgICAgaWYoYmkgPCAwICYmIGdpIDwgMCl7IHJldHVybiBoaWRlVGlwKCk7IH0KCiAgICAgICAgICBjb25zdCB2YiA9IGJpPj0wID8gKGJbYmldLnl8fDApIDogMDsKICAgICAgICAgIGNvbnN0IHZnID0gZ2k+PTAgPyAoZ1tnaV0ueXx8MCkgOiAwOwoKICAgICAgICAgIC8vIERyYXcgY3Jvc3NoYWlyCiAgICAgICAgICBjb25zdCBjeCA9IFgoZG9tYWluWCk7CiAgICAgICAgICBpZihvY3R4KXsgb2N0eC5jbGVhclJlY3QoMCwwLHcsaCk7IG9jdHguc3Ryb2tlU3R5bGU9J3JnYmEoMTQ4LDE2MywxODQsMC4zNSknOyBvY3R4LmxpbmVXaWR0aD0xOyBvY3R4LmJlZ2luUGF0aCgpOyBvY3R4Lm1vdmVUbyhjeCwgcGFkLnRvcCk7IG9jdHgubGluZVRvKGN4LCBoIC0gcGFkLmJvdHRvbSk7IG9jdHguc3Ryb2tlKCk7IH0KCiAgICAgICAgICBzaG93VGlwKE1hdGgubWF4KGJpLCBnaSksIGUuY2xpZW50WCwgZS5jbGllbnRZLCB2YiwgdmcsIGRvbWFpblgpOwogICAgICAgIH0pOwogICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKCk9PnsgaGlkZVRpcCgpOyBpZihvY3R4KXsgb2N0eC5jbGVhclJlY3QoMCwwLHcsaCk7IH0gfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGhpZGVUaXAsIHtwYXNzaXZlOnRydWV9KTsKICAgICAgICBjYW52YXMuX190aXBCb3VuZCA9IHRydWU7CiAgICAgIH0KICAgIH0pKCk7CiAgICB9Cgphc3luYyBmdW5jdGlvbiBwYWludEdsb2JhbExpbmVDaGFydChRLCBwZXJpb2RSYW5nZSwgYmFzZSl7CiAgdHJ5ewogICAgX19HT19DSEFSVF9DQUNIRSA9IGF3YWl0IGNvbXB1dGVHbG9iYWxMaW5lU2VyaWVzKFEsIHBlcmlvZFJhbmdlLCBiYXNlKTsKICAgIGRyYXdHbG9iYWxMaW5lQ2hhcnQoX19HT19DSEFSVF9DQUNIRSk7CiAgfWNhdGNoKGVycil7CiAgICBjb25zb2xlLndhcm4oJ1tHT10gTGluZSBjaGFydCBlcnJvcjonLCBlcnIpOwogICAgY29uc3QgZW1wdHkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tY2hhcnQtZW1wdHknKTsKICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1saW5lLWNoYXJ0Jyk7CiAgICBpZihlbXB0eSAmJiBjYW52YXMpeyBlbXB0eS5zdHlsZS5kaXNwbGF5PSdibG9jayc7IGNhbnZhcy5zdHlsZS5kaXNwbGF5PSdub25lJzsgfQogIH0KfQp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgKCk9PnsgdHJ5eyBkcmF3R2xvYmFsTGluZUNoYXJ0KF9fR09fQ0hBUlRfQ0FDSEUpOyB9Y2F0Y2goXyl7IH0gfSk7Ci8vID09PSBbL0dPXSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KYXN5bmMgZnVuY3Rpb24gcmVmcmVzaCgpe2xvYWRQcmVmcygpOwogICAgdHJ5eyBjb25zdCBwcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1wZXJpb2QnKTsgaWYocHMpeyBTVC5wZXJpb2RLZXkgPSBwcy52YWx1ZXx8U1QucGVyaW9kS2V5fHwnYWxsJzsgU1QucGVyaW9kUmFuZ2UgPSBnZXRQZXJpb2RSYW5nZShTVC5wZXJpb2RLZXkpOyB9IH1jYXRjaChfKXt9CiAgICB0cnl7IGF3YWl0IGVuc3VyZUZ4KCdVU0QnLCdQTE4nKTsgfWNhdGNoKF8pe30KICAgIGNvbnN0IHBmcyA9IEFycmF5LmlzQXJyYXkoU1QuREIucG9ydGZvbGlvcykgPyBTVC5EQi5wb3J0Zm9saW9zIDogW107CiAgICBjb25zdCBiYXNlID0gJCgnI2dvLWJhc2UnKS52YWx1ZSB8fCBTVC5iYXNlIHx8ICdQTE4nOwogICAgZm9yKGNvbnN0IHBmIG9mIHBmcyl7IGF3YWl0IGVuc3VyZUZ4KHBmLmN1cnJlbmN5fHwnUExOJywgYmFzZSk7IH0KICAgIGNvbnN0IFEgPSBhd2FpdCBmZXRjaEFsbFF1b3Rlc0Nvb3AoKTsKICAgIGNvbnN0IGNvbXAgPSBhd2FpdCBjb21wdXRlQWxsKFEsIFNULnBlcmlvZFJhbmdlKTsKICAgIHBhaW50VG90YWxzKGNvbXApOyBwYWludFBvcnRmb2xpb3MoY29tcC5yZXN1bHRzLCBjb21wLmJhc2UpOyBwYWludFBvc2l0aW9ucyhjb21wLnJlc3VsdHMpOwogICAgY29uc3QgZXh0cmEgPSBjb21wdXRlQ2xvc2VkVHJhZGVTdGF0cyhTVC5wZXJpb2RSYW5nZSk7CiAgICB0cnl7IFNULnRwQ291bnQgPSBjb3VudFNlbGxUeEluUmFuZ2UoU1QuREIsIFNULnBlcmlvZFJhbmdlKTsgdmFyIF9fdHA9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLXRwLWNvdW50Jyk7IGlmKF9fdHApeyBfX3RwLnRleHRDb250ZW50ID0gU3RyaW5nKFNULnRwQ291bnQpOyB9IH1jYXRjaChfKXsgfSAgICAgcGFpbnRFeHRyYVN0YXRzKGV4dHJhKTsKICAgIGF3YWl0IHBhaW50R2xvYmFsTGluZUNoYXJ0KFEsIFNULnBlcmlvZFJhbmdlLCBiYXNlKTsKICAgIHJldHVybiBjb21wOwogIH0KICBmdW5jdGlvbiBzY2hlZHVsZSgpewogICAgaWYoU1QudGltZXIpIGNsZWFySW50ZXJ2YWwoU1QudGltZXIpOwogICAgY29uc3Qgc2VjID0gTWF0aC5tYXgoNSwgTnVtYmVyKCQoJyNnby1wb2xsJykudmFsdWUpfHw0NSk7CiAgICBTVC50aW1lciA9IHNldEludGVydmFsKHJlZnJlc2gsIHNlYyoxMDAwKTsKICB9CgogIC8vIFVJIGV2ZW50cwogICQoJyNnby1mYWInKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57ICQoJyNnby10YWItb3ZlcmxheScpLmhpZGRlbj1mYWxzZTsgcmVmcmVzaCgpOyBzY2hlZHVsZSgpOyB9KTsKICAkKCcjZ28tY2xvc2UnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57ICQoJyNnby10YWItb3ZlcmxheScpLmhpZGRlbj10cnVlOyBpZihTVC50aW1lcikgY2xlYXJJbnRlcnZhbChTVC50aW1lcik7IH0pOwogICQoJyNnby1yZWZyZXNoJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCByZWZyZXNoKTsKICAkKCcjZ28tc2F2ZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfYmFzZScsICQoJyNnby1iYXNlJykudmFsdWV8fCdQTE4nKTsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdnbG9iYWxfb3ZlcnZpZXdfcG9sbCcsIFN0cmluZygkKCcjZ28tcG9sbCcpLnZhbHVlfHwnNDUnKSk7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X3RvaycsICgkKCcjZ28tdG9rZW4nKS52YWx1ZXx8JycpLnRyaW0oKSk7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ2xvYmFsX292ZXJ2aWV3X25vYXBpJywgKCQoJyNnby1uby1hcGknKS5jaGVja2VkID8gJzEnIDogJzAnKSk7CiAgICBhbGVydCgnWmFwaXNhbm8uJyk7CiAgICBzY2hlZHVsZSgpOwogIH0pOwogICQoJyNnby1maWx0ZXInKS5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHJlZnJlc2gpOwogIGNvbnN0IHBlcmlvZFNlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1wZXJpb2QnKTsKICBpZihwZXJpb2RTZWwpewogICAgcGVyaW9kU2VsLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpPT57CiAgICAgIHRyeXsKICAgICAgICBTVC5wZXJpb2RLZXkgPSBwZXJpb2RTZWwudmFsdWUgfHwgJ2FsbCc7CiAgICAgICAgU1QucGVyaW9kUmFuZ2UgPSBnZXRQZXJpb2RSYW5nZShTVC5wZXJpb2RLZXkpOwogICAgICAgIHNldFBlcmlvZEtleShTVC5wZXJpb2RLZXkpOwogICAgICB9Y2F0Y2goXyl7fQogICAgICByZWZyZXNoKCk7CiAgICB9KTsKICB9CgogICQoJyNnby1uby1hcGknKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKT0+ewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19ub2FwaScsICgkKCcjZ28tbm8tYXBpJykuY2hlY2tlZCA/ICcxJyA6ICcwJykpOwogICAgcmVmcmVzaCgpOwogIH0pOwoKICBjb25zdCBmeElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWZ4LXVzZHBsbicpOwogIGNvbnN0IGZ4QXBwbHkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tZngtYXBwbHknKTsKICBjb25zdCBmeENsZWFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvLWZ4LWNsZWFyJyk7CiAgaWYgKGZ4QXBwbHkpewogICAgZnhBcHBseS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57CiAgICAgIGNvbnN0IHYgPSBwYXJzZUZsb2F0KGZ4SW5wdXQgJiYgZnhJbnB1dC52YWx1ZSA/IGZ4SW5wdXQudmFsdWUgOiAnMCcpOwogICAgICBpZiAoaXNGaW5pdGUodikgJiYgdiA+IDApewogICAgICAgIGlmKCFTVC5GWFsnVVNEJ10pIFNULkZYWydVU0QnXSA9IHt9OwogICAgICAgIGlmKCFTVC5GWFsnUExOJ10pIFNULkZYWydQTE4nXSA9IHt9OwogICAgICAgIFNULkZYWydVU0QnXVsnUExOJ10gPSB2OwogICAgICAgIFNULkZYWydQTE4nXVsnVVNEJ10gPSAxL3Y7CiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2dsb2JhbF9vdmVydmlld19meF91c2RwbG4nLCBTdHJpbmcodikpOwogICAgICAgIHBhaW50RngoKTsKICAgICAgICAvLyBwcnplbGljeiBuYXR5Y2htaWFzdCB0b3RhbHMKICAgICAgICByZWZyZXNoKCk7CiAgICAgIH1lbHNlewogICAgICAgIGFsZXJ0KCdQb2RhaiBkb2RhdG5pIGt1cnMsIG5wLiA0LjEyMzQnKTsKICAgICAgfQogICAgfSk7CiAgfQogIGlmIChmeENsZWFyKXsKICAgIGZ4Q2xlYXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ewogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnZ2xvYmFsX292ZXJ2aWV3X2Z4X3VzZHBsbicpOwogICAgICAvLyB1c3V3YW15IGplZHluaWUgbmFkcGlzYW5pZTsgcG96b3N0YXdpYW15IGlubmUga3Vyc3kKICAgICAgdHJ5ewogICAgICAgIGlmIChTVC5GWFsnVVNEJ10pIGRlbGV0ZSBTVC5GWFsnVVNEJ11bJ1BMTiddOwogICAgICAgIGlmIChTVC5GWFsnUExOJ10pIGRlbGV0ZSBTVC5GWFsnUExOJ11bJ1VTRCddOwogICAgICB9Y2F0Y2goXyl7fQogICAgICBwYWludEZ4KCk7CiAgICAgIHJlZnJlc2goKTsKICAgIH0pOwogIH0KCgogIC8vID09PSBbR08gRXhwb3J0OiBDU1YgLyBKU09OXSA9PT0KICAoZnVuY3Rpb24oKXsKICAgIGZ1bmN0aW9uIGRvd25sb2FkRmlsZShuYW1lLCBtaW1lLCBkYXRhKXsKICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtkYXRhXSwge3R5cGU6IG1pbWV9KTsKICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgYS5ocmVmID0gdXJsOwogICAgICBhLmRvd25sb2FkID0gbmFtZTsKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsKICAgICAgYS5jbGljaygpOwogICAgICBzZXRUaW1lb3V0KCgpPT57IFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsgYS5yZW1vdmUoKTsgfSwgMTAwMCk7CiAgICB9CiAgICBmdW5jdGlvbiB0b0NzdkNlbGwodil7CiAgICAgIGlmKHY9PT1udWxsIHx8IHY9PT11bmRlZmluZWQpIHJldHVybiAnJzsKICAgICAgY29uc3QgcyA9IFN0cmluZyh2KS5yZXBsYWNlKC8iL2csICciIicpOwogICAgICByZXR1cm4gL1s7IlxuLF0vLnRlc3QocykgPyBgIiR7c30iYCA6IHM7CiAgICB9CiAgICBhc3luYyBmdW5jdGlvbiBleHBvcnRPdmVydmlld0pTT04oKXsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IGNvbXAgPSBhd2FpdCByZWZyZXNoKCk7IC8vIGdldCBmcmVzaCBzbmFwc2hvdAogICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnNBZ2cgPSBidWlsZEFsbFBvc2l0aW9ucyhjb21wLnJlc3VsdHMpOwogICAgICAgIGNvbnN0IHBheWxvYWQgPSB7CiAgICAgICAgICBnZW5lcmF0ZWRBdDogbm93LAogICAgICAgICAgYmFzZTogY29tcC5iYXNlLAogICAgICAgICAgdG90YWxzOiBjb21wLnRvdCwKICAgICAgICAgIHBvcnRmb2xpb3M6IGNvbXAucmVzdWx0cy5tYXAociA9PiAoewogICAgICAgICAgICBuYW1lOiByLnBmPy5uYW1lIHx8ICfigJQnLAogICAgICAgICAgICBjdXJyZW5jeTogci5wZj8uY3VycmVuY3kgfHwgJ1BMTicsCiAgICAgICAgICAgIGVxdWl0eUJhc2U6IHIuZXF1aXR5QmFzZSwKICAgICAgICAgICAgY2FzaEJhc2U6IHIuY2FzaEJhc2UsCiAgICAgICAgICAgIGhvbGRpbmdzQmFzZTogci5ob2xkaW5nc0Jhc2UsCiAgICAgICAgICAgIGNvc3RCYXNlOiByLmNvc3RCYXNlLAogICAgICAgICAgICB1bnJlYWxCYXNlOiByLnVucmVhbEJhc2UsCiAgICAgICAgICAgIGRheU1vdmVCYXNlOiByLmRheU1vdmVCYXNlLAogICAgICAgICAgICByZWFsaXplZEdyb3NzQmFzZTogci5yZWFsaXplZEdyb3NzQmFzZSwKICAgICAgICAgICAgcmVhbGl6ZWRUYXhCYXNlOiByLnJlYWxpemVkVGF4QmFzZSwKICAgICAgICAgICAgcmVhbGl6ZWROZXRCYXNlOiByLnJlYWxpemVkTmV0QmFzZSwKICAgICAgICAgICAgcG9zaXRpb25zOiByLnBvc2l0aW9ucwogICAgICAgICAgfSkpLAogICAgICAgICAgcG9zaXRpb25zQWdncmVnYXRlZDogcG9zaXRpb25zQWdnCiAgICAgICAgfTsKICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCwgbnVsbCwgMik7CiAgICAgICAgZG93bmxvYWRGaWxlKGBnbG9iYWxfb3ZlcnZpZXdfJHtub3cuc2xpY2UoMCwxMCl9Lmpzb25gLCAiYXBwbGljYXRpb24vanNvbiIsIGRhdGEpOwogICAgICB9Y2F0Y2goZSl7CiAgICAgICAgY29uc29sZS53YXJuKCdbR08gZXhwb3J0IGpzb25dIGZhaWxlZCcsIGUpOwogICAgICAgIGFsZXJ0KCdFa3Nwb3J0IEpTT04gbmllIHBvd2nDs2TFgiBzacSZOiAnKyhlJiZlLm1lc3NhZ2U/ZS5tZXNzYWdlOmUpKTsKICAgICAgfQogICAgfQogICAgYXN5bmMgZnVuY3Rpb24gZXhwb3J0T3ZlcnZpZXdDU1YoKXsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IGNvbXAgPSBhd2FpdCByZWZyZXNoKCk7IC8vIGZyZXNoIHNuYXBzaG90CiAgICAgICAgY29uc3Qgcm93cyA9IGJ1aWxkQWxsUG9zaXRpb25zKGNvbXAucmVzdWx0cyk7CiAgICAgICAgY29uc3QgaGVhZGVyID0gWydUaWNrZXInLCdQb3J0ZmVsJywnSWxvxZvEhycsJ8Waci4ga29zenQnLCdLb3N6dCB3xYJhc255JywnS3VycycsJ1dhcnRvxZvEhycsJ1AvTCcsJyUnLCfOlCBkemllbm55JywnV2FsdXRhJ107CiAgICAgICAgY29uc3QgbGluZXMgPSBbXTsKICAgICAgICBsaW5lcy5wdXNoKGhlYWRlci5qb2luKCc7JykpOwogICAgICAgIGZvcihjb25zdCByIG9mIHJvd3MpewogICAgICAgICAgY29uc3QgcGN0ID0gKHIucGN0IT1udWxsICYmIGlzRmluaXRlKHIucGN0KSkgPyAoci5wY3QqMTAwKS50b0ZpeGVkKDIpIDogJyc7CiAgICAgICAgICBjb25zdCBkcCAgPSAoci5kcCE9bnVsbCAmJiBpc0Zpbml0ZShyLmRwKSkgID8gci5kcC50b0ZpeGVkKDIpIDogJyc7CiAgICAgICAgICBjb25zdCBsaW5lID0gWwogICAgICAgICAgICB0b0NzdkNlbGwoci50aWNrZXIpLAogICAgICAgICAgICB0b0NzdkNlbGwoci5wZiksCiAgICAgICAgICAgIHRvQ3N2Q2VsbChOdW1iZXIoci5xdHkpLnRvRml4ZWQoNCkpLAogICAgICAgICAgICB0b0NzdkNlbGwoTnVtYmVyKHIuYXZnKS50b0ZpeGVkKDQpKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKE51bWJlcihyLmNvc3QpLnRvRml4ZWQoMikpLAogICAgICAgICAgICB0b0NzdkNlbGwoci5wcmljZSE9bnVsbCAmJiBpc0Zpbml0ZShyLnByaWNlKSA/IE51bWJlcihyLnByaWNlKS50b0ZpeGVkKDIpIDogJycpLAogICAgICAgICAgICB0b0NzdkNlbGwoTnVtYmVyKHIudmFsdWUpLnRvRml4ZWQoMikpLAogICAgICAgICAgICB0b0NzdkNlbGwoTnVtYmVyKHIucGwpLnRvRml4ZWQoMikpLAogICAgICAgICAgICB0b0NzdkNlbGwocGN0KSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKGRwKSwKICAgICAgICAgICAgdG9Dc3ZDZWxsKHIuY3VycmVuY3l8fCcnKQogICAgICAgICAgXS5qb2luKCc7Jyk7CiAgICAgICAgICBsaW5lcy5wdXNoKGxpbmUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjc3YgPSAnXHVmZWZmJyArIGxpbmVzLmpvaW4oJ1xuJyk7CiAgICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNsaWNlKDAsMTApOwogICAgICAgIGRvd25sb2FkRmlsZShgZ2xvYmFsX292ZXJ2aWV3X3Bvc2l0aW9uc18ke25vd30uY3N2YCwgInRleHQvY3N2O2NoYXJzZXQ9dXRmLTgiLCBjc3YpOwogICAgICB9Y2F0Y2goZSl7CiAgICAgICAgY29uc29sZS53YXJuKCdbR08gZXhwb3J0IGNzdl0gZmFpbGVkJywgZSk7CiAgICAgICAgYWxlcnQoJ0Vrc3BvcnQgQ1NWIG5pZSBwb3dpw7NkxYIgc2nEmTogJysoZSYmZS5tZXNzYWdlP2UubWVzc2FnZTplKSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJ0bkNzdiAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ28tZXhwb3J0LWNzdicpOwogICAgY29uc3QgYnRuSnNvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnby1leHBvcnQtanNvbicpOwogICAgaWYoYnRuQ3N2KSAgYnRuQ3N2LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZXhwb3J0T3ZlcnZpZXdDU1YpOwogICAgaWYoYnRuSnNvbikgYnRuSnNvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGV4cG9ydE92ZXJ2aWV3SlNPTik7CiAgfSkoKTsKfSkoKTs8L3NjcmlwdD4KPCEtLSA9PT0gWy9HVCBBRERPTl0gR2xvYmFsIE92ZXJ2aWV3IFRhYiA9PT0gLS0+Cgo8c2NyaXB0PgovLyA9PT0gSGVscGVyOiBpZ25vcmUgaW5jb25zaXN0ZW50IHNlbGwgdHJhbnNhY3Rpb25zIChub24tZGVzdHJ1Y3RpdmUpID09PQp3aW5kb3cuX19pZ25vcmVJbmNvbnNpc3RlbnRTZWxscyA9IGZ1bmN0aW9uKCl7CiAgdHJ5ewogICAgY29uc3QgcGYgPSBnZXRQZihjdXJyZW50UGZJZCk7IGlmKCFwZikgcmV0dXJuOwogICAgY29uc3QgaWRzID0gbmV3IFNldCgpOwogICAgY29uc3QgZXJycyA9IEFycmF5LmlzQXJyYXkocGYuX19lcnJvcnMpID8gcGYuX19lcnJvcnMgOiBbXTsKICAgIC8vIFBpY2sgc2VsbHMgb25seQogICAgZm9yKGNvbnN0IGUgb2YgZXJycyl7CiAgICAgIGlmKGUgJiYgL1NwcnplZGHFvCBiZXogcG96eWNqaXxCcmFrIHBhcnRpaS8udGVzdChlLm1lc3NhZ2V8fCcnKSl7CiAgICAgICAgLy8gZmluZCBtYXRjaGluZyB0eCBieSB0aWNrZXIgYW5kIGRhdGUgKGJlc3QgZWZmb3J0KQogICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSAocGYudHJhbnNhY3Rpb25zfHxbXSkuZmlsdGVyKHQgPT4gdC50eXBlPT09J3NlbGwnICYmICh0LnRpY2tlcnx8JycpLnRvVXBwZXJDYXNlKCk9PT0oZS50aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpKTsKICAgICAgICAvLyBtYXJrIGFsbCBzZWxscyBmb3IgdGhpcyB0aWNrZXIgdGhhdCB3b3VsZCBlcnJvcgogICAgICAgIGZvcihjb25zdCB0IG9mIGNhbmRpZGF0ZXMpeyBpZHMuYWRkKHQuaWQpOyB9CiAgICAgIH0KICAgIH0KICAgIGlmKCFpZHMuc2l6ZSl7IGFsZXJ0KCdCcmFrIHNwcnplZGHFvHkgZG8gemlnbm9yb3dhbmlhLicpOyByZXR1cm47IH0KICAgIGNvbnN0IG9rID0gY29uZmlybSgnWmlnbm9yb3dhxIcgJytpZHMuc2l6ZSsnIHRyYW5zYWtjamkgc3ByemVkYcW8eSwga3TDs3JlIHPEhSBuaWVzcMOzam5lPyAobW/FvG5hIGNvZm7EhcSHIOKGqe+4jyBDb2ZuaWopJyk7CiAgICBpZighb2spIHJldHVybjsKICAgIHRyeXsgcHVzaFVuZG8oe2xhYmVsOiJJZ25vcnVqIG5pZXNww7NqbmUgc3ByemVkYcW8ZSIsIGtpbmQ6J3R4J30pOyB9Y2F0Y2goXyl7fQogICAgcGYudHJhbnNhY3Rpb25zID0gcGYudHJhbnNhY3Rpb25zLm1hcCh0ID0+IGlkcy5oYXModC5pZCkgPyBPYmplY3QuYXNzaWduKHt9LCB0LCB7aWdub3JlOnRydWUsIG5vdGU6ICh0Lm5vdGU/IHQubm90ZSsnICcgOiAnJykrJ1tJR05PUkVEOiBuaWVzcMOzam5vxZvEh10nfSkgOiB0KTsKICAgIHBmLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgIHJlYnVpbGRQb3J0Zm9saW8ocGYpOyBzYXZlKCk7IHJlbmRlcigpOwogIH1jYXRjaChlKXsKICAgIGFsZXJ0KCdPcGVyYWNqYSBuaWUgcG93aW9kxYJhIHNpxJk6ICcrKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsKICB9Cn07Cjwvc2NyaXB0Pgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICAgIC8vIEludGVyd2HFgiBvZMWbd2llxbxhbmlhOiAxMCBzZWt1bmQgKDEwMDAwIG1zKQogICAgY29uc3QgQVVUT19SRUZSRVNIX0lOVEVSVkFMX01TID0gMTAwMDA7CiAgICBsZXQgX19hdXRvUmVmcmVzaFRpbWVyID0gbnVsbDsKCiAgICBmdW5jdGlvbiBzdGFydENvbmRpdGlvbmFsQXV0b1JlZnJlc2goKXsKICAgICAgICBpZiAoX19hdXRvUmVmcmVzaFRpbWVyKSBjbGVhckludGVydmFsKF9fYXV0b1JlZnJlc2hUaW1lcik7CgogICAgICAgIF9fYXV0b1JlZnJlc2hUaW1lciA9IHNldEludGVydmFsKGFzeW5jICgpPT57CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAvLyBTcHJhd2R6ZW5pZTogQ3p5IEpBS0lLT0xXSUVLIHN6Y3plZ8OzxYIgKDxkZXRhaWxzPikgamVzdCBvdHdhcnR5PwogICAgICAgICAgICAgICAgLy8gWm1pZW5uYSBfX29wZW5EZXRhaWxzVGlja2VycyBwcnplY2hvd3VqZSBzZXQgb3R3YXJ0eWNoIHRpY2tlcsOzdy4KICAgICAgICAgICAgICAgIGNvbnN0IGRldGFpbHNBcmVPcGVuID0gKHdpbmRvdy5fX29wZW5EZXRhaWxzVGlja2VycyAmJiB3aW5kb3cuX19vcGVuRGV0YWlsc1RpY2tlcnMuc2l6ZSA+IDApOwoKICAgICAgICAgICAgICAgIGlmICghZGV0YWlsc0FyZU9wZW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBKZcWbbGkgbmllIG1hIG90d2FydHljaCBzemN6ZWfDs8WCw7N3LCB3eWtvbmFqIG9kxZt3aWXFvGFuaWUKICAgICAgICAgICAgICAgICAgICAvLyBVxbx5d2FteSAncmVmcmVzaCgpJyBwb25pZXdhxbwgcG9iaWVyYSBvbmEgbm93ZSBkYW5lIGkgbWFsdWplIFVJLgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LnJlZnJlc2ggPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgd2luZG93LnJlZnJlc2goKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB3aW5kb3cucmVuZGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFcgb3N0YXRlY3pub8WbY2kgdcW8eWogcmVuZGVyKCksIGplxZtsaSByZWZyZXNoKCkgbmllIGplc3QgZG9zdMSZcG5lCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5yZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIEplxZtsaSBzemN6ZWfDs8WCeSBzxIUgb3R3YXJ0ZSwgcG9tacWEIHBlxYJuZSBvZMWbd2llxbxhbmllL3JlLXJlbmRlcm93YW5pZQogICAgICAgICAgICAgICAgICAgIC8vICh6YXBvYmllZ2EgdG8gbWlnb3Rhbml1KQogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBdXRvbWF0eWN6bmUgb2TFm3dpZcW8YW5pZSB3c3RyenltYW5lOiBvdHdhcnRlIHN6Y3plZ8OzxYJ5IHBvenljamkuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignQsWCxIVkIHcgYXV0b21hdHljem55bSBvZMWbd2llxbxhbml1IHdhcnVua293eW06JywgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCBBVVRPX1JFRlJFU0hfSU5URVJWQUxfTVMpOwogICAgfQoKICAgIC8vIFVydWNob20gaW50ZXJ3YcWCIHByenkgc3RhcmNpZSBhcGxpa2FjamkKICAgIHN0YXJ0Q29uZGl0aW9uYWxBdXRvUmVmcmVzaCgpOwoKfSkoKTsKPC9zY3JpcHQ+Cgo8L2JvZHk+CjwvaHRtbD4KCjxzY3JpcHQ+Ci8vIFNvdW5kIHRpY2tlciB0byBob25vdXIgcmVwZWF0IGludGVydmFsIGluZGVwZW5kZW50bHkgb2YgcXVvdGUgcG9sbGluZwppZighd2luZG93Ll9fc291bmRUaWNrZXIpewogIHdpbmRvdy5fX3NvdW5kVGlja2VyID0gc2V0SW50ZXJ2YWwoKCk9PnsKICAgIHRyeXsgaWYod2luZG93LmNoZWNrQW5kUGxheVBvcnRmb2xpb0FsZXJ0cykgY2hlY2tBbmRQbGF5UG9ydGZvbGlvQWxlcnRzKCk7IH1jYXRjaChfKXt9CiAgICB0cnl7IGlmKHdpbmRvdy5jaGVja0FuZFBsYXlXaXNobGlzdEFsZXJ0KSBjaGVja0FuZFBsYXlXaXNobGlzdEFsZXJ0KCk7IH1jYXRjaChfKXt9CiAgfSwgMTAwMCk7Cn0KCi8qID09PSBDb21wYW55IE5vdGVzIChsb2NhbFN0b3JhZ2UgKyBGaXJlc3RvcmUgc3luYykgPT09ICovCihmdW5jdGlvbigpewogIGNvbnN0IE5PVEVTX0tFWSA9ICdjb21wYW55Tm90ZXNfdjEnOwogIGZ1bmN0aW9uIGxvYWRDb21wYW55Tm90ZXMoKXsgdHJ5eyByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShOT1RFU19LRVkpfHwne30nKXx8e307IH1jYXRjaChfKXsgcmV0dXJuIHt9OyB9IH0KICBmdW5jdGlvbiBzYXZlQ29tcGFueU5vdGVzKG1hcCl7IHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTk9URVNfS0VZLCBKU09OLnN0cmluZ2lmeShtYXB8fHt9KSk7IH1jYXRjaChfKXsgfSB9CiAgd2luZG93LmdldENvbXBhbnlOb3RlID0gKHRpY2tlcik9PiAobG9hZENvbXBhbnlOb3RlcygpWyh0aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpXXx8JycpOwogIHdpbmRvdy5zZXRDb21wYW55Tm90ZSA9ICh0aWNrZXIsIHRleHQpPT57IGNvbnN0IG09bG9hZENvbXBhbnlOb3RlcygpOyBtWyh0aWNrZXJ8fCcnKS50b1VwcGVyQ2FzZSgpXT1TdHJpbmcodGV4dHx8JycpOyBzYXZlQ29tcGFueU5vdGVzKG0pOyB9OwoKICBhc3luYyBmdW5jdGlvbiBzYXZlTm90ZVJlbW90ZSh0aWNrZXIsIHRleHQpewogICAgdHJ5ewogICAgICBjb25zdCBjdHggPSBhd2FpdCAodHlwZW9mIGZiSW5pdCA9PT0gJ2Z1bmN0aW9uJyA/IGZiSW5pdCgpIDogbnVsbCk7CiAgICAgIGNvbnN0IGF1dGggPSBjdHggJiYgY3R4LmF1dGgsIGRiID0gY3R4ICYmIGN0eC5kYjsKICAgICAgaWYoIWF1dGggfHwgIWF1dGguY3VycmVudFVzZXIgfHwgIWRiKSByZXR1cm4gZmFsc2U7CiAgICAgIGNvbnN0IHVpZCA9IGF1dGguY3VycmVudFVzZXIudWlkOwogICAgICBjb25zdCBpZCA9IGAke3VpZH1fJHtTdHJpbmcodGlja2VyfHwnJykudG9VcHBlckNhc2UoKX1gOwogICAgICBjb25zdCBmdiA9ICh3aW5kb3cuZmlyZWJhc2UgJiYgd2luZG93LmZpcmViYXNlLmZpcmVzdG9yZSAmJiB3aW5kb3cuZmlyZWJhc2UuZmlyZXN0b3JlLkZpZWxkVmFsdWUpIHx8IG51bGw7CiAgICAgIGNvbnN0IHRzID0gZnYgJiYgZnYuc2VydmVyVGltZXN0YW1wID8gZnYuc2VydmVyVGltZXN0YW1wKCkgOiBuZXcgRGF0ZSgpOwogICAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKCdjb21wYW55Tm90ZXMnKS5kb2MoaWQpLnNldCh7IHVpZCwgdGlja2VyOiBTdHJpbmcodGlja2VyfHwnJykudG9VcHBlckNhc2UoKSwgbm90ZTogU3RyaW5nKHRleHR8fCcnKSwgdXBkYXRlZEF0OiB0cyB9LCB7IG1lcmdlOiB0cnVlIH0pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH1jYXRjaChlKXsgY29uc29sZS53YXJuKCdbbm90ZXNdIHNhdmUgcmVtb3RlIGZhaWxlZCcsIGUpOyByZXR1cm4gZmFsc2U7IH0KICB9CiAgYXN5bmMgZnVuY3Rpb24gbG9hZE5vdGVSZW1vdGUodGlja2VyKXsKICAgIHRyeXsKICAgICAgY29uc3QgY3R4ID0gYXdhaXQgKHR5cGVvZiBmYkluaXQgPT09ICdmdW5jdGlvbicgPyBmYkluaXQoKSA6IG51bGwpOwogICAgICBjb25zdCBhdXRoID0gY3R4ICYmIGN0eC5hdXRoLCBkYiA9IGN0eCAmJiBjdHguZGI7CiAgICAgIGlmKCFhdXRoIHx8ICFhdXRoLmN1cnJlbnRVc2VyIHx8ICFkYikgcmV0dXJuIG51bGw7CiAgICAgIGNvbnN0IHVpZCA9IGF1dGguY3VycmVudFVzZXIudWlkOwogICAgICBjb25zdCBpZCA9IGAke3VpZH1fJHtTdHJpbmcodGlja2VyfHwnJykudG9VcHBlckNhc2UoKX1gOwogICAgICBjb25zdCBzbmFwID0gYXdhaXQgZGIuY29sbGVjdGlvbignY29tcGFueU5vdGVzJykuZG9jKGlkKS5nZXQoKTsKICAgICAgcmV0dXJuIHNuYXAuZXhpc3RzID8gKHNuYXAuZGF0YSgpICYmIChzbmFwLmRhdGEoKS5ub3RlfHwnJykpIDogbnVsbDsKICAgIH1jYXRjaChlKXsgcmV0dXJuIG51bGw7IH0KICB9CgogIHdpbmRvdy5vcGVuQ29tcGFueUluZm9Nb2RhbCA9IGFzeW5jIGZ1bmN0aW9uKHRpY2tlcil7CiAgICBsZXQgY3VyID0gYXdhaXQgbG9hZE5vdGVSZW1vdGUodGlja2VyKTsKICAgIGlmIChjdXIgPT0gbnVsbCkgY3VyID0gZ2V0Q29tcGFueU5vdGUodGlja2VyKTsKCiAgICBjb25zdCBkYXRhID0gYXdhaXQgb3Blbk1vZGFsKHsKICAgICAgdGl0bGU6IGBOb3RhdGthIG8gc3DDs8WCY2U6ICR7dGlja2VyfWAsCiAgICAgIGlubmVySFRNTDogYDxmb3JtPgogICAgICAgIDxsYWJlbD5Ud29qZSBub3RhdGtpIG8gc3DDs8WCY2U8L2xhYmVsPgogICAgICAgIDx0ZXh0YXJlYSBuYW1lPSJub3RlIiByb3dzPSI4IiBzdHlsZT0id2lkdGg6MTAwJSI+JHtfX2VzYyhjdXJ8fCcnKX08L3RleHRhcmVhPgogICAgICAgIDxwIGNsYXNzPSJzbWFsbCBtdXRlZCI+WmFwaXN5d2FuZSBsb2thbG5pZSBpIHN5bmNocm9uaXpvd2FuZSB6IEZpcmVzdG9yZSAoamXFm2xpIHphbG9nb3dhbnkpLjwvcD4KICAgICAgPC9mb3JtPmAsCiAgICAgIG9rVGV4dDogJ1phcGlzeicKICAgIH0pOwogICAgaWYoIWRhdGEpIHJldHVybjsKCiAgICBzZXRDb21wYW55Tm90ZSh0aWNrZXIsIGRhdGEubm90ZXx8JycpOwogICAgY29uc3Qgb2sgPSBhd2FpdCBzYXZlTm90ZVJlbW90ZSh0aWNrZXIsIGRhdGEubm90ZXx8JycpOwogICAgdHJ5eyBzaG93VG9hc3QgJiYgc2hvd1RvYXN0KHsgdGl0bGU6IG9rID8gJ1phcGlzYW5vIG5vdGF0a8SZIChGaXJlc3RvcmUgKyBsb2thbG5pZSknIDogJ1phcGlzYW5vIG5vdGF0a8SZIChsb2thbG5pZSknLCBtZXNzYWdlOiB0aWNrZXIgfSk7IH1jYXRjaChfKXt9CiAgfTsKCiAgY29uc3QgX19vcmlnRXhwb3J0ID0gd2luZG93LmV4cG9ydEpTT047CiAgaWYgKHR5cGVvZiBfX29yaWdFeHBvcnQgPT09ICdmdW5jdGlvbicpewogICAgd2luZG93LmV4cG9ydEpTT04gPSBmdW5jdGlvbigpewogICAgICB0cnl7IERCLmNvbXBhbnlOb3RlcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkobG9hZENvbXBhbnlOb3RlcygpKSk7IH1jYXRjaChfKXt9CiAgICAgIHJldHVybiBfX29yaWdFeHBvcnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQogIHRyeXsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbXBvcnRGaWxlJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpPT57CiAgICAgIHNldFRpbWVvdXQoKCk9PnsgdHJ5eyBpZihEQiAmJiBEQi5jb21wYW55Tm90ZXMpeyBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShOT1RFU19LRVksIEpTT04uc3RyaW5naWZ5KERCLmNvbXBhbnlOb3RlcykpOyB9IH1jYXRjaChfKXsgfSB9LCAwKTsKICAgIH0sIHtjYXB0dXJlOmZhbHNlfSk7CiAgfWNhdGNoKF8pe30KfSkoKTsKPC9zY3JpcHQ+CjwhLS0gQUxMT1dfUlVMRVNfQUxFUlRTX1NOSVBQRVQKU3VnZ2VzdGVkIEZpcmVzdG9yZSBydWxlcyBmb3IgYWxlcnRzIGNvbGxlY3Rpb24gKHJlcGxhY2Ugd2l0aCB5b3VyIHNldHVwKToKcnVsZXNfdmVyc2lvbiA9ICcyJzsKc2VydmljZSBjbG91ZC5maXJlc3RvcmUgewogIG1hdGNoIC9kYXRhYmFzZXMve2RhdGFiYXNlfS9kb2N1bWVudHMgewogICAgbWF0Y2ggL2FsZXJ0cy97YWxlcnRJZH0gewogICAgICBhbGxvdyByZWFkOiBpZiByZXF1ZXN0LmF1dGggIT0gbnVsbCAmJiByZXNvdXJjZS5kYXRhLnVpZCA9PSByZXF1ZXN0LmF1dGgudWlkOwogICAgICBhbGxvdyBjcmVhdGU6IGlmIHJlcXVlc3QuYXV0aCAhPSBudWxsICYmIHJlcXVlc3QucmVzb3VyY2UuZGF0YS51aWQgPT0gcmVxdWVzdC5hdXRoLnVpZDsKICAgICAgYWxsb3cgdXBkYXRlLCBkZWxldGU6IGlmIHJlcXVlc3QuYXV0aCAhPSBudWxsICYmIHJlc291cmNlLmRhdGEudWlkID09IHJlcXVlc3QuYXV0aC51aWQ7CiAgICB9CiAgfQp9Ci0tPgoKCjxzY3JpcHQ+CihmdW5jdGlvbigpewogIGlmICh0eXBlb2Ygd2luZG93Lm9wZW5Nb2RhbCAhPT0gJ2Z1bmN0aW9uJyl7CiAgICB3aW5kb3cub3Blbk1vZGFsID0gZnVuY3Rpb24oe3RpdGxlPSdJbmZvcm1hY2phJywgaW5uZXJIVE1MPScnLCBva1RleHQ9J09LJywgY2FuY2VsVGV4dD0nQW51bHVqJ309e30pewogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpPT57CiAgICAgICAgY29uc3Qgb3ZlcmxheSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIE9iamVjdC5hc3NpZ24ob3ZlcmxheS5zdHlsZSwge3Bvc2l0aW9uOidmaXhlZCcsIGluc2V0OicwJywgYmFja2dyb3VuZDoncmdiYSgyLDYsMjMsMC42NiknLCBiYWNrZHJvcEZpbHRlcjonYmx1cig2cHgpJywgekluZGV4Oic5OTk5OScsIGRpc3BsYXk6J2ZsZXgnLCBhbGlnbkl0ZW1zOidjZW50ZXInLCBqdXN0aWZ5Q29udGVudDonY2VudGVyJywgcGFkZGluZzonMTZweCd9KTsKICAgICAgICBjb25zdCBib3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBPYmplY3QuYXNzaWduKGJveC5zdHlsZSwge2JhY2tncm91bmQ6J2xpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMTcsMjQsMzksLjk4KSwgcmdiYSgxNSwyMyw0MiwuOTgpKScsY29sb3I6J3ZhcigtLXRleHQpJyxib3JkZXI6JzFweCBzb2xpZCAjMzM0MTU1JyxtYXhXaWR0aDonNzIwcHgnLCB3aWR0aDonMTAwJScsIGJvcmRlclJhZGl1czonMTZweCcsIHBhZGRpbmc6JzE2cHgnLGJveFNoYWRvdzonMCAxMHB4IDI1cHggcmdiYSgwLDAsMCwuMzUpJ30pOwogICAgICAgIGJveC5pbm5lckhUTUwgPSBgCiAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2dhcDo4cHg7bWFyZ2luLWJvdHRvbTo4cHg7Ij4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW46MDtmb250LXNpemU6MThweDsiPiR7dGl0bGV9PC9oMz4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJtb2RhbC14IiBhcmlhLWxhYmVsPSJaYW1rbmlqIiBzdHlsZT0iYm9yZGVyOm5vbmU7YmFja2dyb3VuZDp0cmFuc3BhcmVudDtmb250LXNpemU6MThweDtjdXJzb3I6cG9pbnRlcjtjb2xvcjojOTRhM2I4Ij7DlzwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1ib2R5Ij4ke2lubmVySFRNTH08L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4O2p1c3RpZnktY29udGVudDpmbGV4LWVuZDttYXJnaW4tdG9wOjEycHg7Ij4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gZ2hvc3QgbW9kYWwtY2FuY2VsIj4ke2NhbmNlbFRleHR8fCdBbnVsdWonfTwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBtb2RhbC1vayI+JHtva1RleHR8fCdPSyd9PC9idXR0b24+CiAgICAgICAgICA8L2Rpdj5gOwogICAgICAgIG92ZXJsYXkuYXBwZW5kQ2hpbGQoYm94KTsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG92ZXJsYXkpOwogICAgICAgIGZ1bmN0aW9uIGNsZWFudXAoKXsgdHJ5eyBvdmVybGF5LnJlbW92ZSgpOyB9Y2F0Y2goXyl7fSB9CiAgICAgICAgZnVuY3Rpb24gY29sbGVjdEZvcm0oKXsKICAgICAgICAgIGNvbnN0IGZvcm0gPSBib3gucXVlcnlTZWxlY3RvcignZm9ybScpOwogICAgICAgICAgaWYoIWZvcm0pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICBjb25zdCBmZCA9IG5ldyBGb3JtRGF0YShmb3JtKTsKICAgICAgICAgIGNvbnN0IG9iaiA9IHt9OyBmb3IgKGNvbnN0IFtrLHZdIG9mIGZkLmVudHJpZXMoKSkgb2JqW2tdPXY7IHJldHVybiBvYmo7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNhbmNlbCA9ICgpPT57IGNsZWFudXAoKTsgcmVzb2x2ZShudWxsKTsgfTsKICAgICAgICBib3gucXVlcnlTZWxlY3RvcignLm1vZGFsLW9rJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBjb25zdCBkYXRhPWNvbGxlY3RGb3JtKCk7IGNsZWFudXAoKTsgcmVzb2x2ZShkYXRhfHx7fSk7IH0pOwogICAgICAgIGJveC5xdWVyeVNlbGVjdG9yKCcubW9kYWwtY2FuY2VsJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjYW5jZWwpOwogICAgICAgIGJveC5xdWVyeVNlbGVjdG9yKCcubW9kYWwteCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2FuY2VsKTsKICAgICAgICBvdmVybGF5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGlmKGUudGFyZ2V0PT09b3ZlcmxheSkgY2FuY2VsKCk7IH0pOwogICAgICAgIHNldFRpbWVvdXQoKCk9PnsgY29uc3QgZWwgPSBib3gucXVlcnlTZWxlY3RvcigndGV4dGFyZWEsIGlucHV0LCBzZWxlY3QsIGJ1dHRvbicpOyBlbCAmJiBlbC5mb2N1cyAmJiBlbC5mb2N1cygpOyB9LDApOwogICAgICB9KTsKICAgIH07CiAgfQp9KSgpOwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+ewogIGNvbnN0IGIgPSBlLnRhcmdldC5jbG9zZXN0KCcud2wtaW5mbycpOyBpZighYikgcmV0dXJuOwogIGNvbnN0IHQgPSBiLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsgaWYoIXQpIHJldHVybjsKICBpZiAodHlwZW9mIHdpbmRvdy5vcGVuQ29tcGFueUluZm9Nb2RhbCA9PT0gJ2Z1bmN0aW9uJyl7IGUucHJldmVudERlZmF1bHQoKTsgd2luZG93Lm9wZW5Db21wYW55SW5mb01vZGFsKHQpOyB9Cn0sIHRydWUpOwo8L3NjcmlwdD4KCgo8c2NyaXB0PgovLyA9PT0gVHJhZGluZ1ZpZXcgaGVscGVycyAmIGdsb2JhbCBvcGVuZXIgPT09CihmdW5jdGlvbigpewogIGZ1bmN0aW9uIF9fdHZQYXJzZVN5bWJvbCh0KXsKICAgIHZhciBzID0gU3RyaW5nKHR8fCcnKS50b1VwcGVyQ2FzZSgpLnRyaW0oKTsKICAgIGlmKCFzKSByZXR1cm4gJyc7CiAgICBpZihzLmluY2x1ZGVzKCc6JykpIHJldHVybiBzOyAgICAgICAgICAgLy8gYWxyZWFkeSBFWENIQU5HRTpTWU1CT0wKICAgIGlmKHMuaW5jbHVkZXMoJy4nKSl7CiAgICAgIHZhciBwYXJ0cyA9IHMuc3BsaXQoJy4nKTsKICAgICAgdmFyIGJhc2UgPSBwYXJ0c1swXSwgc3VmID0gcGFydHNbMV07CiAgICAgIGlmKHN1ZiA9PT0gJ1dBJykgcmV0dXJuICdHUFc6JyArIGJhc2U7IC8vIFdhcnNhdyBHUFcKICAgICAgaWYoc3VmID09PSAnTCcpICByZXR1cm4gJ0xTRTonICsgYmFzZTsgLy8gTG9uZG9uCiAgICAgIGlmKHN1ZiA9PT0gJ0RFJykgcmV0dXJuICdYRVRSOicgKyBiYXNlOyAvLyBYZXRyYSAoYmVzdC1lZmZvcnQpCiAgICAgIGlmKHN1ZiA9PT0gJ0YnKSAgcmV0dXJuICdGV0I6JyArIGJhc2U7ICAvLyBGcmFua2Z1cnQgYmVzdC1lZmZvcnQKICAgICAgcmV0dXJuIHM7IC8vIGtlZXAgc3VmZml4IChlLmcuLCBCUksuQiwgQkYuQikgLy8gZmFsbGJhY2s6IHN0cmlwIHN1ZmZpeAogICAgfQogICAgcmV0dXJuIHM7IC8vIG5vIGV4Y2hhbmdlCiAgfQogIGZ1bmN0aW9uIG1ha2VUcmFkaW5nVmlld1VSTCh0KXsKICAgIHZhciBzeW0gPSBfX3R2UGFyc2VTeW1ib2wodCk7CiAgICB2YXIgcSA9IGVuY29kZVVSSUNvbXBvbmVudChzeW0gfHwgU3RyaW5nKHR8fCcnKS50b1VwcGVyQ2FzZSgpKTsKICAgIHJldHVybiAnaHR0cHM6Ly9wbC50cmFkaW5ndmlldy5jb20vY2hhcnQvP3N5bWJvbD0nICsgcTsKICB9CiAgLy8gZ2xvYmFsIGRlbGVnYXRpb24gKHdvcmtzIGZvciBob2xkaW5ncyArIHdpc2hsaXN0KQogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oZSl7CiAgICB2YXIgYnRuID0gZS50YXJnZXQuY2xvc2VzdCgnLnR2LWxpbmsnKTsKICAgIGlmKCFidG4pIHJldHVybjsKICAgIHZhciB0ID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS10aWNrZXInKTsKICAgIGlmKCF0KSByZXR1cm47CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB0cnl7IHdpbmRvdy5vcGVuKG1ha2VUcmFkaW5nVmlld1VSTCh0KSwgJ19ibGFuaycsICdub29wZW5lcicpOyB9Y2F0Y2goXyl7IGxvY2F0aW9uLmhyZWYgPSBtYWtlVHJhZGluZ1ZpZXdVUkwodCk7IH0KICB9LCB0cnVlKTsKICAvLyBleHBvc2UgZm9yIHBvdGVudGlhbCByZXVzZQogIHdpbmRvdy5tYWtlVHJhZGluZ1ZpZXdVUkwgPSBtYWtlVHJhZGluZ1ZpZXdVUkw7Cn0pKCk7Cjwvc2NyaXB0Pgo8c2NyaXB0IGlkPSJwbHVzLWljb24tcmVsYWJlbCI+CihmdW5jdGlvbigpewogIGZ1bmN0aW9uIHN3YXAoYnRuKXsKICAgIGlmKCFidG4pIHJldHVybjsKICAgIGNvbnN0IHR4dCA9IChidG4udGV4dENvbnRlbnQgfHwgIiIpLnRyaW0oKTsKICAgIGlmICh0eHQgPT09ICIrIiB8fCB0eHQgPT09ICLvvIsiKSB7CiAgICAgIGJ0bi50ZXh0Q29udGVudCA9ICLinpUiOwogICAgICBpZiAoIWJ0bi5nZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiKSkgewogICAgICAgIGJ0bi5zZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiLCJEb2RhaiBwYXJ0acSZIik7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gYXBwbHkoKXsKICAgIGNvbnN0IHNlbCA9ICcjaG9sZGluZ3NUYWJsZQ==";
    function b64ToUtf8(b64){ const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return new TextDecoder().decode(bytes); }
    function computeBaseHref(){ try{ const u=new URL(window.location.href); return u.origin + u.pathname.replace(/[^\/]*$/,''); }catch(_e){ return document.baseURI || '/'; } }
    function mount(){ const html=b64ToUtf8(APP_B64).replace("__BASE__", computeBaseHref()); appFrame.srcdoc=html; }

    window.addEventListener('message', (ev) => {
      if (ev.source !== appFrame.contentWindow) return;
      const msg = ev.data || {};
      if (msg.type === 'request_init') {
        appFrame.contentWindow.postMessage({ type: 'storage_apply', payload: lastSnapshot }, '*');
        appFrame.contentWindow.postMessage({ type: 'set_clear_on_exit', value: true }, '*');
        // Trigger programmatic auto-sync inside the iframe
        setTimeout(()=>{ try{ appFrame.contentWindow.postMessage({ type:'auto_sync' }, '*'); }catch(_e){} }, 150);
        setTimeout(()=>{ try{ appFrame.contentWindow.postMessage({ type:'auto_sync' }, '*'); }catch(_e){} }, 600);
        setTimeout(()=>{ try{ appFrame.contentWindow.postMessage({ type:'auto_sync' }, '*'); }catch(_e){} }, 1500);
      } else if (msg.type === 'storage_event') {
        const { key, value } = msg;
        if (!key || isReservedKey(key)) return;
        if (value === null || typeof value === 'undefined') delete lastSnapshot[key];
        else lastSnapshot[key] = value;
        const u = auth.currentUser; if (u) debounce(u.uid);
      } else if (msg.type === 'storage_clear') {
        lastSnapshot = {};
        const u = auth.currentUser; if (u) debounce(u.uid);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginView.classList.remove('hide');
        appContainer.classList.add('hide');
        if (verifyView) verifyView.classList.add('hide');
        who.textContent = '—';
        appFrame.removeAttribute('srcdoc');
        return;
      }

      // Odśwież dane użytkownika, żeby mieć aktualny status emailVerified
      try { if (typeof user.reload === 'function') await user.reload(); } catch(_){}

      if (!user.emailVerified) {
        loginView.classList.add('hide');
        appContainer.classList.add('hide');
        if (verifyView) {
          verifyView.classList.remove('hide');
          if (verifyEmail) verifyEmail.textContent = user.email || user.uid;
        }
        who.textContent = user.email || user.uid;
        appFrame.removeAttribute('srcdoc');
        return;
      }

      if (verifyView) verifyView.classList.add('hide');
      who.textContent = user.email || user.uid;
      loginView.classList.add('hide');
      appContainer.classList.remove('hide');
      try {
        const snap = await getDoc(doc(db, 'users', user.uid, 'gt', 'state'));
        lastSnapshot = (snap.exists() && snap.data().localStorage) ? snap.data().localStorage : {};
      } catch(e) { lastSnapshot = {}; }
      mount();
    });
  </script>
</body>
</html>
